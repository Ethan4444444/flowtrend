<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4 Building the flowmix_tf() method | Creating the flowsmooth R package</title>
  <meta name="description" content="4 Building the flowmix_tf() method | Creating the flowsmooth R package" />
  <meta name="generator" content="bookdown 0.29 and GitBook 2.6.7" />

  <meta property="og:title" content="4 Building the flowmix_tf() method | Creating the flowsmooth R package" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4 Building the flowmix_tf() method | Creating the flowsmooth R package" />
  
  
  

<meta name="author" content="Sangwon Hyun" />


<meta name="date" content="2022-12-01" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="generating-1d-data.html"/>
<link rel="next" href="m-step.html"/>
<script src="libs/header-attrs-2.16/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="package-setup.html"><a href="package-setup.html"><i class="fa fa-check"></i><b>2</b> Package setup</a></li>
<li class="chapter" data-level="3" data-path="generating-1d-data.html"><a href="generating-1d-data.html"><i class="fa fa-check"></i><b>3</b> Generating 1d data</a></li>
<li class="chapter" data-level="4" data-path="building-the-flowmix_tf-method.html"><a href="building-the-flowmix_tf-method.html"><i class="fa fa-check"></i><b>4</b> Building the <code>flowmix_tf()</code> method</a>
<ul>
<li class="chapter" data-level="4.1" data-path="building-the-flowmix_tf-method.html"><a href="building-the-flowmix_tf-method.html#trend-filtering-briefly"><i class="fa fa-check"></i><b>4.1</b> Trend filtering, briefly</a></li>
<li class="chapter" data-level="4.2" data-path="building-the-flowmix_tf-method.html"><a href="building-the-flowmix_tf-method.html#differencing-matrix"><i class="fa fa-check"></i><b>4.2</b> Differencing matrix</a></li>
<li class="chapter" data-level="4.3" data-path="building-the-flowmix_tf-method.html"><a href="building-the-flowmix_tf-method.html#objective-data-log-likelihood"><i class="fa fa-check"></i><b>4.3</b> Objective (data log-likelihood)</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="m-step.html"><a href="m-step.html"><i class="fa fa-check"></i><b>5</b> M step</a>
<ul>
<li class="chapter" data-level="5.1" data-path="m-step.html"><a href="m-step.html#m-step-for-pi"><i class="fa fa-check"></i><b>5.1</b> M step for <span class="math inline">\(\pi\)</span></a></li>
<li class="chapter" data-level="5.2" data-path="m-step.html"><a href="m-step.html#m-step-for-sigma"><i class="fa fa-check"></i><b>5.2</b> M step for <span class="math inline">\(\Sigma\)</span></a></li>
<li class="chapter" data-level="5.3" data-path="m-step.html"><a href="m-step.html#m-step-for-mu"><i class="fa fa-check"></i><b>5.3</b> M step for <span class="math inline">\(\mu\)</span></a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="e-step.html"><a href="e-step.html"><i class="fa fa-check"></i><b>6</b> E step</a></li>
<li class="chapter" data-level="7" data-path="main-flowsmooth-function.html"><a href="main-flowsmooth-function.html"><i class="fa fa-check"></i><b>7</b> Main <code><a href='main-flowsmooth-function.html#flowsmooth'>flowsmooth</a>()</code> function</a></li>
<li class="chapter" data-level="8" data-path="plotting-for-1d-data.html"><a href="plotting-for-1d-data.html"><i class="fa fa-check"></i><b>8</b> Plotting for 1d data</a></li>
<li class="chapter" data-level="9" data-path="tuning-the-regularization-parameters-for-flowsmooth.html"><a href="tuning-the-regularization-parameters-for-flowsmooth.html"><i class="fa fa-check"></i><b>9</b> Tuning the regularization parameters for <code>flowsmooth</code></a>
<ul>
<li class="chapter" data-level="9.1" data-path="tuning-the-regularization-parameters-for-flowsmooth.html"><a href="tuning-the-regularization-parameters-for-flowsmooth.html#predicting-and-evaluating-on-new-time-points"><i class="fa fa-check"></i><b>9.1</b> Predicting and evaluating on new time points</a></li>
<li class="chapter" data-level="9.2" data-path="tuning-the-regularization-parameters-for-flowsmooth.html"><a href="tuning-the-regularization-parameters-for-flowsmooth.html#evaluating-data-fit-by-likelihood-in-an-out-of-sample-measurement."><i class="fa fa-check"></i><b>9.2</b> Evaluating data fit (by likelihood) in an out-of-sample measurement.</a></li>
<li class="chapter" data-level="9.3" data-path="tuning-the-regularization-parameters-for-flowsmooth.html"><a href="tuning-the-regularization-parameters-for-flowsmooth.html#d-example-with-ends-cut-off"><i class="fa fa-check"></i><b>9.3</b> 1d example with ends cut off</a></li>
<li class="chapter" data-level="9.4" data-path="tuning-the-regularization-parameters-for-flowsmooth.html"><a href="tuning-the-regularization-parameters-for-flowsmooth.html#d-example-with-cross-validation"><i class="fa fa-check"></i><b>9.4</b> 1d example with cross-validation</a></li>
<li class="chapter" data-level="9.5" data-path="tuning-the-regularization-parameters-for-flowsmooth.html"><a href="tuning-the-regularization-parameters-for-flowsmooth.html#maximum-lambda_mu-lambda_pi-values-to-test"><i class="fa fa-check"></i><b>9.5</b> Maximum <span class="math inline">\((\lambda_\mu, \lambda_\pi)\)</span> values to test</a></li>
<li class="chapter" data-level="9.6" data-path="tuning-the-regularization-parameters-for-flowsmooth.html"><a href="tuning-the-regularization-parameters-for-flowsmooth.html#cross-validation"><i class="fa fa-check"></i><b>9.6</b> Cross-validation</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="testing-the-flowsmooth-method.html"><a href="testing-the-flowsmooth-method.html"><i class="fa fa-check"></i><b>10</b> Testing the <code><a href='main-flowsmooth-function.html#flowsmooth'>flowsmooth</a>()</code> method</a>
<ul>
<li class="chapter" data-level="10.1" data-path="testing-the-flowsmooth-method.html"><a href="testing-the-flowsmooth-method.html#d-example"><i class="fa fa-check"></i><b>10.1</b> 1d example</a></li>
<li class="chapter" data-level="10.2" data-path="testing-the-flowsmooth-method.html"><a href="testing-the-flowsmooth-method.html#d-example-with-gap"><i class="fa fa-check"></i><b>10.2</b> 1d example with gap</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Creating the <code>flowsmooth</code> R package</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="building-the-flowmix_tf-method" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number">4</span> Building the <code>flowmix_tf()</code> method<a href="building-the-flowmix_tf-method.html#building-the-flowmix_tf-method" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="trend-filtering-briefly" class="section level2 hasAnchor" number="4.1">
<h2><span class="header-section-number">4.1</span> Trend filtering, briefly<a href="building-the-flowmix_tf-method.html#trend-filtering-briefly" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Trend filtering is a tool for
non-parametric regression on a sequence of output points <span class="math inline">\(y = (y_1,..., y_T)\)</span>
observed at locations <span class="math inline">\(x = (x_1, ..., x_T)\)</span>. It is usually assumed that <span class="math inline">\(x_1, ..., x_T\)</span> are evenly spaced points, though this can be relaxed. The trend
filtering estimate of order <span class="math inline">\(l\)</span> of the time series <span class="math inline">\(\mu_t = \mathbb{E}(y_t), t \in x\)</span> is
obtained by calculating <span class="math display">\[\hat{\mu} = \mathop{\mathrm{argmin}}_{\mu \in \mathbb{R}^T}
\frac{1}{2}\| \mu - y\|_2^2 + \lambda \| D^{(l+1)} \mu\|_1\]</span>, where <span class="math inline">\(\lambda\)</span> is
a tuning parameter and <span class="math inline">\(D^{(l+1)} \in \mathbb{R}^{T-l}\)</span> is the <span class="math inline">\((l+1)^\text{th}\)</span> order
discrete differencing matrix.</p>
</div>
<div id="differencing-matrix" class="section level2 hasAnchor" number="4.2">
<h2><span class="header-section-number">4.2</span> Differencing matrix<a href="building-the-flowmix_tf-method.html#differencing-matrix" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We first need to be able to construct the trend filtering “differencing matrix”
used for smoothing the mixture parameters over time. The general idea of the
trend filtering is explained masterfully in [Ryan’s paper, Section 6 and
equation (41)].</p>
<p>The differencing matrix is formed by recursion, starting with <span class="math inline">\(D^{(1)}\)</span>.</p>
<p><span class="math display">\[\begin{equation*}
    D^{(1)} =
    \begin{bmatrix}
    -1 &amp; 1 &amp; 0 &amp; \cdots &amp; 0 &amp; 0 \\
    0 &amp; -1 &amp; 1 &amp; \cdots &amp; 0  &amp; 0\\
    \vdots &amp; &amp; &amp; &amp; \\
    0 &amp; 0 &amp; 0 &amp; \cdots &amp; -1 &amp; 1
    \end{bmatrix}.
\end{equation*}\]</span></p>
<p>For <span class="math inline">\(l&gt;1\)</span>, the differencing matrox <span class="math inline">\(D^{(l+1)}\)</span> is defined recursively as
<span class="math inline">\(D^{(l+1)} = D^{(1)} D^{(l)}\)</span>, starting with <span class="math inline">\(D^{(1)}\)</span>.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="building-the-flowmix_tf-method.html#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Generating Difference Matrix of Specified Order</span></span>
<span id="cb7-2"><a href="building-the-flowmix_tf-method.html#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb7-3"><a href="building-the-flowmix_tf-method.html#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param n length of vector to be differenced</span></span>
<span id="cb7-4"><a href="building-the-flowmix_tf-method.html#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param l order of differencing</span></span>
<span id="cb7-5"><a href="building-the-flowmix_tf-method.html#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param x optional. Spacing of input points.</span></span>
<span id="cb7-6"><a href="building-the-flowmix_tf-method.html#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb7-7"><a href="building-the-flowmix_tf-method.html#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A n by n-l-1 matrix</span></span>
<span id="cb7-8"><a href="building-the-flowmix_tf-method.html#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb7-9"><a href="building-the-flowmix_tf-method.html#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb7-10"><a href="building-the-flowmix_tf-method.html#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @examples</span></span>
<span id="cb7-11"><a href="building-the-flowmix_tf-method.html#cb7-11" aria-hidden="true" tabindex="-1"></a><span id='gen_diff_mat'>gen_diff_mat</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(n, l, <span class="at">x =</span> <span class="cn">NULL</span>){</span>
<span id="cb7-12"><a href="building-the-flowmix_tf-method.html#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="building-the-flowmix_tf-method.html#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Basic check</span></span>
<span id="cb7-14"><a href="building-the-flowmix_tf-method.html#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(x))  <span class="fu">stopifnot</span>(<span class="fu">length</span>(x) <span class="sc">==</span> n)</span>
<span id="cb7-15"><a href="building-the-flowmix_tf-method.html#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="building-the-flowmix_tf-method.html#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span id='get_D1'>get_D1</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(t) {<span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>(t<span class="dv">-1</span>), <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb7-17"><a href="building-the-flowmix_tf-method.html#cb7-17" aria-hidden="true" tabindex="-1"></a>    v <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, t)</span>
<span id="cb7-18"><a href="building-the-flowmix_tf-method.html#cb7-18" aria-hidden="true" tabindex="-1"></a>    v[x] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span></span>
<span id="cb7-19"><a href="building-the-flowmix_tf-method.html#cb7-19" aria-hidden="true" tabindex="-1"></a>    v[x<span class="sc">+</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb7-20"><a href="building-the-flowmix_tf-method.html#cb7-20" aria-hidden="true" tabindex="-1"></a>    v</span>
<span id="cb7-21"><a href="building-the-flowmix_tf-method.html#cb7-21" aria-hidden="true" tabindex="-1"></a>  }))}</span>
<span id="cb7-22"><a href="building-the-flowmix_tf-method.html#cb7-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-23"><a href="building-the-flowmix_tf-method.html#cb7-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(x)){</span>
<span id="cb7-24"><a href="building-the-flowmix_tf-method.html#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(l <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb7-25"><a href="building-the-flowmix_tf-method.html#cb7-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">diag</span>(<span class="fu">rep</span>(<span class="dv">1</span>,n)))</span>
<span id="cb7-26"><a href="building-the-flowmix_tf-method.html#cb7-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-27"><a href="building-the-flowmix_tf-method.html#cb7-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(l <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb7-28"><a href="building-the-flowmix_tf-method.html#cb7-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<a href='building-the-flowmix_tf-method.html#get_D1'>get_D1</a>(n))</span>
<span id="cb7-29"><a href="building-the-flowmix_tf-method.html#cb7-29" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-30"><a href="building-the-flowmix_tf-method.html#cb7-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(l <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb7-31"><a href="building-the-flowmix_tf-method.html#cb7-31" aria-hidden="true" tabindex="-1"></a>      D <span class="ot">&lt;-</span> <a href='building-the-flowmix_tf-method.html#get_D1'>get_D1</a>(n)</span>
<span id="cb7-32"><a href="building-the-flowmix_tf-method.html#cb7-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(l<span class="dv">-1</span>)){</span>
<span id="cb7-33"><a href="building-the-flowmix_tf-method.html#cb7-33" aria-hidden="true" tabindex="-1"></a>        D <span class="ot">&lt;-</span> <a href='building-the-flowmix_tf-method.html#get_D1'>get_D1</a>(n<span class="sc">-</span>k) <span class="sc">%*%</span> D</span>
<span id="cb7-34"><a href="building-the-flowmix_tf-method.html#cb7-34" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb7-35"><a href="building-the-flowmix_tf-method.html#cb7-35" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(D)</span>
<span id="cb7-36"><a href="building-the-flowmix_tf-method.html#cb7-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-37"><a href="building-the-flowmix_tf-method.html#cb7-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-38"><a href="building-the-flowmix_tf-method.html#cb7-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb7-39"><a href="building-the-flowmix_tf-method.html#cb7-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(l <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb7-40"><a href="building-the-flowmix_tf-method.html#cb7-40" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">diag</span>(<span class="fu">rep</span>(<span class="dv">1</span>,n)))</span>
<span id="cb7-41"><a href="building-the-flowmix_tf-method.html#cb7-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-42"><a href="building-the-flowmix_tf-method.html#cb7-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(l <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb7-43"><a href="building-the-flowmix_tf-method.html#cb7-43" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<a href='building-the-flowmix_tf-method.html#get_D1'>get_D1</a>(n))</span>
<span id="cb7-44"><a href="building-the-flowmix_tf-method.html#cb7-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-45"><a href="building-the-flowmix_tf-method.html#cb7-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(l <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb7-46"><a href="building-the-flowmix_tf-method.html#cb7-46" aria-hidden="true" tabindex="-1"></a>      D <span class="ot">&lt;-</span> <a href='building-the-flowmix_tf-method.html#get_D1'>get_D1</a>(n)</span>
<span id="cb7-47"><a href="building-the-flowmix_tf-method.html#cb7-47" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(l<span class="dv">-1</span>)){</span>
<span id="cb7-48"><a href="building-the-flowmix_tf-method.html#cb7-48" aria-hidden="true" tabindex="-1"></a>        D <span class="ot">&lt;-</span> <a href='building-the-flowmix_tf-method.html#get_D1'>get_D1</a>(n<span class="sc">-</span>k) <span class="sc">%*%</span> <span class="fu">diag</span>(k<span class="sc">/</span><span class="fu">diff</span>(x, <span class="at">lag =</span> k)) <span class="sc">%*%</span> D</span>
<span id="cb7-49"><a href="building-the-flowmix_tf-method.html#cb7-49" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb7-50"><a href="building-the-flowmix_tf-method.html#cb7-50" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(D)</span>
<span id="cb7-51"><a href="building-the-flowmix_tf-method.html#cb7-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-52"><a href="building-the-flowmix_tf-method.html#cb7-52" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-53"><a href="building-the-flowmix_tf-method.html#cb7-53" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>For equally spaced inputs:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="building-the-flowmix_tf-method.html#cb8-1" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">load_all</span>(<span class="st">&quot;~/repos/flowsmooth/flowsmooth&quot;</span>)</span>
<span id="cb8-2"><a href="building-the-flowmix_tf-method.html#cb8-2" aria-hidden="true" tabindex="-1"></a>TT <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb8-3"><a href="building-the-flowmix_tf-method.html#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="building-the-flowmix_tf-method.html#cb8-4" aria-hidden="true" tabindex="-1"></a>l <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb8-5"><a href="building-the-flowmix_tf-method.html#cb8-5" aria-hidden="true" tabindex="-1"></a>Dl <span class="ot">=</span> <a href='building-the-flowmix_tf-method.html#gen_diff_mat'>gen_diff_mat</a>(<span class="at">n =</span> <span class="dv">10</span>, <span class="at">l =</span> l<span class="sc">+</span><span class="dv">1</span>, <span class="at">x =</span> <span class="cn">NULL</span>)</span>
<span id="cb8-6"><a href="building-the-flowmix_tf-method.html#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(Dl)</span>
<span id="cb8-7"><a href="building-the-flowmix_tf-method.html#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="building-the-flowmix_tf-method.html#cb8-8" aria-hidden="true" tabindex="-1"></a>l <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb8-9"><a href="building-the-flowmix_tf-method.html#cb8-9" aria-hidden="true" tabindex="-1"></a>Dl <span class="ot">=</span> <a href='building-the-flowmix_tf-method.html#gen_diff_mat'>gen_diff_mat</a>(<span class="at">n =</span> <span class="dv">10</span>, <span class="at">l =</span> l<span class="sc">+</span><span class="dv">1</span>, <span class="at">x =</span> <span class="cn">NULL</span>)</span>
<span id="cb8-10"><a href="building-the-flowmix_tf-method.html#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(Dl)</span>
<span id="cb8-11"><a href="building-the-flowmix_tf-method.html#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="building-the-flowmix_tf-method.html#cb8-12" aria-hidden="true" tabindex="-1"></a>l <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb8-13"><a href="building-the-flowmix_tf-method.html#cb8-13" aria-hidden="true" tabindex="-1"></a>Dl <span class="ot">=</span> <a href='building-the-flowmix_tf-method.html#gen_diff_mat'>gen_diff_mat</a>(<span class="at">n =</span> <span class="dv">10</span>, <span class="at">l =</span> l<span class="sc">+</span><span class="dv">1</span>, <span class="at">x =</span> <span class="cn">NULL</span>)</span>
<span id="cb8-14"><a href="building-the-flowmix_tf-method.html#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(Dl)</span></code></pre></div>
<pre><code>## ℹ Loading flowsmooth</code></pre>
<pre><code>##      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]
## [1,]    1   -2    1    0    0    0    0    0    0     0
## [2,]    0    1   -2    1    0    0    0    0    0     0
## [3,]    0    0    1   -2    1    0    0    0    0     0
## [4,]    0    0    0    1   -2    1    0    0    0     0
## [5,]    0    0    0    0    1   -2    1    0    0     0
## [6,]    0    0    0    0    0    1   -2    1    0     0
## [7,]    0    0    0    0    0    0    1   -2    1     0
## [8,]    0    0    0    0    0    0    0    1   -2     1</code></pre>
<pre><code>##      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]
## [1,]    1   -2    1    0    0    0    0    0    0     0
## [2,]    0    1   -2    1    0    0    0    0    0     0
## [3,]    0    0    1   -2    1    0    0    0    0     0
## [4,]    0    0    0    1   -2    1    0    0    0     0
## [5,]    0    0    0    0    1   -2    1    0    0     0
## [6,]    0    0    0    0    0    1   -2    1    0     0
## [7,]    0    0    0    0    0    0    1   -2    1     0
## [8,]    0    0    0    0    0    0    0    1   -2     1</code></pre>
<pre><code>##      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]
## [1,]   -1    3   -3    1    0    0    0    0    0     0
## [2,]    0   -1    3   -3    1    0    0    0    0     0
## [3,]    0    0   -1    3   -3    1    0    0    0     0
## [4,]    0    0    0   -1    3   -3    1    0    0     0
## [5,]    0    0    0    0   -1    3   -3    1    0     0
## [6,]    0    0    0    0    0   -1    3   -3    1     0
## [7,]    0    0    0    0    0    0   -1    3   -3     1</code></pre>
<p>When the inputs have a gap in it:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="building-the-flowmix_tf-method.html#cb13-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> (<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)[<span class="sc">-</span>(<span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>)]</span>
<span id="cb13-2"><a href="building-the-flowmix_tf-method.html#cb13-2" aria-hidden="true" tabindex="-1"></a>l <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb13-3"><a href="building-the-flowmix_tf-method.html#cb13-3" aria-hidden="true" tabindex="-1"></a>TT <span class="ot">=</span> <span class="fu">length</span>(x)</span>
<span id="cb13-4"><a href="building-the-flowmix_tf-method.html#cb13-4" aria-hidden="true" tabindex="-1"></a>Dl <span class="ot">=</span> <a href='building-the-flowmix_tf-method.html#gen_diff_mat'>gen_diff_mat</a>(<span class="at">n =</span> TT, <span class="at">l =</span> l<span class="sc">+</span><span class="dv">1</span>, <span class="at">x =</span> x)</span>
<span id="cb13-5"><a href="building-the-flowmix_tf-method.html#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(Dl)</span></code></pre></div>
<p>Next, here’s a function to build a lasso regressor matrix <span class="math inline">\(H\)</span> that can be used
to solve an equivalent problem as the trend filtering of the ’th degree.
(This is stated in Lemma 4, equation (25) from Tibshirani (2014))</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="building-the-flowmix_tf-method.html#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; A lasso regressor matrix H that can be used to solve an equivalent problem as the trend filtering of the \code{k}&#39;th degree.</span></span>
<span id="cb14-2"><a href="building-the-flowmix_tf-method.html#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb14-3"><a href="building-the-flowmix_tf-method.html#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param n Total number of time points.</span></span>
<span id="cb14-4"><a href="building-the-flowmix_tf-method.html#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param k Degree of trend filtering for cluster probabilities.</span></span>
<span id="cb14-5"><a href="building-the-flowmix_tf-method.html#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param x Time points</span></span>
<span id="cb14-6"><a href="building-the-flowmix_tf-method.html#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb14-7"><a href="building-the-flowmix_tf-method.html#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return $n$ by $n$ matrix.</span></span>
<span id="cb14-8"><a href="building-the-flowmix_tf-method.html#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb14-9"><a href="building-the-flowmix_tf-method.html#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb14-10"><a href="building-the-flowmix_tf-method.html#cb14-10" aria-hidden="true" tabindex="-1"></a><span id='gen_tf_mat'>gen_tf_mat</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(n, k, <span class="at">x =</span> <span class="cn">NULL</span>){</span>
<span id="cb14-11"><a href="building-the-flowmix_tf-method.html#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="building-the-flowmix_tf-method.html#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(x) ){</span>
<span id="cb14-13"><a href="building-the-flowmix_tf-method.html#cb14-13" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">=</span> (<span class="dv">1</span><span class="sc">:</span>n)<span class="sc">/</span>n</span>
<span id="cb14-14"><a href="building-the-flowmix_tf-method.html#cb14-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-15"><a href="building-the-flowmix_tf-method.html#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(x)){</span>
<span id="cb14-16"><a href="building-the-flowmix_tf-method.html#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(x) <span class="sc">==</span> n)</span>
<span id="cb14-17"><a href="building-the-flowmix_tf-method.html#cb14-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-18"><a href="building-the-flowmix_tf-method.html#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="building-the-flowmix_tf-method.html#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="do">## For every i,j&#39;th entry, use this helper function (from eq 25 of Tibshirani</span></span>
<span id="cb14-20"><a href="building-the-flowmix_tf-method.html#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="do">## (2014)).</span></span>
<span id="cb14-21"><a href="building-the-flowmix_tf-method.html#cb14-21" aria-hidden="true" tabindex="-1"></a>  <span id='gen_ij'>gen_ij</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(i,j){</span>
<span id="cb14-22"><a href="building-the-flowmix_tf-method.html#cb14-22" aria-hidden="true" tabindex="-1"></a>    xi <span class="ot">&lt;-</span> x[i]</span>
<span id="cb14-23"><a href="building-the-flowmix_tf-method.html#cb14-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(j <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span>(k<span class="sc">+</span><span class="dv">1</span>)){</span>
<span id="cb14-24"><a href="building-the-flowmix_tf-method.html#cb14-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(xi<span class="sc">^</span>(j<span class="dv">-1</span>))</span>
<span id="cb14-25"><a href="building-the-flowmix_tf-method.html#cb14-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-26"><a href="building-the-flowmix_tf-method.html#cb14-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(j <span class="sc">%in%</span> (k<span class="sc">+</span><span class="dv">2</span>)<span class="sc">:</span>n){</span>
<span id="cb14-27"><a href="building-the-flowmix_tf-method.html#cb14-27" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">prod</span>(xi <span class="sc">-</span> x[(j<span class="sc">-</span>k)<span class="sc">:</span>(j<span class="dv">-1</span>)]) <span class="sc">*</span> <span class="fu">ifelse</span>(xi <span class="sc">&gt;=</span> x[(j<span class="dv">-1</span>)], <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb14-28"><a href="building-the-flowmix_tf-method.html#cb14-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-29"><a href="building-the-flowmix_tf-method.html#cb14-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-30"><a href="building-the-flowmix_tf-method.html#cb14-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-31"><a href="building-the-flowmix_tf-method.html#cb14-31" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Generate the H matrix, entry-wise.</span></span>
<span id="cb14-32"><a href="building-the-flowmix_tf-method.html#cb14-32" aria-hidden="true" tabindex="-1"></a>  H <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> n, <span class="at">ncol =</span> n)</span>
<span id="cb14-33"><a href="building-the-flowmix_tf-method.html#cb14-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n){</span>
<span id="cb14-34"><a href="building-the-flowmix_tf-method.html#cb14-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n){</span>
<span id="cb14-35"><a href="building-the-flowmix_tf-method.html#cb14-35" aria-hidden="true" tabindex="-1"></a>      H[i,j] <span class="ot">&lt;-</span> <a href='building-the-flowmix_tf-method.html#gen_ij'>gen_ij</a>(i,j)</span>
<span id="cb14-36"><a href="building-the-flowmix_tf-method.html#cb14-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-37"><a href="building-the-flowmix_tf-method.html#cb14-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-38"><a href="building-the-flowmix_tf-method.html#cb14-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(H)</span>
<span id="cb14-39"><a href="building-the-flowmix_tf-method.html#cb14-39" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Here’s a simple test.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="building-the-flowmix_tf-method.html#cb15-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;Trend filtering regression matrix is created correctly.&quot;</span>, {</span>
<span id="cb15-2"><a href="building-the-flowmix_tf-method.html#cb15-2" aria-hidden="true" tabindex="-1"></a>  H1 <span class="ot">&lt;-</span> <a href='building-the-flowmix_tf-method.html#gen_tf_mat'>gen_tf_mat</a>(<span class="dv">10</span>, <span class="dv">1</span>)</span>
<span id="cb15-3"><a href="building-the-flowmix_tf-method.html#cb15-3" aria-hidden="true" tabindex="-1"></a>  H2 <span class="ot">&lt;-</span> <a href='building-the-flowmix_tf-method.html#gen_tf_mat'>gen_tf_mat</a>(<span class="dv">10</span>, <span class="dv">1</span>, <span class="at">x=</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)<span class="sc">/</span><span class="dv">10</span>)</span>
<span id="cb15-4"><a href="building-the-flowmix_tf-method.html#cb15-4" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(H1, H2)</span>
<span id="cb15-5"><a href="building-the-flowmix_tf-method.html#cb15-5" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">dim</span>(H1), <span class="fu">c</span>(<span class="dv">10</span>,<span class="dv">10</span>))</span>
<span id="cb15-6"><a href="building-the-flowmix_tf-method.html#cb15-6" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🥳</code></pre>
</div>
<div id="objective-data-log-likelihood" class="section level2 hasAnchor" number="4.3">
<h2><span class="header-section-number">4.3</span> Objective (data log-likelihood)<a href="building-the-flowmix_tf-method.html#objective-data-log-likelihood" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>First, <code><a href='building-the-flowmix_tf-method.html#loglik_tt'>loglik_tt</a>()</code> calculates the log-likelihood of one cytogram, which is:</p>
<p><span class="math display">\[\sum_{i=1}^{n_t} C_i^{(t)} \log\left( \sum_{k=1}^K \pi_{itk} \phi(y_i^{(t)}; \mu_{kt}, \Sigma_k) \right) \]</span></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="building-the-flowmix_tf-method.html#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param mu Cluster means.</span></span>
<span id="cb17-2"><a href="building-the-flowmix_tf-method.html#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param prob Cluster probabilities.</span></span>
<span id="cb17-3"><a href="building-the-flowmix_tf-method.html#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param prob Cluster variances.</span></span>
<span id="cb17-4"><a href="building-the-flowmix_tf-method.html#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param ylist Data.</span></span>
<span id="cb17-5"><a href="building-the-flowmix_tf-method.html#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param tt Time point.</span></span>
<span id="cb17-6"><a href="building-the-flowmix_tf-method.html#cb17-6" aria-hidden="true" tabindex="-1"></a><span id='loglik_tt'>loglik_tt</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(ylist, tt, mu, sigma, prob, <span class="at">dimdat =</span> <span class="cn">NULL</span>, <span class="at">countslist =</span> <span class="cn">NULL</span>, numclust){</span>
<span id="cb17-7"><a href="building-the-flowmix_tf-method.html#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="building-the-flowmix_tf-method.html#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="do">## One particle&#39;s log likelihood (weighted density)</span></span>
<span id="cb17-9"><a href="building-the-flowmix_tf-method.html#cb17-9" aria-hidden="true" tabindex="-1"></a>  weighted.densities <span class="ot">=</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span>numclust, <span class="cf">function</span>(iclust){</span>
<span id="cb17-10"><a href="building-the-flowmix_tf-method.html#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(dimdat <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb17-11"><a href="building-the-flowmix_tf-method.html#cb17-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(prob[tt,iclust] <span class="sc">*</span> <span class="fu">dnorm</span>(ylist[[tt]], mu[tt,,iclust], <span class="fu">sqrt</span>(sigma[iclust,,])))</span>
<span id="cb17-12"><a href="building-the-flowmix_tf-method.html#cb17-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-13"><a href="building-the-flowmix_tf-method.html#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(dimdat <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb17-14"><a href="building-the-flowmix_tf-method.html#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(prob[tt,iclust] <span class="sc">*</span> <span class="fu">dmvnorm_arma_fast</span>(ylist[[tt]], mu[tt,,iclust], <span class="fu">as.matrix</span>(sigma[iclust,,]), <span class="cn">FALSE</span>))</span>
<span id="cb17-15"><a href="building-the-flowmix_tf-method.html#cb17-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-16"><a href="building-the-flowmix_tf-method.html#cb17-16" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb17-17"><a href="building-the-flowmix_tf-method.html#cb17-17" aria-hidden="true" tabindex="-1"></a>  nt <span class="ot">=</span> <span class="fu">nrow</span>(ylist[[tt]])</span>
<span id="cb17-18"><a href="building-the-flowmix_tf-method.html#cb17-18" aria-hidden="true" tabindex="-1"></a>  counts <span class="ot">=</span> (<span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(countslist)) countslist[[tt]] <span class="cf">else</span> <span class="fu">rep</span>(<span class="dv">1</span>, nt))</span>
<span id="cb17-19"><a href="building-the-flowmix_tf-method.html#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="building-the-flowmix_tf-method.html#cb17-20" aria-hidden="true" tabindex="-1"></a>  sum_wt_dens <span class="ot">=</span> <span class="fu">rowSums</span>(weighted.densities)</span>
<span id="cb17-21"><a href="building-the-flowmix_tf-method.html#cb17-21" aria-hidden="true" tabindex="-1"></a>  sum_wt_dens <span class="ot">=</span> sum_wt_dens <span class="sc">%&gt;%</span> <span class="fu">pmax</span>(<span class="fl">1E-100</span>)</span>
<span id="cb17-22"><a href="building-the-flowmix_tf-method.html#cb17-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-23"><a href="building-the-flowmix_tf-method.html#cb17-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">sum</span>(<span class="fu">log</span>(sum_wt_dens) <span class="sc">*</span> counts))</span>
<span id="cb17-24"><a href="building-the-flowmix_tf-method.html#cb17-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Next, here is the function that calculates the entire objective from all
cytograms, given model parameter <code>mu</code>, <code>prob</code>, and <code>sigma</code>.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="building-the-flowmix_tf-method.html#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Evaluating the penalized data log-likelihood on all data \code{ylist} given parameters \code{mu}, \code{prob}, and \code{sigma}.</span></span>
<span id="cb18-2"><a href="building-the-flowmix_tf-method.html#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb18-3"><a href="building-the-flowmix_tf-method.html#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param mu</span></span>
<span id="cb18-4"><a href="building-the-flowmix_tf-method.html#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param prob</span></span>
<span id="cb18-5"><a href="building-the-flowmix_tf-method.html#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param prob_link</span></span>
<span id="cb18-6"><a href="building-the-flowmix_tf-method.html#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param sigma</span></span>
<span id="cb18-7"><a href="building-the-flowmix_tf-method.html#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param ylist</span></span>
<span id="cb18-8"><a href="building-the-flowmix_tf-method.html#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param Dl</span></span>
<span id="cb18-9"><a href="building-the-flowmix_tf-method.html#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param l</span></span>
<span id="cb18-10"><a href="building-the-flowmix_tf-method.html#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param lambda</span></span>
<span id="cb18-11"><a href="building-the-flowmix_tf-method.html#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param l_prob</span></span>
<span id="cb18-12"><a href="building-the-flowmix_tf-method.html#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param Dl_prob</span></span>
<span id="cb18-13"><a href="building-the-flowmix_tf-method.html#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param lambda_prob</span></span>
<span id="cb18-14"><a href="building-the-flowmix_tf-method.html#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param alpha</span></span>
<span id="cb18-15"><a href="building-the-flowmix_tf-method.html#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param beta</span></span>
<span id="cb18-16"><a href="building-the-flowmix_tf-method.html#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param denslist_by_clust</span></span>
<span id="cb18-17"><a href="building-the-flowmix_tf-method.html#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param countslist</span></span>
<span id="cb18-18"><a href="building-the-flowmix_tf-method.html#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param unpenalized if TRUE, return the unpenalized out-of-sample fit.</span></span>
<span id="cb18-19"><a href="building-the-flowmix_tf-method.html#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb18-20"><a href="building-the-flowmix_tf-method.html#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return</span></span>
<span id="cb18-21"><a href="building-the-flowmix_tf-method.html#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb18-22"><a href="building-the-flowmix_tf-method.html#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb18-23"><a href="building-the-flowmix_tf-method.html#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @examples</span></span>
<span id="cb18-24"><a href="building-the-flowmix_tf-method.html#cb18-24" aria-hidden="true" tabindex="-1"></a><span id='objective'>objective</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(mu, prob, <span class="at">prob_link =</span> <span class="cn">NULL</span>, sigma,</span>
<span id="cb18-25"><a href="building-the-flowmix_tf-method.html#cb18-25" aria-hidden="true" tabindex="-1"></a>                      <span class="do">## TT, N, dimdat, numclust,</span></span>
<span id="cb18-26"><a href="building-the-flowmix_tf-method.html#cb18-26" aria-hidden="true" tabindex="-1"></a>                      ylist,</span>
<span id="cb18-27"><a href="building-the-flowmix_tf-method.html#cb18-27" aria-hidden="true" tabindex="-1"></a>                      Dl, <span class="at">l =</span> <span class="cn">NULL</span>,</span>
<span id="cb18-28"><a href="building-the-flowmix_tf-method.html#cb18-28" aria-hidden="true" tabindex="-1"></a>                      <span class="at">lambda =</span> <span class="dv">0</span>,</span>
<span id="cb18-29"><a href="building-the-flowmix_tf-method.html#cb18-29" aria-hidden="true" tabindex="-1"></a>                      <span class="at">l_prob =</span> <span class="cn">NULL</span>,</span>
<span id="cb18-30"><a href="building-the-flowmix_tf-method.html#cb18-30" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Dl_prob =</span> <span class="cn">NULL</span>,</span>
<span id="cb18-31"><a href="building-the-flowmix_tf-method.html#cb18-31" aria-hidden="true" tabindex="-1"></a>                      <span class="at">lambda_prob =</span> <span class="dv">0</span>,</span>
<span id="cb18-32"><a href="building-the-flowmix_tf-method.html#cb18-32" aria-hidden="true" tabindex="-1"></a>                      <span class="at">alpha =</span> <span class="cn">NULL</span>, <span class="at">beta =</span> <span class="cn">NULL</span>,</span>
<span id="cb18-33"><a href="building-the-flowmix_tf-method.html#cb18-33" aria-hidden="true" tabindex="-1"></a>                      <span class="at">denslist_by_clust =</span> <span class="cn">NULL</span>,</span>
<span id="cb18-34"><a href="building-the-flowmix_tf-method.html#cb18-34" aria-hidden="true" tabindex="-1"></a>                      <span class="at">countslist =</span> <span class="cn">NULL</span>,</span>
<span id="cb18-35"><a href="building-the-flowmix_tf-method.html#cb18-35" aria-hidden="true" tabindex="-1"></a>                      <span class="at">unpenalized =</span> <span class="cn">FALSE</span>){</span>
<span id="cb18-36"><a href="building-the-flowmix_tf-method.html#cb18-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-37"><a href="building-the-flowmix_tf-method.html#cb18-37" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Set some important variables</span></span>
<span id="cb18-38"><a href="building-the-flowmix_tf-method.html#cb18-38" aria-hidden="true" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="fu">dim</span>(mu)[<span class="dv">1</span>]</span>
<span id="cb18-39"><a href="building-the-flowmix_tf-method.html#cb18-39" aria-hidden="true" tabindex="-1"></a>  numclust <span class="ot">=</span> <span class="fu">dim</span>(mu)[<span class="dv">3</span>]</span>
<span id="cb18-40"><a href="building-the-flowmix_tf-method.html#cb18-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(countslist)){</span>
<span id="cb18-41"><a href="building-the-flowmix_tf-method.html#cb18-41" aria-hidden="true" tabindex="-1"></a>    ntlist <span class="ot">=</span> <span class="fu">sapply</span>(ylist, nrow)</span>
<span id="cb18-42"><a href="building-the-flowmix_tf-method.html#cb18-42" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb18-43"><a href="building-the-flowmix_tf-method.html#cb18-43" aria-hidden="true" tabindex="-1"></a>    ntlist <span class="ot">=</span> <span class="fu">sapply</span>(countslist, sum)</span>
<span id="cb18-44"><a href="building-the-flowmix_tf-method.html#cb18-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-45"><a href="building-the-flowmix_tf-method.html#cb18-45" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">=</span> <span class="fu">sum</span>(ntlist)</span>
<span id="cb18-46"><a href="building-the-flowmix_tf-method.html#cb18-46" aria-hidden="true" tabindex="-1"></a>  dimdat <span class="ot">=</span> <span class="fu">ncol</span>(ylist[[<span class="dv">1</span>]])</span>
<span id="cb18-47"><a href="building-the-flowmix_tf-method.html#cb18-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-48"><a href="building-the-flowmix_tf-method.html#cb18-48" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Calculate the log likelihood</span></span>
<span id="cb18-49"><a href="building-the-flowmix_tf-method.html#cb18-49" aria-hidden="true" tabindex="-1"></a>  loglik <span class="ot">=</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="cf">function</span>(tt){</span>
<span id="cb18-50"><a href="building-the-flowmix_tf-method.html#cb18-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(denslist_by_clust)){</span>
<span id="cb18-51"><a href="building-the-flowmix_tf-method.html#cb18-51" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<a href='building-the-flowmix_tf-method.html#loglik_tt'>loglik_tt</a>(ylist, tt, mu, sigma, prob, countslist, <span class="at">numclust =</span> numclust, <span class="at">dimdat =</span> dimdat))</span>
<span id="cb18-52"><a href="building-the-flowmix_tf-method.html#cb18-52" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb18-53"><a href="building-the-flowmix_tf-method.html#cb18-53" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">loglik_tt_precalculate</span>(ylist, tt, denslist_by_clust, prob, countslist, numclust))</span>
<span id="cb18-54"><a href="building-the-flowmix_tf-method.html#cb18-54" aria-hidden="true" tabindex="-1"></a>      <span class="do">## </span><span class="al">TODO</span><span class="do">: This doesn&#39;t exist yet, but might need to, since.. speed!</span></span>
<span id="cb18-55"><a href="building-the-flowmix_tf-method.html#cb18-55" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-56"><a href="building-the-flowmix_tf-method.html#cb18-56" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb18-57"><a href="building-the-flowmix_tf-method.html#cb18-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-58"><a href="building-the-flowmix_tf-method.html#cb18-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(unpenalized){</span>
<span id="cb18-59"><a href="building-the-flowmix_tf-method.html#cb18-59" aria-hidden="true" tabindex="-1"></a>    obj <span class="ot">=</span>  <span class="sc">-</span><span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> <span class="fu">sum</span>(<span class="fu">unlist</span>(loglik)) </span>
<span id="cb18-60"><a href="building-the-flowmix_tf-method.html#cb18-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(obj)</span>
<span id="cb18-61"><a href="building-the-flowmix_tf-method.html#cb18-61" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb18-62"><a href="building-the-flowmix_tf-method.html#cb18-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-63"><a href="building-the-flowmix_tf-method.html#cb18-63" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Return penalized likelihood</span></span>
<span id="cb18-64"><a href="building-the-flowmix_tf-method.html#cb18-64" aria-hidden="true" tabindex="-1"></a>    mu.splt <span class="ot">&lt;-</span> <span class="fu">asplit</span>(mu, <span class="at">MARGIN =</span> <span class="dv">3</span>)</span>
<span id="cb18-65"><a href="building-the-flowmix_tf-method.html#cb18-65" aria-hidden="true" tabindex="-1"></a>    diff_mu <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">unlist</span>(<span class="fu">lapply</span>(mu.splt, <span class="at">FUN =</span> <span class="cf">function</span>(m) <span class="fu">sum</span>(<span class="fu">abs</span>(Dl <span class="sc">%*%</span> m)))))</span>
<span id="cb18-66"><a href="building-the-flowmix_tf-method.html#cb18-66" aria-hidden="true" tabindex="-1"></a>    <span class="do">## diff_prob &lt;- sum(abs(Dl_prob %*% log(prob * sapply(countslist, sum))))</span></span>
<span id="cb18-67"><a href="building-the-flowmix_tf-method.html#cb18-67" aria-hidden="true" tabindex="-1"></a>    diff_prob <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">abs</span>(Dl_prob <span class="sc">%*%</span> prob_link))</span>
<span id="cb18-68"><a href="building-the-flowmix_tf-method.html#cb18-68" aria-hidden="true" tabindex="-1"></a>    obj <span class="ot">=</span>  <span class="sc">-</span><span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> <span class="fu">sum</span>(<span class="fu">unlist</span>(loglik)) <span class="sc">+</span> lambda <span class="sc">*</span> diff_mu <span class="sc">+</span> lambda_prob <span class="sc">*</span> diff_prob</span>
<span id="cb18-69"><a href="building-the-flowmix_tf-method.html#cb18-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(obj)</span>
<span id="cb18-70"><a href="building-the-flowmix_tf-method.html#cb18-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-71"><a href="building-the-flowmix_tf-method.html#cb18-71" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Here’s a helper to check numerical convergence of the EM algorithm.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="building-the-flowmix_tf-method.html#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Checks numerical improvement in objective value. Returns TRUE if |old-new|/|old| is smaller than tol.</span></span>
<span id="cb19-2"><a href="building-the-flowmix_tf-method.html#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb19-3"><a href="building-the-flowmix_tf-method.html#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param old Objective value from previous iteration.</span></span>
<span id="cb19-4"><a href="building-the-flowmix_tf-method.html#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param new Objective value from current iteration.</span></span>
<span id="cb19-5"><a href="building-the-flowmix_tf-method.html#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param tol Numerical tolerance.</span></span>
<span id="cb19-6"><a href="building-the-flowmix_tf-method.html#cb19-6" aria-hidden="true" tabindex="-1"></a><span id='check_converge_rel'>check_converge_rel</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(old, new, <span class="at">tol=</span><span class="fl">1E-6</span>){</span>
<span id="cb19-7"><a href="building-the-flowmix_tf-method.html#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">abs</span>((old<span class="sc">-</span>new)<span class="sc">/</span>old) <span class="sc">&lt;</span> tol )</span>
<span id="cb19-8"><a href="building-the-flowmix_tf-method.html#cb19-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Here’s also a helper function to do the softmax-ing of <span class="math inline">\(\alpha_t \in \mathbb{R}^K\)</span>.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="building-the-flowmix_tf-method.html#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Converts the Xbeta to <a href='building-the-flowmix_tf-method.html#softmax'>softmax</a>(Xbeta), so to speak. Xbeta is the linear functional of X from a multinomial regression; in our notation, it&#39;s alpha.</span></span>
<span id="cb20-2"><a href="building-the-flowmix_tf-method.html#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb20-3"><a href="building-the-flowmix_tf-method.html#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param prob_link alpha, which is a (T x K) matrix.</span></span>
<span id="cb20-4"><a href="building-the-flowmix_tf-method.html#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb20-5"><a href="building-the-flowmix_tf-method.html#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return exp(alpha)/rowSum(exp(alpha)). A (T x K) matrix.</span></span>
<span id="cb20-6"><a href="building-the-flowmix_tf-method.html#cb20-6" aria-hidden="true" tabindex="-1"></a><span id='softmax'>softmax</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(prob_link){</span>
<span id="cb20-7"><a href="building-the-flowmix_tf-method.html#cb20-7" aria-hidden="true" tabindex="-1"></a>  exp_prob_link <span class="ot">=</span> <span class="fu">exp</span>(prob_link)</span>
<span id="cb20-8"><a href="building-the-flowmix_tf-method.html#cb20-8" aria-hidden="true" tabindex="-1"></a>  prob <span class="ot">=</span> exp_prob_link <span class="sc">/</span> <span class="fu">rowSums</span>(exp_prob_link)</span>
<span id="cb20-9"><a href="building-the-flowmix_tf-method.html#cb20-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-10"><a href="building-the-flowmix_tf-method.html#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="building-the-flowmix_tf-method.html#cb20-11" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;Test for softmax&quot;</span>,{</span>
<span id="cb20-12"><a href="building-the-flowmix_tf-method.html#cb20-12" aria-hidden="true" tabindex="-1"></a>  link <span class="ot">=</span> <span class="fu">runif</span>(<span class="dv">100</span>, <span class="at">min =</span> <span class="sc">-</span><span class="dv">10</span>, <span class="at">max =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="dv">10</span>, <span class="at">ncol =</span> <span class="dv">10</span>)</span>
<span id="cb20-13"><a href="building-the-flowmix_tf-method.html#cb20-13" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(<span class="fu">rowSums</span>(<a href='building-the-flowmix_tf-method.html#softmax'>softmax</a>(link)) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">&lt;</span> <span class="fl">1E-13</span>))</span>
<span id="cb20-14"><a href="building-the-flowmix_tf-method.html#cb20-14" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 😸</code></pre>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="generating-1d-data.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="m-step.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
