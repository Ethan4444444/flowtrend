<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>16 Helpers for simulations in the paper | Creating the flowtrend R package</title>
  <meta name="description" content="16 Helpers for simulations in the paper | Creating the flowtrend R package" />
  <meta name="generator" content="bookdown 0.35 and GitBook 2.6.7" />

  <meta property="og:title" content="16 Helpers for simulations in the paper | Creating the flowtrend R package" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="16 Helpers for simulations in the paper | Creating the flowtrend R package" />
  
  
  

<meta name="author" content="Sangwon Hyun, Tim Coleman, Francois Ribalet, Jacob Bien" />


<meta name="date" content="2024-05-07" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="documenting-the-package-and-building.html"/>

<script src="libs/header-attrs-2.25/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="package-setup.html"><a href="package-setup.html"><i class="fa fa-check"></i><b>2</b> Package setup</a>
<ul>
<li class="chapter" data-level="2.1" data-path="package-setup.html"><a href="package-setup.html#plotting-1d-data"><i class="fa fa-check"></i><b>2.1</b> Plotting 1d data</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="d-data.html"><a href="d-data.html"><i class="fa fa-check"></i><b>3</b> 2d data</a>
<ul>
<li class="chapter" data-level="3.1" data-path="d-data.html"><a href="d-data.html#generating-2d-data"><i class="fa fa-check"></i><b>3.1</b> Generating 2d data</a></li>
<li class="chapter" data-level="3.2" data-path="d-data.html"><a href="d-data.html#plotting-2d-data"><i class="fa fa-check"></i><b>3.2</b> Plotting 2d data</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="d-data-1.html"><a href="d-data-1.html"><i class="fa fa-check"></i><b>4</b> 3d data</a></li>
<li class="chapter" data-level="5" data-path="trend-filtering.html"><a href="trend-filtering.html"><i class="fa fa-check"></i><b>5</b> Trend filtering</a></li>
<li class="chapter" data-level="6" data-path="objective-data-log-likelihood.html"><a href="objective-data-log-likelihood.html"><i class="fa fa-check"></i><b>6</b> Objective (data log-likelihood)</a></li>
<li class="chapter" data-level="7" data-path="initial-parameters-for-em-algorithm.html"><a href="initial-parameters-for-em-algorithm.html"><i class="fa fa-check"></i><b>7</b> Initial parameters for EM algorithm</a></li>
<li class="chapter" data-level="8" data-path="e-step.html"><a href="e-step.html"><i class="fa fa-check"></i><b>8</b> E step</a></li>
<li class="chapter" data-level="9" data-path="m-step.html"><a href="m-step.html"><i class="fa fa-check"></i><b>9</b> M step</a>
<ul>
<li class="chapter" data-level="9.1" data-path="m-step.html"><a href="m-step.html#m-step-for-pi"><i class="fa fa-check"></i><b>9.1</b> M step for <span class="math inline">\(\pi\)</span></a></li>
<li class="chapter" data-level="9.2" data-path="m-step.html"><a href="m-step.html#m-step-for-sigma"><i class="fa fa-check"></i><b>9.2</b> M step for <span class="math inline">\(\Sigma\)</span></a></li>
<li class="chapter" data-level="9.3" data-path="m-step.html"><a href="m-step.html#m-step-for-mu"><i class="fa fa-check"></i><b>9.3</b> M step for <span class="math inline">\(\mu\)</span></a></li>
<li class="chapter" data-level="9.4" data-path="m-step.html"><a href="m-step.html#helpers-for-m-step-mu"><i class="fa fa-check"></i><b>9.4</b> Helpers for M step (<span class="math inline">\(\mu\)</span>)</a></li>
<li class="chapter" data-level="9.5" data-path="m-step.html"><a href="m-step.html#all-rcpp-functions"><i class="fa fa-check"></i><b>9.5</b> All Rcpp functions</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="flowtrend.html"><a href="flowtrend.html"><i class="fa fa-check"></i><b>10</b> flowtrend</a></li>
<li class="chapter" data-level="11" data-path="reordering-clusters.html"><a href="reordering-clusters.html"><i class="fa fa-check"></i><b>11</b> Reordering clusters</a></li>
<li class="chapter" data-level="12" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html"><i class="fa fa-check"></i><b>12</b> Tuning the regularization parameters for <code>flowtrend</code></a>
<ul>
<li class="chapter" data-level="12.1" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html#predicting-and-evaluating-on-new-time-points"><i class="fa fa-check"></i><b>12.1</b> Predicting and evaluating on new time points</a></li>
<li class="chapter" data-level="12.2" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html#maximum-lambda_mu-lambda_pi-values-to-test"><i class="fa fa-check"></i><b>12.2</b> Maximum <span class="math inline">\((\lambda_\mu, \lambda_\pi)\)</span> values to test</a></li>
<li class="chapter" data-level="12.3" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html#define-cv-data-folds"><i class="fa fa-check"></i><b>12.3</b> Define CV data folds</a></li>
<li class="chapter" data-level="12.4" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html#cv-many-single-jobs"><i class="fa fa-check"></i><b>12.4</b> CV = many single jobs</a></li>
<li class="chapter" data-level="12.5" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html#running-cross-validation"><i class="fa fa-check"></i><b>12.5</b> Running cross-validation</a></li>
<li class="chapter" data-level="12.6" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html#summarizing-the-output"><i class="fa fa-check"></i><b>12.6</b> Summarizing the output</a></li>
<li class="chapter" data-level="12.7" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html#cv-on-your-own-computer"><i class="fa fa-check"></i><b>12.7</b> CV on your own computer</a></li>
<li class="chapter" data-level="12.8" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html#plotting"><i class="fa fa-check"></i><b>12.8</b> Plotting</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="se-rule-for-cross-validation.html"><a href="se-rule-for-cross-validation.html"><i class="fa fa-check"></i><b>13</b> 1SE rule for cross validation</a></li>
<li class="chapter" data-level="14" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html"><i class="fa fa-check"></i><b>14</b> Testing the flowtrend method</a>
<ul>
<li class="chapter" data-level="14.1" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html#id_1d-example"><i class="fa fa-check"></i><b>14.1</b> 1d example</a></li>
<li class="chapter" data-level="14.2" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html#testing-monotonicity-of-objective-values"><i class="fa fa-check"></i><b>14.2</b> Testing monotonicity of objective values</a></li>
<li class="chapter" data-level="14.3" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html#id_2d-example"><i class="fa fa-check"></i><b>14.3</b> 2d example</a></li>
<li class="chapter" data-level="14.4" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html#working-with-binned-dataset"><i class="fa fa-check"></i><b>14.4</b> Working with “binned” dataset</a></li>
<li class="chapter" data-level="14.5" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html#unevenly-spaced-inputs-x"><i class="fa fa-check"></i><b>14.5</b> Unevenly spaced inputs (x)</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="documenting-the-package-and-building.html"><a href="documenting-the-package-and-building.html"><i class="fa fa-check"></i><b>15</b> Documenting the package and building</a></li>
<li class="chapter" data-level="16" data-path="helpers-for-simulations-in-the-paper.html"><a href="helpers-for-simulations-in-the-paper.html"><i class="fa fa-check"></i><b>16</b> Helpers for simulations in the paper</a>
<ul>
<li class="chapter" data-level="16.1" data-path="helpers-for-simulations-in-the-paper.html"><a href="helpers-for-simulations-in-the-paper.html#two-alternative-estimators"><i class="fa fa-check"></i><b>16.1</b> Two alternative estimators</a></li>
<li class="chapter" data-level="16.2" data-path="helpers-for-simulations-in-the-paper.html"><a href="helpers-for-simulations-in-the-paper.html#example-using-underfit_flowmeans-and-overfit_flowmeans"><i class="fa fa-check"></i><b>16.2</b> Example using <code><a href='helpers-for-simulations-in-the-paper.html#underfit_flowmeans'>underfit_flowmeans</a>()</code> and <code><a href='helpers-for-simulations-in-the-paper.html#overfit_flowmeans'>overfit_flowmeans</a>()</code></a></li>
<li class="chapter" data-level="16.3" data-path="helpers-for-simulations-in-the-paper.html"><a href="helpers-for-simulations-in-the-paper.html#evaluating-performance-soft-rand-index"><i class="fa fa-check"></i><b>16.3</b> Evaluating performance: soft RAND index</a></li>
<li class="chapter" data-level="16.4" data-path="helpers-for-simulations-in-the-paper.html"><a href="helpers-for-simulations-in-the-paper.html#generating-pseudo-real-data"><i class="fa fa-check"></i><b>16.4</b> Generating “pseudo-real” data</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Creating the <code>flowtrend</code> R package</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="helpers-for-simulations-in-the-paper" class="section level1 hasAnchor" number="16">
<h1><span class="header-section-number">16</span> Helpers for simulations in the paper<a href="helpers-for-simulations-in-the-paper.html#helpers-for-simulations-in-the-paper" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>There are two alternatives to consider when estimating mixture models in a
series of cytograms.</p>
<ul>
<li>The first is to estimate the mixture models to be identical across all time
points. This is equivalent to collapsing all cytograms into one and estimating
a single Gaussian mixture model on it.</li>
<li>The second alternative is to estimate separate Gaussian mixture models on each
cytogram, then connect the cytograms as much as one can, e.g., by finding
similar clusters across time points and combining them.</li>
</ul>
<div id="two-alternative-estimators" class="section level2 hasAnchor" number="16.1">
<h2><span class="header-section-number">16.1</span> Two alternative estimators<a href="helpers-for-simulations-in-the-paper.html#two-alternative-estimators" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We will call the two alternatives <code>underfit_flowmean()</code> and <code>overfit_flowmean()</code>.</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="helpers-for-simulations-in-the-paper.html#cb235-1" tabindex="-1"></a>litr<span class="sc">::</span><span class="fu">document</span>() <span class="co"># &lt;-- use instead of devtools::document() </span></span></code></pre></div>
<p>Here is a plotter function.</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb236-1"><a href="helpers-for-simulations-in-the-paper.html#cb236-1" tabindex="-1"></a><span class="co">#&#39; Pool the entire series of cytograms, fit a flowMeans model, and re-aggregate parameters</span></span>
<span id="cb236-2"><a href="helpers-for-simulations-in-the-paper.html#cb236-2" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb236-3"><a href="helpers-for-simulations-in-the-paper.html#cb236-3" tabindex="-1"></a><span class="co">#&#39; @param ylist Data.</span></span>
<span id="cb236-4"><a href="helpers-for-simulations-in-the-paper.html#cb236-4" tabindex="-1"></a><span class="co">#&#39; @param numclust Number of clusters.</span></span>
<span id="cb236-5"><a href="helpers-for-simulations-in-the-paper.html#cb236-5" tabindex="-1"></a><span class="co">#&#39; @return List object with flowtrend model estimates using l=lprob=0 and</span></span>
<span id="cb236-6"><a href="helpers-for-simulations-in-the-paper.html#cb236-6" tabindex="-1"></a><span class="co">#&#39;   extremely large regularization parameters so that all cytograms are the</span></span>
<span id="cb236-7"><a href="helpers-for-simulations-in-the-paper.html#cb236-7" tabindex="-1"></a><span class="co">#&#39;   same across time.</span></span>
<span id="cb236-8"><a href="helpers-for-simulations-in-the-paper.html#cb236-8" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb236-9"><a href="helpers-for-simulations-in-the-paper.html#cb236-9" tabindex="-1"></a><span id='underfit_flowmeans'>underfit_flowmeans</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(ylist, numclust){</span>
<span id="cb236-10"><a href="helpers-for-simulations-in-the-paper.html#cb236-10" tabindex="-1"></a></span>
<span id="cb236-11"><a href="helpers-for-simulations-in-the-paper.html#cb236-11" tabindex="-1"></a>  <span class="do">## Pool all data</span></span>
<span id="cb236-12"><a href="helpers-for-simulations-in-the-paper.html#cb236-12" tabindex="-1"></a>  TT <span class="ot">&lt;-</span> <span class="fu">length</span>(ylist)</span>
<span id="cb236-13"><a href="helpers-for-simulations-in-the-paper.html#cb236-13" tabindex="-1"></a>  nt <span class="ot">&lt;-</span> <span class="fu">sapply</span>(ylist, nrow)</span>
<span id="cb236-14"><a href="helpers-for-simulations-in-the-paper.html#cb236-14" tabindex="-1"></a>  ylist_pooled <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, ylist) <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>()</span>
<span id="cb236-15"><a href="helpers-for-simulations-in-the-paper.html#cb236-15" tabindex="-1"></a>  <span class="fu">colnames</span>(ylist_pooled) <span class="ot">=</span> <span class="st">&quot;Y&quot;</span></span>
<span id="cb236-16"><a href="helpers-for-simulations-in-the-paper.html#cb236-16" tabindex="-1"></a></span>
<span id="cb236-17"><a href="helpers-for-simulations-in-the-paper.html#cb236-17" tabindex="-1"></a>  <span class="do">## Fit the model</span></span>
<span id="cb236-18"><a href="helpers-for-simulations-in-the-paper.html#cb236-18" tabindex="-1"></a>  fmns_pooled <span class="ot">&lt;-</span> flowMeans<span class="sc">::</span><span class="fu">flowMeans</span>(<span class="at">x =</span> ylist_pooled, <span class="at">NumC =</span> numclust)</span>
<span id="cb236-19"><a href="helpers-for-simulations-in-the-paper.html#cb236-19" tabindex="-1"></a>  labeled_ylist <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Y =</span> ylist_pooled<span class="sc">$</span>Y,</span>
<span id="cb236-20"><a href="helpers-for-simulations-in-the-paper.html#cb236-20" tabindex="-1"></a>                              <span class="at">Cluster =</span> fmns_pooled<span class="sc">@</span>Label,</span>
<span id="cb236-21"><a href="helpers-for-simulations-in-the-paper.html#cb236-21" tabindex="-1"></a>                              <span class="at">Time =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">times =</span> nt))</span>
<span id="cb236-22"><a href="helpers-for-simulations-in-the-paper.html#cb236-22" tabindex="-1"></a></span>
<span id="cb236-23"><a href="helpers-for-simulations-in-the-paper.html#cb236-23" tabindex="-1"></a>  <span class="do">## Separate out list of memberships</span></span>
<span id="cb236-24"><a href="helpers-for-simulations-in-the-paper.html#cb236-24" tabindex="-1"></a>  memlist <span class="ot">=</span> labeled_ylist <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Time) <span class="sc">%&gt;%</span> <span class="fu">group_split</span>() <span class="sc">%&gt;%</span> <span class="fu">lapply</span>(<span class="cf">function</span>(a)<span class="fu">pull</span>(a, Cluster))</span>
<span id="cb236-25"><a href="helpers-for-simulations-in-the-paper.html#cb236-25" tabindex="-1"></a>  </span>
<span id="cb236-26"><a href="helpers-for-simulations-in-the-paper.html#cb236-26" tabindex="-1"></a>  <span class="do">## Format nicer output for objective calculations</span></span>
<span id="cb236-27"><a href="helpers-for-simulations-in-the-paper.html#cb236-27" tabindex="-1"></a>  params <span class="ot">&lt;-</span> labeled_ylist <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Cluster, Time) <span class="sc">%&gt;%</span> </span>
<span id="cb236-28"><a href="helpers-for-simulations-in-the-paper.html#cb236-28" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">mu =</span> <span class="fu">mean</span>(Y), <span class="at">prob =</span> <span class="fu">n</span>(), <span class="at">sigma =</span> <span class="fu">var</span>(Y)) <span class="sc">%&gt;%</span> </span>
<span id="cb236-29"><a href="helpers-for-simulations-in-the-paper.html#cb236-29" tabindex="-1"></a>    <span class="fu">group_by</span>(Time) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">prob =</span> prob<span class="sc">/</span><span class="fu">sum</span>(prob))</span>
<span id="cb236-30"><a href="helpers-for-simulations-in-the-paper.html#cb236-30" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> TT, <span class="at">ncol =</span> numclust)</span>
<span id="cb236-31"><a href="helpers-for-simulations-in-the-paper.html#cb236-31" tabindex="-1"></a>  sigma <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> TT, <span class="at">ncol =</span> numclust)</span>
<span id="cb236-32"><a href="helpers-for-simulations-in-the-paper.html#cb236-32" tabindex="-1"></a>  prob <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> TT, <span class="at">ncol =</span> numclust)</span>
<span id="cb236-33"><a href="helpers-for-simulations-in-the-paper.html#cb236-33" tabindex="-1"></a>  </span>
<span id="cb236-34"><a href="helpers-for-simulations-in-the-paper.html#cb236-34" tabindex="-1"></a>  <span class="do">## Fill in missing times for some clusters</span></span>
<span id="cb236-35"><a href="helpers-for-simulations-in-the-paper.html#cb236-35" tabindex="-1"></a>  <span class="cf">for</span>(tt <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>TT){</span>
<span id="cb236-36"><a href="helpers-for-simulations-in-the-paper.html#cb236-36" tabindex="-1"></a>    </span>
<span id="cb236-37"><a href="helpers-for-simulations-in-the-paper.html#cb236-37" tabindex="-1"></a>    params.tt <span class="ot">&lt;-</span> params <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Time <span class="sc">==</span> tt)</span>
<span id="cb236-38"><a href="helpers-for-simulations-in-the-paper.html#cb236-38" tabindex="-1"></a>    <span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>numclust){</span>
<span id="cb236-39"><a href="helpers-for-simulations-in-the-paper.html#cb236-39" tabindex="-1"></a>      </span>
<span id="cb236-40"><a href="helpers-for-simulations-in-the-paper.html#cb236-40" tabindex="-1"></a>      mu[tt,iclust] <span class="ot">&lt;-</span> params.tt<span class="sc">$</span>mu[iclust]</span>
<span id="cb236-41"><a href="helpers-for-simulations-in-the-paper.html#cb236-41" tabindex="-1"></a>      sigma[tt,iclust] <span class="ot">&lt;-</span> params.tt<span class="sc">$</span>sigma[iclust]</span>
<span id="cb236-42"><a href="helpers-for-simulations-in-the-paper.html#cb236-42" tabindex="-1"></a>      prob[tt,iclust] <span class="ot">&lt;-</span> params.tt<span class="sc">$</span>prob[iclust]</span>
<span id="cb236-43"><a href="helpers-for-simulations-in-the-paper.html#cb236-43" tabindex="-1"></a>      </span>
<span id="cb236-44"><a href="helpers-for-simulations-in-the-paper.html#cb236-44" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.na</span>(mu[tt,iclust])){</span>
<span id="cb236-45"><a href="helpers-for-simulations-in-the-paper.html#cb236-45" tabindex="-1"></a>        mu[tt,iclust] <span class="ot">&lt;-</span> mu[tt<span class="dv">-1</span>,iclust]</span>
<span id="cb236-46"><a href="helpers-for-simulations-in-the-paper.html#cb236-46" tabindex="-1"></a>      }</span>
<span id="cb236-47"><a href="helpers-for-simulations-in-the-paper.html#cb236-47" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.na</span>(sigma[tt,iclust])){</span>
<span id="cb236-48"><a href="helpers-for-simulations-in-the-paper.html#cb236-48" tabindex="-1"></a>        sigma[tt,iclust] <span class="ot">&lt;-</span> sigma[tt<span class="dv">-1</span>,iclust]</span>
<span id="cb236-49"><a href="helpers-for-simulations-in-the-paper.html#cb236-49" tabindex="-1"></a>      }</span>
<span id="cb236-50"><a href="helpers-for-simulations-in-the-paper.html#cb236-50" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.na</span>(prob[tt,iclust])){</span>
<span id="cb236-51"><a href="helpers-for-simulations-in-the-paper.html#cb236-51" tabindex="-1"></a>        prob[tt,iclust] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb236-52"><a href="helpers-for-simulations-in-the-paper.html#cb236-52" tabindex="-1"></a>      }</span>
<span id="cb236-53"><a href="helpers-for-simulations-in-the-paper.html#cb236-53" tabindex="-1"></a>    }</span>
<span id="cb236-54"><a href="helpers-for-simulations-in-the-paper.html#cb236-54" tabindex="-1"></a>  }</span>
<span id="cb236-55"><a href="helpers-for-simulations-in-the-paper.html#cb236-55" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">labeled_ylist =</span> labeled_ylist,</span>
<span id="cb236-56"><a href="helpers-for-simulations-in-the-paper.html#cb236-56" tabindex="-1"></a>              <span class="at">memlist =</span> memlist,</span>
<span id="cb236-57"><a href="helpers-for-simulations-in-the-paper.html#cb236-57" tabindex="-1"></a>              <span class="at">params =</span> params,</span>
<span id="cb236-58"><a href="helpers-for-simulations-in-the-paper.html#cb236-58" tabindex="-1"></a>              <span class="at">mu =</span> mu,</span>
<span id="cb236-59"><a href="helpers-for-simulations-in-the-paper.html#cb236-59" tabindex="-1"></a>              <span class="at">prob =</span> prob,</span>
<span id="cb236-60"><a href="helpers-for-simulations-in-the-paper.html#cb236-60" tabindex="-1"></a>              <span class="at">sigma =</span> sigma,</span>
<span id="cb236-61"><a href="helpers-for-simulations-in-the-paper.html#cb236-61" tabindex="-1"></a>              <span class="at">numclust =</span> numclust))</span>
<span id="cb236-62"><a href="helpers-for-simulations-in-the-paper.html#cb236-62" tabindex="-1"></a>}</span></code></pre></div>
<p>Here’s a helper to reorder the clusters of the output created using
<code><a href='helpers-for-simulations-in-the-paper.html#underfit_flowmeans'>underfit_flowmeans</a>()</code> or <code><a href='helpers-for-simulations-in-the-paper.html#overfit_flowmeans'>overfit_flowmeans</a>()</code>.</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="helpers-for-simulations-in-the-paper.html#cb237-1" tabindex="-1"></a><span class="co">#&#39; Plotter for underfit and overfit flowmeans.</span></span>
<span id="cb237-2"><a href="helpers-for-simulations-in-the-paper.html#cb237-2" tabindex="-1"></a><span class="co">#&#39; @param ylist Data</span></span>
<span id="cb237-3"><a href="helpers-for-simulations-in-the-paper.html#cb237-3" tabindex="-1"></a><span class="co">#&#39; @param countslist Optional: counts for each ylist</span></span>
<span id="cb237-4"><a href="helpers-for-simulations-in-the-paper.html#cb237-4" tabindex="-1"></a><span class="co">#&#39; @param obj Output from \code{<a href='helpers-for-simulations-in-the-paper.html#underfit_flowmeans'>underfit_flowmeans</a>()}</span></span>
<span id="cb237-5"><a href="helpers-for-simulations-in-the-paper.html#cb237-5" tabindex="-1"></a><span class="co">#&#39; @return ggplot object</span></span>
<span id="cb237-6"><a href="helpers-for-simulations-in-the-paper.html#cb237-6" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb237-7"><a href="helpers-for-simulations-in-the-paper.html#cb237-7" tabindex="-1"></a><span id='plot_1d_flowmeans'>plot_1d_flowmeans</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(obj, ylist, <span class="at">countslist=</span><span class="cn">NULL</span>){</span>
<span id="cb237-8"><a href="helpers-for-simulations-in-the-paper.html#cb237-8" tabindex="-1"></a>  <span class="do">## Make plot of only data</span></span>
<span id="cb237-9"><a href="helpers-for-simulations-in-the-paper.html#cb237-9" tabindex="-1"></a></span>
<span id="cb237-10"><a href="helpers-for-simulations-in-the-paper.html#cb237-10" tabindex="-1"></a>  gg <span class="ot">=</span> <a href='package-setup.html#plot_1d'>plot_1d</a>(<span class="at">ylist=</span>ylist, <span class="at">countslist=</span>countslist)</span>
<span id="cb237-11"><a href="helpers-for-simulations-in-the-paper.html#cb237-11" tabindex="-1"></a></span>
<span id="cb237-12"><a href="helpers-for-simulations-in-the-paper.html#cb237-12" tabindex="-1"></a>  <span id='my_wrangle'>my_wrangle</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(a, values_to){</span>
<span id="cb237-13"><a href="helpers-for-simulations-in-the-paper.html#cb237-13" tabindex="-1"></a>    a <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">&quot;1&quot;</span>, <span class="st">&quot;2&quot;</span>, <span class="st">&quot;3&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb237-14"><a href="helpers-for-simulations-in-the-paper.html#cb237-14" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">time=</span><span class="fu">row_number</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb237-15"><a href="helpers-for-simulations-in-the-paper.html#cb237-15" tabindex="-1"></a>      <span class="fu">pivot_longer</span>(<span class="sc">-</span>time, <span class="at">names_to =</span> <span class="st">&quot;cluster&quot;</span>, <span class="at">values_to =</span> values_to)</span>
<span id="cb237-16"><a href="helpers-for-simulations-in-the-paper.html#cb237-16" tabindex="-1"></a>  }</span>
<span id="cb237-17"><a href="helpers-for-simulations-in-the-paper.html#cb237-17" tabindex="-1"></a></span>
<span id="cb237-18"><a href="helpers-for-simulations-in-the-paper.html#cb237-18" tabindex="-1"></a>  numclust <span class="ot">=</span> obj<span class="sc">$</span>numclust</span>
<span id="cb237-19"><a href="helpers-for-simulations-in-the-paper.html#cb237-19" tabindex="-1"></a>  mn_long <span class="ot">=</span> obj<span class="sc">$</span>mu <span class="sc">%&gt;%</span> <a href='helpers-for-simulations-in-the-paper.html#my_wrangle'>my_wrangle</a>(<span class="st">&quot;mean&quot;</span>)</span>
<span id="cb237-20"><a href="helpers-for-simulations-in-the-paper.html#cb237-20" tabindex="-1"></a>  prob_long <span class="ot">=</span> obj<span class="sc">$</span>prob <span class="sc">%&gt;%</span> <a href='helpers-for-simulations-in-the-paper.html#my_wrangle'>my_wrangle</a>(<span class="st">&quot;prob&quot;</span>)</span>
<span id="cb237-21"><a href="helpers-for-simulations-in-the-paper.html#cb237-21" tabindex="-1"></a>  <span class="do">## prob_long = probmat %&gt;% pivot_longer(-time, names_to = &quot;cluster&quot;, values_to = &quot;prob&quot;)</span></span>
<span id="cb237-22"><a href="helpers-for-simulations-in-the-paper.html#cb237-22" tabindex="-1"></a>  est_long <span class="ot">=</span> <span class="fu">full_join</span>(mn_long, prob_long, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;time&quot;</span>,<span class="st">&quot;cluster&quot;</span>))</span>
<span id="cb237-23"><a href="helpers-for-simulations-in-the-paper.html#cb237-23" tabindex="-1"></a>  gg <span class="ot">=</span> gg <span class="sc">+</span> <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> mean, <span class="at">linewidth =</span> prob, <span class="at">group =</span> cluster, <span class="at">color =</span> cluster),</span>
<span id="cb237-24"><a href="helpers-for-simulations-in-the-paper.html#cb237-24" tabindex="-1"></a>                        <span class="at">data =</span> est_long,</span>
<span id="cb237-25"><a href="helpers-for-simulations-in-the-paper.html#cb237-25" tabindex="-1"></a>                        <span class="at">lineend =</span> <span class="st">&quot;round&quot;</span>, <span class="at">linejoin=</span><span class="st">&quot;mitre&quot;</span>)</span>
<span id="cb237-26"><a href="helpers-for-simulations-in-the-paper.html#cb237-26" tabindex="-1"></a>  </span>
<span id="cb237-27"><a href="helpers-for-simulations-in-the-paper.html#cb237-27" tabindex="-1"></a>  <span class="do">## Add the estimated 95% probability regions for data.</span></span>
<span id="cb237-28"><a href="helpers-for-simulations-in-the-paper.html#cb237-28" tabindex="-1"></a>  <span class="do">## stdev = obj$sigma %&gt;% .[,,1] %&gt;% sqrt()</span></span>
<span id="cb237-29"><a href="helpers-for-simulations-in-the-paper.html#cb237-29" tabindex="-1"></a>  sigma_long <span class="ot">=</span> obj<span class="sc">$</span>sigma <span class="sc">%&gt;%</span> <span class="fu">sqrt</span>() <span class="sc">%&gt;%</span> <a href='helpers-for-simulations-in-the-paper.html#my_wrangle'>my_wrangle</a>(<span class="st">&quot;stdev&quot;</span>)</span>
<span id="cb237-30"><a href="helpers-for-simulations-in-the-paper.html#cb237-30" tabindex="-1"></a>  band_long <span class="ot">=</span> <span class="fu">full_join</span>(mn_long, sigma_long, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;cluster&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb237-31"><a href="helpers-for-simulations-in-the-paper.html#cb237-31" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">upper =</span> mean <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> stdev)  <span class="sc">%&gt;%</span> </span>
<span id="cb237-32"><a href="helpers-for-simulations-in-the-paper.html#cb237-32" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lower =</span> mean <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> stdev)</span>
<span id="cb237-33"><a href="helpers-for-simulations-in-the-paper.html#cb237-33" tabindex="-1"></a></span>
<span id="cb237-34"><a href="helpers-for-simulations-in-the-paper.html#cb237-34" tabindex="-1"></a>  gg <span class="ot">=</span> gg <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> upper, <span class="at">group =</span> cluster, <span class="at">color =</span> cluster),</span>
<span id="cb237-35"><a href="helpers-for-simulations-in-the-paper.html#cb237-35" tabindex="-1"></a>                 <span class="at">data =</span> band_long, <span class="at">size =</span> <span class="fu">rel</span>(.<span class="dv">7</span>), <span class="at">alpha =</span> .<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb237-36"><a href="helpers-for-simulations-in-the-paper.html#cb237-36" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> lower, <span class="at">group =</span> cluster, <span class="at">color =</span> cluster),</span>
<span id="cb237-37"><a href="helpers-for-simulations-in-the-paper.html#cb237-37" tabindex="-1"></a>              <span class="at">data =</span> band_long, <span class="at">size =</span> <span class="fu">rel</span>(.<span class="dv">7</span>), <span class="at">alpha =</span> .<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb237-38"><a href="helpers-for-simulations-in-the-paper.html#cb237-38" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">size =</span> <span class="st">&quot;none&quot;</span>) <span class="co"># To turn off line size from legend</span></span>
<span id="cb237-39"><a href="helpers-for-simulations-in-the-paper.html#cb237-39" tabindex="-1"></a>  <span class="fu">return</span>(gg)</span>
<span id="cb237-40"><a href="helpers-for-simulations-in-the-paper.html#cb237-40" tabindex="-1"></a>}</span></code></pre></div>
<p>Next, coding <code><a href='helpers-for-simulations-in-the-paper.html#overfit_flowmeans'>overfit_flowmeans</a>()</code>:</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="helpers-for-simulations-in-the-paper.html#cb238-1" tabindex="-1"></a><span class="co">#&#39; Reordering function</span></span>
<span id="cb238-2"><a href="helpers-for-simulations-in-the-paper.html#cb238-2" tabindex="-1"></a><span id='reorder_flowmeans'>reorder_flowmeans</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(obj, new_order){</span>
<span id="cb238-3"><a href="helpers-for-simulations-in-the-paper.html#cb238-3" tabindex="-1"></a>  numclust <span class="ot">=</span> <span class="fu">max</span>(new_order)</span>
<span id="cb238-4"><a href="helpers-for-simulations-in-the-paper.html#cb238-4" tabindex="-1"></a>  obj<span class="sc">$</span>prob <span class="ot">=</span> obj<span class="sc">$</span>prob[,new_order]</span>
<span id="cb238-5"><a href="helpers-for-simulations-in-the-paper.html#cb238-5" tabindex="-1"></a>  obj<span class="sc">$</span>mu <span class="ot">=</span> obj<span class="sc">$</span>mu[,new_order]</span>
<span id="cb238-6"><a href="helpers-for-simulations-in-the-paper.html#cb238-6" tabindex="-1"></a>  obj<span class="sc">$</span>sigma <span class="ot">=</span> obj<span class="sc">$</span>sigma[,new_order]</span>
<span id="cb238-7"><a href="helpers-for-simulations-in-the-paper.html#cb238-7" tabindex="-1"></a>  obj<span class="sc">$</span>memlist <span class="ot">=</span>  <span class="fu">lapply</span>(obj<span class="sc">$</span>memlist, <span class="cf">function</span>(a){</span>
<span id="cb238-8"><a href="helpers-for-simulations-in-the-paper.html#cb238-8" tabindex="-1"></a>    a_copy <span class="ot">=</span> a</span>
<span id="cb238-9"><a href="helpers-for-simulations-in-the-paper.html#cb238-9" tabindex="-1"></a>    <span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>numclust){</span>
<span id="cb238-10"><a href="helpers-for-simulations-in-the-paper.html#cb238-10" tabindex="-1"></a>      a_copy[<span class="fu">which</span>(a<span class="sc">==</span>iclust)] <span class="ot">=</span> new_order[iclust]</span>
<span id="cb238-11"><a href="helpers-for-simulations-in-the-paper.html#cb238-11" tabindex="-1"></a>    }</span>
<span id="cb238-12"><a href="helpers-for-simulations-in-the-paper.html#cb238-12" tabindex="-1"></a>      <span class="do">## a[a==1] = new_order[1]</span></span>
<span id="cb238-13"><a href="helpers-for-simulations-in-the-paper.html#cb238-13" tabindex="-1"></a>      <span class="do">## a[a==2] = new_order[2] ## 3</span></span>
<span id="cb238-14"><a href="helpers-for-simulations-in-the-paper.html#cb238-14" tabindex="-1"></a>      <span class="do">## a[a==3] = new_order[3] ## 2</span></span>
<span id="cb238-15"><a href="helpers-for-simulations-in-the-paper.html#cb238-15" tabindex="-1"></a>    <span class="fu">return</span>(a_copy)</span>
<span id="cb238-16"><a href="helpers-for-simulations-in-the-paper.html#cb238-16" tabindex="-1"></a>  })</span>
<span id="cb238-17"><a href="helpers-for-simulations-in-the-paper.html#cb238-17" tabindex="-1"></a>  <span class="fu">return</span>(obj)</span>
<span id="cb238-18"><a href="helpers-for-simulations-in-the-paper.html#cb238-18" tabindex="-1"></a>}</span></code></pre></div>
<p>The <code>many_mixtures()</code> function uses a few helpers:</p>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb239-1"><a href="helpers-for-simulations-in-the-paper.html#cb239-1" tabindex="-1"></a><span class="co">#&#39; Apply flowmeans sequentially and then cluster match</span></span>
<span id="cb239-2"><a href="helpers-for-simulations-in-the-paper.html#cb239-2" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb239-3"><a href="helpers-for-simulations-in-the-paper.html#cb239-3" tabindex="-1"></a><span class="co">#&#39; @param ylist Data.</span></span>
<span id="cb239-4"><a href="helpers-for-simulations-in-the-paper.html#cb239-4" tabindex="-1"></a><span class="co">#&#39; @param numclust Number of clusters.</span></span>
<span id="cb239-5"><a href="helpers-for-simulations-in-the-paper.html#cb239-5" tabindex="-1"></a><span class="co">#&#39; @return </span></span>
<span id="cb239-6"><a href="helpers-for-simulations-in-the-paper.html#cb239-6" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb239-7"><a href="helpers-for-simulations-in-the-paper.html#cb239-7" tabindex="-1"></a><span id='overfit_flowmeans'>overfit_flowmeans</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(ylist, numclust, <span class="at">verbose =</span> <span class="cn">FALSE</span>){</span>
<span id="cb239-8"><a href="helpers-for-simulations-in-the-paper.html#cb239-8" tabindex="-1"></a>  </span>
<span id="cb239-9"><a href="helpers-for-simulations-in-the-paper.html#cb239-9" tabindex="-1"></a>  fmns_obj <span class="ot">&lt;-</span> <span class="fu">lapply</span>(ylist, <span class="at">FUN =</span> flowmeans_each, <span class="at">numclust =</span> numclust)</span>
<span id="cb239-10"><a href="helpers-for-simulations-in-the-paper.html#cb239-10" tabindex="-1"></a>  hybrid_out <span class="ot">&lt;-</span> <a href='helpers-for-simulations-in-the-paper.html#match_clusters'>match_clusters</a>(fmns_obj)</span>
<span id="cb239-11"><a href="helpers-for-simulations-in-the-paper.html#cb239-11" tabindex="-1"></a>  <span class="fu">return</span>(hybrid_out)</span>
<span id="cb239-12"><a href="helpers-for-simulations-in-the-paper.html#cb239-12" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb240-1"><a href="helpers-for-simulations-in-the-paper.html#cb240-1" tabindex="-1"></a><span class="co">#&#39; Apply flowmeans in each.</span></span>
<span id="cb240-2"><a href="helpers-for-simulations-in-the-paper.html#cb240-2" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb240-3"><a href="helpers-for-simulations-in-the-paper.html#cb240-3" tabindex="-1"></a><span class="co">#&#39; @param ylist Data.</span></span>
<span id="cb240-4"><a href="helpers-for-simulations-in-the-paper.html#cb240-4" tabindex="-1"></a><span class="co">#&#39; @param numclust Number of clusters.</span></span>
<span id="cb240-5"><a href="helpers-for-simulations-in-the-paper.html#cb240-5" tabindex="-1"></a><span class="co">#&#39; @return </span></span>
<span id="cb240-6"><a href="helpers-for-simulations-in-the-paper.html#cb240-6" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb240-7"><a href="helpers-for-simulations-in-the-paper.html#cb240-7" tabindex="-1"></a><span id='flowmeans_each'>flowmeans_each</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(ylist, numclust){</span>
<span id="cb240-8"><a href="helpers-for-simulations-in-the-paper.html#cb240-8" tabindex="-1"></a></span>
<span id="cb240-9"><a href="helpers-for-simulations-in-the-paper.html#cb240-9" tabindex="-1"></a>  <span class="do">## Basic check</span></span>
<span id="cb240-10"><a href="helpers-for-simulations-in-the-paper.html#cb240-10" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">ncol</span>(ylist[[<span class="dv">1</span>]])<span class="sc">==</span><span class="dv">1</span>)</span>
<span id="cb240-11"><a href="helpers-for-simulations-in-the-paper.html#cb240-11" tabindex="-1"></a></span>
<span id="cb240-12"><a href="helpers-for-simulations-in-the-paper.html#cb240-12" tabindex="-1"></a>  <span class="do">## Get cluster labels from the peaks</span></span>
<span id="cb240-13"><a href="helpers-for-simulations-in-the-paper.html#cb240-13" tabindex="-1"></a>  fmns_obj <span class="ot">&lt;-</span> flowMeans<span class="sc">::</span><span class="fu">flowMeans</span>(<span class="at">x =</span> ylist, <span class="at">NumC =</span> numclust)</span>
<span id="cb240-14"><a href="helpers-for-simulations-in-the-paper.html#cb240-14" tabindex="-1"></a>  labeled_ylist <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">cluster =</span> fmns_obj<span class="sc">@</span>Label, ylist) <span class="sc">%&gt;%</span> tibble<span class="sc">::</span><span class="fu">as_tibble</span>()</span>
<span id="cb240-15"><a href="helpers-for-simulations-in-the-paper.html#cb240-15" tabindex="-1"></a>  <span class="fu">colnames</span>(labeled_ylist)[<span class="dv">2</span>] <span class="ot">=</span> <span class="st">&quot;Y&quot;</span></span>
<span id="cb240-16"><a href="helpers-for-simulations-in-the-paper.html#cb240-16" tabindex="-1"></a>  </span>
<span id="cb240-17"><a href="helpers-for-simulations-in-the-paper.html#cb240-17" tabindex="-1"></a>  <span class="do">## Calculate cluster parameters</span></span>
<span id="cb240-18"><a href="helpers-for-simulations-in-the-paper.html#cb240-18" tabindex="-1"></a>  cluster_params <span class="ot">&lt;-</span> labeled_ylist <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span> </span>
<span id="cb240-19"><a href="helpers-for-simulations-in-the-paper.html#cb240-19" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">mu =</span> <span class="fu">mean</span>(Y),</span>
<span id="cb240-20"><a href="helpers-for-simulations-in-the-paper.html#cb240-20" tabindex="-1"></a>              <span class="at">prob =</span> <span class="fu">n</span>()<span class="sc">/</span><span class="fu">nrow</span>(labeled_ylist), </span>
<span id="cb240-21"><a href="helpers-for-simulations-in-the-paper.html#cb240-21" tabindex="-1"></a>              <span class="at">sigma =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">var</span>(Y)), <span class="fu">var</span>(Y), <span class="fl">1e-10</span>))</span>
<span id="cb240-22"><a href="helpers-for-simulations-in-the-paper.html#cb240-22" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">fmns_obj =</span> fmns_obj, <span class="at">cluster_params =</span> cluster_params))</span>
<span id="cb240-23"><a href="helpers-for-simulations-in-the-paper.html#cb240-23" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="example-using-underfit_flowmeans-and-overfit_flowmeans" class="section level2 hasAnchor" number="16.2">
<h2><span class="header-section-number">16.2</span> Example using <code><a href='helpers-for-simulations-in-the-paper.html#underfit_flowmeans'>underfit_flowmeans</a>()</code> and <code><a href='helpers-for-simulations-in-the-paper.html#overfit_flowmeans'>overfit_flowmeans</a>()</code><a href="helpers-for-simulations-in-the-paper.html#example-using-underfit_flowmeans-and-overfit_flowmeans" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb241-1"><a href="helpers-for-simulations-in-the-paper.html#cb241-1" tabindex="-1"></a><span class="co">#&#39; Apply the hungarian matching algorithm to each time point.</span></span>
<span id="cb241-2"><a href="helpers-for-simulations-in-the-paper.html#cb241-2" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb241-3"><a href="helpers-for-simulations-in-the-paper.html#cb241-3" tabindex="-1"></a><span class="co">#&#39; @param flowmeans_obj</span></span>
<span id="cb241-4"><a href="helpers-for-simulations-in-the-paper.html#cb241-4" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb241-5"><a href="helpers-for-simulations-in-the-paper.html#cb241-5" tabindex="-1"></a><span class="co">#&#39; @return</span></span>
<span id="cb241-6"><a href="helpers-for-simulations-in-the-paper.html#cb241-6" tabindex="-1"></a><span id='match_clusters'>match_clusters</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(fmns_obj){</span>
<span id="cb241-7"><a href="helpers-for-simulations-in-the-paper.html#cb241-7" tabindex="-1"></a>  </span>
<span id="cb241-8"><a href="helpers-for-simulations-in-the-paper.html#cb241-8" tabindex="-1"></a>  <span class="do">## Initialize some objects</span></span>
<span id="cb241-9"><a href="helpers-for-simulations-in-the-paper.html#cb241-9" tabindex="-1"></a>  TT <span class="ot">&lt;-</span> <span class="fu">length</span>(fmns_obj)</span>
<span id="cb241-10"><a href="helpers-for-simulations-in-the-paper.html#cb241-10" tabindex="-1"></a>  numc <span class="ot">&lt;-</span> <span class="fu">nrow</span>(fmns_obj[[<span class="dv">1</span>]]<span class="sc">$</span>cluster_params)</span>
<span id="cb241-11"><a href="helpers-for-simulations-in-the-paper.html#cb241-11" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> TT, <span class="at">ncol =</span> numc)</span>
<span id="cb241-12"><a href="helpers-for-simulations-in-the-paper.html#cb241-12" tabindex="-1"></a>  sigma <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> TT, <span class="at">ncol =</span> numc)</span>
<span id="cb241-13"><a href="helpers-for-simulations-in-the-paper.html#cb241-13" tabindex="-1"></a>  prob <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> TT, <span class="at">ncol =</span> numc)</span>
<span id="cb241-14"><a href="helpers-for-simulations-in-the-paper.html#cb241-14" tabindex="-1"></a>  costs <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, TT)</span>
<span id="cb241-15"><a href="helpers-for-simulations-in-the-paper.html#cb241-15" tabindex="-1"></a>  memlist <span class="ot">&lt;-</span> <span class="fu">list</span>(fmns_obj[[<span class="dv">1</span>]]<span class="sc">$</span>fmns_obj<span class="sc">@</span>Label)</span>
<span id="cb241-16"><a href="helpers-for-simulations-in-the-paper.html#cb241-16" tabindex="-1"></a>  </span>
<span id="cb241-17"><a href="helpers-for-simulations-in-the-paper.html#cb241-17" tabindex="-1"></a>  <span class="do">## First row is spoken for</span></span>
<span id="cb241-18"><a href="helpers-for-simulations-in-the-paper.html#cb241-18" tabindex="-1"></a>  mu[<span class="dv">1</span>,] <span class="ot">&lt;-</span> fmns_obj[[<span class="dv">1</span>]]<span class="sc">$</span>cluster_params<span class="sc">$</span>mu</span>
<span id="cb241-19"><a href="helpers-for-simulations-in-the-paper.html#cb241-19" tabindex="-1"></a>  sigma[<span class="dv">1</span>,] <span class="ot">&lt;-</span> fmns_obj[[<span class="dv">1</span>]]<span class="sc">$</span>cluster_params<span class="sc">$</span>sigma</span>
<span id="cb241-20"><a href="helpers-for-simulations-in-the-paper.html#cb241-20" tabindex="-1"></a>  prob[<span class="dv">1</span>,] <span class="ot">&lt;-</span> fmns_obj[[<span class="dv">1</span>]]<span class="sc">$</span>cluster_params<span class="sc">$</span>prob</span>
<span id="cb241-21"><a href="helpers-for-simulations-in-the-paper.html#cb241-21" tabindex="-1"></a>  </span>
<span id="cb241-22"><a href="helpers-for-simulations-in-the-paper.html#cb241-22" tabindex="-1"></a>  <span class="do">## Fill in the rest of the rows by sequentially matching clusters from t-1 to</span></span>
<span id="cb241-23"><a href="helpers-for-simulations-in-the-paper.html#cb241-23" tabindex="-1"></a>  <span class="do">## t, using the Hungarian Algorithm</span></span>
<span id="cb241-24"><a href="helpers-for-simulations-in-the-paper.html#cb241-24" tabindex="-1"></a>  <span class="cf">for</span>(tt <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>TT){</span>
<span id="cb241-25"><a href="helpers-for-simulations-in-the-paper.html#cb241-25" tabindex="-1"></a>    dt_to_tp1 <span class="ot">&lt;-</span> <a href='helpers-for-simulations-in-the-paper.html#my_symmetric_kl'>my_symmetric_kl</a>(<span class="at">c1 =</span> fmns_obj[[tt<span class="dv">-1</span>]]<span class="sc">$</span>cluster_params,</span>
<span id="cb241-26"><a href="helpers-for-simulations-in-the-paper.html#cb241-26" tabindex="-1"></a>                              <span class="at">c2 =</span> fmns_obj[[tt]]<span class="sc">$</span>cluster_params)</span>
<span id="cb241-27"><a href="helpers-for-simulations-in-the-paper.html#cb241-27" tabindex="-1"></a>    hng_tt <span class="ot">&lt;-</span> RcppHungarian<span class="sc">::</span><span class="fu">HungarianSolver</span>(dt_to_tp1)</span>
<span id="cb241-28"><a href="helpers-for-simulations-in-the-paper.html#cb241-28" tabindex="-1"></a>    hng_order <span class="ot">&lt;-</span> hng_tt<span class="sc">$</span>pairs <span class="sc">%&gt;%</span> <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(.[,<span class="dv">2</span>]) <span class="sc">%&gt;%</span> .[,<span class="dv">1</span>]</span>
<span id="cb241-29"><a href="helpers-for-simulations-in-the-paper.html#cb241-29" tabindex="-1"></a></span>
<span id="cb241-30"><a href="helpers-for-simulations-in-the-paper.html#cb241-30" tabindex="-1"></a>    fmns_obj[[tt]]<span class="sc">$</span>cluster_params <span class="ot">&lt;-</span> fmns_obj[[tt]]<span class="sc">$</span>cluster_params[hng_order,]</span>
<span id="cb241-31"><a href="helpers-for-simulations-in-the-paper.html#cb241-31" tabindex="-1"></a>    mu[tt,] <span class="ot">&lt;-</span> fmns_obj[[tt]]<span class="sc">$</span>cluster_params<span class="sc">$</span>mu</span>
<span id="cb241-32"><a href="helpers-for-simulations-in-the-paper.html#cb241-32" tabindex="-1"></a>    prob[tt,] <span class="ot">&lt;-</span> fmns_obj[[tt]]<span class="sc">$</span>cluster_params<span class="sc">$</span>prob</span>
<span id="cb241-33"><a href="helpers-for-simulations-in-the-paper.html#cb241-33" tabindex="-1"></a>    sigma[tt,] <span class="ot">&lt;-</span> fmns_obj[[tt]]<span class="sc">$</span>cluster_params<span class="sc">$</span>sigma[hng_order]</span>
<span id="cb241-34"><a href="helpers-for-simulations-in-the-paper.html#cb241-34" tabindex="-1"></a>    costs[tt] <span class="ot">&lt;-</span> hng_tt<span class="sc">$</span>cost</span>
<span id="cb241-35"><a href="helpers-for-simulations-in-the-paper.html#cb241-35" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">mean</span>(<span class="fu">abs</span>(mu[tt,] <span class="sc">-</span> mu[tt<span class="dv">-1</span>,]))<span class="sc">/</span><span class="fu">max</span>(<span class="fu">abs</span>(mu[tt,])) <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb241-36"><a href="helpers-for-simulations-in-the-paper.html#cb241-36" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;Bad Match at time&quot;</span>, tt, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>))</span>
<span id="cb241-37"><a href="helpers-for-simulations-in-the-paper.html#cb241-37" tabindex="-1"></a>    }</span>
<span id="cb241-38"><a href="helpers-for-simulations-in-the-paper.html#cb241-38" tabindex="-1"></a></span>
<span id="cb241-39"><a href="helpers-for-simulations-in-the-paper.html#cb241-39" tabindex="-1"></a>    <span class="do">## Convert labels</span></span>
<span id="cb241-40"><a href="helpers-for-simulations-in-the-paper.html#cb241-40" tabindex="-1"></a>    <span id='label.convert'>label.convert</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(c1){hng_tt<span class="sc">$</span>pairs[c1,<span class="dv">2</span>]}</span>
<span id="cb241-41"><a href="helpers-for-simulations-in-the-paper.html#cb241-41" tabindex="-1"></a>    memlist[[tt]] <span class="ot">&lt;-</span> <span class="fu">sapply</span>(fmns_obj[[tt]]<span class="sc">$</span>fmns_obj<span class="sc">@</span>Label, label.convert)</span>
<span id="cb241-42"><a href="helpers-for-simulations-in-the-paper.html#cb241-42" tabindex="-1"></a>  }</span>
<span id="cb241-43"><a href="helpers-for-simulations-in-the-paper.html#cb241-43" tabindex="-1"></a>  </span>
<span id="cb241-44"><a href="helpers-for-simulations-in-the-paper.html#cb241-44" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mu =</span> mu, <span class="at">prob =</span> prob, <span class="at">sigma =</span> sigma, <span class="at">costs =</span> costs, <span class="at">memlist =</span> memlist))</span>
<span id="cb241-45"><a href="helpers-for-simulations-in-the-paper.html#cb241-45" tabindex="-1"></a>}</span>
<span id="cb241-46"><a href="helpers-for-simulations-in-the-paper.html#cb241-46" tabindex="-1"></a></span>
<span id="cb241-47"><a href="helpers-for-simulations-in-the-paper.html#cb241-47" tabindex="-1"></a><span class="co">#&#39; Given two K x 2 columns with parameters, make K x K distance matrix.</span></span>
<span id="cb241-48"><a href="helpers-for-simulations-in-the-paper.html#cb241-48" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb241-49"><a href="helpers-for-simulations-in-the-paper.html#cb241-49" tabindex="-1"></a><span class="co">#&#39; @param c1 Data frame with K rows and 2 columns (mu and sigma)</span></span>
<span id="cb241-50"><a href="helpers-for-simulations-in-the-paper.html#cb241-50" tabindex="-1"></a><span class="co">#&#39; @param c2 Another data frame of the same size as \code{c1}.</span></span>
<span id="cb241-51"><a href="helpers-for-simulations-in-the-paper.html#cb241-51" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb241-52"><a href="helpers-for-simulations-in-the-paper.html#cb241-52" tabindex="-1"></a><span class="co">#&#39; @return K x K matrix.</span></span>
<span id="cb241-53"><a href="helpers-for-simulations-in-the-paper.html#cb241-53" tabindex="-1"></a><span id='my_symmetric_kl'>my_symmetric_kl</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(c1, c2){</span>
<span id="cb241-54"><a href="helpers-for-simulations-in-the-paper.html#cb241-54" tabindex="-1"></a>  </span>
<span id="cb241-55"><a href="helpers-for-simulations-in-the-paper.html#cb241-55" tabindex="-1"></a>  <span class="do">## Make sure were using the same number of clusters</span></span>
<span id="cb241-56"><a href="helpers-for-simulations-in-the-paper.html#cb241-56" tabindex="-1"></a>  assertthat<span class="sc">::</span><span class="fu">assert_that</span>(<span class="fu">nrow</span>(c1) <span class="sc">==</span> <span class="fu">nrow</span>(c2))</span>
<span id="cb241-57"><a href="helpers-for-simulations-in-the-paper.html#cb241-57" tabindex="-1"></a>  numclust <span class="ot">&lt;-</span> <span class="fu">nrow</span>(c1)</span>
<span id="cb241-58"><a href="helpers-for-simulations-in-the-paper.html#cb241-58" tabindex="-1"></a></span>
<span id="cb241-59"><a href="helpers-for-simulations-in-the-paper.html#cb241-59" tabindex="-1"></a>  <span class="do">## Fill out distance matrix</span></span>
<span id="cb241-60"><a href="helpers-for-simulations-in-the-paper.html#cb241-60" tabindex="-1"></a>  dist_cs <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">ncol =</span> numclust, <span class="at">nrow =</span> numclust)</span>
<span id="cb241-61"><a href="helpers-for-simulations-in-the-paper.html#cb241-61" tabindex="-1"></a>  <span class="cf">for</span>(iclust_1 <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>numclust){</span>
<span id="cb241-62"><a href="helpers-for-simulations-in-the-paper.html#cb241-62" tabindex="-1"></a>    <span class="cf">for</span>(iclust_2 <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>numclust){</span>
<span id="cb241-63"><a href="helpers-for-simulations-in-the-paper.html#cb241-63" tabindex="-1"></a>      dist_cs[iclust_2, iclust_1] <span class="ot">&lt;-</span></span>
<span id="cb241-64"><a href="helpers-for-simulations-in-the-paper.html#cb241-64" tabindex="-1"></a>        <a href='helpers-for-simulations-in-the-paper.html#one_symmetric_kl'>one_symmetric_kl</a>(<span class="at">mu1 =</span> c1<span class="sc">$</span>mu[iclust_1],</span>
<span id="cb241-65"><a href="helpers-for-simulations-in-the-paper.html#cb241-65" tabindex="-1"></a>                         <span class="at">mu2 =</span> c2<span class="sc">$</span>mu[iclust_2], </span>
<span id="cb241-66"><a href="helpers-for-simulations-in-the-paper.html#cb241-66" tabindex="-1"></a>                         <span class="at">sigma1 =</span> <span class="fu">sqrt</span>(c1<span class="sc">$</span>sigma[iclust_1]),</span>
<span id="cb241-67"><a href="helpers-for-simulations-in-the-paper.html#cb241-67" tabindex="-1"></a>                         <span class="at">sigma2 =</span> <span class="fu">sqrt</span>(c2<span class="sc">$</span>sigma[iclust_2]))</span>
<span id="cb241-68"><a href="helpers-for-simulations-in-the-paper.html#cb241-68" tabindex="-1"></a>    }</span>
<span id="cb241-69"><a href="helpers-for-simulations-in-the-paper.html#cb241-69" tabindex="-1"></a>  }</span>
<span id="cb241-70"><a href="helpers-for-simulations-in-the-paper.html#cb241-70" tabindex="-1"></a>  <span class="fu">rownames</span>(dist_cs) <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="st">&quot;C1&quot;</span>, numclust)</span>
<span id="cb241-71"><a href="helpers-for-simulations-in-the-paper.html#cb241-71" tabindex="-1"></a>  <span class="fu">colnames</span>(dist_cs) <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="st">&quot;C2&quot;</span>, numclust)</span>
<span id="cb241-72"><a href="helpers-for-simulations-in-the-paper.html#cb241-72" tabindex="-1"></a>  <span class="fu">return</span>(dist_cs)</span>
<span id="cb241-73"><a href="helpers-for-simulations-in-the-paper.html#cb241-73" tabindex="-1"></a>}</span>
<span id="cb241-74"><a href="helpers-for-simulations-in-the-paper.html#cb241-74" tabindex="-1"></a></span>
<span id="cb241-75"><a href="helpers-for-simulations-in-the-paper.html#cb241-75" tabindex="-1"></a><span class="co">#&#39; Symmetric KL divergence between two Gaussian distributions.</span></span>
<span id="cb241-76"><a href="helpers-for-simulations-in-the-paper.html#cb241-76" tabindex="-1"></a><span class="co">#&#39; @param mu1 Mean for distribution 1.</span></span>
<span id="cb241-77"><a href="helpers-for-simulations-in-the-paper.html#cb241-77" tabindex="-1"></a><span class="co">#&#39; @param mu2 Mean for distribution 2.</span></span>
<span id="cb241-78"><a href="helpers-for-simulations-in-the-paper.html#cb241-78" tabindex="-1"></a><span class="co">#&#39; @param sigma1 Standard deviation for distribution 1.</span></span>
<span id="cb241-79"><a href="helpers-for-simulations-in-the-paper.html#cb241-79" tabindex="-1"></a><span class="co">#&#39; @param sigma2 Standard deviation for distribution 2.</span></span>
<span id="cb241-80"><a href="helpers-for-simulations-in-the-paper.html#cb241-80" tabindex="-1"></a><span id='one_symmetric_kl'>one_symmetric_kl</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(mu1, mu2, sigma1, sigma2){</span>
<span id="cb241-81"><a href="helpers-for-simulations-in-the-paper.html#cb241-81" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">length</span>(mu1)<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> <span class="fu">length</span>(mu2) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span></span>
<span id="cb241-82"><a href="helpers-for-simulations-in-the-paper.html#cb241-82" tabindex="-1"></a>            <span class="fu">length</span>(sigma1) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> <span class="fu">length</span>(sigma2) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb241-83"><a href="helpers-for-simulations-in-the-paper.html#cb241-83" tabindex="-1"></a>  kl12 <span class="ot">&lt;-</span> <span class="fu">log</span>(sigma2<span class="sc">/</span>sigma1) <span class="sc">+</span> (sigma1<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (mu1 <span class="sc">-</span> mu2)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>sigma2<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span></span>
<span id="cb241-84"><a href="helpers-for-simulations-in-the-paper.html#cb241-84" tabindex="-1"></a>  kl21 <span class="ot">&lt;-</span> <span class="fu">log</span>(sigma1<span class="sc">/</span>sigma2) <span class="sc">+</span> (sigma2<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (mu2 <span class="sc">-</span> mu1)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>sigma1<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span></span>
<span id="cb241-85"><a href="helpers-for-simulations-in-the-paper.html#cb241-85" tabindex="-1"></a>  kl_sym <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>(kl12 <span class="sc">+</span> kl21)</span>
<span id="cb241-86"><a href="helpers-for-simulations-in-the-paper.html#cb241-86" tabindex="-1"></a>  <span class="fu">return</span>(kl_sym)</span>
<span id="cb241-87"><a href="helpers-for-simulations-in-the-paper.html#cb241-87" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="evaluating-performance-soft-rand-index" class="section level2 hasAnchor" number="16.3">
<h2><span class="header-section-number">16.3</span> Evaluating performance: soft RAND index<a href="helpers-for-simulations-in-the-paper.html#evaluating-performance-soft-rand-index" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We will use a “soft” Rand index that replaces the regular Rand index:</p>
<p><span class="math display">\[ \sum_{i, i&#39;} 1\{ \hat C_i = \hat C_{i&#39;}, C_i^* \neq C_{i&#39;}^*\}.\]</span></p>
<p>which measures, for every pair of points <span class="math inline">\(i\)</span> and <span class="math inline">\(i&#39;\)</span>, the number of times that
the two clustering mechanisms <em>disagree</em>.</p>
<p>Now, let’s say that the two mechanisms give <em>probabilities</em>:</p>
<p><span class="math display">\[\hat \gamma_{ik} = \hat P(\hat C_i = k),\]</span>
<span class="math display">\[\hat \gamma^*_{ik} = \hat P(\hat C_i^* = k).\]</span></p>
<p>Then, the probability that the clustering is the same <span class="math inline">\(P(C_i^* = C_{i&#39;}^*)\)</span> for
the pair of points <span class="math inline">\(i\)</span> and <span class="math inline">\(i&#39;\)</span> is:</p>
<p><span class="math display">\[ (\gamma_i^*)^T (\gamma_{i&#39;}^*) = \sum_{k=1} P(C_i = k) P(C_i^* = k) = P(C_i^* = C_{i&#39;}^*).\]</span></p>
<p>and the probaility they are different is:</p>
<p><span class="math display">\[ (\gamma_i^*)^T (\gamma_{i&#39;}^*) = \sum_{k=1} P(C_i = k) P(C_i^* = k) = P(C_i^* = C_{i&#39;}^*).\]</span></p>
<p>So, we can measure the difference as:</p>
<p><span class="math display">\[\sum_{i,i&#39;} (\hat \gamma_i^T \hat \gamma_{i&#39;})\cdot(1-  \gamma^*_i^T \gamma^*_{i&#39;}) \]</span></p>
<p>And when one of the clusterings is absolute, we can still use a 0-1 vector.</p>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb242-1"><a href="helpers-for-simulations-in-the-paper.html#cb242-1" tabindex="-1"></a><span class="do">## Generate data</span></span>
<span id="cb242-2"><a href="helpers-for-simulations-in-the-paper.html#cb242-2" tabindex="-1"></a>numclust <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb242-3"><a href="helpers-for-simulations-in-the-paper.html#cb242-3" tabindex="-1"></a>TT <span class="ot">=</span> <span class="dv">100</span></span>
<span id="cb242-4"><a href="helpers-for-simulations-in-the-paper.html#cb242-4" tabindex="-1"></a>dimdat <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb242-5"><a href="helpers-for-simulations-in-the-paper.html#cb242-5" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">0</span>)</span>
<span id="cb242-6"><a href="helpers-for-simulations-in-the-paper.html#cb242-6" tabindex="-1"></a>dt <span class="ot">=</span> <a href='package-setup.html#gendat_1d'>gendat_1d</a>(<span class="at">TT =</span> TT, <span class="at">ntlist =</span> <span class="fu">rep</span>(TT, <span class="dv">100</span>))</span>
<span id="cb242-7"><a href="helpers-for-simulations-in-the-paper.html#cb242-7" tabindex="-1"></a>ylist <span class="ot">=</span> dt <span class="sc">%&gt;%</span> <a href='package-setup.html#dt2ylist'>dt2ylist</a>()</span>
<span id="cb242-8"><a href="helpers-for-simulations-in-the-paper.html#cb242-8" tabindex="-1"></a>truth <span class="ot">=</span> <a href='package-setup.html#gendat_1d'>gendat_1d</a>(<span class="at">TT =</span> TT, <span class="at">ntlist =</span> <span class="fu">rep</span>(TT, <span class="dv">100</span>), <span class="at">return_model=</span><span class="cn">TRUE</span>)</span>
<span id="cb242-9"><a href="helpers-for-simulations-in-the-paper.html#cb242-9" tabindex="-1"></a></span>
<span id="cb242-10"><a href="helpers-for-simulations-in-the-paper.html#cb242-10" tabindex="-1"></a><span class="do">## Fit the two methods</span></span>
<span id="cb242-11"><a href="helpers-for-simulations-in-the-paper.html#cb242-11" tabindex="-1"></a>obj_underfit <span class="ot">=</span> <a href='helpers-for-simulations-in-the-paper.html#underfit_flowmeans'>underfit_flowmeans</a>(<span class="at">ylist =</span> ylist, <span class="at">numclust =</span> <span class="dv">3</span>)</span>
<span id="cb242-12"><a href="helpers-for-simulations-in-the-paper.html#cb242-12" tabindex="-1"></a>obj_overfit <span class="ot">=</span> <a href='helpers-for-simulations-in-the-paper.html#overfit_flowmeans'>overfit_flowmeans</a>(<span class="at">ylist =</span> ylist, <span class="at">numclust =</span> <span class="dv">3</span>)</span>
<span id="cb242-13"><a href="helpers-for-simulations-in-the-paper.html#cb242-13" tabindex="-1"></a></span>
<span id="cb242-14"><a href="helpers-for-simulations-in-the-paper.html#cb242-14" tabindex="-1"></a><span class="do">## Make the mean plots</span></span>
<span id="cb242-15"><a href="helpers-for-simulations-in-the-paper.html#cb242-15" tabindex="-1"></a>o <span class="ot">=</span> obj_underfit<span class="sc">$</span>mu <span class="sc">%&gt;%</span> <span class="fu">colMeans</span>() <span class="sc">%&gt;%</span> <span class="fu">order</span>()</span>
<span id="cb242-16"><a href="helpers-for-simulations-in-the-paper.html#cb242-16" tabindex="-1"></a>obj_underfit <span class="ot">=</span> <a href='helpers-for-simulations-in-the-paper.html#reorder_flowmeans'>reorder_flowmeans</a>(obj_underfit, o)</span>
<span id="cb242-17"><a href="helpers-for-simulations-in-the-paper.html#cb242-17" tabindex="-1"></a>g1 <span class="ot">=</span> <a href='helpers-for-simulations-in-the-paper.html#plot_1d_flowmeans'>plot_1d_flowmeans</a>(<a href='helpers-for-simulations-in-the-paper.html#reorder_flowmeans'>reorder_flowmeans</a>(obj_underfit, o), ylist) <span class="sc">+</span></span>
<span id="cb242-18"><a href="helpers-for-simulations-in-the-paper.html#cb242-18" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>time, <span class="at">y=</span>mean, <span class="at">group =</span> cluster), <span class="at">data =</span> truth,  <span class="at">col =</span> <span class="st">&#39;black&#39;</span>)</span>
<span id="cb242-19"><a href="helpers-for-simulations-in-the-paper.html#cb242-19" tabindex="-1"></a></span>
<span id="cb242-20"><a href="helpers-for-simulations-in-the-paper.html#cb242-20" tabindex="-1"></a>o <span class="ot">=</span> obj_overfit<span class="sc">$</span>mu <span class="sc">%&gt;%</span> <span class="fu">colMeans</span>() <span class="sc">%&gt;%</span> <span class="fu">order</span>()</span>
<span id="cb242-21"><a href="helpers-for-simulations-in-the-paper.html#cb242-21" tabindex="-1"></a>obj_overfit <span class="ot">=</span> <a href='helpers-for-simulations-in-the-paper.html#reorder_flowmeans'>reorder_flowmeans</a>(obj_overfit, o)</span>
<span id="cb242-22"><a href="helpers-for-simulations-in-the-paper.html#cb242-22" tabindex="-1"></a>g2 <span class="ot">=</span> <a href='helpers-for-simulations-in-the-paper.html#plot_1d_flowmeans'>plot_1d_flowmeans</a>(obj_overfit, ylist) <span class="sc">+</span></span>
<span id="cb242-23"><a href="helpers-for-simulations-in-the-paper.html#cb242-23" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>time, <span class="at">y=</span>mean, <span class="at">group =</span> cluster), <span class="at">data =</span> truth, <span class="at">col =</span> <span class="st">&#39;black&#39;</span>)</span>
<span id="cb242-24"><a href="helpers-for-simulations-in-the-paper.html#cb242-24" tabindex="-1"></a></span>
<span id="cb242-25"><a href="helpers-for-simulations-in-the-paper.html#cb242-25" tabindex="-1"></a><span class="fu">do.call</span>(ggpubr<span class="sc">::</span>ggarrange, <span class="fu">c</span>(<span class="fu">list</span>(g1, g2), <span class="at">ncol=</span><span class="dv">1</span>, <span class="at">nrow=</span><span class="dv">2</span>))</span>
<span id="cb242-26"><a href="helpers-for-simulations-in-the-paper.html#cb242-26" tabindex="-1"></a></span>
<span id="cb242-27"><a href="helpers-for-simulations-in-the-paper.html#cb242-27" tabindex="-1"></a><span class="do">## Make the probability plots</span></span>
<span id="cb242-28"><a href="helpers-for-simulations-in-the-paper.html#cb242-28" tabindex="-1"></a>g1 <span class="ot">=</span> obj_overfit<span class="sc">$</span>prob <span class="sc">%&gt;%</span> <a href='helpers-for-simulations-in-the-paper.html#my_wrangle'>my_wrangle</a>(<span class="st">&quot;prob&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb242-29"><a href="helpers-for-simulations-in-the-paper.html#cb242-29" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb242-30"><a href="helpers-for-simulations-in-the-paper.html#cb242-30" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>time, <span class="at">y =</span> prob, <span class="at">group =</span> cluster, <span class="at">col =</span> cluster), <span class="at">size =</span> <span class="fu">rel</span>(<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb242-31"><a href="helpers-for-simulations-in-the-paper.html#cb242-31" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Estimated cluster probability&quot;</span>) <span class="sc">+</span></span>
<span id="cb242-32"><a href="helpers-for-simulations-in-the-paper.html#cb242-32" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>time, <span class="at">y=</span>prob, <span class="at">group =</span> cluster), <span class="at">data =</span> truth, <span class="at">col =</span> <span class="st">&#39;black&#39;</span>)</span>
<span id="cb242-33"><a href="helpers-for-simulations-in-the-paper.html#cb242-33" tabindex="-1"></a></span>
<span id="cb242-34"><a href="helpers-for-simulations-in-the-paper.html#cb242-34" tabindex="-1"></a>g2 <span class="ot">=</span> obj_underfit<span class="sc">$</span>prob <span class="sc">%&gt;%</span> <a href='helpers-for-simulations-in-the-paper.html#my_wrangle'>my_wrangle</a>(<span class="st">&quot;prob&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb242-35"><a href="helpers-for-simulations-in-the-paper.html#cb242-35" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb242-36"><a href="helpers-for-simulations-in-the-paper.html#cb242-36" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>time, <span class="at">y =</span> prob, <span class="at">group =</span> cluster, <span class="at">col =</span> cluster), <span class="at">size =</span> <span class="fu">rel</span>(<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb242-37"><a href="helpers-for-simulations-in-the-paper.html#cb242-37" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">&quot;Estimated cluster probability&quot;</span>) <span class="sc">+</span></span>
<span id="cb242-38"><a href="helpers-for-simulations-in-the-paper.html#cb242-38" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>time, <span class="at">y=</span>prob, <span class="at">group =</span> cluster), <span class="at">data =</span> truth, <span class="at">col =</span> <span class="st">&#39;black&#39;</span>)</span>
<span id="cb242-39"><a href="helpers-for-simulations-in-the-paper.html#cb242-39" tabindex="-1"></a></span>
<span id="cb242-40"><a href="helpers-for-simulations-in-the-paper.html#cb242-40" tabindex="-1"></a><span class="fu">do.call</span>(ggpubr<span class="sc">::</span>ggarrange, <span class="fu">c</span>(<span class="fu">list</span>(g1, g2), <span class="at">ncol=</span><span class="dv">1</span>, <span class="at">nrow=</span><span class="dv">2</span>))</span></code></pre></div>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="helpers-for-simulations-in-the-paper.html#cb243-1" tabindex="-1"></a><span class="co">#&#39; A &quot;soft&quot; version of a rand index between two sets of responsibility</span></span>
<span id="cb243-2"><a href="helpers-for-simulations-in-the-paper.html#cb243-2" tabindex="-1"></a><span class="co">#&#39; (membership probability) matrices. Measures the /disagreement/ between the two clusterings.</span></span>
<span id="cb243-3"><a href="helpers-for-simulations-in-the-paper.html#cb243-3" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb243-4"><a href="helpers-for-simulations-in-the-paper.html#cb243-4" tabindex="-1"></a><span class="co">#&#39; @param resp_list1 One list of responsibility matrices.</span></span>
<span id="cb243-5"><a href="helpers-for-simulations-in-the-paper.html#cb243-5" tabindex="-1"></a><span class="co">#&#39; @param resp_list2 Another list of responsibility matrices.</span></span>
<span id="cb243-6"><a href="helpers-for-simulations-in-the-paper.html#cb243-6" tabindex="-1"></a><span class="co">#&#39; @param times Optional; if you would like to isolate your attention to some specific times.</span></span>
<span id="cb243-7"><a href="helpers-for-simulations-in-the-paper.html#cb243-7" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb243-8"><a href="helpers-for-simulations-in-the-paper.html#cb243-8" tabindex="-1"></a><span class="co">#&#39; @return A single soft rand index number</span></span>
<span id="cb243-9"><a href="helpers-for-simulations-in-the-paper.html#cb243-9" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb243-10"><a href="helpers-for-simulations-in-the-paper.html#cb243-10" tabindex="-1"></a><span id='soft_rand'>soft_rand</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(resp_list1, resp_list2, <span class="at">times =</span> <span class="cn">NULL</span>){</span>
<span id="cb243-11"><a href="helpers-for-simulations-in-the-paper.html#cb243-11" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(times)) resp_list1 <span class="ot">=</span> resp_list1[times]</span>
<span id="cb243-12"><a href="helpers-for-simulations-in-the-paper.html#cb243-12" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(times)) resp_list2 <span class="ot">=</span> resp_list2[times]</span>
<span id="cb243-13"><a href="helpers-for-simulations-in-the-paper.html#cb243-13" tabindex="-1"></a>  </span>
<span id="cb243-14"><a href="helpers-for-simulations-in-the-paper.html#cb243-14" tabindex="-1"></a>  <span id='soft_rand_onetime'>soft_rand_onetime</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(resp1, resp2){</span>
<span id="cb243-15"><a href="helpers-for-simulations-in-the-paper.html#cb243-15" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(resp1) <span class="sc">==</span> <span class="fu">nrow</span>(resp2))</span>
<span id="cb243-16"><a href="helpers-for-simulations-in-the-paper.html#cb243-16" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">ncol</span>(resp1) <span class="sc">==</span> <span class="fu">ncol</span>(resp2))</span>
<span id="cb243-17"><a href="helpers-for-simulations-in-the-paper.html#cb243-17" tabindex="-1"></a>    nt <span class="ot">=</span> <span class="fu">nrow</span>(resp1)</span>
<span id="cb243-18"><a href="helpers-for-simulations-in-the-paper.html#cb243-18" tabindex="-1"></a>    </span>
<span id="cb243-19"><a href="helpers-for-simulations-in-the-paper.html#cb243-19" tabindex="-1"></a>    <span class="do">## Form the score</span></span>
<span id="cb243-20"><a href="helpers-for-simulations-in-the-paper.html#cb243-20" tabindex="-1"></a>    mat11 <span class="ot">=</span> resp1 <span class="sc">%*%</span> <span class="fu">t</span>(resp1)</span>
<span id="cb243-21"><a href="helpers-for-simulations-in-the-paper.html#cb243-21" tabindex="-1"></a>    mat22 <span class="ot">=</span> resp2 <span class="sc">%*%</span> <span class="fu">t</span>(resp2)</span>
<span id="cb243-22"><a href="helpers-for-simulations-in-the-paper.html#cb243-22" tabindex="-1"></a></span>
<span id="cb243-23"><a href="helpers-for-simulations-in-the-paper.html#cb243-23" tabindex="-1"></a>    a <span class="ot">=</span> mat11 <span class="sc">*</span> mat22</span>
<span id="cb243-24"><a href="helpers-for-simulations-in-the-paper.html#cb243-24" tabindex="-1"></a>    b <span class="ot">=</span> (<span class="dv">1</span><span class="sc">-</span>mat11) <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>mat22)</span>
<span id="cb243-25"><a href="helpers-for-simulations-in-the-paper.html#cb243-25" tabindex="-1"></a>    c <span class="ot">=</span> mat11 <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>mat22)</span>
<span id="cb243-26"><a href="helpers-for-simulations-in-the-paper.html#cb243-26" tabindex="-1"></a>    d <span class="ot">=</span> (<span class="dv">1</span><span class="sc">-</span>mat11) <span class="sc">*</span> mat22</span>
<span id="cb243-27"><a href="helpers-for-simulations-in-the-paper.html#cb243-27" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">c</span>(<span class="at">a =</span> <span class="fu">sum</span>(a), <span class="at">b =</span> <span class="fu">sum</span>(b), <span class="at">c =</span> <span class="fu">sum</span>(c), <span class="at">d =</span> <span class="fu">sum</span>(d)))</span>
<span id="cb243-28"><a href="helpers-for-simulations-in-the-paper.html#cb243-28" tabindex="-1"></a>  }</span>
<span id="cb243-29"><a href="helpers-for-simulations-in-the-paper.html#cb243-29" tabindex="-1"></a>  abcd_over_time <span class="ot">=</span> <span class="fu">mapply</span>(soft_rand_onetime, resp_list1, resp_list2)</span>
<span id="cb243-30"><a href="helpers-for-simulations-in-the-paper.html#cb243-30" tabindex="-1"></a>  abcdmat <span class="ot">=</span> abcd_over_time <span class="sc">%&gt;%</span> <span class="fu">t</span>()</span>
<span id="cb243-31"><a href="helpers-for-simulations-in-the-paper.html#cb243-31" tabindex="-1"></a>  abcd <span class="ot">=</span> abcdmat <span class="sc">%&gt;%</span> <span class="fu">colSums</span>()</span>
<span id="cb243-32"><a href="helpers-for-simulations-in-the-paper.html#cb243-32" tabindex="-1"></a>  score <span class="ot">=</span> (abcd[<span class="st">&quot;a&quot;</span>] <span class="sc">+</span> abcd[<span class="st">&quot;b&quot;</span>])<span class="sc">/</span>  (<span class="fu">sum</span>(abcd))</span>
<span id="cb243-33"><a href="helpers-for-simulations-in-the-paper.html#cb243-33" tabindex="-1"></a>  <span class="fu">return</span>(score)</span>
<span id="cb243-34"><a href="helpers-for-simulations-in-the-paper.html#cb243-34" tabindex="-1"></a>}</span></code></pre></div>
<p>It’s also helpful to have a function that takes a list of discrete memberships
(integers 1,..,K) and convert it to a list of responsibility matrices similar in
format to <code>obj$resp</code> of a flowtrend object <code>obj</code>.</p>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb244-1"><a href="helpers-for-simulations-in-the-paper.html#cb244-1" tabindex="-1"></a>numclust <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb244-2"><a href="helpers-for-simulations-in-the-paper.html#cb244-2" tabindex="-1"></a>TT <span class="ot">=</span> <span class="dv">100</span></span>
<span id="cb244-3"><a href="helpers-for-simulations-in-the-paper.html#cb244-3" tabindex="-1"></a>dimdat <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb244-4"><a href="helpers-for-simulations-in-the-paper.html#cb244-4" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">0</span>)</span>
<span id="cb244-5"><a href="helpers-for-simulations-in-the-paper.html#cb244-5" tabindex="-1"></a>dt <span class="ot">=</span> <a href='package-setup.html#gendat_1d'>gendat_1d</a>(<span class="at">TT =</span> TT, <span class="at">ntlist =</span> <span class="fu">rep</span>(TT, <span class="dv">100</span>))</span>
<span id="cb244-6"><a href="helpers-for-simulations-in-the-paper.html#cb244-6" tabindex="-1"></a>ylist <span class="ot">=</span> dt <span class="sc">%&gt;%</span> <a href='package-setup.html#dt2ylist'>dt2ylist</a>()</span>
<span id="cb244-7"><a href="helpers-for-simulations-in-the-paper.html#cb244-7" tabindex="-1"></a>truth <span class="ot">=</span> <a href='package-setup.html#gendat_1d'>gendat_1d</a>(<span class="at">TT =</span> TT, <span class="at">ntlist =</span> <span class="fu">rep</span>(TT, <span class="dv">100</span>), <span class="at">return_model=</span><span class="cn">TRUE</span>)</span>
<span id="cb244-8"><a href="helpers-for-simulations-in-the-paper.html#cb244-8" tabindex="-1"></a>res <span class="ot">=</span> <a href='flowtrend.html#flowtrend'>flowtrend</a>(<span class="at">ylist=</span>ylist, <span class="at">numclust=</span><span class="dv">3</span>, <span class="at">l=</span><span class="dv">2</span>, <span class="at">l_prob=</span><span class="dv">1</span>, <span class="at">lambda =</span> .<span class="dv">01</span>,</span>
<span id="cb244-9"><a href="helpers-for-simulations-in-the-paper.html#cb244-9" tabindex="-1"></a>                <span class="at">lambda_prob=</span><span class="fl">0.01</span>, <span class="at">verbose=</span><span class="cn">TRUE</span>, <span class="at">nrestart=</span><span class="dv">1</span>)</span>
<span id="cb244-10"><a href="helpers-for-simulations-in-the-paper.html#cb244-10" tabindex="-1"></a>res2 <span class="ot">=</span> <a href='flowtrend.html#flowtrend'>flowtrend</a>(<span class="at">ylist=</span>ylist, <span class="at">numclust=</span><span class="dv">3</span>, <span class="at">l=</span><span class="dv">2</span>, <span class="at">l_prob=</span><span class="dv">1</span>, <span class="at">lambda =</span> <span class="dv">1</span>,</span>
<span id="cb244-11"><a href="helpers-for-simulations-in-the-paper.html#cb244-11" tabindex="-1"></a>                 <span class="at">lambda_prob=</span><span class="dv">1</span>, <span class="at">verbose=</span><span class="cn">TRUE</span>, <span class="at">nrestart=</span><span class="dv">1</span>)</span>
<span id="cb244-12"><a href="helpers-for-simulations-in-the-paper.html#cb244-12" tabindex="-1"></a></span>
<span id="cb244-13"><a href="helpers-for-simulations-in-the-paper.html#cb244-13" tabindex="-1"></a><span class="do">## Calculate the soft rand index of two different models</span></span>
<span id="cb244-14"><a href="helpers-for-simulations-in-the-paper.html#cb244-14" tabindex="-1"></a><a href='helpers-for-simulations-in-the-paper.html#soft_rand'>soft_rand</a>(res<span class="sc">$</span>resp, res2<span class="sc">$</span>resp)</span>
<span id="cb244-15"><a href="helpers-for-simulations-in-the-paper.html#cb244-15" tabindex="-1"></a><a href='helpers-for-simulations-in-the-paper.html#soft_rand'>soft_rand</a>(res<span class="sc">$</span>resp, res<span class="sc">$</span>resp)</span>
<span id="cb244-16"><a href="helpers-for-simulations-in-the-paper.html#cb244-16" tabindex="-1"></a><a href='helpers-for-simulations-in-the-paper.html#soft_rand'>soft_rand</a>(res2<span class="sc">$</span>resp, res2<span class="sc">$</span>resp)</span>
<span id="cb244-17"><a href="helpers-for-simulations-in-the-paper.html#cb244-17" tabindex="-1"></a></span>
<span id="cb244-18"><a href="helpers-for-simulations-in-the-paper.html#cb244-18" tabindex="-1"></a>g1 <span class="ot">=</span> <a href='package-setup.html#plot_1d'>plot_1d</a>(<span class="at">ylist=</span>ylist, <span class="at">obj=</span>res2)</span>
<span id="cb244-19"><a href="helpers-for-simulations-in-the-paper.html#cb244-19" tabindex="-1"></a>g2 <span class="ot">=</span> <a href='package-setup.html#plot_1d'>plot_1d</a>(<span class="at">ylist=</span>ylist, <span class="at">obj=</span>res)</span>
<span id="cb244-20"><a href="helpers-for-simulations-in-the-paper.html#cb244-20" tabindex="-1"></a><span class="fu">do.call</span>(ggpubr<span class="sc">::</span>ggarrange, <span class="fu">c</span>(<span class="fu">list</span>(g1, g2), <span class="at">ncol=</span><span class="dv">1</span>, <span class="at">nrow=</span><span class="dv">2</span>))</span>
<span id="cb244-21"><a href="helpers-for-simulations-in-the-paper.html#cb244-21" tabindex="-1"></a></span>
<span id="cb244-22"><a href="helpers-for-simulations-in-the-paper.html#cb244-22" tabindex="-1"></a><span class="do">## Case 1: above</span></span>
<span id="cb244-23"><a href="helpers-for-simulations-in-the-paper.html#cb244-23" tabindex="-1"></a></span>
<span id="cb244-24"><a href="helpers-for-simulations-in-the-paper.html#cb244-24" tabindex="-1"></a><span class="do">## Case 2: one is the TRUTH; based on the</span></span>
<span id="cb244-25"><a href="helpers-for-simulations-in-the-paper.html#cb244-25" tabindex="-1"></a></span>
<span id="cb244-26"><a href="helpers-for-simulations-in-the-paper.html#cb244-26" tabindex="-1"></a><span class="do">## Case 3: one is a hard clustering. </span></span>
<span id="cb244-27"><a href="helpers-for-simulations-in-the-paper.html#cb244-27" tabindex="-1"></a><span class="fu">plot</span>(ylist[[<span class="dv">1</span>]], <span class="at">col =</span> obj<span class="sc">$</span>memlist[[<span class="dv">1</span>]])</span>
<span id="cb244-28"><a href="helpers-for-simulations-in-the-paper.html#cb244-28" tabindex="-1"></a>obj<span class="sc">$</span>resp <span class="ot">=</span> <a href='helpers-for-simulations-in-the-paper.html#get_resp_from_labels'>get_resp_from_labels</a>(obj<span class="sc">$</span>memlist)</span>
<span id="cb244-29"><a href="helpers-for-simulations-in-the-paper.html#cb244-29" tabindex="-1"></a><a href='helpers-for-simulations-in-the-paper.html#soft_rand'>soft_rand</a>(res<span class="sc">$</span>resp, res2<span class="sc">$</span>resp)</span>
<span id="cb244-30"><a href="helpers-for-simulations-in-the-paper.html#cb244-30" tabindex="-1"></a><a href='helpers-for-simulations-in-the-paper.html#soft_rand'>soft_rand</a>(res<span class="sc">$</span>resp, res<span class="sc">$</span>resp)</span>
<span id="cb244-31"><a href="helpers-for-simulations-in-the-paper.html#cb244-31" tabindex="-1"></a></span>
<span id="cb244-32"><a href="helpers-for-simulations-in-the-paper.html#cb244-32" tabindex="-1"></a><span class="do">## Next, code up the truth</span></span>
<span id="cb244-33"><a href="helpers-for-simulations-in-the-paper.html#cb244-33" tabindex="-1"></a>a <span class="ot">=</span> dt <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(time ) <span class="sc">%&gt;%</span> <span class="fu">group_split</span>() <span class="sc">%&gt;%</span></span>
<span id="cb244-34"><a href="helpers-for-simulations-in-the-paper.html#cb244-34" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="cf">function</span>(one_dt) one_dt <span class="sc">%&gt;%</span> <span class="fu">pull</span>(cluster))</span>
<span id="cb244-35"><a href="helpers-for-simulations-in-the-paper.html#cb244-35" tabindex="-1"></a></span>
<span id="cb244-36"><a href="helpers-for-simulations-in-the-paper.html#cb244-36" tabindex="-1"></a></span>
<span id="cb244-37"><a href="helpers-for-simulations-in-the-paper.html#cb244-37" tabindex="-1"></a><span class="co">#&#39; Helper to get, from labels</span></span>
<span id="cb244-38"><a href="helpers-for-simulations-in-the-paper.html#cb244-38" tabindex="-1"></a><span id='get_resp_from_labels'>get_resp_from_labels</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(labels){</span>
<span id="cb244-39"><a href="helpers-for-simulations-in-the-paper.html#cb244-39" tabindex="-1"></a>  numclust <span class="ot">=</span> <span class="fu">max</span>(labels[[<span class="dv">1</span>]])</span>
<span id="cb244-40"><a href="helpers-for-simulations-in-the-paper.html#cb244-40" tabindex="-1"></a>  <span class="fu">lapply</span>(labels, <span class="cf">function</span>(one_time_label){</span>
<span id="cb244-41"><a href="helpers-for-simulations-in-the-paper.html#cb244-41" tabindex="-1"></a>  one_resp <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">3</span>)</span>
<span id="cb244-42"><a href="helpers-for-simulations-in-the-paper.html#cb244-42" tabindex="-1"></a>  resp <span class="ot">=</span> <span class="fu">sapply</span>(obj<span class="sc">$</span>memlist[[<span class="dv">1</span>]], <span class="cf">function</span>(ii){</span>
<span id="cb244-43"><a href="helpers-for-simulations-in-the-paper.html#cb244-43" tabindex="-1"></a>    one_resp[ii] <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb244-44"><a href="helpers-for-simulations-in-the-paper.html#cb244-44" tabindex="-1"></a>    <span class="fu">return</span>(one_resp)</span>
<span id="cb244-45"><a href="helpers-for-simulations-in-the-paper.html#cb244-45" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span> <span class="fu">t</span>()</span>
<span id="cb244-46"><a href="helpers-for-simulations-in-the-paper.html#cb244-46" tabindex="-1"></a>  <span class="fu">return</span>(resp)</span>
<span id="cb244-47"><a href="helpers-for-simulations-in-the-paper.html#cb244-47" tabindex="-1"></a>  })</span>
<span id="cb244-48"><a href="helpers-for-simulations-in-the-paper.html#cb244-48" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="generating-pseudo-real-data" class="section level2 hasAnchor" number="16.4">
<h2><span class="header-section-number">16.4</span> Generating “pseudo-real” data<a href="helpers-for-simulations-in-the-paper.html#generating-pseudo-real-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Two clusters will be taken from an estimated <em>flowtrend</em> model fit on real data,
downloaded from here:</p>
<p><a href="https://zenodo.org/records/6471995" class="uri">https://zenodo.org/records/6471995</a></p>
<p>to <a href="./data">./data</a>.</p>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb245-1"><a href="helpers-for-simulations-in-the-paper.html#cb245-1" tabindex="-1"></a><span class="co">#&#39; Convert list of memberships into a list of responsibilities.</span></span>
<span id="cb245-2"><a href="helpers-for-simulations-in-the-paper.html#cb245-2" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb245-3"><a href="helpers-for-simulations-in-the-paper.html#cb245-3" tabindex="-1"></a><span class="co">#&#39; @param memlist List of memberships</span></span>
<span id="cb245-4"><a href="helpers-for-simulations-in-the-paper.html#cb245-4" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb245-5"><a href="helpers-for-simulations-in-the-paper.html#cb245-5" tabindex="-1"></a><span class="co">#&#39; @return</span></span>
<span id="cb245-6"><a href="helpers-for-simulations-in-the-paper.html#cb245-6" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb245-7"><a href="helpers-for-simulations-in-the-paper.html#cb245-7" tabindex="-1"></a><span id='memlist_to_respmat'>memlist_to_respmat</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(memlist){</span>
<span id="cb245-8"><a href="helpers-for-simulations-in-the-paper.html#cb245-8" tabindex="-1"></a>  numclust <span class="ot">=</span> <span class="fu">max</span>(<span class="fu">sapply</span>(memlist, max))</span>
<span id="cb245-9"><a href="helpers-for-simulations-in-the-paper.html#cb245-9" tabindex="-1"></a>  respmats <span class="ot">=</span> <span class="fu">lapply</span>(memlist, <span class="cf">function</span>(mem){</span>
<span id="cb245-10"><a href="helpers-for-simulations-in-the-paper.html#cb245-10" tabindex="-1"></a>    respmat <span class="ot">=</span> <span class="fu">lapply</span>(mem, <span class="cf">function</span>(onemem){</span>
<span id="cb245-11"><a href="helpers-for-simulations-in-the-paper.html#cb245-11" tabindex="-1"></a>      onerow <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">0</span>, numclust)<span class="do">##c(0,0)</span></span>
<span id="cb245-12"><a href="helpers-for-simulations-in-the-paper.html#cb245-12" tabindex="-1"></a>      onerow[onemem] <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb245-13"><a href="helpers-for-simulations-in-the-paper.html#cb245-13" tabindex="-1"></a>      <span class="fu">return</span>(onerow)</span>
<span id="cb245-14"><a href="helpers-for-simulations-in-the-paper.html#cb245-14" tabindex="-1"></a>    }) <span class="sc">%&gt;%</span> <span class="fu">do.call</span>(rbind, .)</span>
<span id="cb245-15"><a href="helpers-for-simulations-in-the-paper.html#cb245-15" tabindex="-1"></a>    <span class="fu">return</span>(respmat)</span>
<span id="cb245-16"><a href="helpers-for-simulations-in-the-paper.html#cb245-16" tabindex="-1"></a>  })</span>
<span id="cb245-17"><a href="helpers-for-simulations-in-the-paper.html#cb245-17" tabindex="-1"></a>  <span class="fu">return</span>(respmats)</span>
<span id="cb245-18"><a href="helpers-for-simulations-in-the-paper.html#cb245-18" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## here() starts at /Users/sangwonh/repos/flowtrend</code></pre>
<p>Let’s smooth these using a trend-filter;</p>
<ul>
<li>The cluster means will be taken to directly trend filtered at 2.</li>
<li>The log odds will be smoothed.</li>
</ul>
<p>Specifically, recall that <span class="math inline">\(p = e^\gamma / (1 + e^\gamma)\)</span>. So, we will take
<span class="math inline">\(\gamma = \log(p/(1-p)) \propto \log(p)\)</span>, smooth it, and recreate <span class="math inline">\(p\)</span>.</p>
<p>Next, generate new 1d data.</p>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="helpers-for-simulations-in-the-paper.html#cb247-1" tabindex="-1"></a><span class="do">## This data is from the results from </span></span>
<span id="cb247-2"><a href="helpers-for-simulations-in-the-paper.html#cb247-2" tabindex="-1"></a>here<span class="sc">::</span><span class="fu">i_am</span>(<span class="st">&quot;7simulations.Rmd&quot;</span>)</span>
<span id="cb247-3"><a href="helpers-for-simulations-in-the-paper.html#cb247-3" tabindex="-1"></a>datadir <span class="ot">=</span> <span class="fu">file.path</span>(here<span class="sc">::</span><span class="fu">here</span>(), <span class="st">&quot;inst&quot;</span>, <span class="st">&quot;data&quot;</span>)</span>
<span id="cb247-4"><a href="helpers-for-simulations-in-the-paper.html#cb247-4" tabindex="-1"></a>res <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(datadir, <span class="st">&quot;1d-cvres.rds&quot;</span>)) <span class="sc">%&gt;%</span> .<span class="sc">$</span>bestres</span>
<span id="cb247-5"><a href="helpers-for-simulations-in-the-paper.html#cb247-5" tabindex="-1"></a></span>
<span id="cb247-6"><a href="helpers-for-simulations-in-the-paper.html#cb247-6" tabindex="-1"></a><span class="do">## Picoeuk</span></span>
<span id="cb247-7"><a href="helpers-for-simulations-in-the-paper.html#cb247-7" tabindex="-1"></a>iclust <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb247-8"><a href="helpers-for-simulations-in-the-paper.html#cb247-8" tabindex="-1"></a>mn1 <span class="ot">=</span> <span class="fu">cbind</span>(<span class="dv">1</span>, res<span class="sc">$</span>X) <span class="sc">%*%</span> res<span class="sc">$</span>beta[[iclust]] <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb247-9"><a href="helpers-for-simulations-in-the-paper.html#cb247-9" tabindex="-1"></a></span>
<span id="cb247-10"><a href="helpers-for-simulations-in-the-paper.html#cb247-10" tabindex="-1"></a><span class="do">## Prochlorococcus</span></span>
<span id="cb247-11"><a href="helpers-for-simulations-in-the-paper.html#cb247-11" tabindex="-1"></a>iclust <span class="ot">=</span> <span class="dv">4</span></span>
<span id="cb247-12"><a href="helpers-for-simulations-in-the-paper.html#cb247-12" tabindex="-1"></a>mn2 <span class="ot">=</span> <span class="fu">cbind</span>(<span class="dv">1</span>, res<span class="sc">$</span>X) <span class="sc">%*%</span> res<span class="sc">$</span>beta[[iclust]] <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb247-13"><a href="helpers-for-simulations-in-the-paper.html#cb247-13" tabindex="-1"></a></span>
<span id="cb247-14"><a href="helpers-for-simulations-in-the-paper.html#cb247-14" tabindex="-1"></a><span class="do">## Cluster probabilities</span></span>
<span id="cb247-15"><a href="helpers-for-simulations-in-the-paper.html#cb247-15" tabindex="-1"></a>probs <span class="ot">=</span> res<span class="sc">$</span>pie[,<span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>)]  </span>
<span id="cb247-16"><a href="helpers-for-simulations-in-the-paper.html#cb247-16" tabindex="-1"></a>probs <span class="ot">=</span> probs <span class="sc">/</span> <span class="fu">rowSums</span>(probs)</span>
<span id="cb247-17"><a href="helpers-for-simulations-in-the-paper.html#cb247-17" tabindex="-1"></a></span>
<span id="cb247-18"><a href="helpers-for-simulations-in-the-paper.html#cb247-18" tabindex="-1"></a><span class="do">## Save them as separte objects</span></span>
<span id="cb247-19"><a href="helpers-for-simulations-in-the-paper.html#cb247-19" tabindex="-1"></a>mns_orig <span class="ot">=</span> <span class="fu">cbind</span>(mn1, mn2)</span>
<span id="cb247-20"><a href="helpers-for-simulations-in-the-paper.html#cb247-20" tabindex="-1"></a>probs_orig <span class="ot">=</span> probs</span></code></pre></div>
<p>Lastly, there are some miscellaneous helpers that are useful when running actual
jobs on a server.</p>
<p>The first one is <code><a href='helpers-for-simulations-in-the-paper.html#create_destin'>create_destin</a>()</code>, which creates a directory if it doesn’t already exist.</p>
<div class="sourceCode" id="cb248"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb248-1"><a href="helpers-for-simulations-in-the-paper.html#cb248-1" tabindex="-1"></a>nt <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb248-2"><a href="helpers-for-simulations-in-the-paper.html#cb248-2" tabindex="-1"></a>sd1 <span class="ot">=</span> res<span class="sc">$</span>sigma <span class="sc">%&gt;%</span> .[,<span class="dv">1</span>,<span class="dv">1</span>] <span class="sc">%&gt;%</span> .[<span class="dv">3</span>] <span class="sc">%&gt;%</span> <span class="fu">sqrt</span>() </span>
<span id="cb248-3"><a href="helpers-for-simulations-in-the-paper.html#cb248-3" tabindex="-1"></a>sd2 <span class="ot">=</span> res<span class="sc">$</span>sigma <span class="sc">%&gt;%</span> .[,<span class="dv">1</span>,<span class="dv">1</span>] <span class="sc">%&gt;%</span> .[<span class="dv">4</span>] <span class="sc">%&gt;%</span> <span class="fu">sqrt</span>()</span>
<span id="cb248-4"><a href="helpers-for-simulations-in-the-paper.html#cb248-4" tabindex="-1"></a></span>
<span id="cb248-5"><a href="helpers-for-simulations-in-the-paper.html#cb248-5" tabindex="-1"></a><span class="do">## Smooth means</span></span>
<span id="cb248-6"><a href="helpers-for-simulations-in-the-paper.html#cb248-6" tabindex="-1"></a>mn1 <span class="ot">=</span> mns_orig[,<span class="dv">1</span>]</span>
<span id="cb248-7"><a href="helpers-for-simulations-in-the-paper.html#cb248-7" tabindex="-1"></a>mn2 <span class="ot">=</span> mns_orig[,<span class="dv">2</span>]</span>
<span id="cb248-8"><a href="helpers-for-simulations-in-the-paper.html#cb248-8" tabindex="-1"></a>gap <span class="ot">=</span> <span class="fu">mean</span>(mn1) <span class="sc">-</span> <span class="fu">mean</span>(mn2)</span>
<span id="cb248-9"><a href="helpers-for-simulations-in-the-paper.html#cb248-9" tabindex="-1"></a>mn1 <span class="ot">=</span> mn1 <span class="sc">-</span> gap</span>
<span id="cb248-10"><a href="helpers-for-simulations-in-the-paper.html#cb248-10" tabindex="-1"></a>mn1 <span class="ot">=</span> mn1 <span class="sc">%&gt;%</span> <span class="fu">fit_tf</span>(<span class="at">ord =</span> <span class="dv">2</span>)</span>
<span id="cb248-11"><a href="helpers-for-simulations-in-the-paper.html#cb248-11" tabindex="-1"></a>mn2 <span class="ot">=</span> mn2 <span class="sc">%&gt;%</span> <span class="fu">fit_tf</span>(<span class="at">ord =</span> <span class="dv">2</span>)</span>
<span id="cb248-12"><a href="helpers-for-simulations-in-the-paper.html#cb248-12" tabindex="-1"></a></span>
<span id="cb248-13"><a href="helpers-for-simulations-in-the-paper.html#cb248-13" tabindex="-1"></a><span class="do">## Smooth probabilities</span></span>
<span id="cb248-14"><a href="helpers-for-simulations-in-the-paper.html#cb248-14" tabindex="-1"></a>probs <span class="ot">=</span> probs_orig</span>
<span id="cb248-15"><a href="helpers-for-simulations-in-the-paper.html#cb248-15" tabindex="-1"></a>gamma <span class="ot">=</span> <span class="fu">log</span>(probs[,<span class="dv">1</span>]<span class="sc">/</span>probs[,<span class="dv">2</span>])</span>
<span id="cb248-16"><a href="helpers-for-simulations-in-the-paper.html#cb248-16" tabindex="-1"></a>gamma <span class="ot">=</span> gamma <span class="sc">%&gt;%</span> <span class="fu">fit_tf</span>(<span class="at">ord =</span> <span class="dv">1</span>)</span>
<span id="cb248-17"><a href="helpers-for-simulations-in-the-paper.html#cb248-17" tabindex="-1"></a>probs[,<span class="dv">1</span>] <span class="ot">=</span> gamma <span class="sc">%&gt;%</span> <span class="fu">exp</span>()</span>
<span id="cb248-18"><a href="helpers-for-simulations-in-the-paper.html#cb248-18" tabindex="-1"></a>probs[,<span class="dv">1</span>] <span class="ot">=</span> probs[,<span class="dv">1</span>]<span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> probs[,<span class="dv">1</span>])</span>
<span id="cb248-19"><a href="helpers-for-simulations-in-the-paper.html#cb248-19" tabindex="-1"></a>probs[,<span class="dv">2</span>] <span class="ot">=</span>  <span class="dv">1</span> <span class="sc">-</span> probs[,<span class="dv">1</span>] </span>
<span id="cb248-20"><a href="helpers-for-simulations-in-the-paper.html#cb248-20" tabindex="-1"></a></span>
<span id="cb248-21"><a href="helpers-for-simulations-in-the-paper.html#cb248-21" tabindex="-1"></a><span class="do">## Create all the data</span></span>
<span id="cb248-22"><a href="helpers-for-simulations-in-the-paper.html#cb248-22" tabindex="-1"></a><span class="cf">for</span>(isignal <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">12</span>){</span>
<span id="cb248-23"><a href="helpers-for-simulations-in-the-paper.html#cb248-23" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&quot;isignal&quot;</span>)</span>
<span id="cb248-24"><a href="helpers-for-simulations-in-the-paper.html#cb248-24" tabindex="-1"></a>  <span class="fu">print</span>(isignal)</span>
<span id="cb248-25"><a href="helpers-for-simulations-in-the-paper.html#cb248-25" tabindex="-1"></a>  parallel<span class="sc">::</span><span class="fu">mclapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="cf">function</span>(isim){</span>
<span id="cb248-26"><a href="helpers-for-simulations-in-the-paper.html#cb248-26" tabindex="-1"></a>    <span class="fu">printprogress</span>(isim, <span class="dv">10</span>)</span>
<span id="cb248-27"><a href="helpers-for-simulations-in-the-paper.html#cb248-27" tabindex="-1"></a>  <span class="do">## for(isim in 1:10){</span></span>
<span id="cb248-28"><a href="helpers-for-simulations-in-the-paper.html#cb248-28" tabindex="-1"></a>    mns <span class="ot">=</span> <span class="fu">cbind</span>(mn1 <span class="sc">+</span> isignal <span class="sc">*</span> <span class="fl">0.05</span>, mn2)</span>
<span id="cb248-29"><a href="helpers-for-simulations-in-the-paper.html#cb248-29" tabindex="-1"></a>    <span class="fu">set.seed</span>(<span class="dv">10000</span> <span class="sc">+</span> isignal <span class="sc">*</span> <span class="dv">100</span> <span class="sc">+</span> isim)</span>
<span id="cb248-30"><a href="helpers-for-simulations-in-the-paper.html#cb248-30" tabindex="-1"></a>    datobj <span class="ot">=</span> <span class="fu">pseudoreal_gendat_1d</span>(mns, probs, sd1, sd2, <span class="at">nt =</span> <span class="dv">1000</span>)</span>
<span id="cb248-31"><a href="helpers-for-simulations-in-the-paper.html#cb248-31" tabindex="-1"></a>    datobj[[<span class="st">&quot;mns&quot;</span>]] <span class="ot">=</span> mns</span>
<span id="cb248-32"><a href="helpers-for-simulations-in-the-paper.html#cb248-32" tabindex="-1"></a>    datobj[[<span class="st">&quot;probs&quot;</span>]] <span class="ot">=</span> probs</span>
<span id="cb248-33"><a href="helpers-for-simulations-in-the-paper.html#cb248-33" tabindex="-1"></a>    datobj[[<span class="st">&quot;sd1&quot;</span>]] <span class="ot">=</span> sd1</span>
<span id="cb248-34"><a href="helpers-for-simulations-in-the-paper.html#cb248-34" tabindex="-1"></a>    datobj[[<span class="st">&quot;sd2&quot;</span>]] <span class="ot">=</span> sd2</span>
<span id="cb248-35"><a href="helpers-for-simulations-in-the-paper.html#cb248-35" tabindex="-1"></a>    destin <span class="ot">=</span> <span class="fu">file.path</span>(<span class="st">&quot;~/repos/flowtrend/inst/output/1dsim-pseudoreal&quot;</span>,</span>
<span id="cb248-36"><a href="helpers-for-simulations-in-the-paper.html#cb248-36" tabindex="-1"></a>                       <span class="fu">paste0</span>(<span class="st">&quot;isignal-&quot;</span>, isignal),</span>
<span id="cb248-37"><a href="helpers-for-simulations-in-the-paper.html#cb248-37" tabindex="-1"></a>                       <span class="fu">paste0</span>(<span class="st">&quot;isim-&quot;</span>, isim))</span>
<span id="cb248-38"><a href="helpers-for-simulations-in-the-paper.html#cb248-38" tabindex="-1"></a>    <a href='helpers-for-simulations-in-the-paper.html#create_destin'>create_destin</a>(destin)</span>
<span id="cb248-39"><a href="helpers-for-simulations-in-the-paper.html#cb248-39" tabindex="-1"></a>    <span class="do">## if(file.exists(file.path(destin, &quot;datobj.RDS&quot;))) next</span></span>
<span id="cb248-40"><a href="helpers-for-simulations-in-the-paper.html#cb248-40" tabindex="-1"></a>    <span class="fu">saveRDS</span>(datobj, <span class="at">file =</span> <span class="fu">file.path</span>(destin, <span class="st">&quot;datobj.RDS&quot;</span>))</span>
<span id="cb248-41"><a href="helpers-for-simulations-in-the-paper.html#cb248-41" tabindex="-1"></a>  <span class="do">## }</span></span>
<span id="cb248-42"><a href="helpers-for-simulations-in-the-paper.html#cb248-42" tabindex="-1"></a>  }, <span class="at">mc.cores=</span><span class="dv">8</span>)</span>
<span id="cb248-43"><a href="helpers-for-simulations-in-the-paper.html#cb248-43" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="at">fill=</span><span class="cn">TRUE</span>)</span>
<span id="cb248-44"><a href="helpers-for-simulations-in-the-paper.html#cb248-44" tabindex="-1"></a>}</span></code></pre></div>
<p>Another helper <code><a href='documenting-the-package-and-building.html#parse_args'>parse_args</a>()</code> helps R read in trailing arguments from the command line, like this:</p>
<p><code><a href='documenting-the-package-and-building.html#parse_args'>parse_args</a>(args = commandArgs(trailingOnly = TRUE), verbose=TRUE)</code></p>
<p>so that one can run jobs using a SLURM command such as:</p>
<p><code>sbatch --export=summ=0 --array=1 run-3dreal.slurm</code></p>
<p>from which the R script can access the <code>summ=0</code> variable.</p>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb249-1"><a href="helpers-for-simulations-in-the-paper.html#cb249-1" tabindex="-1"></a><span class="co">#&#39; Creates a directory \code{destin}, if it doesn&#39;t already exist.</span></span>
<span id="cb249-2"><a href="helpers-for-simulations-in-the-paper.html#cb249-2" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb249-3"><a href="helpers-for-simulations-in-the-paper.html#cb249-3" tabindex="-1"></a><span class="co">#&#39; @param destin Destination directory.</span></span>
<span id="cb249-4"><a href="helpers-for-simulations-in-the-paper.html#cb249-4" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb249-5"><a href="helpers-for-simulations-in-the-paper.html#cb249-5" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb249-6"><a href="helpers-for-simulations-in-the-paper.html#cb249-6" tabindex="-1"></a><span id='create_destin'>create_destin</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(destin){</span>
<span id="cb249-7"><a href="helpers-for-simulations-in-the-paper.html#cb249-7" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(destin)){</span>
<span id="cb249-8"><a href="helpers-for-simulations-in-the-paper.html#cb249-8" tabindex="-1"></a>    <span class="fu">dir.create</span>(destin, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb249-9"><a href="helpers-for-simulations-in-the-paper.html#cb249-9" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&quot;Creating destin: &quot;</span>, destin, <span class="at">fill=</span><span class="cn">TRUE</span>)</span>
<span id="cb249-10"><a href="helpers-for-simulations-in-the-paper.html#cb249-10" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb249-11"><a href="helpers-for-simulations-in-the-paper.html#cb249-11" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&quot;All output goes out to destin: &quot;</span>, destin, <span class="at">fill =</span> <span class="cn">TRUE</span>)</span>
<span id="cb249-12"><a href="helpers-for-simulations-in-the-paper.html#cb249-12" tabindex="-1"></a>  }</span>
<span id="cb249-13"><a href="helpers-for-simulations-in-the-paper.html#cb249-13" tabindex="-1"></a>}</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="documenting-the-package-and-building.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
