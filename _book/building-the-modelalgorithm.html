<!DOCTYPE html>
<html lang="" xml:lang="">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>3 Building the model/algorithm | Creating the flowtrend R package</title>
<meta name="description" content="3 Building the model/algorithm | Creating the flowtrend R package">
<meta name="generator" content="bookdown 0.40 and GitBook 2.6.7">
<meta property="og:title" content="3 Building the model/algorithm | Creating the flowtrend R package">
<meta property="og:type" content="book">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="3 Building the model/algorithm | Creating the flowtrend R package">
<meta name="author" content="Sangwon Hyun, Tim Coleman, Francois Ribalet, Jacob Bien">
<meta name="date" content="2024-07-12">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="prev" href="package-setup.html">
<link rel="next" href="reordering-clusters.html">
<script src="libs/header-attrs-2.27/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script><link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet">
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet">
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet">
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet">
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet">
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet">
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet">
<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet">
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet">
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script><style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>
<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
</head>
<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation"><ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="package-setup.html">
<a href="package-setup.html"><i class="fa fa-check"></i><b>2</b> Package setup</a>
<ul>
<li class="chapter" data-level="2.1" data-path="package-setup.html">
<a href="package-setup.html#d-data"><i class="fa fa-check"></i><b>2.1</b> 1d data</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="package-setup.html"><a href="package-setup.html#generating-1d-data"><i class="fa fa-check"></i><b>2.1.1</b> Generating 1d data</a></li>
<li class="chapter" data-level="2.1.2" data-path="package-setup.html"><a href="package-setup.html#plotting-1d-data"><i class="fa fa-check"></i><b>2.1.2</b> Plotting 1d data</a></li>
</ul>
</li>
<li class="chapter" data-level="2.2" data-path="package-setup.html">
<a href="package-setup.html#d-data-1"><i class="fa fa-check"></i><b>2.2</b> 2d data</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="package-setup.html"><a href="package-setup.html#generating-2d-data"><i class="fa fa-check"></i><b>2.2.1</b> Generating 2d data</a></li>
<li class="chapter" data-level="2.2.2" data-path="package-setup.html"><a href="package-setup.html#plotting-2d-data"><i class="fa fa-check"></i><b>2.2.2</b> Plotting 2d data</a></li>
</ul>
</li>
<li class="chapter" data-level="2.3" data-path="package-setup.html">
<a href="package-setup.html#d-data-2"><i class="fa fa-check"></i><b>2.3</b> 3d data</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="package-setup.html"><a href="package-setup.html#plotting-3d-data"><i class="fa fa-check"></i><b>2.3.1</b> Plotting 3d data</a></li>
<li class="chapter" data-level="2.3.2" data-path="package-setup.html"><a href="package-setup.html#generating-3d-data"><i class="fa fa-check"></i><b>2.3.2</b> Generating 3d data</a></li>
</ul>
</li>
</ul>
</li>
<li class="chapter" data-level="3" data-path="building-the-modelalgorithm.html">
<a href="building-the-modelalgorithm.html"><i class="fa fa-check"></i><b>3</b> Building the model/algorithm</a>
<ul>
<li class="chapter" data-level="3.1" data-path="building-the-modelalgorithm.html"><a href="building-the-modelalgorithm.html#trend-filtering"><i class="fa fa-check"></i><b>3.1</b> Trend filtering</a></li>
<li class="chapter" data-level="3.2" data-path="building-the-modelalgorithm.html"><a href="building-the-modelalgorithm.html#objective-data-log-likelihood"><i class="fa fa-check"></i><b>3.2</b> Objective (data log-likelihood)</a></li>
<li class="chapter" data-level="3.3" data-path="building-the-modelalgorithm.html"><a href="building-the-modelalgorithm.html#initial-parameters-for-em-algorithm"><i class="fa fa-check"></i><b>3.3</b> Initial parameters for EM algorithm</a></li>
<li class="chapter" data-level="3.4" data-path="building-the-modelalgorithm.html"><a href="building-the-modelalgorithm.html#e-step"><i class="fa fa-check"></i><b>3.4</b> E step</a></li>
<li class="chapter" data-level="3.5" data-path="building-the-modelalgorithm.html">
<a href="building-the-modelalgorithm.html#m-step"><i class="fa fa-check"></i><b>3.5</b> M step</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="building-the-modelalgorithm.html"><a href="building-the-modelalgorithm.html#m-step-for-pi"><i class="fa fa-check"></i><b>3.5.1</b> M step for <span class="math inline">\(\pi\)</span></a></li>
<li class="chapter" data-level="3.5.2" data-path="building-the-modelalgorithm.html"><a href="building-the-modelalgorithm.html#m-step-for-sigma"><i class="fa fa-check"></i><b>3.5.2</b> M step for <span class="math inline">\(\Sigma\)</span></a></li>
<li class="chapter" data-level="3.5.3" data-path="building-the-modelalgorithm.html"><a href="building-the-modelalgorithm.html#m-step-for-mu"><i class="fa fa-check"></i><b>3.5.3</b> M step for <span class="math inline">\(\mu\)</span></a></li>
<li class="chapter" data-level="3.5.4" data-path="building-the-modelalgorithm.html"><a href="building-the-modelalgorithm.html#helpers-for-m-step-mu"><i class="fa fa-check"></i><b>3.5.4</b> Helpers for M step (<span class="math inline">\(\mu\)</span>)</a></li>
<li class="chapter" data-level="3.5.5" data-path="building-the-modelalgorithm.html"><a href="building-the-modelalgorithm.html#all-rcpp-functions"><i class="fa fa-check"></i><b>3.5.5</b> All Rcpp functions</a></li>
</ul>
</li>
<li class="chapter" data-level="3.6" data-path="building-the-modelalgorithm.html"><a href="building-the-modelalgorithm.html#the-main-flowtrend-function"><i class="fa fa-check"></i><b>3.6</b> The main “flowtrend” function</a></li>
</ul>
</li>
<li class="chapter" data-level="4" data-path="reordering-clusters.html"><a href="reordering-clusters.html"><i class="fa fa-check"></i><b>4</b> Reordering clusters</a></li>
<li class="chapter" data-level="5" data-path="tuning-lambda.html">
<a href="tuning-lambda.html"><i class="fa fa-check"></i><b>5</b> Tuning <span class="math inline">\(\lambda\)</span></a>
<ul>
<li class="chapter" data-level="5.1" data-path="tuning-lambda.html"><a href="tuning-lambda.html#predicting-and-evaluating-on-new-time-points"><i class="fa fa-check"></i><b>5.1</b> Predicting and evaluating on new time points</a></li>
<li class="chapter" data-level="5.2" data-path="tuning-lambda.html"><a href="tuning-lambda.html#maximum-lambda_mu-lambda_pi-values-to-test"><i class="fa fa-check"></i><b>5.2</b> Maximum <span class="math inline">\((\lambda_\mu, \lambda_\pi)\)</span> values to test</a></li>
<li class="chapter" data-level="5.3" data-path="tuning-lambda.html"><a href="tuning-lambda.html#define-cv-data-folds"><i class="fa fa-check"></i><b>5.3</b> Define CV data folds</a></li>
<li class="chapter" data-level="5.4" data-path="tuning-lambda.html"><a href="tuning-lambda.html#cv-many-single-jobs"><i class="fa fa-check"></i><b>5.4</b> CV = many single jobs</a></li>
<li class="chapter" data-level="5.5" data-path="tuning-lambda.html"><a href="tuning-lambda.html#running-cross-validation"><i class="fa fa-check"></i><b>5.5</b> Running cross-validation</a></li>
<li class="chapter" data-level="5.6" data-path="tuning-lambda.html"><a href="tuning-lambda.html#summarizing-the-output"><i class="fa fa-check"></i><b>5.6</b> Summarizing the output</a></li>
<li class="chapter" data-level="5.7" data-path="tuning-lambda.html"><a href="tuning-lambda.html#cv-on-your-own-computer"><i class="fa fa-check"></i><b>5.7</b> CV on your own computer</a></li>
<li class="chapter" data-level="5.8" data-path="tuning-lambda.html"><a href="tuning-lambda.html#plotting"><i class="fa fa-check"></i><b>5.8</b> Plotting</a></li>
</ul>
</li>
<li class="chapter" data-level="6" data-path="testing-the-flowtrend-method.html">
<a href="testing-the-flowtrend-method.html"><i class="fa fa-check"></i><b>6</b> Testing the flowtrend method</a>
<ul>
<li class="chapter" data-level="6.1" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html#d-example-1d-example"><i class="fa fa-check"></i><b>6.1</b> 1d example {#1d-example}</a></li>
<li class="chapter" data-level="6.2" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html#testing-monotonicity-of-objective-values"><i class="fa fa-check"></i><b>6.2</b> Testing monotonicity of objective values</a></li>
<li class="chapter" data-level="6.3" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html#d-example-2d-example"><i class="fa fa-check"></i><b>6.3</b> 2d example {#2d-example}</a></li>
<li class="chapter" data-level="6.4" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html#working-with-binned-dataset"><i class="fa fa-check"></i><b>6.4</b> Working with “binned” dataset</a></li>
<li class="chapter" data-level="6.5" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html#unevenly-spaced-inputs-x"><i class="fa fa-check"></i><b>6.5</b> Unevenly spaced inputs (x)</a></li>
</ul>
</li>
<li class="chapter" data-level="7" data-path="helpers-for-simulations.html">
<a href="helpers-for-simulations.html"><i class="fa fa-check"></i><b>7</b> Helpers for simulations</a>
<ul>
<li class="chapter" data-level="7.1" data-path="helpers-for-simulations.html"><a href="helpers-for-simulations.html#two-alternative-clusterings"><i class="fa fa-check"></i><b>7.1</b> Two alternative clusterings</a></li>
<li class="chapter" data-level="7.2" data-path="helpers-for-simulations.html"><a href="helpers-for-simulations.html#example-using-other-cluster-algorithms"><i class="fa fa-check"></i><b>7.2</b> Example using other cluster algorithms</a></li>
<li class="chapter" data-level="7.3" data-path="helpers-for-simulations.html"><a href="helpers-for-simulations.html#evaluating-performance-soft-rand-index"><i class="fa fa-check"></i><b>7.3</b> Evaluating performance: soft RAND index</a></li>
<li class="chapter" data-level="7.4" data-path="helpers-for-simulations.html"><a href="helpers-for-simulations.html#generating-pseudo-real-data"><i class="fa fa-check"></i><b>7.4</b> Generating “pseudo-real” data</a></li>
<li class="chapter" data-level="7.5" data-path="helpers-for-simulations.html"><a href="helpers-for-simulations.html#miscellaneous-helpers"><i class="fa fa-check"></i><b>7.5</b> Miscellaneous helpers</a></li>
</ul>
</li>
<li class="chapter" data-level="8" data-path="documenting-the-package-and-building.html"><a href="documenting-the-package-and-building.html"><i class="fa fa-check"></i><b>8</b> Documenting the package and building</a></li>
</ul></nav>
</div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Creating the <code>flowtrend</code> R package</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-"><div id="building-the-modelalgorithm" class="section level1 hasAnchor" number="3">
<h1>
<span class="header-section-number">3</span> Building the model/algorithm<a href="building-the-modelalgorithm.html#building-the-modelalgorithm" class="anchor-section" aria-label="Anchor link to header"></a>
</h1>
<div id="trend-filtering" class="section level2 hasAnchor" number="3.1">
<h2>
<span class="header-section-number">3.1</span> Trend filtering<a href="building-the-modelalgorithm.html#trend-filtering" class="anchor-section" aria-label="Anchor link to header"></a>
</h2>
<p>Trend filtering  is a
non-parametric regression technique for a sequence of output points <span class="math inline">\(y = (y_1,..., y_T)\)</span>
observed at locations <span class="math inline">\(x = (x_1, ..., x_T)\)</span>. It is usually assumed that <span class="math inline">\(x_1, ..., x_T\)</span> are evenly spaced points, though this can be relaxed. The trend
filtering estimate of order <span class="math inline">\(l\)</span> of the time series <span class="math inline">\(\mu_t = \mathbb{E}(y_t), t \in x\)</span> is
obtained by calculating <span class="math display">\[\hat{\mu} = \mathop{\mathrm{argmin}}_{\mu \in \mathbb{R}^T}
\frac{1}{2}\| \mu - y\|_2^2 + \lambda \| D^{(l+1)} \mu\|_1,\]</span> where <span class="math inline">\(\lambda\)</span> is
a tuning parameter and <span class="math inline">\(D^{(l+1)} \in \mathbb{R}^{T-l}\)</span> is the <span class="math inline">\((l+1)^\text{th}\)</span> order
discrete differencing matrix.</p>
<p>We first need to be able to construct the trend filtering “differencing matrix”
used for smoothing the mixture parameters over time. The general idea of the
trend filtering is explained masterfully in [Ryan’s paper, Section 6 and
equation (41)].</p>
<p>The differencing matrix is formed by recursion, starting with <span class="math inline">\(D^{(1)}\)</span>.</p>
<p><span class="math display">\[\begin{equation*}
    D^{(1)} = 
    \begin{bmatrix}
    -1 &amp; 1 &amp; 0 &amp; \cdots &amp; 0 &amp; 0 \\
    0 &amp; -1 &amp; 1 &amp; \cdots &amp; 0  &amp; 0\\
    \vdots &amp; &amp; &amp; &amp; \\
    0 &amp; 0 &amp; 0 &amp; \cdots &amp; -1 &amp; 1
    \end{bmatrix}.
\end{equation*}\]</span></p>
<p>For <span class="math inline">\(l&gt;1\)</span>, the differencing matrox <span class="math inline">\(D^{(l+1)}\)</span> is defined recursively as
<span class="math inline">\(D^{(l+1)} = D^{(1)} D^{(l)}\)</span>, starting with <span class="math inline">\(D^{(1)}\)</span>.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="building-the-modelalgorithm.html#cb23-1" aria-hidden="true"></a><span class="co">#' Generating Difference Matrix of Specified Order</span></span>
<span id="cb23-2"><a href="building-the-modelalgorithm.html#cb23-2" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb23-3"><a href="building-the-modelalgorithm.html#cb23-3" aria-hidden="true"></a><span class="co">#' @param n length of vector to be differenced</span></span>
<span id="cb23-4"><a href="building-the-modelalgorithm.html#cb23-4" aria-hidden="true"></a><span class="co">#' @param l order of differencing</span></span>
<span id="cb23-5"><a href="building-the-modelalgorithm.html#cb23-5" aria-hidden="true"></a><span class="co">#' @param x optional. Spacing of input points.</span></span>
<span id="cb23-6"><a href="building-the-modelalgorithm.html#cb23-6" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb23-7"><a href="building-the-modelalgorithm.html#cb23-7" aria-hidden="true"></a><span class="co">#' @return A n by n-l-1 matrix</span></span>
<span id="cb23-8"><a href="building-the-modelalgorithm.html#cb23-8" aria-hidden="true"></a><span class="co">#' @export</span></span>
<span id="cb23-9"><a href="building-the-modelalgorithm.html#cb23-9" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb23-10"><a href="building-the-modelalgorithm.html#cb23-10" aria-hidden="true"></a><span class="co">#' @examples</span></span>
<span id="cb23-11"><a href="building-the-modelalgorithm.html#cb23-11" aria-hidden="true"></a>gen_diff_mat &lt;-<span class="st"> </span><span class="cf">function</span>(n, l, <span class="dt">x =</span> <span class="ot">NULL</span>){</span>
<span id="cb23-12"><a href="building-the-modelalgorithm.html#cb23-12" aria-hidden="true"></a></span>
<span id="cb23-13"><a href="building-the-modelalgorithm.html#cb23-13" aria-hidden="true"></a>  <span class="co">## Basic check</span></span>
<span id="cb23-14"><a href="building-the-modelalgorithm.html#cb23-14" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(x))  <span class="kw">stopifnot</span>(<span class="kw">length</span>(x) <span class="op">==</span><span class="st"> </span>n) </span>
<span id="cb23-15"><a href="building-the-modelalgorithm.html#cb23-15" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="kw">is.unsorted</span>(x))  <span class="kw">stop</span>(<span class="st">"x must be in increasing order!"</span>) </span>
<span id="cb23-16"><a href="building-the-modelalgorithm.html#cb23-16" aria-hidden="true"></a></span>
<span id="cb23-17"><a href="building-the-modelalgorithm.html#cb23-17" aria-hidden="true"></a>  get_D1 &lt;-<span class="st"> </span><span class="cf">function</span>(t) {<span class="kw">do.call</span>(rbind, <span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>(t<span class="dv">-1</span>), <span class="dt">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb23-18"><a href="building-the-modelalgorithm.html#cb23-18" aria-hidden="true"></a>    v &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>, t)</span>
<span id="cb23-19"><a href="building-the-modelalgorithm.html#cb23-19" aria-hidden="true"></a>    v[x] &lt;-<span class="st"> </span><span class="dv">-1</span></span>
<span id="cb23-20"><a href="building-the-modelalgorithm.html#cb23-20" aria-hidden="true"></a>    v[x<span class="op">+</span><span class="dv">1</span>] &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb23-21"><a href="building-the-modelalgorithm.html#cb23-21" aria-hidden="true"></a>    v</span>
<span id="cb23-22"><a href="building-the-modelalgorithm.html#cb23-22" aria-hidden="true"></a>  }))}</span>
<span id="cb23-23"><a href="building-the-modelalgorithm.html#cb23-23" aria-hidden="true"></a></span>
<span id="cb23-24"><a href="building-the-modelalgorithm.html#cb23-24" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="kw">is.null</span>(x)){</span>
<span id="cb23-25"><a href="building-the-modelalgorithm.html#cb23-25" aria-hidden="true"></a>    <span class="cf">if</span>(l <span class="op">==</span><span class="st"> </span><span class="dv">0</span>){</span>
<span id="cb23-26"><a href="building-the-modelalgorithm.html#cb23-26" aria-hidden="true"></a>      <span class="kw">return</span>(<span class="kw">diag</span>(<span class="kw">rep</span>(<span class="dv">1</span>,n)))</span>
<span id="cb23-27"><a href="building-the-modelalgorithm.html#cb23-27" aria-hidden="true"></a>    }</span>
<span id="cb23-28"><a href="building-the-modelalgorithm.html#cb23-28" aria-hidden="true"></a>    <span class="cf">if</span>(l <span class="op">==</span><span class="st"> </span><span class="dv">1</span>){</span>
<span id="cb23-29"><a href="building-the-modelalgorithm.html#cb23-29" aria-hidden="true"></a>      <span class="kw">return</span>(<span class="kw">get_D1</span>(n))</span>
<span id="cb23-30"><a href="building-the-modelalgorithm.html#cb23-30" aria-hidden="true"></a>    }</span>
<span id="cb23-31"><a href="building-the-modelalgorithm.html#cb23-31" aria-hidden="true"></a>    <span class="cf">if</span>(l <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>){</span>
<span id="cb23-32"><a href="building-the-modelalgorithm.html#cb23-32" aria-hidden="true"></a>      D &lt;-<span class="st"> </span><span class="kw">get_D1</span>(n)</span>
<span id="cb23-33"><a href="building-the-modelalgorithm.html#cb23-33" aria-hidden="true"></a>      <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>(l<span class="dv">-1</span>)){</span>
<span id="cb23-34"><a href="building-the-modelalgorithm.html#cb23-34" aria-hidden="true"></a>        D &lt;-<span class="st"> </span><span class="kw">get_D1</span>(n<span class="op">-</span>k) <span class="op">%*%</span><span class="st"> </span>D</span>
<span id="cb23-35"><a href="building-the-modelalgorithm.html#cb23-35" aria-hidden="true"></a>      }</span>
<span id="cb23-36"><a href="building-the-modelalgorithm.html#cb23-36" aria-hidden="true"></a>      <span class="kw">return</span>(D)</span>
<span id="cb23-37"><a href="building-the-modelalgorithm.html#cb23-37" aria-hidden="true"></a>    }</span>
<span id="cb23-38"><a href="building-the-modelalgorithm.html#cb23-38" aria-hidden="true"></a>  }</span>
<span id="cb23-39"><a href="building-the-modelalgorithm.html#cb23-39" aria-hidden="true"></a>  <span class="cf">else</span>{</span>
<span id="cb23-40"><a href="building-the-modelalgorithm.html#cb23-40" aria-hidden="true"></a>    <span class="cf">if</span>(l <span class="op">==</span><span class="st"> </span><span class="dv">0</span>){</span>
<span id="cb23-41"><a href="building-the-modelalgorithm.html#cb23-41" aria-hidden="true"></a>      <span class="kw">return</span>(<span class="kw">diag</span>(<span class="kw">rep</span>(<span class="dv">1</span>,n)))</span>
<span id="cb23-42"><a href="building-the-modelalgorithm.html#cb23-42" aria-hidden="true"></a>    }</span>
<span id="cb23-43"><a href="building-the-modelalgorithm.html#cb23-43" aria-hidden="true"></a>    <span class="cf">if</span>(l <span class="op">==</span><span class="st"> </span><span class="dv">1</span>){</span>
<span id="cb23-44"><a href="building-the-modelalgorithm.html#cb23-44" aria-hidden="true"></a>      <span class="kw">return</span>(<span class="kw">get_D1</span>(n))</span>
<span id="cb23-45"><a href="building-the-modelalgorithm.html#cb23-45" aria-hidden="true"></a>    }</span>
<span id="cb23-46"><a href="building-the-modelalgorithm.html#cb23-46" aria-hidden="true"></a>    <span class="cf">if</span>(l <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>){</span>
<span id="cb23-47"><a href="building-the-modelalgorithm.html#cb23-47" aria-hidden="true"></a></span>
<span id="cb23-48"><a href="building-the-modelalgorithm.html#cb23-48" aria-hidden="true"></a>      D &lt;-<span class="st"> </span><span class="kw">get_D1</span>(n)</span>
<span id="cb23-49"><a href="building-the-modelalgorithm.html#cb23-49" aria-hidden="true"></a>      <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>(l<span class="dv">-1</span>)){</span>
<span id="cb23-50"><a href="building-the-modelalgorithm.html#cb23-50" aria-hidden="true"></a>        D1 =<span class="st"> </span><span class="kw">get_D1</span>(n<span class="op">-</span>k)</span>
<span id="cb23-51"><a href="building-the-modelalgorithm.html#cb23-51" aria-hidden="true"></a>        facmat =<span class="st"> </span><span class="kw">diag</span>(k <span class="op">/</span><span class="st"> </span><span class="kw">diff</span>(x, <span class="dt">lag =</span> k))</span>
<span id="cb23-52"><a href="building-the-modelalgorithm.html#cb23-52" aria-hidden="true"></a>        D &lt;-<span class="st"> </span>D1 <span class="op">%*%</span><span class="st"> </span>facmat <span class="op">%*%</span><span class="st"> </span>D</span>
<span id="cb23-53"><a href="building-the-modelalgorithm.html#cb23-53" aria-hidden="true"></a>      }</span>
<span id="cb23-54"><a href="building-the-modelalgorithm.html#cb23-54" aria-hidden="true"></a>      <span class="kw">return</span>(D)</span>
<span id="cb23-55"><a href="building-the-modelalgorithm.html#cb23-55" aria-hidden="true"></a>    }</span>
<span id="cb23-56"><a href="building-the-modelalgorithm.html#cb23-56" aria-hidden="true"></a>  }</span>
<span id="cb23-57"><a href="building-the-modelalgorithm.html#cb23-57" aria-hidden="true"></a>}</span></code></pre></div>
<p>For equally spaced inputs with <span class="math inline">\(l=1\)</span> and <span class="math inline">\(l=2\)</span>:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="building-the-modelalgorithm.html#cb24-1" aria-hidden="true"></a>l =<span class="st"> </span><span class="dv">1</span></span>
<span id="cb24-2"><a href="building-the-modelalgorithm.html#cb24-2" aria-hidden="true"></a>Dl =<span class="st"> </span><span class="kw">gen_diff_mat</span>(<span class="dt">n =</span> <span class="dv">10</span>, <span class="dt">l =</span> l<span class="op">+</span><span class="dv">1</span>, <span class="dt">x =</span> <span class="ot">NULL</span>)</span>
<span id="cb24-3"><a href="building-the-modelalgorithm.html#cb24-3" aria-hidden="true"></a><span class="kw">print</span>(Dl)</span>
<span id="cb24-4"><a href="building-the-modelalgorithm.html#cb24-4" aria-hidden="true"></a></span>
<span id="cb24-5"><a href="building-the-modelalgorithm.html#cb24-5" aria-hidden="true"></a>l =<span class="st"> </span><span class="dv">2</span></span>
<span id="cb24-6"><a href="building-the-modelalgorithm.html#cb24-6" aria-hidden="true"></a>Dl =<span class="st"> </span><span class="kw">gen_diff_mat</span>(<span class="dt">n =</span> <span class="dv">10</span>, <span class="dt">l =</span> l<span class="op">+</span><span class="dv">1</span>, <span class="dt">x =</span> <span class="ot">NULL</span>)</span>
<span id="cb24-7"><a href="building-the-modelalgorithm.html#cb24-7" aria-hidden="true"></a><span class="kw">print</span>(Dl)</span></code></pre></div>
<p>When the inputs have a gap in it:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="building-the-modelalgorithm.html#cb25-1" aria-hidden="true"></a><span class="co">## See what a l=2 difference matrix looks like:</span></span>
<span id="cb25-2"><a href="building-the-modelalgorithm.html#cb25-2" aria-hidden="true"></a>x =<span class="st"> </span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)[<span class="op">-</span>(<span class="dv">3</span>)]</span>
<span id="cb25-3"><a href="building-the-modelalgorithm.html#cb25-3" aria-hidden="true"></a>l =<span class="st"> </span><span class="dv">2</span></span>
<span id="cb25-4"><a href="building-the-modelalgorithm.html#cb25-4" aria-hidden="true"></a>TT =<span class="st"> </span><span class="kw">length</span>(x)</span>
<span id="cb25-5"><a href="building-the-modelalgorithm.html#cb25-5" aria-hidden="true"></a>Dl =<span class="st"> </span><span class="kw">gen_diff_mat</span>(<span class="dt">n =</span> TT, <span class="dt">l =</span> l<span class="op">+</span><span class="dv">1</span>, <span class="dt">x =</span> x)</span>
<span id="cb25-6"><a href="building-the-modelalgorithm.html#cb25-6" aria-hidden="true"></a><span class="kw">print</span>(Dl)</span>
<span id="cb25-7"><a href="building-the-modelalgorithm.html#cb25-7" aria-hidden="true"></a></span>
<span id="cb25-8"><a href="building-the-modelalgorithm.html#cb25-8" aria-hidden="true"></a><span class="co">## Formally test it</span></span>
<span id="cb25-9"><a href="building-the-modelalgorithm.html#cb25-9" aria-hidden="true"></a>d1 =<span class="st"> </span><span class="kw">gen_diff_mat</span>(<span class="dt">n =</span> <span class="dv">10</span>, <span class="dt">l =</span> l<span class="op">+</span><span class="dv">1</span>, <span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</span>
<span id="cb25-10"><a href="building-the-modelalgorithm.html#cb25-10" aria-hidden="true"></a>d2 =<span class="st"> </span><span class="kw">gen_diff_mat</span>(<span class="dt">n =</span> <span class="dv">10</span>, <span class="dt">l =</span> l<span class="op">+</span><span class="dv">1</span>, <span class="dt">x =</span> (<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)<span class="op">*</span><span class="dv">2</span>)</span>
<span id="cb25-11"><a href="building-the-modelalgorithm.html#cb25-11" aria-hidden="true"></a><span class="kw">print</span>(d1)</span>
<span id="cb25-12"><a href="building-the-modelalgorithm.html#cb25-12" aria-hidden="true"></a><span class="kw">print</span>(d2)</span>
<span id="cb25-13"><a href="building-the-modelalgorithm.html#cb25-13" aria-hidden="true"></a>d1_d2_ratio =<span class="st"> </span><span class="kw">as.numeric</span>(d1<span class="op">/</span>d2)  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">na.omit</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.numeric</span>()</span>
<span id="cb25-14"><a href="building-the-modelalgorithm.html#cb25-14" aria-hidden="true"></a>testthat<span class="op">::</span><span class="kw">expect_true</span>(<span class="kw">all</span>(d1_d2_ratio<span class="op">==</span>d1_d2_ratio[<span class="dv">1</span>])) <span class="co">## correct</span></span></code></pre></div>
<p>A formal test for unevenly spaced inputs will come soon, once we’ve defined
<code>gen_tf_mat</code>, next.</p>
<p>We now build a function to build a lasso regressor matrix <span class="math inline">\(H\)</span> that can be used
to solve an equivalent problem as the trend filtering of the l’th degree.</p>
<p>(This is stated in Lemma 4, equation (25) from Tibshirani (2014))</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="building-the-modelalgorithm.html#cb26-1" aria-hidden="true"></a><span class="co">#' A lasso regressor matrix H that can be used to solve an equivalent problem as the trend filtering of the \code{k}'th degree.</span></span>
<span id="cb26-2"><a href="building-the-modelalgorithm.html#cb26-2" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb26-3"><a href="building-the-modelalgorithm.html#cb26-3" aria-hidden="true"></a><span class="co">#' @param n Total number of time points.</span></span>
<span id="cb26-4"><a href="building-the-modelalgorithm.html#cb26-4" aria-hidden="true"></a><span class="co">#' @param k Degree of trend filtering for cluster probabilities. $k=0$ is fused lasso, $k=1$ is linear trend filtering, and so on.</span></span>
<span id="cb26-5"><a href="building-the-modelalgorithm.html#cb26-5" aria-hidden="true"></a><span class="co">#' @param x Time points</span></span>
<span id="cb26-6"><a href="building-the-modelalgorithm.html#cb26-6" aria-hidden="true"></a><span class="co">#' </span></span>
<span id="cb26-7"><a href="building-the-modelalgorithm.html#cb26-7" aria-hidden="true"></a><span class="co">#' @return $n$ by $n$ matrix.</span></span>
<span id="cb26-8"><a href="building-the-modelalgorithm.html#cb26-8" aria-hidden="true"></a><span class="co">#' </span></span>
<span id="cb26-9"><a href="building-the-modelalgorithm.html#cb26-9" aria-hidden="true"></a><span class="co">#' @export</span></span>
<span id="cb26-10"><a href="building-the-modelalgorithm.html#cb26-10" aria-hidden="true"></a>gen_tf_mat &lt;-<span class="st"> </span><span class="cf">function</span>(n, k, <span class="dt">x =</span> <span class="ot">NULL</span>){</span>
<span id="cb26-11"><a href="building-the-modelalgorithm.html#cb26-11" aria-hidden="true"></a></span>
<span id="cb26-12"><a href="building-the-modelalgorithm.html#cb26-12" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="kw">is.null</span>(x) ){</span>
<span id="cb26-13"><a href="building-the-modelalgorithm.html#cb26-13" aria-hidden="true"></a>    x =<span class="st"> </span>(<span class="dv">1</span><span class="op">:</span>n)<span class="op">/</span>n</span>
<span id="cb26-14"><a href="building-the-modelalgorithm.html#cb26-14" aria-hidden="true"></a>  }</span>
<span id="cb26-15"><a href="building-the-modelalgorithm.html#cb26-15" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(x)){</span>
<span id="cb26-16"><a href="building-the-modelalgorithm.html#cb26-16" aria-hidden="true"></a>    <span class="kw">stopifnot</span>(<span class="kw">length</span>(x) <span class="op">==</span><span class="st"> </span>n)</span>
<span id="cb26-17"><a href="building-the-modelalgorithm.html#cb26-17" aria-hidden="true"></a>  }</span>
<span id="cb26-18"><a href="building-the-modelalgorithm.html#cb26-18" aria-hidden="true"></a></span>
<span id="cb26-19"><a href="building-the-modelalgorithm.html#cb26-19" aria-hidden="true"></a>  <span class="co">## For every i,j'th entry, use this helper function (from eq 25 of Tibshirani</span></span>
<span id="cb26-20"><a href="building-the-modelalgorithm.html#cb26-20" aria-hidden="true"></a>  <span class="co">## (2014)).</span></span>
<span id="cb26-21"><a href="building-the-modelalgorithm.html#cb26-21" aria-hidden="true"></a>  gen_ij &lt;-<span class="st"> </span><span class="cf">function</span>(x, i, j, k){</span>
<span id="cb26-22"><a href="building-the-modelalgorithm.html#cb26-22" aria-hidden="true"></a>    xi &lt;-<span class="st"> </span>x[i]</span>
<span id="cb26-23"><a href="building-the-modelalgorithm.html#cb26-23" aria-hidden="true"></a>    <span class="cf">if</span>(j <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>(k<span class="op">+</span><span class="dv">1</span>)){</span>
<span id="cb26-24"><a href="building-the-modelalgorithm.html#cb26-24" aria-hidden="true"></a>      <span class="kw">return</span>(xi<span class="op">^</span>(j<span class="dv">-1</span>))</span>
<span id="cb26-25"><a href="building-the-modelalgorithm.html#cb26-25" aria-hidden="true"></a>    }</span>
<span id="cb26-26"><a href="building-the-modelalgorithm.html#cb26-26" aria-hidden="true"></a>    <span class="cf">if</span>(j <span class="op">%in%</span><span class="st"> </span>(k<span class="op">+</span><span class="dv">2</span>)<span class="op">:</span>n){</span>
<span id="cb26-27"><a href="building-the-modelalgorithm.html#cb26-27" aria-hidden="true"></a></span>
<span id="cb26-28"><a href="building-the-modelalgorithm.html#cb26-28" aria-hidden="true"></a>      <span class="co">## Special handling for k==0, See lemma 4 eq 25</span></span>
<span id="cb26-29"><a href="building-the-modelalgorithm.html#cb26-29" aria-hidden="true"></a>      <span class="cf">if</span>(k <span class="op">==</span><span class="st"> </span><span class="dv">0</span>){</span>
<span id="cb26-30"><a href="building-the-modelalgorithm.html#cb26-30" aria-hidden="true"></a>        prd =<span class="st"> </span><span class="dv">1</span> </span>
<span id="cb26-31"><a href="building-the-modelalgorithm.html#cb26-31" aria-hidden="true"></a>        ind =<span class="st"> </span>j</span>
<span id="cb26-32"><a href="building-the-modelalgorithm.html#cb26-32" aria-hidden="true"></a>      }</span>
<span id="cb26-33"><a href="building-the-modelalgorithm.html#cb26-33" aria-hidden="true"></a>      <span class="cf">if</span>(k <span class="op">&gt;=</span><span class="st"> </span><span class="dv">1</span>){</span>
<span id="cb26-34"><a href="building-the-modelalgorithm.html#cb26-34" aria-hidden="true"></a>        ind =<span class="st"> </span>j <span class="op">-</span><span class="st"> </span>(<span class="dv">1</span><span class="op">:</span>k)</span>
<span id="cb26-35"><a href="building-the-modelalgorithm.html#cb26-35" aria-hidden="true"></a>        prd =<span class="st"> </span><span class="kw">prod</span>(xi <span class="op">-</span><span class="st"> </span>x[ind]) </span>
<span id="cb26-36"><a href="building-the-modelalgorithm.html#cb26-36" aria-hidden="true"></a></span>
<span id="cb26-37"><a href="building-the-modelalgorithm.html#cb26-37" aria-hidden="true"></a>      }</span>
<span id="cb26-38"><a href="building-the-modelalgorithm.html#cb26-38" aria-hidden="true"></a>      <span class="kw">return</span>(prd <span class="op">*</span><span class="st"> </span><span class="kw">ifelse</span>(xi <span class="op">&gt;=</span><span class="st"> </span>x[<span class="kw">max</span>(ind)], <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb26-39"><a href="building-the-modelalgorithm.html#cb26-39" aria-hidden="true"></a>      <span class="co">## if(k &gt;= 1) prd = prod(xi - x[(j-k):(j-1)]) </span></span>
<span id="cb26-40"><a href="building-the-modelalgorithm.html#cb26-40" aria-hidden="true"></a>      <span class="co">## return(prd * ifelse(xi &gt;= x[(j-1)], 1, 0)) </span></span>
<span id="cb26-41"><a href="building-the-modelalgorithm.html#cb26-41" aria-hidden="true"></a>    }</span>
<span id="cb26-42"><a href="building-the-modelalgorithm.html#cb26-42" aria-hidden="true"></a>  }</span>
<span id="cb26-43"><a href="building-the-modelalgorithm.html#cb26-43" aria-hidden="true"></a></span>
<span id="cb26-44"><a href="building-the-modelalgorithm.html#cb26-44" aria-hidden="true"></a>  <span class="co">## Generate the H matrix, entry-wise.</span></span>
<span id="cb26-45"><a href="building-the-modelalgorithm.html#cb26-45" aria-hidden="true"></a>  H &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dt">nrow =</span> n, <span class="dt">ncol =</span> n)</span>
<span id="cb26-46"><a href="building-the-modelalgorithm.html#cb26-46" aria-hidden="true"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n){</span>
<span id="cb26-47"><a href="building-the-modelalgorithm.html#cb26-47" aria-hidden="true"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n){</span>
<span id="cb26-48"><a href="building-the-modelalgorithm.html#cb26-48" aria-hidden="true"></a>      H[i,j] &lt;-<span class="st"> </span><span class="kw">gen_ij</span>(x, i,j, k)</span>
<span id="cb26-49"><a href="building-the-modelalgorithm.html#cb26-49" aria-hidden="true"></a>    }</span>
<span id="cb26-50"><a href="building-the-modelalgorithm.html#cb26-50" aria-hidden="true"></a>  }</span>
<span id="cb26-51"><a href="building-the-modelalgorithm.html#cb26-51" aria-hidden="true"></a>  <span class="kw">return</span>(H)</span>
<span id="cb26-52"><a href="building-the-modelalgorithm.html#cb26-52" aria-hidden="true"></a>}</span></code></pre></div>
<p>Here’s a simple test of <code>gen_tf_mat()</code>, against an alternative function built
for equally spaced data.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="building-the-modelalgorithm.html#cb27-1" aria-hidden="true"></a><span class="co">#' Creates trendfiltering regression matrix using Lemma 2 of Ryan Tibshirani's</span></span>
<span id="cb27-2"><a href="building-the-modelalgorithm.html#cb27-2" aria-hidden="true"></a><span class="co">#' trendfilter paper (2014); works on equally spaced data only.</span></span>
<span id="cb27-3"><a href="building-the-modelalgorithm.html#cb27-3" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb27-4"><a href="building-the-modelalgorithm.html#cb27-4" aria-hidden="true"></a><span class="co">#' @param n Number of data points</span></span>
<span id="cb27-5"><a href="building-the-modelalgorithm.html#cb27-5" aria-hidden="true"></a><span class="co">#' @param k Order of trend filter. 0 is fused lasso, and so on.</span></span>
<span id="cb27-6"><a href="building-the-modelalgorithm.html#cb27-6" aria-hidden="true"></a><span class="co">#' @examples </span></span>
<span id="cb27-7"><a href="building-the-modelalgorithm.html#cb27-7" aria-hidden="true"></a><span class="co">#' ord = 1</span></span>
<span id="cb27-8"><a href="building-the-modelalgorithm.html#cb27-8" aria-hidden="true"></a><span class="co">#' H_tf &lt;- gen_tf_mat_equalspace(n = 100, k = ord)</span></span>
<span id="cb27-9"><a href="building-the-modelalgorithm.html#cb27-9" aria-hidden="true"></a><span class="co">#' H_tf[,1] * 100</span></span>
<span id="cb27-10"><a href="building-the-modelalgorithm.html#cb27-10" aria-hidden="true"></a><span class="co">#' H_tf[,2] * 100</span></span>
<span id="cb27-11"><a href="building-the-modelalgorithm.html#cb27-11" aria-hidden="true"></a><span class="co">#' H_tf[,3] * 100</span></span>
<span id="cb27-12"><a href="building-the-modelalgorithm.html#cb27-12" aria-hidden="true"></a><span class="co">#' H_tf[,4] * 100</span></span>
<span id="cb27-13"><a href="building-the-modelalgorithm.html#cb27-13" aria-hidden="true"></a><span class="co">#' H_tf[,99] * 100</span></span>
<span id="cb27-14"><a href="building-the-modelalgorithm.html#cb27-14" aria-hidden="true"></a><span class="co">#' H_tf[,100] * 100</span></span>
<span id="cb27-15"><a href="building-the-modelalgorithm.html#cb27-15" aria-hidden="true"></a><span class="co">#' @return n by n matrix.</span></span>
<span id="cb27-16"><a href="building-the-modelalgorithm.html#cb27-16" aria-hidden="true"></a>gen_tf_mat_equalspace &lt;-<span class="st"> </span><span class="cf">function</span>(n, k){</span>
<span id="cb27-17"><a href="building-the-modelalgorithm.html#cb27-17" aria-hidden="true"></a>  nn =<span class="st"> </span>n</span>
<span id="cb27-18"><a href="building-the-modelalgorithm.html#cb27-18" aria-hidden="true"></a>  kk =<span class="st"> </span>k</span>
<span id="cb27-19"><a href="building-the-modelalgorithm.html#cb27-19" aria-hidden="true"></a>  <span class="co">##' Connects kk to kk-1.</span></span>
<span id="cb27-20"><a href="building-the-modelalgorithm.html#cb27-20" aria-hidden="true"></a>  sigm &lt;-<span class="st"> </span><span class="cf">function</span>(ii, kk){</span>
<span id="cb27-21"><a href="building-the-modelalgorithm.html#cb27-21" aria-hidden="true"></a>    <span class="cf">if</span>(kk <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) <span class="kw">return</span>(<span class="kw">rep</span>(<span class="dv">1</span>, ii))</span>
<span id="cb27-22"><a href="building-the-modelalgorithm.html#cb27-22" aria-hidden="true"></a>    <span class="kw">cumsum</span>(<span class="kw">sigm</span>(ii, kk<span class="dv">-1</span>))</span>
<span id="cb27-23"><a href="building-the-modelalgorithm.html#cb27-23" aria-hidden="true"></a>  }</span>
<span id="cb27-24"><a href="building-the-modelalgorithm.html#cb27-24" aria-hidden="true"></a></span>
<span id="cb27-25"><a href="building-the-modelalgorithm.html#cb27-25" aria-hidden="true"></a>  mat =<span class="st"> </span><span class="kw">matrix</span>(<span class="ot">NA</span>, <span class="dt">ncol =</span> nn, <span class="dt">nrow =</span> nn)</span>
<span id="cb27-26"><a href="building-the-modelalgorithm.html#cb27-26" aria-hidden="true"></a>  <span class="cf">for</span>(ii <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>nn){</span>
<span id="cb27-27"><a href="building-the-modelalgorithm.html#cb27-27" aria-hidden="true"></a>    <span class="cf">for</span>(jj <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>nn){</span>
<span id="cb27-28"><a href="building-the-modelalgorithm.html#cb27-28" aria-hidden="true"></a>      <span class="cf">if</span>(jj <span class="op">&lt;=</span><span class="st"> </span>kk<span class="op">+</span><span class="dv">1</span>) mat[ii,jj] =<span class="st"> </span>ii<span class="op">^</span>(jj<span class="dv">-1</span>) <span class="op">/</span><span class="st"> </span>nn<span class="op">^</span>(jj<span class="dv">-1</span>)</span>
<span id="cb27-29"><a href="building-the-modelalgorithm.html#cb27-29" aria-hidden="true"></a>      <span class="cf">if</span>(ii <span class="op">&lt;=</span><span class="st"> </span>jj<span class="dv">-1</span> <span class="op">&amp;</span><span class="st"> </span>jj <span class="op">&gt;=</span><span class="st"> </span>kk<span class="op">+</span><span class="dv">2</span>) mat[ii, jj] =<span class="st"> </span><span class="dv">0</span></span>
<span id="cb27-30"><a href="building-the-modelalgorithm.html#cb27-30" aria-hidden="true"></a>      <span class="cf">if</span>(ii <span class="op">&gt;</span><span class="st"> </span>jj<span class="dv">-1</span> <span class="op">&amp;</span><span class="st"> </span>jj <span class="op">&gt;=</span><span class="st"> </span>kk<span class="op">+</span><span class="dv">2</span>){</span>
<span id="cb27-31"><a href="building-the-modelalgorithm.html#cb27-31" aria-hidden="true"></a>        mat[ii, jj] =<span class="st"> </span>(<span class="kw">sigm</span>(ii<span class="op">-</span>jj<span class="op">+</span><span class="dv">1</span>, kk) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">tail</span>(<span class="dv">1</span>)) <span class="op">*</span><span class="st"> </span><span class="kw">factorial</span>(kk) <span class="op">/</span><span class="st"> </span>nn<span class="op">^</span>kk</span>
<span id="cb27-32"><a href="building-the-modelalgorithm.html#cb27-32" aria-hidden="true"></a>      }</span>
<span id="cb27-33"><a href="building-the-modelalgorithm.html#cb27-33" aria-hidden="true"></a>    }</span>
<span id="cb27-34"><a href="building-the-modelalgorithm.html#cb27-34" aria-hidden="true"></a>  }</span>
<span id="cb27-35"><a href="building-the-modelalgorithm.html#cb27-35" aria-hidden="true"></a>  <span class="kw">return</span>(mat)</span>
<span id="cb27-36"><a href="building-the-modelalgorithm.html#cb27-36" aria-hidden="true"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="building-the-modelalgorithm.html#cb28-1" aria-hidden="true"></a>testthat<span class="op">::</span><span class="kw">test_that</span>(<span class="st">"Trend filtering regression matrix is created correctly on equally spaced data."</span>,</span>
<span id="cb28-2"><a href="building-the-modelalgorithm.html#cb28-2" aria-hidden="true"></a>{</span>
<span id="cb28-3"><a href="building-the-modelalgorithm.html#cb28-3" aria-hidden="true"></a>  <span class="co">## Check that equally spaced data creates same trendfilter regression matrix</span></span>
<span id="cb28-4"><a href="building-the-modelalgorithm.html#cb28-4" aria-hidden="true"></a>  <span class="co">## Degree 1</span></span>
<span id="cb28-5"><a href="building-the-modelalgorithm.html#cb28-5" aria-hidden="true"></a>  H1 &lt;-<span class="st"> </span><span class="kw">gen_tf_mat</span>(<span class="dv">10</span>, <span class="dv">1</span>)</span>
<span id="cb28-6"><a href="building-the-modelalgorithm.html#cb28-6" aria-hidden="true"></a>  H1_other &lt;-<span class="st"> </span><span class="kw">gen_tf_mat</span>(<span class="dv">10</span>, <span class="dv">1</span>, <span class="dt">x=</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)<span class="op">/</span><span class="dv">10</span>)</span>
<span id="cb28-7"><a href="building-the-modelalgorithm.html#cb28-7" aria-hidden="true"></a>  testthat<span class="op">::</span><span class="kw">expect_equal</span>(H1, H1_other)</span>
<span id="cb28-8"><a href="building-the-modelalgorithm.html#cb28-8" aria-hidden="true"></a></span>
<span id="cb28-9"><a href="building-the-modelalgorithm.html#cb28-9" aria-hidden="true"></a>  <span class="co">## Degree 1</span></span>
<span id="cb28-10"><a href="building-the-modelalgorithm.html#cb28-10" aria-hidden="true"></a>  H2 &lt;-<span class="st"> </span><span class="kw">gen_tf_mat</span>(<span class="dv">10</span>, <span class="dv">2</span>)</span>
<span id="cb28-11"><a href="building-the-modelalgorithm.html#cb28-11" aria-hidden="true"></a>  H2_other &lt;-<span class="st"> </span><span class="kw">gen_tf_mat</span>(<span class="dv">10</span>, <span class="dv">2</span>, <span class="dt">x=</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)<span class="op">/</span><span class="dv">10</span>)</span>
<span id="cb28-12"><a href="building-the-modelalgorithm.html#cb28-12" aria-hidden="true"></a>  testthat<span class="op">::</span><span class="kw">expect_equal</span>(H2, H2_other)</span>
<span id="cb28-13"><a href="building-the-modelalgorithm.html#cb28-13" aria-hidden="true"></a>  </span>
<span id="cb28-14"><a href="building-the-modelalgorithm.html#cb28-14" aria-hidden="true"></a>  <span class="co">## Check the dimension</span></span>
<span id="cb28-15"><a href="building-the-modelalgorithm.html#cb28-15" aria-hidden="true"></a>  testthat<span class="op">::</span><span class="kw">expect_equal</span>(<span class="kw">dim</span>(H1), <span class="kw">c</span>(<span class="dv">10</span>,<span class="dv">10</span>))</span>
<span id="cb28-16"><a href="building-the-modelalgorithm.html#cb28-16" aria-hidden="true"></a>  </span>
<span id="cb28-17"><a href="building-the-modelalgorithm.html#cb28-17" aria-hidden="true"></a>  <span class="co">## Check against an alternative function.</span></span>
<span id="cb28-18"><a href="building-the-modelalgorithm.html#cb28-18" aria-hidden="true"></a>  <span class="cf">for</span>(ord <span class="cf">in</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>)){</span>
<span id="cb28-19"><a href="building-the-modelalgorithm.html#cb28-19" aria-hidden="true"></a>    H &lt;-<span class="st"> </span><span class="kw">gen_tf_mat</span>(<span class="dv">10</span>, ord)</span>
<span id="cb28-20"><a href="building-the-modelalgorithm.html#cb28-20" aria-hidden="true"></a>    H_eq =<span class="st"> </span><span class="kw">gen_tf_mat_equalspace</span>(<span class="dv">10</span>, ord)</span>
<span id="cb28-21"><a href="building-the-modelalgorithm.html#cb28-21" aria-hidden="true"></a>    testthat<span class="op">::</span><span class="kw">expect_true</span>(<span class="kw">max</span>(<span class="kw">abs</span>(H_eq<span class="op">-</span><span class="st"> </span>H)) <span class="op">&lt;</span><span class="st"> </span><span class="fl">1E-10</span>)</span>
<span id="cb28-22"><a href="building-the-modelalgorithm.html#cb28-22" aria-hidden="true"></a>  }</span>
<span id="cb28-23"><a href="building-the-modelalgorithm.html#cb28-23" aria-hidden="true"></a>})</span></code></pre></div>
<p>Finally, let’s test the difference matrix <span class="math inline">\(D\)</span> formed using unevenly spaced <span class="math inline">\(x\)</span>’s.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="building-the-modelalgorithm.html#cb29-1" aria-hidden="true"></a>testthat<span class="op">::</span><span class="kw">test_that</span>(<span class="st">"Uneven spaced D matrix is formed correctly"</span>, {</span>
<span id="cb29-2"><a href="building-the-modelalgorithm.html#cb29-2" aria-hidden="true"></a></span>
<span id="cb29-3"><a href="building-the-modelalgorithm.html#cb29-3" aria-hidden="true"></a>  x =<span class="st"> </span>(<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>)[<span class="op">-</span>(<span class="dv">2</span>)]</span>
<span id="cb29-4"><a href="building-the-modelalgorithm.html#cb29-4" aria-hidden="true"></a>  <span class="co">## k = 0 is piecewise constant, k=1 is piecewise linear, etc.</span></span>
<span id="cb29-5"><a href="building-the-modelalgorithm.html#cb29-5" aria-hidden="true"></a>  <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">0</span><span class="op">:</span><span class="dv">3</span>){</span>
<span id="cb29-6"><a href="building-the-modelalgorithm.html#cb29-6" aria-hidden="true"></a></span>
<span id="cb29-7"><a href="building-the-modelalgorithm.html#cb29-7" aria-hidden="true"></a>    l =<span class="st"> </span>k<span class="op">+</span><span class="dv">1</span></span>
<span id="cb29-8"><a href="building-the-modelalgorithm.html#cb29-8" aria-hidden="true"></a></span>
<span id="cb29-9"><a href="building-the-modelalgorithm.html#cb29-9" aria-hidden="true"></a>    <span class="co">## Form Dl using our function</span></span>
<span id="cb29-10"><a href="building-the-modelalgorithm.html#cb29-10" aria-hidden="true"></a>    Dl &lt;-<span class="st"> </span>flowtrend<span class="op">::</span><span class="kw">gen_diff_mat</span>(<span class="dt">n=</span><span class="dv">5</span>, <span class="dt">l =</span> l, <span class="dt">x=</span>x)</span>
<span id="cb29-11"><a href="building-the-modelalgorithm.html#cb29-11" aria-hidden="true"></a>    </span>
<span id="cb29-12"><a href="building-the-modelalgorithm.html#cb29-12" aria-hidden="true"></a>    <span class="co">## Compare it to rows of H matrix, per section 6 of Tibshirani et al. 2014</span></span>
<span id="cb29-13"><a href="building-the-modelalgorithm.html#cb29-13" aria-hidden="true"></a>    <span class="kw">gen_tf_mat</span>(<span class="dt">n =</span> <span class="kw">length</span>(x), <span class="dt">k =</span> k, <span class="dt">x =</span> x) <span class="op">%&gt;%</span></span>
<span id="cb29-14"><a href="building-the-modelalgorithm.html#cb29-14" aria-hidden="true"></a><span class="st">      </span><span class="kw">solve</span>() <span class="op">%&gt;%</span></span>
<span id="cb29-15"><a href="building-the-modelalgorithm.html#cb29-15" aria-hidden="true"></a><span class="st">      `</span><span class="dt">*</span><span class="st">`</span>(<span class="kw">factorial</span>(k)) <span class="op">%&gt;%</span><span class="st"> </span><span class="co">## This part is missing in Tibshirani et al. 2014</span></span>
<span id="cb29-16"><a href="building-the-modelalgorithm.html#cb29-16" aria-hidden="true"></a><span class="st">      </span><span class="kw">tail</span>(<span class="kw">length</span>(x)<span class="op">-</span>(k<span class="op">+</span><span class="dv">1</span>)) -&gt;<span class="st"> </span>Hx </span>
<span id="cb29-17"><a href="building-the-modelalgorithm.html#cb29-17" aria-hidden="true"></a>    ratiomat =<span class="st"> </span>Hx<span class="op">/</span>Dl</span>
<span id="cb29-18"><a href="building-the-modelalgorithm.html#cb29-18" aria-hidden="true"></a></span>
<span id="cb29-19"><a href="building-the-modelalgorithm.html#cb29-19" aria-hidden="true"></a>    <span class="co">## Process the ratios of each entry, and check that they're equal to 1</span></span>
<span id="cb29-20"><a href="building-the-modelalgorithm.html#cb29-20" aria-hidden="true"></a>    ratios =<span class="st"> </span>ratiomat[<span class="op">!</span><span class="kw">is.nan</span>(ratiomat)]</span>
<span id="cb29-21"><a href="building-the-modelalgorithm.html#cb29-21" aria-hidden="true"></a>    ratios =<span class="st"> </span>ratios[<span class="kw">is.finite</span>(ratios)]</span>
<span id="cb29-22"><a href="building-the-modelalgorithm.html#cb29-22" aria-hidden="true"></a>    testthat<span class="op">::</span><span class="kw">expect_true</span>(<span class="kw">all.equal</span>(ratios, <span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">length</span>(ratios)))) </span>
<span id="cb29-23"><a href="building-the-modelalgorithm.html#cb29-23" aria-hidden="true"></a>  }</span>
<span id="cb29-24"><a href="building-the-modelalgorithm.html#cb29-24" aria-hidden="true"></a>})</span></code></pre></div>
</div>
<div id="objective-data-log-likelihood" class="section level2 hasAnchor" number="3.2">
<h2>
<span class="header-section-number">3.2</span> Objective (data log-likelihood)<a href="building-the-modelalgorithm.html#objective-data-log-likelihood" class="anchor-section" aria-label="Anchor link to header"></a>
</h2>
<p>The function <code>loglik_tt()</code> calculates the log-likelihood of one cytogram, which is:</p>
<p><span class="math display">\[\sum_{i=1}^{n_t} C_i^{(t)} \log\left( \sum_{k=1}^K \pi_{itk} \phi(y_i^{(t)};
\mu_{kt}, \Sigma_k) \right). \]</span></p>
<p>This is the portion of the <em>objective</em> function of the flowtrend model.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="building-the-modelalgorithm.html#cb30-1" aria-hidden="true"></a><span class="co">#' Log likelihood for a single time point's data.</span></span>
<span id="cb30-2"><a href="building-the-modelalgorithm.html#cb30-2" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb30-3"><a href="building-the-modelalgorithm.html#cb30-3" aria-hidden="true"></a><span class="co">#' @param mu Cluster means.</span></span>
<span id="cb30-4"><a href="building-the-modelalgorithm.html#cb30-4" aria-hidden="true"></a><span class="co">#' @param prob Cluster probabilities.</span></span>
<span id="cb30-5"><a href="building-the-modelalgorithm.html#cb30-5" aria-hidden="true"></a><span class="co">#' @param prob Cluster variances.</span></span>
<span id="cb30-6"><a href="building-the-modelalgorithm.html#cb30-6" aria-hidden="true"></a><span class="co">#' @param ylist Data.</span></span>
<span id="cb30-7"><a href="building-the-modelalgorithm.html#cb30-7" aria-hidden="true"></a><span class="co">#' @param tt Time point.</span></span>
<span id="cb30-8"><a href="building-the-modelalgorithm.html#cb30-8" aria-hidden="true"></a>loglik_tt &lt;-<span class="st"> </span><span class="cf">function</span>(ylist, tt, mu, sigma, prob, <span class="dt">dimdat =</span> <span class="ot">NULL</span>, <span class="dt">countslist =</span> <span class="ot">NULL</span>, numclust){</span>
<span id="cb30-9"><a href="building-the-modelalgorithm.html#cb30-9" aria-hidden="true"></a></span>
<span id="cb30-10"><a href="building-the-modelalgorithm.html#cb30-10" aria-hidden="true"></a>  <span class="co">## One particle's log likelihood (weighted density)</span></span>
<span id="cb30-11"><a href="building-the-modelalgorithm.html#cb30-11" aria-hidden="true"></a>  weighted.densities =<span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span>numclust, <span class="cf">function</span>(iclust){</span>
<span id="cb30-12"><a href="building-the-modelalgorithm.html#cb30-12" aria-hidden="true"></a>    <span class="cf">if</span>(dimdat <span class="op">==</span><span class="st"> </span><span class="dv">1</span>){</span>
<span id="cb30-13"><a href="building-the-modelalgorithm.html#cb30-13" aria-hidden="true"></a>      <span class="kw">return</span>(prob[tt,iclust] <span class="op">*</span><span class="st"> </span><span class="kw">dnorm</span>(ylist[[tt]], mu[tt,,iclust], <span class="kw">sqrt</span>(sigma[iclust,,])))</span>
<span id="cb30-14"><a href="building-the-modelalgorithm.html#cb30-14" aria-hidden="true"></a>    }</span>
<span id="cb30-15"><a href="building-the-modelalgorithm.html#cb30-15" aria-hidden="true"></a>    <span class="cf">if</span>(dimdat <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>){</span>
<span id="cb30-16"><a href="building-the-modelalgorithm.html#cb30-16" aria-hidden="true"></a>    <span class="kw">return</span>(prob[tt,iclust] <span class="op">*</span><span class="st"> </span><span class="kw">dmvnorm_arma_fast</span>(ylist[[tt]], mu[tt,,iclust], <span class="kw">as.matrix</span>(sigma[iclust,,]), <span class="ot">FALSE</span>))</span>
<span id="cb30-17"><a href="building-the-modelalgorithm.html#cb30-17" aria-hidden="true"></a>    }</span>
<span id="cb30-18"><a href="building-the-modelalgorithm.html#cb30-18" aria-hidden="true"></a>  })</span>
<span id="cb30-19"><a href="building-the-modelalgorithm.html#cb30-19" aria-hidden="true"></a>  nt =<span class="st"> </span><span class="kw">nrow</span>(ylist[[tt]])</span>
<span id="cb30-20"><a href="building-the-modelalgorithm.html#cb30-20" aria-hidden="true"></a>  counts =<span class="st"> </span>(<span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(countslist)) countslist[[tt]] <span class="cf">else</span> <span class="kw">rep</span>(<span class="dv">1</span>, nt))</span>
<span id="cb30-21"><a href="building-the-modelalgorithm.html#cb30-21" aria-hidden="true"></a></span>
<span id="cb30-22"><a href="building-the-modelalgorithm.html#cb30-22" aria-hidden="true"></a>  sum_wt_dens =<span class="st"> </span><span class="kw">rowSums</span>(weighted.densities)</span>
<span id="cb30-23"><a href="building-the-modelalgorithm.html#cb30-23" aria-hidden="true"></a>  sum_wt_dens =<span class="st"> </span>sum_wt_dens <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pmax</span>(<span class="fl">1E-100</span>)</span>
<span id="cb30-24"><a href="building-the-modelalgorithm.html#cb30-24" aria-hidden="true"></a></span>
<span id="cb30-25"><a href="building-the-modelalgorithm.html#cb30-25" aria-hidden="true"></a>  <span class="kw">return</span>(<span class="kw">sum</span>(<span class="kw">log</span>(sum_wt_dens) <span class="op">*</span><span class="st"> </span>counts))</span>
<span id="cb30-26"><a href="building-the-modelalgorithm.html#cb30-26" aria-hidden="true"></a>}</span></code></pre></div>
<p>Next, here is the function that calculates the entire objective from all
cytograms, given model parameter <code>mu</code>, <code>prob</code>, and <code>sigma</code>:</p>
<p><span class="math display">\[\sum_{t=1}^T\sum_{i=1}^{n_t} C_i^{(t)} \log\left( \sum_{k=1}^K \pi_{itk} \phi(y_i^{(t)};
\mu_{kt}, \Sigma_k) \right). \]</span></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="building-the-modelalgorithm.html#cb31-1" aria-hidden="true"></a><span class="co">#' Evaluating the penalized data log-likelihood on all data \code{ylist} given parameters \code{mu}, \code{prob}, and \code{sigma}.</span></span>
<span id="cb31-2"><a href="building-the-modelalgorithm.html#cb31-2" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb31-3"><a href="building-the-modelalgorithm.html#cb31-3" aria-hidden="true"></a><span class="co">#' @param mu</span></span>
<span id="cb31-4"><a href="building-the-modelalgorithm.html#cb31-4" aria-hidden="true"></a><span class="co">#' @param prob</span></span>
<span id="cb31-5"><a href="building-the-modelalgorithm.html#cb31-5" aria-hidden="true"></a><span class="co">#' @param prob_link</span></span>
<span id="cb31-6"><a href="building-the-modelalgorithm.html#cb31-6" aria-hidden="true"></a><span class="co">#' @param sigma</span></span>
<span id="cb31-7"><a href="building-the-modelalgorithm.html#cb31-7" aria-hidden="true"></a><span class="co">#' @param ylist</span></span>
<span id="cb31-8"><a href="building-the-modelalgorithm.html#cb31-8" aria-hidden="true"></a><span class="co">#' @param Dl</span></span>
<span id="cb31-9"><a href="building-the-modelalgorithm.html#cb31-9" aria-hidden="true"></a><span class="co">#' @param l</span></span>
<span id="cb31-10"><a href="building-the-modelalgorithm.html#cb31-10" aria-hidden="true"></a><span class="co">#' @param lambda</span></span>
<span id="cb31-11"><a href="building-the-modelalgorithm.html#cb31-11" aria-hidden="true"></a><span class="co">#' @param l_prob</span></span>
<span id="cb31-12"><a href="building-the-modelalgorithm.html#cb31-12" aria-hidden="true"></a><span class="co">#' @param Dl_prob</span></span>
<span id="cb31-13"><a href="building-the-modelalgorithm.html#cb31-13" aria-hidden="true"></a><span class="co">#' @param lambda_prob</span></span>
<span id="cb31-14"><a href="building-the-modelalgorithm.html#cb31-14" aria-hidden="true"></a><span class="co">#' @param alpha</span></span>
<span id="cb31-15"><a href="building-the-modelalgorithm.html#cb31-15" aria-hidden="true"></a><span class="co">#' @param beta</span></span>
<span id="cb31-16"><a href="building-the-modelalgorithm.html#cb31-16" aria-hidden="true"></a><span class="co">#' @param denslist_by_clust</span></span>
<span id="cb31-17"><a href="building-the-modelalgorithm.html#cb31-17" aria-hidden="true"></a><span class="co">#' @param countslist</span></span>
<span id="cb31-18"><a href="building-the-modelalgorithm.html#cb31-18" aria-hidden="true"></a><span class="co">#' @param unpenalized if TRUE, return the unpenalized out-of-sample fit.</span></span>
<span id="cb31-19"><a href="building-the-modelalgorithm.html#cb31-19" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb31-20"><a href="building-the-modelalgorithm.html#cb31-20" aria-hidden="true"></a><span class="co">#' @return</span></span>
<span id="cb31-21"><a href="building-the-modelalgorithm.html#cb31-21" aria-hidden="true"></a><span class="co">#' @export</span></span>
<span id="cb31-22"><a href="building-the-modelalgorithm.html#cb31-22" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb31-23"><a href="building-the-modelalgorithm.html#cb31-23" aria-hidden="true"></a><span class="co">#' @examples</span></span>
<span id="cb31-24"><a href="building-the-modelalgorithm.html#cb31-24" aria-hidden="true"></a>objective &lt;-<span class="st"> </span><span class="cf">function</span>(mu, prob, <span class="dt">prob_link =</span> <span class="ot">NULL</span>, sigma,</span>
<span id="cb31-25"><a href="building-the-modelalgorithm.html#cb31-25" aria-hidden="true"></a>                      ylist,</span>
<span id="cb31-26"><a href="building-the-modelalgorithm.html#cb31-26" aria-hidden="true"></a>                      Dlp1, <span class="dt">l =</span> <span class="ot">NULL</span>,</span>
<span id="cb31-27"><a href="building-the-modelalgorithm.html#cb31-27" aria-hidden="true"></a>                      <span class="dt">lambda =</span> <span class="dv">0</span>,</span>
<span id="cb31-28"><a href="building-the-modelalgorithm.html#cb31-28" aria-hidden="true"></a>                      <span class="dt">l_prob =</span> <span class="ot">NULL</span>,</span>
<span id="cb31-29"><a href="building-the-modelalgorithm.html#cb31-29" aria-hidden="true"></a>                      <span class="dt">Dlp1_prob =</span> <span class="ot">NULL</span>,</span>
<span id="cb31-30"><a href="building-the-modelalgorithm.html#cb31-30" aria-hidden="true"></a>                      <span class="dt">lambda_prob =</span> <span class="dv">0</span>,</span>
<span id="cb31-31"><a href="building-the-modelalgorithm.html#cb31-31" aria-hidden="true"></a>                      <span class="dt">alpha =</span> <span class="ot">NULL</span>, <span class="dt">beta =</span> <span class="ot">NULL</span>,</span>
<span id="cb31-32"><a href="building-the-modelalgorithm.html#cb31-32" aria-hidden="true"></a>                      <span class="dt">denslist_by_clust =</span> <span class="ot">NULL</span>,</span>
<span id="cb31-33"><a href="building-the-modelalgorithm.html#cb31-33" aria-hidden="true"></a>                      <span class="dt">countslist =</span> <span class="ot">NULL</span>,</span>
<span id="cb31-34"><a href="building-the-modelalgorithm.html#cb31-34" aria-hidden="true"></a>                      <span class="dt">unpenalized =</span> <span class="ot">FALSE</span>){</span>
<span id="cb31-35"><a href="building-the-modelalgorithm.html#cb31-35" aria-hidden="true"></a></span>
<span id="cb31-36"><a href="building-the-modelalgorithm.html#cb31-36" aria-hidden="true"></a>  <span class="co">## Set some important variables</span></span>
<span id="cb31-37"><a href="building-the-modelalgorithm.html#cb31-37" aria-hidden="true"></a>  TT =<span class="st"> </span><span class="kw">dim</span>(mu)[<span class="dv">1</span>]</span>
<span id="cb31-38"><a href="building-the-modelalgorithm.html#cb31-38" aria-hidden="true"></a>  numclust =<span class="st"> </span><span class="kw">dim</span>(mu)[<span class="dv">3</span>]</span>
<span id="cb31-39"><a href="building-the-modelalgorithm.html#cb31-39" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="kw">is.null</span>(countslist)){</span>
<span id="cb31-40"><a href="building-the-modelalgorithm.html#cb31-40" aria-hidden="true"></a>    ntlist =<span class="st"> </span><span class="kw">sapply</span>(ylist, nrow)</span>
<span id="cb31-41"><a href="building-the-modelalgorithm.html#cb31-41" aria-hidden="true"></a>  } <span class="cf">else</span> {</span>
<span id="cb31-42"><a href="building-the-modelalgorithm.html#cb31-42" aria-hidden="true"></a>    ntlist =<span class="st"> </span><span class="kw">sapply</span>(countslist, sum)</span>
<span id="cb31-43"><a href="building-the-modelalgorithm.html#cb31-43" aria-hidden="true"></a>  }</span>
<span id="cb31-44"><a href="building-the-modelalgorithm.html#cb31-44" aria-hidden="true"></a>  N =<span class="st"> </span><span class="kw">sum</span>(ntlist)</span>
<span id="cb31-45"><a href="building-the-modelalgorithm.html#cb31-45" aria-hidden="true"></a>  dimdat =<span class="st"> </span><span class="kw">ncol</span>(ylist[[<span class="dv">1</span>]])</span>
<span id="cb31-46"><a href="building-the-modelalgorithm.html#cb31-46" aria-hidden="true"></a></span>
<span id="cb31-47"><a href="building-the-modelalgorithm.html#cb31-47" aria-hidden="true"></a>  <span class="co">## Calculate the log likelihood</span></span>
<span id="cb31-48"><a href="building-the-modelalgorithm.html#cb31-48" aria-hidden="true"></a>  loglik =<span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span>TT, <span class="cf">function</span>(tt){</span>
<span id="cb31-49"><a href="building-the-modelalgorithm.html#cb31-49" aria-hidden="true"></a>    <span class="cf">if</span>(<span class="kw">is.null</span>(denslist_by_clust)){</span>
<span id="cb31-50"><a href="building-the-modelalgorithm.html#cb31-50" aria-hidden="true"></a>      <span class="kw">return</span>(<span class="kw">loglik_tt</span>(ylist, tt, mu, sigma, prob, countslist, <span class="dt">numclust =</span> numclust, <span class="dt">dimdat =</span> dimdat))</span>
<span id="cb31-51"><a href="building-the-modelalgorithm.html#cb31-51" aria-hidden="true"></a>    } <span class="cf">else</span> {</span>
<span id="cb31-52"><a href="building-the-modelalgorithm.html#cb31-52" aria-hidden="true"></a>      <span class="co">## </span><span class="al">TODO</span><span class="co">: This function doesn't exist yet, but might need to, since.. speed!</span></span>
<span id="cb31-53"><a href="building-the-modelalgorithm.html#cb31-53" aria-hidden="true"></a>      <span class="kw">return</span>(<span class="kw">loglik_tt_precalculate</span>(ylist, tt, denslist_by_clust, prob, countslist, numclust))</span>
<span id="cb31-54"><a href="building-the-modelalgorithm.html#cb31-54" aria-hidden="true"></a>    }</span>
<span id="cb31-55"><a href="building-the-modelalgorithm.html#cb31-55" aria-hidden="true"></a>  })</span>
<span id="cb31-56"><a href="building-the-modelalgorithm.html#cb31-56" aria-hidden="true"></a></span>
<span id="cb31-57"><a href="building-the-modelalgorithm.html#cb31-57" aria-hidden="true"></a>  <span class="cf">if</span>(unpenalized){</span>
<span id="cb31-58"><a href="building-the-modelalgorithm.html#cb31-58" aria-hidden="true"></a>    obj =<span class="st">  </span><span class="dv">-1</span><span class="op">/</span>N <span class="op">*</span><span class="st"> </span><span class="kw">sum</span>(<span class="kw">unlist</span>(loglik)) </span>
<span id="cb31-59"><a href="building-the-modelalgorithm.html#cb31-59" aria-hidden="true"></a>    <span class="kw">return</span>(obj)</span>
<span id="cb31-60"><a href="building-the-modelalgorithm.html#cb31-60" aria-hidden="true"></a>  } <span class="cf">else</span> {</span>
<span id="cb31-61"><a href="building-the-modelalgorithm.html#cb31-61" aria-hidden="true"></a></span>
<span id="cb31-62"><a href="building-the-modelalgorithm.html#cb31-62" aria-hidden="true"></a>    <span class="co">## Return penalized likelihood</span></span>
<span id="cb31-63"><a href="building-the-modelalgorithm.html#cb31-63" aria-hidden="true"></a>    mu.splt &lt;-<span class="st"> </span><span class="kw">asplit</span>(mu, <span class="dt">MARGIN =</span> <span class="dv">2</span>) <span class="co">## This was 3, which I think produces the same result.</span></span>
<span id="cb31-64"><a href="building-the-modelalgorithm.html#cb31-64" aria-hidden="true"></a>    diff_mu &lt;-<span class="st"> </span><span class="kw">sum</span>(<span class="kw">unlist</span>(<span class="kw">lapply</span>(mu.splt, <span class="dt">FUN =</span> <span class="cf">function</span>(m) <span class="kw">sum</span>(<span class="kw">abs</span>(Dlp1 <span class="op">%*%</span><span class="st"> </span>m)))))</span>
<span id="cb31-65"><a href="building-the-modelalgorithm.html#cb31-65" aria-hidden="true"></a>    diff_prob &lt;-<span class="st"> </span><span class="kw">sum</span>(<span class="kw">abs</span>(Dlp1_prob <span class="op">%*%</span><span class="st"> </span>prob_link))</span>
<span id="cb31-66"><a href="building-the-modelalgorithm.html#cb31-66" aria-hidden="true"></a>    obj =<span class="st">  </span><span class="dv">-1</span><span class="op">/</span>N <span class="op">*</span><span class="st"> </span><span class="kw">sum</span>(<span class="kw">unlist</span>(loglik)) <span class="op">+</span><span class="st"> </span>lambda <span class="op">*</span><span class="st"> </span>diff_mu <span class="op">+</span><span class="st"> </span>lambda_prob <span class="op">*</span><span class="st"> </span>diff_prob</span>
<span id="cb31-67"><a href="building-the-modelalgorithm.html#cb31-67" aria-hidden="true"></a>    <span class="kw">return</span>(obj)</span>
<span id="cb31-68"><a href="building-the-modelalgorithm.html#cb31-68" aria-hidden="true"></a>  }</span>
<span id="cb31-69"><a href="building-the-modelalgorithm.html#cb31-69" aria-hidden="true"></a>}</span></code></pre></div>
<p>Here’s a helper to check numerical convergence of the EM algorithm.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="building-the-modelalgorithm.html#cb32-1" aria-hidden="true"></a><span class="co">#' Checks numerical improvement in objective value. Returns TRUE if |old-new|/|old| is smaller than tol.</span></span>
<span id="cb32-2"><a href="building-the-modelalgorithm.html#cb32-2" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb32-3"><a href="building-the-modelalgorithm.html#cb32-3" aria-hidden="true"></a><span class="co">#' @param old Objective value from previous iteration.</span></span>
<span id="cb32-4"><a href="building-the-modelalgorithm.html#cb32-4" aria-hidden="true"></a><span class="co">#' @param new Objective value from current iteration.</span></span>
<span id="cb32-5"><a href="building-the-modelalgorithm.html#cb32-5" aria-hidden="true"></a><span class="co">#' @param tol Numerical tolerance.</span></span>
<span id="cb32-6"><a href="building-the-modelalgorithm.html#cb32-6" aria-hidden="true"></a>check_converge_rel &lt;-<span class="st"> </span><span class="cf">function</span>(old, new, <span class="dt">tol=</span><span class="fl">1E-6</span>){</span>
<span id="cb32-7"><a href="building-the-modelalgorithm.html#cb32-7" aria-hidden="true"></a>  <span class="kw">return</span>(<span class="kw">abs</span>((old<span class="op">-</span>new)<span class="op">/</span>old) <span class="op">&lt;</span><span class="st"> </span>tol )</span>
<span id="cb32-8"><a href="building-the-modelalgorithm.html#cb32-8" aria-hidden="true"></a>}</span></code></pre></div>
<p>Here’s also a helper function to do the softmax-ing of <span class="math inline">\(\alpha_t \in \mathbb{R}^K\)</span>.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="building-the-modelalgorithm.html#cb33-1" aria-hidden="true"></a><span class="co">#'  Softmax function.</span></span>
<span id="cb33-2"><a href="building-the-modelalgorithm.html#cb33-2" aria-hidden="true"></a><span class="co">#' </span></span>
<span id="cb33-3"><a href="building-the-modelalgorithm.html#cb33-3" aria-hidden="true"></a><span class="co">#' @param prob_link alpha, which is a (T x K) matrix.</span></span>
<span id="cb33-4"><a href="building-the-modelalgorithm.html#cb33-4" aria-hidden="true"></a><span class="co">#' </span></span>
<span id="cb33-5"><a href="building-the-modelalgorithm.html#cb33-5" aria-hidden="true"></a><span class="co">#' @return exp(alpha)/rowSum(exp(alpha)). A (T x K) matrix.</span></span>
<span id="cb33-6"><a href="building-the-modelalgorithm.html#cb33-6" aria-hidden="true"></a>softmax &lt;-<span class="st"> </span><span class="cf">function</span>(prob_link){</span>
<span id="cb33-7"><a href="building-the-modelalgorithm.html#cb33-7" aria-hidden="true"></a>  exp_prob_link =<span class="st"> </span><span class="kw">exp</span>(prob_link)</span>
<span id="cb33-8"><a href="building-the-modelalgorithm.html#cb33-8" aria-hidden="true"></a>  prob =<span class="st"> </span>exp_prob_link <span class="op">/</span><span class="st"> </span><span class="kw">rowSums</span>(exp_prob_link)</span>
<span id="cb33-9"><a href="building-the-modelalgorithm.html#cb33-9" aria-hidden="true"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="building-the-modelalgorithm.html#cb34-1" aria-hidden="true"></a>testthat<span class="op">::</span><span class="kw">test_that</span>(<span class="st">"Test for softmax"</span>,{</span>
<span id="cb34-2"><a href="building-the-modelalgorithm.html#cb34-2" aria-hidden="true"></a>  link =<span class="st"> </span><span class="kw">runif</span>(<span class="dv">100</span>, <span class="dt">min =</span> <span class="dv">-10</span>, <span class="dt">max =</span> <span class="dv">10</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">matrix</span>(<span class="dt">nrow =</span> <span class="dv">10</span>, <span class="dt">ncol =</span> <span class="dv">10</span>)</span>
<span id="cb34-3"><a href="building-the-modelalgorithm.html#cb34-3" aria-hidden="true"></a>  testthat<span class="op">::</span><span class="kw">expect_true</span>(<span class="kw">all</span>(<span class="kw">abs</span>(<span class="kw">rowSums</span>(<span class="kw">softmax</span>(link)) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">&lt;</span><span class="st"> </span><span class="fl">1E-13</span>))</span>
<span id="cb34-4"><a href="building-the-modelalgorithm.html#cb34-4" aria-hidden="true"></a>})</span></code></pre></div>
</div>
<div id="initial-parameters-for-em-algorithm" class="section level2 hasAnchor" number="3.3">
<h2>
<span class="header-section-number">3.3</span> Initial parameters for EM algorithm<a href="building-the-modelalgorithm.html#initial-parameters-for-em-algorithm" class="anchor-section" aria-label="Anchor link to header"></a>
</h2>
<p>The EM algorithm requires some initial values for <span class="math inline">\(\mu\)</span>, <span class="math inline">\(\pi\)</span> and <span class="math inline">\(\Sigma\)</span>.</p>
<p>Initializing <span class="math inline">\(\pi\)</span> is done in one line, <code>prob = matrix(1/numclust, nrow = TT, ncol = numclust)</code>, which sets everything to <span class="math inline">\(1/K\)</span>.</p>
<p>For <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\Sigma\)</span>, we write some functions. Essentially, initial means
<span class="math inline">\(\mu\)</span> are <em>jittered</em> versions of a <span class="math inline">\(K\)</span> means that are drawn from a downsampled
version of <span class="math inline">\(ylist\)</span> (downsampling is done because <span class="math inline">\(ylist\)</span> can have a large number
of particles). <span class="math inline">\(\Sigma\)</span> is <span class="math inline">\(d\times d\)</span> identity matrices, with <code>fac=1</code> diagonal
by default.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="building-the-modelalgorithm.html#cb35-1" aria-hidden="true"></a><span class="co">#' Initialize the cluster centers.</span></span>
<span id="cb35-2"><a href="building-the-modelalgorithm.html#cb35-2" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb35-3"><a href="building-the-modelalgorithm.html#cb35-3" aria-hidden="true"></a><span class="co">#' @param ylist  A T-length list of (nt  by 3) datasets.  There should  be T of</span></span>
<span id="cb35-4"><a href="building-the-modelalgorithm.html#cb35-4" aria-hidden="true"></a><span class="co">#'   such datasets. 3 is actually \code{mulen}.</span></span>
<span id="cb35-5"><a href="building-the-modelalgorithm.html#cb35-5" aria-hidden="true"></a><span class="co">#' @param numclust Number of clusters (M).</span></span>
<span id="cb35-6"><a href="building-the-modelalgorithm.html#cb35-6" aria-hidden="true"></a><span class="co">#' @param TT total number of (training) time points.</span></span>
<span id="cb35-7"><a href="building-the-modelalgorithm.html#cb35-7" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb35-8"><a href="building-the-modelalgorithm.html#cb35-8" aria-hidden="true"></a><span class="co">#' @return An array of dimension (T x dimdat x M).</span></span>
<span id="cb35-9"><a href="building-the-modelalgorithm.html#cb35-9" aria-hidden="true"></a><span class="co">#' @export</span></span>
<span id="cb35-10"><a href="building-the-modelalgorithm.html#cb35-10" aria-hidden="true"></a>init_mn &lt;-<span class="st"> </span><span class="cf">function</span>(ylist, numclust, TT, dimdat, <span class="dt">countslist =</span> <span class="ot">NULL</span>, <span class="dt">seed=</span><span class="ot">NULL</span>){</span>
<span id="cb35-11"><a href="building-the-modelalgorithm.html#cb35-11" aria-hidden="true"></a></span>
<span id="cb35-12"><a href="building-the-modelalgorithm.html#cb35-12" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(seed)){</span>
<span id="cb35-13"><a href="building-the-modelalgorithm.html#cb35-13" aria-hidden="true"></a>    assertthat<span class="op">::</span><span class="kw">assert_that</span>(<span class="kw">all</span>((seed <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sapply</span>(., class)) <span class="op">==</span><span class="st"> "integer"</span>))</span>
<span id="cb35-14"><a href="building-the-modelalgorithm.html#cb35-14" aria-hidden="true"></a>    assertthat<span class="op">::</span><span class="kw">assert_that</span>(<span class="kw">length</span>(seed) <span class="op">==</span><span class="st"> </span><span class="dv">7</span>)</span>
<span id="cb35-15"><a href="building-the-modelalgorithm.html#cb35-15" aria-hidden="true"></a>    <span class="kw">RNGkind</span>(<span class="st">"L'Ecuyer-CMRG"</span>) </span>
<span id="cb35-16"><a href="building-the-modelalgorithm.html#cb35-16" aria-hidden="true"></a>    .Random.seed &lt;&lt;-<span class="st"> </span>seed</span>
<span id="cb35-17"><a href="building-the-modelalgorithm.html#cb35-17" aria-hidden="true"></a>  }</span>
<span id="cb35-18"><a href="building-the-modelalgorithm.html#cb35-18" aria-hidden="true"></a></span>
<span id="cb35-19"><a href="building-the-modelalgorithm.html#cb35-19" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="kw">is.null</span>(countslist)){</span>
<span id="cb35-20"><a href="building-the-modelalgorithm.html#cb35-20" aria-hidden="true"></a>    ntlist =<span class="st"> </span><span class="kw">sapply</span>(ylist, nrow)</span>
<span id="cb35-21"><a href="building-the-modelalgorithm.html#cb35-21" aria-hidden="true"></a>    countslist =<span class="st"> </span><span class="kw">lapply</span>(ntlist, <span class="dt">FUN =</span> <span class="cf">function</span>(nt) <span class="kw">rep</span>(<span class="dv">1</span>, nt))</span>
<span id="cb35-22"><a href="building-the-modelalgorithm.html#cb35-22" aria-hidden="true"></a>  }</span>
<span id="cb35-23"><a href="building-the-modelalgorithm.html#cb35-23" aria-hidden="true"></a></span>
<span id="cb35-24"><a href="building-the-modelalgorithm.html#cb35-24" aria-hidden="true"></a>  <span class="co">## Initialize the means by (1) collapsing to one cytogram (2) random</span></span>
<span id="cb35-25"><a href="building-the-modelalgorithm.html#cb35-25" aria-hidden="true"></a>  <span class="co">## sampling from this distribution, after truncation,</span></span>
<span id="cb35-26"><a href="building-the-modelalgorithm.html#cb35-26" aria-hidden="true"></a>  TT =<span class="st"> </span><span class="kw">length</span>(ylist)</span>
<span id="cb35-27"><a href="building-the-modelalgorithm.html#cb35-27" aria-hidden="true"></a>  ylist_downsampled &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>TT, <span class="cf">function</span>(tt){</span>
<span id="cb35-28"><a href="building-the-modelalgorithm.html#cb35-28" aria-hidden="true"></a></span>
<span id="cb35-29"><a href="building-the-modelalgorithm.html#cb35-29" aria-hidden="true"></a>    y =<span class="st"> </span>ylist[[tt]]</span>
<span id="cb35-30"><a href="building-the-modelalgorithm.html#cb35-30" aria-hidden="true"></a>    counts =<span class="st"> </span>countslist[[tt]]</span>
<span id="cb35-31"><a href="building-the-modelalgorithm.html#cb35-31" aria-hidden="true"></a></span>
<span id="cb35-32"><a href="building-the-modelalgorithm.html#cb35-32" aria-hidden="true"></a>    <span class="co">## Sample so that, in total, we get mean(nt) * 30 sized sample. In the case</span></span>
<span id="cb35-33"><a href="building-the-modelalgorithm.html#cb35-33" aria-hidden="true"></a>    <span class="co">## of binned data, nt is the number of bins.</span></span>
<span id="cb35-34"><a href="building-the-modelalgorithm.html#cb35-34" aria-hidden="true"></a>    <span class="cf">if</span>(<span class="kw">nrow</span>(y) <span class="op">&gt;</span><span class="st"> </span><span class="dv">500</span>) nsize =<span class="st"> </span><span class="kw">pmin</span>(<span class="kw">nrow</span>(y) <span class="op">/</span><span class="st"> </span>TT <span class="op">*</span><span class="st"> </span><span class="dv">30</span>, <span class="kw">nrow</span>(y)) <span class="cf">else</span> nsize =<span class="st"> </span><span class="kw">nrow</span>(y)</span>
<span id="cb35-35"><a href="building-the-modelalgorithm.html#cb35-35" aria-hidden="true"></a>    some_rows =<span class="st"> </span><span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(y),</span>
<span id="cb35-36"><a href="building-the-modelalgorithm.html#cb35-36" aria-hidden="true"></a>                       <span class="dt">size =</span> nsize,</span>
<span id="cb35-37"><a href="building-the-modelalgorithm.html#cb35-37" aria-hidden="true"></a>                       <span class="dt">prob =</span> counts<span class="op">/</span><span class="kw">sum</span>(counts))</span>
<span id="cb35-38"><a href="building-the-modelalgorithm.html#cb35-38" aria-hidden="true"></a>    y[some_rows,, drop=<span class="ot">FALSE</span>]</span>
<span id="cb35-39"><a href="building-the-modelalgorithm.html#cb35-39" aria-hidden="true"></a>  })</span>
<span id="cb35-40"><a href="building-the-modelalgorithm.html#cb35-40" aria-hidden="true"></a></span>
<span id="cb35-41"><a href="building-the-modelalgorithm.html#cb35-41" aria-hidden="true"></a>  <span class="co">## Jitter the means a bit</span></span>
<span id="cb35-42"><a href="building-the-modelalgorithm.html#cb35-42" aria-hidden="true"></a>  yy =<span class="st"> </span><span class="kw">do.call</span>(rbind, ylist_downsampled)</span>
<span id="cb35-43"><a href="building-the-modelalgorithm.html#cb35-43" aria-hidden="true"></a>  new_means =<span class="st"> </span>yy[<span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(yy), numclust),, drop=<span class="ot">FALSE</span>]</span>
<span id="cb35-44"><a href="building-the-modelalgorithm.html#cb35-44" aria-hidden="true"></a>  jitter_sd =<span class="st"> </span><span class="kw">apply</span>(yy, <span class="dv">2</span>, sd) <span class="op">/</span><span class="st"> </span><span class="dv">100</span></span>
<span id="cb35-45"><a href="building-the-modelalgorithm.html#cb35-45" aria-hidden="true"></a>  jitter_means =<span class="st"> </span>MASS<span class="op">::</span><span class="kw">mvrnorm</span>(<span class="dt">n =</span> <span class="kw">nrow</span>(new_means),</span>
<span id="cb35-46"><a href="building-the-modelalgorithm.html#cb35-46" aria-hidden="true"></a>                               <span class="dt">mu =</span> <span class="kw">rep</span>(<span class="dv">0</span>, dimdat),</span>
<span id="cb35-47"><a href="building-the-modelalgorithm.html#cb35-47" aria-hidden="true"></a>                               <span class="dt">Sigma =</span> <span class="kw">diag</span>(jitter_sd, <span class="dt">ncol =</span> dimdat))</span>
<span id="cb35-48"><a href="building-the-modelalgorithm.html#cb35-48" aria-hidden="true"></a>  new_means =<span class="st"> </span>new_means <span class="op">+</span><span class="st"> </span>jitter_means</span>
<span id="cb35-49"><a href="building-the-modelalgorithm.html#cb35-49" aria-hidden="true"></a></span>
<span id="cb35-50"><a href="building-the-modelalgorithm.html#cb35-50" aria-hidden="true"></a>  <span class="co">## Repeat TT times == flat/constant initial means across time.</span></span>
<span id="cb35-51"><a href="building-the-modelalgorithm.html#cb35-51" aria-hidden="true"></a>  mulist =<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>TT, <span class="cf">function</span>(tt){ new_means })</span>
<span id="cb35-52"><a href="building-the-modelalgorithm.html#cb35-52" aria-hidden="true"></a></span>
<span id="cb35-53"><a href="building-the-modelalgorithm.html#cb35-53" aria-hidden="true"></a>  <span class="co">## } else {</span></span>
<span id="cb35-54"><a href="building-the-modelalgorithm.html#cb35-54" aria-hidden="true"></a></span>
<span id="cb35-55"><a href="building-the-modelalgorithm.html#cb35-55" aria-hidden="true"></a>  <span class="co">##   TT = length(ylist)</span></span>
<span id="cb35-56"><a href="building-the-modelalgorithm.html#cb35-56" aria-hidden="true"></a>  <span class="co">##   ylist_downsampled &lt;- lapply(1:TT, function(tt){</span></span>
<span id="cb35-57"><a href="building-the-modelalgorithm.html#cb35-57" aria-hidden="true"></a>  <span class="co">##     y = ylist[[tt]]</span></span>
<span id="cb35-58"><a href="building-the-modelalgorithm.html#cb35-58" aria-hidden="true"></a>  <span class="co">##     counts = countslist[[tt]]</span></span>
<span id="cb35-59"><a href="building-the-modelalgorithm.html#cb35-59" aria-hidden="true"></a>  <span class="co">##     nsize = pmin(nrow(y) / TT * 30, nrow(y))</span></span>
<span id="cb35-60"><a href="building-the-modelalgorithm.html#cb35-60" aria-hidden="true"></a>  <span class="co">##     y[sample(1:nrow(y), size = nsize),, drop=FALSE]</span></span>
<span id="cb35-61"><a href="building-the-modelalgorithm.html#cb35-61" aria-hidden="true"></a>  <span class="co">##   })</span></span>
<span id="cb35-62"><a href="building-the-modelalgorithm.html#cb35-62" aria-hidden="true"></a></span>
<span id="cb35-63"><a href="building-the-modelalgorithm.html#cb35-63" aria-hidden="true"></a>  <span class="co">##   ## Combine all the particles</span></span>
<span id="cb35-64"><a href="building-the-modelalgorithm.html#cb35-64" aria-hidden="true"></a>  <span class="co">##   yy = do.call(rbind, ylist_downsampled)</span></span>
<span id="cb35-65"><a href="building-the-modelalgorithm.html#cb35-65" aria-hidden="true"></a></span>
<span id="cb35-66"><a href="building-the-modelalgorithm.html#cb35-66" aria-hidden="true"></a>  <span class="co">##   ## Get K new means from these</span></span>
<span id="cb35-67"><a href="building-the-modelalgorithm.html#cb35-67" aria-hidden="true"></a>  <span class="co">##   inds = sample(1:nrow(yy), numclust)</span></span>
<span id="cb35-68"><a href="building-the-modelalgorithm.html#cb35-68" aria-hidden="true"></a>  <span class="co">##   new_means = yy[inds,, drop=FALSE]</span></span>
<span id="cb35-69"><a href="building-the-modelalgorithm.html#cb35-69" aria-hidden="true"></a>  <span class="co">##   mulist = lapply(1:TT, function(tt){ new_means })</span></span>
<span id="cb35-70"><a href="building-the-modelalgorithm.html#cb35-70" aria-hidden="true"></a></span>
<span id="cb35-71"><a href="building-the-modelalgorithm.html#cb35-71" aria-hidden="true"></a>  <span class="co">## }</span></span>
<span id="cb35-72"><a href="building-the-modelalgorithm.html#cb35-72" aria-hidden="true"></a></span>
<span id="cb35-73"><a href="building-the-modelalgorithm.html#cb35-73" aria-hidden="true"></a>  <span class="co">## New (T x dimdat x numclust) array is created.</span></span>
<span id="cb35-74"><a href="building-the-modelalgorithm.html#cb35-74" aria-hidden="true"></a>  muarray =<span class="st"> </span><span class="kw">array</span>(<span class="ot">NA</span>, <span class="dt">dim=</span><span class="kw">c</span>(TT, dimdat, numclust))</span>
<span id="cb35-75"><a href="building-the-modelalgorithm.html#cb35-75" aria-hidden="true"></a>  <span class="cf">for</span>(tt <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>TT){</span>
<span id="cb35-76"><a href="building-the-modelalgorithm.html#cb35-76" aria-hidden="true"></a>    muarray[tt,,] =<span class="st"> </span><span class="kw">as.matrix</span>(mulist[[tt]])</span>
<span id="cb35-77"><a href="building-the-modelalgorithm.html#cb35-77" aria-hidden="true"></a>  }</span>
<span id="cb35-78"><a href="building-the-modelalgorithm.html#cb35-78" aria-hidden="true"></a>  <span class="kw">return</span>(muarray)</span>
<span id="cb35-79"><a href="building-the-modelalgorithm.html#cb35-79" aria-hidden="true"></a>}</span>
<span id="cb35-80"><a href="building-the-modelalgorithm.html#cb35-80" aria-hidden="true"></a></span>
<span id="cb35-81"><a href="building-the-modelalgorithm.html#cb35-81" aria-hidden="true"></a></span>
<span id="cb35-82"><a href="building-the-modelalgorithm.html#cb35-82" aria-hidden="true"></a><span class="co">#' Initialize the covariances.</span></span>
<span id="cb35-83"><a href="building-the-modelalgorithm.html#cb35-83" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb35-84"><a href="building-the-modelalgorithm.html#cb35-84" aria-hidden="true"></a><span class="co">#' @param data The (nt by 3) datasets. There should be T of them.</span></span>
<span id="cb35-85"><a href="building-the-modelalgorithm.html#cb35-85" aria-hidden="true"></a><span class="co">#' @param numclust Number of clusters.</span></span>
<span id="cb35-86"><a href="building-the-modelalgorithm.html#cb35-86" aria-hidden="true"></a><span class="co">#' @param fac Value to use for the diagonal of the (dimdat x dimdat) covariance</span></span>
<span id="cb35-87"><a href="building-the-modelalgorithm.html#cb35-87" aria-hidden="true"></a><span class="co">#'   matrix.</span></span>
<span id="cb35-88"><a href="building-the-modelalgorithm.html#cb35-88" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb35-89"><a href="building-the-modelalgorithm.html#cb35-89" aria-hidden="true"></a><span class="co">#' @return An (K x dimdat x dimdat) array containing the (dimdat by dimdat)</span></span>
<span id="cb35-90"><a href="building-the-modelalgorithm.html#cb35-90" aria-hidden="true"></a><span class="co">#'   covariances.</span></span>
<span id="cb35-91"><a href="building-the-modelalgorithm.html#cb35-91" aria-hidden="true"></a><span class="co">#' @export</span></span>
<span id="cb35-92"><a href="building-the-modelalgorithm.html#cb35-92" aria-hidden="true"></a>init_sigma &lt;-<span class="st"> </span><span class="cf">function</span>(data, numclust, <span class="dt">fac =</span> <span class="dv">1</span>){</span>
<span id="cb35-93"><a href="building-the-modelalgorithm.html#cb35-93" aria-hidden="true"></a></span>
<span id="cb35-94"><a href="building-the-modelalgorithm.html#cb35-94" aria-hidden="true"></a>  ndat =<span class="st"> </span><span class="kw">nrow</span>(data[[<span class="dv">1</span>]])</span>
<span id="cb35-95"><a href="building-the-modelalgorithm.html#cb35-95" aria-hidden="true"></a>  pdat =<span class="st"> </span><span class="kw">ncol</span>(data[[<span class="dv">1</span>]])</span>
<span id="cb35-96"><a href="building-the-modelalgorithm.html#cb35-96" aria-hidden="true"></a>  sigmas =<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>numclust, <span class="cf">function</span>(iclust){</span>
<span id="cb35-97"><a href="building-the-modelalgorithm.html#cb35-97" aria-hidden="true"></a>    onesigma =<span class="st"> </span><span class="kw">diag</span>(fac <span class="op">*</span><span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span>, pdat))</span>
<span id="cb35-98"><a href="building-the-modelalgorithm.html#cb35-98" aria-hidden="true"></a>    <span class="cf">if</span>(pdat<span class="op">==</span><span class="dv">1</span>) onesigma =<span class="st"> </span><span class="kw">as.matrix</span>(fac)</span>
<span id="cb35-99"><a href="building-the-modelalgorithm.html#cb35-99" aria-hidden="true"></a>    <span class="kw">colnames</span>(onesigma) =<span class="st"> </span><span class="kw">paste0</span>(<span class="st">"datcol"</span>, <span class="dv">1</span><span class="op">:</span>pdat)</span>
<span id="cb35-100"><a href="building-the-modelalgorithm.html#cb35-100" aria-hidden="true"></a>    <span class="kw">rownames</span>(onesigma) =<span class="st"> </span><span class="kw">paste0</span>(<span class="st">"datcol"</span>, <span class="dv">1</span><span class="op">:</span>pdat)</span>
<span id="cb35-101"><a href="building-the-modelalgorithm.html#cb35-101" aria-hidden="true"></a>    <span class="kw">return</span>(onesigma)</span>
<span id="cb35-102"><a href="building-the-modelalgorithm.html#cb35-102" aria-hidden="true"></a>  })</span>
<span id="cb35-103"><a href="building-the-modelalgorithm.html#cb35-103" aria-hidden="true"></a>  sigmas =<span class="st"> </span>abind<span class="op">::</span><span class="kw">abind</span>(sigmas, <span class="dt">along=</span><span class="dv">0</span>)</span>
<span id="cb35-104"><a href="building-the-modelalgorithm.html#cb35-104" aria-hidden="true"></a>  <span class="kw">return</span>(sigmas)</span>
<span id="cb35-105"><a href="building-the-modelalgorithm.html#cb35-105" aria-hidden="true"></a>}</span></code></pre></div>
<p>Here’s a helper function for printing the progress.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="building-the-modelalgorithm.html#cb36-1" aria-hidden="true"></a><span class="co">#' A helper function to print the progress of a loop or simulation.</span></span>
<span id="cb36-2"><a href="building-the-modelalgorithm.html#cb36-2" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb36-3"><a href="building-the-modelalgorithm.html#cb36-3" aria-hidden="true"></a><span class="co">#' @param isim Replicate number.</span></span>
<span id="cb36-4"><a href="building-the-modelalgorithm.html#cb36-4" aria-hidden="true"></a><span class="co">#' @param nsim Total number of replicates.</span></span>
<span id="cb36-5"><a href="building-the-modelalgorithm.html#cb36-5" aria-hidden="true"></a><span class="co">#' @param type Type of job you're running. Defaults to "simulation".</span></span>
<span id="cb36-6"><a href="building-the-modelalgorithm.html#cb36-6" aria-hidden="true"></a><span class="co">#' @param lapsetime Lapsed time, in seconds (by default).</span></span>
<span id="cb36-7"><a href="building-the-modelalgorithm.html#cb36-7" aria-hidden="true"></a><span class="co">#' @param lapsetimeunit "second".</span></span>
<span id="cb36-8"><a href="building-the-modelalgorithm.html#cb36-8" aria-hidden="true"></a><span class="co">#' @param start.time start time.</span></span>
<span id="cb36-9"><a href="building-the-modelalgorithm.html#cb36-9" aria-hidden="true"></a><span class="co">#' @param fill Whether or not to fill the line.</span></span>
<span id="cb36-10"><a href="building-the-modelalgorithm.html#cb36-10" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb36-11"><a href="building-the-modelalgorithm.html#cb36-11" aria-hidden="true"></a><span class="co">#' @return No return</span></span>
<span id="cb36-12"><a href="building-the-modelalgorithm.html#cb36-12" aria-hidden="true"></a>print_progress &lt;-<span class="st"> </span><span class="cf">function</span>(isim, nsim,</span>
<span id="cb36-13"><a href="building-the-modelalgorithm.html#cb36-13" aria-hidden="true"></a>                           <span class="dt">type =</span> <span class="st">"simulation"</span>, <span class="dt">lapsetime =</span> <span class="ot">NULL</span>,</span>
<span id="cb36-14"><a href="building-the-modelalgorithm.html#cb36-14" aria-hidden="true"></a>                           <span class="dt">lapsetimeunit =</span> <span class="st">"seconds"</span>, <span class="dt">start.time =</span> <span class="ot">NULL</span>,</span>
<span id="cb36-15"><a href="building-the-modelalgorithm.html#cb36-15" aria-hidden="true"></a>                           <span class="dt">fill =</span> <span class="ot">FALSE</span>){</span>
<span id="cb36-16"><a href="building-the-modelalgorithm.html#cb36-16" aria-hidden="true"></a></span>
<span id="cb36-17"><a href="building-the-modelalgorithm.html#cb36-17" aria-hidden="true"></a>  <span class="co">## If lapse time is present, then use it</span></span>
<span id="cb36-18"><a href="building-the-modelalgorithm.html#cb36-18" aria-hidden="true"></a>  <span class="cf">if</span>(fill) <span class="kw">cat</span>(<span class="dt">fill =</span> <span class="ot">TRUE</span>)</span>
<span id="cb36-19"><a href="building-the-modelalgorithm.html#cb36-19" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="kw">is.null</span>(lapsetime) <span class="op">&amp;</span><span class="st"> </span><span class="kw">is.null</span>(start.time)){</span>
<span id="cb36-20"><a href="building-the-modelalgorithm.html#cb36-20" aria-hidden="true"></a>    <span class="kw">cat</span>(<span class="st">"</span><span class="ch">\r</span><span class="st">"</span>, type, <span class="st">" "</span>, isim, <span class="st">"out of"</span>, nsim)</span>
<span id="cb36-21"><a href="building-the-modelalgorithm.html#cb36-21" aria-hidden="true"></a>  } <span class="cf">else</span> {</span>
<span id="cb36-22"><a href="building-the-modelalgorithm.html#cb36-22" aria-hidden="true"></a>    <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(start.time)){</span>
<span id="cb36-23"><a href="building-the-modelalgorithm.html#cb36-23" aria-hidden="true"></a>      lapsetime =<span class="st"> </span><span class="kw">round</span>(<span class="kw">difftime</span>(<span class="kw">Sys.time</span>(), start.time,</span>
<span id="cb36-24"><a href="building-the-modelalgorithm.html#cb36-24" aria-hidden="true"></a>                                 <span class="dt">units =</span> <span class="st">"secs"</span>), <span class="dv">0</span>)</span>
<span id="cb36-25"><a href="building-the-modelalgorithm.html#cb36-25" aria-hidden="true"></a>      remainingtime =<span class="st"> </span><span class="kw">round</span>(lapsetime <span class="op">*</span><span class="st"> </span>(nsim<span class="op">-</span>isim)<span class="op">/</span>isim,<span class="dv">0</span>)</span>
<span id="cb36-26"><a href="building-the-modelalgorithm.html#cb36-26" aria-hidden="true"></a>      endtime =<span class="st"> </span><span class="kw">Sys.time</span>() <span class="op">+</span><span class="st"> </span>remainingtime</span>
<span id="cb36-27"><a href="building-the-modelalgorithm.html#cb36-27" aria-hidden="true"></a>    }</span>
<span id="cb36-28"><a href="building-the-modelalgorithm.html#cb36-28" aria-hidden="true"></a>    <span class="kw">cat</span>(<span class="st">"</span><span class="ch">\r</span><span class="st">"</span>, type, <span class="st">" "</span>, isim, <span class="st">"out of"</span>, nsim, <span class="st">"with lapsed time"</span>,</span>
<span id="cb36-29"><a href="building-the-modelalgorithm.html#cb36-29" aria-hidden="true"></a>        lapsetime, lapsetimeunit, <span class="st">"and remaining time"</span>, remainingtime,</span>
<span id="cb36-30"><a href="building-the-modelalgorithm.html#cb36-30" aria-hidden="true"></a>        lapsetimeunit, <span class="st">"and will finish at"</span>, <span class="kw">strftime</span>(endtime))</span>
<span id="cb36-31"><a href="building-the-modelalgorithm.html#cb36-31" aria-hidden="true"></a>  }</span>
<span id="cb36-32"><a href="building-the-modelalgorithm.html#cb36-32" aria-hidden="true"></a>  <span class="cf">if</span>(fill) <span class="kw">cat</span>(<span class="dt">fill =</span> <span class="ot">TRUE</span>)</span>
<span id="cb36-33"><a href="building-the-modelalgorithm.html#cb36-33" aria-hidden="true"></a>}</span></code></pre></div>
</div>
<div id="e-step" class="section level2 hasAnchor" number="3.4">
<h2>
<span class="header-section-number">3.4</span> E step<a href="building-the-modelalgorithm.html#e-step" class="anchor-section" aria-label="Anchor link to header"></a>
</h2>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="building-the-modelalgorithm.html#cb37-1" aria-hidden="true"></a><span class="co">#' E step, which updates the "responsibilities", which are posterior membership probabilities of each particle.</span></span>
<span id="cb37-2"><a href="building-the-modelalgorithm.html#cb37-2" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb37-3"><a href="building-the-modelalgorithm.html#cb37-3" aria-hidden="true"></a><span class="co">#' @param mn</span></span>
<span id="cb37-4"><a href="building-the-modelalgorithm.html#cb37-4" aria-hidden="true"></a><span class="co">#' @param sigma</span></span>
<span id="cb37-5"><a href="building-the-modelalgorithm.html#cb37-5" aria-hidden="true"></a><span class="co">#' @param prob</span></span>
<span id="cb37-6"><a href="building-the-modelalgorithm.html#cb37-6" aria-hidden="true"></a><span class="co">#' @param ylist</span></span>
<span id="cb37-7"><a href="building-the-modelalgorithm.html#cb37-7" aria-hidden="true"></a><span class="co">#' @param numclust</span></span>
<span id="cb37-8"><a href="building-the-modelalgorithm.html#cb37-8" aria-hidden="true"></a><span class="co">#' @param denslist_by_clust</span></span>
<span id="cb37-9"><a href="building-the-modelalgorithm.html#cb37-9" aria-hidden="true"></a><span class="co">#' @param first_iter</span></span>
<span id="cb37-10"><a href="building-the-modelalgorithm.html#cb37-10" aria-hidden="true"></a><span class="co">#' @param countslist</span></span>
<span id="cb37-11"><a href="building-the-modelalgorithm.html#cb37-11" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb37-12"><a href="building-the-modelalgorithm.html#cb37-12" aria-hidden="true"></a><span class="co">#' @return</span></span>
<span id="cb37-13"><a href="building-the-modelalgorithm.html#cb37-13" aria-hidden="true"></a><span class="co">#' @export</span></span>
<span id="cb37-14"><a href="building-the-modelalgorithm.html#cb37-14" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb37-15"><a href="building-the-modelalgorithm.html#cb37-15" aria-hidden="true"></a>Estep &lt;-<span class="st"> </span><span class="cf">function</span>(mn, sigma, prob, <span class="dt">ylist =</span> <span class="ot">NULL</span>, numclust, <span class="dt">denslist_by_clust =</span> <span class="ot">NULL</span>,</span>
<span id="cb37-16"><a href="building-the-modelalgorithm.html#cb37-16" aria-hidden="true"></a>                  <span class="dt">first_iter =</span> <span class="ot">FALSE</span>, <span class="dt">countslist =</span> <span class="ot">NULL</span>){</span>
<span id="cb37-17"><a href="building-the-modelalgorithm.html#cb37-17" aria-hidden="true"></a>  <span class="co">## Basic setup</span></span>
<span id="cb37-18"><a href="building-the-modelalgorithm.html#cb37-18" aria-hidden="true"></a>  TT =<span class="st"> </span><span class="kw">length</span>(ylist)</span>
<span id="cb37-19"><a href="building-the-modelalgorithm.html#cb37-19" aria-hidden="true"></a>  ntlist =<span class="st"> </span><span class="kw">sapply</span>(ylist, nrow)</span>
<span id="cb37-20"><a href="building-the-modelalgorithm.html#cb37-20" aria-hidden="true"></a>  resp =<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb37-21"><a href="building-the-modelalgorithm.html#cb37-21" aria-hidden="true"></a>  dimdat =<span class="st"> </span><span class="kw">dim</span>(mn)[<span class="dv">2</span>]</span>
<span id="cb37-22"><a href="building-the-modelalgorithm.html#cb37-22" aria-hidden="true"></a>  assertthat<span class="op">::</span><span class="kw">assert_that</span>(<span class="kw">dim</span>(mn)[<span class="dv">1</span>] <span class="op">==</span><span class="st"> </span><span class="kw">length</span>(ylist))</span>
<span id="cb37-23"><a href="building-the-modelalgorithm.html#cb37-23" aria-hidden="true"></a></span>
<span id="cb37-24"><a href="building-the-modelalgorithm.html#cb37-24" aria-hidden="true"></a>  <span class="co">## Helper to calculate Gaussian density for each \code{N(y_{t,k},mu_{t,k} and</span></span>
<span id="cb37-25"><a href="building-the-modelalgorithm.html#cb37-25" aria-hidden="true"></a>  <span class="co">## Sigma_k)}.</span></span>
<span id="cb37-26"><a href="building-the-modelalgorithm.html#cb37-26" aria-hidden="true"></a>  calculate_dens &lt;-<span class="st"> </span><span class="cf">function</span>(iclust, tt, y, mn, sigma, denslist_by_clust,</span>
<span id="cb37-27"><a href="building-the-modelalgorithm.html#cb37-27" aria-hidden="true"></a>                             first_iter) {</span>
<span id="cb37-28"><a href="building-the-modelalgorithm.html#cb37-28" aria-hidden="true"></a>    mu &lt;-<span class="st"> </span>mn[tt, , iclust]</span>
<span id="cb37-29"><a href="building-the-modelalgorithm.html#cb37-29" aria-hidden="true"></a>    <span class="cf">if</span> (dimdat <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) {</span>
<span id="cb37-30"><a href="building-the-modelalgorithm.html#cb37-30" aria-hidden="true"></a>      dens =<span class="st"> </span><span class="kw">dnorm</span>(y, mu, <span class="dt">sd =</span> <span class="kw">sqrt</span>(sigma[iclust, , ]))</span>
<span id="cb37-31"><a href="building-the-modelalgorithm.html#cb37-31" aria-hidden="true"></a>    } <span class="cf">else</span> {</span>
<span id="cb37-32"><a href="building-the-modelalgorithm.html#cb37-32" aria-hidden="true"></a>       dens =<span class="st"> </span><span class="kw">dmvnorm_arma_fast</span>(y, mu, sigma[iclust,,], <span class="ot">FALSE</span>)</span>
<span id="cb37-33"><a href="building-the-modelalgorithm.html#cb37-33" aria-hidden="true"></a>    }</span>
<span id="cb37-34"><a href="building-the-modelalgorithm.html#cb37-34" aria-hidden="true"></a>    <span class="kw">return</span>(dens)</span>
<span id="cb37-35"><a href="building-the-modelalgorithm.html#cb37-35" aria-hidden="true"></a>  }</span>
<span id="cb37-36"><a href="building-the-modelalgorithm.html#cb37-36" aria-hidden="true"></a>  <span class="co">## Calculate posterior probability of membership of $y_{it}$.</span></span>
<span id="cb37-37"><a href="building-the-modelalgorithm.html#cb37-37" aria-hidden="true"></a>  ncol.prob =<span class="st"> </span><span class="kw">ncol</span>(prob)</span>
<span id="cb37-38"><a href="building-the-modelalgorithm.html#cb37-38" aria-hidden="true"></a>  <span class="cf">for</span> (tt <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>TT) {</span>
<span id="cb37-39"><a href="building-the-modelalgorithm.html#cb37-39" aria-hidden="true"></a>    ylist_tt =<span class="st"> </span>ylist[[tt]]</span>
<span id="cb37-40"><a href="building-the-modelalgorithm.html#cb37-40" aria-hidden="true"></a>    densmat &lt;-<span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span>numclust, calculate_dens, tt, ylist_tt,</span>
<span id="cb37-41"><a href="building-the-modelalgorithm.html#cb37-41" aria-hidden="true"></a>                      mn, sigma, denslist_by_clust, first_iter)</span>
<span id="cb37-42"><a href="building-the-modelalgorithm.html#cb37-42" aria-hidden="true"></a>    wt.densmat &lt;-<span class="st"> </span><span class="kw">matrix</span>(prob[tt, ], <span class="dt">nrow =</span> ntlist[tt],</span>
<span id="cb37-43"><a href="building-the-modelalgorithm.html#cb37-43" aria-hidden="true"></a>                         <span class="dt">ncol =</span> ncol.prob, <span class="dt">byrow =</span> <span class="ot">TRUE</span>) <span class="op">*</span><span class="st"> </span>densmat</span>
<span id="cb37-44"><a href="building-the-modelalgorithm.html#cb37-44" aria-hidden="true"></a>    wt.densmat =<span class="st"> </span>wt.densmat <span class="op">+</span><span class="st"> </span><span class="fl">1e-20</span></span>
<span id="cb37-45"><a href="building-the-modelalgorithm.html#cb37-45" aria-hidden="true"></a>    wt.densmat &lt;-<span class="st"> </span>wt.densmat<span class="op">/</span><span class="kw">rowSums</span>(wt.densmat)</span>
<span id="cb37-46"><a href="building-the-modelalgorithm.html#cb37-46" aria-hidden="true"></a>    resp[[tt]] &lt;-<span class="st"> </span>wt.densmat</span>
<span id="cb37-47"><a href="building-the-modelalgorithm.html#cb37-47" aria-hidden="true"></a>  }</span>
<span id="cb37-48"><a href="building-the-modelalgorithm.html#cb37-48" aria-hidden="true"></a></span>
<span id="cb37-49"><a href="building-the-modelalgorithm.html#cb37-49" aria-hidden="true"></a>  <span class="co">## Weight the responsibilities by $C_{it}$.</span></span>
<span id="cb37-50"><a href="building-the-modelalgorithm.html#cb37-50" aria-hidden="true"></a>  <span class="cf">if</span> (<span class="op">!</span><span class="kw">is.null</span>(countslist)) {</span>
<span id="cb37-51"><a href="building-the-modelalgorithm.html#cb37-51" aria-hidden="true"></a>    resp &lt;-<span class="st"> </span><span class="kw">Map</span>(<span class="cf">function</span>(myresp, mycount) {</span>
<span id="cb37-52"><a href="building-the-modelalgorithm.html#cb37-52" aria-hidden="true"></a>      myresp <span class="op">*</span><span class="st"> </span>mycount</span>
<span id="cb37-53"><a href="building-the-modelalgorithm.html#cb37-53" aria-hidden="true"></a>    }, resp, countslist)</span>
<span id="cb37-54"><a href="building-the-modelalgorithm.html#cb37-54" aria-hidden="true"></a>  }</span>
<span id="cb37-55"><a href="building-the-modelalgorithm.html#cb37-55" aria-hidden="true"></a>  <span class="kw">return</span>(resp)</span>
<span id="cb37-56"><a href="building-the-modelalgorithm.html#cb37-56" aria-hidden="true"></a>}</span></code></pre></div>
<p>The E step should return a list of exactly the same size and format as <code>ylist</code>,
which is a <span class="math inline">\(T\)</span> -length list of matrices of size <span class="math inline">\(n_t \times d\)</span>.</p>
<p>(This test fails for some reason; will come back to this.)</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="building-the-modelalgorithm.html#cb38-1" aria-hidden="true"></a>testthat<span class="op">::</span><span class="kw">test_that</span>(<span class="st">"E step returns appropriately sized responsibilities."</span>,{</span>
<span id="cb38-2"><a href="building-the-modelalgorithm.html#cb38-2" aria-hidden="true"></a>  </span>
<span id="cb38-3"><a href="building-the-modelalgorithm.html#cb38-3" aria-hidden="true"></a>  <span class="co">## Generate some fake data</span></span>
<span id="cb38-4"><a href="building-the-modelalgorithm.html#cb38-4" aria-hidden="true"></a>  TT =<span class="st"> </span><span class="dv">10</span></span>
<span id="cb38-5"><a href="building-the-modelalgorithm.html#cb38-5" aria-hidden="true"></a>  ylist =<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>TT, <span class="cf">function</span>(tt){ <span class="kw">runif</span>(<span class="dv">90</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">matrix</span>(<span class="dt">ncol =</span> <span class="dv">3</span>, <span class="dt">nrow =</span> <span class="dv">30</span>)})</span>
<span id="cb38-6"><a href="building-the-modelalgorithm.html#cb38-6" aria-hidden="true"></a>  numclust =<span class="st"> </span><span class="dv">3</span></span>
<span id="cb38-7"><a href="building-the-modelalgorithm.html#cb38-7" aria-hidden="true"></a>  dimdat =<span class="st"> </span><span class="dv">3</span></span>
<span id="cb38-8"><a href="building-the-modelalgorithm.html#cb38-8" aria-hidden="true"></a></span>
<span id="cb38-9"><a href="building-the-modelalgorithm.html#cb38-9" aria-hidden="true"></a>  <span class="co">## Initialize a few parameters, not carefully</span></span>
<span id="cb38-10"><a href="building-the-modelalgorithm.html#cb38-10" aria-hidden="true"></a>  sigma =<span class="st"> </span><span class="kw">init_sigma</span>(ylist, numclust) <span class="co">## (T x numclust x (dimdat x dimdat))</span></span>
<span id="cb38-11"><a href="building-the-modelalgorithm.html#cb38-11" aria-hidden="true"></a>  mn =<span class="st"> </span><span class="kw">init_mn</span>(ylist, numclust, TT, dimdat)<span class="co">##, countslist = countslist)</span></span>
<span id="cb38-12"><a href="building-the-modelalgorithm.html#cb38-12" aria-hidden="true"></a>  prob =<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span><span class="op">/</span>numclust, <span class="dt">nrow =</span> TT, <span class="dt">ncol =</span> numclust) <span class="co">## Initialize to all 1/K.</span></span>
<span id="cb38-13"><a href="building-the-modelalgorithm.html#cb38-13" aria-hidden="true"></a></span>
<span id="cb38-14"><a href="building-the-modelalgorithm.html#cb38-14" aria-hidden="true"></a>  <span class="co">## ## Calculate responsibility</span></span>
<span id="cb38-15"><a href="building-the-modelalgorithm.html#cb38-15" aria-hidden="true"></a>  <span class="co">## resp = Estep(mn = mn, sigma = sigma, prob = prob, ylist = ylist, numclust = numclust)</span></span>
<span id="cb38-16"><a href="building-the-modelalgorithm.html#cb38-16" aria-hidden="true"></a></span>
<span id="cb38-17"><a href="building-the-modelalgorithm.html#cb38-17" aria-hidden="true"></a>  <span class="co">## Check these things</span></span>
<span id="cb38-18"><a href="building-the-modelalgorithm.html#cb38-18" aria-hidden="true"></a>  <span class="co">## testthat::expect_equal(length(resp), length(ylist))</span></span>
<span id="cb38-19"><a href="building-the-modelalgorithm.html#cb38-19" aria-hidden="true"></a>  <span class="co">## ?testthat::expect_equal</span></span>
<span id="cb38-20"><a href="building-the-modelalgorithm.html#cb38-20" aria-hidden="true"></a>  <span class="co">## testthat::expect_equal(sapply(resp, dim), sapply(ylist, dim), reporter = "stop")</span></span>
<span id="cb38-21"><a href="building-the-modelalgorithm.html#cb38-21" aria-hidden="true"></a>})</span></code></pre></div>
</div>
<div id="m-step" class="section level2 hasAnchor" number="3.5">
<h2>
<span class="header-section-number">3.5</span> M step<a href="building-the-modelalgorithm.html#m-step" class="anchor-section" aria-label="Anchor link to header"></a>
</h2>
<p>The M step of the EM algorithm has three steps – one each for <span class="math inline">\(\mu\)</span>, <span class="math inline">\(\pi\)</span>, and
<span class="math inline">\(\Sigma\)</span>.</p>
<div id="m-step-for-pi" class="section level3 hasAnchor" number="3.5.1">
<h3>
<span class="header-section-number">3.5.1</span> M step for <span class="math inline">\(\pi\)</span><a href="building-the-modelalgorithm.html#m-step-for-pi" class="anchor-section" aria-label="Anchor link to header"></a>
</h3>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="building-the-modelalgorithm.html#cb39-1" aria-hidden="true"></a><span class="co">#' The M step for the cluster probabilities</span></span>
<span id="cb39-2"><a href="building-the-modelalgorithm.html#cb39-2" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb39-3"><a href="building-the-modelalgorithm.html#cb39-3" aria-hidden="true"></a><span class="co">#' @param resp Responsibilities.</span></span>
<span id="cb39-4"><a href="building-the-modelalgorithm.html#cb39-4" aria-hidden="true"></a><span class="co">#' @param H_tf Trend filtering matrix.</span></span>
<span id="cb39-5"><a href="building-the-modelalgorithm.html#cb39-5" aria-hidden="true"></a><span class="co">#' @param countslist Particle multiplicities.</span></span>
<span id="cb39-6"><a href="building-the-modelalgorithm.html#cb39-6" aria-hidden="true"></a><span class="co">#' @param lambda_prob Regularization. </span></span>
<span id="cb39-7"><a href="building-the-modelalgorithm.html#cb39-7" aria-hidden="true"></a><span class="co">#' @param l_prob Trend filtering degree.</span></span>
<span id="cb39-8"><a href="building-the-modelalgorithm.html#cb39-8" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb39-9"><a href="building-the-modelalgorithm.html#cb39-9" aria-hidden="true"></a><span class="co">#' @return (T x k) matrix containing the alphas, for \code{prob = exp(alpha)/</span></span>
<span id="cb39-10"><a href="building-the-modelalgorithm.html#cb39-10" aria-hidden="true"></a><span class="co">#'         rowSums(exp(alpha))}. </span></span>
<span id="cb39-11"><a href="building-the-modelalgorithm.html#cb39-11" aria-hidden="true"></a><span class="co">#' @export</span></span>
<span id="cb39-12"><a href="building-the-modelalgorithm.html#cb39-12" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb39-13"><a href="building-the-modelalgorithm.html#cb39-13" aria-hidden="true"></a>Mstep_prob &lt;-<span class="st"> </span><span class="cf">function</span>(resp, H_tf, <span class="dt">countslist =</span> <span class="ot">NULL</span>,</span>
<span id="cb39-14"><a href="building-the-modelalgorithm.html#cb39-14" aria-hidden="true"></a>                       <span class="dt">lambda_prob =</span> <span class="ot">NULL</span>, <span class="dt">l_prob =</span> <span class="ot">NULL</span>, <span class="dt">x =</span> <span class="ot">NULL</span>){</span>
<span id="cb39-15"><a href="building-the-modelalgorithm.html#cb39-15" aria-hidden="true"></a></span>
<span id="cb39-16"><a href="building-the-modelalgorithm.html#cb39-16" aria-hidden="true"></a>  <span class="co">## Basic setup</span></span>
<span id="cb39-17"><a href="building-the-modelalgorithm.html#cb39-17" aria-hidden="true"></a>  TT &lt;-<span class="st"> </span><span class="kw">length</span>(resp)</span>
<span id="cb39-18"><a href="building-the-modelalgorithm.html#cb39-18" aria-hidden="true"></a></span>
<span id="cb39-19"><a href="building-the-modelalgorithm.html#cb39-19" aria-hidden="true"></a>  <span class="co">## Basic checks</span></span>
<span id="cb39-20"><a href="building-the-modelalgorithm.html#cb39-20" aria-hidden="true"></a>  <span class="kw">stopifnot</span>(<span class="kw">is.null</span>(l_prob) <span class="op">==</span><span class="st"> </span><span class="kw">is.null</span>(lambda_prob))</span>
<span id="cb39-21"><a href="building-the-modelalgorithm.html#cb39-21" aria-hidden="true"></a></span>
<span id="cb39-22"><a href="building-the-modelalgorithm.html#cb39-22" aria-hidden="true"></a>  <span class="co">## If glmnet isn't actually needed, don't use it.</span></span>
<span id="cb39-23"><a href="building-the-modelalgorithm.html#cb39-23" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="kw">is.null</span>(l_prob) <span class="op">&amp;</span><span class="st"> </span><span class="kw">is.null</span>(lambda_prob)){</span>
<span id="cb39-24"><a href="building-the-modelalgorithm.html#cb39-24" aria-hidden="true"></a></span>
<span id="cb39-25"><a href="building-the-modelalgorithm.html#cb39-25" aria-hidden="true"></a>    <span class="co">## Calculate the average responsibilities, per time point.</span></span>
<span id="cb39-26"><a href="building-the-modelalgorithm.html#cb39-26" aria-hidden="true"></a>    <span class="cf">if</span>(<span class="kw">is.null</span>(countslist)){</span>
<span id="cb39-27"><a href="building-the-modelalgorithm.html#cb39-27" aria-hidden="true"></a>      resp.avg &lt;-<span class="st"> </span><span class="kw">lapply</span>(resp, colMeans) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">do.call</span>(rbind, .)</span>
<span id="cb39-28"><a href="building-the-modelalgorithm.html#cb39-28" aria-hidden="true"></a>    } <span class="cf">else</span> {</span>
<span id="cb39-29"><a href="building-the-modelalgorithm.html#cb39-29" aria-hidden="true"></a>      resp.avg &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>TT, <span class="dt">FUN =</span> <span class="cf">function</span>(ii){</span>
<span id="cb39-30"><a href="building-the-modelalgorithm.html#cb39-30" aria-hidden="true"></a>        <span class="kw">colSums</span>(resp[[ii]])<span class="op">/</span><span class="kw">sum</span>(countslist[[ii]])</span>
<span id="cb39-31"><a href="building-the-modelalgorithm.html#cb39-31" aria-hidden="true"></a>      }) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">do.call</span>(rbind, .)</span>
<span id="cb39-32"><a href="building-the-modelalgorithm.html#cb39-32" aria-hidden="true"></a>    }</span>
<span id="cb39-33"><a href="building-the-modelalgorithm.html#cb39-33" aria-hidden="true"></a>    <span class="kw">return</span>(resp.avg) </span>
<span id="cb39-34"><a href="building-the-modelalgorithm.html#cb39-34" aria-hidden="true"></a></span>
<span id="cb39-35"><a href="building-the-modelalgorithm.html#cb39-35" aria-hidden="true"></a>  <span class="co">## If glmnet is needed, use it.</span></span>
<span id="cb39-36"><a href="building-the-modelalgorithm.html#cb39-36" aria-hidden="true"></a>  } <span class="cf">else</span> {</span>
<span id="cb39-37"><a href="building-the-modelalgorithm.html#cb39-37" aria-hidden="true"></a></span>
<span id="cb39-38"><a href="building-the-modelalgorithm.html#cb39-38" aria-hidden="true"></a>    lambda_range &lt;-<span class="st"> </span><span class="cf">function</span>(lam, <span class="dt">nlam =</span> <span class="dv">50</span>, <span class="dt">lam.max =</span> <span class="kw">max</span>(<span class="dv">1</span>, <span class="dv">5</span><span class="op">*</span>lam)){</span>
<span id="cb39-39"><a href="building-the-modelalgorithm.html#cb39-39" aria-hidden="true"></a>      <span class="kw">return</span>(<span class="kw">exp</span>(<span class="kw">seq</span>(<span class="kw">log</span>(lam.max), <span class="kw">log</span>(lam), <span class="dt">length.out =</span> nlam)))</span>
<span id="cb39-40"><a href="building-the-modelalgorithm.html#cb39-40" aria-hidden="true"></a>    }</span>
<span id="cb39-41"><a href="building-the-modelalgorithm.html#cb39-41" aria-hidden="true"></a></span>
<span id="cb39-42"><a href="building-the-modelalgorithm.html#cb39-42" aria-hidden="true"></a>    penalty.facs &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">0</span>, l_prob<span class="op">+</span><span class="dv">1</span>), <span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">nrow</span>(H_tf) <span class="op">-</span><span class="st"> </span>l_prob <span class="op">-</span><span class="st"> </span><span class="dv">1</span>))</span>
<span id="cb39-43"><a href="building-the-modelalgorithm.html#cb39-43" aria-hidden="true"></a>    resp.predict &lt;-<span class="st"> </span><span class="kw">do.call</span>(rbind, <span class="kw">lapply</span>(resp, colSums))</span>
<span id="cb39-44"><a href="building-the-modelalgorithm.html#cb39-44" aria-hidden="true"></a>    glmnet_obj &lt;-<span class="st"> </span>glmnet<span class="op">::</span><span class="kw">glmnet</span>(<span class="dt">x =</span> H_tf, <span class="dt">y =</span> resp.predict, <span class="dt">family =</span> <span class="st">"multinomial"</span>,</span>
<span id="cb39-45"><a href="building-the-modelalgorithm.html#cb39-45" aria-hidden="true"></a>                                 <span class="dt">penalty.factor =</span> penalty.facs, <span class="dt">maxit =</span> <span class="fl">1e7</span>,</span>
<span id="cb39-46"><a href="building-the-modelalgorithm.html#cb39-46" aria-hidden="true"></a>                                 <span class="dt">lambda =</span>  <span class="kw">mean</span>(penalty.facs)<span class="op">*</span><span class="kw">lambda_range</span>(lambda_prob),</span>
<span id="cb39-47"><a href="building-the-modelalgorithm.html#cb39-47" aria-hidden="true"></a>                                 <span class="dt">standardize =</span> F, <span class="dt">intercept =</span> <span class="ot">FALSE</span>) </span>
<span id="cb39-48"><a href="building-the-modelalgorithm.html#cb39-48" aria-hidden="true"></a>    pred_link &lt;-<span class="st"> </span><span class="kw">predict</span>(glmnet_obj, <span class="dt">newx =</span> H_tf, <span class="dt">type =</span> <span class="st">"link"</span>, <span class="dt">s =</span> <span class="kw">mean</span>(penalty.facs) <span class="op">*</span><span class="st"> </span>lambda_prob)[,,<span class="dv">1</span>]</span>
<span id="cb39-49"><a href="building-the-modelalgorithm.html#cb39-49" aria-hidden="true"></a>    <span class="kw">return</span>(pred_link)</span>
<span id="cb39-50"><a href="building-the-modelalgorithm.html#cb39-50" aria-hidden="true"></a>  }</span>
<span id="cb39-51"><a href="building-the-modelalgorithm.html#cb39-51" aria-hidden="true"></a>}</span></code></pre></div>
<p>This should return a <span class="math inline">\(T\)</span> by <span class="math inline">\(K\)</span> matrix, which we’ll test here:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="building-the-modelalgorithm.html#cb40-1" aria-hidden="true"></a>testthat<span class="op">::</span><span class="kw">test_that</span>(<span class="st">"Mstep of pi returns a (T x K) matrix."</span>, {</span>
<span id="cb40-2"><a href="building-the-modelalgorithm.html#cb40-2" aria-hidden="true"></a></span>
<span id="cb40-3"><a href="building-the-modelalgorithm.html#cb40-3" aria-hidden="true"></a>  <span class="co">## Generate some fake responsibilities and trend filtering matrix</span></span>
<span id="cb40-4"><a href="building-the-modelalgorithm.html#cb40-4" aria-hidden="true"></a>  TT =<span class="st"> </span><span class="dv">100</span></span>
<span id="cb40-5"><a href="building-the-modelalgorithm.html#cb40-5" aria-hidden="true"></a>  numclust =<span class="st"> </span><span class="dv">3</span></span>
<span id="cb40-6"><a href="building-the-modelalgorithm.html#cb40-6" aria-hidden="true"></a>  nt =<span class="st"> </span><span class="dv">10</span></span>
<span id="cb40-7"><a href="building-the-modelalgorithm.html#cb40-7" aria-hidden="true"></a>  resp =<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>TT, <span class="cf">function</span>(tt){</span>
<span id="cb40-8"><a href="building-the-modelalgorithm.html#cb40-8" aria-hidden="true"></a>    oneresp =<span class="st"> </span><span class="kw">runif</span>(nt<span class="op">*</span>numclust) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">matrix</span>(<span class="dt">ncol=</span>numclust)</span>
<span id="cb40-9"><a href="building-the-modelalgorithm.html#cb40-9" aria-hidden="true"></a>    oneresp =<span class="st"> </span>oneresp<span class="op">/</span><span class="kw">rowSums</span>(oneresp)</span>
<span id="cb40-10"><a href="building-the-modelalgorithm.html#cb40-10" aria-hidden="true"></a>  })</span>
<span id="cb40-11"><a href="building-the-modelalgorithm.html#cb40-11" aria-hidden="true"></a>  H_tf &lt;-<span class="st"> </span><span class="kw">gen_tf_mat</span>(<span class="dt">n =</span> TT, <span class="dt">k =</span> <span class="dv">0</span>)</span>
<span id="cb40-12"><a href="building-the-modelalgorithm.html#cb40-12" aria-hidden="true"></a></span>
<span id="cb40-13"><a href="building-the-modelalgorithm.html#cb40-13" aria-hidden="true"></a>  <span class="co">## Check the size</span></span>
<span id="cb40-14"><a href="building-the-modelalgorithm.html#cb40-14" aria-hidden="true"></a>  pred_link =<span class="st"> </span><span class="kw">Mstep_prob</span>(resp, H_tf, <span class="dt">l_prob =</span> <span class="dv">0</span>, <span class="dt">lambda_prob =</span> <span class="fl">1E-3</span>)</span>
<span id="cb40-15"><a href="building-the-modelalgorithm.html#cb40-15" aria-hidden="true"></a>  testthat<span class="op">::</span><span class="kw">expect_equal</span>(<span class="kw">dim</span>(pred_link), <span class="kw">c</span>(TT, numclust))</span>
<span id="cb40-16"><a href="building-the-modelalgorithm.html#cb40-16" aria-hidden="true"></a>  pred_link =<span class="st"> </span><span class="kw">Mstep_prob</span>(resp, H_tf)</span>
<span id="cb40-17"><a href="building-the-modelalgorithm.html#cb40-17" aria-hidden="true"></a>  testthat<span class="op">::</span><span class="kw">expect_equal</span>(<span class="kw">dim</span>(pred_link), <span class="kw">c</span>(TT, numclust))</span>
<span id="cb40-18"><a href="building-the-modelalgorithm.html#cb40-18" aria-hidden="true"></a></span>
<span id="cb40-19"><a href="building-the-modelalgorithm.html#cb40-19" aria-hidden="true"></a>  <span class="co">## Check the correctness</span></span>
<span id="cb40-20"><a href="building-the-modelalgorithm.html#cb40-20" aria-hidden="true"></a>  pred_link =<span class="st"> </span><span class="kw">Mstep_prob</span>(resp, H_tf)</span>
<span id="cb40-21"><a href="building-the-modelalgorithm.html#cb40-21" aria-hidden="true"></a>})</span></code></pre></div>
<p>Each row of this matrix should contain the fitted values <span class="math inline">\(\alpha_k \in \mathbb{R}^3\)</span> where <span class="math inline">\(\alpha_{kt} = h_t^T w_{k}\)</span>, for..</p>
<ul>
<li><p><span class="math inline">\(h_t\)</span> that are rows of the trend filtering matrix <span class="math inline">\(H \in \mathbb{R}^{T \times T}\)</span>.</p></li>
<li><p><span class="math inline">\(w_k \in \mathbb{R}^{n}\)</span> that are the regression coefficients estimated by
<code>glmnet()</code>.</p></li>
</ul>
<p>Here is a test for the correctness of the M step for <span class="math inline">\(\pi\)</span>.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="building-the-modelalgorithm.html#cb41-1" aria-hidden="true"></a>testthat<span class="op">::</span><span class="kw">test_that</span>(<span class="st">"Test the M step of \pi against CVXR"</span>, {})</span></code></pre></div>
</div>
<div id="m-step-for-sigma" class="section level3 hasAnchor" number="3.5.2">
<h3>
<span class="header-section-number">3.5.2</span> M step for <span class="math inline">\(\Sigma\)</span><a href="building-the-modelalgorithm.html#m-step-for-sigma" class="anchor-section" aria-label="Anchor link to header"></a>
</h3>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="building-the-modelalgorithm.html#cb42-1" aria-hidden="true"></a><span class="co">#' M step for cluster covariance (sigma).</span></span>
<span id="cb42-2"><a href="building-the-modelalgorithm.html#cb42-2" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb42-3"><a href="building-the-modelalgorithm.html#cb42-3" aria-hidden="true"></a><span class="co">#' @param resp Responsibility.</span></span>
<span id="cb42-4"><a href="building-the-modelalgorithm.html#cb42-4" aria-hidden="true"></a><span class="co">#' @param ylist Data.</span></span>
<span id="cb42-5"><a href="building-the-modelalgorithm.html#cb42-5" aria-hidden="true"></a><span class="co">#' @param mn Means</span></span>
<span id="cb42-6"><a href="building-the-modelalgorithm.html#cb42-6" aria-hidden="true"></a><span class="co">#' @param numclust Number of clusters.</span></span>
<span id="cb42-7"><a href="building-the-modelalgorithm.html#cb42-7" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb42-8"><a href="building-the-modelalgorithm.html#cb42-8" aria-hidden="true"></a><span class="co">#' @return (K x d x d) array containing K (d x d) covariance matrices.</span></span>
<span id="cb42-9"><a href="building-the-modelalgorithm.html#cb42-9" aria-hidden="true"></a><span class="co">#' @export</span></span>
<span id="cb42-10"><a href="building-the-modelalgorithm.html#cb42-10" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb42-11"><a href="building-the-modelalgorithm.html#cb42-11" aria-hidden="true"></a><span class="co">#' @examples</span></span>
<span id="cb42-12"><a href="building-the-modelalgorithm.html#cb42-12" aria-hidden="true"></a>Mstep_sigma &lt;-<span class="st"> </span><span class="cf">function</span>(resp, ylist, mn, numclust){</span>
<span id="cb42-13"><a href="building-the-modelalgorithm.html#cb42-13" aria-hidden="true"></a></span>
<span id="cb42-14"><a href="building-the-modelalgorithm.html#cb42-14" aria-hidden="true"></a>  <span class="co">## Find some sizes</span></span>
<span id="cb42-15"><a href="building-the-modelalgorithm.html#cb42-15" aria-hidden="true"></a>  TT =<span class="st"> </span><span class="kw">length</span>(ylist)</span>
<span id="cb42-16"><a href="building-the-modelalgorithm.html#cb42-16" aria-hidden="true"></a>  ntlist =<span class="st"> </span><span class="kw">sapply</span>(ylist, nrow)</span>
<span id="cb42-17"><a href="building-the-modelalgorithm.html#cb42-17" aria-hidden="true"></a>  dimdat =<span class="st"> </span><span class="kw">ncol</span>(ylist[[<span class="dv">1</span>]])</span>
<span id="cb42-18"><a href="building-the-modelalgorithm.html#cb42-18" aria-hidden="true"></a>  cs =<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">cumsum</span>(ntlist))</span>
<span id="cb42-19"><a href="building-the-modelalgorithm.html#cb42-19" aria-hidden="true"></a></span>
<span id="cb42-20"><a href="building-the-modelalgorithm.html#cb42-20" aria-hidden="true"></a>  <span class="co">## Set up empty residual matrix (to be reused)</span></span>
<span id="cb42-21"><a href="building-the-modelalgorithm.html#cb42-21" aria-hidden="true"></a>  cs =<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">cumsum</span>(ntlist))</span>
<span id="cb42-22"><a href="building-the-modelalgorithm.html#cb42-22" aria-hidden="true"></a>  vars &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="dt">mode =</span> <span class="st">"list"</span>, numclust)</span>
<span id="cb42-23"><a href="building-the-modelalgorithm.html#cb42-23" aria-hidden="true"></a>  ylong =<span class="st"> </span><span class="kw">do.call</span>(rbind, ylist)</span>
<span id="cb42-24"><a href="building-the-modelalgorithm.html#cb42-24" aria-hidden="true"></a>  ntlist =<span class="st"> </span><span class="kw">sapply</span>(ylist, nrow)</span>
<span id="cb42-25"><a href="building-the-modelalgorithm.html#cb42-25" aria-hidden="true"></a>  irows =<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(mn), <span class="dt">times =</span> ntlist)</span>
<span id="cb42-26"><a href="building-the-modelalgorithm.html#cb42-26" aria-hidden="true"></a></span>
<span id="cb42-27"><a href="building-the-modelalgorithm.html#cb42-27" aria-hidden="true"></a>  <span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>numclust){</span>
<span id="cb42-28"><a href="building-the-modelalgorithm.html#cb42-28" aria-hidden="true"></a>    resp.thisclust =<span class="st"> </span><span class="kw">lapply</span>(resp, <span class="cf">function</span>(myresp) myresp[,iclust, <span class="dt">drop =</span> <span class="ot">TRUE</span>])</span>
<span id="cb42-29"><a href="building-the-modelalgorithm.html#cb42-29" aria-hidden="true"></a>    resp.long =<span class="st"> </span><span class="kw">do.call</span>(c, resp.thisclust)</span>
<span id="cb42-30"><a href="building-the-modelalgorithm.html#cb42-30" aria-hidden="true"></a>    mnlong =<span class="st"> </span>mn[irows,,iclust]</span>
<span id="cb42-31"><a href="building-the-modelalgorithm.html#cb42-31" aria-hidden="true"></a>    <span class="cf">if</span>(<span class="kw">is.vector</span>(mnlong)) mnlong =<span class="st"> </span>mnlong <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">cbind</span>()</span>
<span id="cb42-32"><a href="building-the-modelalgorithm.html#cb42-32" aria-hidden="true"></a>    resid &lt;-<span class="st"> </span>ylong <span class="op">-</span><span class="st"> </span>mnlong</span>
<span id="cb42-33"><a href="building-the-modelalgorithm.html#cb42-33" aria-hidden="true"></a>    resid_weighted &lt;-<span class="st"> </span>resp.long <span class="op">*</span><span class="st"> </span>resid</span>
<span id="cb42-34"><a href="building-the-modelalgorithm.html#cb42-34" aria-hidden="true"></a>    sig_temp &lt;-<span class="st"> </span><span class="kw">t</span>(resid_weighted) <span class="op">%*%</span><span class="st"> </span>resid<span class="op">/</span><span class="kw">sum</span>(resp.long)</span>
<span id="cb42-35"><a href="building-the-modelalgorithm.html#cb42-35" aria-hidden="true"></a>    vars[[iclust]] &lt;-<span class="st"> </span>sig_temp</span>
<span id="cb42-36"><a href="building-the-modelalgorithm.html#cb42-36" aria-hidden="true"></a>  }</span>
<span id="cb42-37"><a href="building-the-modelalgorithm.html#cb42-37" aria-hidden="true"></a></span>
<span id="cb42-38"><a href="building-the-modelalgorithm.html#cb42-38" aria-hidden="true"></a>  <span class="co">## Make into an array</span></span>
<span id="cb42-39"><a href="building-the-modelalgorithm.html#cb42-39" aria-hidden="true"></a>  sigma_array =<span class="st"> </span><span class="kw">array</span>(<span class="ot">NA</span>, <span class="dt">dim=</span><span class="kw">c</span>(numclust, dimdat, dimdat))</span>
<span id="cb42-40"><a href="building-the-modelalgorithm.html#cb42-40" aria-hidden="true"></a>  <span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>numclust){</span>
<span id="cb42-41"><a href="building-the-modelalgorithm.html#cb42-41" aria-hidden="true"></a>    sigma_array[iclust,,] =<span class="st"> </span>vars[[iclust]]</span>
<span id="cb42-42"><a href="building-the-modelalgorithm.html#cb42-42" aria-hidden="true"></a>  }</span>
<span id="cb42-43"><a href="building-the-modelalgorithm.html#cb42-43" aria-hidden="true"></a></span>
<span id="cb42-44"><a href="building-the-modelalgorithm.html#cb42-44" aria-hidden="true"></a>  <span class="co">## Basic check</span></span>
<span id="cb42-45"><a href="building-the-modelalgorithm.html#cb42-45" aria-hidden="true"></a>  <span class="kw">stopifnot</span>(<span class="kw">all</span>(<span class="kw">dim</span>(sigma_array) <span class="op">==</span><span class="st"> </span><span class="kw">c</span>(numclust, dimdat, dimdat)))</span>
<span id="cb42-46"><a href="building-the-modelalgorithm.html#cb42-46" aria-hidden="true"></a>  <span class="kw">return</span>(sigma_array)</span>
<span id="cb42-47"><a href="building-the-modelalgorithm.html#cb42-47" aria-hidden="true"></a>}</span></code></pre></div>
</div>
<div id="m-step-for-mu" class="section level3 hasAnchor" number="3.5.3">
<h3>
<span class="header-section-number">3.5.3</span> M step for <span class="math inline">\(\mu\)</span><a href="building-the-modelalgorithm.html#m-step-for-mu" class="anchor-section" aria-label="Anchor link to header"></a>
</h3>
<p>This is a big one. It uses the ADMM algorithm as written in section OO (TODO:
fill in) of the paper, reproduced briefly here.</p>
<p>We need a convergence checker for the outer layer of LA-ADMM, which checks
whether the objective values have plateaued.</p>
<p>Next, we define the main function <code>Mstep_mu()</code>. This uses a “locally-adaptive” ADMM <a href="https://proceedings.neurips.cc/paper_files/paper/2017/file/e97ee2054defb209c35fe4dc94599061-Paper.pdf">paper</a>. <code>M-step_mu()</code> calls <code>la_admm_oneclust()</code> on each cluster <span class="math inline">\(k=1,\cdots, K\)</span>; this function will be introduced shortly.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="building-the-modelalgorithm.html#cb43-1" aria-hidden="true"></a><span class="co">#' Computes the M step for mu. </span><span class="al">TODO</span><span class="co">: use templates for the argument. As shown</span></span>
<span id="cb43-2"><a href="building-the-modelalgorithm.html#cb43-2" aria-hidden="true"></a><span class="co">#' here:</span></span>
<span id="cb43-3"><a href="building-the-modelalgorithm.html#cb43-3" aria-hidden="true"></a><span class="co">#' https://stackoverflow.com/questions/15100129/using-roxygen2-template-tags</span></span>
<span id="cb43-4"><a href="building-the-modelalgorithm.html#cb43-4" aria-hidden="true"></a><span class="co">#' </span></span>
<span id="cb43-5"><a href="building-the-modelalgorithm.html#cb43-5" aria-hidden="true"></a><span class="co">#' @param resp Responsbilities of each particle.</span></span>
<span id="cb43-6"><a href="building-the-modelalgorithm.html#cb43-6" aria-hidden="true"></a><span class="co">#' @param ylist </span></span>
<span id="cb43-7"><a href="building-the-modelalgorithm.html#cb43-7" aria-hidden="true"></a><span class="co">#' @param lambda</span></span>
<span id="cb43-8"><a href="building-the-modelalgorithm.html#cb43-8" aria-hidden="true"></a><span class="co">#' @param l</span></span>
<span id="cb43-9"><a href="building-the-modelalgorithm.html#cb43-9" aria-hidden="true"></a><span class="co">#' @param sigma</span></span>
<span id="cb43-10"><a href="building-the-modelalgorithm.html#cb43-10" aria-hidden="true"></a><span class="co">#' @param sigma_eig_by_clust</span></span>
<span id="cb43-11"><a href="building-the-modelalgorithm.html#cb43-11" aria-hidden="true"></a><span class="co">#' @param Dl</span></span>
<span id="cb43-12"><a href="building-the-modelalgorithm.html#cb43-12" aria-hidden="true"></a><span class="co">#' @param Dlp1</span></span>
<span id="cb43-13"><a href="building-the-modelalgorithm.html#cb43-13" aria-hidden="true"></a><span class="co">#' @param TT</span></span>
<span id="cb43-14"><a href="building-the-modelalgorithm.html#cb43-14" aria-hidden="true"></a><span class="co">#' @param N</span></span>
<span id="cb43-15"><a href="building-the-modelalgorithm.html#cb43-15" aria-hidden="true"></a><span class="co">#' @param dimdat</span></span>
<span id="cb43-16"><a href="building-the-modelalgorithm.html#cb43-16" aria-hidden="true"></a><span class="co">#' @param first_iter</span></span>
<span id="cb43-17"><a href="building-the-modelalgorithm.html#cb43-17" aria-hidden="true"></a><span class="co">#' @param mus</span></span>
<span id="cb43-18"><a href="building-the-modelalgorithm.html#cb43-18" aria-hidden="true"></a><span class="co">#' @param Zs</span></span>
<span id="cb43-19"><a href="building-the-modelalgorithm.html#cb43-19" aria-hidden="true"></a><span class="co">#' @param Ws</span></span>
<span id="cb43-20"><a href="building-the-modelalgorithm.html#cb43-20" aria-hidden="true"></a><span class="co">#' @param uws</span></span>
<span id="cb43-21"><a href="building-the-modelalgorithm.html#cb43-21" aria-hidden="true"></a><span class="co">#' @param uzs</span></span>
<span id="cb43-22"><a href="building-the-modelalgorithm.html#cb43-22" aria-hidden="true"></a><span class="co">#' @param maxdev</span></span>
<span id="cb43-23"><a href="building-the-modelalgorithm.html#cb43-23" aria-hidden="true"></a><span class="co">#' @param x</span></span>
<span id="cb43-24"><a href="building-the-modelalgorithm.html#cb43-24" aria-hidden="true"></a><span class="co">#' @param niter</span></span>
<span id="cb43-25"><a href="building-the-modelalgorithm.html#cb43-25" aria-hidden="true"></a><span class="co">#' @param err_rel</span></span>
<span id="cb43-26"><a href="building-the-modelalgorithm.html#cb43-26" aria-hidden="true"></a><span class="co">#' @param err_abs</span></span>
<span id="cb43-27"><a href="building-the-modelalgorithm.html#cb43-27" aria-hidden="true"></a><span class="co">#' @param zerothresh</span></span>
<span id="cb43-28"><a href="building-the-modelalgorithm.html#cb43-28" aria-hidden="true"></a><span class="co">#' @param local_adapt</span></span>
<span id="cb43-29"><a href="building-the-modelalgorithm.html#cb43-29" aria-hidden="true"></a><span class="co">#' @param local_adapt_niter</span></span>
<span id="cb43-30"><a href="building-the-modelalgorithm.html#cb43-30" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb43-31"><a href="building-the-modelalgorithm.html#cb43-31" aria-hidden="true"></a><span class="co">#' @return</span></span>
<span id="cb43-32"><a href="building-the-modelalgorithm.html#cb43-32" aria-hidden="true"></a><span class="co">#' @export</span></span>
<span id="cb43-33"><a href="building-the-modelalgorithm.html#cb43-33" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb43-34"><a href="building-the-modelalgorithm.html#cb43-34" aria-hidden="true"></a><span class="co">#' @examples</span></span>
<span id="cb43-35"><a href="building-the-modelalgorithm.html#cb43-35" aria-hidden="true"></a>Mstep_mu &lt;-<span class="st"> </span><span class="cf">function</span>(resp,</span>
<span id="cb43-36"><a href="building-the-modelalgorithm.html#cb43-36" aria-hidden="true"></a>                     ylist,  </span>
<span id="cb43-37"><a href="building-the-modelalgorithm.html#cb43-37" aria-hidden="true"></a>                     <span class="dt">lambda =</span> <span class="fl">0.5</span>,</span>
<span id="cb43-38"><a href="building-the-modelalgorithm.html#cb43-38" aria-hidden="true"></a>                     <span class="dt">l =</span> <span class="dv">3</span>,</span>
<span id="cb43-39"><a href="building-the-modelalgorithm.html#cb43-39" aria-hidden="true"></a>                     sigma,</span>
<span id="cb43-40"><a href="building-the-modelalgorithm.html#cb43-40" aria-hidden="true"></a>                     <span class="dt">sigma_eig_by_clust =</span> <span class="ot">NULL</span>,</span>
<span id="cb43-41"><a href="building-the-modelalgorithm.html#cb43-41" aria-hidden="true"></a>                     Dlsqrd,</span>
<span id="cb43-42"><a href="building-the-modelalgorithm.html#cb43-42" aria-hidden="true"></a>                     Dl, tDl, Dlp1,  TT, N, dimdat,</span>
<span id="cb43-43"><a href="building-the-modelalgorithm.html#cb43-43" aria-hidden="true"></a>                     <span class="dt">first_iter =</span> <span class="ot">TRUE</span>,</span>
<span id="cb43-44"><a href="building-the-modelalgorithm.html#cb43-44" aria-hidden="true"></a>                     e_mat,</span>
<span id="cb43-45"><a href="building-the-modelalgorithm.html#cb43-45" aria-hidden="true"></a></span>
<span id="cb43-46"><a href="building-the-modelalgorithm.html#cb43-46" aria-hidden="true"></a>                     <span class="co">## Warm startable variables</span></span>
<span id="cb43-47"><a href="building-the-modelalgorithm.html#cb43-47" aria-hidden="true"></a>                     <span class="dt">mus =</span> <span class="ot">NULL</span>,</span>
<span id="cb43-48"><a href="building-the-modelalgorithm.html#cb43-48" aria-hidden="true"></a>                     <span class="dt">Zs =</span> <span class="ot">NULL</span>,</span>
<span id="cb43-49"><a href="building-the-modelalgorithm.html#cb43-49" aria-hidden="true"></a>                     <span class="dt">Ws =</span> <span class="ot">NULL</span>,</span>
<span id="cb43-50"><a href="building-the-modelalgorithm.html#cb43-50" aria-hidden="true"></a>                     <span class="dt">uws =</span> <span class="ot">NULL</span>,</span>
<span id="cb43-51"><a href="building-the-modelalgorithm.html#cb43-51" aria-hidden="true"></a>                     <span class="dt">uzs =</span> <span class="ot">NULL</span>,</span>
<span id="cb43-52"><a href="building-the-modelalgorithm.html#cb43-52" aria-hidden="true"></a>                     <span class="co">## End of warm startable variables</span></span>
<span id="cb43-53"><a href="building-the-modelalgorithm.html#cb43-53" aria-hidden="true"></a></span>
<span id="cb43-54"><a href="building-the-modelalgorithm.html#cb43-54" aria-hidden="true"></a>                     <span class="dt">maxdev =</span> <span class="ot">NULL</span>,</span>
<span id="cb43-55"><a href="building-the-modelalgorithm.html#cb43-55" aria-hidden="true"></a>                     <span class="dt">x =</span> <span class="ot">NULL</span>,</span>
<span id="cb43-56"><a href="building-the-modelalgorithm.html#cb43-56" aria-hidden="true"></a>                     <span class="dt">niter =</span> (<span class="cf">if</span>(local_adapt) <span class="fl">1e2</span> <span class="cf">else</span> <span class="fl">1e3</span>),</span>
<span id="cb43-57"><a href="building-the-modelalgorithm.html#cb43-57" aria-hidden="true"></a>                     <span class="dt">err_rel =</span> <span class="fl">1E-3</span>,</span>
<span id="cb43-58"><a href="building-the-modelalgorithm.html#cb43-58" aria-hidden="true"></a>                     <span class="dt">err_abs =</span> <span class="dv">0</span>,</span>
<span id="cb43-59"><a href="building-the-modelalgorithm.html#cb43-59" aria-hidden="true"></a>                     <span class="dt">zerothresh =</span> <span class="fl">1E-6</span>,</span>
<span id="cb43-60"><a href="building-the-modelalgorithm.html#cb43-60" aria-hidden="true"></a>                     <span class="dt">local_adapt =</span> <span class="ot">FALSE</span>,</span>
<span id="cb43-61"><a href="building-the-modelalgorithm.html#cb43-61" aria-hidden="true"></a>                     <span class="dt">local_adapt_niter =</span> <span class="dv">10</span>,</span>
<span id="cb43-62"><a href="building-the-modelalgorithm.html#cb43-62" aria-hidden="true"></a>                     <span class="dt">rho_init =</span> <span class="fl">0.01</span>,</span>
<span id="cb43-63"><a href="building-the-modelalgorithm.html#cb43-63" aria-hidden="true"></a>                     <span class="dt">iter =</span> <span class="ot">NULL</span>){</span>
<span id="cb43-64"><a href="building-the-modelalgorithm.html#cb43-64" aria-hidden="true"></a></span>
<span id="cb43-65"><a href="building-the-modelalgorithm.html#cb43-65" aria-hidden="true"></a>  <span class="co">####################</span></span>
<span id="cb43-66"><a href="building-the-modelalgorithm.html#cb43-66" aria-hidden="true"></a>  <span class="co">## Preliminaries </span><span class="al">###</span></span>
<span id="cb43-67"><a href="building-the-modelalgorithm.html#cb43-67" aria-hidden="true"></a>  <span class="co">####################</span></span>
<span id="cb43-68"><a href="building-the-modelalgorithm.html#cb43-68" aria-hidden="true"></a>  TT =<span class="st"> </span><span class="kw">length</span>(ylist)</span>
<span id="cb43-69"><a href="building-the-modelalgorithm.html#cb43-69" aria-hidden="true"></a>  numclust =<span class="st"> </span><span class="kw">ncol</span>(resp[[<span class="dv">1</span>]])</span>
<span id="cb43-70"><a href="building-the-modelalgorithm.html#cb43-70" aria-hidden="true"></a>  dimdat =<span class="st"> </span><span class="kw">ncol</span>(ylist[[<span class="dv">1</span>]])</span>
<span id="cb43-71"><a href="building-the-modelalgorithm.html#cb43-71" aria-hidden="true"></a>  ntlist =<span class="st"> </span><span class="kw">sapply</span>(ylist, nrow)</span>
<span id="cb43-72"><a href="building-the-modelalgorithm.html#cb43-72" aria-hidden="true"></a>  resp.sum =<span class="st"> </span><span class="kw">lapply</span>(resp, colSums) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">do.call</span>(rbind, .)</span>
<span id="cb43-73"><a href="building-the-modelalgorithm.html#cb43-73" aria-hidden="true"></a>  N =<span class="st"> </span><span class="kw">sum</span>(<span class="kw">unlist</span>(resp.sum))</span>
<span id="cb43-74"><a href="building-the-modelalgorithm.html#cb43-74" aria-hidden="true"></a></span>
<span id="cb43-75"><a href="building-the-modelalgorithm.html#cb43-75" aria-hidden="true"></a>  <span class="co">## Other preliminaries</span></span>
<span id="cb43-76"><a href="building-the-modelalgorithm.html#cb43-76" aria-hidden="true"></a>  schur_syl_A_by_clust =<span class="st"> </span>schur_syl_B_by_clust =<span class="st"> </span>term3list =<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb43-77"><a href="building-the-modelalgorithm.html#cb43-77" aria-hidden="true"></a>  ybarlist =<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb43-78"><a href="building-the-modelalgorithm.html#cb43-78" aria-hidden="true"></a>  ycentered_list =<span class="st"> </span>Xcentered_list =<span class="st"> </span>yXcentered_list =<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb43-79"><a href="building-the-modelalgorithm.html#cb43-79" aria-hidden="true"></a>  Qlist =<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb43-80"><a href="building-the-modelalgorithm.html#cb43-80" aria-hidden="true"></a>  sigmainv_list =<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb43-81"><a href="building-the-modelalgorithm.html#cb43-81" aria-hidden="true"></a>  <span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>numclust){</span>
<span id="cb43-82"><a href="building-the-modelalgorithm.html#cb43-82" aria-hidden="true"></a></span>
<span id="cb43-83"><a href="building-the-modelalgorithm.html#cb43-83" aria-hidden="true"></a>    <span class="co">## Retrieve sigma inverse from pre-computed SVD, if necessary</span></span>
<span id="cb43-84"><a href="building-the-modelalgorithm.html#cb43-84" aria-hidden="true"></a>    <span class="cf">if</span>(<span class="kw">is.null</span>(sigma_eig_by_clust)){</span>
<span id="cb43-85"><a href="building-the-modelalgorithm.html#cb43-85" aria-hidden="true"></a>      sigmainv =<span class="st"> </span><span class="kw">solve</span>(sigma[iclust,,])</span>
<span id="cb43-86"><a href="building-the-modelalgorithm.html#cb43-86" aria-hidden="true"></a>    } <span class="cf">else</span> {</span>
<span id="cb43-87"><a href="building-the-modelalgorithm.html#cb43-87" aria-hidden="true"></a>      sigmainv =<span class="st"> </span>sigma_eig_by_clust[[iclust]]<span class="op">$</span>sigma_inv</span>
<span id="cb43-88"><a href="building-the-modelalgorithm.html#cb43-88" aria-hidden="true"></a>    }</span>
<span id="cb43-89"><a href="building-the-modelalgorithm.html#cb43-89" aria-hidden="true"></a></span>
<span id="cb43-90"><a href="building-the-modelalgorithm.html#cb43-90" aria-hidden="true"></a>    resp.iclust &lt;-<span class="st"> </span><span class="kw">lapply</span>(resp, <span class="dt">FUN =</span> <span class="cf">function</span>(r) <span class="kw">matrix</span>(r[,iclust]))</span>
<span id="cb43-91"><a href="building-the-modelalgorithm.html#cb43-91" aria-hidden="true"></a></span>
<span id="cb43-92"><a href="building-the-modelalgorithm.html#cb43-92" aria-hidden="true"></a>    AB &lt;-<span class="st"> </span><span class="kw">get_AB_mats</span>(<span class="dt">y =</span> y, <span class="dt">resp =</span> resp.iclust, <span class="dt">Sigma_inv =</span> sigmainv,</span>
<span id="cb43-93"><a href="building-the-modelalgorithm.html#cb43-93" aria-hidden="true"></a>                      <span class="dt">e_mat =</span> e_mat, <span class="dt">N =</span> N, <span class="dt">Dlp1 =</span> Dlp1, <span class="dt">Dl =</span> Dl,</span>
<span id="cb43-94"><a href="building-the-modelalgorithm.html#cb43-94" aria-hidden="true"></a>                      <span class="dt">Dlsqrd =</span> Dlsqrd, <span class="dt">rho =</span> rho_init, <span class="dt">z =</span> <span class="ot">NULL</span>, <span class="dt">w =</span> <span class="ot">NULL</span>,</span>
<span id="cb43-95"><a href="building-the-modelalgorithm.html#cb43-95" aria-hidden="true"></a>                      <span class="dt">uz =</span> <span class="ot">NULL</span>, <span class="dt">uw =</span> <span class="ot">NULL</span>)</span>
<span id="cb43-96"><a href="building-the-modelalgorithm.html#cb43-96" aria-hidden="true"></a></span>
<span id="cb43-97"><a href="building-the-modelalgorithm.html#cb43-97" aria-hidden="true"></a>    <span class="co">## Store the Schur decomposition</span></span>
<span id="cb43-98"><a href="building-the-modelalgorithm.html#cb43-98" aria-hidden="true"></a>    schur_syl_A_by_clust[[iclust]] =<span class="st"> </span><span class="kw">myschur</span>(AB<span class="op">$</span>A)</span>
<span id="cb43-99"><a href="building-the-modelalgorithm.html#cb43-99" aria-hidden="true"></a>    schur_syl_B_by_clust[[iclust]] =<span class="st"> </span><span class="kw">myschur</span>(AB<span class="op">$</span>B)</span>
<span id="cb43-100"><a href="building-the-modelalgorithm.html#cb43-100" aria-hidden="true"></a></span>
<span id="cb43-101"><a href="building-the-modelalgorithm.html#cb43-101" aria-hidden="true"></a>    ycentered &lt;-<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb43-102"><a href="building-the-modelalgorithm.html#cb43-102" aria-hidden="true"></a>    ycentered_list[[iclust]] =<span class="st"> </span>ycentered</span>
<span id="cb43-103"><a href="building-the-modelalgorithm.html#cb43-103" aria-hidden="true"></a>    sigmainv_list[[iclust]] =<span class="st"> </span>sigmainv</span>
<span id="cb43-104"><a href="building-the-modelalgorithm.html#cb43-104" aria-hidden="true"></a>  }</span>
<span id="cb43-105"><a href="building-the-modelalgorithm.html#cb43-105" aria-hidden="true"></a></span>
<span id="cb43-106"><a href="building-the-modelalgorithm.html#cb43-106" aria-hidden="true"></a>  <span class="co">##########################################</span></span>
<span id="cb43-107"><a href="building-the-modelalgorithm.html#cb43-107" aria-hidden="true"></a>  <span class="co">## Run ADMM separately on each cluster ##</span></span>
<span id="cb43-108"><a href="building-the-modelalgorithm.html#cb43-108" aria-hidden="true"></a>  <span class="co">#########################################</span></span>
<span id="cb43-109"><a href="building-the-modelalgorithm.html#cb43-109" aria-hidden="true"></a>  admm_niters =<span class="st"> </span>admm_inner_iters =<span class="st"> </span><span class="kw">vector</span>(<span class="dt">length =</span> numclust, <span class="dt">mode =</span> <span class="st">"list"</span>)</span>
<span id="cb43-110"><a href="building-the-modelalgorithm.html#cb43-110" aria-hidden="true"></a>  <span class="cf">if</span>(first_iter) mus =<span class="st"> </span><span class="kw">vector</span>(<span class="dt">length =</span> numclust, <span class="dt">mode =</span> <span class="st">"list"</span>)</span>
<span id="cb43-111"><a href="building-the-modelalgorithm.html#cb43-111" aria-hidden="true"></a> <span class="co"># if(first_iter){</span></span>
<span id="cb43-112"><a href="building-the-modelalgorithm.html#cb43-112" aria-hidden="true"></a>    Zs &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>numclust, <span class="cf">function</span>(x) <span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> TT, <span class="dt">ncol =</span> dimdat))</span>
<span id="cb43-113"><a href="building-the-modelalgorithm.html#cb43-113" aria-hidden="true"></a>    Ws &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>numclust, <span class="cf">function</span>(x) <span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> TT <span class="op">-</span><span class="st"> </span>l, <span class="dt">ncol =</span> dimdat))</span>
<span id="cb43-114"><a href="building-the-modelalgorithm.html#cb43-114" aria-hidden="true"></a>    uzs &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>numclust, <span class="cf">function</span>(x) <span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> TT, <span class="dt">ncol =</span> dimdat))</span>
<span id="cb43-115"><a href="building-the-modelalgorithm.html#cb43-115" aria-hidden="true"></a>    uws &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>numclust, <span class="cf">function</span>(x) <span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> TT <span class="op">-</span><span class="st"> </span>l, <span class="dt">ncol =</span> dimdat))</span>
<span id="cb43-116"><a href="building-the-modelalgorithm.html#cb43-116" aria-hidden="true"></a></span>
<span id="cb43-117"><a href="building-the-modelalgorithm.html#cb43-117" aria-hidden="true"></a>   <span class="co"># Zs =  Ws =  Us  = vector(length = numclust, mode = "list")</span></span>
<span id="cb43-118"><a href="building-the-modelalgorithm.html#cb43-118" aria-hidden="true"></a> <span class="co"># }</span></span>
<span id="cb43-119"><a href="building-the-modelalgorithm.html#cb43-119" aria-hidden="true"></a></span>
<span id="cb43-120"><a href="building-the-modelalgorithm.html#cb43-120" aria-hidden="true"></a>  <span class="co">## For every cluster, run LA-ADMM</span></span>
<span id="cb43-121"><a href="building-the-modelalgorithm.html#cb43-121" aria-hidden="true"></a>  start.time =<span class="st"> </span><span class="kw">Sys.time</span>()</span>
<span id="cb43-122"><a href="building-the-modelalgorithm.html#cb43-122" aria-hidden="true"></a>  <span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>numclust){</span>
<span id="cb43-123"><a href="building-the-modelalgorithm.html#cb43-123" aria-hidden="true"></a></span>
<span id="cb43-124"><a href="building-the-modelalgorithm.html#cb43-124" aria-hidden="true"></a>    resp.iclust &lt;-<span class="st"> </span><span class="kw">lapply</span>(resp, <span class="dt">FUN =</span> <span class="cf">function</span>(r) <span class="kw">matrix</span>(r[,iclust]))</span>
<span id="cb43-125"><a href="building-the-modelalgorithm.html#cb43-125" aria-hidden="true"></a></span>
<span id="cb43-126"><a href="building-the-modelalgorithm.html#cb43-126" aria-hidden="true"></a>    <span class="co">## Possibly locally adaptive ADMM, for now just running with rho == lambda</span></span>
<span id="cb43-127"><a href="building-the-modelalgorithm.html#cb43-127" aria-hidden="true"></a>    res =<span class="st"> </span><span class="kw">la_admm_oneclust</span>(<span class="dt">K =</span> (<span class="cf">if</span>(local_adapt) local_adapt_niter <span class="cf">else</span> <span class="dv">1</span>),</span>
<span id="cb43-128"><a href="building-the-modelalgorithm.html#cb43-128" aria-hidden="true"></a>                           <span class="dt">local_adapt =</span> local_adapt,</span>
<span id="cb43-129"><a href="building-the-modelalgorithm.html#cb43-129" aria-hidden="true"></a>                           <span class="dt">iclust =</span> iclust,</span>
<span id="cb43-130"><a href="building-the-modelalgorithm.html#cb43-130" aria-hidden="true"></a>                           <span class="dt">niter =</span> niter,</span>
<span id="cb43-131"><a href="building-the-modelalgorithm.html#cb43-131" aria-hidden="true"></a>                           <span class="dt">TT =</span> TT, <span class="dt">N =</span> N, <span class="dt">dimdat =</span> dimdat, <span class="dt">maxdev =</span> maxdev,</span>
<span id="cb43-132"><a href="building-the-modelalgorithm.html#cb43-132" aria-hidden="true"></a>                           <span class="dt">schurA =</span> schur_syl_A_by_clust[[iclust]],</span>
<span id="cb43-133"><a href="building-the-modelalgorithm.html#cb43-133" aria-hidden="true"></a>                           <span class="dt">schurB =</span> schur_syl_B_by_clust[[iclust]],</span>
<span id="cb43-134"><a href="building-the-modelalgorithm.html#cb43-134" aria-hidden="true"></a>                           <span class="dt">sigmainv =</span> sigmainv_list[[iclust]],</span>
<span id="cb43-135"><a href="building-the-modelalgorithm.html#cb43-135" aria-hidden="true"></a>                           <span class="dt">rho =</span> rho_init, </span>
<span id="cb43-136"><a href="building-the-modelalgorithm.html#cb43-136" aria-hidden="true"></a>                           <span class="dt">rhoinit =</span> rho_init, </span>
<span id="cb43-137"><a href="building-the-modelalgorithm.html#cb43-137" aria-hidden="true"></a>                           <span class="co">## rho = (if(iclust == 1) rho_init else res$rho/2),</span></span>
<span id="cb43-138"><a href="building-the-modelalgorithm.html#cb43-138" aria-hidden="true"></a>                           <span class="co">## rhoinit = (if(iclust == 1) rho_init else res$rho/2),</span></span>
<span id="cb43-139"><a href="building-the-modelalgorithm.html#cb43-139" aria-hidden="true"></a>                           <span class="dt">sigma =</span> sigma,</span>
<span id="cb43-140"><a href="building-the-modelalgorithm.html#cb43-140" aria-hidden="true"></a>                           <span class="dt">lambda =</span> lambda,</span>
<span id="cb43-141"><a href="building-the-modelalgorithm.html#cb43-141" aria-hidden="true"></a>                           <span class="dt">resp =</span> resp.iclust,</span>
<span id="cb43-142"><a href="building-the-modelalgorithm.html#cb43-142" aria-hidden="true"></a>                           <span class="dt">resp_sum =</span> resp.sum[,iclust],</span>
<span id="cb43-143"><a href="building-the-modelalgorithm.html#cb43-143" aria-hidden="true"></a>                           <span class="dt">l =</span> l,</span>
<span id="cb43-144"><a href="building-the-modelalgorithm.html#cb43-144" aria-hidden="true"></a>                           <span class="dt">Dlp1 =</span> Dlp1,</span>
<span id="cb43-145"><a href="building-the-modelalgorithm.html#cb43-145" aria-hidden="true"></a>                           <span class="dt">Dl =</span> Dl,</span>
<span id="cb43-146"><a href="building-the-modelalgorithm.html#cb43-146" aria-hidden="true"></a>                           <span class="dt">tDl =</span> tDl,</span>
<span id="cb43-147"><a href="building-the-modelalgorithm.html#cb43-147" aria-hidden="true"></a>                           <span class="dt">y =</span> ylist,</span>
<span id="cb43-148"><a href="building-the-modelalgorithm.html#cb43-148" aria-hidden="true"></a>                           <span class="dt">err_rel =</span> err_rel,</span>
<span id="cb43-149"><a href="building-the-modelalgorithm.html#cb43-149" aria-hidden="true"></a>                           <span class="dt">err_abs =</span> err_abs,</span>
<span id="cb43-150"><a href="building-the-modelalgorithm.html#cb43-150" aria-hidden="true"></a>                           <span class="dt">zerothresh =</span> zerothresh,</span>
<span id="cb43-151"><a href="building-the-modelalgorithm.html#cb43-151" aria-hidden="true"></a>                           <span class="dt">sigma_eig_by_clust =</span> sigma_eig_by_clust,</span>
<span id="cb43-152"><a href="building-the-modelalgorithm.html#cb43-152" aria-hidden="true"></a>                           <span class="dt">iter =</span> iter,</span>
<span id="cb43-153"><a href="building-the-modelalgorithm.html#cb43-153" aria-hidden="true"></a></span>
<span id="cb43-154"><a href="building-the-modelalgorithm.html#cb43-154" aria-hidden="true"></a>                           <span class="co">## Warm starts from previous *EM* iteration</span></span>
<span id="cb43-155"><a href="building-the-modelalgorithm.html#cb43-155" aria-hidden="true"></a>                           <span class="dt">first_iter =</span> first_iter,</span>
<span id="cb43-156"><a href="building-the-modelalgorithm.html#cb43-156" aria-hidden="true"></a>                           <span class="co">## mu = mus[[iclust]], ## I think we want this.</span></span>
<span id="cb43-157"><a href="building-the-modelalgorithm.html#cb43-157" aria-hidden="true"></a>                           <span class="dt">uw =</span> uws[[iclust]],</span>
<span id="cb43-158"><a href="building-the-modelalgorithm.html#cb43-158" aria-hidden="true"></a>                           <span class="dt">uz =</span> uzs[[iclust]],</span>
<span id="cb43-159"><a href="building-the-modelalgorithm.html#cb43-159" aria-hidden="true"></a>                           <span class="dt">z =</span> Zs[[iclust]],</span>
<span id="cb43-160"><a href="building-the-modelalgorithm.html#cb43-160" aria-hidden="true"></a>                           <span class="dt">w =</span> Ws[[iclust]])</span>
<span id="cb43-161"><a href="building-the-modelalgorithm.html#cb43-161" aria-hidden="true"></a>    <span class="co">## print(res$rho)</span></span>
<span id="cb43-162"><a href="building-the-modelalgorithm.html#cb43-162" aria-hidden="true"></a></span>
<span id="cb43-163"><a href="building-the-modelalgorithm.html#cb43-163" aria-hidden="true"></a>    <span class="co">## Store the results</span></span>
<span id="cb43-164"><a href="building-the-modelalgorithm.html#cb43-164" aria-hidden="true"></a>    mus[[iclust]] =<span class="st"> </span>res<span class="op">$</span>mu</span>
<span id="cb43-165"><a href="building-the-modelalgorithm.html#cb43-165" aria-hidden="true"></a>    admm_niters[[iclust]] =<span class="st"> </span>res<span class="op">$</span>kk</span>
<span id="cb43-166"><a href="building-the-modelalgorithm.html#cb43-166" aria-hidden="true"></a>    admm_inner_iters[[iclust]] =<span class="st"> </span>res<span class="op">$</span>inner.iter</span>
<span id="cb43-167"><a href="building-the-modelalgorithm.html#cb43-167" aria-hidden="true"></a></span>
<span id="cb43-168"><a href="building-the-modelalgorithm.html#cb43-168" aria-hidden="true"></a>    <span class="co">## Store other things for for warmstart</span></span>
<span id="cb43-169"><a href="building-the-modelalgorithm.html#cb43-169" aria-hidden="true"></a>    <span class="co">## mus[[iclust]] = res$mu</span></span>
<span id="cb43-170"><a href="building-the-modelalgorithm.html#cb43-170" aria-hidden="true"></a>    Zs[[iclust]] =<span class="st"> </span>res<span class="op">$</span>Z</span>
<span id="cb43-171"><a href="building-the-modelalgorithm.html#cb43-171" aria-hidden="true"></a>    uzs[[iclust]] =<span class="st"> </span>res<span class="op">$</span>uz</span>
<span id="cb43-172"><a href="building-the-modelalgorithm.html#cb43-172" aria-hidden="true"></a>    uws[[iclust]] =<span class="st"> </span>res<span class="op">$</span>uw</span>
<span id="cb43-173"><a href="building-the-modelalgorithm.html#cb43-173" aria-hidden="true"></a>    Ws[[iclust]] =<span class="st"> </span>res<span class="op">$</span>W</span>
<span id="cb43-174"><a href="building-the-modelalgorithm.html#cb43-174" aria-hidden="true"></a>    <span class="co">## The upper triangular matrix remains the same. (code missing?)</span></span>
<span id="cb43-175"><a href="building-the-modelalgorithm.html#cb43-175" aria-hidden="true"></a></span>
<span id="cb43-176"><a href="building-the-modelalgorithm.html#cb43-176" aria-hidden="true"></a>  }</span>
<span id="cb43-177"><a href="building-the-modelalgorithm.html#cb43-177" aria-hidden="true"></a></span>
<span id="cb43-178"><a href="building-the-modelalgorithm.html#cb43-178" aria-hidden="true"></a>  <span class="co">## Aggregate the yhats into one array</span></span>
<span id="cb43-179"><a href="building-the-modelalgorithm.html#cb43-179" aria-hidden="true"></a>  mu_array =<span class="st"> </span><span class="kw">array</span>(<span class="ot">NA</span>, <span class="dt">dim =</span> <span class="kw">c</span>(TT, dimdat, numclust))</span>
<span id="cb43-180"><a href="building-the-modelalgorithm.html#cb43-180" aria-hidden="true"></a>  <span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>numclust){ mu_array[,,iclust] =<span class="st"> </span>mus[[iclust]] }</span>
<span id="cb43-181"><a href="building-the-modelalgorithm.html#cb43-181" aria-hidden="true"></a></span>
<span id="cb43-182"><a href="building-the-modelalgorithm.html#cb43-182" aria-hidden="true"></a>  <span class="co">## Each are lists of length |numclust|.</span></span>
<span id="cb43-183"><a href="building-the-modelalgorithm.html#cb43-183" aria-hidden="true"></a>  <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">mns =</span> mu_array,</span>
<span id="cb43-184"><a href="building-the-modelalgorithm.html#cb43-184" aria-hidden="true"></a>              <span class="dt">admm_niters =</span> admm_niters, </span>
<span id="cb43-185"><a href="building-the-modelalgorithm.html#cb43-185" aria-hidden="true"></a>              <span class="dt">admm_inner_iters =</span> admm_inner_iters,</span>
<span id="cb43-186"><a href="building-the-modelalgorithm.html#cb43-186" aria-hidden="true"></a></span>
<span id="cb43-187"><a href="building-the-modelalgorithm.html#cb43-187" aria-hidden="true"></a>              <span class="co">## For warmstarts</span></span>
<span id="cb43-188"><a href="building-the-modelalgorithm.html#cb43-188" aria-hidden="true"></a>              <span class="dt">Zs =</span> Zs,</span>
<span id="cb43-189"><a href="building-the-modelalgorithm.html#cb43-189" aria-hidden="true"></a>              <span class="dt">Ws =</span> Ws,</span>
<span id="cb43-190"><a href="building-the-modelalgorithm.html#cb43-190" aria-hidden="true"></a>              <span class="dt">uws =</span> uws,</span>
<span id="cb43-191"><a href="building-the-modelalgorithm.html#cb43-191" aria-hidden="true"></a>              <span class="dt">uzs =</span> uzs,</span>
<span id="cb43-192"><a href="building-the-modelalgorithm.html#cb43-192" aria-hidden="true"></a>              <span class="dt">N =</span> N,</span>
<span id="cb43-193"><a href="building-the-modelalgorithm.html#cb43-193" aria-hidden="true"></a></span>
<span id="cb43-194"><a href="building-the-modelalgorithm.html#cb43-194" aria-hidden="true"></a>              <span class="co">## Return the column</span></span>
<span id="cb43-195"><a href="building-the-modelalgorithm.html#cb43-195" aria-hidden="true"></a>              <span class="dt">rho =</span> res<span class="op">$</span>rho,</span>
<span id="cb43-196"><a href="building-the-modelalgorithm.html#cb43-196" aria-hidden="true"></a></span>
<span id="cb43-197"><a href="building-the-modelalgorithm.html#cb43-197" aria-hidden="true"></a>              <span class="co">## For using in the Sigma M step</span></span>
<span id="cb43-198"><a href="building-the-modelalgorithm.html#cb43-198" aria-hidden="true"></a>              <span class="dt">ycentered_list =</span> ycentered_list,</span>
<span id="cb43-199"><a href="building-the-modelalgorithm.html#cb43-199" aria-hidden="true"></a>              <span class="dt">Xcentered_list =</span> Xcentered_list,</span>
<span id="cb43-200"><a href="building-the-modelalgorithm.html#cb43-200" aria-hidden="true"></a>              <span class="dt">yXcentered_list =</span> yXcentered_list,</span>
<span id="cb43-201"><a href="building-the-modelalgorithm.html#cb43-201" aria-hidden="true"></a>              <span class="dt">Qlist =</span> Qlist</span>
<span id="cb43-202"><a href="building-the-modelalgorithm.html#cb43-202" aria-hidden="true"></a>  ))</span>
<span id="cb43-203"><a href="building-the-modelalgorithm.html#cb43-203" aria-hidden="true"></a>}</span></code></pre></div>
<p>The locally adaptive admm for a single cluster involves an inner and outer
loop. The inner loop is an ADMM for a fixed <span class="math inline">\(\rho\)</span>. The outer loop is written
here in <code>la_admm_oneclust</code>, and runs the inner ADMM with a fixed step-size
<span class="math inline">\(\rho\)</span> while sequentially doubling <span class="math inline">\(\rho\)</span>.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="building-the-modelalgorithm.html#cb44-1" aria-hidden="true"></a><span class="co">#' Locally adaptive ADMM.</span></span>
<span id="cb44-2"><a href="building-the-modelalgorithm.html#cb44-2" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb44-3"><a href="building-the-modelalgorithm.html#cb44-3" aria-hidden="true"></a><span class="co">#' @param K</span></span>
<span id="cb44-4"><a href="building-the-modelalgorithm.html#cb44-4" aria-hidden="true"></a><span class="co">#' @param ...</span></span>
<span id="cb44-5"><a href="building-the-modelalgorithm.html#cb44-5" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb44-6"><a href="building-the-modelalgorithm.html#cb44-6" aria-hidden="true"></a><span class="co">#' @return</span></span>
<span id="cb44-7"><a href="building-the-modelalgorithm.html#cb44-7" aria-hidden="true"></a><span class="co">#' @export</span></span>
<span id="cb44-8"><a href="building-the-modelalgorithm.html#cb44-8" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb44-9"><a href="building-the-modelalgorithm.html#cb44-9" aria-hidden="true"></a><span class="co">#' @examples</span></span>
<span id="cb44-10"><a href="building-the-modelalgorithm.html#cb44-10" aria-hidden="true"></a>la_admm_oneclust &lt;-<span class="st"> </span><span class="cf">function</span>(K, ...){</span>
<span id="cb44-11"><a href="building-the-modelalgorithm.html#cb44-11" aria-hidden="true"></a></span>
<span id="cb44-12"><a href="building-the-modelalgorithm.html#cb44-12" aria-hidden="true"></a>  <span class="co">## Initialize arguments for ADMM.</span></span>
<span id="cb44-13"><a href="building-the-modelalgorithm.html#cb44-13" aria-hidden="true"></a>  args &lt;-<span class="st"> </span><span class="kw">list</span>(...)</span>
<span id="cb44-14"><a href="building-the-modelalgorithm.html#cb44-14" aria-hidden="true"></a>  p =<span class="st"> </span>args<span class="op">$</span>p</span>
<span id="cb44-15"><a href="building-the-modelalgorithm.html#cb44-15" aria-hidden="true"></a>  l =<span class="st"> </span>args<span class="op">$</span>l</span>
<span id="cb44-16"><a href="building-the-modelalgorithm.html#cb44-16" aria-hidden="true"></a>  TT =<span class="st"> </span>args<span class="op">$</span>TT</span>
<span id="cb44-17"><a href="building-the-modelalgorithm.html#cb44-17" aria-hidden="true"></a>  dimdat =<span class="st"> </span>args<span class="op">$</span>dimdat</span>
<span id="cb44-18"><a href="building-the-modelalgorithm.html#cb44-18" aria-hidden="true"></a>  rhoinit =<span class="st"> </span>args<span class="op">$</span>rhoinit</span>
<span id="cb44-19"><a href="building-the-modelalgorithm.html#cb44-19" aria-hidden="true"></a></span>
<span id="cb44-20"><a href="building-the-modelalgorithm.html#cb44-20" aria-hidden="true"></a>  <span class="co">## This initialization can come from the previous *EM* iteration.</span></span>
<span id="cb44-21"><a href="building-the-modelalgorithm.html#cb44-21" aria-hidden="true"></a>  <span class="cf">if</span>(args<span class="op">$</span>first_iter){</span>
<span id="cb44-22"><a href="building-the-modelalgorithm.html#cb44-22" aria-hidden="true"></a>    mu =<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> TT, <span class="dt">ncol =</span> dimdat)</span>
<span id="cb44-23"><a href="building-the-modelalgorithm.html#cb44-23" aria-hidden="true"></a>    Z &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> TT, <span class="dt">ncol =</span> dimdat)</span>
<span id="cb44-24"><a href="building-the-modelalgorithm.html#cb44-24" aria-hidden="true"></a>    W &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> TT<span class="op">-</span>l, <span class="dt">ncol =</span> dimdat)</span>
<span id="cb44-25"><a href="building-the-modelalgorithm.html#cb44-25" aria-hidden="true"></a>    uz &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> TT, <span class="dt">ncol =</span> dimdat)</span>
<span id="cb44-26"><a href="building-the-modelalgorithm.html#cb44-26" aria-hidden="true"></a>    uw &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> TT <span class="op">-</span><span class="st"> </span>l, <span class="dt">ncol =</span> dimdat)</span>
<span id="cb44-27"><a href="building-the-modelalgorithm.html#cb44-27" aria-hidden="true"></a></span>
<span id="cb44-28"><a href="building-the-modelalgorithm.html#cb44-28" aria-hidden="true"></a>    args[[<span class="st">'mu'</span>]] &lt;-<span class="st"> </span>mu</span>
<span id="cb44-29"><a href="building-the-modelalgorithm.html#cb44-29" aria-hidden="true"></a>    args[[<span class="st">'z'</span>]] &lt;-<span class="st"> </span>Z</span>
<span id="cb44-30"><a href="building-the-modelalgorithm.html#cb44-30" aria-hidden="true"></a>    args[[<span class="st">'w'</span>]] &lt;-<span class="st"> </span>W</span>
<span id="cb44-31"><a href="building-the-modelalgorithm.html#cb44-31" aria-hidden="true"></a>    args[[<span class="st">'uz'</span>]] &lt;-<span class="st"> </span>uz</span>
<span id="cb44-32"><a href="building-the-modelalgorithm.html#cb44-32" aria-hidden="true"></a>    args[[<span class="st">'uw'</span>]] &lt;-<span class="st"> </span>uw</span>
<span id="cb44-33"><a href="building-the-modelalgorithm.html#cb44-33" aria-hidden="true"></a>  }</span>
<span id="cb44-34"><a href="building-the-modelalgorithm.html#cb44-34" aria-hidden="true"></a></span>
<span id="cb44-35"><a href="building-the-modelalgorithm.html#cb44-35" aria-hidden="true"></a>  cols =<span class="st"> </span><span class="kw">c</span>()</span>
<span id="cb44-36"><a href="building-the-modelalgorithm.html#cb44-36" aria-hidden="true"></a>  some_admm_objectives =<span class="st"> </span><span class="kw">c</span>()</span>
<span id="cb44-37"><a href="building-the-modelalgorithm.html#cb44-37" aria-hidden="true"></a></span>
<span id="cb44-38"><a href="building-the-modelalgorithm.html#cb44-38" aria-hidden="true"></a></span>
<span id="cb44-39"><a href="building-the-modelalgorithm.html#cb44-39" aria-hidden="true"></a>  <span class="co">## Run ADMM repeatedly with (1) double rho, and (2) previous b</span></span>
<span id="cb44-40"><a href="building-the-modelalgorithm.html#cb44-40" aria-hidden="true"></a>  <span class="cf">for</span>(kk <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>K){</span>
<span id="cb44-41"><a href="building-the-modelalgorithm.html#cb44-41" aria-hidden="true"></a>    <span class="cf">if</span>(kk <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>){</span>
<span id="cb44-42"><a href="building-the-modelalgorithm.html#cb44-42" aria-hidden="true"></a>      <span class="co">## Z = matrix(0, nrow = TT, ncol = dimdat)</span></span>
<span id="cb44-43"><a href="building-the-modelalgorithm.html#cb44-43" aria-hidden="true"></a>      <span class="co">## W = matrix(0, nrow = TT - l , ncol = dimdat)</span></span>
<span id="cb44-44"><a href="building-the-modelalgorithm.html#cb44-44" aria-hidden="true"></a>      <span class="co">## uz = matrix(0, nrow = TT, ncol = dimdat)</span></span>
<span id="cb44-45"><a href="building-the-modelalgorithm.html#cb44-45" aria-hidden="true"></a>      <span class="co">## uw = matrix(0, nrow = TT - l , ncol = dimdat)</span></span>
<span id="cb44-46"><a href="building-the-modelalgorithm.html#cb44-46" aria-hidden="true"></a></span>
<span id="cb44-47"><a href="building-the-modelalgorithm.html#cb44-47" aria-hidden="true"></a>      <span class="co">## These ensure warm starts are true</span></span>
<span id="cb44-48"><a href="building-the-modelalgorithm.html#cb44-48" aria-hidden="true"></a>      args[[<span class="st">'mu'</span>]] &lt;-<span class="st"> </span>mu</span>
<span id="cb44-49"><a href="building-the-modelalgorithm.html#cb44-49" aria-hidden="true"></a>      args[[<span class="st">'z'</span>]] &lt;-<span class="st"> </span>Z</span>
<span id="cb44-50"><a href="building-the-modelalgorithm.html#cb44-50" aria-hidden="true"></a>      args[[<span class="st">'w'</span>]] &lt;-<span class="st"> </span>W</span>
<span id="cb44-51"><a href="building-the-modelalgorithm.html#cb44-51" aria-hidden="true"></a>      args[[<span class="st">'uz'</span>]] &lt;-<span class="st"> </span>uz</span>
<span id="cb44-52"><a href="building-the-modelalgorithm.html#cb44-52" aria-hidden="true"></a>      args[[<span class="st">'uw'</span>]] &lt;-<span class="st"> </span>uw</span>
<span id="cb44-53"><a href="building-the-modelalgorithm.html#cb44-53" aria-hidden="true"></a>      args[[<span class="st">'rho'</span>]] &lt;-<span class="st"> </span>rho</span>
<span id="cb44-54"><a href="building-the-modelalgorithm.html#cb44-54" aria-hidden="true"></a>    }</span>
<span id="cb44-55"><a href="building-the-modelalgorithm.html#cb44-55" aria-hidden="true"></a></span>
<span id="cb44-56"><a href="building-the-modelalgorithm.html#cb44-56" aria-hidden="true"></a>    <span class="co">## Run ADMM</span></span>
<span id="cb44-57"><a href="building-the-modelalgorithm.html#cb44-57" aria-hidden="true"></a>    args[[<span class="st">'outer_iter'</span>]] &lt;-<span class="st"> </span>kk</span>
<span id="cb44-58"><a href="building-the-modelalgorithm.html#cb44-58" aria-hidden="true"></a></span>
<span id="cb44-59"><a href="building-the-modelalgorithm.html#cb44-59" aria-hidden="true"></a>    <span class="co">## Call main function</span></span>
<span id="cb44-60"><a href="building-the-modelalgorithm.html#cb44-60" aria-hidden="true"></a>    argn &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">names</span>(args), as.name)</span>
<span id="cb44-61"><a href="building-the-modelalgorithm.html#cb44-61" aria-hidden="true"></a>    <span class="kw">names</span>(argn) &lt;-<span class="st"> </span><span class="kw">names</span>(args)</span>
<span id="cb44-62"><a href="building-the-modelalgorithm.html#cb44-62" aria-hidden="true"></a>    call &lt;-<span class="st"> </span><span class="kw">as.call</span>(<span class="kw">c</span>(<span class="kw">list</span>(<span class="kw">as.name</span>(<span class="st">"admm_oneclust"</span>)), argn))</span>
<span id="cb44-63"><a href="building-the-modelalgorithm.html#cb44-63" aria-hidden="true"></a>    res =<span class="st"> </span><span class="kw">eval</span>(call, args)</span>
<span id="cb44-64"><a href="building-the-modelalgorithm.html#cb44-64" aria-hidden="true"></a></span>
<span id="cb44-65"><a href="building-the-modelalgorithm.html#cb44-65" aria-hidden="true"></a>    <span class="cf">if</span>(<span class="kw">any</span>(<span class="kw">abs</span>(res<span class="op">$</span>mu)<span class="op">&gt;</span><span class="fl">1E2</span>)){</span>
<span id="cb44-66"><a href="building-the-modelalgorithm.html#cb44-66" aria-hidden="true"></a>      <span class="kw">stop</span>(<span class="st">"mu is blowing up! Probably because the initial ADMM step size (rho) is too large (and possibly the ball constraint on the means is large."</span>) </span>
<span id="cb44-67"><a href="building-the-modelalgorithm.html#cb44-67" aria-hidden="true"></a>    }</span>
<span id="cb44-68"><a href="building-the-modelalgorithm.html#cb44-68" aria-hidden="true"></a></span>
<span id="cb44-69"><a href="building-the-modelalgorithm.html#cb44-69" aria-hidden="true"></a>    some_admm_objectives =<span class="st"> </span><span class="kw">c</span>(some_admm_objectives, res<span class="op">$</span>single_admm_objective) </span>
<span id="cb44-70"><a href="building-the-modelalgorithm.html#cb44-70" aria-hidden="true"></a></span>
<span id="cb44-71"><a href="building-the-modelalgorithm.html#cb44-71" aria-hidden="true"></a>    <span class="co">## Handling the scenario where the objectives are all zero</span></span>
<span id="cb44-72"><a href="building-the-modelalgorithm.html#cb44-72" aria-hidden="true"></a>    padding =<span class="st"> </span><span class="fl">1E-12</span></span>
<span id="cb44-73"><a href="building-the-modelalgorithm.html#cb44-73" aria-hidden="true"></a>    some_admm_objectives =<span class="st"> </span>some_admm_objectives <span class="op">+</span><span class="st"> </span>padding</span>
<span id="cb44-74"><a href="building-the-modelalgorithm.html#cb44-74" aria-hidden="true"></a></span>
<span id="cb44-75"><a href="building-the-modelalgorithm.html#cb44-75" aria-hidden="true"></a>    <span class="co">## See if outer iterations should terminate</span></span>
<span id="cb44-76"><a href="building-the-modelalgorithm.html#cb44-76" aria-hidden="true"></a>    <span class="cf">if</span>(res<span class="op">$</span>converge){</span>
<span id="cb44-77"><a href="building-the-modelalgorithm.html#cb44-77" aria-hidden="true"></a>      res<span class="op">$</span>converge &lt;-<span class="st"> </span>T</span>
<span id="cb44-78"><a href="building-the-modelalgorithm.html#cb44-78" aria-hidden="true"></a>      <span class="cf">break</span></span>
<span id="cb44-79"><a href="building-the-modelalgorithm.html#cb44-79" aria-hidden="true"></a>    }</span>
<span id="cb44-80"><a href="building-the-modelalgorithm.html#cb44-80" aria-hidden="true"></a></span>
<span id="cb44-81"><a href="building-the-modelalgorithm.html#cb44-81" aria-hidden="true"></a>    <span class="co">## Update some parameters; double the rho value, and update the B matrix</span></span>
<span id="cb44-82"><a href="building-the-modelalgorithm.html#cb44-82" aria-hidden="true"></a>    rho =<span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>args<span class="op">$</span>rho</span>
<span id="cb44-83"><a href="building-the-modelalgorithm.html#cb44-83" aria-hidden="true"></a>    <span class="co">## tQ = 2 * args$schurB$tQ ## This seems wrong. Delete now.</span></span>
<span id="cb44-84"><a href="building-the-modelalgorithm.html#cb44-84" aria-hidden="true"></a>    mu =<span class="st"> </span>res<span class="op">$</span>mu</span>
<span id="cb44-85"><a href="building-the-modelalgorithm.html#cb44-85" aria-hidden="true"></a>    Z =<span class="st"> </span>res<span class="op">$</span>Z</span>
<span id="cb44-86"><a href="building-the-modelalgorithm.html#cb44-86" aria-hidden="true"></a>    W =<span class="st"> </span>res<span class="op">$</span>W</span>
<span id="cb44-87"><a href="building-the-modelalgorithm.html#cb44-87" aria-hidden="true"></a>    uz =<span class="st"> </span>res<span class="op">$</span>uz</span>
<span id="cb44-88"><a href="building-the-modelalgorithm.html#cb44-88" aria-hidden="true"></a>    uw =<span class="st"> </span>res<span class="op">$</span>uw</span>
<span id="cb44-89"><a href="building-the-modelalgorithm.html#cb44-89" aria-hidden="true"></a>    <span class="co">## print("args$rho")</span></span>
<span id="cb44-90"><a href="building-the-modelalgorithm.html#cb44-90" aria-hidden="true"></a>    <span class="co">## print(args$rho)</span></span>
<span id="cb44-91"><a href="building-the-modelalgorithm.html#cb44-91" aria-hidden="true"></a>  }</span>
<span id="cb44-92"><a href="building-the-modelalgorithm.html#cb44-92" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="op">!</span>res<span class="op">$</span>converge)   <span class="kw">warning</span>(<span class="st">"ADMM didn't converge for one cluster."</span>)</span>
<span id="cb44-93"><a href="building-the-modelalgorithm.html#cb44-93" aria-hidden="true"></a></span>
<span id="cb44-94"><a href="building-the-modelalgorithm.html#cb44-94" aria-hidden="true"></a>  <span class="co">## Record how long the admm took; in terms of # iterations.</span></span>
<span id="cb44-95"><a href="building-the-modelalgorithm.html#cb44-95" aria-hidden="true"></a>  res<span class="op">$</span>kk =<span class="st"> </span>kk</span>
<span id="cb44-96"><a href="building-the-modelalgorithm.html#cb44-96" aria-hidden="true"></a></span>
<span id="cb44-97"><a href="building-the-modelalgorithm.html#cb44-97" aria-hidden="true"></a>  <span class="co">## Record the final rho</span></span>
<span id="cb44-98"><a href="building-the-modelalgorithm.html#cb44-98" aria-hidden="true"></a>  res<span class="op">$</span>rho =<span class="st"> </span>args<span class="op">$</span>rho</span>
<span id="cb44-99"><a href="building-the-modelalgorithm.html#cb44-99" aria-hidden="true"></a></span>
<span id="cb44-100"><a href="building-the-modelalgorithm.html#cb44-100" aria-hidden="true"></a>  <span class="kw">return</span>(res)</span>
<span id="cb44-101"><a href="building-the-modelalgorithm.html#cb44-101" aria-hidden="true"></a>}</span></code></pre></div>
<p>Next, the inner loop. The workhorse <code>admm_oneclust()</code> actually performs the ADMM
update for one cluster for a fixed step-size <span class="math inline">\(\rho\)</span> across optimization
iterations <code>iter=1,...,n</code>.</p>
<p>This <code>admm_oneclust()</code> uses the following helpers:</p>
<ul>
<li>
<code>W_update_fused()</code>: this uses the <code>prox</code> function, which uses a RCpp function.
<code>prox_dp</code>.</li>
<li><code>Z_update()</code></li>
<li><code>U_update_Z()</code></li>
<li><code>U_update_W()</code></li>
</ul>
<p>A <code>prox_dp</code> function, written in C, will be used.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="building-the-modelalgorithm.html#cb45-1" aria-hidden="true"></a><span class="co">#' Solve a fused lasso problem for the W update. Internally, a fused lasso dynamic</span></span>
<span id="cb45-2"><a href="building-the-modelalgorithm.html#cb45-2" aria-hidden="true"></a><span class="co">#' programming solver \code{<a href="building-the-modelalgorithm.html#prox">prox</a>()} (which calls \code{prox_dp()} written in C)</span></span>
<span id="cb45-3"><a href="building-the-modelalgorithm.html#cb45-3" aria-hidden="true"></a><span class="co">#' is used.</span></span>
<span id="cb45-4"><a href="building-the-modelalgorithm.html#cb45-4" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb45-5"><a href="building-the-modelalgorithm.html#cb45-5" aria-hidden="true"></a>W_update_fused &lt;-<span class="st"> </span><span class="cf">function</span>(l, TT, mu, uw, rho, lambda, Dl){</span>
<span id="cb45-6"><a href="building-the-modelalgorithm.html#cb45-6" aria-hidden="true"></a></span>
<span id="cb45-7"><a href="building-the-modelalgorithm.html#cb45-7" aria-hidden="true"></a>  <span class="co"># modified lambda for fused lasso routine</span></span>
<span id="cb45-8"><a href="building-the-modelalgorithm.html#cb45-8" aria-hidden="true"></a>  mod_lam &lt;-<span class="st"> </span>lambda<span class="op">/</span>rho</span>
<span id="cb45-9"><a href="building-the-modelalgorithm.html#cb45-9" aria-hidden="true"></a></span>
<span id="cb45-10"><a href="building-the-modelalgorithm.html#cb45-10" aria-hidden="true"></a>  <span class="co"># generating pseudo response xi</span></span>
<span id="cb45-11"><a href="building-the-modelalgorithm.html#cb45-11" aria-hidden="true"></a>  <span class="cf">if</span>( l <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span> ){</span>
<span id="cb45-12"><a href="building-the-modelalgorithm.html#cb45-12" aria-hidden="true"></a>    <span class="kw">stop</span>(<span class="st">"l should never be /below/ zero!"</span>)</span>
<span id="cb45-13"><a href="building-the-modelalgorithm.html#cb45-13" aria-hidden="true"></a>  } <span class="cf">else</span> <span class="cf">if</span>( l <span class="op">==</span><span class="st"> </span><span class="dv">0</span> ){</span>
<span id="cb45-14"><a href="building-the-modelalgorithm.html#cb45-14" aria-hidden="true"></a>    xi &lt;-<span class="st"> </span>mu <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">/</span>rho <span class="op">*</span><span class="st"> </span>uw  <span class="co">## This is faster</span></span>
<span id="cb45-15"><a href="building-the-modelalgorithm.html#cb45-15" aria-hidden="true"></a>  } <span class="cf">else</span> {</span>
<span id="cb45-16"><a href="building-the-modelalgorithm.html#cb45-16" aria-hidden="true"></a>    xi &lt;-<span class="st"> </span>Dl <span class="op">%*%</span><span class="st"> </span>mu <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">/</span>rho <span class="op">*</span><span class="st"> </span>uw</span>
<span id="cb45-17"><a href="building-the-modelalgorithm.html#cb45-17" aria-hidden="true"></a>    <span class="cf">if</span>(<span class="kw">any</span>(<span class="kw">is.nan</span>(xi))) <span class="kw">browser</span>()</span>
<span id="cb45-18"><a href="building-the-modelalgorithm.html#cb45-18" aria-hidden="true"></a></span>
<span id="cb45-19"><a href="building-the-modelalgorithm.html#cb45-19" aria-hidden="true"></a>    <span class="co">## l = 2 is quadratic trend filtering</span></span>
<span id="cb45-20"><a href="building-the-modelalgorithm.html#cb45-20" aria-hidden="true"></a>    <span class="co">## l = 1 is linear trend filtering</span></span>
<span id="cb45-21"><a href="building-the-modelalgorithm.html#cb45-21" aria-hidden="true"></a>    <span class="co">## l = 0 is fused lasso</span></span>
<span id="cb45-22"><a href="building-the-modelalgorithm.html#cb45-22" aria-hidden="true"></a>    <span class="co">## D^{(1)} is first differences, so it correponds to l=0</span></span>
<span id="cb45-23"><a href="building-the-modelalgorithm.html#cb45-23" aria-hidden="true"></a>    <span class="co">## Dl = gen_diff_mat(n = TT, l = l, x = x)  &lt;---  (T-l) x T matrix </span></span>
<span id="cb45-24"><a href="building-the-modelalgorithm.html#cb45-24" aria-hidden="true"></a>  }</span>
<span id="cb45-25"><a href="building-the-modelalgorithm.html#cb45-25" aria-hidden="true"></a></span>
<span id="cb45-26"><a href="building-the-modelalgorithm.html#cb45-26" aria-hidden="true"></a>  <span class="co">## Running the fused LASSO</span></span>
<span id="cb45-27"><a href="building-the-modelalgorithm.html#cb45-27" aria-hidden="true"></a>  <span class="co">## which solves min_zhat 1/2 |z-zhat|_2^2 + lambda |D^{(1)}zhat|</span></span>
<span id="cb45-28"><a href="building-the-modelalgorithm.html#cb45-28" aria-hidden="true"></a>  <span class="co">## fit &lt;- <a href="building-the-modelalgorithm.html#prox">prox</a>(z = xi, lam = mod_lam)</span></span>
<span id="cb45-29"><a href="building-the-modelalgorithm.html#cb45-29" aria-hidden="true"></a>  <span class="co">## fit &lt;- prox_dp(z = xi, lam = mod_lam) ## instead of FlowTF::prox()</span></span>
<span id="cb45-30"><a href="building-the-modelalgorithm.html#cb45-30" aria-hidden="true"></a>  <span class="co">## fit &lt;- flowtrendprox::prox_dp(z = xi, lam = mod_lam) </span></span>
<span id="cb45-31"><a href="building-the-modelalgorithm.html#cb45-31" aria-hidden="true"></a>  fit &lt;-<span class="st"> </span>FlowTF<span class="op">::</span><span class="kw">prox</span>(<span class="dt">z =</span> xi, <span class="dt">lam =</span> mod_lam) </span>
<span id="cb45-32"><a href="building-the-modelalgorithm.html#cb45-32" aria-hidden="true"></a>  <span class="co">## </span><span class="al">TODO</span><span class="co">: eventually change to  fit &lt;- flowtrendprox::prox(z = xi, lam = mod_lam)</span></span>
<span id="cb45-33"><a href="building-the-modelalgorithm.html#cb45-33" aria-hidden="true"></a></span>
<span id="cb45-34"><a href="building-the-modelalgorithm.html#cb45-34" aria-hidden="true"></a>  <span class="kw">return</span>(fit)</span>
<span id="cb45-35"><a href="building-the-modelalgorithm.html#cb45-35" aria-hidden="true"></a>}</span>
<span id="cb45-36"><a href="building-the-modelalgorithm.html#cb45-36" aria-hidden="true"></a></span>
<span id="cb45-37"><a href="building-the-modelalgorithm.html#cb45-37" aria-hidden="true"></a><span class="co">## This function is in FlowTF now. It's the last function there!</span></span>
<span id="cb45-38"><a href="building-the-modelalgorithm.html#cb45-38" aria-hidden="true"></a><span class="co">## #' Fused LASSO for scalar inputs.</span></span>
<span id="cb45-39"><a href="building-the-modelalgorithm.html#cb45-39" aria-hidden="true"></a><span class="co">## #'</span></span>
<span id="cb45-40"><a href="building-the-modelalgorithm.html#cb45-40" aria-hidden="true"></a><span class="co">## #' @param z scalar input to be smoothed via the fused LASSO</span></span>
<span id="cb45-41"><a href="building-the-modelalgorithm.html#cb45-41" aria-hidden="true"></a><span class="co">## #' @param lam  Fused LASSO smoothing parameter</span></span>
<span id="cb45-42"><a href="building-the-modelalgorithm.html#cb45-42" aria-hidden="true"></a><span class="co">## #'</span></span>
<span id="cb45-43"><a href="building-the-modelalgorithm.html#cb45-43" aria-hidden="true"></a><span class="co">## #' @return Estimates of the fused LASSO solution</span></span>
<span id="cb45-44"><a href="building-the-modelalgorithm.html#cb45-44" aria-hidden="true"></a><span class="co">## #' @export prox</span></span>
<span id="cb45-45"><a href="building-the-modelalgorithm.html#cb45-45" aria-hidden="true"></a><span class="co">## #'</span></span>
<span id="cb45-46"><a href="building-the-modelalgorithm.html#cb45-46" aria-hidden="true"></a><span class="co">## #' @references All credit for writing this function goes to Ryan Tibshirani. See</span></span>
<span id="cb45-47"><a href="building-the-modelalgorithm.html#cb45-47" aria-hidden="true"></a><span class="co">## #'   the original code for calling this function at</span></span>
<span id="cb45-48"><a href="building-the-modelalgorithm.html#cb45-48" aria-hidden="true"></a><span class="co">## #'</span></span>
<span id="cb45-49"><a href="building-the-modelalgorithm.html#cb45-49" aria-hidden="true"></a><span class="co">## #' @useDynLib FlowTF prox_dp </span></span>
<span id="cb45-50"><a href="building-the-modelalgorithm.html#cb45-50" aria-hidden="true"></a><span class="co">## <span id="prox">prox</span> &lt;-  function(z, lam) {</span></span>
<span id="cb45-51"><a href="building-the-modelalgorithm.html#cb45-51" aria-hidden="true"></a><span class="co">##   o &lt;- .C("prox_dp",  </span></span>
<span id="cb45-52"><a href="building-the-modelalgorithm.html#cb45-52" aria-hidden="true"></a><span class="co">##           as.integer(length(z)),</span></span>
<span id="cb45-53"><a href="building-the-modelalgorithm.html#cb45-53" aria-hidden="true"></a><span class="co">##           as.double(z),</span></span>
<span id="cb45-54"><a href="building-the-modelalgorithm.html#cb45-54" aria-hidden="true"></a><span class="co">##           as.double(lam),</span></span>
<span id="cb45-55"><a href="building-the-modelalgorithm.html#cb45-55" aria-hidden="true"></a><span class="co">##           as.double(numeric(length(z))),</span></span>
<span id="cb45-56"><a href="building-the-modelalgorithm.html#cb45-56" aria-hidden="true"></a><span class="co">##           #  dup=FALSE,</span></span>
<span id="cb45-57"><a href="building-the-modelalgorithm.html#cb45-57" aria-hidden="true"></a><span class="co">##           PACKAGE="FlowTF")</span></span>
<span id="cb45-58"><a href="building-the-modelalgorithm.html#cb45-58" aria-hidden="true"></a></span>
<span id="cb45-59"><a href="building-the-modelalgorithm.html#cb45-59" aria-hidden="true"></a><span class="co">##   return(o[[4]])</span></span>
<span id="cb45-60"><a href="building-the-modelalgorithm.html#cb45-60" aria-hidden="true"></a><span class="co">## }</span></span>
<span id="cb45-61"><a href="building-the-modelalgorithm.html#cb45-61" aria-hidden="true"></a></span>
<span id="cb45-62"><a href="building-the-modelalgorithm.html#cb45-62" aria-hidden="true"></a>Z_update  &lt;-<span class="st"> </span><span class="cf">function</span>(m, Uz, C, rho){</span>
<span id="cb45-63"><a href="building-the-modelalgorithm.html#cb45-63" aria-hidden="true"></a>  mat =<span class="st"> </span>m <span class="op">+</span><span class="st"> </span>Uz<span class="op">/</span>rho</span>
<span id="cb45-64"><a href="building-the-modelalgorithm.html#cb45-64" aria-hidden="true"></a>  Z =<span class="st"> </span><span class="kw">projCmat</span>(mat, C)</span>
<span id="cb45-65"><a href="building-the-modelalgorithm.html#cb45-65" aria-hidden="true"></a>  <span class="kw">return</span>(Z)</span>
<span id="cb45-66"><a href="building-the-modelalgorithm.html#cb45-66" aria-hidden="true"></a>}</span>
<span id="cb45-67"><a href="building-the-modelalgorithm.html#cb45-67" aria-hidden="true"></a></span>
<span id="cb45-68"><a href="building-the-modelalgorithm.html#cb45-68" aria-hidden="true"></a><span class="co">#' Project /rows/ of matrix |mat| into a ball of size C.</span></span>
<span id="cb45-69"><a href="building-the-modelalgorithm.html#cb45-69" aria-hidden="true"></a><span class="co">#' </span></span>
<span id="cb45-70"><a href="building-the-modelalgorithm.html#cb45-70" aria-hidden="true"></a><span class="co">#' @param mat Matrix whose rows will be projected into a C-sized ball.</span></span>
<span id="cb45-71"><a href="building-the-modelalgorithm.html#cb45-71" aria-hidden="true"></a><span class="co">#' @param C radius</span></span>
<span id="cb45-72"><a href="building-the-modelalgorithm.html#cb45-72" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb45-73"><a href="building-the-modelalgorithm.html#cb45-73" aria-hidden="true"></a><span class="co">#' @return Projected matrix.</span></span>
<span id="cb45-74"><a href="building-the-modelalgorithm.html#cb45-74" aria-hidden="true"></a>projCmat &lt;-<span class="st"> </span><span class="cf">function</span>(mat, C){</span>
<span id="cb45-75"><a href="building-the-modelalgorithm.html#cb45-75" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(C)){</span>
<span id="cb45-76"><a href="building-the-modelalgorithm.html#cb45-76" aria-hidden="true"></a>    vlens =<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">rowSums</span>(mat <span class="op">*</span><span class="st"> </span>mat))</span>
<span id="cb45-77"><a href="building-the-modelalgorithm.html#cb45-77" aria-hidden="true"></a>    inds =<span class="st"> </span><span class="kw">which</span>(vlens <span class="op">&gt;</span><span class="st"> </span>C)</span>
<span id="cb45-78"><a href="building-the-modelalgorithm.html#cb45-78" aria-hidden="true"></a>    <span class="cf">if</span>(<span class="kw">length</span>(inds) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>){</span>
<span id="cb45-79"><a href="building-the-modelalgorithm.html#cb45-79" aria-hidden="true"></a>      mat[inds,] =<span class="st"> </span>mat[inds,] <span class="op">*</span><span class="st"> </span>C <span class="op">/</span><span class="st"> </span>vlens[inds]</span>
<span id="cb45-80"><a href="building-the-modelalgorithm.html#cb45-80" aria-hidden="true"></a>    }</span>
<span id="cb45-81"><a href="building-the-modelalgorithm.html#cb45-81" aria-hidden="true"></a>  }</span>
<span id="cb45-82"><a href="building-the-modelalgorithm.html#cb45-82" aria-hidden="true"></a>  <span class="kw">return</span>(mat)</span>
<span id="cb45-83"><a href="building-the-modelalgorithm.html#cb45-83" aria-hidden="true"></a>}</span></code></pre></div>
<p>We will test the <code>projCmat</code> function.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="building-the-modelalgorithm.html#cb46-1" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb46-2"><a href="building-the-modelalgorithm.html#cb46-2" aria-hidden="true"></a>mat =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rnorm</span>(<span class="dv">100</span>), <span class="dt">ncol=</span><span class="dv">2</span>)</span>
<span id="cb46-3"><a href="building-the-modelalgorithm.html#cb46-3" aria-hidden="true"></a>projected_mat =<span class="st"> </span>flowtrend<span class="op">:::</span><span class="kw">projCmat</span>(mat, <span class="dv">1</span>)</span>
<span id="cb46-4"><a href="building-the-modelalgorithm.html#cb46-4" aria-hidden="true"></a><span class="kw">stopifnot</span>(<span class="kw">all</span>(projected_mat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">apply</span>(<span class="dv">1</span>, <span class="cf">function</span>(myrow)<span class="kw">sum</span>(myrow<span class="op">*</span>myrow)) <span class="op">&lt;</span><span class="st"> </span><span class="dv">1</span><span class="fl">+1E-8</span>))</span></code></pre></div>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="building-the-modelalgorithm.html#cb47-1" aria-hidden="true"></a><span class="co">#' @param U (T x dimdat) matrix.</span></span>
<span id="cb47-2"><a href="building-the-modelalgorithm.html#cb47-2" aria-hidden="true"></a>U_update_Z &lt;-<span class="st"> </span><span class="cf">function</span>(U, rho, mu, Z, TT){</span>
<span id="cb47-3"><a href="building-the-modelalgorithm.html#cb47-3" aria-hidden="true"></a> <span class="co"># return(U + rho * (scale(mu, scale = F) - Z))</span></span>
<span id="cb47-4"><a href="building-the-modelalgorithm.html#cb47-4" aria-hidden="true"></a>  <span class="kw">stopifnot</span>(<span class="kw">nrow</span>(U) <span class="op">==</span><span class="st"> </span>TT)</span>
<span id="cb47-5"><a href="building-the-modelalgorithm.html#cb47-5" aria-hidden="true"></a></span>
<span id="cb47-6"><a href="building-the-modelalgorithm.html#cb47-6" aria-hidden="true"></a>  centered_mu =<span class="st"> </span><span class="kw">sweep</span>(mu, <span class="dv">2</span>, <span class="kw">colMeans</span>(mu)) </span>
<span id="cb47-7"><a href="building-the-modelalgorithm.html#cb47-7" aria-hidden="true"></a>  <span class="co">## stopifnot(all(abs(colMeans(centered_mu))&lt;1E-8))</span></span>
<span id="cb47-8"><a href="building-the-modelalgorithm.html#cb47-8" aria-hidden="true"></a>  Unew =<span class="st"> </span>U <span class="op">+</span><span class="st"> </span>rho <span class="op">*</span><span class="st"> </span>(centered_mu <span class="op">-</span><span class="st"> </span>Z)</span>
<span id="cb47-9"><a href="building-the-modelalgorithm.html#cb47-9" aria-hidden="true"></a></span>
<span id="cb47-10"><a href="building-the-modelalgorithm.html#cb47-10" aria-hidden="true"></a>  <span class="co">## Expect a (T-l) x dimdat matrix.</span></span>
<span id="cb47-11"><a href="building-the-modelalgorithm.html#cb47-11" aria-hidden="true"></a>  <span class="kw">stopifnot</span>(<span class="kw">all</span>(<span class="kw">dim</span>(U) <span class="op">==</span><span class="st"> </span><span class="kw">dim</span>(Unew))) </span>
<span id="cb47-12"><a href="building-the-modelalgorithm.html#cb47-12" aria-hidden="true"></a>  <span class="kw">stopifnot</span>(<span class="kw">nrow</span>(U) <span class="op">==</span><span class="st"> </span>TT)</span>
<span id="cb47-13"><a href="building-the-modelalgorithm.html#cb47-13" aria-hidden="true"></a>  <span class="kw">return</span>(Unew)</span>
<span id="cb47-14"><a href="building-the-modelalgorithm.html#cb47-14" aria-hidden="true"></a>}</span>
<span id="cb47-15"><a href="building-the-modelalgorithm.html#cb47-15" aria-hidden="true"></a></span>
<span id="cb47-16"><a href="building-the-modelalgorithm.html#cb47-16" aria-hidden="true"></a><span class="co">#' @param U ((T-l) x dimdat) matrix.</span></span>
<span id="cb47-17"><a href="building-the-modelalgorithm.html#cb47-17" aria-hidden="true"></a>U_update_W &lt;-<span class="st"> </span><span class="cf">function</span>(U, rho, mu, W, l, Dl, TT){</span>
<span id="cb47-18"><a href="building-the-modelalgorithm.html#cb47-18" aria-hidden="true"></a></span>
<span id="cb47-19"><a href="building-the-modelalgorithm.html#cb47-19" aria-hidden="true"></a>  <span class="co"># l = 2 is quadratic trend filtering </span></span>
<span id="cb47-20"><a href="building-the-modelalgorithm.html#cb47-20" aria-hidden="true"></a>  <span class="co"># l = 1 is linear trend filtering</span></span>
<span id="cb47-21"><a href="building-the-modelalgorithm.html#cb47-21" aria-hidden="true"></a>  <span class="co"># l = 0 is fused lasso</span></span>
<span id="cb47-22"><a href="building-the-modelalgorithm.html#cb47-22" aria-hidden="true"></a>  <span class="co"># D^{(1)} is first differences, so it correponds to l=0</span></span>
<span id="cb47-23"><a href="building-the-modelalgorithm.html#cb47-23" aria-hidden="true"></a>  <span class="co"># D^{(l+1)} is used for order-l trend filtering.</span></span>
<span id="cb47-24"><a href="building-the-modelalgorithm.html#cb47-24" aria-hidden="true"></a>  <span class="kw">stopifnot</span>(<span class="kw">nrow</span>(W) <span class="op">==</span><span class="st"> </span>TT <span class="op">-</span><span class="st"> </span>l)</span>
<span id="cb47-25"><a href="building-the-modelalgorithm.html#cb47-25" aria-hidden="true"></a>  <span class="co">## if(l == 0){</span></span>
<span id="cb47-26"><a href="building-the-modelalgorithm.html#cb47-26" aria-hidden="true"></a>  <span class="co">##   Unew = U +  rho * (mu - W)</span></span>
<span id="cb47-27"><a href="building-the-modelalgorithm.html#cb47-27" aria-hidden="true"></a>  <span class="co">## } else {</span></span>
<span id="cb47-28"><a href="building-the-modelalgorithm.html#cb47-28" aria-hidden="true"></a>  <span class="co">##   Unew = U + rho * ( diff(mu, differences = l) - W)</span></span>
<span id="cb47-29"><a href="building-the-modelalgorithm.html#cb47-29" aria-hidden="true"></a>  <span class="co">## }</span></span>
<span id="cb47-30"><a href="building-the-modelalgorithm.html#cb47-30" aria-hidden="true"></a>  Unew &lt;-<span class="st"> </span>U <span class="op">+</span><span class="st"> </span>rho <span class="op">*</span><span class="st"> </span>(Dl <span class="op">%*%</span><span class="st"> </span>mu <span class="op">-</span><span class="st"> </span>W)</span>
<span id="cb47-31"><a href="building-the-modelalgorithm.html#cb47-31" aria-hidden="true"></a></span>
<span id="cb47-32"><a href="building-the-modelalgorithm.html#cb47-32" aria-hidden="true"></a>  <span class="co">## Expect a (T-l) x dimdat matrix.</span></span>
<span id="cb47-33"><a href="building-the-modelalgorithm.html#cb47-33" aria-hidden="true"></a>  <span class="kw">stopifnot</span>(<span class="kw">all</span>(<span class="kw">dim</span>(U) <span class="op">==</span><span class="st"> </span><span class="kw">dim</span>(Unew))) </span>
<span id="cb47-34"><a href="building-the-modelalgorithm.html#cb47-34" aria-hidden="true"></a>  <span class="kw">stopifnot</span>(<span class="kw">nrow</span>(U) <span class="op">==</span><span class="st"> </span>TT<span class="op">-</span>l)</span>
<span id="cb47-35"><a href="building-the-modelalgorithm.html#cb47-35" aria-hidden="true"></a>  <span class="kw">return</span>(Unew)</span>
<span id="cb47-36"><a href="building-the-modelalgorithm.html#cb47-36" aria-hidden="true"></a>}</span></code></pre></div>
<p>Here is that main workhorse <code>admm_oneclust()</code>.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="building-the-modelalgorithm.html#cb48-1" aria-hidden="true"></a><span class="co">#' One cluster's admm for a fixed step size (rho).</span></span>
<span id="cb48-2"><a href="building-the-modelalgorithm.html#cb48-2" aria-hidden="true"></a>admm_oneclust &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">iclust =</span> <span class="dv">1</span>, niter, y,</span>
<span id="cb48-3"><a href="building-the-modelalgorithm.html#cb48-3" aria-hidden="true"></a>                          Dl, tDl, Dlp1, <span class="dt">l =</span> <span class="ot">NULL</span>,</span>
<span id="cb48-4"><a href="building-the-modelalgorithm.html#cb48-4" aria-hidden="true"></a>                          TT, N, dimdat, maxdev,</span>
<span id="cb48-5"><a href="building-the-modelalgorithm.html#cb48-5" aria-hidden="true"></a>                          rho,</span>
<span id="cb48-6"><a href="building-the-modelalgorithm.html#cb48-6" aria-hidden="true"></a>                          <span class="dt">rhoinit =</span> rho,</span>
<span id="cb48-7"><a href="building-the-modelalgorithm.html#cb48-7" aria-hidden="true"></a>                          Xinv,</span>
<span id="cb48-8"><a href="building-the-modelalgorithm.html#cb48-8" aria-hidden="true"></a>                          schurA,</span>
<span id="cb48-9"><a href="building-the-modelalgorithm.html#cb48-9" aria-hidden="true"></a>                          schurB,</span>
<span id="cb48-10"><a href="building-the-modelalgorithm.html#cb48-10" aria-hidden="true"></a>                          sigmainv,</span>
<span id="cb48-11"><a href="building-the-modelalgorithm.html#cb48-11" aria-hidden="true"></a>                          lambda,</span>
<span id="cb48-12"><a href="building-the-modelalgorithm.html#cb48-12" aria-hidden="true"></a>                          resp,</span>
<span id="cb48-13"><a href="building-the-modelalgorithm.html#cb48-13" aria-hidden="true"></a>                          resp_sum,</span>
<span id="cb48-14"><a href="building-the-modelalgorithm.html#cb48-14" aria-hidden="true"></a>                          ylist, <span class="dt">err_rel =</span> <span class="fl">1e-3</span>, <span class="dt">err_abs =</span> <span class="dv">0</span>,</span>
<span id="cb48-15"><a href="building-the-modelalgorithm.html#cb48-15" aria-hidden="true"></a>                          zerothresh,</span>
<span id="cb48-16"><a href="building-the-modelalgorithm.html#cb48-16" aria-hidden="true"></a>                          mu, </span>
<span id="cb48-17"><a href="building-the-modelalgorithm.html#cb48-17" aria-hidden="true"></a>                          z,</span>
<span id="cb48-18"><a href="building-the-modelalgorithm.html#cb48-18" aria-hidden="true"></a>                          w,</span>
<span id="cb48-19"><a href="building-the-modelalgorithm.html#cb48-19" aria-hidden="true"></a>                          uw,</span>
<span id="cb48-20"><a href="building-the-modelalgorithm.html#cb48-20" aria-hidden="true"></a>                          uz,</span>
<span id="cb48-21"><a href="building-the-modelalgorithm.html#cb48-21" aria-hidden="true"></a>                          <span class="co">## warmstart = FALSE,</span></span>
<span id="cb48-22"><a href="building-the-modelalgorithm.html#cb48-22" aria-hidden="true"></a>                          <span class="co">## mu.warm = if(!warmstart) NULL,</span></span>
<span id="cb48-23"><a href="building-the-modelalgorithm.html#cb48-23" aria-hidden="true"></a>                          first_iter,<span class="co">## Not used </span></span>
<span id="cb48-24"><a href="building-the-modelalgorithm.html#cb48-24" aria-hidden="true"></a>                          iter,</span>
<span id="cb48-25"><a href="building-the-modelalgorithm.html#cb48-25" aria-hidden="true"></a>                          outer_iter,</span>
<span id="cb48-26"><a href="building-the-modelalgorithm.html#cb48-26" aria-hidden="true"></a>                          local_adapt,</span>
<span id="cb48-27"><a href="building-the-modelalgorithm.html#cb48-27" aria-hidden="true"></a>                          sigma,</span>
<span id="cb48-28"><a href="building-the-modelalgorithm.html#cb48-28" aria-hidden="true"></a>                          sigma_eig_by_clust){</span>
<span id="cb48-29"><a href="building-the-modelalgorithm.html#cb48-29" aria-hidden="true"></a></span>
<span id="cb48-30"><a href="building-the-modelalgorithm.html#cb48-30" aria-hidden="true"></a>  <span class="co">## Initialize the variables </span><span class="al">###</span></span>
<span id="cb48-31"><a href="building-the-modelalgorithm.html#cb48-31" aria-hidden="true"></a>  <span class="co">## resid_mat = matrix(NA, nrow = ceiling(niter/5), ncol = 4)</span></span>
<span id="cb48-32"><a href="building-the-modelalgorithm.html#cb48-32" aria-hidden="true"></a>  <span class="co">## colnames(resid_mat) = c("primresid", "primerr", "dualresid", "dualerr")</span></span>
<span id="cb48-33"><a href="building-the-modelalgorithm.html#cb48-33" aria-hidden="true"></a>  resid_mat =<span class="st"> </span><span class="kw">matrix</span>(<span class="ot">NA</span>, <span class="dt">nrow =</span> <span class="kw">ceiling</span>(niter<span class="op">/</span><span class="dv">5</span>), <span class="dt">ncol =</span> <span class="dv">6</span>)</span>
<span id="cb48-34"><a href="building-the-modelalgorithm.html#cb48-34" aria-hidden="true"></a>  <span class="kw">colnames</span>(resid_mat) =<span class="st"> </span><span class="kw">c</span>(<span class="st">"prim1"</span>, <span class="st">"prim2"</span>, <span class="st">"primresid"</span>, <span class="st">"primerr"</span>, <span class="st">"dualresid"</span>, <span class="st">"dualerr"</span>)</span>
<span id="cb48-35"><a href="building-the-modelalgorithm.html#cb48-35" aria-hidden="true"></a>  rhofac =<span class="st"> </span>rho <span class="op">/</span><span class="st"> </span>rhoinit </span>
<span id="cb48-36"><a href="building-the-modelalgorithm.html#cb48-36" aria-hidden="true"></a></span>
<span id="cb48-37"><a href="building-the-modelalgorithm.html#cb48-37" aria-hidden="true"></a>  </span>
<span id="cb48-38"><a href="building-the-modelalgorithm.html#cb48-38" aria-hidden="true"></a></span>
<span id="cb48-39"><a href="building-the-modelalgorithm.html#cb48-39" aria-hidden="true"></a>  <span class="co">## This doesn't change over iterations</span></span>
<span id="cb48-40"><a href="building-the-modelalgorithm.html#cb48-40" aria-hidden="true"></a>  schurB =<span class="st"> </span><span class="kw">myschur</span>(schurB<span class="op">$</span>orig <span class="op">*</span><span class="st"> </span>rhofac) <span class="co">## In flowmix, this is done on A. Here, it's done on B (in AX + XB + C = 0).</span></span>
<span id="cb48-41"><a href="building-the-modelalgorithm.html#cb48-41" aria-hidden="true"></a>  TA =<span class="st"> </span>schurA<span class="op">$</span>T <span class="co">##* rhofac</span></span>
<span id="cb48-42"><a href="building-the-modelalgorithm.html#cb48-42" aria-hidden="true"></a>  TB =<span class="st"> </span>schurB<span class="op">$</span>T</span>
<span id="cb48-43"><a href="building-the-modelalgorithm.html#cb48-43" aria-hidden="true"></a>  UA =<span class="st"> </span>schurA<span class="op">$</span>Q</span>
<span id="cb48-44"><a href="building-the-modelalgorithm.html#cb48-44" aria-hidden="true"></a>  UB =<span class="st"> </span>schurB<span class="op">$</span>Q</span>
<span id="cb48-45"><a href="building-the-modelalgorithm.html#cb48-45" aria-hidden="true"></a>  tUA =<span class="st"> </span>schurA<span class="op">$</span>tQ</span>
<span id="cb48-46"><a href="building-the-modelalgorithm.html#cb48-46" aria-hidden="true"></a>  tUB =<span class="st"> </span>schurB<span class="op">$</span>tQ</span>
<span id="cb48-47"><a href="building-the-modelalgorithm.html#cb48-47" aria-hidden="true"></a></span>
<span id="cb48-48"><a href="building-the-modelalgorithm.html#cb48-48" aria-hidden="true"></a>  <span class="co">## This also doesn't change over iterations</span></span>
<span id="cb48-49"><a href="building-the-modelalgorithm.html#cb48-49" aria-hidden="true"></a>  C1 &lt;-<span class="st"> </span><span class="kw">do.call</span>(cbind, <span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>TT, <span class="dt">FUN =</span> <span class="cf">function</span>(tt){</span>
<span id="cb48-50"><a href="building-the-modelalgorithm.html#cb48-50" aria-hidden="true"></a>      multmat &lt;-<span class="st"> </span><span class="kw">apply</span>(y[[tt]], <span class="dt">FUN =</span> <span class="cf">function</span>(yy) yy <span class="op">*</span><span class="st"> </span>resp[[tt]], <span class="dt">MARGIN =</span> <span class="dv">2</span>)</span>
<span id="cb48-51"><a href="building-the-modelalgorithm.html#cb48-51" aria-hidden="true"></a>      sigmainv <span class="op">%*%</span><span class="st"> </span><span class="kw">colSums</span>(multmat)</span>
<span id="cb48-52"><a href="building-the-modelalgorithm.html#cb48-52" aria-hidden="true"></a>    }))</span>
<span id="cb48-53"><a href="building-the-modelalgorithm.html#cb48-53" aria-hidden="true"></a></span>
<span id="cb48-54"><a href="building-the-modelalgorithm.html#cb48-54" aria-hidden="true"></a></span>
<span id="cb48-55"><a href="building-the-modelalgorithm.html#cb48-55" aria-hidden="true"></a>  <span class="cf">for</span>(iter <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>niter){</span>
<span id="cb48-56"><a href="building-the-modelalgorithm.html#cb48-56" aria-hidden="true"></a>    syl_C &lt;-<span class="st"> </span><span class="kw">get_C_mat</span>(<span class="dt">C1 =</span> C1, <span class="dt">resp_sum =</span> resp_sum, <span class="dt">TT =</span> TT, <span class="dt">dimdat =</span> dimdat,</span>
<span id="cb48-57"><a href="building-the-modelalgorithm.html#cb48-57" aria-hidden="true"></a>                       <span class="dt">Sigma_inv =</span> sigmainv, <span class="dt">N =</span> N, <span class="dt">Dl =</span> Dl, <span class="dt">rho =</span> rho,</span>
<span id="cb48-58"><a href="building-the-modelalgorithm.html#cb48-58" aria-hidden="true"></a>                       <span class="dt">z =</span> z, <span class="dt">w =</span> w, <span class="dt">uz =</span> uz, <span class="dt">uw =</span> uw, <span class="dt">l=</span>l)</span>
<span id="cb48-59"><a href="building-the-modelalgorithm.html#cb48-59" aria-hidden="true"></a>    FF =<span class="st">  </span>(<span class="op">-</span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span>tUA <span class="op">%*%</span><span class="st"> </span>syl_C <span class="op">%*%</span><span class="st"> </span>UB</span>
<span id="cb48-60"><a href="building-the-modelalgorithm.html#cb48-60" aria-hidden="true"></a>    mu =<span class="st"> </span>UA <span class="op">%*%</span><span class="st"> </span><span class="kw">matrix_function_solve_triangular_sylvester_barebonesC2</span>(TA, TB, FF) <span class="op">%*%</span><span class="st"> </span>tUB</span>
<span id="cb48-61"><a href="building-the-modelalgorithm.html#cb48-61" aria-hidden="true"></a>    mu =<span class="st"> </span><span class="kw">t</span>(mu)</span>
<span id="cb48-62"><a href="building-the-modelalgorithm.html#cb48-62" aria-hidden="true"></a>    <span class="kw">stopifnot</span>(<span class="kw">nrow</span>(mu) <span class="op">==</span><span class="st"> </span>TT)</span>
<span id="cb48-63"><a href="building-the-modelalgorithm.html#cb48-63" aria-hidden="true"></a>    <span class="kw">stopifnot</span>(<span class="kw">ncol</span>(mu) <span class="op">==</span><span class="st"> </span>dimdat)</span>
<span id="cb48-64"><a href="building-the-modelalgorithm.html#cb48-64" aria-hidden="true"></a></span>
<span id="cb48-65"><a href="building-the-modelalgorithm.html#cb48-65" aria-hidden="true"></a>    <span class="co">## if(warmstart &amp; iter == 1){</span></span>
<span id="cb48-66"><a href="building-the-modelalgorithm.html#cb48-66" aria-hidden="true"></a>    <span class="co">##   print("warmed up mu!")</span></span>
<span id="cb48-67"><a href="building-the-modelalgorithm.html#cb48-67" aria-hidden="true"></a>    <span class="co">##   mu = mu.warm</span></span>
<span id="cb48-68"><a href="building-the-modelalgorithm.html#cb48-68" aria-hidden="true"></a>    <span class="co">## }</span></span>
<span id="cb48-69"><a href="building-the-modelalgorithm.html#cb48-69" aria-hidden="true"></a></span>
<span id="cb48-70"><a href="building-the-modelalgorithm.html#cb48-70" aria-hidden="true"></a>    centered_mu =<span class="st"> </span><span class="kw">sweep</span>(mu, <span class="dv">2</span>, <span class="kw">colMeans</span>(mu)) </span>
<span id="cb48-71"><a href="building-the-modelalgorithm.html#cb48-71" aria-hidden="true"></a>    <span class="co">## stopifnot(all(abs(colMeans(centered_mu))&lt;1E-8))</span></span>
<span id="cb48-72"><a href="building-the-modelalgorithm.html#cb48-72" aria-hidden="true"></a>    z &lt;-<span class="st"> </span><span class="kw">Z_update</span>(centered_mu, <span class="dt">Uz =</span> uz, <span class="dt">C =</span> maxdev, <span class="dt">rho =</span> rho)</span>
<span id="cb48-73"><a href="building-the-modelalgorithm.html#cb48-73" aria-hidden="true"></a></span>
<span id="cb48-74"><a href="building-the-modelalgorithm.html#cb48-74" aria-hidden="true"></a>    <span class="cf">if</span>(<span class="kw">any</span>(<span class="kw">abs</span>(mu)<span class="op">&gt;</span><span class="fl">1E2</span>)){</span>
<span id="cb48-75"><a href="building-the-modelalgorithm.html#cb48-75" aria-hidden="true"></a>      <span class="kw">stop</span>(<span class="st">"mu is blowing up!"</span>)</span>
<span id="cb48-76"><a href="building-the-modelalgorithm.html#cb48-76" aria-hidden="true"></a>      <span class="co">## break</span></span>
<span id="cb48-77"><a href="building-the-modelalgorithm.html#cb48-77" aria-hidden="true"></a>    }</span>
<span id="cb48-78"><a href="building-the-modelalgorithm.html#cb48-78" aria-hidden="true"></a>    wlist =<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>dimdat, <span class="cf">function</span>(j){</span>
<span id="cb48-79"><a href="building-the-modelalgorithm.html#cb48-79" aria-hidden="true"></a>      <span class="kw">W_update_fused</span>(<span class="dt">l =</span> l, <span class="dt">TT =</span> TT, <span class="dt">mu =</span> mu[, j, <span class="dt">drop =</span> <span class="ot">TRUE</span>],</span>
<span id="cb48-80"><a href="building-the-modelalgorithm.html#cb48-80" aria-hidden="true"></a>                     <span class="dt">rho =</span> rho, <span class="dt">lambda =</span> lambda,</span>
<span id="cb48-81"><a href="building-the-modelalgorithm.html#cb48-81" aria-hidden="true"></a>                     <span class="dt">uw =</span> uw[,j,<span class="dt">drop=</span><span class="ot">TRUE</span>],</span>
<span id="cb48-82"><a href="building-the-modelalgorithm.html#cb48-82" aria-hidden="true"></a>                     <span class="dt">Dl =</span> Dl)})</span>
<span id="cb48-83"><a href="building-the-modelalgorithm.html#cb48-83" aria-hidden="true"></a>    w &lt;-<span class="st"> </span><span class="kw">do.call</span>(cbind, wlist)</span>
<span id="cb48-84"><a href="building-the-modelalgorithm.html#cb48-84" aria-hidden="true"></a>    <span class="kw">stopifnot</span>(<span class="kw">nrow</span>(w) <span class="op">==</span><span class="st"> </span>TT<span class="op">-</span>l)</span>
<span id="cb48-85"><a href="building-the-modelalgorithm.html#cb48-85" aria-hidden="true"></a>    <span class="kw">stopifnot</span>(<span class="kw">ncol</span>(w) <span class="op">==</span><span class="st"> </span>dimdat)</span>
<span id="cb48-86"><a href="building-the-modelalgorithm.html#cb48-86" aria-hidden="true"></a></span>
<span id="cb48-87"><a href="building-the-modelalgorithm.html#cb48-87" aria-hidden="true"></a>    uz =<span class="st"> </span><span class="kw">U_update_Z</span>(uz, rho, mu, z, TT)</span>
<span id="cb48-88"><a href="building-the-modelalgorithm.html#cb48-88" aria-hidden="true"></a></span>
<span id="cb48-89"><a href="building-the-modelalgorithm.html#cb48-89" aria-hidden="true"></a>    <span class="co">## uw = U_update_W(uw, rho, mu, w, l, TT)</span></span>
<span id="cb48-90"><a href="building-the-modelalgorithm.html#cb48-90" aria-hidden="true"></a>    uw =<span class="st"> </span><span class="kw">U_update_W</span>(uw, rho, mu, w, l, Dl, TT)</span>
<span id="cb48-91"><a href="building-the-modelalgorithm.html#cb48-91" aria-hidden="true"></a></span>
<span id="cb48-92"><a href="building-the-modelalgorithm.html#cb48-92" aria-hidden="true"></a>    <span class="co">## Check convergence</span></span>
<span id="cb48-93"><a href="building-the-modelalgorithm.html#cb48-93" aria-hidden="true"></a>    <span class="cf">if</span>( iter <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>  <span class="op">&amp;</span><span class="st"> </span>iter <span class="op">%%</span><span class="st"> </span><span class="dv">5</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>){<span class="co">## &amp; !local_adapt){</span></span>
<span id="cb48-94"><a href="building-the-modelalgorithm.html#cb48-94" aria-hidden="true"></a></span>
<span id="cb48-95"><a href="building-the-modelalgorithm.html#cb48-95" aria-hidden="true"></a>      <span class="co">## Calculate convergence criterion</span></span>
<span id="cb48-96"><a href="building-the-modelalgorithm.html#cb48-96" aria-hidden="true"></a>      obj =<span class="st"> </span><span class="kw">check_converge</span>(mu, rho,</span>
<span id="cb48-97"><a href="building-the-modelalgorithm.html#cb48-97" aria-hidden="true"></a>                           w, z,</span>
<span id="cb48-98"><a href="building-the-modelalgorithm.html#cb48-98" aria-hidden="true"></a>                           w_prev, z_prev,</span>
<span id="cb48-99"><a href="building-the-modelalgorithm.html#cb48-99" aria-hidden="true"></a>                           uw, uz,</span>
<span id="cb48-100"><a href="building-the-modelalgorithm.html#cb48-100" aria-hidden="true"></a>                           Dl, tDl, <span class="dt">err_rel =</span> err_rel, <span class="dt">err_abs =</span> err_abs)</span>
<span id="cb48-101"><a href="building-the-modelalgorithm.html#cb48-101" aria-hidden="true"></a></span>
<span id="cb48-102"><a href="building-the-modelalgorithm.html#cb48-102" aria-hidden="true"></a>      jj =<span class="st"> </span>(iter<span class="op">/</span><span class="st"> </span><span class="dv">5</span>)</span>
<span id="cb48-103"><a href="building-the-modelalgorithm.html#cb48-103" aria-hidden="true"></a>      resid_mat[jj,] =<span class="st"> </span><span class="kw">c</span>(</span>
<span id="cb48-104"><a href="building-the-modelalgorithm.html#cb48-104" aria-hidden="true"></a>          <span class="kw">norm</span>(obj<span class="op">$</span>primal_resid1, <span class="st">"F"</span>), <span class="co">## Temp</span></span>
<span id="cb48-105"><a href="building-the-modelalgorithm.html#cb48-105" aria-hidden="true"></a>          <span class="kw">norm</span>(obj<span class="op">$</span>primal_resid2, <span class="st">"F"</span>), <span class="co">## Temp</span></span>
<span id="cb48-106"><a href="building-the-modelalgorithm.html#cb48-106" aria-hidden="true"></a>          <span class="kw">norm</span>(obj<span class="op">$</span>primal_resid, <span class="st">"F"</span>),</span>
<span id="cb48-107"><a href="building-the-modelalgorithm.html#cb48-107" aria-hidden="true"></a>                         obj<span class="op">$</span>primal_err,</span>
<span id="cb48-108"><a href="building-the-modelalgorithm.html#cb48-108" aria-hidden="true"></a>                         <span class="kw">norm</span>(obj<span class="op">$</span>dual_resid,<span class="st">"F"</span>),</span>
<span id="cb48-109"><a href="building-the-modelalgorithm.html#cb48-109" aria-hidden="true"></a>                         obj<span class="op">$</span>dual_err)</span>
<span id="cb48-110"><a href="building-the-modelalgorithm.html#cb48-110" aria-hidden="true"></a></span>
<span id="cb48-111"><a href="building-the-modelalgorithm.html#cb48-111" aria-hidden="true"></a>      <span class="cf">if</span>(<span class="kw">is.na</span>(obj<span class="op">$</span>converge)){</span>
<span id="cb48-112"><a href="building-the-modelalgorithm.html#cb48-112" aria-hidden="true"></a>        obj<span class="op">$</span>converge =<span class="st"> </span>converge =<span class="st"> </span><span class="ot">FALSE</span></span>
<span id="cb48-113"><a href="building-the-modelalgorithm.html#cb48-113" aria-hidden="true"></a>        <span class="kw">warning</span>(<span class="st">"Convergence was NA"</span>)</span>
<span id="cb48-114"><a href="building-the-modelalgorithm.html#cb48-114" aria-hidden="true"></a>      }</span>
<span id="cb48-115"><a href="building-the-modelalgorithm.html#cb48-115" aria-hidden="true"></a>      <span class="cf">if</span>(obj<span class="op">$</span>converge){</span>
<span id="cb48-116"><a href="building-the-modelalgorithm.html#cb48-116" aria-hidden="true"></a>        converge =<span class="st"> </span><span class="ot">TRUE</span></span>
<span id="cb48-117"><a href="building-the-modelalgorithm.html#cb48-117" aria-hidden="true"></a>        <span class="cf">break</span></span>
<span id="cb48-118"><a href="building-the-modelalgorithm.html#cb48-118" aria-hidden="true"></a>      } <span class="cf">else</span> {</span>
<span id="cb48-119"><a href="building-the-modelalgorithm.html#cb48-119" aria-hidden="true"></a>        converge =<span class="st"> </span><span class="ot">FALSE</span></span>
<span id="cb48-120"><a href="building-the-modelalgorithm.html#cb48-120" aria-hidden="true"></a>      }</span>
<span id="cb48-121"><a href="building-the-modelalgorithm.html#cb48-121" aria-hidden="true"></a>    }</span>
<span id="cb48-122"><a href="building-the-modelalgorithm.html#cb48-122" aria-hidden="true"></a>    w_prev =<span class="st"> </span>w</span>
<span id="cb48-123"><a href="building-the-modelalgorithm.html#cb48-123" aria-hidden="true"></a>    z_prev =<span class="st"> </span>z</span>
<span id="cb48-124"><a href="building-the-modelalgorithm.html#cb48-124" aria-hidden="true"></a>  }</span>
<span id="cb48-125"><a href="building-the-modelalgorithm.html#cb48-125" aria-hidden="true"></a></span>
<span id="cb48-126"><a href="building-the-modelalgorithm.html#cb48-126" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="ot">FALSE</span>){</span>
<span id="cb48-127"><a href="building-the-modelalgorithm.html#cb48-127" aria-hidden="true"></a>    <span class="co">## Calculate optimization objective values for this cluster.</span></span>
<span id="cb48-128"><a href="building-the-modelalgorithm.html#cb48-128" aria-hidden="true"></a>    obj.value &lt;-<span class="st"> </span><span class="kw">objective_per_cluster</span>(<span class="dt">y =</span> y, <span class="dt">mu =</span> mu, <span class="dt">resp =</span> resp,</span>
<span id="cb48-129"><a href="building-the-modelalgorithm.html#cb48-129" aria-hidden="true"></a>                                       <span class="dt">Sigma_inv =</span> sigmainv, <span class="dt">TT =</span> TT,</span>
<span id="cb48-130"><a href="building-the-modelalgorithm.html#cb48-130" aria-hidden="true"></a>                                       <span class="dt">d =</span> dimdat, <span class="dt">Dlp1 =</span> Dlp1, <span class="dt">Dl =</span> Dl, <span class="dt">l =</span> l,</span>
<span id="cb48-131"><a href="building-the-modelalgorithm.html#cb48-131" aria-hidden="true"></a>                                       <span class="dt">maxdev =</span> maxdev, <span class="dt">lambda =</span> lambda,</span>
<span id="cb48-132"><a href="building-the-modelalgorithm.html#cb48-132" aria-hidden="true"></a>                                       <span class="dt">rho =</span> rho, <span class="dt">N =</span> N)</span>
<span id="cb48-133"><a href="building-the-modelalgorithm.html#cb48-133" aria-hidden="true"></a>    <span class="co">## This is very expensive to do within each ADMM iteration, so it's commented out for now.</span></span>
<span id="cb48-134"><a href="building-the-modelalgorithm.html#cb48-134" aria-hidden="true"></a>  }</span>
<span id="cb48-135"><a href="building-the-modelalgorithm.html#cb48-135" aria-hidden="true"></a>  obj.value =<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb48-136"><a href="building-the-modelalgorithm.html#cb48-136" aria-hidden="true"></a></span>
<span id="cb48-137"><a href="building-the-modelalgorithm.html#cb48-137" aria-hidden="true"></a>  <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">mu =</span> mu,</span>
<span id="cb48-138"><a href="building-the-modelalgorithm.html#cb48-138" aria-hidden="true"></a>              <span class="dt">resid_mat =</span> resid_mat,</span>
<span id="cb48-139"><a href="building-the-modelalgorithm.html#cb48-139" aria-hidden="true"></a>              <span class="dt">converge =</span> converge,</span>
<span id="cb48-140"><a href="building-the-modelalgorithm.html#cb48-140" aria-hidden="true"></a>              <span class="co">## Other variables to return.</span></span>
<span id="cb48-141"><a href="building-the-modelalgorithm.html#cb48-141" aria-hidden="true"></a>              <span class="dt">Z =</span> z,</span>
<span id="cb48-142"><a href="building-the-modelalgorithm.html#cb48-142" aria-hidden="true"></a>              <span class="dt">W =</span> w,</span>
<span id="cb48-143"><a href="building-the-modelalgorithm.html#cb48-143" aria-hidden="true"></a>              <span class="dt">uz =</span> uz,</span>
<span id="cb48-144"><a href="building-the-modelalgorithm.html#cb48-144" aria-hidden="true"></a>              <span class="dt">uw =</span> uw,</span>
<span id="cb48-145"><a href="building-the-modelalgorithm.html#cb48-145" aria-hidden="true"></a>              <span class="dt">inner.iter =</span> iter,</span>
<span id="cb48-146"><a href="building-the-modelalgorithm.html#cb48-146" aria-hidden="true"></a>              <span class="dt">single_admm_objective =</span> obj.value))</span>
<span id="cb48-147"><a href="building-the-modelalgorithm.html#cb48-147" aria-hidden="true"></a>}</span></code></pre></div>
</div>
<div id="helpers-for-m-step-mu" class="section level3 hasAnchor" number="3.5.4">
<h3>
<span class="header-section-number">3.5.4</span> Helpers for M step (<span class="math inline">\(\mu\)</span>)<a href="building-the-modelalgorithm.html#helpers-for-m-step-mu" class="anchor-section" aria-label="Anchor link to header"></a>
</h3>
<p>First, let’s start with a few helper functions.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="building-the-modelalgorithm.html#cb49-1" aria-hidden="true"></a><span class="co">#' @param TT Number of time points.</span></span>
<span id="cb49-2"><a href="building-the-modelalgorithm.html#cb49-2" aria-hidden="true"></a>etilde_mat &lt;-<span class="st"> </span><span class="cf">function</span>(TT){</span>
<span id="cb49-3"><a href="building-the-modelalgorithm.html#cb49-3" aria-hidden="true"></a></span>
<span id="cb49-4"><a href="building-the-modelalgorithm.html#cb49-4" aria-hidden="true"></a>  mats &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>TT, <span class="dt">FUN =</span> <span class="cf">function</span>(t){</span>
<span id="cb49-5"><a href="building-the-modelalgorithm.html#cb49-5" aria-hidden="true"></a>    e_vec &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>, TT)</span>
<span id="cb49-6"><a href="building-the-modelalgorithm.html#cb49-6" aria-hidden="true"></a>    e_vec[t] &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb49-7"><a href="building-the-modelalgorithm.html#cb49-7" aria-hidden="true"></a>    (e_vec <span class="op">-</span><span class="st"> </span><span class="dv">1</span><span class="op">/</span>TT) <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(e_vec <span class="op">-</span><span class="st"> </span><span class="dv">1</span><span class="op">/</span>TT)</span>
<span id="cb49-8"><a href="building-the-modelalgorithm.html#cb49-8" aria-hidden="true"></a>  })</span>
<span id="cb49-9"><a href="building-the-modelalgorithm.html#cb49-9" aria-hidden="true"></a>  <span class="kw">Reduce</span>(<span class="st">'+'</span>, mats)</span>
<span id="cb49-10"><a href="building-the-modelalgorithm.html#cb49-10" aria-hidden="true"></a>}</span>
<span id="cb49-11"><a href="building-the-modelalgorithm.html#cb49-11" aria-hidden="true"></a></span>
<span id="cb49-12"><a href="building-the-modelalgorithm.html#cb49-12" aria-hidden="true"></a>get_AB_mats &lt;-<span class="st"> </span><span class="cf">function</span>(y, resp, Sigma_inv, e_mat, Dlsqrd, N, Dlp1, Dl, rho, z, w, uz, uw){</span>
<span id="cb49-13"><a href="building-the-modelalgorithm.html#cb49-13" aria-hidden="true"></a></span>
<span id="cb49-14"><a href="building-the-modelalgorithm.html#cb49-14" aria-hidden="true"></a>  <span class="co"># A matrix</span></span>
<span id="cb49-15"><a href="building-the-modelalgorithm.html#cb49-15" aria-hidden="true"></a>  A &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">/</span>N <span class="op">*</span><span class="st"> </span>Sigma_inv</span>
<span id="cb49-16"><a href="building-the-modelalgorithm.html#cb49-16" aria-hidden="true"></a></span>
<span id="cb49-17"><a href="building-the-modelalgorithm.html#cb49-17" aria-hidden="true"></a>  <span class="co"># B matrix</span></span>
<span id="cb49-18"><a href="building-the-modelalgorithm.html#cb49-18" aria-hidden="true"></a>  sum_resp &lt;-<span class="st"> </span><span class="kw">sapply</span>(resp, sum)</span>
<span id="cb49-19"><a href="building-the-modelalgorithm.html#cb49-19" aria-hidden="true"></a>  <span class="co">#B &lt;- rho*(t(Dl)%*%Dl + e_mat)%*% diag(1/unlist(sum_resp))</span></span>
<span id="cb49-20"><a href="building-the-modelalgorithm.html#cb49-20" aria-hidden="true"></a>  B &lt;-<span class="st"> </span>rho<span class="op">*</span>(Dlsqrd <span class="op">+</span><span class="st"> </span>e_mat)</span>
<span id="cb49-21"><a href="building-the-modelalgorithm.html#cb49-21" aria-hidden="true"></a>  B &lt;-<span class="st"> </span>B<span class="op">/</span>sum_resp[<span class="kw">col</span>(B)]</span>
<span id="cb49-22"><a href="building-the-modelalgorithm.html#cb49-22" aria-hidden="true"></a>  <span class="co">#B &lt;- rho*(Dlsqrd + e_mat)  %*% diag(1/unlist(sum_resp))</span></span>
<span id="cb49-23"><a href="building-the-modelalgorithm.html#cb49-23" aria-hidden="true"></a></span>
<span id="cb49-24"><a href="building-the-modelalgorithm.html#cb49-24" aria-hidden="true"></a>  <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">A =</span> A, <span class="dt">B =</span> B))</span>
<span id="cb49-25"><a href="building-the-modelalgorithm.html#cb49-25" aria-hidden="true"></a>}</span>
<span id="cb49-26"><a href="building-the-modelalgorithm.html#cb49-26" aria-hidden="true"></a></span>
<span id="cb49-27"><a href="building-the-modelalgorithm.html#cb49-27" aria-hidden="true"></a>get_C_mat &lt;-<span class="st"> </span><span class="cf">function</span>(C1, resp_sum, TT, dimdat, Sigma_inv, e_mat, N, Dlp1, Dl,</span>
<span id="cb49-28"><a href="building-the-modelalgorithm.html#cb49-28" aria-hidden="true"></a>                      rho, z, w, uz, uw, l){</span>
<span id="cb49-29"><a href="building-the-modelalgorithm.html#cb49-29" aria-hidden="true"></a></span>
<span id="cb49-30"><a href="building-the-modelalgorithm.html#cb49-30" aria-hidden="true"></a>  C2 &lt;-<span class="st"> </span><span class="kw">t</span>(uz <span class="op">-</span><span class="st"> </span>rho<span class="op">*</span>z)</span>
<span id="cb49-31"><a href="building-the-modelalgorithm.html#cb49-31" aria-hidden="true"></a></span>
<span id="cb49-32"><a href="building-the-modelalgorithm.html#cb49-32" aria-hidden="true"></a>  <span class="co"># averaging</span></span>
<span id="cb49-33"><a href="building-the-modelalgorithm.html#cb49-33" aria-hidden="true"></a>  C2 &lt;-<span class="st"> </span>C2 <span class="op">-</span><span class="st"> </span><span class="kw">rowMeans</span>(C2)</span>
<span id="cb49-34"><a href="building-the-modelalgorithm.html#cb49-34" aria-hidden="true"></a></span>
<span id="cb49-35"><a href="building-the-modelalgorithm.html#cb49-35" aria-hidden="true"></a>  <span class="co"># third component</span></span>
<span id="cb49-36"><a href="building-the-modelalgorithm.html#cb49-36" aria-hidden="true"></a>  C3 &lt;-<span class="st"> </span><span class="kw">do.call</span>(rbind, <span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>dimdat, <span class="dt">FUN =</span> <span class="cf">function</span>(j){</span>
<span id="cb49-37"><a href="building-the-modelalgorithm.html#cb49-37" aria-hidden="true"></a>    ((uw[,j, <span class="dt">drop=</span><span class="ot">TRUE</span>] <span class="op">-</span><span class="st"> </span>rho <span class="op">*</span><span class="st"> </span>w[,j,<span class="dt">drop=</span><span class="ot">TRUE</span>]) <span class="op">%*%</span><span class="st"> </span>Dl) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.numeric</span>()</span>
<span id="cb49-38"><a href="building-the-modelalgorithm.html#cb49-38" aria-hidden="true"></a>  }))</span>
<span id="cb49-39"><a href="building-the-modelalgorithm.html#cb49-39" aria-hidden="true"></a></span>
<span id="cb49-40"><a href="building-the-modelalgorithm.html#cb49-40" aria-hidden="true"></a>  <span class="co"># combining</span></span>
<span id="cb49-41"><a href="building-the-modelalgorithm.html#cb49-41" aria-hidden="true"></a>  C &lt;-<span class="st">  </span>(<span class="op">-</span><span class="dv">1</span><span class="op">/</span>N <span class="op">*</span><span class="st"> </span>C1 <span class="op">+</span><span class="st"> </span>C2 <span class="op">+</span><span class="st"> </span>C3)</span>
<span id="cb49-42"><a href="building-the-modelalgorithm.html#cb49-42" aria-hidden="true"></a>  C &lt;-<span class="st"> </span>C<span class="op">/</span>resp_sum[<span class="kw">col</span>(C)]</span>
<span id="cb49-43"><a href="building-the-modelalgorithm.html#cb49-43" aria-hidden="true"></a>  <span class="kw">return</span>(C)</span>
<span id="cb49-44"><a href="building-the-modelalgorithm.html#cb49-44" aria-hidden="true"></a>}</span>
<span id="cb49-45"><a href="building-the-modelalgorithm.html#cb49-45" aria-hidden="true"></a></span>
<span id="cb49-46"><a href="building-the-modelalgorithm.html#cb49-46" aria-hidden="true"></a></span>
<span id="cb49-47"><a href="building-the-modelalgorithm.html#cb49-47" aria-hidden="true"></a><span class="co">#' @param mat Matrix to Schur-decompose.</span></span>
<span id="cb49-48"><a href="building-the-modelalgorithm.html#cb49-48" aria-hidden="true"></a>myschur &lt;-<span class="st"> </span><span class="cf">function</span>(mat){</span>
<span id="cb49-49"><a href="building-the-modelalgorithm.html#cb49-49" aria-hidden="true"></a>  <span class="kw">stopifnot</span>(<span class="kw">nrow</span>(mat) <span class="op">==</span><span class="st"> </span><span class="kw">ncol</span>(mat))</span>
<span id="cb49-50"><a href="building-the-modelalgorithm.html#cb49-50" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="kw">is.numeric</span>(mat) <span class="op">&amp;</span><span class="st"> </span><span class="kw">length</span>(mat)<span class="op">==</span><span class="dv">1</span>) mat =<span class="st"> </span>mat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.matrix</span>()</span>
<span id="cb49-51"><a href="building-the-modelalgorithm.html#cb49-51" aria-hidden="true"></a>  obj =<span class="st"> </span>Matrix<span class="op">::</span><span class="kw">Schur</span>(mat)</span>
<span id="cb49-52"><a href="building-the-modelalgorithm.html#cb49-52" aria-hidden="true"></a>  obj<span class="op">$</span>tQ =<span class="st"> </span><span class="kw">t</span>(obj<span class="op">$</span>Q)</span>
<span id="cb49-53"><a href="building-the-modelalgorithm.html#cb49-53" aria-hidden="true"></a>  obj<span class="op">$</span>orig =<span class="st"> </span>mat</span>
<span id="cb49-54"><a href="building-the-modelalgorithm.html#cb49-54" aria-hidden="true"></a>  <span class="kw">return</span>(obj)</span>
<span id="cb49-55"><a href="building-the-modelalgorithm.html#cb49-55" aria-hidden="true"></a>}</span></code></pre></div>
<p>Here’s a function to check convergence of the ADMM with a fixed step size.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="building-the-modelalgorithm.html#cb50-1" aria-hidden="true"></a><span class="co">#' Check convergence of ADMM with a fixed step size (rho).</span></span>
<span id="cb50-2"><a href="building-the-modelalgorithm.html#cb50-2" aria-hidden="true"></a>check_converge &lt;-<span class="st"> </span><span class="cf">function</span>(mu, rho, w, z, w_prev, z_prev, uw, uz, Dl, tDl,</span>
<span id="cb50-3"><a href="building-the-modelalgorithm.html#cb50-3" aria-hidden="true"></a>                     <span class="dt">err_rel =</span> <span class="fl">1E-4</span>,</span>
<span id="cb50-4"><a href="building-the-modelalgorithm.html#cb50-4" aria-hidden="true"></a>                     <span class="dt">err_abs =</span> <span class="dv">0</span></span>
<span id="cb50-5"><a href="building-the-modelalgorithm.html#cb50-5" aria-hidden="true"></a>){</span>
<span id="cb50-6"><a href="building-the-modelalgorithm.html#cb50-6" aria-hidden="true"></a></span>
<span id="cb50-7"><a href="building-the-modelalgorithm.html#cb50-7" aria-hidden="true"></a>  <span class="co">## Constraints are: Ax + Bz =c, where x = mu, z =(w, z)</span></span>
<span id="cb50-8"><a href="building-the-modelalgorithm.html#cb50-8" aria-hidden="true"></a>  prim1 =<span class="st"> </span><span class="kw">rbind</span>(Dl <span class="op">%*%</span><span class="st"> </span>mu, mu <span class="op">-</span><span class="st"> </span><span class="kw">colMeans</span>(mu))</span>
<span id="cb50-9"><a href="building-the-modelalgorithm.html#cb50-9" aria-hidden="true"></a>  prim2 =<span class="st"> </span><span class="kw">rbind</span>(<span class="op">-</span>w, <span class="op">-</span>z)</span>
<span id="cb50-10"><a href="building-the-modelalgorithm.html#cb50-10" aria-hidden="true"></a>  primal_resid =<span class="st"> </span>prim1 <span class="op">+</span><span class="st"> </span>prim2   <span class="co">## Ax + Bz - c</span></span>
<span id="cb50-11"><a href="building-the-modelalgorithm.html#cb50-11" aria-hidden="true"></a></span>
<span id="cb50-12"><a href="building-the-modelalgorithm.html#cb50-12" aria-hidden="true"></a>  change_z =<span class="st"> </span>z <span class="op">-</span><span class="st"> </span>z_prev</span>
<span id="cb50-13"><a href="building-the-modelalgorithm.html#cb50-13" aria-hidden="true"></a>  change_w =<span class="st"> </span>w <span class="op">-</span><span class="st"> </span>w_prev</span>
<span id="cb50-14"><a href="building-the-modelalgorithm.html#cb50-14" aria-hidden="true"></a>  dual_resid =<span class="st"> </span>rho <span class="op">*</span><span class="st"> </span>(<span class="op">-</span>(change_z <span class="op">-</span><span class="st"> </span><span class="kw">colMeans</span>(change_z)) <span class="op">-</span><span class="st"> </span>tDl <span class="op">%*%</span><span class="st"> </span>change_w)</span>
<span id="cb50-15"><a href="building-the-modelalgorithm.html#cb50-15" aria-hidden="true"></a>  tAU =<span class="st"> </span>(uz <span class="op">-</span><span class="st"> </span><span class="kw">colMeans</span>(uz)) <span class="op">+</span><span class="st"> </span>tDl <span class="op">%*%</span><span class="st"> </span>uw</span>
<span id="cb50-16"><a href="building-the-modelalgorithm.html#cb50-16" aria-hidden="true"></a>         </span>
<span id="cb50-17"><a href="building-the-modelalgorithm.html#cb50-17" aria-hidden="true"></a>  <span class="co">## Form primal and dual tolerances.</span></span>
<span id="cb50-18"><a href="building-the-modelalgorithm.html#cb50-18" aria-hidden="true"></a>  primal_err =<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">length</span>(primal_resid)) <span class="op">*</span><span class="st"> </span>err_abs <span class="op">+</span></span>
<span id="cb50-19"><a href="building-the-modelalgorithm.html#cb50-19" aria-hidden="true"></a><span class="st">    </span>err_rel <span class="op">*</span><span class="st"> </span><span class="kw">max</span>(<span class="kw">norm</span>(prim1, <span class="st">"F"</span>), <span class="kw">norm</span>(prim2, <span class="st">"F"</span>))</span>
<span id="cb50-20"><a href="building-the-modelalgorithm.html#cb50-20" aria-hidden="true"></a>  dual_err =<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">length</span>(dual_resid)) <span class="op">*</span><span class="st"> </span>err_abs <span class="op">+</span></span>
<span id="cb50-21"><a href="building-the-modelalgorithm.html#cb50-21" aria-hidden="true"></a><span class="st">    </span>err_rel <span class="op">*</span><span class="st"> </span><span class="kw">norm</span>(tAU, <span class="st">"F"</span>)</span>
<span id="cb50-22"><a href="building-the-modelalgorithm.html#cb50-22" aria-hidden="true"></a></span>
<span id="cb50-23"><a href="building-the-modelalgorithm.html#cb50-23" aria-hidden="true"></a>  <span class="co">## Check convergence.</span></span>
<span id="cb50-24"><a href="building-the-modelalgorithm.html#cb50-24" aria-hidden="true"></a>  primal_resid_size =<span class="st"> </span><span class="kw">norm</span>(primal_resid, <span class="st">"F"</span>)</span>
<span id="cb50-25"><a href="building-the-modelalgorithm.html#cb50-25" aria-hidden="true"></a>  dual_resid_size =<span class="st"> </span><span class="kw">norm</span>(dual_resid, <span class="st">"F"</span>)</span>
<span id="cb50-26"><a href="building-the-modelalgorithm.html#cb50-26" aria-hidden="true"></a>  primal_converge =<span class="st"> </span>( primal_resid_size  <span class="op">&lt;=</span><span class="st"> </span>primal_err )</span>
<span id="cb50-27"><a href="building-the-modelalgorithm.html#cb50-27" aria-hidden="true"></a>  dual_converge =<span class="st"> </span>( dual_resid_size <span class="op">&lt;=</span><span class="st"> </span>dual_err )</span>
<span id="cb50-28"><a href="building-the-modelalgorithm.html#cb50-28" aria-hidden="true"></a></span>
<span id="cb50-29"><a href="building-the-modelalgorithm.html#cb50-29" aria-hidden="true"></a>  <span class="co">## Some checks (trying to address problems with |converge|).</span></span>
<span id="cb50-30"><a href="building-the-modelalgorithm.html#cb50-30" aria-hidden="true"></a>  assertthat<span class="op">::</span><span class="kw">assert_that</span>(<span class="kw">is.numeric</span>(primal_resid_size))</span>
<span id="cb50-31"><a href="building-the-modelalgorithm.html#cb50-31" aria-hidden="true"></a>  assertthat<span class="op">::</span><span class="kw">assert_that</span>(<span class="kw">is.numeric</span>(primal_err))</span>
<span id="cb50-32"><a href="building-the-modelalgorithm.html#cb50-32" aria-hidden="true"></a>  assertthat<span class="op">::</span><span class="kw">assert_that</span>(<span class="kw">is.numeric</span>(dual_resid_size))</span>
<span id="cb50-33"><a href="building-the-modelalgorithm.html#cb50-33" aria-hidden="true"></a>  assertthat<span class="op">::</span><span class="kw">assert_that</span>(<span class="kw">is.numeric</span>(dual_err))</span>
<span id="cb50-34"><a href="building-the-modelalgorithm.html#cb50-34" aria-hidden="true"></a></span>
<span id="cb50-35"><a href="building-the-modelalgorithm.html#cb50-35" aria-hidden="true"></a>  <span class="co">## return(primal_converge &amp; dual_converge)</span></span>
<span id="cb50-36"><a href="building-the-modelalgorithm.html#cb50-36" aria-hidden="true"></a>  converge =<span class="st"> </span>primal_converge <span class="op">&amp;</span><span class="st"> </span>dual_converge</span>
<span id="cb50-37"><a href="building-the-modelalgorithm.html#cb50-37" aria-hidden="true"></a></span>
<span id="cb50-38"><a href="building-the-modelalgorithm.html#cb50-38" aria-hidden="true"></a>  <span class="kw">return</span>(<span class="kw">list</span>(</span>
<span id="cb50-39"><a href="building-the-modelalgorithm.html#cb50-39" aria-hidden="true"></a>      <span class="dt">primal_resid1 =</span> prim1,</span>
<span id="cb50-40"><a href="building-the-modelalgorithm.html#cb50-40" aria-hidden="true"></a>      <span class="dt">primal_resid2 =</span> prim2,</span>
<span id="cb50-41"><a href="building-the-modelalgorithm.html#cb50-41" aria-hidden="true"></a>      <span class="dt">primal_resid =</span> primal_resid,</span>
<span id="cb50-42"><a href="building-the-modelalgorithm.html#cb50-42" aria-hidden="true"></a>      <span class="dt">primal_err =</span> primal_err,</span>
<span id="cb50-43"><a href="building-the-modelalgorithm.html#cb50-43" aria-hidden="true"></a>      <span class="dt">dual_resid =</span> dual_resid,</span>
<span id="cb50-44"><a href="building-the-modelalgorithm.html#cb50-44" aria-hidden="true"></a>      <span class="dt">dual_err =</span> dual_err,</span>
<span id="cb50-45"><a href="building-the-modelalgorithm.html#cb50-45" aria-hidden="true"></a>      <span class="dt">converge =</span> converge))</span>
<span id="cb50-46"><a href="building-the-modelalgorithm.html#cb50-46" aria-hidden="true"></a>}</span></code></pre></div>
<p>Here’s a function to compute the augmented Lagrangian of the M-step (this is not used for now).</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="building-the-modelalgorithm.html#cb51-1" aria-hidden="true"></a><span class="co">#' computes the Augmented lagrangian.</span></span>
<span id="cb51-2"><a href="building-the-modelalgorithm.html#cb51-2" aria-hidden="true"></a>aug_lagr &lt;-<span class="st"> </span><span class="cf">function</span>(y, TT, d, z, w, l, uz, uw, mu, resp, Sigma_inv, Dlp1, Dl, maxdev, lambda, rho, N){</span>
<span id="cb51-3"><a href="building-the-modelalgorithm.html#cb51-3" aria-hidden="true"></a>  mu_dd &lt;-<span class="st"> </span><span class="kw">rowMeans</span>(mu)</span>
<span id="cb51-4"><a href="building-the-modelalgorithm.html#cb51-4" aria-hidden="true"></a></span>
<span id="cb51-5"><a href="building-the-modelalgorithm.html#cb51-5" aria-hidden="true"></a>  <span class="co"># Check the Z's for ball constraint, up to a tolerance of 1e-4</span></span>
<span id="cb51-6"><a href="building-the-modelalgorithm.html#cb51-6" aria-hidden="true"></a>  znorms &lt;-<span class="st"> </span><span class="kw">apply</span>(z, <span class="dt">FUN =</span> <span class="cf">function</span>(zz) <span class="kw">sqrt</span>(<span class="kw">sum</span>(zz<span class="op">^</span><span class="dv">2</span>)), <span class="dt">MARGIN =</span> <span class="dv">1</span>)</span>
<span id="cb51-7"><a href="building-the-modelalgorithm.html#cb51-7" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="kw">any</span>(<span class="kw">is.na</span>(znorms))) <span class="kw">browser</span>()</span>
<span id="cb51-8"><a href="building-the-modelalgorithm.html#cb51-8" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="kw">any</span>(znorms <span class="op">&gt;</span><span class="st"> </span>(maxdev <span class="op">+</span><span class="st"> </span><span class="fl">1e-4</span>))){</span>
<span id="cb51-9"><a href="building-the-modelalgorithm.html#cb51-9" aria-hidden="true"></a>    <span class="kw">warning</span>(<span class="st">"||z||_2 &gt; maxdev, current iterate not feasible."</span>)</span>
<span id="cb51-10"><a href="building-the-modelalgorithm.html#cb51-10" aria-hidden="true"></a>    <span class="kw">return</span>(<span class="ot">Inf</span>)</span>
<span id="cb51-11"><a href="building-the-modelalgorithm.html#cb51-11" aria-hidden="true"></a>  }</span>
<span id="cb51-12"><a href="building-the-modelalgorithm.html#cb51-12" aria-hidden="true"></a></span>
<span id="cb51-13"><a href="building-the-modelalgorithm.html#cb51-13" aria-hidden="true"></a>  aug1 &lt;-<span class="st"> </span><span class="kw">sum</span>(<span class="kw">do.call</span>(cbind, <span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>TT, <span class="dt">FUN =</span> <span class="cf">function</span>(t){</span>
<span id="cb51-14"><a href="building-the-modelalgorithm.html#cb51-14" aria-hidden="true"></a>    multmat &lt;-<span class="st"> </span><span class="kw">apply</span>(y[[t]], <span class="dt">FUN =</span> <span class="cf">function</span>(yy){</span>
<span id="cb51-15"><a href="building-the-modelalgorithm.html#cb51-15" aria-hidden="true"></a>      <span class="kw">t</span>(yy <span class="op">-</span><span class="st"> </span>mu[,t]) <span class="op">%*%</span><span class="st"> </span>Sigma_inv <span class="op">%*%</span><span class="st"> </span>(yy <span class="op">-</span><span class="st"> </span>mu[,t])}, <span class="dt">MARGIN =</span> <span class="dv">1</span>)</span>
<span id="cb51-16"><a href="building-the-modelalgorithm.html#cb51-16" aria-hidden="true"></a>    <span class="kw">sum</span>(<span class="dv">1</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>N) <span class="op">*</span><span class="st"> </span>resp[[t]]<span class="op">*</span>multmat)</span>
<span id="cb51-17"><a href="building-the-modelalgorithm.html#cb51-17" aria-hidden="true"></a>  })))</span>
<span id="cb51-18"><a href="building-the-modelalgorithm.html#cb51-18" aria-hidden="true"></a></span>
<span id="cb51-19"><a href="building-the-modelalgorithm.html#cb51-19" aria-hidden="true"></a>  aug2 &lt;-<span class="st"> </span>lambda<span class="op">*</span><span class="kw">sum</span>(<span class="kw">do.call</span>(rbind, <span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>d, <span class="dt">FUN =</span> <span class="cf">function</span>(j)</span>
<span id="cb51-20"><a href="building-the-modelalgorithm.html#cb51-20" aria-hidden="true"></a>    <span class="kw">sum</span>(<span class="kw">abs</span>(<span class="kw">diff</span>(w[j,], <span class="dt">differences =</span> <span class="dv">1</span>))))))</span>
<span id="cb51-21"><a href="building-the-modelalgorithm.html#cb51-21" aria-hidden="true"></a></span>
<span id="cb51-22"><a href="building-the-modelalgorithm.html#cb51-22" aria-hidden="true"></a>  aug3 &lt;-<span class="st"> </span><span class="kw">sum</span>(<span class="kw">do.call</span>(cbind, <span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>TT, <span class="dt">FUN =</span> <span class="cf">function</span>(t){</span>
<span id="cb51-23"><a href="building-the-modelalgorithm.html#cb51-23" aria-hidden="true"></a>    uz[t,]<span class="op">%*%</span>(mu[,t] <span class="op">-</span><span class="st"> </span>mu_dd <span class="op">-</span><span class="st"> </span>z[t,]) <span class="op">+</span><span class="st"> </span>rho<span class="op">/</span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">sum</span>((mu[,t] <span class="op">-</span><span class="st"> </span>mu_dd <span class="op">-</span><span class="st"> </span>z[t,])<span class="op">^</span><span class="dv">2</span>)</span>
<span id="cb51-24"><a href="building-the-modelalgorithm.html#cb51-24" aria-hidden="true"></a>  })))</span>
<span id="cb51-25"><a href="building-the-modelalgorithm.html#cb51-25" aria-hidden="true"></a></span>
<span id="cb51-26"><a href="building-the-modelalgorithm.html#cb51-26" aria-hidden="true"></a></span>
<span id="cb51-27"><a href="building-the-modelalgorithm.html#cb51-27" aria-hidden="true"></a>  aug4 &lt;-<span class="st"> </span><span class="kw">sum</span>(<span class="kw">do.call</span>(rbind, <span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>d, <span class="dt">FUN =</span> <span class="cf">function</span>(j){</span>
<span id="cb51-28"><a href="building-the-modelalgorithm.html#cb51-28" aria-hidden="true"></a>    uw[,j] <span class="op">%*%</span><span class="st"> </span>(Dl <span class="op">%*%</span><span class="st"> </span>mu[j,]  <span class="op">-</span><span class="st"> </span>w[j,]) <span class="op">+</span><span class="st"> </span>rho<span class="op">/</span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">sum</span>((Dl <span class="op">%*%</span><span class="st"> </span>mu[j,] <span class="op">-</span><span class="st"> </span>w[j,])<span class="op">^</span><span class="dv">2</span>)</span>
<span id="cb51-29"><a href="building-the-modelalgorithm.html#cb51-29" aria-hidden="true"></a>  })))</span>
<span id="cb51-30"><a href="building-the-modelalgorithm.html#cb51-30" aria-hidden="true"></a></span>
<span id="cb51-31"><a href="building-the-modelalgorithm.html#cb51-31" aria-hidden="true"></a>  total &lt;-<span class="st"> </span>aug1 <span class="op">+</span><span class="st"> </span>aug2 <span class="op">+</span><span class="st"> </span>aug3 <span class="op">+</span><span class="st"> </span>aug4</span>
<span id="cb51-32"><a href="building-the-modelalgorithm.html#cb51-32" aria-hidden="true"></a></span>
<span id="cb51-33"><a href="building-the-modelalgorithm.html#cb51-33" aria-hidden="true"></a>  <span class="kw">return</span>(total)</span>
<span id="cb51-34"><a href="building-the-modelalgorithm.html#cb51-34" aria-hidden="true"></a>}</span></code></pre></div>
<p>Here’s a function to calculate the objective value for the ADMM.</p>
<p><span class="math display">\[\frac{1}{2N} \sum_{t=1}^T \sum_{i=1}^{n_t} \hat{\gamma}_{it} (y_i^{(t)} - \mu_{\cdot
       t})^T \hat{\Sigma}^{-1} ( y_i^{(t)} - \mu_{\cdot t}) + \lambda
     \sum_{j=1}^d \|D^{(l+1)}\mu_{j\cdot }\|_1\]</span></p>
<p>(This is the penalized surrogate objective <span class="math inline">\(Q_{\tilde \theta}(\mu, \Sigma, \pi) + \lambda \sum_{j=1}^d \|D^{(l+1)} \mu_{j \cdot}\|_1\)</span>, taking only the
parts, and leaving out a constant <span class="math inline">\(C=-\frac{d}{2}\log(2\pi) - \frac{1}{2} \log det(\Sigma_k)\)</span>, since the constant <span class="math inline">\(C\)</span> doesn’t change over ADMM iterations.)</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="building-the-modelalgorithm.html#cb52-1" aria-hidden="true"></a><span class="co">#' computes the ADMM objective for one cluster</span></span>
<span id="cb52-2"><a href="building-the-modelalgorithm.html#cb52-2" aria-hidden="true"></a>objective_per_cluster &lt;-<span class="st"> </span><span class="cf">function</span>(y, TT, d, l, mu, resp, Sigma_inv, Dlp1, Dl,</span>
<span id="cb52-3"><a href="building-the-modelalgorithm.html#cb52-3" aria-hidden="true"></a>                                  maxdev, lambda, rho, N){</span>
<span id="cb52-4"><a href="building-the-modelalgorithm.html#cb52-4" aria-hidden="true"></a>  </span>
<span id="cb52-5"><a href="building-the-modelalgorithm.html#cb52-5" aria-hidden="true"></a>  aug1 &lt;-<span class="st"> </span><span class="kw">sum</span>(<span class="kw">do.call</span>(cbind, <span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>TT, <span class="dt">FUN =</span> <span class="cf">function</span>(tt){</span>
<span id="cb52-6"><a href="building-the-modelalgorithm.html#cb52-6" aria-hidden="true"></a>    multmat &lt;-<span class="st"> </span><span class="kw">apply</span>(y[[tt]], <span class="dt">FUN =</span> <span class="cf">function</span>(yy){</span>
<span id="cb52-7"><a href="building-the-modelalgorithm.html#cb52-7" aria-hidden="true"></a>      <span class="kw">t</span>(yy <span class="op">-</span><span class="st"> </span>mu[tt,]) <span class="op">%*%</span><span class="st"> </span>Sigma_inv <span class="op">%*%</span><span class="st"> </span>(yy <span class="op">-</span><span class="st"> </span>mu[tt,])}, <span class="dt">MARGIN =</span> <span class="dv">1</span>)</span>
<span id="cb52-8"><a href="building-the-modelalgorithm.html#cb52-8" aria-hidden="true"></a>    <span class="kw">sum</span>(<span class="dv">1</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>N) <span class="op">*</span><span class="st"> </span>resp[[tt]] <span class="op">*</span><span class="st"> </span>multmat)</span>
<span id="cb52-9"><a href="building-the-modelalgorithm.html#cb52-9" aria-hidden="true"></a>  })))</span>
<span id="cb52-10"><a href="building-the-modelalgorithm.html#cb52-10" aria-hidden="true"></a></span>
<span id="cb52-11"><a href="building-the-modelalgorithm.html#cb52-11" aria-hidden="true"></a>  aug2 &lt;-<span class="st"> </span>lambda<span class="op">*</span><span class="kw">sum</span>(<span class="kw">do.call</span>(rbind, <span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>d, <span class="dt">FUN =</span> <span class="cf">function</span>(j)</span>
<span id="cb52-12"><a href="building-the-modelalgorithm.html#cb52-12" aria-hidden="true"></a>    <span class="kw">sum</span>(<span class="kw">abs</span>(<span class="kw">diff</span>(mu[,j], <span class="dt">differences =</span> l))))))</span>
<span id="cb52-13"><a href="building-the-modelalgorithm.html#cb52-13" aria-hidden="true"></a></span>
<span id="cb52-14"><a href="building-the-modelalgorithm.html#cb52-14" aria-hidden="true"></a>  total &lt;-<span class="st"> </span>aug1 <span class="op">+</span><span class="st"> </span>aug2</span>
<span id="cb52-15"><a href="building-the-modelalgorithm.html#cb52-15" aria-hidden="true"></a>  <span class="kw">return</span>(total)</span>
<span id="cb52-16"><a href="building-the-modelalgorithm.html#cb52-16" aria-hidden="true"></a>}</span></code></pre></div>
</div>
<div id="all-rcpp-functions" class="section level3 hasAnchor" number="3.5.5">
<h3>
<span class="header-section-number">3.5.5</span> All Rcpp functions<a href="building-the-modelalgorithm.html#all-rcpp-functions" class="anchor-section" aria-label="Anchor link to header"></a>
</h3>
<p>The main function we write in Rcpp is the “barebones” Sylvester equation solver
that takes upper-triangular coefficient matrices.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb53-1"><a href="building-the-modelalgorithm.html#cb53-1" aria-hidden="true"></a><span class="co">// [[Rcpp::depends(RcppArmadillo)]]</span></span>
<span id="cb53-2"><a href="building-the-modelalgorithm.html#cb53-2" aria-hidden="true"></a><span class="co">// [[Rcpp::depends(RcppEigen)]]</span></span>
<span id="cb53-3"><a href="building-the-modelalgorithm.html#cb53-3" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&lt;RcppArmadillo.h&gt;</span></span>
<span id="cb53-4"><a href="building-the-modelalgorithm.html#cb53-4" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&lt;RcppEigen.h&gt;</span></span>
<span id="cb53-5"><a href="building-the-modelalgorithm.html#cb53-5" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&lt;numeric&gt;</span></span>
<span id="cb53-6"><a href="building-the-modelalgorithm.html#cb53-6" aria-hidden="true"></a></span>
<span id="cb53-7"><a href="building-the-modelalgorithm.html#cb53-7" aria-hidden="true"></a><span class="kw">using</span> <span class="kw">namespace</span> arma;</span>
<span id="cb53-8"><a href="building-the-modelalgorithm.html#cb53-8" aria-hidden="true"></a><span class="kw">using</span> <span class="kw">namespace</span> Eigen;</span>
<span id="cb53-9"><a href="building-the-modelalgorithm.html#cb53-9" aria-hidden="true"></a></span>
<span id="cb53-10"><a href="building-the-modelalgorithm.html#cb53-10" aria-hidden="true"></a><span class="kw">using</span> Eigen::Map;                       <span class="co">// 'maps' rather than copies</span></span>
<span id="cb53-11"><a href="building-the-modelalgorithm.html#cb53-11" aria-hidden="true"></a><span class="kw">using</span> Eigen::MatrixXd;                  <span class="co">// variable size matrix, double precision</span></span>
<span id="cb53-12"><a href="building-the-modelalgorithm.html#cb53-12" aria-hidden="true"></a></span>
<span id="cb53-13"><a href="building-the-modelalgorithm.html#cb53-13" aria-hidden="true"></a><span class="co">//' Solve "barebones" sylvester equation that takes upper triangular matrices as coefficients.</span></span>
<span id="cb53-14"><a href="building-the-modelalgorithm.html#cb53-14" aria-hidden="true"></a><span class="co">//'</span></span>
<span id="cb53-15"><a href="building-the-modelalgorithm.html#cb53-15" aria-hidden="true"></a><span class="co">//' @param TA Upper-triangular matrix</span></span>
<span id="cb53-16"><a href="building-the-modelalgorithm.html#cb53-16" aria-hidden="true"></a><span class="co">//' @param TB Upper-triangular matrix</span></span>
<span id="cb53-17"><a href="building-the-modelalgorithm.html#cb53-17" aria-hidden="true"></a><span class="co">//' @param C matrix</span></span>
<span id="cb53-18"><a href="building-the-modelalgorithm.html#cb53-18" aria-hidden="true"></a><span class="co">//' @export</span></span>
<span id="cb53-19"><a href="building-the-modelalgorithm.html#cb53-19" aria-hidden="true"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb53-20"><a href="building-the-modelalgorithm.html#cb53-20" aria-hidden="true"></a>Eigen::MatrixXd matrix_function_solve_triangular_sylvester_barebonesC2(<span class="at">const</span> Eigen::MatrixXd &amp; TA, </span>
<span id="cb53-21"><a href="building-the-modelalgorithm.html#cb53-21" aria-hidden="true"></a>                                     <span class="at">const</span> Eigen::MatrixXd &amp; TB,</span>
<span id="cb53-22"><a href="building-the-modelalgorithm.html#cb53-22" aria-hidden="true"></a>                                     <span class="at">const</span> Eigen::MatrixXd &amp; C){</span>
<span id="cb53-23"><a href="building-the-modelalgorithm.html#cb53-23" aria-hidden="true"></a>  <span class="co">// Eigen::eigen_assert(TA.rows() == TA.cols());</span></span>
<span id="cb53-24"><a href="building-the-modelalgorithm.html#cb53-24" aria-hidden="true"></a>  <span class="co">// Eigen::eigen_assert(TA.Eigen::isUpperTriangular());</span></span>
<span id="cb53-25"><a href="building-the-modelalgorithm.html#cb53-25" aria-hidden="true"></a>  <span class="co">// Eigen::eigen_assert(TB.rows() == TB.cols());</span></span>
<span id="cb53-26"><a href="building-the-modelalgorithm.html#cb53-26" aria-hidden="true"></a>  <span class="co">// Eigen::eigen_assert(TB.Eigen::isUpperTriangular());</span></span>
<span id="cb53-27"><a href="building-the-modelalgorithm.html#cb53-27" aria-hidden="true"></a>  <span class="co">// Eigen::eigen_assert(C.rows() == TA.rows());</span></span>
<span id="cb53-28"><a href="building-the-modelalgorithm.html#cb53-28" aria-hidden="true"></a>  <span class="co">// Eigen::eigen_assert(C.cols() == TB.rows());</span></span>
<span id="cb53-29"><a href="building-the-modelalgorithm.html#cb53-29" aria-hidden="true"></a></span>
<span id="cb53-30"><a href="building-the-modelalgorithm.html#cb53-30" aria-hidden="true"></a>  <span class="co">// typedef typename MatrixType::Index Index; </span></span>
<span id="cb53-31"><a href="building-the-modelalgorithm.html#cb53-31" aria-hidden="true"></a>  <span class="co">// typedef typename MatrixType::Scalar Scalar;</span></span>
<span id="cb53-32"><a href="building-the-modelalgorithm.html#cb53-32" aria-hidden="true"></a></span>
<span id="cb53-33"><a href="building-the-modelalgorithm.html#cb53-33" aria-hidden="true"></a>  <span class="dt">int</span> m = TA.rows();</span>
<span id="cb53-34"><a href="building-the-modelalgorithm.html#cb53-34" aria-hidden="true"></a>  <span class="dt">int</span> n = TB.rows();</span>
<span id="cb53-35"><a href="building-the-modelalgorithm.html#cb53-35" aria-hidden="true"></a>  Eigen::MatrixXd X(m, n);</span>
<span id="cb53-36"><a href="building-the-modelalgorithm.html#cb53-36" aria-hidden="true"></a></span>
<span id="cb53-37"><a href="building-the-modelalgorithm.html#cb53-37" aria-hidden="true"></a>  <span class="cf">for</span> (<span class="dt">int</span> i = m - <span class="dv">1</span>; i &gt;= <span class="dv">0</span>; --i) {</span>
<span id="cb53-38"><a href="building-the-modelalgorithm.html#cb53-38" aria-hidden="true"></a>    <span class="cf">for</span> (<span class="dt">int</span> j = <span class="dv">0</span>; j &lt; n; ++j) {</span>
<span id="cb53-39"><a href="building-the-modelalgorithm.html#cb53-39" aria-hidden="true"></a></span>
<span id="cb53-40"><a href="building-the-modelalgorithm.html#cb53-40" aria-hidden="true"></a>      <span class="co">// Compute T_A X = \sum_{k=i+1}^m T_A_{ik} X_{kj}</span></span>
<span id="cb53-41"><a href="building-the-modelalgorithm.html#cb53-41" aria-hidden="true"></a>      <span class="dt">double</span> TAX;</span>
<span id="cb53-42"><a href="building-the-modelalgorithm.html#cb53-42" aria-hidden="true"></a>      <span class="cf">if</span> (i == m - <span class="dv">1</span>) {</span>
<span id="cb53-43"><a href="building-the-modelalgorithm.html#cb53-43" aria-hidden="true"></a>        TAX = <span class="dv">0</span>;</span>
<span id="cb53-44"><a href="building-the-modelalgorithm.html#cb53-44" aria-hidden="true"></a>      } <span class="cf">else</span> {</span>
<span id="cb53-45"><a href="building-the-modelalgorithm.html#cb53-45" aria-hidden="true"></a>    MatrixXd TAXmatrix = TA.row(i).tail(m-<span class="dv">1</span>-i) * X.col(j).tail(m-<span class="dv">1</span>-i);</span>
<span id="cb53-46"><a href="building-the-modelalgorithm.html#cb53-46" aria-hidden="true"></a>        TAX = TAXmatrix(<span class="dv">0</span>,<span class="dv">0</span>);</span>
<span id="cb53-47"><a href="building-the-modelalgorithm.html#cb53-47" aria-hidden="true"></a>      }</span>
<span id="cb53-48"><a href="building-the-modelalgorithm.html#cb53-48" aria-hidden="true"></a></span>
<span id="cb53-49"><a href="building-the-modelalgorithm.html#cb53-49" aria-hidden="true"></a>      <span class="co">// Compute X T_B = \sum_{k=1}^{j-1} X_{ik} T_B_{kj}</span></span>
<span id="cb53-50"><a href="building-the-modelalgorithm.html#cb53-50" aria-hidden="true"></a>      <span class="dt">double</span> XTB;</span>
<span id="cb53-51"><a href="building-the-modelalgorithm.html#cb53-51" aria-hidden="true"></a>      <span class="cf">if</span> (j == <span class="dv">0</span>) {</span>
<span id="cb53-52"><a href="building-the-modelalgorithm.html#cb53-52" aria-hidden="true"></a>        XTB = <span class="dv">0</span>;</span>
<span id="cb53-53"><a href="building-the-modelalgorithm.html#cb53-53" aria-hidden="true"></a>      } <span class="cf">else</span> {</span>
<span id="cb53-54"><a href="building-the-modelalgorithm.html#cb53-54" aria-hidden="true"></a>        MatrixXd XTBmatrix = X.row(i).head(j) * TB.col(j).head(j);</span>
<span id="cb53-55"><a href="building-the-modelalgorithm.html#cb53-55" aria-hidden="true"></a>        XTB = XTBmatrix(<span class="dv">0</span>,<span class="dv">0</span>);</span>
<span id="cb53-56"><a href="building-the-modelalgorithm.html#cb53-56" aria-hidden="true"></a>      }</span>
<span id="cb53-57"><a href="building-the-modelalgorithm.html#cb53-57" aria-hidden="true"></a></span>
<span id="cb53-58"><a href="building-the-modelalgorithm.html#cb53-58" aria-hidden="true"></a>      X(i,j) = (C(i,j) - TAX - XTB) / (TA(i,i) + TB(j,j));</span>
<span id="cb53-59"><a href="building-the-modelalgorithm.html#cb53-59" aria-hidden="true"></a>    }</span>
<span id="cb53-60"><a href="building-the-modelalgorithm.html#cb53-60" aria-hidden="true"></a>  }</span>
<span id="cb53-61"><a href="building-the-modelalgorithm.html#cb53-61" aria-hidden="true"></a>  <span class="cf">return</span> X;</span>
<span id="cb53-62"><a href="building-the-modelalgorithm.html#cb53-62" aria-hidden="true"></a>}</span></code></pre></div>
<p>Also, we define a faster <code>dmvnorm</code> function written in C++.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb54-1"><a href="building-the-modelalgorithm.html#cb54-1" aria-hidden="true"></a><span class="co">// [[Rcpp::depends(RcppArmadillo)]]</span></span>
<span id="cb54-2"><a href="building-the-modelalgorithm.html#cb54-2" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&lt;RcppArmadillo.h&gt;</span></span>
<span id="cb54-3"><a href="building-the-modelalgorithm.html#cb54-3" aria-hidden="true"></a></span>
<span id="cb54-4"><a href="building-the-modelalgorithm.html#cb54-4" aria-hidden="true"></a><span class="at">static</span> <span class="dt">double</span> <span class="at">const</span> log2pi = <span class="bu">std::</span>log(<span class="fl">2.0</span> * M_PI);</span>
<span id="cb54-5"><a href="building-the-modelalgorithm.html#cb54-5" aria-hidden="true"></a></span>
<span id="cb54-6"><a href="building-the-modelalgorithm.html#cb54-6" aria-hidden="true"></a><span class="co">/* C++ version of the dtrmv BLAS function */</span></span>
<span id="cb54-7"><a href="building-the-modelalgorithm.html#cb54-7" aria-hidden="true"></a><span class="dt">void</span> inplace_tri_mat_mult(arma::rowvec &amp;x, arma::mat <span class="at">const</span> &amp;trimat){</span>
<span id="cb54-8"><a href="building-the-modelalgorithm.html#cb54-8" aria-hidden="true"></a>  arma::uword <span class="at">const</span> n = trimat.n_cols;</span>
<span id="cb54-9"><a href="building-the-modelalgorithm.html#cb54-9" aria-hidden="true"></a></span>
<span id="cb54-10"><a href="building-the-modelalgorithm.html#cb54-10" aria-hidden="true"></a>  <span class="cf">for</span>(<span class="dt">unsigned</span> j = n; j-- &gt; <span class="dv">0</span>;){</span>
<span id="cb54-11"><a href="building-the-modelalgorithm.html#cb54-11" aria-hidden="true"></a>    <span class="dt">double</span> tmp(<span class="fl">0.</span>);</span>
<span id="cb54-12"><a href="building-the-modelalgorithm.html#cb54-12" aria-hidden="true"></a>    <span class="cf">for</span>(<span class="dt">unsigned</span> i = <span class="dv">0</span>; i &lt;= j; ++i)</span>
<span id="cb54-13"><a href="building-the-modelalgorithm.html#cb54-13" aria-hidden="true"></a>      tmp += trimat.at(i, j) * x[i];</span>
<span id="cb54-14"><a href="building-the-modelalgorithm.html#cb54-14" aria-hidden="true"></a>    x[j] = tmp;</span>
<span id="cb54-15"><a href="building-the-modelalgorithm.html#cb54-15" aria-hidden="true"></a>  }</span>
<span id="cb54-16"><a href="building-the-modelalgorithm.html#cb54-16" aria-hidden="true"></a>}</span>
<span id="cb54-17"><a href="building-the-modelalgorithm.html#cb54-17" aria-hidden="true"></a></span>
<span id="cb54-18"><a href="building-the-modelalgorithm.html#cb54-18" aria-hidden="true"></a></span>
<span id="cb54-19"><a href="building-the-modelalgorithm.html#cb54-19" aria-hidden="true"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb54-20"><a href="building-the-modelalgorithm.html#cb54-20" aria-hidden="true"></a>arma::vec dmvnorm_arma_fast(arma::mat <span class="at">const</span> &amp;x,</span>
<span id="cb54-21"><a href="building-the-modelalgorithm.html#cb54-21" aria-hidden="true"></a>                           arma::rowvec <span class="at">const</span> &amp;mean,</span>
<span id="cb54-22"><a href="building-the-modelalgorithm.html#cb54-22" aria-hidden="true"></a>                           arma::mat <span class="at">const</span> &amp;sigma,</span>
<span id="cb54-23"><a href="building-the-modelalgorithm.html#cb54-23" aria-hidden="true"></a>                           <span class="dt">bool</span> <span class="at">const</span> logd = <span class="kw">false</span>) {</span>
<span id="cb54-24"><a href="building-the-modelalgorithm.html#cb54-24" aria-hidden="true"></a>    <span class="kw">using</span> arma::uword;</span>
<span id="cb54-25"><a href="building-the-modelalgorithm.html#cb54-25" aria-hidden="true"></a>    uword <span class="at">const</span> n = x.n_rows,</span>
<span id="cb54-26"><a href="building-the-modelalgorithm.html#cb54-26" aria-hidden="true"></a>             xdim = x.n_cols;</span>
<span id="cb54-27"><a href="building-the-modelalgorithm.html#cb54-27" aria-hidden="true"></a>    arma::vec out(n);</span>
<span id="cb54-28"><a href="building-the-modelalgorithm.html#cb54-28" aria-hidden="true"></a>    arma::mat <span class="at">const</span> rooti = arma::inv(trimatu(arma::chol(sigma)));</span>
<span id="cb54-29"><a href="building-the-modelalgorithm.html#cb54-29" aria-hidden="true"></a>    <span class="dt">double</span> <span class="at">const</span> rootisum = arma::sum(log(rooti.diag())),</span>
<span id="cb54-30"><a href="building-the-modelalgorithm.html#cb54-30" aria-hidden="true"></a>                constants = -(<span class="dt">double</span>)xdim/<span class="fl">2.0</span> * log2pi,</span>
<span id="cb54-31"><a href="building-the-modelalgorithm.html#cb54-31" aria-hidden="true"></a>              other_terms = rootisum + constants;</span>
<span id="cb54-32"><a href="building-the-modelalgorithm.html#cb54-32" aria-hidden="true"></a></span>
<span id="cb54-33"><a href="building-the-modelalgorithm.html#cb54-33" aria-hidden="true"></a>    arma::rowvec z;</span>
<span id="cb54-34"><a href="building-the-modelalgorithm.html#cb54-34" aria-hidden="true"></a>    <span class="cf">for</span> (uword i = <span class="dv">0</span>; i &lt; n; i++) {</span>
<span id="cb54-35"><a href="building-the-modelalgorithm.html#cb54-35" aria-hidden="true"></a>        z = (x.row(i) - mean);</span>
<span id="cb54-36"><a href="building-the-modelalgorithm.html#cb54-36" aria-hidden="true"></a>        inplace_tri_mat_mult(z, rooti);</span>
<span id="cb54-37"><a href="building-the-modelalgorithm.html#cb54-37" aria-hidden="true"></a>        out(i) = other_terms - <span class="fl">0.5</span> * arma::dot(z, z);</span>
<span id="cb54-38"><a href="building-the-modelalgorithm.html#cb54-38" aria-hidden="true"></a>    }</span>
<span id="cb54-39"><a href="building-the-modelalgorithm.html#cb54-39" aria-hidden="true"></a></span>
<span id="cb54-40"><a href="building-the-modelalgorithm.html#cb54-40" aria-hidden="true"></a>    <span class="cf">if</span> (logd)</span>
<span id="cb54-41"><a href="building-the-modelalgorithm.html#cb54-41" aria-hidden="true"></a>      <span class="cf">return</span> out;</span>
<span id="cb54-42"><a href="building-the-modelalgorithm.html#cb54-42" aria-hidden="true"></a>    <span class="cf">return</span> exp(out);</span>
<span id="cb54-43"><a href="building-the-modelalgorithm.html#cb54-43" aria-hidden="true"></a>}</span>
<span id="cb54-44"><a href="building-the-modelalgorithm.html#cb54-44" aria-hidden="true"></a></span>
<span id="cb54-45"><a href="building-the-modelalgorithm.html#cb54-45" aria-hidden="true"></a><span class="co">// All credit goes to https://gallery.rcpp.org/articles/dmvnorm_arma/</span></span></code></pre></div>
<p>We need this blob
(from <a href="https://github.com/jacobbien/litr-project/blob/main/examples/make-an-r-package-with-armadillo/create-witharmadillo.Rmd" class="uri">https://github.com/jacobbien/litr-project/blob/main/examples/make-an-r-package-with-armadillo/create-witharmadillo.Rmd</a> ):</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="building-the-modelalgorithm.html#cb55-1" aria-hidden="true"></a>usethis<span class="op">::</span><span class="kw">use_rcpp_armadillo</span>(<span class="dt">name =</span> <span class="st">"code"</span>)</span></code></pre></div>
<pre><code>## ✔ Leaving 'src/code.cpp' unchanged
## • Edit 'src/code.cpp'
## ✔ Adding 'RcppArmadillo' to LinkingTo field in DESCRIPTION
## ✔ Created 'src/Makevars' and 'src/Makevars.win' with requested compilation settings.</code></pre>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="building-the-modelalgorithm.html#cb57-1" aria-hidden="true"></a>usethis<span class="op">::</span><span class="kw">use_rcpp_eigen</span>(<span class="dt">name =</span> <span class="st">"code"</span>)</span></code></pre></div>
<pre><code>## ✔ Leaving 'src/code.cpp' unchanged
## • Edit 'src/code.cpp'
## Registered S3 methods overwritten by 'RcppEigen':
##   method               from         
##   predict.fastLm       RcppArmadillo
##   print.fastLm         RcppArmadillo
##   summary.fastLm       RcppArmadillo
##   print.summary.fastLm RcppArmadillo
## 
## ✔ Adding 'RcppEigen' to LinkingTo field in DESCRIPTION
## ✔ Adding '@import RcppEigen' to 'R/flowtrend-package.R'
## • Run `devtools::document()` to update 'NAMESPACE'</code></pre>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="building-the-modelalgorithm.html#cb59-1" aria-hidden="true"></a><span class="co">#' Testing against \code{Mstep_mu()}, for ONE cluster.</span></span>
<span id="cb59-2"><a href="building-the-modelalgorithm.html#cb59-2" aria-hidden="true"></a><span class="co">#' @param ylist</span></span>
<span id="cb59-3"><a href="building-the-modelalgorithm.html#cb59-3" aria-hidden="true"></a><span class="co">#' @param resp</span></span>
<span id="cb59-4"><a href="building-the-modelalgorithm.html#cb59-4" aria-hidden="true"></a><span class="co">#' @param lambda</span></span>
<span id="cb59-5"><a href="building-the-modelalgorithm.html#cb59-5" aria-hidden="true"></a><span class="co">#' @param l</span></span>
<span id="cb59-6"><a href="building-the-modelalgorithm.html#cb59-6" aria-hidden="true"></a><span class="co">#' @param Sigma_inv inverse of Sigma</span></span>
<span id="cb59-7"><a href="building-the-modelalgorithm.html#cb59-7" aria-hidden="true"></a><span class="co">#' @param x covariates</span></span>
<span id="cb59-8"><a href="building-the-modelalgorithm.html#cb59-8" aria-hidden="true"></a>Mstep_mu_cvxr &lt;-<span class="st"> </span><span class="cf">function</span>(ylist,</span>
<span id="cb59-9"><a href="building-the-modelalgorithm.html#cb59-9" aria-hidden="true"></a>                          resp,</span>
<span id="cb59-10"><a href="building-the-modelalgorithm.html#cb59-10" aria-hidden="true"></a>                          lambda,</span>
<span id="cb59-11"><a href="building-the-modelalgorithm.html#cb59-11" aria-hidden="true"></a>                          l,</span>
<span id="cb59-12"><a href="building-the-modelalgorithm.html#cb59-12" aria-hidden="true"></a>                          Sigma_inv, </span>
<span id="cb59-13"><a href="building-the-modelalgorithm.html#cb59-13" aria-hidden="true"></a>                          <span class="dt">x =</span> <span class="ot">NULL</span>,</span>
<span id="cb59-14"><a href="building-the-modelalgorithm.html#cb59-14" aria-hidden="true"></a>                          <span class="dt">thresh =</span> <span class="fl">1E-8</span>,</span>
<span id="cb59-15"><a href="building-the-modelalgorithm.html#cb59-15" aria-hidden="true"></a>                          <span class="dt">maxdev =</span> <span class="ot">NULL</span>,</span>
<span id="cb59-16"><a href="building-the-modelalgorithm.html#cb59-16" aria-hidden="true"></a>                          dimdat,</span>
<span id="cb59-17"><a href="building-the-modelalgorithm.html#cb59-17" aria-hidden="true"></a>                          N,</span>
<span id="cb59-18"><a href="building-the-modelalgorithm.html#cb59-18" aria-hidden="true"></a>                          <span class="dt">ecos_thresh =</span> <span class="fl">1E-8</span>,</span>
<span id="cb59-19"><a href="building-the-modelalgorithm.html#cb59-19" aria-hidden="true"></a>                          <span class="dt">scs_eps =</span> <span class="fl">1E-5</span>){</span>
<span id="cb59-20"><a href="building-the-modelalgorithm.html#cb59-20" aria-hidden="true"></a>  </span>
<span id="cb59-21"><a href="building-the-modelalgorithm.html#cb59-21" aria-hidden="true"></a>  <span class="co">## Define dimensions</span></span>
<span id="cb59-22"><a href="building-the-modelalgorithm.html#cb59-22" aria-hidden="true"></a>  TT =<span class="st"> </span><span class="kw">length</span>(ylist)</span>
<span id="cb59-23"><a href="building-the-modelalgorithm.html#cb59-23" aria-hidden="true"></a>  </span>
<span id="cb59-24"><a href="building-the-modelalgorithm.html#cb59-24" aria-hidden="true"></a>  <span class="co">## Responsibility Weighted Data</span></span>
<span id="cb59-25"><a href="building-the-modelalgorithm.html#cb59-25" aria-hidden="true"></a>  ytildes &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>TT, <span class="dt">FUN =</span> <span class="cf">function</span>(tt){</span>
<span id="cb59-26"><a href="building-the-modelalgorithm.html#cb59-26" aria-hidden="true"></a>    yy &lt;-<span class="st"> </span>ylist[[tt]]</span>
<span id="cb59-27"><a href="building-the-modelalgorithm.html#cb59-27" aria-hidden="true"></a>    g &lt;-<span class="st"> </span>resp[[tt]]</span>
<span id="cb59-28"><a href="building-the-modelalgorithm.html#cb59-28" aria-hidden="true"></a>    yy &lt;-<span class="st"> </span><span class="kw">apply</span>(yy, <span class="dt">MARGIN =</span> <span class="dv">2</span>, <span class="dt">FUN =</span> <span class="cf">function</span>(x) x <span class="op">*</span><span class="st"> </span>g)</span>
<span id="cb59-29"><a href="building-the-modelalgorithm.html#cb59-29" aria-hidden="true"></a>    yrow =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="ot">NA</span>, <span class="ot">NA</span>), <span class="dt">nrow=</span><span class="dv">1</span>, <span class="dt">ncol=</span>dimdat)</span>
<span id="cb59-30"><a href="building-the-modelalgorithm.html#cb59-30" aria-hidden="true"></a>    yrow[<span class="dv">1</span>,] =<span class="st"> </span><span class="kw">colSums</span>(yy)</span>
<span id="cb59-31"><a href="building-the-modelalgorithm.html#cb59-31" aria-hidden="true"></a>    yrow</span>
<span id="cb59-32"><a href="building-the-modelalgorithm.html#cb59-32" aria-hidden="true"></a>  }) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">do.call</span>(rbind, .)</span>
<span id="cb59-33"><a href="building-the-modelalgorithm.html#cb59-33" aria-hidden="true"></a>  </span>
<span id="cb59-34"><a href="building-the-modelalgorithm.html#cb59-34" aria-hidden="true"></a>  <span class="co">## Auxiliary term, needed to make the objective interpretable</span></span>
<span id="cb59-35"><a href="building-the-modelalgorithm.html#cb59-35" aria-hidden="true"></a>  aux.y &lt;-<span class="st"> </span><span class="kw">Reduce</span>(<span class="st">"+"</span>, <span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>TT, <span class="dt">FUN =</span> <span class="cf">function</span>(tt){</span>
<span id="cb59-36"><a href="building-the-modelalgorithm.html#cb59-36" aria-hidden="true"></a>    yy &lt;-<span class="st"> </span>ylist[[tt]]</span>
<span id="cb59-37"><a href="building-the-modelalgorithm.html#cb59-37" aria-hidden="true"></a>    g &lt;-<span class="st"> </span><span class="kw">sqrt</span>(resp[[tt]])</span>
<span id="cb59-38"><a href="building-the-modelalgorithm.html#cb59-38" aria-hidden="true"></a>    yy &lt;-<span class="st"> </span><span class="kw">apply</span>(yy, <span class="dt">MARGIN =</span> <span class="dv">2</span>, <span class="dt">FUN =</span> <span class="cf">function</span>(x) x <span class="op">*</span><span class="st"> </span>g)</span>
<span id="cb59-39"><a href="building-the-modelalgorithm.html#cb59-39" aria-hidden="true"></a>    <span class="kw">sum</span>(<span class="kw">diag</span>(yy <span class="op">%*%</span><span class="st"> </span>Sigma_inv <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(yy)))</span>
<span id="cb59-40"><a href="building-the-modelalgorithm.html#cb59-40" aria-hidden="true"></a>  }))</span>
<span id="cb59-41"><a href="building-the-modelalgorithm.html#cb59-41" aria-hidden="true"></a>  </span>
<span id="cb59-42"><a href="building-the-modelalgorithm.html#cb59-42" aria-hidden="true"></a>  <span class="co">## Mu, d x T matrix</span></span>
<span id="cb59-43"><a href="building-the-modelalgorithm.html#cb59-43" aria-hidden="true"></a>  mumat &lt;-<span class="st"> </span>CVXR<span class="op">::</span><span class="kw">Variable</span>(<span class="dt">cols=</span>dimdat, <span class="dt">rows=</span>TT)</span>
<span id="cb59-44"><a href="building-the-modelalgorithm.html#cb59-44" aria-hidden="true"></a>  </span>
<span id="cb59-45"><a href="building-the-modelalgorithm.html#cb59-45" aria-hidden="true"></a>  <span class="co">## Summed sqrt responsibilities - needed in the objective.</span></span>
<span id="cb59-46"><a href="building-the-modelalgorithm.html#cb59-46" aria-hidden="true"></a>  resp.sum.sqrt &lt;-<span class="st"> </span><span class="kw">lapply</span>(resp, <span class="dt">FUN =</span> <span class="cf">function</span>(x) <span class="kw">sqrt</span>(<span class="kw">sum</span>(x)))</span>
<span id="cb59-47"><a href="building-the-modelalgorithm.html#cb59-47" aria-hidden="true"></a>  </span>
<span id="cb59-48"><a href="building-the-modelalgorithm.html#cb59-48" aria-hidden="true"></a>  <span class="co">## Differencing Matrix, (TT-(l+1)) x TT </span></span>
<span id="cb59-49"><a href="building-the-modelalgorithm.html#cb59-49" aria-hidden="true"></a>  Dlp1 &lt;-<span class="st"> </span><span class="kw">gen_diff_mat</span>(<span class="dt">n =</span> TT, <span class="dt">l =</span> l<span class="op">+</span><span class="dv">1</span>, <span class="dt">x =</span> x)</span>
<span id="cb59-50"><a href="building-the-modelalgorithm.html#cb59-50" aria-hidden="true"></a>  <span class="co"># l = 2 is quadratic trend filtering</span></span>
<span id="cb59-51"><a href="building-the-modelalgorithm.html#cb59-51" aria-hidden="true"></a>  <span class="co"># l = 1 is linear trend filtering</span></span>
<span id="cb59-52"><a href="building-the-modelalgorithm.html#cb59-52" aria-hidden="true"></a>  <span class="co"># l = 0 is fused lasso</span></span>
<span id="cb59-53"><a href="building-the-modelalgorithm.html#cb59-53" aria-hidden="true"></a>  </span>
<span id="cb59-54"><a href="building-the-modelalgorithm.html#cb59-54" aria-hidden="true"></a>  <span class="co">## Forming the objective</span></span>
<span id="cb59-55"><a href="building-the-modelalgorithm.html#cb59-55" aria-hidden="true"></a>  obj =<span class="st"> </span><span class="dv">1</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>N) <span class="op">*</span>( <span class="kw">Reduce</span>(<span class="st">"+"</span>, <span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>TT, <span class="dt">FUN =</span> <span class="cf">function</span>(tt) CVXR<span class="op">::</span><span class="kw">quad_form</span>(<span class="kw">t</span>(resp.sum.sqrt[[tt]]<span class="op">*</span>mumat[tt,]), Sigma_inv))) <span class="dv">-2</span> <span class="op">*</span><span class="st"> </span><span class="kw">Reduce</span>(<span class="st">"+"</span>, <span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>TT, <span class="dt">FUN =</span> <span class="cf">function</span>(tt) <span class="kw">t</span>(ytildes[tt,]) <span class="op">%*%</span><span class="st"> </span>Sigma_inv <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(mumat[tt,]))) <span class="op">+</span><span class="st"> </span>aux.y) <span class="op">+</span><span class="st"> </span>lambda <span class="op">*</span><span class="st"> </span><span class="kw">sum</span>(CVXR<span class="op">::</span><span class="kw">sum_entries</span>(<span class="kw">abs</span>(Dlp1 <span class="op">%*%</span><span class="st"> </span>mumat), <span class="dt">axis =</span> <span class="dv">1</span>))</span>
<span id="cb59-56"><a href="building-the-modelalgorithm.html#cb59-56" aria-hidden="true"></a></span>
<span id="cb59-57"><a href="building-the-modelalgorithm.html#cb59-57" aria-hidden="true"></a>  <span class="co">##Reduce("+", lapply(1:TT, FUN = function(tt) t(ytildes[tt,]) %*% Sigma_inv %*% (mumat[tt,]))) + aux.y</span></span>
<span id="cb59-58"><a href="building-the-modelalgorithm.html#cb59-58" aria-hidden="true"></a>  <span class="co">## a = t(resp.sum.sqrt[[tt]]*mumat[tt,])</span></span>
<span id="cb59-59"><a href="building-the-modelalgorithm.html#cb59-59" aria-hidden="true"></a>  <span class="co">## CVXR::quad_form(resp.sum.sqrt[[tt]]*mumat[tt,], Sigma_inv)</span></span>
<span id="cb59-60"><a href="building-the-modelalgorithm.html#cb59-60" aria-hidden="true"></a>    </span>
<span id="cb59-61"><a href="building-the-modelalgorithm.html#cb59-61" aria-hidden="true"></a>    </span>
<span id="cb59-62"><a href="building-the-modelalgorithm.html#cb59-62" aria-hidden="true"></a>  <span class="co">## resp.sum.sqrt[[tt]]*mumat[tt,] %&gt;% dim()</span></span>
<span id="cb59-63"><a href="building-the-modelalgorithm.html#cb59-63" aria-hidden="true"></a>  <span class="co">## dim(Sigma_inv)</span></span>
<span id="cb59-64"><a href="building-the-modelalgorithm.html#cb59-64" aria-hidden="true"></a>  <span class="co">## mumat %&gt;% dim()</span></span>
<span id="cb59-65"><a href="building-the-modelalgorithm.html#cb59-65" aria-hidden="true"></a>  <span class="co">## ( (resp.sum.sqrt[[tt]]) * mumat[tt,]) %&gt;% dim()</span></span>
<span id="cb59-66"><a href="building-the-modelalgorithm.html#cb59-66" aria-hidden="true"></a>  </span>
<span id="cb59-67"><a href="building-the-modelalgorithm.html#cb59-67" aria-hidden="true"></a></span>
<span id="cb59-68"><a href="building-the-modelalgorithm.html#cb59-68" aria-hidden="true"></a>  <span class="co">## Putting together the ball constraint</span></span>
<span id="cb59-69"><a href="building-the-modelalgorithm.html#cb59-69" aria-hidden="true"></a>  rowmns &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rep</span>(<span class="dv">1</span>, TT<span class="op">^</span><span class="dv">2</span>), <span class="dt">nrow =</span> TT)<span class="op">/</span>TT</span>
<span id="cb59-70"><a href="building-the-modelalgorithm.html#cb59-70" aria-hidden="true"></a>  mu_dotdot &lt;-<span class="st"> </span>rowmns <span class="op">%*%</span><span class="st"> </span>mumat</span>
<span id="cb59-71"><a href="building-the-modelalgorithm.html#cb59-71" aria-hidden="true"></a>  constraints =<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb59-72"><a href="building-the-modelalgorithm.html#cb59-72" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(maxdev)){</span>
<span id="cb59-73"><a href="building-the-modelalgorithm.html#cb59-73" aria-hidden="true"></a>    constraints =<span class="st"> </span><span class="kw">list</span>(CVXR<span class="op">::</span><span class="kw">sum_entries</span>(CVXR<span class="op">::</span><span class="kw">square</span>(mumat <span class="op">-</span><span class="st"> </span>mu_dotdot), <span class="dt">axis =</span> <span class="dv">2</span>) <span class="op">&lt;=</span><span class="st"> </span><span class="kw">rep</span>(maxdev<span class="op">^</span><span class="dv">2</span>, TT) )</span>
<span id="cb59-74"><a href="building-the-modelalgorithm.html#cb59-74" aria-hidden="true"></a>  }</span>
<span id="cb59-75"><a href="building-the-modelalgorithm.html#cb59-75" aria-hidden="true"></a>  </span>
<span id="cb59-76"><a href="building-the-modelalgorithm.html#cb59-76" aria-hidden="true"></a>  <span class="co">## Try all two CVXR solvers.</span></span>
<span id="cb59-77"><a href="building-the-modelalgorithm.html#cb59-77" aria-hidden="true"></a>  prob &lt;-<span class="st"> </span>CVXR<span class="op">::</span><span class="kw">Problem</span>(CVXR<span class="op">::</span><span class="kw">Minimize</span>(obj), constraints)</span>
<span id="cb59-78"><a href="building-the-modelalgorithm.html#cb59-78" aria-hidden="true"></a>  result =<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb59-79"><a href="building-the-modelalgorithm.html#cb59-79" aria-hidden="true"></a>  result &lt;-<span class="st"> </span><span class="kw">tryCatch</span>({</span>
<span id="cb59-80"><a href="building-the-modelalgorithm.html#cb59-80" aria-hidden="true"></a>    CVXR<span class="op">::</span><span class="kw">solve</span>(prob, <span class="dt">solver=</span><span class="st">"ECOS"</span>,</span>
<span id="cb59-81"><a href="building-the-modelalgorithm.html#cb59-81" aria-hidden="true"></a>          <span class="dt">FEASTOL =</span> ecos_thresh, <span class="dt">RELTOL =</span> ecos_thresh, <span class="dt">ABSTOL =</span> ecos_thresh)</span>
<span id="cb59-82"><a href="building-the-modelalgorithm.html#cb59-82" aria-hidden="true"></a>  }, <span class="dt">error=</span><span class="cf">function</span>(err){</span>
<span id="cb59-83"><a href="building-the-modelalgorithm.html#cb59-83" aria-hidden="true"></a>    err<span class="op">$</span>message =<span class="st"> </span><span class="kw">paste</span>(err<span class="op">$</span>message, </span>
<span id="cb59-84"><a href="building-the-modelalgorithm.html#cb59-84" aria-hidden="true"></a>                        <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>, <span class="st">"Lasso solver using ECOS has failed."</span> ,<span class="dt">sep=</span><span class="st">""</span>)</span>
<span id="cb59-85"><a href="building-the-modelalgorithm.html#cb59-85" aria-hidden="true"></a>    <span class="kw">cat</span>(err<span class="op">$</span>message, <span class="dt">fill=</span><span class="ot">TRUE</span>)</span>
<span id="cb59-86"><a href="building-the-modelalgorithm.html#cb59-86" aria-hidden="true"></a>    <span class="kw">return</span>(<span class="ot">NULL</span>)</span>
<span id="cb59-87"><a href="building-the-modelalgorithm.html#cb59-87" aria-hidden="true"></a>  })</span>
<span id="cb59-88"><a href="building-the-modelalgorithm.html#cb59-88" aria-hidden="true"></a>  </span>
<span id="cb59-89"><a href="building-the-modelalgorithm.html#cb59-89" aria-hidden="true"></a>  <span class="co">## If anything is wrong, flag to use SCS solver</span></span>
<span id="cb59-90"><a href="building-the-modelalgorithm.html#cb59-90" aria-hidden="true"></a>  scs =<span class="st"> </span><span class="ot">FALSE</span></span>
<span id="cb59-91"><a href="building-the-modelalgorithm.html#cb59-91" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="kw">is.null</span>(result)){</span>
<span id="cb59-92"><a href="building-the-modelalgorithm.html#cb59-92" aria-hidden="true"></a>    scs =<span class="st"> </span><span class="ot">TRUE</span></span>
<span id="cb59-93"><a href="building-the-modelalgorithm.html#cb59-93" aria-hidden="true"></a>  } <span class="cf">else</span> {</span>
<span id="cb59-94"><a href="building-the-modelalgorithm.html#cb59-94" aria-hidden="true"></a>    <span class="cf">if</span>(result<span class="op">$</span>status <span class="op">!=</span><span class="st"> "optimal"</span>) scs =<span class="st"> </span><span class="ot">TRUE</span></span>
<span id="cb59-95"><a href="building-the-modelalgorithm.html#cb59-95" aria-hidden="true"></a>  }</span>
<span id="cb59-96"><a href="building-the-modelalgorithm.html#cb59-96" aria-hidden="true"></a>  </span>
<span id="cb59-97"><a href="building-the-modelalgorithm.html#cb59-97" aria-hidden="true"></a>  <span class="co">## Use the SCS solver</span></span>
<span id="cb59-98"><a href="building-the-modelalgorithm.html#cb59-98" aria-hidden="true"></a>  <span class="cf">if</span>(scs){</span>
<span id="cb59-99"><a href="building-the-modelalgorithm.html#cb59-99" aria-hidden="true"></a>    result =<span class="st"> </span>CVXR<span class="op">::</span><span class="kw">solve</span>(prob, <span class="dt">solver=</span><span class="st">"SCS"</span>, <span class="dt">eps =</span> scs_eps)</span>
<span id="cb59-100"><a href="building-the-modelalgorithm.html#cb59-100" aria-hidden="true"></a>    <span class="cf">if</span>(<span class="kw">any</span>(<span class="kw">is.na</span>(result<span class="op">$</span><span class="kw">getValue</span>(mumat)))){ <span class="co">## A clumsy way to check.</span></span>
<span id="cb59-101"><a href="building-the-modelalgorithm.html#cb59-101" aria-hidden="true"></a>      <span class="kw">stop</span>(<span class="st">"Lasso solver using both ECOS and SCS has failed."</span>, <span class="dt">sep=</span><span class="st">""</span>)</span>
<span id="cb59-102"><a href="building-the-modelalgorithm.html#cb59-102" aria-hidden="true"></a>    }</span>
<span id="cb59-103"><a href="building-the-modelalgorithm.html#cb59-103" aria-hidden="true"></a>  }</span>
<span id="cb59-104"><a href="building-the-modelalgorithm.html#cb59-104" aria-hidden="true"></a>  </span>
<span id="cb59-105"><a href="building-the-modelalgorithm.html#cb59-105" aria-hidden="true"></a>  <span class="co">## Record Interesting Parameters</span></span>
<span id="cb59-106"><a href="building-the-modelalgorithm.html#cb59-106" aria-hidden="true"></a>  num_iters &lt;-<span class="st"> </span>result<span class="op">$</span>num_iters</span>
<span id="cb59-107"><a href="building-the-modelalgorithm.html#cb59-107" aria-hidden="true"></a>  status &lt;-<span class="st"> </span>result<span class="op">$</span>status</span>
<span id="cb59-108"><a href="building-the-modelalgorithm.html#cb59-108" aria-hidden="true"></a>  mumat &lt;-<span class="st"> </span>result<span class="op">$</span><span class="kw">getValue</span>(mumat)</span>
<span id="cb59-109"><a href="building-the-modelalgorithm.html#cb59-109" aria-hidden="true"></a>  val &lt;-<span class="st"> </span>result<span class="op">$</span>value</span>
<span id="cb59-110"><a href="building-the-modelalgorithm.html#cb59-110" aria-hidden="true"></a>  </span>
<span id="cb59-111"><a href="building-the-modelalgorithm.html#cb59-111" aria-hidden="true"></a>  <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">mu =</span> mumat, <span class="dt">value =</span> val, <span class="dt">status =</span> status, <span class="dt">num_iters =</span> num_iters))</span>
<span id="cb59-112"><a href="building-the-modelalgorithm.html#cb59-112" aria-hidden="true"></a>}</span></code></pre></div>
<p>This function solves the following problem:</p>
<p><span class="math display">\[
\begin{align*}
&amp;\text{minimize}_{\mu}
{\frac{1}{2N}
    \sum_{t=1}^T \sum_{i=1}^{n_t} \hat{\gamma}_{it} (y_i^{(t)} - \mu_{\cdot t})^\top \hat{\Sigma}^{-1} ( y_i^{(t)} - \mu_{\cdot t})
  + \lambda \sum_{j=1}^d \|D^{(l)}\mu_{j\cdot }\|_1}\\
&amp;\text{subject to}\;\; {\| \mu_{\cdot t} - \bar{\mu}_{\cdot \cdot}\|_2 \le r \;\;\forall t=1,\cdots, T, }
\end{align*}
\]</span></p>
<p>and is directly equivalent to <code>Mstep_mu()</code>. The resulting solution and the
objective value should be the same. Let’s check that.</p>
<p>First, set up some objects to run <code>Mstep_mu()</code> and <code>Mstep_mu_cvxr()</code>.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="building-the-modelalgorithm.html#cb60-1" aria-hidden="true"></a>numclust =<span class="st"> </span><span class="dv">3</span></span>
<span id="cb60-2"><a href="building-the-modelalgorithm.html#cb60-2" aria-hidden="true"></a>TT =<span class="st"> </span><span class="dv">100</span></span>
<span id="cb60-3"><a href="building-the-modelalgorithm.html#cb60-3" aria-hidden="true"></a>dimdat =<span class="st"> </span><span class="dv">1</span></span>
<span id="cb60-4"><a href="building-the-modelalgorithm.html#cb60-4" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">0</span>)</span>
<span id="cb60-5"><a href="building-the-modelalgorithm.html#cb60-5" aria-hidden="true"></a>dt =<span class="st"> </span><span class="kw">gendat_1d</span>(<span class="dt">TT =</span> TT, <span class="dt">ntlist =</span> <span class="kw">rep</span>(TT, <span class="dv">100</span>))</span>
<span id="cb60-6"><a href="building-the-modelalgorithm.html#cb60-6" aria-hidden="true"></a>ylist =<span class="st"> </span>dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dt2ylist</span>()</span>
<span id="cb60-7"><a href="building-the-modelalgorithm.html#cb60-7" aria-hidden="true"></a>sigma =<span class="st"> </span><span class="kw">init_sigma</span>(ylist, numclust) <span class="co">## (T x numclust x (dimdat x dimdat))</span></span>
<span id="cb60-8"><a href="building-the-modelalgorithm.html#cb60-8" aria-hidden="true"></a>mn =<span class="st"> </span><span class="kw">init_mn</span>(ylist, numclust, TT, dimdat)<span class="co">##, countslist = countslist) </span></span>
<span id="cb60-9"><a href="building-the-modelalgorithm.html#cb60-9" aria-hidden="true"></a>prob =<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span><span class="op">/</span>numclust, <span class="dt">nrow =</span> TT, <span class="dt">ncol =</span> numclust) <span class="co">## Initialize to all 1/K.</span></span>
<span id="cb60-10"><a href="building-the-modelalgorithm.html#cb60-10" aria-hidden="true"></a>resp =<span class="st"> </span><span class="kw">Estep</span>(mn, sigma, prob, <span class="dt">ylist =</span> ylist, numclust)</span>
<span id="cb60-11"><a href="building-the-modelalgorithm.html#cb60-11" aria-hidden="true"></a>lambda =<span class="st"> </span><span class="fl">.01</span></span>
<span id="cb60-12"><a href="building-the-modelalgorithm.html#cb60-12" aria-hidden="true"></a>l =<span class="st"> </span><span class="dv">1</span></span>
<span id="cb60-13"><a href="building-the-modelalgorithm.html#cb60-13" aria-hidden="true"></a>x =<span class="st"> </span><span class="dv">1</span><span class="op">:</span>TT</span>
<span id="cb60-14"><a href="building-the-modelalgorithm.html#cb60-14" aria-hidden="true"></a>Dlp1 =<span class="st"> </span><span class="kw">gen_diff_mat</span>(<span class="dt">n =</span> TT, <span class="dt">l =</span> l<span class="op">+</span><span class="dv">1</span>, <span class="dt">x =</span> x)</span>
<span id="cb60-15"><a href="building-the-modelalgorithm.html#cb60-15" aria-hidden="true"></a>Dl =<span class="st"> </span><span class="kw">gen_diff_mat</span>(<span class="dt">n =</span> TT, <span class="dt">l =</span> l, <span class="dt">x =</span> x)</span>
<span id="cb60-16"><a href="building-the-modelalgorithm.html#cb60-16" aria-hidden="true"></a>Dlsqrd &lt;-<span class="st"> </span><span class="kw">t</span>(Dl) <span class="op">%*%</span><span class="st"> </span>Dl</span>
<span id="cb60-17"><a href="building-the-modelalgorithm.html#cb60-17" aria-hidden="true"></a>maxdev =<span class="st"> </span><span class="ot">NULL</span></span></code></pre></div>
<p>Then, compare the result of the two implementations. They should look identical.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="building-the-modelalgorithm.html#cb61-1" aria-hidden="true"></a><span class="co">## overall ADMM</span></span>
<span id="cb61-2"><a href="building-the-modelalgorithm.html#cb61-2" aria-hidden="true"></a>res1 =<span class="st"> </span><span class="kw">Mstep_mu</span>(resp, ylist, lambda, <span class="dt">l=</span>l, <span class="dt">sigma=</span>sigma, <span class="dt">Dlsqrd =</span> Dlsqrd, <span class="dt">Dl=</span>Dl, <span class="dt">Dlp1=</span>Dlp1, <span class="dt">TT=</span>TT, <span class="dt">N=</span>N, <span class="dt">dimdat=</span>dimdat, <span class="dt">e_mat=</span><span class="kw">etilde_mat</span>(<span class="dt">TT =</span> TT),</span>
<span id="cb61-3"><a href="building-the-modelalgorithm.html#cb61-3" aria-hidden="true"></a>                <span class="dt">maxdev =</span> maxdev)</span>
<span id="cb61-4"><a href="building-the-modelalgorithm.html#cb61-4" aria-hidden="true"></a>mn1 =<span class="st"> </span>res1<span class="op">$</span>mns</span>
<span id="cb61-5"><a href="building-the-modelalgorithm.html#cb61-5" aria-hidden="true"></a></span>
<span id="cb61-6"><a href="building-the-modelalgorithm.html#cb61-6" aria-hidden="true"></a><span class="co">## CVXR just ONE cluster</span></span>
<span id="cb61-7"><a href="building-the-modelalgorithm.html#cb61-7" aria-hidden="true"></a>res2list =<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>numclust, <span class="cf">function</span>(iclust){</span>
<span id="cb61-8"><a href="building-the-modelalgorithm.html#cb61-8" aria-hidden="true"></a>  Sigma_inv_oneclust =<span class="st"> </span><span class="kw">solve</span>(sigma[iclust,,])</span>
<span id="cb61-9"><a href="building-the-modelalgorithm.html#cb61-9" aria-hidden="true"></a>  resp_oneclist =<span class="st"> </span><span class="kw">lapply</span>(resp, <span class="cf">function</span>(resp_onetime){resp_onetime[,iclust, drop=<span class="ot">FALSE</span>]})</span>
<span id="cb61-10"><a href="building-the-modelalgorithm.html#cb61-10" aria-hidden="true"></a>  N =<span class="st"> </span><span class="kw">sum</span>(<span class="kw">unlist</span>(resp))</span>
<span id="cb61-11"><a href="building-the-modelalgorithm.html#cb61-11" aria-hidden="true"></a>  res2 =<span class="st"> </span><span class="kw">Mstep_mu_cvxr</span>(ylist, resp_oneclist,</span>
<span id="cb61-12"><a href="building-the-modelalgorithm.html#cb61-12" aria-hidden="true"></a>                       lambda, l,  Sigma_inv_oneclust,</span>
<span id="cb61-13"><a href="building-the-modelalgorithm.html#cb61-13" aria-hidden="true"></a>                       <span class="dt">thresh =</span> <span class="fl">1E-8</span>, <span class="dt">maxdev =</span> maxdev, dimdat, N) </span>
<span id="cb61-14"><a href="building-the-modelalgorithm.html#cb61-14" aria-hidden="true"></a>  res2<span class="op">$</span>mu</span>
<span id="cb61-15"><a href="building-the-modelalgorithm.html#cb61-15" aria-hidden="true"></a>})</span>
<span id="cb61-16"><a href="building-the-modelalgorithm.html#cb61-16" aria-hidden="true"></a>mn2 =<span class="st"> </span><span class="kw">array</span>(<span class="ot">NA</span>, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">100</span>, dimdat, <span class="dv">3</span>))</span>
<span id="cb61-17"><a href="building-the-modelalgorithm.html#cb61-17" aria-hidden="true"></a><span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>numclust){</span>
<span id="cb61-18"><a href="building-the-modelalgorithm.html#cb61-18" aria-hidden="true"></a>  mn2[,,iclust] =<span class="st"> </span>res2list[[iclust]] <span class="op">%&gt;%</span><span class="st">  </span><span class="kw">as.matrix</span>()</span>
<span id="cb61-19"><a href="building-the-modelalgorithm.html#cb61-19" aria-hidden="true"></a>}</span>
<span id="cb61-20"><a href="building-the-modelalgorithm.html#cb61-20" aria-hidden="true"></a></span>
<span id="cb61-21"><a href="building-the-modelalgorithm.html#cb61-21" aria-hidden="true"></a>  </span>
<span id="cb61-22"><a href="building-the-modelalgorithm.html#cb61-22" aria-hidden="true"></a><span class="co">## Plot them</span></span>
<span id="cb61-23"><a href="building-the-modelalgorithm.html#cb61-23" aria-hidden="true"></a><span class="kw">plot</span>(<span class="dt">x =</span> dt<span class="op">$</span>time, <span class="dt">y=</span>dt<span class="op">$</span>Y, <span class="dt">col =</span> <span class="kw">rgb</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.04</span>),</span>
<span id="cb61-24"><a href="building-the-modelalgorithm.html#cb61-24" aria-hidden="true"></a>     <span class="dt">main =</span> <span class="st">'admm (solid) vs cvxr (dashed)'</span>,</span>
<span id="cb61-25"><a href="building-the-modelalgorithm.html#cb61-25" aria-hidden="true"></a>     <span class="dt">ylab =</span> <span class="st">""</span>, <span class="dt">xlab =</span> <span class="st">"time"</span>)</span>
<span id="cb61-26"><a href="building-the-modelalgorithm.html#cb61-26" aria-hidden="true"></a>mn1[,<span class="dv">1</span>,] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">matlines</span>(<span class="dt">lwd =</span> <span class="dv">1</span>, <span class="dt">lty =</span> <span class="dv">1</span>)</span>
<span id="cb61-27"><a href="building-the-modelalgorithm.html#cb61-27" aria-hidden="true"></a>mn2[,<span class="dv">1</span>,] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">matlines</span>(<span class="dt">lwd =</span> <span class="dv">3</span>, <span class="dt">lty =</span> <span class="dv">3</span>)</span></code></pre></div>
<p>Next, do this for uneven inputs.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="building-the-modelalgorithm.html#cb62-1" aria-hidden="true"></a><span class="co">## Setup</span></span>
<span id="cb62-2"><a href="building-the-modelalgorithm.html#cb62-2" aria-hidden="true"></a>numclust =<span class="st"> </span><span class="dv">3</span></span>
<span id="cb62-3"><a href="building-the-modelalgorithm.html#cb62-3" aria-hidden="true"></a>TT =<span class="st"> </span><span class="dv">100</span></span>
<span id="cb62-4"><a href="building-the-modelalgorithm.html#cb62-4" aria-hidden="true"></a>dimdat =<span class="st"> </span><span class="dv">1</span></span>
<span id="cb62-5"><a href="building-the-modelalgorithm.html#cb62-5" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">0</span>)</span>
<span id="cb62-6"><a href="building-the-modelalgorithm.html#cb62-6" aria-hidden="true"></a>dt =<span class="st"> </span><span class="kw">gendat_1d</span>(<span class="dt">TT =</span> TT, <span class="dt">ntlist =</span> <span class="kw">rep</span>(TT, <span class="dv">100</span>))</span>
<span id="cb62-7"><a href="building-the-modelalgorithm.html#cb62-7" aria-hidden="true"></a>ylist =<span class="st"> </span>dt <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dt2ylist</span>()</span>
<span id="cb62-8"><a href="building-the-modelalgorithm.html#cb62-8" aria-hidden="true"></a></span>
<span id="cb62-9"><a href="building-the-modelalgorithm.html#cb62-9" aria-hidden="true"></a><span class="co">## Subset them</span></span>
<span id="cb62-10"><a href="building-the-modelalgorithm.html#cb62-10" aria-hidden="true"></a>ylist =<span class="st"> </span>ylist[<span class="op">-</span><span class="kw">seq</span>(<span class="dt">from=</span><span class="dv">10</span>,<span class="dt">to=</span><span class="dv">100</span>,<span class="dt">by=</span><span class="dv">10</span>)]</span>
<span id="cb62-11"><a href="building-the-modelalgorithm.html#cb62-11" aria-hidden="true"></a>x =<span class="st"> </span>(<span class="dv">1</span><span class="op">:</span><span class="dv">100</span>)[<span class="op">-</span><span class="kw">seq</span>(<span class="dt">from=</span><span class="dv">10</span>,<span class="dt">to=</span><span class="dv">100</span>,<span class="dt">by=</span><span class="dv">10</span>)]</span>
<span id="cb62-12"><a href="building-the-modelalgorithm.html#cb62-12" aria-hidden="true"></a></span>
<span id="cb62-13"><a href="building-the-modelalgorithm.html#cb62-13" aria-hidden="true"></a>sigma =<span class="st"> </span><span class="kw">init_sigma</span>(ylist, numclust) <span class="co">## (T x numclust x (dimdat x dimdat))</span></span>
<span id="cb62-14"><a href="building-the-modelalgorithm.html#cb62-14" aria-hidden="true"></a>mn =<span class="st"> </span><span class="kw">init_mn</span>(ylist, numclust, TT, dimdat)<span class="co">##, countslist = countslist)</span></span>
<span id="cb62-15"><a href="building-the-modelalgorithm.html#cb62-15" aria-hidden="true"></a>prob =<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span><span class="op">/</span>numclust, <span class="dt">nrow =</span> TT, <span class="dt">ncol =</span> numclust) <span class="co">## Initialize to all 1/K.</span></span>
<span id="cb62-16"><a href="building-the-modelalgorithm.html#cb62-16" aria-hidden="true"></a>resp =<span class="st"> </span><span class="kw">Estep</span>(mn, sigma, prob, <span class="dt">ylist =</span> ylist, numclust)</span>
<span id="cb62-17"><a href="building-the-modelalgorithm.html#cb62-17" aria-hidden="true"></a>lambda =<span class="st"> </span><span class="fl">.1</span></span>
<span id="cb62-18"><a href="building-the-modelalgorithm.html#cb62-18" aria-hidden="true"></a>l =<span class="st"> </span><span class="dv">2</span></span>
<span id="cb62-19"><a href="building-the-modelalgorithm.html#cb62-19" aria-hidden="true"></a><span class="co">##x = 1:TT</span></span>
<span id="cb62-20"><a href="building-the-modelalgorithm.html#cb62-20" aria-hidden="true"></a>Dlp1 =<span class="st"> </span><span class="kw">gen_diff_mat</span>(<span class="dt">n =</span> <span class="kw">length</span>(x), <span class="dt">l =</span> l<span class="op">+</span><span class="dv">1</span>, <span class="dt">x =</span> x)</span>
<span id="cb62-21"><a href="building-the-modelalgorithm.html#cb62-21" aria-hidden="true"></a>Dl =<span class="st"> </span><span class="kw">gen_diff_mat</span>(<span class="dt">n =</span> <span class="kw">length</span>(x), <span class="dt">l =</span> l, <span class="dt">x =</span> x)</span>
<span id="cb62-22"><a href="building-the-modelalgorithm.html#cb62-22" aria-hidden="true"></a>Dlsqrd &lt;-<span class="st"> </span><span class="kw">t</span>(Dl) <span class="op">%*%</span><span class="st"> </span>Dl</span>
<span id="cb62-23"><a href="building-the-modelalgorithm.html#cb62-23" aria-hidden="true"></a>maxdev =<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb62-24"><a href="building-the-modelalgorithm.html#cb62-24" aria-hidden="true"></a></span>
<span id="cb62-25"><a href="building-the-modelalgorithm.html#cb62-25" aria-hidden="true"></a></span>
<span id="cb62-26"><a href="building-the-modelalgorithm.html#cb62-26" aria-hidden="true"></a><span class="co">## Try the algorithm itelf.</span></span>
<span id="cb62-27"><a href="building-the-modelalgorithm.html#cb62-27" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb62-28"><a href="building-the-modelalgorithm.html#cb62-28" aria-hidden="true"></a>obj =<span class="st"> </span><span class="kw">flowtrend_once</span>(<span class="dt">ylist =</span> ylist, <span class="dt">x =</span> x, <span class="dt">lambda =</span> <span class="fl">.1</span>, <span class="dt">lambda_prob =</span> <span class="fl">.1</span>,</span>
<span id="cb62-29"><a href="building-the-modelalgorithm.html#cb62-29" aria-hidden="true"></a>                     <span class="dt">l =</span> <span class="dv">2</span>, <span class="dt">l_prob =</span> <span class="dv">2</span>, <span class="dt">maxdev =</span> <span class="dv">5</span>, <span class="dt">numclust =</span> <span class="dv">3</span>,</span>
<span id="cb62-30"><a href="building-the-modelalgorithm.html#cb62-30" aria-hidden="true"></a>                     <span class="dt">rho_init =</span> <span class="fl">0.01</span>, <span class="dt">verbose =</span> <span class="ot">TRUE</span>)</span>
<span id="cb62-31"><a href="building-the-modelalgorithm.html#cb62-31" aria-hidden="true"></a><span class="kw">plot_1d</span>(<span class="dt">ylist=</span>ylist, <span class="dt">obj=</span>obj)</span>
<span id="cb62-32"><a href="building-the-modelalgorithm.html#cb62-32" aria-hidden="true"></a><span class="kw">plot</span>(obj<span class="op">$</span>objectives, <span class="dt">type =</span><span class="st">'l'</span>)</span>
<span id="cb62-33"><a href="building-the-modelalgorithm.html#cb62-33" aria-hidden="true"></a>mn1 =<span class="st"> </span>obj<span class="op">$</span>mn</span>
<span id="cb62-34"><a href="building-the-modelalgorithm.html#cb62-34" aria-hidden="true"></a>obj<span class="op">$</span>mn[,<span class="dv">1</span>,] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">diff</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">diff</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">diff</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">matplot</span>(<span class="dt">type=</span><span class="st">'l'</span>)</span>
<span id="cb62-35"><a href="building-the-modelalgorithm.html#cb62-35" aria-hidden="true"></a>mn[,<span class="dv">1</span>,] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">diff</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">diff</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">diff</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">matplot</span>(<span class="dt">type=</span><span class="st">'l'</span>)</span>
<span id="cb62-36"><a href="building-the-modelalgorithm.html#cb62-36" aria-hidden="true"></a>mn[,<span class="dv">1</span>,] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">matplot</span>(<span class="dt">type=</span><span class="st">'l'</span>)</span>
<span id="cb62-37"><a href="building-the-modelalgorithm.html#cb62-37" aria-hidden="true"></a><span class="co">## Okay, so cluster 3 has a very irregular mean.</span></span>
<span id="cb62-38"><a href="building-the-modelalgorithm.html#cb62-38" aria-hidden="true"></a></span>
<span id="cb62-39"><a href="building-the-modelalgorithm.html#cb62-39" aria-hidden="true"></a><span class="kw">plot</span>(<span class="dt">x =</span> dt<span class="op">$</span>time, <span class="dt">y=</span>dt<span class="op">$</span>Y, <span class="dt">col =</span> <span class="kw">rgb</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.04</span>),</span>
<span id="cb62-40"><a href="building-the-modelalgorithm.html#cb62-40" aria-hidden="true"></a>     <span class="dt">main =</span> <span class="st">'admm (solid) vs cvxr (dashed)'</span>,</span>
<span id="cb62-41"><a href="building-the-modelalgorithm.html#cb62-41" aria-hidden="true"></a>     <span class="dt">ylab =</span> <span class="st">""</span>, <span class="dt">xlab =</span> <span class="st">"time"</span>)</span>
<span id="cb62-42"><a href="building-the-modelalgorithm.html#cb62-42" aria-hidden="true"></a>mn_old[,<span class="dv">1</span>,] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">matlines</span>(<span class="dt">lwd =</span> <span class="dv">1</span>, <span class="dt">x=</span>x, <span class="dt">lty =</span> <span class="dv">1</span>)</span>
<span id="cb62-43"><a href="building-the-modelalgorithm.html#cb62-43" aria-hidden="true"></a>mn_less_old[,<span class="dv">1</span>,] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">matlines</span>(<span class="dt">lwd =</span> <span class="dv">1</span>, <span class="dt">x=</span>x, <span class="dt">lty =</span> <span class="dv">2</span>)</span>
<span id="cb62-44"><a href="building-the-modelalgorithm.html#cb62-44" aria-hidden="true"></a>mn[,<span class="dv">1</span>,] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">matlines</span>(<span class="dt">lwd =</span> <span class="dv">1</span>, <span class="dt">x=</span>x, <span class="dt">lty =</span> <span class="dv">3</span>)</span></code></pre></div>
<p>TODO: We just need to bundle this into <code>testthat</code> style tests, and make sure to test several lambda values.</p>
<pre><code>TODO: maybe do this for unevenly spaced inputs. CVXR needs to take a different D matrix.</code></pre>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="building-the-modelalgorithm.html#cb64-1" aria-hidden="true"></a>testthat<span class="op">::</span><span class="kw">test_that</span>(<span class="st">"Test the M step of \mu against CVXR"</span>, {})</span></code></pre></div>
</div>
</div>
<div id="the-main-flowtrend-function" class="section level2 hasAnchor" number="3.6">
<h2>
<span class="header-section-number">3.6</span> The main “flowtrend” function<a href="building-the-modelalgorithm.html#the-main-flowtrend-function" class="anchor-section" aria-label="Anchor link to header"></a>
</h2>
<p>Now we’ve assembled all ingredients we need, we’ll build the main function
<code>flowtrend_once()</code> to estimate a flowtrend model. Here goes:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="building-the-modelalgorithm.html#cb65-1" aria-hidden="true"></a><span class="co">#' Estimate flowtrend model once.</span></span>
<span id="cb65-2"><a href="building-the-modelalgorithm.html#cb65-2" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb65-3"><a href="building-the-modelalgorithm.html#cb65-3" aria-hidden="true"></a><span class="co">#' @param ylist Data.</span></span>
<span id="cb65-4"><a href="building-the-modelalgorithm.html#cb65-4" aria-hidden="true"></a><span class="co">#' @param countslist Counts corresponding to multiplicities.</span></span>
<span id="cb65-5"><a href="building-the-modelalgorithm.html#cb65-5" aria-hidden="true"></a><span class="co">#' @param x Times, if points are not evenly spaced. Defaults to NULL, in which</span></span>
<span id="cb65-6"><a href="building-the-modelalgorithm.html#cb65-6" aria-hidden="true"></a><span class="co">#'   case the value becomes \code{1:T}, for the $T==length(ylist)$.</span></span>
<span id="cb65-7"><a href="building-the-modelalgorithm.html#cb65-7" aria-hidden="true"></a><span class="co">#' @param numclust Number of clusters.</span></span>
<span id="cb65-8"><a href="building-the-modelalgorithm.html#cb65-8" aria-hidden="true"></a><span class="co">#' @param niter Maximum number of EM iterations.</span></span>
<span id="cb65-9"><a href="building-the-modelalgorithm.html#cb65-9" aria-hidden="true"></a><span class="co">#' @param l Degree of differencing for the mean trend filtering. l=0 will give</span></span>
<span id="cb65-10"><a href="building-the-modelalgorithm.html#cb65-10" aria-hidden="true"></a><span class="co">#'   you piecewise constant means; l=1 is piecewise linear, and so forth. </span></span>
<span id="cb65-11"><a href="building-the-modelalgorithm.html#cb65-11" aria-hidden="true"></a><span class="co">#' @param l_prob Degree of differencing for the probability trend filtering. </span></span>
<span id="cb65-12"><a href="building-the-modelalgorithm.html#cb65-12" aria-hidden="true"></a><span class="co">#' @param mn Initial value for cluster means. Defaults to NULL, in which case</span></span>
<span id="cb65-13"><a href="building-the-modelalgorithm.html#cb65-13" aria-hidden="true"></a><span class="co">#'   initial values are randomly chosen from the data.</span></span>
<span id="cb65-14"><a href="building-the-modelalgorithm.html#cb65-14" aria-hidden="true"></a><span class="co">#' @param lambda Smoothing parameter for means</span></span>
<span id="cb65-15"><a href="building-the-modelalgorithm.html#cb65-15" aria-hidden="true"></a><span class="co">#' @param lambda_prob Smoothing parameter for probabilities</span></span>
<span id="cb65-16"><a href="building-the-modelalgorithm.html#cb65-16" aria-hidden="true"></a><span class="co">#' @param verbose Loud or not? EM iteration progress is printed.</span></span>
<span id="cb65-17"><a href="building-the-modelalgorithm.html#cb65-17" aria-hidden="true"></a><span class="co">#' @param tol_em Relative numerical improvement of the objective value at which</span></span>
<span id="cb65-18"><a href="building-the-modelalgorithm.html#cb65-18" aria-hidden="true"></a><span class="co">#'   to stop the EM algorithm</span></span>
<span id="cb65-19"><a href="building-the-modelalgorithm.html#cb65-19" aria-hidden="true"></a><span class="co">#' @param maxdev Maximum deviation of cluster means across time..</span></span>
<span id="cb65-20"><a href="building-the-modelalgorithm.html#cb65-20" aria-hidden="true"></a><span class="co">#' @param countslist_overwrite</span></span>
<span id="cb65-21"><a href="building-the-modelalgorithm.html#cb65-21" aria-hidden="true"></a><span class="co">#' @param admm_err_rel</span></span>
<span id="cb65-22"><a href="building-the-modelalgorithm.html#cb65-22" aria-hidden="true"></a><span class="co">#' @param admm_err_abs</span></span>
<span id="cb65-23"><a href="building-the-modelalgorithm.html#cb65-23" aria-hidden="true"></a><span class="co">#' @param admm_local_adapt</span></span>
<span id="cb65-24"><a href="building-the-modelalgorithm.html#cb65-24" aria-hidden="true"></a><span class="co">#' @param admm_local_adapt_niter</span></span>
<span id="cb65-25"><a href="building-the-modelalgorithm.html#cb65-25" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb65-26"><a href="building-the-modelalgorithm.html#cb65-26" aria-hidden="true"></a><span class="co">#' @return List object with flowtrend model estimates.</span></span>
<span id="cb65-27"><a href="building-the-modelalgorithm.html#cb65-27" aria-hidden="true"></a><span class="co">#' @export</span></span>
<span id="cb65-28"><a href="building-the-modelalgorithm.html#cb65-28" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb65-29"><a href="building-the-modelalgorithm.html#cb65-29" aria-hidden="true"></a><span class="co">#' @examples</span></span>
<span id="cb65-30"><a href="building-the-modelalgorithm.html#cb65-30" aria-hidden="true"></a>flowtrend_once &lt;-<span class="st"> </span><span class="cf">function</span>(ylist,</span>
<span id="cb65-31"><a href="building-the-modelalgorithm.html#cb65-31" aria-hidden="true"></a>                       <span class="dt">countslist =</span> <span class="ot">NULL</span>,</span>
<span id="cb65-32"><a href="building-the-modelalgorithm.html#cb65-32" aria-hidden="true"></a>                       <span class="dt">x =</span> <span class="ot">NULL</span>,</span>
<span id="cb65-33"><a href="building-the-modelalgorithm.html#cb65-33" aria-hidden="true"></a>                       numclust, <span class="dt">niter =</span> <span class="dv">1000</span>, l, <span class="dt">l_prob =</span> <span class="ot">NULL</span>,</span>
<span id="cb65-34"><a href="building-the-modelalgorithm.html#cb65-34" aria-hidden="true"></a>                       <span class="dt">mn =</span> <span class="ot">NULL</span>, <span class="dt">lambda =</span> <span class="dv">0</span>, <span class="dt">lambda_prob =</span> <span class="ot">NULL</span>, <span class="dt">verbose =</span> <span class="ot">FALSE</span>,</span>
<span id="cb65-35"><a href="building-the-modelalgorithm.html#cb65-35" aria-hidden="true"></a>                       <span class="dt">tol_em =</span> <span class="fl">1E-4</span>,</span>
<span id="cb65-36"><a href="building-the-modelalgorithm.html#cb65-36" aria-hidden="true"></a>                       <span class="dt">maxdev =</span> <span class="ot">NULL</span>,</span>
<span id="cb65-37"><a href="building-the-modelalgorithm.html#cb65-37" aria-hidden="true"></a>                       <span class="dt">countslist_overwrite =</span> <span class="ot">NULL</span>,</span>
<span id="cb65-38"><a href="building-the-modelalgorithm.html#cb65-38" aria-hidden="true"></a>                       <span class="co">## beta Mstep (ADMM) settings</span></span>
<span id="cb65-39"><a href="building-the-modelalgorithm.html#cb65-39" aria-hidden="true"></a>                       <span class="dt">admm =</span> <span class="ot">TRUE</span>,</span>
<span id="cb65-40"><a href="building-the-modelalgorithm.html#cb65-40" aria-hidden="true"></a>                       <span class="dt">admm_err_rel =</span> <span class="fl">1E-3</span>,</span>
<span id="cb65-41"><a href="building-the-modelalgorithm.html#cb65-41" aria-hidden="true"></a>                       <span class="dt">admm_err_abs =</span> <span class="fl">1E-4</span>,</span>
<span id="cb65-42"><a href="building-the-modelalgorithm.html#cb65-42" aria-hidden="true"></a>                       <span class="co">## Mean M step (Locally Adaptive ADMM) settings</span></span>
<span id="cb65-43"><a href="building-the-modelalgorithm.html#cb65-43" aria-hidden="true"></a>                       <span class="dt">admm_local_adapt =</span> <span class="ot">TRUE</span>,</span>
<span id="cb65-44"><a href="building-the-modelalgorithm.html#cb65-44" aria-hidden="true"></a>                       <span class="dt">admm_local_adapt_niter =</span> <span class="cf">if</span>(admm_local_adapt) <span class="dv">10</span> <span class="cf">else</span> <span class="dv">1</span>,</span>
<span id="cb65-45"><a href="building-the-modelalgorithm.html#cb65-45" aria-hidden="true"></a>                       <span class="dt">rho_init =</span> <span class="fl">0.1</span>,</span>
<span id="cb65-46"><a href="building-the-modelalgorithm.html#cb65-46" aria-hidden="true"></a>                       <span class="co">## Other options</span></span>
<span id="cb65-47"><a href="building-the-modelalgorithm.html#cb65-47" aria-hidden="true"></a>                       <span class="dt">check_convergence =</span> <span class="ot">TRUE</span>,</span>
<span id="cb65-48"><a href="building-the-modelalgorithm.html#cb65-48" aria-hidden="true"></a>                       <span class="co">## Random seed</span></span>
<span id="cb65-49"><a href="building-the-modelalgorithm.html#cb65-49" aria-hidden="true"></a>                       <span class="dt">seed =</span> <span class="ot">NULL</span>){</span>
<span id="cb65-50"><a href="building-the-modelalgorithm.html#cb65-50" aria-hidden="true"></a></span>
<span id="cb65-51"><a href="building-the-modelalgorithm.html#cb65-51" aria-hidden="true"></a>  <span class="co">## Basic checks</span></span>
<span id="cb65-52"><a href="building-the-modelalgorithm.html#cb65-52" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(maxdev)){</span>
<span id="cb65-53"><a href="building-the-modelalgorithm.html#cb65-53" aria-hidden="true"></a>    assertthat<span class="op">::</span><span class="kw">assert_that</span>(maxdev<span class="op">!=</span><span class="dv">0</span>)</span>
<span id="cb65-54"><a href="building-the-modelalgorithm.html#cb65-54" aria-hidden="true"></a>  } <span class="cf">else</span> {</span>
<span id="cb65-55"><a href="building-the-modelalgorithm.html#cb65-55" aria-hidden="true"></a>    maxdev =<span class="st"> </span><span class="fl">1E10</span></span>
<span id="cb65-56"><a href="building-the-modelalgorithm.html#cb65-56" aria-hidden="true"></a>  }</span>
<span id="cb65-57"><a href="building-the-modelalgorithm.html#cb65-57" aria-hidden="true"></a>  assertthat<span class="op">::</span><span class="kw">assert_that</span>(numclust <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>)</span>
<span id="cb65-58"><a href="building-the-modelalgorithm.html#cb65-58" aria-hidden="true"></a>  assertthat<span class="op">::</span><span class="kw">assert_that</span>(niter <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>)</span>
<span id="cb65-59"><a href="building-the-modelalgorithm.html#cb65-59" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="kw">is.null</span>(countslist)){</span>
<span id="cb65-60"><a href="building-the-modelalgorithm.html#cb65-60" aria-hidden="true"></a>    ntlist =<span class="st"> </span><span class="kw">sapply</span>(ylist, nrow)</span>
<span id="cb65-61"><a href="building-the-modelalgorithm.html#cb65-61" aria-hidden="true"></a>    countslist =<span class="st"> </span><span class="kw">lapply</span>(ntlist, <span class="dt">FUN =</span> <span class="cf">function</span>(nt) <span class="kw">rep</span>(<span class="dv">1</span>, nt))</span>
<span id="cb65-62"><a href="building-the-modelalgorithm.html#cb65-62" aria-hidden="true"></a>  }</span>
<span id="cb65-63"><a href="building-the-modelalgorithm.html#cb65-63" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(seed)){</span>
<span id="cb65-64"><a href="building-the-modelalgorithm.html#cb65-64" aria-hidden="true"></a>    assertthat<span class="op">::</span><span class="kw">assert_that</span>(<span class="kw">all</span>((seed <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sapply</span>(., class)) <span class="op">==</span><span class="st"> "integer"</span>))</span>
<span id="cb65-65"><a href="building-the-modelalgorithm.html#cb65-65" aria-hidden="true"></a>    assertthat<span class="op">::</span><span class="kw">assert_that</span>(<span class="kw">length</span>(seed) <span class="op">==</span><span class="st"> </span><span class="dv">7</span>)</span>
<span id="cb65-66"><a href="building-the-modelalgorithm.html#cb65-66" aria-hidden="true"></a>  }</span>
<span id="cb65-67"><a href="building-the-modelalgorithm.html#cb65-67" aria-hidden="true"></a></span>
<span id="cb65-68"><a href="building-the-modelalgorithm.html#cb65-68" aria-hidden="true"></a>  <span class="co">## Setup for EM algorithm</span></span>
<span id="cb65-69"><a href="building-the-modelalgorithm.html#cb65-69" aria-hidden="true"></a>  TT =<span class="st"> </span><span class="kw">length</span>(ylist)</span>
<span id="cb65-70"><a href="building-the-modelalgorithm.html#cb65-70" aria-hidden="true"></a>  dimdat =<span class="st"> </span><span class="kw">ncol</span>(ylist[[<span class="dv">1</span>]])</span>
<span id="cb65-71"><a href="building-the-modelalgorithm.html#cb65-71" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="kw">is.null</span>(x)) x &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span>TT</span>
<span id="cb65-72"><a href="building-the-modelalgorithm.html#cb65-72" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="kw">is.unsorted</span>(x)) <span class="kw">stop</span>(<span class="st">"x must be ordered!"</span>)</span>
<span id="cb65-73"><a href="building-the-modelalgorithm.html#cb65-73" aria-hidden="true"></a></span>
<span id="cb65-74"><a href="building-the-modelalgorithm.html#cb65-74" aria-hidden="true"></a>  <span class="co"># l = 2 is quadratic trend filtering</span></span>
<span id="cb65-75"><a href="building-the-modelalgorithm.html#cb65-75" aria-hidden="true"></a>  <span class="co"># l = 1 is linear trend filtering</span></span>
<span id="cb65-76"><a href="building-the-modelalgorithm.html#cb65-76" aria-hidden="true"></a>  <span class="co"># l = 0 is fused lasso</span></span>
<span id="cb65-77"><a href="building-the-modelalgorithm.html#cb65-77" aria-hidden="true"></a>  <span class="co"># D^{(1)} is first differences, so it correponds to l=0</span></span>
<span id="cb65-78"><a href="building-the-modelalgorithm.html#cb65-78" aria-hidden="true"></a>  Dlp1 =<span class="st"> </span><span class="kw">gen_diff_mat</span>(<span class="dt">n =</span> TT, <span class="dt">l =</span> l<span class="op">+</span><span class="dv">1</span>, <span class="dt">x =</span> x)</span>
<span id="cb65-79"><a href="building-the-modelalgorithm.html#cb65-79" aria-hidden="true"></a>  <span class="cf">if</span>(l <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>){</span>
<span id="cb65-80"><a href="building-the-modelalgorithm.html#cb65-80" aria-hidden="true"></a>    facmat =<span class="st"> </span><span class="kw">diag</span>(l <span class="op">/</span><span class="st"> </span><span class="kw">diff</span>(x, <span class="dt">lag =</span> l))</span>
<span id="cb65-81"><a href="building-the-modelalgorithm.html#cb65-81" aria-hidden="true"></a>  } <span class="cf">else</span> {</span>
<span id="cb65-82"><a href="building-the-modelalgorithm.html#cb65-82" aria-hidden="true"></a>    facmat =<span class="st"> </span><span class="kw">diag</span>(<span class="kw">rep</span>(<span class="dv">1</span>, TT<span class="op">-</span>l))</span>
<span id="cb65-83"><a href="building-the-modelalgorithm.html#cb65-83" aria-hidden="true"></a>  }</span>
<span id="cb65-84"><a href="building-the-modelalgorithm.html#cb65-84" aria-hidden="true"></a>  Dl =<span class="st"> </span>facmat <span class="op">%*%</span><span class="st"> </span><span class="kw">gen_diff_mat</span>(<span class="dt">n =</span> TT, <span class="dt">l =</span> l, <span class="dt">x =</span> x)</span>
<span id="cb65-85"><a href="building-the-modelalgorithm.html#cb65-85" aria-hidden="true"></a>  tDl =<span class="st"> </span><span class="kw">t</span>(Dl)</span>
<span id="cb65-86"><a href="building-the-modelalgorithm.html#cb65-86" aria-hidden="true"></a></span>
<span id="cb65-87"><a href="building-the-modelalgorithm.html#cb65-87" aria-hidden="true"></a>  Dlsqrd &lt;-<span class="st"> </span><span class="kw">t</span>(Dl) <span class="op">%*%</span><span class="st"> </span>Dl</span>
<span id="cb65-88"><a href="building-the-modelalgorithm.html#cb65-88" aria-hidden="true"></a>  e_mat &lt;-<span class="st"> </span><span class="kw">etilde_mat</span>(<span class="dt">TT =</span> TT) <span class="co"># needed to generate B</span></span>
<span id="cb65-89"><a href="building-the-modelalgorithm.html#cb65-89" aria-hidden="true"></a>  Dlp1_prob =<span class="st"> </span><span class="kw">gen_diff_mat</span>(<span class="dt">n =</span> TT, <span class="dt">l =</span> l_prob<span class="op">+</span><span class="dv">1</span>, <span class="dt">x =</span> x)</span>
<span id="cb65-90"><a href="building-the-modelalgorithm.html#cb65-90" aria-hidden="true"></a>  H_tf &lt;-<span class="st"> </span><span class="kw">gen_tf_mat</span>(<span class="dt">n =</span> TT, <span class="dt">k =</span> l_prob, <span class="dt">x =</span> x)</span>
<span id="cb65-91"><a href="building-the-modelalgorithm.html#cb65-91" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="kw">is.null</span>(mn)){</span>
<span id="cb65-92"><a href="building-the-modelalgorithm.html#cb65-92" aria-hidden="true"></a>    mn =<span class="st"> </span><span class="kw">init_mn</span>(ylist, numclust, TT, dimdat,</span>
<span id="cb65-93"><a href="building-the-modelalgorithm.html#cb65-93" aria-hidden="true"></a>                 <span class="dt">countslist =</span> countslist, <span class="dt">seed =</span> seed)</span>
<span id="cb65-94"><a href="building-the-modelalgorithm.html#cb65-94" aria-hidden="true"></a>  }</span>
<span id="cb65-95"><a href="building-the-modelalgorithm.html#cb65-95" aria-hidden="true"></a>  ntlist =<span class="st"> </span><span class="kw">sapply</span>(ylist, nrow)</span>
<span id="cb65-96"><a href="building-the-modelalgorithm.html#cb65-96" aria-hidden="true"></a>  N =<span class="st"> </span><span class="kw">sum</span>(ntlist)</span>
<span id="cb65-97"><a href="building-the-modelalgorithm.html#cb65-97" aria-hidden="true"></a></span>
<span id="cb65-98"><a href="building-the-modelalgorithm.html#cb65-98" aria-hidden="true"></a>  <span class="co">## Initialize some objects</span></span>
<span id="cb65-99"><a href="building-the-modelalgorithm.html#cb65-99" aria-hidden="true"></a>  prob =<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span><span class="op">/</span>numclust, <span class="dt">nrow =</span> TT, <span class="dt">ncol =</span> numclust) <span class="co">## Initialize to all 1/K.</span></span>
<span id="cb65-100"><a href="building-the-modelalgorithm.html#cb65-100" aria-hidden="true"></a>  denslist_by_clust &lt;-<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb65-101"><a href="building-the-modelalgorithm.html#cb65-101" aria-hidden="true"></a>  objectives =<span class="st"> </span><span class="kw">c</span>(<span class="op">+</span><span class="fl">1E20</span>, <span class="kw">rep</span>(<span class="ot">NA</span>, niter<span class="dv">-1</span>))</span>
<span id="cb65-102"><a href="building-the-modelalgorithm.html#cb65-102" aria-hidden="true"></a>  sigma_fac &lt;-<span class="st"> </span><span class="kw">diff</span>(<span class="kw">range</span>(<span class="kw">do.call</span>(rbind, ylist)))<span class="op">/</span><span class="dv">8</span></span>
<span id="cb65-103"><a href="building-the-modelalgorithm.html#cb65-103" aria-hidden="true"></a>  sigma =<span class="st"> </span><span class="kw">init_sigma</span>(ylist, numclust, sigma_fac) <span class="co">## (T x numclust x (dimdat x dimdat))</span></span>
<span id="cb65-104"><a href="building-the-modelalgorithm.html#cb65-104" aria-hidden="true"></a>  sigma_eig_by_clust =<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb65-105"><a href="building-the-modelalgorithm.html#cb65-105" aria-hidden="true"></a>  zero.betas =<span class="st"> </span>zero.alphas =<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb65-106"><a href="building-the-modelalgorithm.html#cb65-106" aria-hidden="true"></a></span>
<span id="cb65-107"><a href="building-the-modelalgorithm.html#cb65-107" aria-hidden="true"></a>  <span class="co">## The least elegant solution I can think of.. used only for blocked cv</span></span>
<span id="cb65-108"><a href="building-the-modelalgorithm.html#cb65-108" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(countslist_overwrite)) countslist =<span class="st"> </span>countslist_overwrite</span>
<span id="cb65-109"><a href="building-the-modelalgorithm.html#cb65-109" aria-hidden="true"></a>  <span class="co">#if(!is.null(countslist)) check_trim(ylist, countslist)</span></span>
<span id="cb65-110"><a href="building-the-modelalgorithm.html#cb65-110" aria-hidden="true"></a></span>
<span id="cb65-111"><a href="building-the-modelalgorithm.html#cb65-111" aria-hidden="true"></a>  vals &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="dt">length =</span> niter)</span>
<span id="cb65-112"><a href="building-the-modelalgorithm.html#cb65-112" aria-hidden="true"></a>  latest_rho =<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb65-113"><a href="building-the-modelalgorithm.html#cb65-113" aria-hidden="true"></a>  start.time =<span class="st"> </span><span class="kw">Sys.time</span>()</span>
<span id="cb65-114"><a href="building-the-modelalgorithm.html#cb65-114" aria-hidden="true"></a>  <span class="cf">for</span>(iter <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span>niter){</span>
<span id="cb65-115"><a href="building-the-modelalgorithm.html#cb65-115" aria-hidden="true"></a>    <span class="cf">if</span>(verbose){</span>
<span id="cb65-116"><a href="building-the-modelalgorithm.html#cb65-116" aria-hidden="true"></a>      <span class="kw">print_progress</span>(iter<span class="dv">-1</span>, niter<span class="dv">-1</span>, <span class="st">"EM iterations."</span>, <span class="dt">start.time =</span> start.time, <span class="dt">fill =</span> <span class="ot">FALSE</span>)</span>
<span id="cb65-117"><a href="building-the-modelalgorithm.html#cb65-117" aria-hidden="true"></a>    }</span>
<span id="cb65-118"><a href="building-the-modelalgorithm.html#cb65-118" aria-hidden="true"></a>    resp &lt;-<span class="st"> </span><span class="kw">Estep</span>(mn, sigma, prob, <span class="dt">ylist =</span> ylist, <span class="dt">numclust =</span> numclust,</span>
<span id="cb65-119"><a href="building-the-modelalgorithm.html#cb65-119" aria-hidden="true"></a>                  <span class="dt">denslist_by_clust =</span> denslist_by_clust,</span>
<span id="cb65-120"><a href="building-the-modelalgorithm.html#cb65-120" aria-hidden="true"></a>                  <span class="dt">first_iter =</span> (iter <span class="op">==</span><span class="st"> </span><span class="dv">2</span>), <span class="dt">countslist =</span> countslist)</span>
<span id="cb65-121"><a href="building-the-modelalgorithm.html#cb65-121" aria-hidden="true"></a></span>
<span id="cb65-122"><a href="building-the-modelalgorithm.html#cb65-122" aria-hidden="true"></a>    <span class="co">## M step (three parts)</span></span>
<span id="cb65-123"><a href="building-the-modelalgorithm.html#cb65-123" aria-hidden="true"></a></span>
<span id="cb65-124"><a href="building-the-modelalgorithm.html#cb65-124" aria-hidden="true"></a>    <span class="co">## 1. Means</span></span>
<span id="cb65-125"><a href="building-the-modelalgorithm.html#cb65-125" aria-hidden="true"></a>    res_mu =<span class="st"> </span><span class="kw">Mstep_mu</span>(resp, ylist,</span>
<span id="cb65-126"><a href="building-the-modelalgorithm.html#cb65-126" aria-hidden="true"></a>                      <span class="dt">lambda =</span> lambda,</span>
<span id="cb65-127"><a href="building-the-modelalgorithm.html#cb65-127" aria-hidden="true"></a>                      <span class="dt">first_iter =</span> (iter <span class="op">==</span><span class="st"> </span><span class="dv">2</span>),</span>
<span id="cb65-128"><a href="building-the-modelalgorithm.html#cb65-128" aria-hidden="true"></a>                      <span class="dt">l =</span> l, <span class="dt">Dlp1 =</span> Dlp1, <span class="dt">Dl =</span> Dl,</span>
<span id="cb65-129"><a href="building-the-modelalgorithm.html#cb65-129" aria-hidden="true"></a>                      <span class="dt">tDl =</span> tDl,</span>
<span id="cb65-130"><a href="building-the-modelalgorithm.html#cb65-130" aria-hidden="true"></a>                      <span class="dt">Dlsqrd =</span> Dlsqrd,</span>
<span id="cb65-131"><a href="building-the-modelalgorithm.html#cb65-131" aria-hidden="true"></a>                      <span class="dt">sigma_eig_by_clust =</span> sigma_eig_by_clust,</span>
<span id="cb65-132"><a href="building-the-modelalgorithm.html#cb65-132" aria-hidden="true"></a>                      <span class="dt">sigma =</span> sigma, <span class="dt">maxdev =</span> maxdev,</span>
<span id="cb65-133"><a href="building-the-modelalgorithm.html#cb65-133" aria-hidden="true"></a>                      <span class="dt">e_mat =</span> e_mat,</span>
<span id="cb65-134"><a href="building-the-modelalgorithm.html#cb65-134" aria-hidden="true"></a>                      <span class="dt">Zs =</span> <span class="ot">NULL</span>,</span>
<span id="cb65-135"><a href="building-the-modelalgorithm.html#cb65-135" aria-hidden="true"></a>                      <span class="dt">Ws =</span> <span class="ot">NULL</span>,</span>
<span id="cb65-136"><a href="building-the-modelalgorithm.html#cb65-136" aria-hidden="true"></a>                      <span class="dt">uws =</span> <span class="ot">NULL</span>,</span>
<span id="cb65-137"><a href="building-the-modelalgorithm.html#cb65-137" aria-hidden="true"></a>                      <span class="dt">uzs =</span>  <span class="ot">NULL</span>,</span>
<span id="cb65-138"><a href="building-the-modelalgorithm.html#cb65-138" aria-hidden="true"></a>                      <span class="dt">x =</span> x,</span>
<span id="cb65-139"><a href="building-the-modelalgorithm.html#cb65-139" aria-hidden="true"></a>                      <span class="dt">err_rel =</span> admm_err_rel,</span>
<span id="cb65-140"><a href="building-the-modelalgorithm.html#cb65-140" aria-hidden="true"></a>                      <span class="dt">err_abs =</span> admm_err_abs,</span>
<span id="cb65-141"><a href="building-the-modelalgorithm.html#cb65-141" aria-hidden="true"></a>                      <span class="dt">local_adapt =</span> admm_local_adapt,</span>
<span id="cb65-142"><a href="building-the-modelalgorithm.html#cb65-142" aria-hidden="true"></a>                      <span class="dt">local_adapt_niter =</span> admm_local_adapt_niter,</span>
<span id="cb65-143"><a href="building-the-modelalgorithm.html#cb65-143" aria-hidden="true"></a>                      <span class="dt">rho_init =</span> rho_init,</span>
<span id="cb65-144"><a href="building-the-modelalgorithm.html#cb65-144" aria-hidden="true"></a>                      <span class="dt">iter =</span> iter)</span>
<span id="cb65-145"><a href="building-the-modelalgorithm.html#cb65-145" aria-hidden="true"></a>                      <span class="co">## rho_init = (if(iter == 2) rho_init else latest_rho))</span></span>
<span id="cb65-146"><a href="building-the-modelalgorithm.html#cb65-146" aria-hidden="true"></a>    <span class="co">## latest_rho = res_mu$rho</span></span>
<span id="cb65-147"><a href="building-the-modelalgorithm.html#cb65-147" aria-hidden="true"></a>    mn =<span class="st"> </span>res_mu<span class="op">$</span>mns</span>
<span id="cb65-148"><a href="building-the-modelalgorithm.html#cb65-148" aria-hidden="true"></a></span>
<span id="cb65-149"><a href="building-the-modelalgorithm.html#cb65-149" aria-hidden="true"></a>    <span class="co">## 2. Sigma</span></span>
<span id="cb65-150"><a href="building-the-modelalgorithm.html#cb65-150" aria-hidden="true"></a>    sigma =<span class="st"> </span><span class="kw">Mstep_sigma</span>(resp, ylist, mn, numclust)</span>
<span id="cb65-151"><a href="building-the-modelalgorithm.html#cb65-151" aria-hidden="true"></a></span>
<span id="cb65-152"><a href="building-the-modelalgorithm.html#cb65-152" aria-hidden="true"></a>    <span class="co">## 3. Probabilities</span></span>
<span id="cb65-153"><a href="building-the-modelalgorithm.html#cb65-153" aria-hidden="true"></a>    prob_link =<span class="st"> </span><span class="kw">Mstep_prob</span>(resp, <span class="dt">countslist =</span> countslist, <span class="dt">H_tf =</span> H_tf,</span>
<span id="cb65-154"><a href="building-the-modelalgorithm.html#cb65-154" aria-hidden="true"></a>                           <span class="dt">lambda_prob =</span> lambda_prob, <span class="dt">l_prob =</span> l_prob, <span class="dt">x =</span> x)</span>
<span id="cb65-155"><a href="building-the-modelalgorithm.html#cb65-155" aria-hidden="true"></a>    prob =<span class="st"> </span><span class="kw">softmax</span>(prob_link)</span>
<span id="cb65-156"><a href="building-the-modelalgorithm.html#cb65-156" aria-hidden="true"></a></span>
<span id="cb65-157"><a href="building-the-modelalgorithm.html#cb65-157" aria-hidden="true"></a>    objectives[iter] =<span class="st"> </span><span class="kw">objective</span>(<span class="dt">ylist =</span> ylist, <span class="dt">mu =</span> mn, <span class="dt">sigma =</span> sigma, <span class="dt">prob =</span> prob, <span class="dt">prob_link =</span> prob_link,</span>
<span id="cb65-158"><a href="building-the-modelalgorithm.html#cb65-158" aria-hidden="true"></a>                                 <span class="dt">lambda =</span> lambda, <span class="dt">Dlp1 =</span> Dlp1, <span class="dt">l =</span> l, <span class="dt">countslist =</span> countslist,</span>
<span id="cb65-159"><a href="building-the-modelalgorithm.html#cb65-159" aria-hidden="true"></a>                                 <span class="dt">Dlp1_prob =</span> Dlp1_prob,</span>
<span id="cb65-160"><a href="building-the-modelalgorithm.html#cb65-160" aria-hidden="true"></a>                                 <span class="dt">l_prob =</span> l_prob,</span>
<span id="cb65-161"><a href="building-the-modelalgorithm.html#cb65-161" aria-hidden="true"></a>                                 <span class="dt">lambda_prob =</span> lambda_prob)</span>
<span id="cb65-162"><a href="building-the-modelalgorithm.html#cb65-162" aria-hidden="true"></a></span>
<span id="cb65-163"><a href="building-the-modelalgorithm.html#cb65-163" aria-hidden="true"></a>    <span class="co">## Check convergence</span></span>
<span id="cb65-164"><a href="building-the-modelalgorithm.html#cb65-164" aria-hidden="true"></a>    <span class="cf">if</span>(iter <span class="op">&gt;</span><span class="st"> </span><span class="dv">10</span>){ </span>
<span id="cb65-165"><a href="building-the-modelalgorithm.html#cb65-165" aria-hidden="true"></a>      <span class="cf">if</span>(check_convergence <span class="op">&amp;</span></span>
<span id="cb65-166"><a href="building-the-modelalgorithm.html#cb65-166" aria-hidden="true"></a><span class="st">         </span><span class="kw">check_converge_rel</span>(objectives[iter<span class="dv">-1</span>], objectives[iter], <span class="dt">tol =</span> tol_em) <span class="op">&amp;</span></span>
<span id="cb65-167"><a href="building-the-modelalgorithm.html#cb65-167" aria-hidden="true"></a><span class="st">         </span><span class="kw">check_converge_rel</span>(objectives[iter<span class="dv">-2</span>], objectives[iter<span class="dv">-1</span>], <span class="dt">tol =</span> tol_em)<span class="op">&amp;</span></span>
<span id="cb65-168"><a href="building-the-modelalgorithm.html#cb65-168" aria-hidden="true"></a><span class="st">         </span><span class="kw">check_converge_rel</span>(objectives[iter<span class="dv">-3</span>], objectives[iter<span class="dv">-2</span>], <span class="dt">tol =</span> tol_em)){</span>
<span id="cb65-169"><a href="building-the-modelalgorithm.html#cb65-169" aria-hidden="true"></a>         <span class="co">## check_converge_rel(objectives[iter-4], objectives[iter-3], tol = tol_em)){</span></span>
<span id="cb65-170"><a href="building-the-modelalgorithm.html#cb65-170" aria-hidden="true"></a>        <span class="cf">break</span></span>
<span id="cb65-171"><a href="building-the-modelalgorithm.html#cb65-171" aria-hidden="true"></a>      }</span>
<span id="cb65-172"><a href="building-the-modelalgorithm.html#cb65-172" aria-hidden="true"></a>    }</span>
<span id="cb65-173"><a href="building-the-modelalgorithm.html#cb65-173" aria-hidden="true"></a>  }</span>
<span id="cb65-174"><a href="building-the-modelalgorithm.html#cb65-174" aria-hidden="true"></a></span>
<span id="cb65-175"><a href="building-the-modelalgorithm.html#cb65-175" aria-hidden="true"></a>  <span class="kw">return</span>(<span class="kw">structure</span>(<span class="kw">list</span>(<span class="dt">mn =</span> mn,</span>
<span id="cb65-176"><a href="building-the-modelalgorithm.html#cb65-176" aria-hidden="true"></a>                        <span class="dt">prob =</span> prob,</span>
<span id="cb65-177"><a href="building-the-modelalgorithm.html#cb65-177" aria-hidden="true"></a>                        <span class="dt">prob_link =</span> prob_link,</span>
<span id="cb65-178"><a href="building-the-modelalgorithm.html#cb65-178" aria-hidden="true"></a>                        <span class="dt">sigma =</span> sigma,</span>
<span id="cb65-179"><a href="building-the-modelalgorithm.html#cb65-179" aria-hidden="true"></a>                        <span class="dt">objectives =</span> objectives[<span class="dv">2</span><span class="op">:</span>iter],</span>
<span id="cb65-180"><a href="building-the-modelalgorithm.html#cb65-180" aria-hidden="true"></a>                        <span class="dt">final.iter =</span> iter,</span>
<span id="cb65-181"><a href="building-the-modelalgorithm.html#cb65-181" aria-hidden="true"></a>                        <span class="dt">resp =</span> resp,</span>
<span id="cb65-182"><a href="building-the-modelalgorithm.html#cb65-182" aria-hidden="true"></a>                        <span class="co">## Above is output, below are data/algorithm settings.</span></span>
<span id="cb65-183"><a href="building-the-modelalgorithm.html#cb65-183" aria-hidden="true"></a>                        <span class="dt">dimdat =</span> dimdat,</span>
<span id="cb65-184"><a href="building-the-modelalgorithm.html#cb65-184" aria-hidden="true"></a>                        <span class="dt">TT =</span> TT,</span>
<span id="cb65-185"><a href="building-the-modelalgorithm.html#cb65-185" aria-hidden="true"></a>                        <span class="dt">N =</span> N,</span>
<span id="cb65-186"><a href="building-the-modelalgorithm.html#cb65-186" aria-hidden="true"></a>                        <span class="dt">l =</span> l,</span>
<span id="cb65-187"><a href="building-the-modelalgorithm.html#cb65-187" aria-hidden="true"></a>                        <span class="dt">l_prob =</span> l_prob,</span>
<span id="cb65-188"><a href="building-the-modelalgorithm.html#cb65-188" aria-hidden="true"></a>                        <span class="dt">x =</span> x,</span>
<span id="cb65-189"><a href="building-the-modelalgorithm.html#cb65-189" aria-hidden="true"></a>                        <span class="dt">numclust =</span> numclust,</span>
<span id="cb65-190"><a href="building-the-modelalgorithm.html#cb65-190" aria-hidden="true"></a>                        <span class="dt">lambda =</span> lambda,</span>
<span id="cb65-191"><a href="building-the-modelalgorithm.html#cb65-191" aria-hidden="true"></a>                        <span class="dt">lambda_prob =</span> lambda_prob,</span>
<span id="cb65-192"><a href="building-the-modelalgorithm.html#cb65-192" aria-hidden="true"></a>                        <span class="dt">maxdev =</span> maxdev,</span>
<span id="cb65-193"><a href="building-the-modelalgorithm.html#cb65-193" aria-hidden="true"></a>                        <span class="dt">niter =</span> niter</span>
<span id="cb65-194"><a href="building-the-modelalgorithm.html#cb65-194" aria-hidden="true"></a>  ), <span class="dt">class =</span> <span class="st">"flowtrend"</span>))</span>
<span id="cb65-195"><a href="building-the-modelalgorithm.html#cb65-195" aria-hidden="true"></a>}</span></code></pre></div>
<p>Next, <code>flowtrend()</code> is the main user-facing function.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="building-the-modelalgorithm.html#cb66-1" aria-hidden="true"></a><span class="co">#' Main function. Repeats the EM algorithm (\code{flowtrend_once()}) with |nrep| restarts (5 by default).</span></span>
<span id="cb66-2"><a href="building-the-modelalgorithm.html#cb66-2" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb66-3"><a href="building-the-modelalgorithm.html#cb66-3" aria-hidden="true"></a><span class="co">#' @param ... : arguments for \code{flowtrend_once()}</span></span>
<span id="cb66-4"><a href="building-the-modelalgorithm.html#cb66-4" aria-hidden="true"></a><span class="co">#' @param nrestart : number of random restarts</span></span>
<span id="cb66-5"><a href="building-the-modelalgorithm.html#cb66-5" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb66-6"><a href="building-the-modelalgorithm.html#cb66-6" aria-hidden="true"></a><span class="co">#' @return</span></span>
<span id="cb66-7"><a href="building-the-modelalgorithm.html#cb66-7" aria-hidden="true"></a><span class="co">#' @export</span></span>
<span id="cb66-8"><a href="building-the-modelalgorithm.html#cb66-8" aria-hidden="true"></a><span class="co">#'</span></span>
<span id="cb66-9"><a href="building-the-modelalgorithm.html#cb66-9" aria-hidden="true"></a><span class="co">#' @examples</span></span>
<span id="cb66-10"><a href="building-the-modelalgorithm.html#cb66-10" aria-hidden="true"></a>flowtrend &lt;-<span class="st"> </span><span class="cf">function</span>(..., <span class="dt">nrestart =</span> <span class="dv">5</span>){</span>
<span id="cb66-11"><a href="building-the-modelalgorithm.html#cb66-11" aria-hidden="true"></a></span>
<span id="cb66-12"><a href="building-the-modelalgorithm.html#cb66-12" aria-hidden="true"></a>  args =<span class="st"> </span><span class="kw">list</span>(...)</span>
<span id="cb66-13"><a href="building-the-modelalgorithm.html#cb66-13" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="st">"verbose"</span> <span class="op">%in%</span><span class="st"> </span><span class="kw">names</span>(args)){</span>
<span id="cb66-14"><a href="building-the-modelalgorithm.html#cb66-14" aria-hidden="true"></a>    <span class="cf">if</span>(args<span class="op">$</span>verbose){</span>
<span id="cb66-15"><a href="building-the-modelalgorithm.html#cb66-15" aria-hidden="true"></a>      <span class="kw">cat</span>(<span class="st">"EM will restart"</span>, nrestart, <span class="st">"times"</span>, <span class="dt">fill=</span><span class="ot">TRUE</span>)</span>
<span id="cb66-16"><a href="building-the-modelalgorithm.html#cb66-16" aria-hidden="true"></a>    }</span>
<span id="cb66-17"><a href="building-the-modelalgorithm.html#cb66-17" aria-hidden="true"></a>  }</span>
<span id="cb66-18"><a href="building-the-modelalgorithm.html#cb66-18" aria-hidden="true"></a></span>
<span id="cb66-19"><a href="building-the-modelalgorithm.html#cb66-19" aria-hidden="true"></a>  out_models &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>nrestart, <span class="dt">FUN =</span> <span class="cf">function</span>(irestart){</span>
<span id="cb66-20"><a href="building-the-modelalgorithm.html#cb66-20" aria-hidden="true"></a>    <span class="cf">if</span>(<span class="st">"verbose"</span> <span class="op">%in%</span><span class="st"> </span><span class="kw">names</span>(args)){</span>
<span id="cb66-21"><a href="building-the-modelalgorithm.html#cb66-21" aria-hidden="true"></a>      <span class="cf">if</span>(args<span class="op">$</span>verbose){</span>
<span id="cb66-22"><a href="building-the-modelalgorithm.html#cb66-22" aria-hidden="true"></a>        <span class="kw">cat</span>(<span class="st">"EM restart:"</span>, irestart, <span class="dt">fill=</span><span class="ot">TRUE</span>) </span>
<span id="cb66-23"><a href="building-the-modelalgorithm.html#cb66-23" aria-hidden="true"></a>      }</span>
<span id="cb66-24"><a href="building-the-modelalgorithm.html#cb66-24" aria-hidden="true"></a>    }</span>
<span id="cb66-25"><a href="building-the-modelalgorithm.html#cb66-25" aria-hidden="true"></a>    model_temp &lt;-<span class="st"> </span><span class="kw">flowtrend_once</span>(...)</span>
<span id="cb66-26"><a href="building-the-modelalgorithm.html#cb66-26" aria-hidden="true"></a>    model_obj &lt;-<span class="st"> </span><span class="kw">tail</span>(model_temp<span class="op">$</span>objectives, <span class="dt">n =</span> <span class="dv">1</span>)</span>
<span id="cb66-27"><a href="building-the-modelalgorithm.html#cb66-27" aria-hidden="true"></a>    <span class="cf">if</span>(<span class="st">"verbose"</span> <span class="op">%in%</span><span class="st"> </span><span class="kw">names</span>(args)){</span>
<span id="cb66-28"><a href="building-the-modelalgorithm.html#cb66-28" aria-hidden="true"></a>      <span class="cf">if</span>(args<span class="op">$</span>verbose){</span>
<span id="cb66-29"><a href="building-the-modelalgorithm.html#cb66-29" aria-hidden="true"></a>        <span class="kw">cat</span>(<span class="dt">fill=</span><span class="ot">TRUE</span>) </span>
<span id="cb66-30"><a href="building-the-modelalgorithm.html#cb66-30" aria-hidden="true"></a>      }</span>
<span id="cb66-31"><a href="building-the-modelalgorithm.html#cb66-31" aria-hidden="true"></a>    }</span>
<span id="cb66-32"><a href="building-the-modelalgorithm.html#cb66-32" aria-hidden="true"></a>    <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">model =</span> model_temp, <span class="dt">final_objective =</span> model_obj))</span>
<span id="cb66-33"><a href="building-the-modelalgorithm.html#cb66-33" aria-hidden="true"></a>  })</span>
<span id="cb66-34"><a href="building-the-modelalgorithm.html#cb66-34" aria-hidden="true"></a>  final_objectives &lt;-<span class="st"> </span><span class="kw">sapply</span>(out_models, <span class="dt">FUN =</span> <span class="cf">function</span>(x) x<span class="op">$</span>final_objective)</span>
<span id="cb66-35"><a href="building-the-modelalgorithm.html#cb66-35" aria-hidden="true"></a>  best_model &lt;-<span class="st"> </span><span class="kw">which.min</span>(final_objectives)</span>
<span id="cb66-36"><a href="building-the-modelalgorithm.html#cb66-36" aria-hidden="true"></a>  final_model =<span class="st"> </span>out_models[[best_model]][[<span class="st">"model"</span>]]</span>
<span id="cb66-37"><a href="building-the-modelalgorithm.html#cb66-37" aria-hidden="true"></a></span>
<span id="cb66-38"><a href="building-the-modelalgorithm.html#cb66-38" aria-hidden="true"></a>  <span class="co">## Add the objectives</span></span>
<span id="cb66-39"><a href="building-the-modelalgorithm.html#cb66-39" aria-hidden="true"></a>  final_model<span class="op">$</span>all_objectives =</span>
<span id="cb66-40"><a href="building-the-modelalgorithm.html#cb66-40" aria-hidden="true"></a><span class="st">    </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>nrestart, <span class="cf">function</span>(irestart){</span>
<span id="cb66-41"><a href="building-the-modelalgorithm.html#cb66-41" aria-hidden="true"></a>        one_model =<span class="st"> </span>out_models[[irestart]]</span>
<span id="cb66-42"><a href="building-the-modelalgorithm.html#cb66-42" aria-hidden="true"></a>        <span class="kw">data.frame</span>(<span class="dt">objective=</span>one_model<span class="op">$</span>model<span class="op">$</span>objectives) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">iter=</span><span class="kw">row_number</span>(), <span class="dt">irestart=</span>irestart) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(irestart, iter, objective)</span>
<span id="cb66-43"><a href="building-the-modelalgorithm.html#cb66-43" aria-hidden="true"></a>    }) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">bind_rows</span>()</span>
<span id="cb66-44"><a href="building-the-modelalgorithm.html#cb66-44" aria-hidden="true"></a>  <span class="kw">return</span>(final_model)</span>
<span id="cb66-45"><a href="building-the-modelalgorithm.html#cb66-45" aria-hidden="true"></a>}</span></code></pre></div>

</div>
</div>
            </section>
</div>
        </div>
      </div>
<a href="package-setup.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="reordering-clusters.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script><script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script><script src="libs/gitbook-2.6.7/js/plugin-search.js"></script><script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script><script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script><script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script><script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script><script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script><script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
