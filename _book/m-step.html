<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>9 M step | Creating the flowtrend R package</title>
  <meta name="description" content="9 M step | Creating the flowtrend R package" />
  <meta name="generator" content="bookdown 0.35 and GitBook 2.6.7" />

  <meta property="og:title" content="9 M step | Creating the flowtrend R package" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="9 M step | Creating the flowtrend R package" />
  
  
  

<meta name="author" content="Sangwon Hyun" />


<meta name="date" content="2024-04-09" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="e-step.html"/>
<link rel="next" href="flowtrend.html"/>
<script src="libs/header-attrs-2.25/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="package-setup.html"><a href="package-setup.html"><i class="fa fa-check"></i><b>2</b> Package setup</a>
<ul>
<li class="chapter" data-level="2.1" data-path="package-setup.html"><a href="package-setup.html#plotting-1d-data"><i class="fa fa-check"></i><b>2.1</b> Plotting 1d data</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="d-data.html"><a href="d-data.html"><i class="fa fa-check"></i><b>3</b> 2d data</a>
<ul>
<li class="chapter" data-level="3.1" data-path="d-data.html"><a href="d-data.html#generating-2d-data"><i class="fa fa-check"></i><b>3.1</b> Generating 2d data</a></li>
<li class="chapter" data-level="3.2" data-path="d-data.html"><a href="d-data.html#plotting-2d-data"><i class="fa fa-check"></i><b>3.2</b> Plotting 2d data</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="d-data-1.html"><a href="d-data-1.html"><i class="fa fa-check"></i><b>4</b> 3d data</a></li>
<li class="chapter" data-level="5" data-path="trend-filtering.html"><a href="trend-filtering.html"><i class="fa fa-check"></i><b>5</b> Trend filtering</a></li>
<li class="chapter" data-level="6" data-path="objective-data-log-likelihood.html"><a href="objective-data-log-likelihood.html"><i class="fa fa-check"></i><b>6</b> Objective (data log-likelihood)</a></li>
<li class="chapter" data-level="7" data-path="initial-parameters-for-em-algorithm.html"><a href="initial-parameters-for-em-algorithm.html"><i class="fa fa-check"></i><b>7</b> Initial parameters for EM algorithm</a></li>
<li class="chapter" data-level="8" data-path="e-step.html"><a href="e-step.html"><i class="fa fa-check"></i><b>8</b> E step</a></li>
<li class="chapter" data-level="9" data-path="m-step.html"><a href="m-step.html"><i class="fa fa-check"></i><b>9</b> M step</a>
<ul>
<li class="chapter" data-level="9.1" data-path="m-step.html"><a href="m-step.html#m-step-for-pi"><i class="fa fa-check"></i><b>9.1</b> M step for <span class="math inline">\(\pi\)</span></a></li>
<li class="chapter" data-level="9.2" data-path="m-step.html"><a href="m-step.html#m-step-for-sigma"><i class="fa fa-check"></i><b>9.2</b> M step for <span class="math inline">\(\Sigma\)</span></a></li>
<li class="chapter" data-level="9.3" data-path="m-step.html"><a href="m-step.html#m-step-for-mu"><i class="fa fa-check"></i><b>9.3</b> M step for <span class="math inline">\(\mu\)</span></a></li>
<li class="chapter" data-level="9.4" data-path="m-step.html"><a href="m-step.html#helpers-for-m-step-mu"><i class="fa fa-check"></i><b>9.4</b> Helpers for M step (<span class="math inline">\(\mu\)</span>)</a></li>
<li class="chapter" data-level="9.5" data-path="m-step.html"><a href="m-step.html#all-rcpp-functions"><i class="fa fa-check"></i><b>9.5</b> All Rcpp functions</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="flowtrend.html"><a href="flowtrend.html"><i class="fa fa-check"></i><b>10</b> flowtrend</a></li>
<li class="chapter" data-level="11" data-path="reordering-clusters.html"><a href="reordering-clusters.html"><i class="fa fa-check"></i><b>11</b> Reordering clusters</a></li>
<li class="chapter" data-level="12" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html"><i class="fa fa-check"></i><b>12</b> Tuning the regularization parameters for <code>flowtrend</code></a>
<ul>
<li class="chapter" data-level="12.1" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html#predicting-and-evaluating-on-new-time-points"><i class="fa fa-check"></i><b>12.1</b> Predicting and evaluating on new time points</a></li>
<li class="chapter" data-level="12.2" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html#maximum-lambda_mu-lambda_pi-values-to-test"><i class="fa fa-check"></i><b>12.2</b> Maximum <span class="math inline">\((\lambda_\mu, \lambda_\pi)\)</span> values to test</a></li>
<li class="chapter" data-level="12.3" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html#define-cv-data-folds"><i class="fa fa-check"></i><b>12.3</b> Define CV data folds</a></li>
<li class="chapter" data-level="12.4" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html#cv-many-single-jobs"><i class="fa fa-check"></i><b>12.4</b> CV = many single jobs</a></li>
<li class="chapter" data-level="12.5" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html#running-cross-validation"><i class="fa fa-check"></i><b>12.5</b> Running cross-validation</a></li>
<li class="chapter" data-level="12.6" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html#summarizing-the-output"><i class="fa fa-check"></i><b>12.6</b> Summarizing the output</a></li>
<li class="chapter" data-level="12.7" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html#cv-on-your-own-computer"><i class="fa fa-check"></i><b>12.7</b> CV on your own computer</a></li>
<li class="chapter" data-level="12.8" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html#plotting"><i class="fa fa-check"></i><b>12.8</b> Plotting</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="se-rule-for-cross-validation.html"><a href="se-rule-for-cross-validation.html"><i class="fa fa-check"></i><b>13</b> 1SE rule for cross validation</a></li>
<li class="chapter" data-level="14" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html"><i class="fa fa-check"></i><b>14</b> Testing the flowtrend method</a>
<ul>
<li class="chapter" data-level="14.1" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html#id_1d-example"><i class="fa fa-check"></i><b>14.1</b> 1d example</a></li>
<li class="chapter" data-level="14.2" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html#testing-monotonicity-of-objective-values"><i class="fa fa-check"></i><b>14.2</b> Testing monotonicity of objective values</a></li>
<li class="chapter" data-level="14.3" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html#id_2d-example"><i class="fa fa-check"></i><b>14.3</b> 2d example</a></li>
<li class="chapter" data-level="14.4" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html#working-with-binned-dataset"><i class="fa fa-check"></i><b>14.4</b> Working with “binned” dataset</a></li>
<li class="chapter" data-level="14.5" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html#unevenly-spaced-inputs-x"><i class="fa fa-check"></i><b>14.5</b> Unevenly spaced inputs (x)</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="documenting-the-package-and-building.html"><a href="documenting-the-package-and-building.html"><i class="fa fa-check"></i><b>15</b> Documenting the package and building</a></li>
<li class="chapter" data-level="16" data-path="helpers-for-simulations-in-the-paper.html"><a href="helpers-for-simulations-in-the-paper.html"><i class="fa fa-check"></i><b>16</b> Helpers for simulations in the paper</a>
<ul>
<li class="chapter" data-level="16.1" data-path="helpers-for-simulations-in-the-paper.html"><a href="helpers-for-simulations-in-the-paper.html#two-alternative-estimators"><i class="fa fa-check"></i><b>16.1</b> Two alternative estimators</a></li>
<li class="chapter" data-level="16.2" data-path="helpers-for-simulations-in-the-paper.html"><a href="helpers-for-simulations-in-the-paper.html#example-using-underfit_flowmeans-and-overfit_flowmeans"><i class="fa fa-check"></i><b>16.2</b> Example using <code><a href='helpers-for-simulations-in-the-paper.html#underfit_flowmeans'>underfit_flowmeans</a>()</code> and <code><a href='helpers-for-simulations-in-the-paper.html#overfit_flowmeans'>overfit_flowmeans</a>()</code></a></li>
<li class="chapter" data-level="16.3" data-path="helpers-for-simulations-in-the-paper.html"><a href="helpers-for-simulations-in-the-paper.html#evaluating-performance-soft-rand-index"><i class="fa fa-check"></i><b>16.3</b> Evaluating performance: soft RAND index</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Creating the <code>flowtrend</code> R package</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="m-step" class="section level1 hasAnchor" number="9">
<h1><span class="header-section-number">9</span> M step<a href="m-step.html#m-step" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>The M step of the EM algorithm has three steps – one each for <span class="math inline">\(\mu\)</span>, <span class="math inline">\(\pi\)</span>, and
<span class="math inline">\(\Sigma\)</span>.</p>
<div id="m-step-for-pi" class="section level2 hasAnchor" number="9.1">
<h2><span class="header-section-number">9.1</span> M step for <span class="math inline">\(\pi\)</span><a href="m-step.html#m-step-for-pi" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="m-step.html#cb50-1" tabindex="-1"></a><span class="co">#&#39; The M step for the cluster probabilities</span></span>
<span id="cb50-2"><a href="m-step.html#cb50-2" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb50-3"><a href="m-step.html#cb50-3" tabindex="-1"></a><span class="co">#&#39; @param resp Responsibilities.</span></span>
<span id="cb50-4"><a href="m-step.html#cb50-4" tabindex="-1"></a><span class="co">#&#39; @param H_tf Trend filtering matrix.</span></span>
<span id="cb50-5"><a href="m-step.html#cb50-5" tabindex="-1"></a><span class="co">#&#39; @param countslist Particle multiplicities.</span></span>
<span id="cb50-6"><a href="m-step.html#cb50-6" tabindex="-1"></a><span class="co">#&#39; @param lambda_prob Regularization. </span></span>
<span id="cb50-7"><a href="m-step.html#cb50-7" tabindex="-1"></a><span class="co">#&#39; @param l_prob Trend filtering degree.</span></span>
<span id="cb50-8"><a href="m-step.html#cb50-8" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb50-9"><a href="m-step.html#cb50-9" tabindex="-1"></a><span class="co">#&#39; @return (T x k) matrix containing the alphas, for \code{prob = exp(alpha)/</span></span>
<span id="cb50-10"><a href="m-step.html#cb50-10" tabindex="-1"></a><span class="co">#&#39;         rowSums(exp(alpha))}. </span></span>
<span id="cb50-11"><a href="m-step.html#cb50-11" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb50-12"><a href="m-step.html#cb50-12" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb50-13"><a href="m-step.html#cb50-13" tabindex="-1"></a><span id='Mstep_prob'>Mstep_prob</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(resp, H_tf, <span class="at">countslist =</span> <span class="cn">NULL</span>,</span>
<span id="cb50-14"><a href="m-step.html#cb50-14" tabindex="-1"></a>                       <span class="at">lambda_prob =</span> <span class="cn">NULL</span>, <span class="at">l_prob =</span> <span class="cn">NULL</span>, <span class="at">x =</span> <span class="cn">NULL</span>){</span>
<span id="cb50-15"><a href="m-step.html#cb50-15" tabindex="-1"></a></span>
<span id="cb50-16"><a href="m-step.html#cb50-16" tabindex="-1"></a>  <span class="do">## Basic setup</span></span>
<span id="cb50-17"><a href="m-step.html#cb50-17" tabindex="-1"></a>  TT <span class="ot">&lt;-</span> <span class="fu">length</span>(resp)</span>
<span id="cb50-18"><a href="m-step.html#cb50-18" tabindex="-1"></a></span>
<span id="cb50-19"><a href="m-step.html#cb50-19" tabindex="-1"></a>  <span class="do">## Basic checks</span></span>
<span id="cb50-20"><a href="m-step.html#cb50-20" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.null</span>(l_prob) <span class="sc">==</span> <span class="fu">is.null</span>(lambda_prob))</span>
<span id="cb50-21"><a href="m-step.html#cb50-21" tabindex="-1"></a></span>
<span id="cb50-22"><a href="m-step.html#cb50-22" tabindex="-1"></a>  <span class="do">## If glmnet isn&#39;t actually needed, don&#39;t use it.</span></span>
<span id="cb50-23"><a href="m-step.html#cb50-23" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(l_prob) <span class="sc">&amp;</span> <span class="fu">is.null</span>(lambda_prob)){</span>
<span id="cb50-24"><a href="m-step.html#cb50-24" tabindex="-1"></a></span>
<span id="cb50-25"><a href="m-step.html#cb50-25" tabindex="-1"></a>    <span class="do">## Calculate the average responsibilities, per time point.</span></span>
<span id="cb50-26"><a href="m-step.html#cb50-26" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(countslist)){</span>
<span id="cb50-27"><a href="m-step.html#cb50-27" tabindex="-1"></a>      resp.avg <span class="ot">&lt;-</span> <span class="fu">lapply</span>(resp, colMeans) <span class="sc">%&gt;%</span> <span class="fu">do.call</span>(rbind, .)</span>
<span id="cb50-28"><a href="m-step.html#cb50-28" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb50-29"><a href="m-step.html#cb50-29" tabindex="-1"></a>      resp.avg <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(ii){</span>
<span id="cb50-30"><a href="m-step.html#cb50-30" tabindex="-1"></a>        <span class="fu">colSums</span>(resp[[ii]])<span class="sc">/</span><span class="fu">sum</span>(countslist[[ii]])</span>
<span id="cb50-31"><a href="m-step.html#cb50-31" tabindex="-1"></a>      }) <span class="sc">%&gt;%</span> <span class="fu">do.call</span>(rbind, .)</span>
<span id="cb50-32"><a href="m-step.html#cb50-32" tabindex="-1"></a>    }</span>
<span id="cb50-33"><a href="m-step.html#cb50-33" tabindex="-1"></a>    <span class="fu">return</span>(resp.avg) </span>
<span id="cb50-34"><a href="m-step.html#cb50-34" tabindex="-1"></a></span>
<span id="cb50-35"><a href="m-step.html#cb50-35" tabindex="-1"></a>  <span class="do">## If glmnet is needed, use it.</span></span>
<span id="cb50-36"><a href="m-step.html#cb50-36" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb50-37"><a href="m-step.html#cb50-37" tabindex="-1"></a></span>
<span id="cb50-38"><a href="m-step.html#cb50-38" tabindex="-1"></a>    <span id='lambda_range'>lambda_range</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(lam, <span class="at">nlam =</span> <span class="dv">50</span>, <span class="at">lam.max =</span> <span class="dv">5</span><span class="sc">*</span>lam){</span>
<span id="cb50-39"><a href="m-step.html#cb50-39" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">exp</span>(<span class="fu">seq</span>(<span class="fu">log</span>(lam.max), <span class="fu">log</span>(lam), <span class="at">length.out =</span> nlam)))</span>
<span id="cb50-40"><a href="m-step.html#cb50-40" tabindex="-1"></a>    }</span>
<span id="cb50-41"><a href="m-step.html#cb50-41" tabindex="-1"></a></span>
<span id="cb50-42"><a href="m-step.html#cb50-42" tabindex="-1"></a>    penalty.facs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>, l_prob<span class="sc">+</span><span class="dv">1</span>), <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(H_tf) <span class="sc">-</span> l_prob <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb50-43"><a href="m-step.html#cb50-43" tabindex="-1"></a>    resp.predict <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(resp, colSums))</span>
<span id="cb50-44"><a href="m-step.html#cb50-44" tabindex="-1"></a>    glmnet_obj <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">glmnet</span>(<span class="at">x =</span> H_tf, <span class="at">y =</span> resp.predict, <span class="at">family =</span> <span class="st">&quot;multinomial&quot;</span>,</span>
<span id="cb50-45"><a href="m-step.html#cb50-45" tabindex="-1"></a>                                 <span class="at">penalty.factor =</span> penalty.facs, <span class="at">maxit =</span> <span class="fl">1e7</span>,</span>
<span id="cb50-46"><a href="m-step.html#cb50-46" tabindex="-1"></a>                                 <span class="at">lambda =</span>  <span class="fu">mean</span>(penalty.facs)<span class="sc">*</span><a href='m-step.html#lambda_range'>lambda_range</a>(lambda_prob),</span>
<span id="cb50-47"><a href="m-step.html#cb50-47" tabindex="-1"></a>                                 <span class="at">standardize =</span> F, <span class="at">intercept =</span> <span class="cn">FALSE</span>) </span>
<span id="cb50-48"><a href="m-step.html#cb50-48" tabindex="-1"></a>    pred_link <span class="ot">&lt;-</span> <span class="fu">predict</span>(glmnet_obj, <span class="at">newx =</span> H_tf, <span class="at">type =</span> <span class="st">&quot;link&quot;</span>, <span class="at">s =</span> <span class="fu">mean</span>(penalty.facs) <span class="sc">*</span> lambda_prob)[,,<span class="dv">1</span>]</span>
<span id="cb50-49"><a href="m-step.html#cb50-49" tabindex="-1"></a>    <span class="fu">return</span>(pred_link)</span>
<span id="cb50-50"><a href="m-step.html#cb50-50" tabindex="-1"></a>  }</span>
<span id="cb50-51"><a href="m-step.html#cb50-51" tabindex="-1"></a>}</span></code></pre></div>
<p>This should return a <span class="math inline">\(T\)</span> by <span class="math inline">\(K\)</span> matrix, which we’ll test here:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="m-step.html#cb51-1" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;Mstep of pi returns a (T x K) matrix.&quot;</span>, {</span>
<span id="cb51-2"><a href="m-step.html#cb51-2" tabindex="-1"></a></span>
<span id="cb51-3"><a href="m-step.html#cb51-3" tabindex="-1"></a>  <span class="do">## Generate some fake responsibilities and trend filtering matrix</span></span>
<span id="cb51-4"><a href="m-step.html#cb51-4" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="dv">100</span></span>
<span id="cb51-5"><a href="m-step.html#cb51-5" tabindex="-1"></a>  numclust <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb51-6"><a href="m-step.html#cb51-6" tabindex="-1"></a>  nt <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb51-7"><a href="m-step.html#cb51-7" tabindex="-1"></a>  resp <span class="ot">=</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="cf">function</span>(tt){</span>
<span id="cb51-8"><a href="m-step.html#cb51-8" tabindex="-1"></a>    oneresp <span class="ot">=</span> <span class="fu">runif</span>(nt<span class="sc">*</span>numclust) <span class="sc">%&gt;%</span> <span class="fu">matrix</span>(<span class="at">ncol=</span>numclust)</span>
<span id="cb51-9"><a href="m-step.html#cb51-9" tabindex="-1"></a>    oneresp <span class="ot">=</span> oneresp<span class="sc">/</span><span class="fu">rowSums</span>(oneresp)</span>
<span id="cb51-10"><a href="m-step.html#cb51-10" tabindex="-1"></a>  })</span>
<span id="cb51-11"><a href="m-step.html#cb51-11" tabindex="-1"></a>  H_tf <span class="ot">&lt;-</span> <a href='trend-filtering.html#gen_tf_mat'>gen_tf_mat</a>(<span class="at">n =</span> TT, <span class="at">k =</span> <span class="dv">0</span>)</span>
<span id="cb51-12"><a href="m-step.html#cb51-12" tabindex="-1"></a></span>
<span id="cb51-13"><a href="m-step.html#cb51-13" tabindex="-1"></a>  <span class="do">## Check the size</span></span>
<span id="cb51-14"><a href="m-step.html#cb51-14" tabindex="-1"></a>  pred_link <span class="ot">=</span> <a href='m-step.html#Mstep_prob'>Mstep_prob</a>(resp, H_tf, <span class="at">l_prob =</span> <span class="dv">0</span>, <span class="at">lambda_prob =</span> <span class="fl">1E-3</span>)</span>
<span id="cb51-15"><a href="m-step.html#cb51-15" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">dim</span>(pred_link), <span class="fu">c</span>(TT, numclust))</span>
<span id="cb51-16"><a href="m-step.html#cb51-16" tabindex="-1"></a>  pred_link <span class="ot">=</span> <a href='m-step.html#Mstep_prob'>Mstep_prob</a>(resp, H_tf)</span>
<span id="cb51-17"><a href="m-step.html#cb51-17" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">dim</span>(pred_link), <span class="fu">c</span>(TT, numclust))</span>
<span id="cb51-18"><a href="m-step.html#cb51-18" tabindex="-1"></a></span>
<span id="cb51-19"><a href="m-step.html#cb51-19" tabindex="-1"></a>  <span class="do">## Check the correctness</span></span>
<span id="cb51-20"><a href="m-step.html#cb51-20" tabindex="-1"></a>  pred_link <span class="ot">=</span> <a href='m-step.html#Mstep_prob'>Mstep_prob</a>(resp, H_tf)</span>
<span id="cb51-21"><a href="m-step.html#cb51-21" tabindex="-1"></a>})</span></code></pre></div>
<p>Each row of this matrix should contain the fitted values <span class="math inline">\(\alpha_k \in
\mathbb{R}^3\)</span> where <span class="math inline">\(\alpha_{kt} = h_t^T w_{k}\)</span>, for..</p>
<ul>
<li><p><span class="math inline">\(h_t\)</span> that are rows of the trend filtering matrix <span class="math inline">\(H \in \mathbb{R}^{T \times
T}\)</span>.</p></li>
<li><p><span class="math inline">\(w_k \in \mathbb{R}^{n}\)</span> that are the regression coefficients estimated by
<code>glmnet()</code>.</p></li>
</ul>
<p>Here is a test for the correctness of the M step for <span class="math inline">\(\pi\)</span>.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="m-step.html#cb52-1" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;Test the M step of \pi against CVXR&quot;</span>, {})</span></code></pre></div>
</div>
<div id="m-step-for-sigma" class="section level2 hasAnchor" number="9.2">
<h2><span class="header-section-number">9.2</span> M step for <span class="math inline">\(\Sigma\)</span><a href="m-step.html#m-step-for-sigma" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="m-step.html#cb53-1" tabindex="-1"></a><span class="co">#&#39; M step for cluster covariance (sigma).</span></span>
<span id="cb53-2"><a href="m-step.html#cb53-2" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb53-3"><a href="m-step.html#cb53-3" tabindex="-1"></a><span class="co">#&#39; @param resp Responsibility.</span></span>
<span id="cb53-4"><a href="m-step.html#cb53-4" tabindex="-1"></a><span class="co">#&#39; @param ylist Data.</span></span>
<span id="cb53-5"><a href="m-step.html#cb53-5" tabindex="-1"></a><span class="co">#&#39; @param mn Means</span></span>
<span id="cb53-6"><a href="m-step.html#cb53-6" tabindex="-1"></a><span class="co">#&#39; @param numclust Number of clusters.</span></span>
<span id="cb53-7"><a href="m-step.html#cb53-7" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb53-8"><a href="m-step.html#cb53-8" tabindex="-1"></a><span class="co">#&#39; @return (K x d x d) array containing K (d x d) covariance matrices.</span></span>
<span id="cb53-9"><a href="m-step.html#cb53-9" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb53-10"><a href="m-step.html#cb53-10" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb53-11"><a href="m-step.html#cb53-11" tabindex="-1"></a><span class="co">#&#39; @examples</span></span>
<span id="cb53-12"><a href="m-step.html#cb53-12" tabindex="-1"></a><span id='Mstep_sigma'>Mstep_sigma</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(resp, ylist, mn, numclust){</span>
<span id="cb53-13"><a href="m-step.html#cb53-13" tabindex="-1"></a></span>
<span id="cb53-14"><a href="m-step.html#cb53-14" tabindex="-1"></a>  <span class="do">## Find some sizes</span></span>
<span id="cb53-15"><a href="m-step.html#cb53-15" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="fu">length</span>(ylist)</span>
<span id="cb53-16"><a href="m-step.html#cb53-16" tabindex="-1"></a>  ntlist <span class="ot">=</span> <span class="fu">sapply</span>(ylist, nrow)</span>
<span id="cb53-17"><a href="m-step.html#cb53-17" tabindex="-1"></a>  dimdat <span class="ot">=</span> <span class="fu">ncol</span>(ylist[[<span class="dv">1</span>]])</span>
<span id="cb53-18"><a href="m-step.html#cb53-18" tabindex="-1"></a>  cs <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">cumsum</span>(ntlist))</span>
<span id="cb53-19"><a href="m-step.html#cb53-19" tabindex="-1"></a></span>
<span id="cb53-20"><a href="m-step.html#cb53-20" tabindex="-1"></a>  <span class="do">## Set up empty residual matrix (to be reused)</span></span>
<span id="cb53-21"><a href="m-step.html#cb53-21" tabindex="-1"></a>  cs <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">cumsum</span>(ntlist))</span>
<span id="cb53-22"><a href="m-step.html#cb53-22" tabindex="-1"></a>  vars <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">&quot;list&quot;</span>, numclust)</span>
<span id="cb53-23"><a href="m-step.html#cb53-23" tabindex="-1"></a>  ylong <span class="ot">=</span> <span class="fu">do.call</span>(rbind, ylist)</span>
<span id="cb53-24"><a href="m-step.html#cb53-24" tabindex="-1"></a>  ntlist <span class="ot">=</span> <span class="fu">sapply</span>(ylist, nrow)</span>
<span id="cb53-25"><a href="m-step.html#cb53-25" tabindex="-1"></a>  irows <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(mn), <span class="at">times =</span> ntlist)</span>
<span id="cb53-26"><a href="m-step.html#cb53-26" tabindex="-1"></a></span>
<span id="cb53-27"><a href="m-step.html#cb53-27" tabindex="-1"></a>  <span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>numclust){</span>
<span id="cb53-28"><a href="m-step.html#cb53-28" tabindex="-1"></a>    resp.thisclust <span class="ot">=</span> <span class="fu">lapply</span>(resp, <span class="cf">function</span>(myresp) myresp[,iclust, <span class="at">drop =</span> <span class="cn">TRUE</span>])</span>
<span id="cb53-29"><a href="m-step.html#cb53-29" tabindex="-1"></a>    resp.long <span class="ot">=</span> <span class="fu">do.call</span>(c, resp.thisclust)</span>
<span id="cb53-30"><a href="m-step.html#cb53-30" tabindex="-1"></a>    mnlong <span class="ot">=</span> mn[irows,,iclust]</span>
<span id="cb53-31"><a href="m-step.html#cb53-31" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.vector</span>(mnlong)) mnlong <span class="ot">=</span> mnlong <span class="sc">%&gt;%</span> <span class="fu">cbind</span>()</span>
<span id="cb53-32"><a href="m-step.html#cb53-32" tabindex="-1"></a>    resid <span class="ot">&lt;-</span> ylong <span class="sc">-</span> mnlong</span>
<span id="cb53-33"><a href="m-step.html#cb53-33" tabindex="-1"></a>    resid_weighted <span class="ot">&lt;-</span> resp.long <span class="sc">*</span> resid</span>
<span id="cb53-34"><a href="m-step.html#cb53-34" tabindex="-1"></a>    sig_temp <span class="ot">&lt;-</span> <span class="fu">t</span>(resid_weighted) <span class="sc">%*%</span> resid<span class="sc">/</span><span class="fu">sum</span>(resp.long)</span>
<span id="cb53-35"><a href="m-step.html#cb53-35" tabindex="-1"></a>    vars[[iclust]] <span class="ot">&lt;-</span> sig_temp</span>
<span id="cb53-36"><a href="m-step.html#cb53-36" tabindex="-1"></a>  }</span>
<span id="cb53-37"><a href="m-step.html#cb53-37" tabindex="-1"></a></span>
<span id="cb53-38"><a href="m-step.html#cb53-38" tabindex="-1"></a>  <span class="do">## Make into an array</span></span>
<span id="cb53-39"><a href="m-step.html#cb53-39" tabindex="-1"></a>  sigma_array <span class="ot">=</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(numclust, dimdat, dimdat))</span>
<span id="cb53-40"><a href="m-step.html#cb53-40" tabindex="-1"></a>  <span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>numclust){</span>
<span id="cb53-41"><a href="m-step.html#cb53-41" tabindex="-1"></a>    sigma_array[iclust,,] <span class="ot">=</span> vars[[iclust]]</span>
<span id="cb53-42"><a href="m-step.html#cb53-42" tabindex="-1"></a>  }</span>
<span id="cb53-43"><a href="m-step.html#cb53-43" tabindex="-1"></a></span>
<span id="cb53-44"><a href="m-step.html#cb53-44" tabindex="-1"></a>  <span class="do">## Basic check</span></span>
<span id="cb53-45"><a href="m-step.html#cb53-45" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="fu">dim</span>(sigma_array) <span class="sc">==</span> <span class="fu">c</span>(numclust, dimdat, dimdat)))</span>
<span id="cb53-46"><a href="m-step.html#cb53-46" tabindex="-1"></a>  <span class="fu">return</span>(sigma_array)</span>
<span id="cb53-47"><a href="m-step.html#cb53-47" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="m-step-for-mu" class="section level2 hasAnchor" number="9.3">
<h2><span class="header-section-number">9.3</span> M step for <span class="math inline">\(\mu\)</span><a href="m-step.html#m-step-for-mu" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This is a big one. It uses the ADMM algorithm as written in section OO of the
paper, reproduced briefly here.</p>
<p>We need a convergence checker for the outer layer of LA-ADMM, which checks
whether the objective values have plateaued.</p>
<p>Next, we define the main function <code><a href='m-step.html#Mstep_mu'>Mstep_mu</a>()</code>. This uses a “locally-adaptive” ADMM <a href="https://proceedings.neurips.cc/paper_files/paper/2017/file/e97ee2054defb209c35fe4dc94599061-Paper.pdf">paper</a>. <code>M-step_mu()</code> calls <code><a href='m-step.html#la_admm_oneclust'>la_admm_oneclust</a>()</code> on each cluster <span class="math inline">\(k=1,\cdots, K\)</span>; this function will be introduced shortly.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="m-step.html#cb54-1" tabindex="-1"></a><span class="co">#&#39; Computes the M step for mu. </span><span class="al">TODO</span><span class="co">: use templates for the argument. As shown</span></span>
<span id="cb54-2"><a href="m-step.html#cb54-2" tabindex="-1"></a><span class="co">#&#39; here:</span></span>
<span id="cb54-3"><a href="m-step.html#cb54-3" tabindex="-1"></a><span class="co">#&#39; https://stackoverflow.com/questions/15100129/using-roxygen2-template-tags</span></span>
<span id="cb54-4"><a href="m-step.html#cb54-4" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb54-5"><a href="m-step.html#cb54-5" tabindex="-1"></a><span class="co">#&#39; @param resp Responsbilities of each particle.</span></span>
<span id="cb54-6"><a href="m-step.html#cb54-6" tabindex="-1"></a><span class="co">#&#39; @param ylist </span></span>
<span id="cb54-7"><a href="m-step.html#cb54-7" tabindex="-1"></a><span class="co">#&#39; @param lambda</span></span>
<span id="cb54-8"><a href="m-step.html#cb54-8" tabindex="-1"></a><span class="co">#&#39; @param l</span></span>
<span id="cb54-9"><a href="m-step.html#cb54-9" tabindex="-1"></a><span class="co">#&#39; @param sigma</span></span>
<span id="cb54-10"><a href="m-step.html#cb54-10" tabindex="-1"></a><span class="co">#&#39; @param sigma_eig_by_clust</span></span>
<span id="cb54-11"><a href="m-step.html#cb54-11" tabindex="-1"></a><span class="co">#&#39; @param Dl</span></span>
<span id="cb54-12"><a href="m-step.html#cb54-12" tabindex="-1"></a><span class="co">#&#39; @param Dlp1</span></span>
<span id="cb54-13"><a href="m-step.html#cb54-13" tabindex="-1"></a><span class="co">#&#39; @param TT</span></span>
<span id="cb54-14"><a href="m-step.html#cb54-14" tabindex="-1"></a><span class="co">#&#39; @param N</span></span>
<span id="cb54-15"><a href="m-step.html#cb54-15" tabindex="-1"></a><span class="co">#&#39; @param dimdat</span></span>
<span id="cb54-16"><a href="m-step.html#cb54-16" tabindex="-1"></a><span class="co">#&#39; @param first_iter</span></span>
<span id="cb54-17"><a href="m-step.html#cb54-17" tabindex="-1"></a><span class="co">#&#39; @param mus</span></span>
<span id="cb54-18"><a href="m-step.html#cb54-18" tabindex="-1"></a><span class="co">#&#39; @param Zs</span></span>
<span id="cb54-19"><a href="m-step.html#cb54-19" tabindex="-1"></a><span class="co">#&#39; @param Ws</span></span>
<span id="cb54-20"><a href="m-step.html#cb54-20" tabindex="-1"></a><span class="co">#&#39; @param uws</span></span>
<span id="cb54-21"><a href="m-step.html#cb54-21" tabindex="-1"></a><span class="co">#&#39; @param uzs</span></span>
<span id="cb54-22"><a href="m-step.html#cb54-22" tabindex="-1"></a><span class="co">#&#39; @param maxdev</span></span>
<span id="cb54-23"><a href="m-step.html#cb54-23" tabindex="-1"></a><span class="co">#&#39; @param x</span></span>
<span id="cb54-24"><a href="m-step.html#cb54-24" tabindex="-1"></a><span class="co">#&#39; @param niter</span></span>
<span id="cb54-25"><a href="m-step.html#cb54-25" tabindex="-1"></a><span class="co">#&#39; @param err_rel</span></span>
<span id="cb54-26"><a href="m-step.html#cb54-26" tabindex="-1"></a><span class="co">#&#39; @param err_abs</span></span>
<span id="cb54-27"><a href="m-step.html#cb54-27" tabindex="-1"></a><span class="co">#&#39; @param zerothresh</span></span>
<span id="cb54-28"><a href="m-step.html#cb54-28" tabindex="-1"></a><span class="co">#&#39; @param local_adapt</span></span>
<span id="cb54-29"><a href="m-step.html#cb54-29" tabindex="-1"></a><span class="co">#&#39; @param local_adapt_niter</span></span>
<span id="cb54-30"><a href="m-step.html#cb54-30" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb54-31"><a href="m-step.html#cb54-31" tabindex="-1"></a><span class="co">#&#39; @return</span></span>
<span id="cb54-32"><a href="m-step.html#cb54-32" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb54-33"><a href="m-step.html#cb54-33" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb54-34"><a href="m-step.html#cb54-34" tabindex="-1"></a><span class="co">#&#39; @examples</span></span>
<span id="cb54-35"><a href="m-step.html#cb54-35" tabindex="-1"></a><span id='Mstep_mu'>Mstep_mu</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(resp,</span>
<span id="cb54-36"><a href="m-step.html#cb54-36" tabindex="-1"></a>                     ylist,  </span>
<span id="cb54-37"><a href="m-step.html#cb54-37" tabindex="-1"></a>                     <span class="at">lambda =</span> <span class="fl">0.5</span>,</span>
<span id="cb54-38"><a href="m-step.html#cb54-38" tabindex="-1"></a>                     <span class="at">l =</span> <span class="dv">3</span>,</span>
<span id="cb54-39"><a href="m-step.html#cb54-39" tabindex="-1"></a>                     sigma,</span>
<span id="cb54-40"><a href="m-step.html#cb54-40" tabindex="-1"></a>                     <span class="at">sigma_eig_by_clust =</span> <span class="cn">NULL</span>,</span>
<span id="cb54-41"><a href="m-step.html#cb54-41" tabindex="-1"></a>                     Dlsqrd,</span>
<span id="cb54-42"><a href="m-step.html#cb54-42" tabindex="-1"></a>                     Dl, tDl, Dlp1,  TT, N, dimdat,</span>
<span id="cb54-43"><a href="m-step.html#cb54-43" tabindex="-1"></a>                     <span class="at">first_iter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb54-44"><a href="m-step.html#cb54-44" tabindex="-1"></a>                     e_mat,</span>
<span id="cb54-45"><a href="m-step.html#cb54-45" tabindex="-1"></a></span>
<span id="cb54-46"><a href="m-step.html#cb54-46" tabindex="-1"></a>                     <span class="do">## Warm startable variables</span></span>
<span id="cb54-47"><a href="m-step.html#cb54-47" tabindex="-1"></a>                     <span class="at">mus =</span> <span class="cn">NULL</span>,</span>
<span id="cb54-48"><a href="m-step.html#cb54-48" tabindex="-1"></a>                     <span class="at">Zs =</span> <span class="cn">NULL</span>,</span>
<span id="cb54-49"><a href="m-step.html#cb54-49" tabindex="-1"></a>                     <span class="at">Ws =</span> <span class="cn">NULL</span>,</span>
<span id="cb54-50"><a href="m-step.html#cb54-50" tabindex="-1"></a>                     <span class="at">uws =</span> <span class="cn">NULL</span>,</span>
<span id="cb54-51"><a href="m-step.html#cb54-51" tabindex="-1"></a>                     <span class="at">uzs =</span> <span class="cn">NULL</span>,</span>
<span id="cb54-52"><a href="m-step.html#cb54-52" tabindex="-1"></a>                     <span class="do">## End of warm startable variables</span></span>
<span id="cb54-53"><a href="m-step.html#cb54-53" tabindex="-1"></a></span>
<span id="cb54-54"><a href="m-step.html#cb54-54" tabindex="-1"></a>                     <span class="at">maxdev =</span> <span class="cn">NULL</span>,</span>
<span id="cb54-55"><a href="m-step.html#cb54-55" tabindex="-1"></a>                     <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb54-56"><a href="m-step.html#cb54-56" tabindex="-1"></a>                     <span class="at">niter =</span> (<span class="cf">if</span>(local_adapt) <span class="fl">1e2</span> <span class="cf">else</span> <span class="fl">1e3</span>),</span>
<span id="cb54-57"><a href="m-step.html#cb54-57" tabindex="-1"></a>                     <span class="at">err_rel =</span> <span class="fl">1E-3</span>,</span>
<span id="cb54-58"><a href="m-step.html#cb54-58" tabindex="-1"></a>                     <span class="at">err_abs =</span> <span class="dv">0</span>,</span>
<span id="cb54-59"><a href="m-step.html#cb54-59" tabindex="-1"></a>                     <span class="at">zerothresh =</span> <span class="fl">1E-6</span>,</span>
<span id="cb54-60"><a href="m-step.html#cb54-60" tabindex="-1"></a>                     <span class="at">local_adapt =</span> <span class="cn">FALSE</span>,</span>
<span id="cb54-61"><a href="m-step.html#cb54-61" tabindex="-1"></a>                     <span class="at">local_adapt_niter =</span> <span class="dv">10</span>,</span>
<span id="cb54-62"><a href="m-step.html#cb54-62" tabindex="-1"></a>                     <span class="at">rho_init =</span> <span class="fl">0.01</span>,</span>
<span id="cb54-63"><a href="m-step.html#cb54-63" tabindex="-1"></a>                     <span class="at">iter =</span> <span class="cn">NULL</span>){</span>
<span id="cb54-64"><a href="m-step.html#cb54-64" tabindex="-1"></a></span>
<span id="cb54-65"><a href="m-step.html#cb54-65" tabindex="-1"></a>  <span class="do">####################</span></span>
<span id="cb54-66"><a href="m-step.html#cb54-66" tabindex="-1"></a>  <span class="do">## Preliminaries </span><span class="al">###</span></span>
<span id="cb54-67"><a href="m-step.html#cb54-67" tabindex="-1"></a>  <span class="do">####################</span></span>
<span id="cb54-68"><a href="m-step.html#cb54-68" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="fu">length</span>(ylist)</span>
<span id="cb54-69"><a href="m-step.html#cb54-69" tabindex="-1"></a>  numclust <span class="ot">=</span> <span class="fu">ncol</span>(resp[[<span class="dv">1</span>]])</span>
<span id="cb54-70"><a href="m-step.html#cb54-70" tabindex="-1"></a>  dimdat <span class="ot">=</span> <span class="fu">ncol</span>(ylist[[<span class="dv">1</span>]])</span>
<span id="cb54-71"><a href="m-step.html#cb54-71" tabindex="-1"></a>  ntlist <span class="ot">=</span> <span class="fu">sapply</span>(ylist, nrow)</span>
<span id="cb54-72"><a href="m-step.html#cb54-72" tabindex="-1"></a>  resp.sum <span class="ot">=</span> <span class="fu">lapply</span>(resp, colSums) <span class="sc">%&gt;%</span> <span class="fu">do.call</span>(rbind, .)</span>
<span id="cb54-73"><a href="m-step.html#cb54-73" tabindex="-1"></a>  N <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">unlist</span>(resp.sum))</span>
<span id="cb54-74"><a href="m-step.html#cb54-74" tabindex="-1"></a></span>
<span id="cb54-75"><a href="m-step.html#cb54-75" tabindex="-1"></a>  <span class="do">## Other preliminaries</span></span>
<span id="cb54-76"><a href="m-step.html#cb54-76" tabindex="-1"></a>  schur_syl_A_by_clust <span class="ot">=</span> schur_syl_B_by_clust <span class="ot">=</span> term3list <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb54-77"><a href="m-step.html#cb54-77" tabindex="-1"></a>  ybarlist <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb54-78"><a href="m-step.html#cb54-78" tabindex="-1"></a>  ycentered_list <span class="ot">=</span> Xcentered_list <span class="ot">=</span> yXcentered_list <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb54-79"><a href="m-step.html#cb54-79" tabindex="-1"></a>  Qlist <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb54-80"><a href="m-step.html#cb54-80" tabindex="-1"></a>  sigmainv_list <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb54-81"><a href="m-step.html#cb54-81" tabindex="-1"></a>  <span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>numclust){</span>
<span id="cb54-82"><a href="m-step.html#cb54-82" tabindex="-1"></a></span>
<span id="cb54-83"><a href="m-step.html#cb54-83" tabindex="-1"></a>    <span class="do">## Retrieve sigma inverse from pre-computed SVD, if necessary</span></span>
<span id="cb54-84"><a href="m-step.html#cb54-84" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(sigma_eig_by_clust)){</span>
<span id="cb54-85"><a href="m-step.html#cb54-85" tabindex="-1"></a>      sigmainv <span class="ot">=</span> <span class="fu">solve</span>(sigma[iclust,,])</span>
<span id="cb54-86"><a href="m-step.html#cb54-86" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb54-87"><a href="m-step.html#cb54-87" tabindex="-1"></a>      sigmainv <span class="ot">=</span> sigma_eig_by_clust[[iclust]]<span class="sc">$</span>sigma_inv</span>
<span id="cb54-88"><a href="m-step.html#cb54-88" tabindex="-1"></a>    }</span>
<span id="cb54-89"><a href="m-step.html#cb54-89" tabindex="-1"></a></span>
<span id="cb54-90"><a href="m-step.html#cb54-90" tabindex="-1"></a>    resp.iclust <span class="ot">&lt;-</span> <span class="fu">lapply</span>(resp, <span class="at">FUN =</span> <span class="cf">function</span>(r) <span class="fu">matrix</span>(r[,iclust]))</span>
<span id="cb54-91"><a href="m-step.html#cb54-91" tabindex="-1"></a></span>
<span id="cb54-92"><a href="m-step.html#cb54-92" tabindex="-1"></a>    AB <span class="ot">&lt;-</span> <a href='m-step.html#get_AB_mats'>get_AB_mats</a>(<span class="at">y =</span> y, <span class="at">resp =</span> resp.iclust, <span class="at">Sigma_inv =</span> sigmainv,</span>
<span id="cb54-93"><a href="m-step.html#cb54-93" tabindex="-1"></a>                      <span class="at">e_mat =</span> e_mat, <span class="at">N =</span> N, <span class="at">Dlp1 =</span> Dlp1, <span class="at">Dl =</span> Dl,</span>
<span id="cb54-94"><a href="m-step.html#cb54-94" tabindex="-1"></a>                      <span class="at">Dlsqrd =</span> Dlsqrd, <span class="at">rho =</span> rho_init, <span class="at">z =</span> <span class="cn">NULL</span>, <span class="at">w =</span> <span class="cn">NULL</span>,</span>
<span id="cb54-95"><a href="m-step.html#cb54-95" tabindex="-1"></a>                      <span class="at">uz =</span> <span class="cn">NULL</span>, <span class="at">uw =</span> <span class="cn">NULL</span>)</span>
<span id="cb54-96"><a href="m-step.html#cb54-96" tabindex="-1"></a></span>
<span id="cb54-97"><a href="m-step.html#cb54-97" tabindex="-1"></a>    <span class="do">## Store the Schur decomposition</span></span>
<span id="cb54-98"><a href="m-step.html#cb54-98" tabindex="-1"></a>    schur_syl_A_by_clust[[iclust]] <span class="ot">=</span> <a href='m-step.html#myschur'>myschur</a>(AB<span class="sc">$</span>A)</span>
<span id="cb54-99"><a href="m-step.html#cb54-99" tabindex="-1"></a>    schur_syl_B_by_clust[[iclust]] <span class="ot">=</span> <a href='m-step.html#myschur'>myschur</a>(AB<span class="sc">$</span>B)</span>
<span id="cb54-100"><a href="m-step.html#cb54-100" tabindex="-1"></a></span>
<span id="cb54-101"><a href="m-step.html#cb54-101" tabindex="-1"></a>    ycentered <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb54-102"><a href="m-step.html#cb54-102" tabindex="-1"></a>    ycentered_list[[iclust]] <span class="ot">=</span> ycentered</span>
<span id="cb54-103"><a href="m-step.html#cb54-103" tabindex="-1"></a>    sigmainv_list[[iclust]] <span class="ot">=</span> sigmainv</span>
<span id="cb54-104"><a href="m-step.html#cb54-104" tabindex="-1"></a>  }</span>
<span id="cb54-105"><a href="m-step.html#cb54-105" tabindex="-1"></a></span>
<span id="cb54-106"><a href="m-step.html#cb54-106" tabindex="-1"></a>  <span class="do">##########################################</span></span>
<span id="cb54-107"><a href="m-step.html#cb54-107" tabindex="-1"></a>  <span class="do">## Run ADMM separately on each cluster ##</span></span>
<span id="cb54-108"><a href="m-step.html#cb54-108" tabindex="-1"></a>  <span class="do">#########################################</span></span>
<span id="cb54-109"><a href="m-step.html#cb54-109" tabindex="-1"></a>  admm_niters <span class="ot">=</span> admm_inner_iters <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">length =</span> numclust, <span class="at">mode =</span> <span class="st">&quot;list&quot;</span>)</span>
<span id="cb54-110"><a href="m-step.html#cb54-110" tabindex="-1"></a>  <span class="cf">if</span>(first_iter) mus <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">length =</span> numclust, <span class="at">mode =</span> <span class="st">&quot;list&quot;</span>)</span>
<span id="cb54-111"><a href="m-step.html#cb54-111" tabindex="-1"></a> <span class="co"># if(first_iter){</span></span>
<span id="cb54-112"><a href="m-step.html#cb54-112" tabindex="-1"></a>    Zs <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>numclust, <span class="cf">function</span>(x) <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT, <span class="at">ncol =</span> dimdat))</span>
<span id="cb54-113"><a href="m-step.html#cb54-113" tabindex="-1"></a>    Ws <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>numclust, <span class="cf">function</span>(x) <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT <span class="sc">-</span> l, <span class="at">ncol =</span> dimdat))</span>
<span id="cb54-114"><a href="m-step.html#cb54-114" tabindex="-1"></a>    uzs <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>numclust, <span class="cf">function</span>(x) <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT, <span class="at">ncol =</span> dimdat))</span>
<span id="cb54-115"><a href="m-step.html#cb54-115" tabindex="-1"></a>    uws <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>numclust, <span class="cf">function</span>(x) <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT <span class="sc">-</span> l, <span class="at">ncol =</span> dimdat))</span>
<span id="cb54-116"><a href="m-step.html#cb54-116" tabindex="-1"></a></span>
<span id="cb54-117"><a href="m-step.html#cb54-117" tabindex="-1"></a>   <span class="co"># Zs =  Ws =  Us  = vector(length = numclust, mode = &quot;list&quot;)</span></span>
<span id="cb54-118"><a href="m-step.html#cb54-118" tabindex="-1"></a> <span class="co"># }</span></span>
<span id="cb54-119"><a href="m-step.html#cb54-119" tabindex="-1"></a></span>
<span id="cb54-120"><a href="m-step.html#cb54-120" tabindex="-1"></a>  <span class="do">## For every cluster, run LA-ADMM</span></span>
<span id="cb54-121"><a href="m-step.html#cb54-121" tabindex="-1"></a>  start.time <span class="ot">=</span> <span class="fu">Sys.time</span>()</span>
<span id="cb54-122"><a href="m-step.html#cb54-122" tabindex="-1"></a>  <span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>numclust){</span>
<span id="cb54-123"><a href="m-step.html#cb54-123" tabindex="-1"></a></span>
<span id="cb54-124"><a href="m-step.html#cb54-124" tabindex="-1"></a>    resp.iclust <span class="ot">&lt;-</span> <span class="fu">lapply</span>(resp, <span class="at">FUN =</span> <span class="cf">function</span>(r) <span class="fu">matrix</span>(r[,iclust]))</span>
<span id="cb54-125"><a href="m-step.html#cb54-125" tabindex="-1"></a></span>
<span id="cb54-126"><a href="m-step.html#cb54-126" tabindex="-1"></a>    <span class="do">## Possibly locally adaptive ADMM, for now just running with rho == lambda</span></span>
<span id="cb54-127"><a href="m-step.html#cb54-127" tabindex="-1"></a>    res <span class="ot">=</span> <a href='m-step.html#la_admm_oneclust'>la_admm_oneclust</a>(<span class="at">K =</span> (<span class="cf">if</span>(local_adapt) local_adapt_niter <span class="cf">else</span> <span class="dv">1</span>),</span>
<span id="cb54-128"><a href="m-step.html#cb54-128" tabindex="-1"></a>                           <span class="at">local_adapt =</span> local_adapt,</span>
<span id="cb54-129"><a href="m-step.html#cb54-129" tabindex="-1"></a>                           <span class="at">iclust =</span> iclust,</span>
<span id="cb54-130"><a href="m-step.html#cb54-130" tabindex="-1"></a>                           <span class="at">niter =</span> niter,</span>
<span id="cb54-131"><a href="m-step.html#cb54-131" tabindex="-1"></a>                           <span class="at">TT =</span> TT, <span class="at">N =</span> N, <span class="at">dimdat =</span> dimdat, <span class="at">maxdev =</span> maxdev,</span>
<span id="cb54-132"><a href="m-step.html#cb54-132" tabindex="-1"></a>                           <span class="at">schurA =</span> schur_syl_A_by_clust[[iclust]],</span>
<span id="cb54-133"><a href="m-step.html#cb54-133" tabindex="-1"></a>                           <span class="at">schurB =</span> schur_syl_B_by_clust[[iclust]],</span>
<span id="cb54-134"><a href="m-step.html#cb54-134" tabindex="-1"></a>                           <span class="at">sigmainv =</span> sigmainv_list[[iclust]],</span>
<span id="cb54-135"><a href="m-step.html#cb54-135" tabindex="-1"></a>                           <span class="at">rho =</span> rho_init, </span>
<span id="cb54-136"><a href="m-step.html#cb54-136" tabindex="-1"></a>                           <span class="at">rhoinit =</span> rho_init, </span>
<span id="cb54-137"><a href="m-step.html#cb54-137" tabindex="-1"></a>                           <span class="do">## rho = (if(iclust == 1) rho_init else res$rho/2),</span></span>
<span id="cb54-138"><a href="m-step.html#cb54-138" tabindex="-1"></a>                           <span class="do">## rhoinit = (if(iclust == 1) rho_init else res$rho/2),</span></span>
<span id="cb54-139"><a href="m-step.html#cb54-139" tabindex="-1"></a>                           <span class="at">sigma =</span> sigma,</span>
<span id="cb54-140"><a href="m-step.html#cb54-140" tabindex="-1"></a>                           <span class="at">lambda =</span> lambda,</span>
<span id="cb54-141"><a href="m-step.html#cb54-141" tabindex="-1"></a>                           <span class="at">resp =</span> resp.iclust,</span>
<span id="cb54-142"><a href="m-step.html#cb54-142" tabindex="-1"></a>                           <span class="at">resp_sum =</span> resp.sum[,iclust],</span>
<span id="cb54-143"><a href="m-step.html#cb54-143" tabindex="-1"></a>                           <span class="at">l =</span> l,</span>
<span id="cb54-144"><a href="m-step.html#cb54-144" tabindex="-1"></a>                           <span class="at">Dlp1 =</span> Dlp1,</span>
<span id="cb54-145"><a href="m-step.html#cb54-145" tabindex="-1"></a>                           <span class="at">Dl =</span> Dl,</span>
<span id="cb54-146"><a href="m-step.html#cb54-146" tabindex="-1"></a>                           <span class="at">tDl =</span> tDl,</span>
<span id="cb54-147"><a href="m-step.html#cb54-147" tabindex="-1"></a>                           <span class="at">y =</span> ylist,</span>
<span id="cb54-148"><a href="m-step.html#cb54-148" tabindex="-1"></a>                           <span class="at">err_rel =</span> err_rel,</span>
<span id="cb54-149"><a href="m-step.html#cb54-149" tabindex="-1"></a>                           <span class="at">err_abs =</span> err_abs,</span>
<span id="cb54-150"><a href="m-step.html#cb54-150" tabindex="-1"></a>                           <span class="at">zerothresh =</span> zerothresh,</span>
<span id="cb54-151"><a href="m-step.html#cb54-151" tabindex="-1"></a>                           <span class="at">sigma_eig_by_clust =</span> sigma_eig_by_clust,</span>
<span id="cb54-152"><a href="m-step.html#cb54-152" tabindex="-1"></a>                           <span class="at">iter =</span> iter,</span>
<span id="cb54-153"><a href="m-step.html#cb54-153" tabindex="-1"></a></span>
<span id="cb54-154"><a href="m-step.html#cb54-154" tabindex="-1"></a>                           <span class="do">## Warm starts from previous *EM* iteration</span></span>
<span id="cb54-155"><a href="m-step.html#cb54-155" tabindex="-1"></a>                           <span class="at">first_iter =</span> first_iter,</span>
<span id="cb54-156"><a href="m-step.html#cb54-156" tabindex="-1"></a>                           <span class="do">## mu = mus[[iclust]], ## I think we want this.</span></span>
<span id="cb54-157"><a href="m-step.html#cb54-157" tabindex="-1"></a>                           <span class="at">uw =</span> uws[[iclust]],</span>
<span id="cb54-158"><a href="m-step.html#cb54-158" tabindex="-1"></a>                           <span class="at">uz =</span> uzs[[iclust]],</span>
<span id="cb54-159"><a href="m-step.html#cb54-159" tabindex="-1"></a>                           <span class="at">z =</span> Zs[[iclust]],</span>
<span id="cb54-160"><a href="m-step.html#cb54-160" tabindex="-1"></a>                           <span class="at">w =</span> Ws[[iclust]])</span>
<span id="cb54-161"><a href="m-step.html#cb54-161" tabindex="-1"></a>    <span class="do">## print(res$rho)</span></span>
<span id="cb54-162"><a href="m-step.html#cb54-162" tabindex="-1"></a></span>
<span id="cb54-163"><a href="m-step.html#cb54-163" tabindex="-1"></a>    <span class="do">## Store the results</span></span>
<span id="cb54-164"><a href="m-step.html#cb54-164" tabindex="-1"></a>    mus[[iclust]] <span class="ot">=</span> res<span class="sc">$</span>mu</span>
<span id="cb54-165"><a href="m-step.html#cb54-165" tabindex="-1"></a>    admm_niters[[iclust]] <span class="ot">=</span> res<span class="sc">$</span>kk</span>
<span id="cb54-166"><a href="m-step.html#cb54-166" tabindex="-1"></a>    admm_inner_iters[[iclust]] <span class="ot">=</span> res<span class="sc">$</span>inner.iter</span>
<span id="cb54-167"><a href="m-step.html#cb54-167" tabindex="-1"></a></span>
<span id="cb54-168"><a href="m-step.html#cb54-168" tabindex="-1"></a>    <span class="do">## Store other things for for warmstart</span></span>
<span id="cb54-169"><a href="m-step.html#cb54-169" tabindex="-1"></a>    <span class="do">## mus[[iclust]] = res$mu</span></span>
<span id="cb54-170"><a href="m-step.html#cb54-170" tabindex="-1"></a>    Zs[[iclust]] <span class="ot">=</span> res<span class="sc">$</span>Z</span>
<span id="cb54-171"><a href="m-step.html#cb54-171" tabindex="-1"></a>    uzs[[iclust]] <span class="ot">=</span> res<span class="sc">$</span>uz</span>
<span id="cb54-172"><a href="m-step.html#cb54-172" tabindex="-1"></a>    uws[[iclust]] <span class="ot">=</span> res<span class="sc">$</span>uw</span>
<span id="cb54-173"><a href="m-step.html#cb54-173" tabindex="-1"></a>    Ws[[iclust]] <span class="ot">=</span> res<span class="sc">$</span>W</span>
<span id="cb54-174"><a href="m-step.html#cb54-174" tabindex="-1"></a>    <span class="do">## The upper triangular matrix remains the same. (code missing?)</span></span>
<span id="cb54-175"><a href="m-step.html#cb54-175" tabindex="-1"></a></span>
<span id="cb54-176"><a href="m-step.html#cb54-176" tabindex="-1"></a>  }</span>
<span id="cb54-177"><a href="m-step.html#cb54-177" tabindex="-1"></a></span>
<span id="cb54-178"><a href="m-step.html#cb54-178" tabindex="-1"></a>  <span class="do">## Aggregate the yhats into one array</span></span>
<span id="cb54-179"><a href="m-step.html#cb54-179" tabindex="-1"></a>  mu_array <span class="ot">=</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">c</span>(TT, dimdat, numclust))</span>
<span id="cb54-180"><a href="m-step.html#cb54-180" tabindex="-1"></a>  <span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>numclust){ mu_array[,,iclust] <span class="ot">=</span> mus[[iclust]] }</span>
<span id="cb54-181"><a href="m-step.html#cb54-181" tabindex="-1"></a></span>
<span id="cb54-182"><a href="m-step.html#cb54-182" tabindex="-1"></a>  <span class="do">## Each are lists of length |numclust|.</span></span>
<span id="cb54-183"><a href="m-step.html#cb54-183" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mns =</span> mu_array,</span>
<span id="cb54-184"><a href="m-step.html#cb54-184" tabindex="-1"></a>              <span class="at">admm_niters =</span> admm_niters, </span>
<span id="cb54-185"><a href="m-step.html#cb54-185" tabindex="-1"></a>              <span class="at">admm_inner_iters =</span> admm_inner_iters,</span>
<span id="cb54-186"><a href="m-step.html#cb54-186" tabindex="-1"></a></span>
<span id="cb54-187"><a href="m-step.html#cb54-187" tabindex="-1"></a>              <span class="do">## For warmstarts</span></span>
<span id="cb54-188"><a href="m-step.html#cb54-188" tabindex="-1"></a>              <span class="at">Zs =</span> Zs,</span>
<span id="cb54-189"><a href="m-step.html#cb54-189" tabindex="-1"></a>              <span class="at">Ws =</span> Ws,</span>
<span id="cb54-190"><a href="m-step.html#cb54-190" tabindex="-1"></a>              <span class="at">uws =</span> uws,</span>
<span id="cb54-191"><a href="m-step.html#cb54-191" tabindex="-1"></a>              <span class="at">uzs =</span> uzs,</span>
<span id="cb54-192"><a href="m-step.html#cb54-192" tabindex="-1"></a>              <span class="at">N =</span> N,</span>
<span id="cb54-193"><a href="m-step.html#cb54-193" tabindex="-1"></a></span>
<span id="cb54-194"><a href="m-step.html#cb54-194" tabindex="-1"></a>              <span class="do">## Return the column</span></span>
<span id="cb54-195"><a href="m-step.html#cb54-195" tabindex="-1"></a>              <span class="at">rho =</span> res<span class="sc">$</span>rho,</span>
<span id="cb54-196"><a href="m-step.html#cb54-196" tabindex="-1"></a></span>
<span id="cb54-197"><a href="m-step.html#cb54-197" tabindex="-1"></a>              <span class="do">## For using in the Sigma M step</span></span>
<span id="cb54-198"><a href="m-step.html#cb54-198" tabindex="-1"></a>              <span class="at">ycentered_list =</span> ycentered_list,</span>
<span id="cb54-199"><a href="m-step.html#cb54-199" tabindex="-1"></a>              <span class="at">Xcentered_list =</span> Xcentered_list,</span>
<span id="cb54-200"><a href="m-step.html#cb54-200" tabindex="-1"></a>              <span class="at">yXcentered_list =</span> yXcentered_list,</span>
<span id="cb54-201"><a href="m-step.html#cb54-201" tabindex="-1"></a>              <span class="at">Qlist =</span> Qlist</span>
<span id="cb54-202"><a href="m-step.html#cb54-202" tabindex="-1"></a>  ))</span>
<span id="cb54-203"><a href="m-step.html#cb54-203" tabindex="-1"></a>}</span></code></pre></div>
<p>The locally adaptive admm for a single cluster involves an inner and outer
loop. The inner loop is an ADMM for a fixed <span class="math inline">\(\rho\)</span>. The outer loop is written
here in <code>la_admm_oneclust</code>, and runs the inner ADMM with a fixed step-size
<span class="math inline">\(\rho\)</span> while sequentially doubling <span class="math inline">\(\rho\)</span>.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="m-step.html#cb55-1" tabindex="-1"></a><span class="co">#&#39; Locally adaptive ADMM.</span></span>
<span id="cb55-2"><a href="m-step.html#cb55-2" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb55-3"><a href="m-step.html#cb55-3" tabindex="-1"></a><span class="co">#&#39; @param K</span></span>
<span id="cb55-4"><a href="m-step.html#cb55-4" tabindex="-1"></a><span class="co">#&#39; @param ...</span></span>
<span id="cb55-5"><a href="m-step.html#cb55-5" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb55-6"><a href="m-step.html#cb55-6" tabindex="-1"></a><span class="co">#&#39; @return</span></span>
<span id="cb55-7"><a href="m-step.html#cb55-7" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb55-8"><a href="m-step.html#cb55-8" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb55-9"><a href="m-step.html#cb55-9" tabindex="-1"></a><span class="co">#&#39; @examples</span></span>
<span id="cb55-10"><a href="m-step.html#cb55-10" tabindex="-1"></a><span id='la_admm_oneclust'>la_admm_oneclust</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(K, ...){</span>
<span id="cb55-11"><a href="m-step.html#cb55-11" tabindex="-1"></a></span>
<span id="cb55-12"><a href="m-step.html#cb55-12" tabindex="-1"></a>  <span class="do">## Initialize arguments for ADMM.</span></span>
<span id="cb55-13"><a href="m-step.html#cb55-13" tabindex="-1"></a>  args <span class="ot">&lt;-</span> <span class="fu">list</span>(...)</span>
<span id="cb55-14"><a href="m-step.html#cb55-14" tabindex="-1"></a>  p <span class="ot">=</span> args<span class="sc">$</span>p</span>
<span id="cb55-15"><a href="m-step.html#cb55-15" tabindex="-1"></a>  l <span class="ot">=</span> args<span class="sc">$</span>l</span>
<span id="cb55-16"><a href="m-step.html#cb55-16" tabindex="-1"></a>  TT <span class="ot">=</span> args<span class="sc">$</span>TT</span>
<span id="cb55-17"><a href="m-step.html#cb55-17" tabindex="-1"></a>  dimdat <span class="ot">=</span> args<span class="sc">$</span>dimdat</span>
<span id="cb55-18"><a href="m-step.html#cb55-18" tabindex="-1"></a>  rhoinit <span class="ot">=</span> args<span class="sc">$</span>rhoinit</span>
<span id="cb55-19"><a href="m-step.html#cb55-19" tabindex="-1"></a></span>
<span id="cb55-20"><a href="m-step.html#cb55-20" tabindex="-1"></a>  <span class="do">## This initialization can come from the previous *EM* iteration.</span></span>
<span id="cb55-21"><a href="m-step.html#cb55-21" tabindex="-1"></a>  <span class="cf">if</span>(args<span class="sc">$</span>first_iter){</span>
<span id="cb55-22"><a href="m-step.html#cb55-22" tabindex="-1"></a>    mu <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT, <span class="at">ncol =</span> dimdat)</span>
<span id="cb55-23"><a href="m-step.html#cb55-23" tabindex="-1"></a>    Z <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT, <span class="at">ncol =</span> dimdat)</span>
<span id="cb55-24"><a href="m-step.html#cb55-24" tabindex="-1"></a>    W <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT<span class="sc">-</span>l, <span class="at">ncol =</span> dimdat)</span>
<span id="cb55-25"><a href="m-step.html#cb55-25" tabindex="-1"></a>    uz <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT, <span class="at">ncol =</span> dimdat)</span>
<span id="cb55-26"><a href="m-step.html#cb55-26" tabindex="-1"></a>    uw <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT <span class="sc">-</span> l, <span class="at">ncol =</span> dimdat)</span>
<span id="cb55-27"><a href="m-step.html#cb55-27" tabindex="-1"></a></span>
<span id="cb55-28"><a href="m-step.html#cb55-28" tabindex="-1"></a>    args[[<span class="st">&#39;mu&#39;</span>]] <span class="ot">&lt;-</span> mu</span>
<span id="cb55-29"><a href="m-step.html#cb55-29" tabindex="-1"></a>    args[[<span class="st">&#39;z&#39;</span>]] <span class="ot">&lt;-</span> Z</span>
<span id="cb55-30"><a href="m-step.html#cb55-30" tabindex="-1"></a>    args[[<span class="st">&#39;w&#39;</span>]] <span class="ot">&lt;-</span> W</span>
<span id="cb55-31"><a href="m-step.html#cb55-31" tabindex="-1"></a>    args[[<span class="st">&#39;uz&#39;</span>]] <span class="ot">&lt;-</span> uz</span>
<span id="cb55-32"><a href="m-step.html#cb55-32" tabindex="-1"></a>    args[[<span class="st">&#39;uw&#39;</span>]] <span class="ot">&lt;-</span> uw</span>
<span id="cb55-33"><a href="m-step.html#cb55-33" tabindex="-1"></a>  }</span>
<span id="cb55-34"><a href="m-step.html#cb55-34" tabindex="-1"></a></span>
<span id="cb55-35"><a href="m-step.html#cb55-35" tabindex="-1"></a>  cols <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb55-36"><a href="m-step.html#cb55-36" tabindex="-1"></a>  some_admm_objectives <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb55-37"><a href="m-step.html#cb55-37" tabindex="-1"></a></span>
<span id="cb55-38"><a href="m-step.html#cb55-38" tabindex="-1"></a></span>
<span id="cb55-39"><a href="m-step.html#cb55-39" tabindex="-1"></a>  <span class="do">## Run ADMM repeatedly with (1) double rho, and (2) previous b</span></span>
<span id="cb55-40"><a href="m-step.html#cb55-40" tabindex="-1"></a>  <span class="cf">for</span>(kk <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){</span>
<span id="cb55-41"><a href="m-step.html#cb55-41" tabindex="-1"></a>    <span class="cf">if</span>(kk <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb55-42"><a href="m-step.html#cb55-42" tabindex="-1"></a>      <span class="do">## Z = matrix(0, nrow = TT, ncol = dimdat)</span></span>
<span id="cb55-43"><a href="m-step.html#cb55-43" tabindex="-1"></a>      <span class="do">## W = matrix(0, nrow = TT - l , ncol = dimdat)</span></span>
<span id="cb55-44"><a href="m-step.html#cb55-44" tabindex="-1"></a>      <span class="do">## uz = matrix(0, nrow = TT, ncol = dimdat)</span></span>
<span id="cb55-45"><a href="m-step.html#cb55-45" tabindex="-1"></a>      <span class="do">## uw = matrix(0, nrow = TT - l , ncol = dimdat)</span></span>
<span id="cb55-46"><a href="m-step.html#cb55-46" tabindex="-1"></a></span>
<span id="cb55-47"><a href="m-step.html#cb55-47" tabindex="-1"></a>      <span class="do">## These ensure warm starts are true</span></span>
<span id="cb55-48"><a href="m-step.html#cb55-48" tabindex="-1"></a>      args[[<span class="st">&#39;mu&#39;</span>]] <span class="ot">&lt;-</span> mu</span>
<span id="cb55-49"><a href="m-step.html#cb55-49" tabindex="-1"></a>      args[[<span class="st">&#39;z&#39;</span>]] <span class="ot">&lt;-</span> Z</span>
<span id="cb55-50"><a href="m-step.html#cb55-50" tabindex="-1"></a>      args[[<span class="st">&#39;w&#39;</span>]] <span class="ot">&lt;-</span> W</span>
<span id="cb55-51"><a href="m-step.html#cb55-51" tabindex="-1"></a>      args[[<span class="st">&#39;uz&#39;</span>]] <span class="ot">&lt;-</span> uz</span>
<span id="cb55-52"><a href="m-step.html#cb55-52" tabindex="-1"></a>      args[[<span class="st">&#39;uw&#39;</span>]] <span class="ot">&lt;-</span> uw</span>
<span id="cb55-53"><a href="m-step.html#cb55-53" tabindex="-1"></a>      args[[<span class="st">&#39;rho&#39;</span>]] <span class="ot">&lt;-</span> rho</span>
<span id="cb55-54"><a href="m-step.html#cb55-54" tabindex="-1"></a>    }</span>
<span id="cb55-55"><a href="m-step.html#cb55-55" tabindex="-1"></a></span>
<span id="cb55-56"><a href="m-step.html#cb55-56" tabindex="-1"></a>    <span class="do">## Run ADMM</span></span>
<span id="cb55-57"><a href="m-step.html#cb55-57" tabindex="-1"></a>    args[[<span class="st">&#39;outer_iter&#39;</span>]] <span class="ot">&lt;-</span> kk</span>
<span id="cb55-58"><a href="m-step.html#cb55-58" tabindex="-1"></a></span>
<span id="cb55-59"><a href="m-step.html#cb55-59" tabindex="-1"></a>    <span class="do">## Call main function</span></span>
<span id="cb55-60"><a href="m-step.html#cb55-60" tabindex="-1"></a>    argn <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(args), as.name)</span>
<span id="cb55-61"><a href="m-step.html#cb55-61" tabindex="-1"></a>    <span class="fu">names</span>(argn) <span class="ot">&lt;-</span> <span class="fu">names</span>(args)</span>
<span id="cb55-62"><a href="m-step.html#cb55-62" tabindex="-1"></a>    call <span class="ot">&lt;-</span> <span class="fu">as.call</span>(<span class="fu">c</span>(<span class="fu">list</span>(<span class="fu">as.name</span>(<span class="st">&quot;admm_oneclust&quot;</span>)), argn))</span>
<span id="cb55-63"><a href="m-step.html#cb55-63" tabindex="-1"></a>    res <span class="ot">=</span> <span class="fu">eval</span>(call, args)</span>
<span id="cb55-64"><a href="m-step.html#cb55-64" tabindex="-1"></a></span>
<span id="cb55-65"><a href="m-step.html#cb55-65" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">abs</span>(res<span class="sc">$</span>mu)<span class="sc">&gt;</span><span class="fl">1E2</span>)){</span>
<span id="cb55-66"><a href="m-step.html#cb55-66" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">&quot;mu is blowing up! Probably because the initial ADMM step size (rho) is too large (and possibly the ball constraint on the means is large.&quot;</span>) </span>
<span id="cb55-67"><a href="m-step.html#cb55-67" tabindex="-1"></a>    }</span>
<span id="cb55-68"><a href="m-step.html#cb55-68" tabindex="-1"></a></span>
<span id="cb55-69"><a href="m-step.html#cb55-69" tabindex="-1"></a>    some_admm_objectives <span class="ot">=</span> <span class="fu">c</span>(some_admm_objectives, res<span class="sc">$</span>single_admm_objective) </span>
<span id="cb55-70"><a href="m-step.html#cb55-70" tabindex="-1"></a></span>
<span id="cb55-71"><a href="m-step.html#cb55-71" tabindex="-1"></a>    <span class="do">## Handling the scenario where the objectives are all zero</span></span>
<span id="cb55-72"><a href="m-step.html#cb55-72" tabindex="-1"></a>    padding <span class="ot">=</span> <span class="fl">1E-12</span></span>
<span id="cb55-73"><a href="m-step.html#cb55-73" tabindex="-1"></a>    some_admm_objectives <span class="ot">=</span> some_admm_objectives <span class="sc">+</span> padding</span>
<span id="cb55-74"><a href="m-step.html#cb55-74" tabindex="-1"></a></span>
<span id="cb55-75"><a href="m-step.html#cb55-75" tabindex="-1"></a>    <span class="do">## See if outer iterations should terminate</span></span>
<span id="cb55-76"><a href="m-step.html#cb55-76" tabindex="-1"></a>    <span class="cf">if</span>(res<span class="sc">$</span>converge){</span>
<span id="cb55-77"><a href="m-step.html#cb55-77" tabindex="-1"></a>      res<span class="sc">$</span>converge <span class="ot">&lt;-</span> T</span>
<span id="cb55-78"><a href="m-step.html#cb55-78" tabindex="-1"></a>      <span class="cf">break</span></span>
<span id="cb55-79"><a href="m-step.html#cb55-79" tabindex="-1"></a>    }</span>
<span id="cb55-80"><a href="m-step.html#cb55-80" tabindex="-1"></a></span>
<span id="cb55-81"><a href="m-step.html#cb55-81" tabindex="-1"></a>    <span class="do">## Update some parameters; double the rho value, and update the B matrix</span></span>
<span id="cb55-82"><a href="m-step.html#cb55-82" tabindex="-1"></a>    rho <span class="ot">=</span> <span class="dv">2</span> <span class="sc">*</span> args<span class="sc">$</span>rho</span>
<span id="cb55-83"><a href="m-step.html#cb55-83" tabindex="-1"></a>    <span class="do">## tQ = 2 * args$schurB$tQ ## This seems wrong. Delete now.</span></span>
<span id="cb55-84"><a href="m-step.html#cb55-84" tabindex="-1"></a>    mu <span class="ot">=</span> res<span class="sc">$</span>mu</span>
<span id="cb55-85"><a href="m-step.html#cb55-85" tabindex="-1"></a>    Z <span class="ot">=</span> res<span class="sc">$</span>Z</span>
<span id="cb55-86"><a href="m-step.html#cb55-86" tabindex="-1"></a>    W <span class="ot">=</span> res<span class="sc">$</span>W</span>
<span id="cb55-87"><a href="m-step.html#cb55-87" tabindex="-1"></a>    uz <span class="ot">=</span> res<span class="sc">$</span>uz</span>
<span id="cb55-88"><a href="m-step.html#cb55-88" tabindex="-1"></a>    uw <span class="ot">=</span> res<span class="sc">$</span>uw</span>
<span id="cb55-89"><a href="m-step.html#cb55-89" tabindex="-1"></a>    <span class="do">## print(&quot;args$rho&quot;)</span></span>
<span id="cb55-90"><a href="m-step.html#cb55-90" tabindex="-1"></a>    <span class="do">## print(args$rho)</span></span>
<span id="cb55-91"><a href="m-step.html#cb55-91" tabindex="-1"></a>  }</span>
<span id="cb55-92"><a href="m-step.html#cb55-92" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span>res<span class="sc">$</span>converge)   <span class="fu">warning</span>(<span class="st">&quot;ADMM didn&#39;t converge for one cluster.&quot;</span>)</span>
<span id="cb55-93"><a href="m-step.html#cb55-93" tabindex="-1"></a></span>
<span id="cb55-94"><a href="m-step.html#cb55-94" tabindex="-1"></a>  <span class="do">## Record how long the admm took; in terms of # iterations.</span></span>
<span id="cb55-95"><a href="m-step.html#cb55-95" tabindex="-1"></a>  res<span class="sc">$</span>kk <span class="ot">=</span> kk</span>
<span id="cb55-96"><a href="m-step.html#cb55-96" tabindex="-1"></a></span>
<span id="cb55-97"><a href="m-step.html#cb55-97" tabindex="-1"></a>  <span class="do">## Record the final rho</span></span>
<span id="cb55-98"><a href="m-step.html#cb55-98" tabindex="-1"></a>  res<span class="sc">$</span>rho <span class="ot">=</span> args<span class="sc">$</span>rho</span>
<span id="cb55-99"><a href="m-step.html#cb55-99" tabindex="-1"></a></span>
<span id="cb55-100"><a href="m-step.html#cb55-100" tabindex="-1"></a>  <span class="fu">return</span>(res)</span>
<span id="cb55-101"><a href="m-step.html#cb55-101" tabindex="-1"></a>}</span></code></pre></div>
<p>Next, the inner loop. The workhorse <code><a href='m-step.html#admm_oneclust'>admm_oneclust</a>()</code> actually performs the ADMM
update for one cluster for a fixed step-size <span class="math inline">\(\rho\)</span> across optimization
iterations <code>iter=1,...,n</code>.</p>
<p>This <code><a href='m-step.html#admm_oneclust'>admm_oneclust</a>()</code> uses the following helpers:</p>
<ul>
<li><code><a href='m-step.html#W_update_fused'>W_update_fused</a>()</code>: this uses the <code>prox</code> function, which uses a RCpp function.
<code>prox_dp</code>.</li>
<li><code><a href='m-step.html#Z_update'>Z_update</a>()</code></li>
<li><code><a href='m-step.html#U_update_Z'>U_update_Z</a>()</code></li>
<li><code><a href='m-step.html#U_update_W'>U_update_W</a>()</code></li>
</ul>
<p>A <code>prox_dp</code> function, written in C, will be used.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="m-step.html#cb56-1" tabindex="-1"></a><span class="co">#&#39; Solve a fused lasso problem for the W update. Internally, a fused lasso dynamic</span></span>
<span id="cb56-2"><a href="m-step.html#cb56-2" tabindex="-1"></a><span class="co">#&#39; programming solver \code{<a href='m-step.html#prox'>prox</a>()} (which calls \code{prox_dp()} written in C)</span></span>
<span id="cb56-3"><a href="m-step.html#cb56-3" tabindex="-1"></a><span class="co">#&#39; is used.</span></span>
<span id="cb56-4"><a href="m-step.html#cb56-4" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb56-5"><a href="m-step.html#cb56-5" tabindex="-1"></a><span id='W_update_fused'>W_update_fused</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(l, TT, mu, uw, rho, lambda, Dl){</span>
<span id="cb56-6"><a href="m-step.html#cb56-6" tabindex="-1"></a></span>
<span id="cb56-7"><a href="m-step.html#cb56-7" tabindex="-1"></a>  <span class="co"># modified lambda for fused lasso routine</span></span>
<span id="cb56-8"><a href="m-step.html#cb56-8" tabindex="-1"></a>  mod_lam <span class="ot">&lt;-</span> lambda<span class="sc">/</span>rho</span>
<span id="cb56-9"><a href="m-step.html#cb56-9" tabindex="-1"></a></span>
<span id="cb56-10"><a href="m-step.html#cb56-10" tabindex="-1"></a>  <span class="co"># generating pseudo response xi</span></span>
<span id="cb56-11"><a href="m-step.html#cb56-11" tabindex="-1"></a>  <span class="cf">if</span>( l <span class="sc">&lt;</span> <span class="dv">0</span> ){</span>
<span id="cb56-12"><a href="m-step.html#cb56-12" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;l should never be /below/ zero!&quot;</span>)</span>
<span id="cb56-13"><a href="m-step.html#cb56-13" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span>( l <span class="sc">==</span> <span class="dv">0</span> ){</span>
<span id="cb56-14"><a href="m-step.html#cb56-14" tabindex="-1"></a>    xi <span class="ot">&lt;-</span> mu <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>rho <span class="sc">*</span> uw  <span class="do">## This is faster</span></span>
<span id="cb56-15"><a href="m-step.html#cb56-15" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb56-16"><a href="m-step.html#cb56-16" tabindex="-1"></a>    xi <span class="ot">&lt;-</span> Dl <span class="sc">%*%</span> mu <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>rho <span class="sc">*</span> uw</span>
<span id="cb56-17"><a href="m-step.html#cb56-17" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.nan</span>(xi))) <span class="fu">browser</span>()</span>
<span id="cb56-18"><a href="m-step.html#cb56-18" tabindex="-1"></a></span>
<span id="cb56-19"><a href="m-step.html#cb56-19" tabindex="-1"></a>    <span class="do">## l = 2 is quadratic trend filtering</span></span>
<span id="cb56-20"><a href="m-step.html#cb56-20" tabindex="-1"></a>    <span class="do">## l = 1 is linear trend filtering</span></span>
<span id="cb56-21"><a href="m-step.html#cb56-21" tabindex="-1"></a>    <span class="do">## l = 0 is fused lasso</span></span>
<span id="cb56-22"><a href="m-step.html#cb56-22" tabindex="-1"></a>    <span class="do">## D^{(1)} is first differences, so it correponds to l=0</span></span>
<span id="cb56-23"><a href="m-step.html#cb56-23" tabindex="-1"></a>    <span class="do">## Dl = <a href='trend-filtering.html#gen_diff_mat'>gen_diff_mat</a>(n = TT, l = l, x = x)  &lt;---  (T-l) x T matrix </span></span>
<span id="cb56-24"><a href="m-step.html#cb56-24" tabindex="-1"></a>  }</span>
<span id="cb56-25"><a href="m-step.html#cb56-25" tabindex="-1"></a></span>
<span id="cb56-26"><a href="m-step.html#cb56-26" tabindex="-1"></a>  <span class="do">## Running the fused LASSO</span></span>
<span id="cb56-27"><a href="m-step.html#cb56-27" tabindex="-1"></a>  <span class="do">## which solves min_zhat 1/2 |z-zhat|_2^2 + lambda |D^{(1)}zhat|</span></span>
<span id="cb56-28"><a href="m-step.html#cb56-28" tabindex="-1"></a>  <span class="do">## fit &lt;- <a href='m-step.html#prox'>prox</a>(z = xi, lam = mod_lam)</span></span>
<span id="cb56-29"><a href="m-step.html#cb56-29" tabindex="-1"></a>  <span class="do">## fit &lt;- prox_dp(z = xi, lam = mod_lam) ## instead of FlowTF::prox()</span></span>
<span id="cb56-30"><a href="m-step.html#cb56-30" tabindex="-1"></a>  <span class="do">## fit &lt;- flowtrendprox::prox_dp(z = xi, lam = mod_lam) </span></span>
<span id="cb56-31"><a href="m-step.html#cb56-31" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> FlowTF<span class="sc">::</span><a href='m-step.html#prox'>prox</a>(<span class="at">z =</span> xi, <span class="at">lam =</span> mod_lam) </span>
<span id="cb56-32"><a href="m-step.html#cb56-32" tabindex="-1"></a>  <span class="do">## </span><span class="al">TODO</span><span class="do">: eventually change to  fit &lt;- flowtrendprox::prox(z = xi, lam = mod_lam)</span></span>
<span id="cb56-33"><a href="m-step.html#cb56-33" tabindex="-1"></a></span>
<span id="cb56-34"><a href="m-step.html#cb56-34" tabindex="-1"></a>  <span class="fu">return</span>(fit)</span>
<span id="cb56-35"><a href="m-step.html#cb56-35" tabindex="-1"></a>}</span>
<span id="cb56-36"><a href="m-step.html#cb56-36" tabindex="-1"></a></span>
<span id="cb56-37"><a href="m-step.html#cb56-37" tabindex="-1"></a><span class="do">## This function is in FlowTF now. It&#39;s the last function there!</span></span>
<span id="cb56-38"><a href="m-step.html#cb56-38" tabindex="-1"></a><span class="do">## #&#39; Fused LASSO for scalar inputs.</span></span>
<span id="cb56-39"><a href="m-step.html#cb56-39" tabindex="-1"></a><span class="do">## #&#39;</span></span>
<span id="cb56-40"><a href="m-step.html#cb56-40" tabindex="-1"></a><span class="do">## #&#39; @param z scalar input to be smoothed via the fused LASSO</span></span>
<span id="cb56-41"><a href="m-step.html#cb56-41" tabindex="-1"></a><span class="do">## #&#39; @param lam  Fused LASSO smoothing parameter</span></span>
<span id="cb56-42"><a href="m-step.html#cb56-42" tabindex="-1"></a><span class="do">## #&#39;</span></span>
<span id="cb56-43"><a href="m-step.html#cb56-43" tabindex="-1"></a><span class="do">## #&#39; @return Estimates of the fused LASSO solution</span></span>
<span id="cb56-44"><a href="m-step.html#cb56-44" tabindex="-1"></a><span class="do">## #&#39; @export prox</span></span>
<span id="cb56-45"><a href="m-step.html#cb56-45" tabindex="-1"></a><span class="do">## #&#39;</span></span>
<span id="cb56-46"><a href="m-step.html#cb56-46" tabindex="-1"></a><span class="do">## #&#39; @references All credit for writing this function goes to Ryan Tibshirani. See</span></span>
<span id="cb56-47"><a href="m-step.html#cb56-47" tabindex="-1"></a><span class="do">## #&#39;   the original code for calling this function at</span></span>
<span id="cb56-48"><a href="m-step.html#cb56-48" tabindex="-1"></a><span class="do">## #&#39;</span></span>
<span id="cb56-49"><a href="m-step.html#cb56-49" tabindex="-1"></a><span class="do">## #&#39; @useDynLib FlowTF prox_dp </span></span>
<span id="cb56-50"><a href="m-step.html#cb56-50" tabindex="-1"></a><span class="do">## <span id='prox'>prox</span> &lt;-  function(z, lam) {</span></span>
<span id="cb56-51"><a href="m-step.html#cb56-51" tabindex="-1"></a><span class="do">##   o &lt;- .C(&quot;prox_dp&quot;,  </span></span>
<span id="cb56-52"><a href="m-step.html#cb56-52" tabindex="-1"></a><span class="do">##           as.integer(length(z)),</span></span>
<span id="cb56-53"><a href="m-step.html#cb56-53" tabindex="-1"></a><span class="do">##           as.double(z),</span></span>
<span id="cb56-54"><a href="m-step.html#cb56-54" tabindex="-1"></a><span class="do">##           as.double(lam),</span></span>
<span id="cb56-55"><a href="m-step.html#cb56-55" tabindex="-1"></a><span class="do">##           as.double(numeric(length(z))),</span></span>
<span id="cb56-56"><a href="m-step.html#cb56-56" tabindex="-1"></a><span class="do">##           #  dup=FALSE,</span></span>
<span id="cb56-57"><a href="m-step.html#cb56-57" tabindex="-1"></a><span class="do">##           PACKAGE=&quot;FlowTF&quot;)</span></span>
<span id="cb56-58"><a href="m-step.html#cb56-58" tabindex="-1"></a></span>
<span id="cb56-59"><a href="m-step.html#cb56-59" tabindex="-1"></a><span class="do">##   return(o[[4]])</span></span>
<span id="cb56-60"><a href="m-step.html#cb56-60" tabindex="-1"></a><span class="do">## }</span></span>
<span id="cb56-61"><a href="m-step.html#cb56-61" tabindex="-1"></a></span>
<span id="cb56-62"><a href="m-step.html#cb56-62" tabindex="-1"></a></span>
<span id="cb56-63"><a href="m-step.html#cb56-63" tabindex="-1"></a><span id='Z_update'>Z_update</span>  <span class="ot">&lt;-</span> <span class="cf">function</span>(m, Uz, C, rho){</span>
<span id="cb56-64"><a href="m-step.html#cb56-64" tabindex="-1"></a>  mat <span class="ot">=</span> m <span class="sc">+</span> Uz<span class="sc">/</span>rho</span>
<span id="cb56-65"><a href="m-step.html#cb56-65" tabindex="-1"></a>  Z <span class="ot">=</span> <a href='m-step.html#projCmat'>projCmat</a>(mat, C)</span>
<span id="cb56-66"><a href="m-step.html#cb56-66" tabindex="-1"></a>  <span class="fu">return</span>(Z)</span>
<span id="cb56-67"><a href="m-step.html#cb56-67" tabindex="-1"></a>}</span>
<span id="cb56-68"><a href="m-step.html#cb56-68" tabindex="-1"></a></span>
<span id="cb56-69"><a href="m-step.html#cb56-69" tabindex="-1"></a><span id='projCmat'>projCmat</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(mat, C){</span>
<span id="cb56-70"><a href="m-step.html#cb56-70" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(C)){</span>
<span id="cb56-71"><a href="m-step.html#cb56-71" tabindex="-1"></a>    vlens <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="fu">rowSums</span>(mat <span class="sc">*</span> mat))</span>
<span id="cb56-72"><a href="m-step.html#cb56-72" tabindex="-1"></a>    inds <span class="ot">=</span> <span class="fu">which</span>(vlens <span class="sc">&gt;</span> C)</span>
<span id="cb56-73"><a href="m-step.html#cb56-73" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(inds) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb56-74"><a href="m-step.html#cb56-74" tabindex="-1"></a>      mat[inds,] <span class="ot">=</span> mat[inds,] <span class="sc">*</span> C <span class="sc">/</span> vlens[inds]</span>
<span id="cb56-75"><a href="m-step.html#cb56-75" tabindex="-1"></a>    }</span>
<span id="cb56-76"><a href="m-step.html#cb56-76" tabindex="-1"></a>  }</span>
<span id="cb56-77"><a href="m-step.html#cb56-77" tabindex="-1"></a>  <span class="fu">return</span>(mat)</span>
<span id="cb56-78"><a href="m-step.html#cb56-78" tabindex="-1"></a>}</span>
<span id="cb56-79"><a href="m-step.html#cb56-79" tabindex="-1"></a></span>
<span id="cb56-80"><a href="m-step.html#cb56-80" tabindex="-1"></a><span class="co">#&#39; @param U (T x dimdat) matrix.</span></span>
<span id="cb56-81"><a href="m-step.html#cb56-81" tabindex="-1"></a><span id='U_update_Z'>U_update_Z</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(U, rho, mu, Z, TT){</span>
<span id="cb56-82"><a href="m-step.html#cb56-82" tabindex="-1"></a> <span class="co"># return(U + rho * (scale(mu, scale = F) - Z))</span></span>
<span id="cb56-83"><a href="m-step.html#cb56-83" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(U) <span class="sc">==</span> TT)</span>
<span id="cb56-84"><a href="m-step.html#cb56-84" tabindex="-1"></a>  Unew <span class="ot">=</span> U <span class="sc">+</span> rho <span class="sc">*</span> (mu <span class="sc">-</span> <span class="fu">colMeans</span>(mu) <span class="sc">-</span> Z)</span>
<span id="cb56-85"><a href="m-step.html#cb56-85" tabindex="-1"></a></span>
<span id="cb56-86"><a href="m-step.html#cb56-86" tabindex="-1"></a>  <span class="do">## Expect a (T-l) x dimdat matrix.</span></span>
<span id="cb56-87"><a href="m-step.html#cb56-87" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="fu">dim</span>(U) <span class="sc">==</span> <span class="fu">dim</span>(Unew))) </span>
<span id="cb56-88"><a href="m-step.html#cb56-88" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(U) <span class="sc">==</span> TT)</span>
<span id="cb56-89"><a href="m-step.html#cb56-89" tabindex="-1"></a>  <span class="fu">return</span>(Unew)</span>
<span id="cb56-90"><a href="m-step.html#cb56-90" tabindex="-1"></a>}</span>
<span id="cb56-91"><a href="m-step.html#cb56-91" tabindex="-1"></a></span>
<span id="cb56-92"><a href="m-step.html#cb56-92" tabindex="-1"></a><span class="co">#&#39; @param U ((T-l) x dimdat) matrix.</span></span>
<span id="cb56-93"><a href="m-step.html#cb56-93" tabindex="-1"></a><span id='U_update_W'>U_update_W</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(U, rho, mu, W, l, Dl, TT){</span>
<span id="cb56-94"><a href="m-step.html#cb56-94" tabindex="-1"></a></span>
<span id="cb56-95"><a href="m-step.html#cb56-95" tabindex="-1"></a>  <span class="co"># l = 2 is quadratic trend filtering </span></span>
<span id="cb56-96"><a href="m-step.html#cb56-96" tabindex="-1"></a>  <span class="co"># l = 1 is linear trend filtering</span></span>
<span id="cb56-97"><a href="m-step.html#cb56-97" tabindex="-1"></a>  <span class="co"># l = 0 is fused lasso</span></span>
<span id="cb56-98"><a href="m-step.html#cb56-98" tabindex="-1"></a>  <span class="co"># D^{(1)} is first differences, so it correponds to l=0</span></span>
<span id="cb56-99"><a href="m-step.html#cb56-99" tabindex="-1"></a>  <span class="co"># D^{(l+1)} is used for order-l trend filtering.</span></span>
<span id="cb56-100"><a href="m-step.html#cb56-100" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(W) <span class="sc">==</span> TT <span class="sc">-</span> l)</span>
<span id="cb56-101"><a href="m-step.html#cb56-101" tabindex="-1"></a>  <span class="do">## if(l == 0){</span></span>
<span id="cb56-102"><a href="m-step.html#cb56-102" tabindex="-1"></a>  <span class="do">##   Unew = U +  rho * (mu - W)</span></span>
<span id="cb56-103"><a href="m-step.html#cb56-103" tabindex="-1"></a>  <span class="do">## } else {</span></span>
<span id="cb56-104"><a href="m-step.html#cb56-104" tabindex="-1"></a>  <span class="do">##   Unew = U + rho * ( diff(mu, differences = l) - W)</span></span>
<span id="cb56-105"><a href="m-step.html#cb56-105" tabindex="-1"></a>  <span class="do">## }</span></span>
<span id="cb56-106"><a href="m-step.html#cb56-106" tabindex="-1"></a>  Unew <span class="ot">&lt;-</span> U <span class="sc">+</span> rho <span class="sc">*</span> (Dl <span class="sc">%*%</span> mu <span class="sc">-</span> W)</span>
<span id="cb56-107"><a href="m-step.html#cb56-107" tabindex="-1"></a></span>
<span id="cb56-108"><a href="m-step.html#cb56-108" tabindex="-1"></a>  <span class="do">## Expect a (T-l) x dimdat matrix.</span></span>
<span id="cb56-109"><a href="m-step.html#cb56-109" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="fu">dim</span>(U) <span class="sc">==</span> <span class="fu">dim</span>(Unew))) </span>
<span id="cb56-110"><a href="m-step.html#cb56-110" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(U) <span class="sc">==</span> TT<span class="sc">-</span>l)</span>
<span id="cb56-111"><a href="m-step.html#cb56-111" tabindex="-1"></a>  <span class="fu">return</span>(Unew)</span>
<span id="cb56-112"><a href="m-step.html#cb56-112" tabindex="-1"></a>}</span></code></pre></div>
<p>Here is that main workhorse <code><a href='m-step.html#admm_oneclust'>admm_oneclust</a>()</code>.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="m-step.html#cb57-1" tabindex="-1"></a><span class="co">#&#39; One cluster&#39;s admm for a fixed step size (rho).</span></span>
<span id="cb57-2"><a href="m-step.html#cb57-2" tabindex="-1"></a><span id='admm_oneclust'>admm_oneclust</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">iclust =</span> <span class="dv">1</span>, niter, y,</span>
<span id="cb57-3"><a href="m-step.html#cb57-3" tabindex="-1"></a>                          Dl, tDl, Dlp1, <span class="at">l =</span> <span class="cn">NULL</span>,</span>
<span id="cb57-4"><a href="m-step.html#cb57-4" tabindex="-1"></a>                          TT, N, dimdat, maxdev,</span>
<span id="cb57-5"><a href="m-step.html#cb57-5" tabindex="-1"></a>                          rho,</span>
<span id="cb57-6"><a href="m-step.html#cb57-6" tabindex="-1"></a>                          <span class="at">rhoinit =</span> rho,</span>
<span id="cb57-7"><a href="m-step.html#cb57-7" tabindex="-1"></a>                          Xinv,</span>
<span id="cb57-8"><a href="m-step.html#cb57-8" tabindex="-1"></a>                          schurA,</span>
<span id="cb57-9"><a href="m-step.html#cb57-9" tabindex="-1"></a>                          schurB,</span>
<span id="cb57-10"><a href="m-step.html#cb57-10" tabindex="-1"></a>                          sigmainv,</span>
<span id="cb57-11"><a href="m-step.html#cb57-11" tabindex="-1"></a>                          lambda,</span>
<span id="cb57-12"><a href="m-step.html#cb57-12" tabindex="-1"></a>                          resp,</span>
<span id="cb57-13"><a href="m-step.html#cb57-13" tabindex="-1"></a>                          resp_sum,</span>
<span id="cb57-14"><a href="m-step.html#cb57-14" tabindex="-1"></a>                          ylist, <span class="at">err_rel =</span> <span class="fl">1e-3</span>, <span class="at">err_abs =</span> <span class="dv">0</span>,</span>
<span id="cb57-15"><a href="m-step.html#cb57-15" tabindex="-1"></a>                          zerothresh,</span>
<span id="cb57-16"><a href="m-step.html#cb57-16" tabindex="-1"></a>                          mu, </span>
<span id="cb57-17"><a href="m-step.html#cb57-17" tabindex="-1"></a>                          z,</span>
<span id="cb57-18"><a href="m-step.html#cb57-18" tabindex="-1"></a>                          w,</span>
<span id="cb57-19"><a href="m-step.html#cb57-19" tabindex="-1"></a>                          uw,</span>
<span id="cb57-20"><a href="m-step.html#cb57-20" tabindex="-1"></a>                          uz,</span>
<span id="cb57-21"><a href="m-step.html#cb57-21" tabindex="-1"></a>                          <span class="do">## warmstart = FALSE,</span></span>
<span id="cb57-22"><a href="m-step.html#cb57-22" tabindex="-1"></a>                          <span class="do">## mu.warm = if(!warmstart) NULL,</span></span>
<span id="cb57-23"><a href="m-step.html#cb57-23" tabindex="-1"></a>                          first_iter,<span class="do">## Not used </span></span>
<span id="cb57-24"><a href="m-step.html#cb57-24" tabindex="-1"></a>                          iter,</span>
<span id="cb57-25"><a href="m-step.html#cb57-25" tabindex="-1"></a>                          outer_iter,</span>
<span id="cb57-26"><a href="m-step.html#cb57-26" tabindex="-1"></a>                          local_adapt,</span>
<span id="cb57-27"><a href="m-step.html#cb57-27" tabindex="-1"></a>                          sigma,</span>
<span id="cb57-28"><a href="m-step.html#cb57-28" tabindex="-1"></a>                          sigma_eig_by_clust){</span>
<span id="cb57-29"><a href="m-step.html#cb57-29" tabindex="-1"></a></span>
<span id="cb57-30"><a href="m-step.html#cb57-30" tabindex="-1"></a>  <span class="do">## Initialize the variables </span><span class="al">###</span></span>
<span id="cb57-31"><a href="m-step.html#cb57-31" tabindex="-1"></a>  <span class="do">## resid_mat = matrix(NA, nrow = ceiling(niter/5), ncol = 4)</span></span>
<span id="cb57-32"><a href="m-step.html#cb57-32" tabindex="-1"></a>  <span class="do">## colnames(resid_mat) = c(&quot;primresid&quot;, &quot;primerr&quot;, &quot;dualresid&quot;, &quot;dualerr&quot;)</span></span>
<span id="cb57-33"><a href="m-step.html#cb57-33" tabindex="-1"></a>  resid_mat <span class="ot">=</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">ceiling</span>(niter<span class="sc">/</span><span class="dv">5</span>), <span class="at">ncol =</span> <span class="dv">6</span>)</span>
<span id="cb57-34"><a href="m-step.html#cb57-34" tabindex="-1"></a>  <span class="fu">colnames</span>(resid_mat) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;prim1&quot;</span>, <span class="st">&quot;prim2&quot;</span>, <span class="st">&quot;primresid&quot;</span>, <span class="st">&quot;primerr&quot;</span>, <span class="st">&quot;dualresid&quot;</span>, <span class="st">&quot;dualerr&quot;</span>)</span>
<span id="cb57-35"><a href="m-step.html#cb57-35" tabindex="-1"></a>  rhofac <span class="ot">=</span> rho <span class="sc">/</span> rhoinit </span>
<span id="cb57-36"><a href="m-step.html#cb57-36" tabindex="-1"></a></span>
<span id="cb57-37"><a href="m-step.html#cb57-37" tabindex="-1"></a>  </span>
<span id="cb57-38"><a href="m-step.html#cb57-38" tabindex="-1"></a></span>
<span id="cb57-39"><a href="m-step.html#cb57-39" tabindex="-1"></a>  <span class="do">## This doesn&#39;t change over iterations</span></span>
<span id="cb57-40"><a href="m-step.html#cb57-40" tabindex="-1"></a>  schurB <span class="ot">=</span> <a href='m-step.html#myschur'>myschur</a>(schurB<span class="sc">$</span>orig <span class="sc">*</span> rhofac) <span class="do">## In flowmix, this is done on A. Here, it&#39;s done on B (in AX + XB + C = 0).</span></span>
<span id="cb57-41"><a href="m-step.html#cb57-41" tabindex="-1"></a>  TA <span class="ot">=</span> schurA<span class="sc">$</span>T <span class="do">##* rhofac</span></span>
<span id="cb57-42"><a href="m-step.html#cb57-42" tabindex="-1"></a>  TB <span class="ot">=</span> schurB<span class="sc">$</span>T</span>
<span id="cb57-43"><a href="m-step.html#cb57-43" tabindex="-1"></a>  UA <span class="ot">=</span> schurA<span class="sc">$</span>Q</span>
<span id="cb57-44"><a href="m-step.html#cb57-44" tabindex="-1"></a>  UB <span class="ot">=</span> schurB<span class="sc">$</span>Q</span>
<span id="cb57-45"><a href="m-step.html#cb57-45" tabindex="-1"></a>  tUA <span class="ot">=</span> schurA<span class="sc">$</span>tQ</span>
<span id="cb57-46"><a href="m-step.html#cb57-46" tabindex="-1"></a>  tUB <span class="ot">=</span> schurB<span class="sc">$</span>tQ</span>
<span id="cb57-47"><a href="m-step.html#cb57-47" tabindex="-1"></a></span>
<span id="cb57-48"><a href="m-step.html#cb57-48" tabindex="-1"></a>  <span class="do">## This also doesn&#39;t change over iterations</span></span>
<span id="cb57-49"><a href="m-step.html#cb57-49" tabindex="-1"></a>  C1 <span class="ot">&lt;-</span> <span class="fu">do.call</span>(cbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(tt){</span>
<span id="cb57-50"><a href="m-step.html#cb57-50" tabindex="-1"></a>      multmat <span class="ot">&lt;-</span> <span class="fu">apply</span>(y[[tt]], <span class="at">FUN =</span> <span class="cf">function</span>(yy) yy <span class="sc">*</span> resp[[tt]], <span class="at">MARGIN =</span> <span class="dv">2</span>)</span>
<span id="cb57-51"><a href="m-step.html#cb57-51" tabindex="-1"></a>      sigmainv <span class="sc">%*%</span> <span class="fu">colSums</span>(multmat)</span>
<span id="cb57-52"><a href="m-step.html#cb57-52" tabindex="-1"></a>    }))</span>
<span id="cb57-53"><a href="m-step.html#cb57-53" tabindex="-1"></a></span>
<span id="cb57-54"><a href="m-step.html#cb57-54" tabindex="-1"></a></span>
<span id="cb57-55"><a href="m-step.html#cb57-55" tabindex="-1"></a>  <span class="cf">for</span>(iter <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>niter){</span>
<span id="cb57-56"><a href="m-step.html#cb57-56" tabindex="-1"></a>    syl_C <span class="ot">&lt;-</span> <a href='m-step.html#get_C_mat'>get_C_mat</a>(<span class="at">C1 =</span> C1, <span class="at">resp_sum =</span> resp_sum, <span class="at">TT =</span> TT, <span class="at">dimdat =</span> dimdat,</span>
<span id="cb57-57"><a href="m-step.html#cb57-57" tabindex="-1"></a>                       <span class="at">Sigma_inv =</span> sigmainv, <span class="at">N =</span> N, <span class="at">Dl =</span> Dl, <span class="at">rho =</span> rho,</span>
<span id="cb57-58"><a href="m-step.html#cb57-58" tabindex="-1"></a>                       <span class="at">z =</span> z, <span class="at">w =</span> w, <span class="at">uz =</span> uz, <span class="at">uw =</span> uw, <span class="at">l=</span>l)</span>
<span id="cb57-59"><a href="m-step.html#cb57-59" tabindex="-1"></a>    FF <span class="ot">=</span>  (<span class="sc">-</span><span class="dv">1</span>) <span class="sc">*</span> tUA <span class="sc">%*%</span> syl_C <span class="sc">%*%</span> UB</span>
<span id="cb57-60"><a href="m-step.html#cb57-60" tabindex="-1"></a>    mu <span class="ot">=</span> UA <span class="sc">%*%</span> <span class="fu">matrix_function_solve_triangular_sylvester_barebonesC2</span>(TA, TB, FF) <span class="sc">%*%</span> tUB</span>
<span id="cb57-61"><a href="m-step.html#cb57-61" tabindex="-1"></a>    mu <span class="ot">=</span> <span class="fu">t</span>(mu)</span>
<span id="cb57-62"><a href="m-step.html#cb57-62" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(mu) <span class="sc">==</span> TT)</span>
<span id="cb57-63"><a href="m-step.html#cb57-63" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">ncol</span>(mu) <span class="sc">==</span> dimdat)</span>
<span id="cb57-64"><a href="m-step.html#cb57-64" tabindex="-1"></a></span>
<span id="cb57-65"><a href="m-step.html#cb57-65" tabindex="-1"></a>    <span class="do">## if(warmstart &amp; iter == 1){</span></span>
<span id="cb57-66"><a href="m-step.html#cb57-66" tabindex="-1"></a>    <span class="do">##   print(&quot;warmed up mu!&quot;)</span></span>
<span id="cb57-67"><a href="m-step.html#cb57-67" tabindex="-1"></a>    <span class="do">##   mu = mu.warm</span></span>
<span id="cb57-68"><a href="m-step.html#cb57-68" tabindex="-1"></a>    <span class="do">## }</span></span>
<span id="cb57-69"><a href="m-step.html#cb57-69" tabindex="-1"></a></span>
<span id="cb57-70"><a href="m-step.html#cb57-70" tabindex="-1"></a>    z <span class="ot">&lt;-</span> <a href='m-step.html#Z_update'>Z_update</a>(mu <span class="sc">-</span> <span class="fu">colMeans</span>(mu), <span class="at">Uz =</span> uz, <span class="at">C =</span> maxdev, <span class="at">rho =</span> rho)</span>
<span id="cb57-71"><a href="m-step.html#cb57-71" tabindex="-1"></a></span>
<span id="cb57-72"><a href="m-step.html#cb57-72" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">abs</span>(mu)<span class="sc">&gt;</span><span class="fl">1E2</span>)){</span>
<span id="cb57-73"><a href="m-step.html#cb57-73" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">&quot;mu is blowing up!&quot;</span>)</span>
<span id="cb57-74"><a href="m-step.html#cb57-74" tabindex="-1"></a>      <span class="fu">browser</span>()</span>
<span id="cb57-75"><a href="m-step.html#cb57-75" tabindex="-1"></a>      <span class="do">## break</span></span>
<span id="cb57-76"><a href="m-step.html#cb57-76" tabindex="-1"></a>    }</span>
<span id="cb57-77"><a href="m-step.html#cb57-77" tabindex="-1"></a>    wlist <span class="ot">=</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>dimdat, <span class="cf">function</span>(j){</span>
<span id="cb57-78"><a href="m-step.html#cb57-78" tabindex="-1"></a>      <a href='m-step.html#W_update_fused'>W_update_fused</a>(<span class="at">l =</span> l, <span class="at">TT =</span> TT, <span class="at">mu =</span> mu[, j, <span class="at">drop =</span> <span class="cn">TRUE</span>],</span>
<span id="cb57-79"><a href="m-step.html#cb57-79" tabindex="-1"></a>                     <span class="at">rho =</span> rho, <span class="at">lambda =</span> lambda,</span>
<span id="cb57-80"><a href="m-step.html#cb57-80" tabindex="-1"></a>                     <span class="at">uw =</span> uw[,j,<span class="at">drop=</span><span class="cn">TRUE</span>],</span>
<span id="cb57-81"><a href="m-step.html#cb57-81" tabindex="-1"></a>                     <span class="at">Dl =</span> Dl)})</span>
<span id="cb57-82"><a href="m-step.html#cb57-82" tabindex="-1"></a>    w <span class="ot">&lt;-</span> <span class="fu">do.call</span>(cbind, wlist)</span>
<span id="cb57-83"><a href="m-step.html#cb57-83" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(w) <span class="sc">==</span> TT<span class="sc">-</span>l)</span>
<span id="cb57-84"><a href="m-step.html#cb57-84" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">ncol</span>(w) <span class="sc">==</span> dimdat)</span>
<span id="cb57-85"><a href="m-step.html#cb57-85" tabindex="-1"></a></span>
<span id="cb57-86"><a href="m-step.html#cb57-86" tabindex="-1"></a></span>
<span id="cb57-87"><a href="m-step.html#cb57-87" tabindex="-1"></a>    uz <span class="ot">=</span> <a href='m-step.html#U_update_Z'>U_update_Z</a>(uz, rho, mu, z, TT)</span>
<span id="cb57-88"><a href="m-step.html#cb57-88" tabindex="-1"></a></span>
<span id="cb57-89"><a href="m-step.html#cb57-89" tabindex="-1"></a></span>
<span id="cb57-90"><a href="m-step.html#cb57-90" tabindex="-1"></a>    <span class="do">## uw = <a href='m-step.html#U_update_W'>U_update_W</a>(uw, rho, mu, w, l, TT)</span></span>
<span id="cb57-91"><a href="m-step.html#cb57-91" tabindex="-1"></a>    uw <span class="ot">=</span> <a href='m-step.html#U_update_W'>U_update_W</a>(uw, rho, mu, w, l, Dl, TT)</span>
<span id="cb57-92"><a href="m-step.html#cb57-92" tabindex="-1"></a></span>
<span id="cb57-93"><a href="m-step.html#cb57-93" tabindex="-1"></a></span>
<span id="cb57-94"><a href="m-step.html#cb57-94" tabindex="-1"></a>    <span class="do">## Check convergence</span></span>
<span id="cb57-95"><a href="m-step.html#cb57-95" tabindex="-1"></a>    <span class="cf">if</span>( iter <span class="sc">&gt;</span> <span class="dv">1</span>  <span class="sc">&amp;</span> iter <span class="sc">%%</span> <span class="dv">5</span> <span class="sc">==</span> <span class="dv">0</span>){<span class="do">## &amp; !local_adapt){</span></span>
<span id="cb57-96"><a href="m-step.html#cb57-96" tabindex="-1"></a></span>
<span id="cb57-97"><a href="m-step.html#cb57-97" tabindex="-1"></a>      <span class="do">## Calculate convergence criterion</span></span>
<span id="cb57-98"><a href="m-step.html#cb57-98" tabindex="-1"></a>      obj <span class="ot">=</span> <a href='m-step.html#check_converge'>check_converge</a>(mu, rho,</span>
<span id="cb57-99"><a href="m-step.html#cb57-99" tabindex="-1"></a>                           w, z,</span>
<span id="cb57-100"><a href="m-step.html#cb57-100" tabindex="-1"></a>                           w_prev, z_prev,</span>
<span id="cb57-101"><a href="m-step.html#cb57-101" tabindex="-1"></a>                           uw, uz,</span>
<span id="cb57-102"><a href="m-step.html#cb57-102" tabindex="-1"></a>                           Dl, tDl, <span class="at">err_rel =</span> err_rel, <span class="at">err_abs =</span> err_abs)</span>
<span id="cb57-103"><a href="m-step.html#cb57-103" tabindex="-1"></a></span>
<span id="cb57-104"><a href="m-step.html#cb57-104" tabindex="-1"></a>      jj <span class="ot">=</span> (iter<span class="sc">/</span> <span class="dv">5</span>)</span>
<span id="cb57-105"><a href="m-step.html#cb57-105" tabindex="-1"></a>      resid_mat[jj,] <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb57-106"><a href="m-step.html#cb57-106" tabindex="-1"></a>          <span class="fu">norm</span>(obj<span class="sc">$</span>primal_resid1, <span class="st">&quot;F&quot;</span>), <span class="do">## Temp</span></span>
<span id="cb57-107"><a href="m-step.html#cb57-107" tabindex="-1"></a>          <span class="fu">norm</span>(obj<span class="sc">$</span>primal_resid2, <span class="st">&quot;F&quot;</span>), <span class="do">## Temp</span></span>
<span id="cb57-108"><a href="m-step.html#cb57-108" tabindex="-1"></a>          <span class="fu">norm</span>(obj<span class="sc">$</span>primal_resid, <span class="st">&quot;F&quot;</span>),</span>
<span id="cb57-109"><a href="m-step.html#cb57-109" tabindex="-1"></a>                         obj<span class="sc">$</span>primal_err,</span>
<span id="cb57-110"><a href="m-step.html#cb57-110" tabindex="-1"></a>                         <span class="fu">norm</span>(obj<span class="sc">$</span>dual_resid,<span class="st">&quot;F&quot;</span>),</span>
<span id="cb57-111"><a href="m-step.html#cb57-111" tabindex="-1"></a>                         obj<span class="sc">$</span>dual_err)</span>
<span id="cb57-112"><a href="m-step.html#cb57-112" tabindex="-1"></a></span>
<span id="cb57-113"><a href="m-step.html#cb57-113" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.na</span>(obj<span class="sc">$</span>converge)){</span>
<span id="cb57-114"><a href="m-step.html#cb57-114" tabindex="-1"></a>        obj<span class="sc">$</span>converge <span class="ot">&lt;-</span> converge <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb57-115"><a href="m-step.html#cb57-115" tabindex="-1"></a>        <span class="fu">warning</span>(<span class="st">&quot;Convergence was NA&quot;</span>)</span>
<span id="cb57-116"><a href="m-step.html#cb57-116" tabindex="-1"></a>      }</span>
<span id="cb57-117"><a href="m-step.html#cb57-117" tabindex="-1"></a>      <span class="cf">if</span>(obj<span class="sc">$</span>converge){</span>
<span id="cb57-118"><a href="m-step.html#cb57-118" tabindex="-1"></a>        converge <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb57-119"><a href="m-step.html#cb57-119" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb57-120"><a href="m-step.html#cb57-120" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb57-121"><a href="m-step.html#cb57-121" tabindex="-1"></a>        converge <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb57-122"><a href="m-step.html#cb57-122" tabindex="-1"></a>      }</span>
<span id="cb57-123"><a href="m-step.html#cb57-123" tabindex="-1"></a>    }</span>
<span id="cb57-124"><a href="m-step.html#cb57-124" tabindex="-1"></a>    w_prev <span class="ot">=</span> w</span>
<span id="cb57-125"><a href="m-step.html#cb57-125" tabindex="-1"></a>    z_prev <span class="ot">=</span> z</span>
<span id="cb57-126"><a href="m-step.html#cb57-126" tabindex="-1"></a>  }</span>
<span id="cb57-127"><a href="m-step.html#cb57-127" tabindex="-1"></a></span>
<span id="cb57-128"><a href="m-step.html#cb57-128" tabindex="-1"></a>  <span class="cf">if</span>(<span class="cn">FALSE</span>){</span>
<span id="cb57-129"><a href="m-step.html#cb57-129" tabindex="-1"></a>    <span class="do">## Calculate optimization objective values for this cluster.</span></span>
<span id="cb57-130"><a href="m-step.html#cb57-130" tabindex="-1"></a>    obj.value <span class="ot">&lt;-</span> <a href='m-step.html#objective_per_cluster'>objective_per_cluster</a>(<span class="at">y =</span> y, <span class="at">mu =</span> mu, <span class="at">resp =</span> resp,</span>
<span id="cb57-131"><a href="m-step.html#cb57-131" tabindex="-1"></a>                                       <span class="at">Sigma_inv =</span> sigmainv, <span class="at">TT =</span> TT,</span>
<span id="cb57-132"><a href="m-step.html#cb57-132" tabindex="-1"></a>                                       <span class="at">d =</span> dimdat, <span class="at">Dlp1 =</span> Dlp1, <span class="at">Dl =</span> Dl, <span class="at">l =</span> l,</span>
<span id="cb57-133"><a href="m-step.html#cb57-133" tabindex="-1"></a>                                       <span class="at">maxdev =</span> maxdev, <span class="at">lambda =</span> lambda,</span>
<span id="cb57-134"><a href="m-step.html#cb57-134" tabindex="-1"></a>                                       <span class="at">rho =</span> rho, <span class="at">N =</span> N)</span>
<span id="cb57-135"><a href="m-step.html#cb57-135" tabindex="-1"></a>    <span class="do">## This is very expensive to do within each ADMM iteration, so it&#39;s commented out for now.</span></span>
<span id="cb57-136"><a href="m-step.html#cb57-136" tabindex="-1"></a>  }</span>
<span id="cb57-137"><a href="m-step.html#cb57-137" tabindex="-1"></a>  obj.value <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb57-138"><a href="m-step.html#cb57-138" tabindex="-1"></a></span>
<span id="cb57-139"><a href="m-step.html#cb57-139" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mu =</span> mu,</span>
<span id="cb57-140"><a href="m-step.html#cb57-140" tabindex="-1"></a>              <span class="at">resid_mat =</span> resid_mat,</span>
<span id="cb57-141"><a href="m-step.html#cb57-141" tabindex="-1"></a>              <span class="at">converge =</span> converge,</span>
<span id="cb57-142"><a href="m-step.html#cb57-142" tabindex="-1"></a>              <span class="do">## Other variables to return.</span></span>
<span id="cb57-143"><a href="m-step.html#cb57-143" tabindex="-1"></a>              <span class="at">Z =</span> z,</span>
<span id="cb57-144"><a href="m-step.html#cb57-144" tabindex="-1"></a>              <span class="at">W =</span> w,</span>
<span id="cb57-145"><a href="m-step.html#cb57-145" tabindex="-1"></a>              <span class="at">uz =</span> uz,</span>
<span id="cb57-146"><a href="m-step.html#cb57-146" tabindex="-1"></a>              <span class="at">uw =</span> uw,</span>
<span id="cb57-147"><a href="m-step.html#cb57-147" tabindex="-1"></a>              <span class="at">inner.iter =</span> iter,</span>
<span id="cb57-148"><a href="m-step.html#cb57-148" tabindex="-1"></a>              <span class="at">single_admm_objective =</span> obj.value))</span>
<span id="cb57-149"><a href="m-step.html#cb57-149" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="helpers-for-m-step-mu" class="section level2 hasAnchor" number="9.4">
<h2><span class="header-section-number">9.4</span> Helpers for M step (<span class="math inline">\(\mu\)</span>)<a href="m-step.html#helpers-for-m-step-mu" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>First, let’s start with a few R functions.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="m-step.html#cb58-1" tabindex="-1"></a><span class="co">#&#39; @param TT Number of time points.</span></span>
<span id="cb58-2"><a href="m-step.html#cb58-2" tabindex="-1"></a><span id='etilde_mat'>etilde_mat</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(TT){</span>
<span id="cb58-3"><a href="m-step.html#cb58-3" tabindex="-1"></a></span>
<span id="cb58-4"><a href="m-step.html#cb58-4" tabindex="-1"></a>  mats <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(t){</span>
<span id="cb58-5"><a href="m-step.html#cb58-5" tabindex="-1"></a>    e_vec <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, TT)</span>
<span id="cb58-6"><a href="m-step.html#cb58-6" tabindex="-1"></a>    e_vec[t] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb58-7"><a href="m-step.html#cb58-7" tabindex="-1"></a>    (e_vec <span class="sc">-</span> <span class="dv">1</span><span class="sc">/</span>TT) <span class="sc">%*%</span> <span class="fu">t</span>(e_vec <span class="sc">-</span> <span class="dv">1</span><span class="sc">/</span>TT)</span>
<span id="cb58-8"><a href="m-step.html#cb58-8" tabindex="-1"></a>  })</span>
<span id="cb58-9"><a href="m-step.html#cb58-9" tabindex="-1"></a>  <span class="fu">Reduce</span>(<span class="st">&#39;+&#39;</span>, mats)</span>
<span id="cb58-10"><a href="m-step.html#cb58-10" tabindex="-1"></a>}</span>
<span id="cb58-11"><a href="m-step.html#cb58-11" tabindex="-1"></a></span>
<span id="cb58-12"><a href="m-step.html#cb58-12" tabindex="-1"></a><span id='get_AB_mats'>get_AB_mats</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(y, resp, Sigma_inv, e_mat, Dlsqrd, N, Dlp1, Dl, rho, z, w, uz, uw){</span>
<span id="cb58-13"><a href="m-step.html#cb58-13" tabindex="-1"></a></span>
<span id="cb58-14"><a href="m-step.html#cb58-14" tabindex="-1"></a>  <span class="co"># A matrix</span></span>
<span id="cb58-15"><a href="m-step.html#cb58-15" tabindex="-1"></a>  A <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> Sigma_inv</span>
<span id="cb58-16"><a href="m-step.html#cb58-16" tabindex="-1"></a></span>
<span id="cb58-17"><a href="m-step.html#cb58-17" tabindex="-1"></a>  <span class="co"># B matrix</span></span>
<span id="cb58-18"><a href="m-step.html#cb58-18" tabindex="-1"></a>  sum_resp <span class="ot">&lt;-</span> <span class="fu">sapply</span>(resp, sum)</span>
<span id="cb58-19"><a href="m-step.html#cb58-19" tabindex="-1"></a>  <span class="co">#B &lt;- rho*(t(Dl)%*%Dl + e_mat)%*% diag(1/unlist(sum_resp))</span></span>
<span id="cb58-20"><a href="m-step.html#cb58-20" tabindex="-1"></a>  B <span class="ot">&lt;-</span> rho<span class="sc">*</span>(Dlsqrd <span class="sc">+</span> e_mat)</span>
<span id="cb58-21"><a href="m-step.html#cb58-21" tabindex="-1"></a>  B <span class="ot">&lt;-</span> B<span class="sc">/</span>sum_resp[<span class="fu">col</span>(B)]</span>
<span id="cb58-22"><a href="m-step.html#cb58-22" tabindex="-1"></a>  <span class="co">#B &lt;- rho*(Dlsqrd + e_mat)  %*% diag(1/unlist(sum_resp))</span></span>
<span id="cb58-23"><a href="m-step.html#cb58-23" tabindex="-1"></a></span>
<span id="cb58-24"><a href="m-step.html#cb58-24" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">A =</span> A, <span class="at">B =</span> B))</span>
<span id="cb58-25"><a href="m-step.html#cb58-25" tabindex="-1"></a>}</span>
<span id="cb58-26"><a href="m-step.html#cb58-26" tabindex="-1"></a></span>
<span id="cb58-27"><a href="m-step.html#cb58-27" tabindex="-1"></a><span id='get_C_mat'>get_C_mat</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(C1, resp_sum, TT, dimdat, Sigma_inv, e_mat, N, Dlp1, Dl,</span>
<span id="cb58-28"><a href="m-step.html#cb58-28" tabindex="-1"></a>                      rho, z, w, uz, uw, l){</span>
<span id="cb58-29"><a href="m-step.html#cb58-29" tabindex="-1"></a></span>
<span id="cb58-30"><a href="m-step.html#cb58-30" tabindex="-1"></a>  C2 <span class="ot">&lt;-</span> <span class="fu">t</span>(uz <span class="sc">-</span> rho<span class="sc">*</span>z)</span>
<span id="cb58-31"><a href="m-step.html#cb58-31" tabindex="-1"></a></span>
<span id="cb58-32"><a href="m-step.html#cb58-32" tabindex="-1"></a>  <span class="co"># averaging</span></span>
<span id="cb58-33"><a href="m-step.html#cb58-33" tabindex="-1"></a>  C2 <span class="ot">&lt;-</span> C2 <span class="sc">-</span> <span class="fu">rowMeans</span>(C2)</span>
<span id="cb58-34"><a href="m-step.html#cb58-34" tabindex="-1"></a></span>
<span id="cb58-35"><a href="m-step.html#cb58-35" tabindex="-1"></a>  <span class="co"># third component</span></span>
<span id="cb58-36"><a href="m-step.html#cb58-36" tabindex="-1"></a>  C3 <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>dimdat, <span class="at">FUN =</span> <span class="cf">function</span>(j){</span>
<span id="cb58-37"><a href="m-step.html#cb58-37" tabindex="-1"></a>    ((uw[,j, <span class="at">drop=</span><span class="cn">TRUE</span>] <span class="sc">-</span> rho <span class="sc">*</span> w[,j,<span class="at">drop=</span><span class="cn">TRUE</span>]) <span class="sc">%*%</span> Dl) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb58-38"><a href="m-step.html#cb58-38" tabindex="-1"></a>  }))</span>
<span id="cb58-39"><a href="m-step.html#cb58-39" tabindex="-1"></a></span>
<span id="cb58-40"><a href="m-step.html#cb58-40" tabindex="-1"></a>  <span class="co"># combining</span></span>
<span id="cb58-41"><a href="m-step.html#cb58-41" tabindex="-1"></a>  C <span class="ot">&lt;-</span>  (<span class="sc">-</span><span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> C1 <span class="sc">+</span> C2 <span class="sc">+</span> C3)</span>
<span id="cb58-42"><a href="m-step.html#cb58-42" tabindex="-1"></a>  C <span class="ot">&lt;-</span> C<span class="sc">/</span>resp_sum[<span class="fu">col</span>(C)]</span>
<span id="cb58-43"><a href="m-step.html#cb58-43" tabindex="-1"></a>  <span class="fu">return</span>(C)</span>
<span id="cb58-44"><a href="m-step.html#cb58-44" tabindex="-1"></a>}</span>
<span id="cb58-45"><a href="m-step.html#cb58-45" tabindex="-1"></a></span>
<span id="cb58-46"><a href="m-step.html#cb58-46" tabindex="-1"></a></span>
<span id="cb58-47"><a href="m-step.html#cb58-47" tabindex="-1"></a><span class="co">#&#39; @param mat Matrix to Schur-decompose.</span></span>
<span id="cb58-48"><a href="m-step.html#cb58-48" tabindex="-1"></a><span id='myschur'>myschur</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(mat){</span>
<span id="cb58-49"><a href="m-step.html#cb58-49" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(mat) <span class="sc">==</span> <span class="fu">ncol</span>(mat))</span>
<span id="cb58-50"><a href="m-step.html#cb58-50" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.numeric</span>(mat) <span class="sc">&amp;</span> <span class="fu">length</span>(mat)<span class="sc">==</span><span class="dv">1</span>) mat <span class="ot">=</span> mat <span class="sc">%&gt;%</span> <span class="fu">as.matrix</span>()</span>
<span id="cb58-51"><a href="m-step.html#cb58-51" tabindex="-1"></a>  obj <span class="ot">=</span> Matrix<span class="sc">::</span><span class="fu">Schur</span>(mat)</span>
<span id="cb58-52"><a href="m-step.html#cb58-52" tabindex="-1"></a>  obj<span class="sc">$</span>tQ <span class="ot">=</span> <span class="fu">t</span>(obj<span class="sc">$</span>Q)</span>
<span id="cb58-53"><a href="m-step.html#cb58-53" tabindex="-1"></a>  obj<span class="sc">$</span>orig <span class="ot">=</span> mat</span>
<span id="cb58-54"><a href="m-step.html#cb58-54" tabindex="-1"></a>  <span class="fu">return</span>(obj)</span>
<span id="cb58-55"><a href="m-step.html#cb58-55" tabindex="-1"></a>}</span></code></pre></div>
<p>Here’s a function to check convergence of the ADMM with a fixed step size.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="m-step.html#cb59-1" tabindex="-1"></a><span class="co">#&#39; Check convergence of ADMM with a fixed step size (rho).</span></span>
<span id="cb59-2"><a href="m-step.html#cb59-2" tabindex="-1"></a><span id='check_converge'>check_converge</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(mu, rho, w, z, w_prev, z_prev, uw, uz, Dl, tDl,</span>
<span id="cb59-3"><a href="m-step.html#cb59-3" tabindex="-1"></a>                     <span class="at">err_rel =</span> <span class="fl">1E-4</span>,</span>
<span id="cb59-4"><a href="m-step.html#cb59-4" tabindex="-1"></a>                     <span class="at">err_abs =</span> <span class="dv">0</span></span>
<span id="cb59-5"><a href="m-step.html#cb59-5" tabindex="-1"></a>){</span>
<span id="cb59-6"><a href="m-step.html#cb59-6" tabindex="-1"></a></span>
<span id="cb59-7"><a href="m-step.html#cb59-7" tabindex="-1"></a>  <span class="do">## Constraints are: Ax + Bz =c, where x = mu, z =(w, z)</span></span>
<span id="cb59-8"><a href="m-step.html#cb59-8" tabindex="-1"></a>  prim1 <span class="ot">=</span> <span class="fu">rbind</span>(Dl <span class="sc">%*%</span> mu, mu <span class="sc">-</span> <span class="fu">colMeans</span>(mu))</span>
<span id="cb59-9"><a href="m-step.html#cb59-9" tabindex="-1"></a>  prim2 <span class="ot">=</span> <span class="fu">rbind</span>(<span class="sc">-</span>w, <span class="sc">-</span>z)</span>
<span id="cb59-10"><a href="m-step.html#cb59-10" tabindex="-1"></a>  primal_resid <span class="ot">=</span> prim1 <span class="sc">+</span> prim2   <span class="do">## Ax + Bz - c</span></span>
<span id="cb59-11"><a href="m-step.html#cb59-11" tabindex="-1"></a></span>
<span id="cb59-12"><a href="m-step.html#cb59-12" tabindex="-1"></a>  change_z <span class="ot">=</span> z <span class="sc">-</span> z_prev</span>
<span id="cb59-13"><a href="m-step.html#cb59-13" tabindex="-1"></a>  change_w <span class="ot">=</span> w <span class="sc">-</span> w_prev</span>
<span id="cb59-14"><a href="m-step.html#cb59-14" tabindex="-1"></a>  dual_resid <span class="ot">=</span> rho <span class="sc">*</span> (<span class="sc">-</span>(change_z <span class="sc">-</span> <span class="fu">colMeans</span>(change_z)) <span class="sc">-</span> tDl <span class="sc">%*%</span> change_w)</span>
<span id="cb59-15"><a href="m-step.html#cb59-15" tabindex="-1"></a>  tAU <span class="ot">=</span> (uz <span class="sc">-</span> <span class="fu">colMeans</span>(uz)) <span class="sc">+</span> tDl <span class="sc">%*%</span> uw</span>
<span id="cb59-16"><a href="m-step.html#cb59-16" tabindex="-1"></a>         </span>
<span id="cb59-17"><a href="m-step.html#cb59-17" tabindex="-1"></a>  <span class="do">## Form primal and dual tolerances.</span></span>
<span id="cb59-18"><a href="m-step.html#cb59-18" tabindex="-1"></a>  primal_err <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="fu">length</span>(primal_resid)) <span class="sc">*</span> err_abs <span class="sc">+</span></span>
<span id="cb59-19"><a href="m-step.html#cb59-19" tabindex="-1"></a>    err_rel <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">norm</span>(prim1, <span class="st">&quot;F&quot;</span>), <span class="fu">norm</span>(prim2, <span class="st">&quot;F&quot;</span>))</span>
<span id="cb59-20"><a href="m-step.html#cb59-20" tabindex="-1"></a>  dual_err <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="fu">length</span>(dual_resid)) <span class="sc">*</span> err_abs <span class="sc">+</span></span>
<span id="cb59-21"><a href="m-step.html#cb59-21" tabindex="-1"></a>    err_rel <span class="sc">*</span> <span class="fu">norm</span>(tAU, <span class="st">&quot;F&quot;</span>)</span>
<span id="cb59-22"><a href="m-step.html#cb59-22" tabindex="-1"></a></span>
<span id="cb59-23"><a href="m-step.html#cb59-23" tabindex="-1"></a>  <span class="do">## Check convergence.</span></span>
<span id="cb59-24"><a href="m-step.html#cb59-24" tabindex="-1"></a>  primal_resid_size <span class="ot">=</span> <span class="fu">norm</span>(primal_resid, <span class="st">&quot;F&quot;</span>)</span>
<span id="cb59-25"><a href="m-step.html#cb59-25" tabindex="-1"></a>  dual_resid_size <span class="ot">=</span> <span class="fu">norm</span>(dual_resid, <span class="st">&quot;F&quot;</span>)</span>
<span id="cb59-26"><a href="m-step.html#cb59-26" tabindex="-1"></a>  primal_converge <span class="ot">=</span> ( primal_resid_size  <span class="sc">&lt;=</span> primal_err )</span>
<span id="cb59-27"><a href="m-step.html#cb59-27" tabindex="-1"></a>  dual_converge <span class="ot">=</span> ( dual_resid_size <span class="sc">&lt;=</span> dual_err )</span>
<span id="cb59-28"><a href="m-step.html#cb59-28" tabindex="-1"></a></span>
<span id="cb59-29"><a href="m-step.html#cb59-29" tabindex="-1"></a>  <span class="do">## Some checks (trying to address problems with |converge|).</span></span>
<span id="cb59-30"><a href="m-step.html#cb59-30" tabindex="-1"></a>  assertthat<span class="sc">::</span><span class="fu">assert_that</span>(<span class="fu">is.numeric</span>(primal_resid_size))</span>
<span id="cb59-31"><a href="m-step.html#cb59-31" tabindex="-1"></a>  assertthat<span class="sc">::</span><span class="fu">assert_that</span>(<span class="fu">is.numeric</span>(primal_err))</span>
<span id="cb59-32"><a href="m-step.html#cb59-32" tabindex="-1"></a>  assertthat<span class="sc">::</span><span class="fu">assert_that</span>(<span class="fu">is.numeric</span>(dual_resid_size))</span>
<span id="cb59-33"><a href="m-step.html#cb59-33" tabindex="-1"></a>  assertthat<span class="sc">::</span><span class="fu">assert_that</span>(<span class="fu">is.numeric</span>(dual_err))</span>
<span id="cb59-34"><a href="m-step.html#cb59-34" tabindex="-1"></a></span>
<span id="cb59-35"><a href="m-step.html#cb59-35" tabindex="-1"></a>  <span class="do">## return(primal_converge &amp; dual_converge)</span></span>
<span id="cb59-36"><a href="m-step.html#cb59-36" tabindex="-1"></a>  converge <span class="ot">=</span> primal_converge <span class="sc">&amp;</span> dual_converge</span>
<span id="cb59-37"><a href="m-step.html#cb59-37" tabindex="-1"></a></span>
<span id="cb59-38"><a href="m-step.html#cb59-38" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb59-39"><a href="m-step.html#cb59-39" tabindex="-1"></a>      <span class="at">primal_resid1 =</span> prim1,</span>
<span id="cb59-40"><a href="m-step.html#cb59-40" tabindex="-1"></a>      <span class="at">primal_resid2 =</span> prim2,</span>
<span id="cb59-41"><a href="m-step.html#cb59-41" tabindex="-1"></a>      <span class="at">primal_resid =</span> primal_resid,</span>
<span id="cb59-42"><a href="m-step.html#cb59-42" tabindex="-1"></a>      <span class="at">primal_err =</span> primal_err,</span>
<span id="cb59-43"><a href="m-step.html#cb59-43" tabindex="-1"></a>      <span class="at">dual_resid =</span> dual_resid,</span>
<span id="cb59-44"><a href="m-step.html#cb59-44" tabindex="-1"></a>      <span class="at">dual_err =</span> dual_err,</span>
<span id="cb59-45"><a href="m-step.html#cb59-45" tabindex="-1"></a>      <span class="at">converge =</span> converge))</span>
<span id="cb59-46"><a href="m-step.html#cb59-46" tabindex="-1"></a>}</span></code></pre></div>
<p>Here’s a function to compute the augmented Lagrangian of the M-step (this is not used for now).</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="m-step.html#cb60-1" tabindex="-1"></a><span class="co">#&#39; computes the Augmented lagrangian.</span></span>
<span id="cb60-2"><a href="m-step.html#cb60-2" tabindex="-1"></a><span id='aug_lagr'>aug_lagr</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(y, TT, d, z, w, l, uz, uw, mu, resp, Sigma_inv, Dlp1, Dl, maxdev, lambda, rho, N){</span>
<span id="cb60-3"><a href="m-step.html#cb60-3" tabindex="-1"></a>  mu_dd <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(mu)</span>
<span id="cb60-4"><a href="m-step.html#cb60-4" tabindex="-1"></a></span>
<span id="cb60-5"><a href="m-step.html#cb60-5" tabindex="-1"></a>  <span class="co"># Check the Z&#39;s for ball constraint, up to a tolerance of 1e-4</span></span>
<span id="cb60-6"><a href="m-step.html#cb60-6" tabindex="-1"></a>  znorms <span class="ot">&lt;-</span> <span class="fu">apply</span>(z, <span class="at">FUN =</span> <span class="cf">function</span>(zz) <span class="fu">sqrt</span>(<span class="fu">sum</span>(zz<span class="sc">^</span><span class="dv">2</span>)), <span class="at">MARGIN =</span> <span class="dv">1</span>)</span>
<span id="cb60-7"><a href="m-step.html#cb60-7" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.na</span>(znorms))) <span class="fu">browser</span>()</span>
<span id="cb60-8"><a href="m-step.html#cb60-8" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(znorms <span class="sc">&gt;</span> (maxdev <span class="sc">+</span> <span class="fl">1e-4</span>))){</span>
<span id="cb60-9"><a href="m-step.html#cb60-9" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">&quot;||z||_2 &gt; maxdev, current iterate not feasible.&quot;</span>)</span>
<span id="cb60-10"><a href="m-step.html#cb60-10" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">Inf</span>)</span>
<span id="cb60-11"><a href="m-step.html#cb60-11" tabindex="-1"></a>  }</span>
<span id="cb60-12"><a href="m-step.html#cb60-12" tabindex="-1"></a></span>
<span id="cb60-13"><a href="m-step.html#cb60-13" tabindex="-1"></a>  aug1 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">do.call</span>(cbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(t){</span>
<span id="cb60-14"><a href="m-step.html#cb60-14" tabindex="-1"></a>    multmat <span class="ot">&lt;-</span> <span class="fu">apply</span>(y[[t]], <span class="at">FUN =</span> <span class="cf">function</span>(yy){</span>
<span id="cb60-15"><a href="m-step.html#cb60-15" tabindex="-1"></a>      <span class="fu">t</span>(yy <span class="sc">-</span> mu[,t]) <span class="sc">%*%</span> Sigma_inv <span class="sc">%*%</span> (yy <span class="sc">-</span> mu[,t])}, <span class="at">MARGIN =</span> <span class="dv">1</span>)</span>
<span id="cb60-16"><a href="m-step.html#cb60-16" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="dv">1</span><span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>N) <span class="sc">*</span> resp[[t]]<span class="sc">*</span>multmat)</span>
<span id="cb60-17"><a href="m-step.html#cb60-17" tabindex="-1"></a>  })))</span>
<span id="cb60-18"><a href="m-step.html#cb60-18" tabindex="-1"></a></span>
<span id="cb60-19"><a href="m-step.html#cb60-19" tabindex="-1"></a>  aug2 <span class="ot">&lt;-</span> lambda<span class="sc">*</span><span class="fu">sum</span>(<span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>d, <span class="at">FUN =</span> <span class="cf">function</span>(j)</span>
<span id="cb60-20"><a href="m-step.html#cb60-20" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="fu">abs</span>(<span class="fu">diff</span>(w[j,], <span class="at">differences =</span> <span class="dv">1</span>))))))</span>
<span id="cb60-21"><a href="m-step.html#cb60-21" tabindex="-1"></a></span>
<span id="cb60-22"><a href="m-step.html#cb60-22" tabindex="-1"></a>  aug3 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">do.call</span>(cbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(t){</span>
<span id="cb60-23"><a href="m-step.html#cb60-23" tabindex="-1"></a>    uz[t,]<span class="sc">%*%</span>(mu[,t] <span class="sc">-</span> mu_dd <span class="sc">-</span> z[t,]) <span class="sc">+</span> rho<span class="sc">/</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">sum</span>((mu[,t] <span class="sc">-</span> mu_dd <span class="sc">-</span> z[t,])<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb60-24"><a href="m-step.html#cb60-24" tabindex="-1"></a>  })))</span>
<span id="cb60-25"><a href="m-step.html#cb60-25" tabindex="-1"></a></span>
<span id="cb60-26"><a href="m-step.html#cb60-26" tabindex="-1"></a></span>
<span id="cb60-27"><a href="m-step.html#cb60-27" tabindex="-1"></a>  aug4 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>d, <span class="at">FUN =</span> <span class="cf">function</span>(j){</span>
<span id="cb60-28"><a href="m-step.html#cb60-28" tabindex="-1"></a>    uw[,j] <span class="sc">%*%</span> (Dl <span class="sc">%*%</span> mu[j,]  <span class="sc">-</span> w[j,]) <span class="sc">+</span> rho<span class="sc">/</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">sum</span>((Dl <span class="sc">%*%</span> mu[j,] <span class="sc">-</span> w[j,])<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb60-29"><a href="m-step.html#cb60-29" tabindex="-1"></a>  })))</span>
<span id="cb60-30"><a href="m-step.html#cb60-30" tabindex="-1"></a></span>
<span id="cb60-31"><a href="m-step.html#cb60-31" tabindex="-1"></a>  total <span class="ot">&lt;-</span> aug1 <span class="sc">+</span> aug2 <span class="sc">+</span> aug3 <span class="sc">+</span> aug4</span>
<span id="cb60-32"><a href="m-step.html#cb60-32" tabindex="-1"></a></span>
<span id="cb60-33"><a href="m-step.html#cb60-33" tabindex="-1"></a>  <span class="fu">return</span>(total)</span>
<span id="cb60-34"><a href="m-step.html#cb60-34" tabindex="-1"></a>}</span></code></pre></div>
<p>Here’s a function to calculate the objective value for the ADMM.</p>
<p><span class="math display">\[\frac{1}{2N} \sum_{t=1}^T \sum_{i=1}^{n_t} \hat{\gamma}_{it} (y_i^{(t)} - \mu_{\cdot
       t})^T \hat{\Sigma}^{-1} ( y_i^{(t)} - \mu_{\cdot t}) + \lambda
     \sum_{j=1}^d \|D^{(l+1)}\mu_{j\cdot }\|_1\]</span></p>
<p>(This is the penalized surrogate objective <span class="math inline">\(Q_{\tilde \theta}(\mu, \Sigma,
\pi) + \lambda \sum_{j=1}^d \|D^{(l+1)} \mu_{j \cdot}\|_1\)</span>, taking only the
parts, and leaving out a constant <span class="math inline">\(C=-\frac{d}{2}\log(2\pi) - \frac{1}{2} \log
det(\Sigma_k)\)</span>, since the constant <span class="math inline">\(C\)</span> doesn’t change over ADMM iterations.)</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="m-step.html#cb61-1" tabindex="-1"></a><span class="co">#&#39; computes the ADMM objective for one cluster</span></span>
<span id="cb61-2"><a href="m-step.html#cb61-2" tabindex="-1"></a><span id='objective_per_cluster'>objective_per_cluster</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(y, TT, d, l, mu, resp, Sigma_inv, Dlp1, Dl,</span>
<span id="cb61-3"><a href="m-step.html#cb61-3" tabindex="-1"></a>                                  maxdev, lambda, rho, N){</span>
<span id="cb61-4"><a href="m-step.html#cb61-4" tabindex="-1"></a>  </span>
<span id="cb61-5"><a href="m-step.html#cb61-5" tabindex="-1"></a>  aug1 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">do.call</span>(cbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(tt){</span>
<span id="cb61-6"><a href="m-step.html#cb61-6" tabindex="-1"></a>    multmat <span class="ot">&lt;-</span> <span class="fu">apply</span>(y[[tt]], <span class="at">FUN =</span> <span class="cf">function</span>(yy){</span>
<span id="cb61-7"><a href="m-step.html#cb61-7" tabindex="-1"></a>      <span class="fu">t</span>(yy <span class="sc">-</span> mu[tt,]) <span class="sc">%*%</span> Sigma_inv <span class="sc">%*%</span> (yy <span class="sc">-</span> mu[tt,])}, <span class="at">MARGIN =</span> <span class="dv">1</span>)</span>
<span id="cb61-8"><a href="m-step.html#cb61-8" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="dv">1</span><span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>N) <span class="sc">*</span> resp[[tt]] <span class="sc">*</span> multmat)</span>
<span id="cb61-9"><a href="m-step.html#cb61-9" tabindex="-1"></a>  })))</span>
<span id="cb61-10"><a href="m-step.html#cb61-10" tabindex="-1"></a></span>
<span id="cb61-11"><a href="m-step.html#cb61-11" tabindex="-1"></a>  aug2 <span class="ot">&lt;-</span> lambda<span class="sc">*</span><span class="fu">sum</span>(<span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>d, <span class="at">FUN =</span> <span class="cf">function</span>(j)</span>
<span id="cb61-12"><a href="m-step.html#cb61-12" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="fu">abs</span>(<span class="fu">diff</span>(mu[,j], <span class="at">differences =</span> l))))))</span>
<span id="cb61-13"><a href="m-step.html#cb61-13" tabindex="-1"></a></span>
<span id="cb61-14"><a href="m-step.html#cb61-14" tabindex="-1"></a>  total <span class="ot">&lt;-</span> aug1 <span class="sc">+</span> aug2</span>
<span id="cb61-15"><a href="m-step.html#cb61-15" tabindex="-1"></a>  <span class="fu">return</span>(total)</span>
<span id="cb61-16"><a href="m-step.html#cb61-16" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="all-rcpp-functions" class="section level2 hasAnchor" number="9.5">
<h2><span class="header-section-number">9.5</span> All Rcpp functions<a href="m-step.html#all-rcpp-functions" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The main function we write in Rcpp is the “barebones” Sylvester equation solver
that takes upper-triangular coefficient matrices.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb62-1"><a href="m-step.html#cb62-1" tabindex="-1"></a><span class="co">// [[Rcpp::depends(RcppArmadillo)]]</span></span>
<span id="cb62-2"><a href="m-step.html#cb62-2" tabindex="-1"></a><span class="co">// [[Rcpp::depends(RcppEigen)]]</span></span>
<span id="cb62-3"><a href="m-step.html#cb62-3" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;RcppArmadillo.h&gt;</span></span>
<span id="cb62-4"><a href="m-step.html#cb62-4" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;RcppEigen.h&gt;</span></span>
<span id="cb62-5"><a href="m-step.html#cb62-5" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;numeric&gt;</span></span>
<span id="cb62-6"><a href="m-step.html#cb62-6" tabindex="-1"></a></span>
<span id="cb62-7"><a href="m-step.html#cb62-7" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> arma<span class="op">;</span></span>
<span id="cb62-8"><a href="m-step.html#cb62-8" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Eigen<span class="op">;</span></span>
<span id="cb62-9"><a href="m-step.html#cb62-9" tabindex="-1"></a></span>
<span id="cb62-10"><a href="m-step.html#cb62-10" tabindex="-1"></a><span class="kw">using</span> Eigen<span class="op">::</span>Map<span class="op">;</span>                       <span class="co">// &#39;maps&#39; rather than copies</span></span>
<span id="cb62-11"><a href="m-step.html#cb62-11" tabindex="-1"></a><span class="kw">using</span> Eigen<span class="op">::</span>MatrixXd<span class="op">;</span>                  <span class="co">// variable size matrix, double precision</span></span>
<span id="cb62-12"><a href="m-step.html#cb62-12" tabindex="-1"></a></span>
<span id="cb62-13"><a href="m-step.html#cb62-13" tabindex="-1"></a><span class="co">//&#39; Solve &quot;barebones&quot; sylvester equation that takes upper triangular matrices as coefficients.</span></span>
<span id="cb62-14"><a href="m-step.html#cb62-14" tabindex="-1"></a><span class="co">//&#39;</span></span>
<span id="cb62-15"><a href="m-step.html#cb62-15" tabindex="-1"></a><span class="co">//&#39; @param TA Upper-triangular matrix</span></span>
<span id="cb62-16"><a href="m-step.html#cb62-16" tabindex="-1"></a><span class="co">//&#39; @param TB Upper-triangular matrix</span></span>
<span id="cb62-17"><a href="m-step.html#cb62-17" tabindex="-1"></a><span class="co">//&#39; @param C matrix</span></span>
<span id="cb62-18"><a href="m-step.html#cb62-18" tabindex="-1"></a><span class="co">//&#39; @export</span></span>
<span id="cb62-19"><a href="m-step.html#cb62-19" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb62-20"><a href="m-step.html#cb62-20" tabindex="-1"></a>Eigen<span class="op">::</span>MatrixXd matrix_function_solve_triangular_sylvester_barebonesC2<span class="op">(</span><span class="at">const</span> Eigen<span class="op">::</span>MatrixXd <span class="op">&amp;</span> TA<span class="op">,</span> </span>
<span id="cb62-21"><a href="m-step.html#cb62-21" tabindex="-1"></a>                                     <span class="at">const</span> Eigen<span class="op">::</span>MatrixXd <span class="op">&amp;</span> TB<span class="op">,</span></span>
<span id="cb62-22"><a href="m-step.html#cb62-22" tabindex="-1"></a>                                     <span class="at">const</span> Eigen<span class="op">::</span>MatrixXd <span class="op">&amp;</span> C<span class="op">){</span></span>
<span id="cb62-23"><a href="m-step.html#cb62-23" tabindex="-1"></a>  <span class="co">// Eigen::eigen_assert(TA.rows() == TA.cols());</span></span>
<span id="cb62-24"><a href="m-step.html#cb62-24" tabindex="-1"></a>  <span class="co">// Eigen::eigen_assert(TA.Eigen::isUpperTriangular());</span></span>
<span id="cb62-25"><a href="m-step.html#cb62-25" tabindex="-1"></a>  <span class="co">// Eigen::eigen_assert(TB.rows() == TB.cols());</span></span>
<span id="cb62-26"><a href="m-step.html#cb62-26" tabindex="-1"></a>  <span class="co">// Eigen::eigen_assert(TB.Eigen::isUpperTriangular());</span></span>
<span id="cb62-27"><a href="m-step.html#cb62-27" tabindex="-1"></a>  <span class="co">// Eigen::eigen_assert(C.rows() == TA.rows());</span></span>
<span id="cb62-28"><a href="m-step.html#cb62-28" tabindex="-1"></a>  <span class="co">// Eigen::eigen_assert(C.cols() == TB.rows());</span></span>
<span id="cb62-29"><a href="m-step.html#cb62-29" tabindex="-1"></a></span>
<span id="cb62-30"><a href="m-step.html#cb62-30" tabindex="-1"></a>  <span class="co">// typedef typename MatrixType::Index Index; </span></span>
<span id="cb62-31"><a href="m-step.html#cb62-31" tabindex="-1"></a>  <span class="co">// typedef typename MatrixType::Scalar Scalar;</span></span>
<span id="cb62-32"><a href="m-step.html#cb62-32" tabindex="-1"></a></span>
<span id="cb62-33"><a href="m-step.html#cb62-33" tabindex="-1"></a>  <span class="dt">int</span> m <span class="op">=</span> TA<span class="op">.</span>rows<span class="op">();</span></span>
<span id="cb62-34"><a href="m-step.html#cb62-34" tabindex="-1"></a>  <span class="dt">int</span> n <span class="op">=</span> TB<span class="op">.</span>rows<span class="op">();</span></span>
<span id="cb62-35"><a href="m-step.html#cb62-35" tabindex="-1"></a>  Eigen<span class="op">::</span>MatrixXd X<span class="op">(</span>m<span class="op">,</span> n<span class="op">);</span></span>
<span id="cb62-36"><a href="m-step.html#cb62-36" tabindex="-1"></a></span>
<span id="cb62-37"><a href="m-step.html#cb62-37" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> m <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">;</span> <span class="op">--</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-38"><a href="m-step.html#cb62-38" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> n<span class="op">;</span> <span class="op">++</span>j<span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-39"><a href="m-step.html#cb62-39" tabindex="-1"></a></span>
<span id="cb62-40"><a href="m-step.html#cb62-40" tabindex="-1"></a>      <span class="co">// Compute T_A X = \sum_{k=i+1}^m T_A_{ik} X_{kj}</span></span>
<span id="cb62-41"><a href="m-step.html#cb62-41" tabindex="-1"></a>      <span class="dt">double</span> TAX<span class="op">;</span></span>
<span id="cb62-42"><a href="m-step.html#cb62-42" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>i <span class="op">==</span> m <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-43"><a href="m-step.html#cb62-43" tabindex="-1"></a>        TAX <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb62-44"><a href="m-step.html#cb62-44" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb62-45"><a href="m-step.html#cb62-45" tabindex="-1"></a>    MatrixXd TAXmatrix <span class="op">=</span> TA<span class="op">.</span>row<span class="op">(</span>i<span class="op">).</span>tail<span class="op">(</span>m<span class="op">-</span><span class="dv">1</span><span class="op">-</span>i<span class="op">)</span> <span class="op">*</span> X<span class="op">.</span>col<span class="op">(</span>j<span class="op">).</span>tail<span class="op">(</span>m<span class="op">-</span><span class="dv">1</span><span class="op">-</span>i<span class="op">);</span></span>
<span id="cb62-46"><a href="m-step.html#cb62-46" tabindex="-1"></a>        TAX <span class="op">=</span> TAXmatrix<span class="op">(</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb62-47"><a href="m-step.html#cb62-47" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb62-48"><a href="m-step.html#cb62-48" tabindex="-1"></a></span>
<span id="cb62-49"><a href="m-step.html#cb62-49" tabindex="-1"></a>      <span class="co">// Compute X T_B = \sum_{k=1}^{j-1} X_{ik} T_B_{kj}</span></span>
<span id="cb62-50"><a href="m-step.html#cb62-50" tabindex="-1"></a>      <span class="dt">double</span> XTB<span class="op">;</span></span>
<span id="cb62-51"><a href="m-step.html#cb62-51" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>j <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-52"><a href="m-step.html#cb62-52" tabindex="-1"></a>        XTB <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb62-53"><a href="m-step.html#cb62-53" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb62-54"><a href="m-step.html#cb62-54" tabindex="-1"></a>        MatrixXd XTBmatrix <span class="op">=</span> X<span class="op">.</span>row<span class="op">(</span>i<span class="op">).</span>head<span class="op">(</span>j<span class="op">)</span> <span class="op">*</span> TB<span class="op">.</span>col<span class="op">(</span>j<span class="op">).</span>head<span class="op">(</span>j<span class="op">);</span></span>
<span id="cb62-55"><a href="m-step.html#cb62-55" tabindex="-1"></a>        XTB <span class="op">=</span> XTBmatrix<span class="op">(</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb62-56"><a href="m-step.html#cb62-56" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb62-57"><a href="m-step.html#cb62-57" tabindex="-1"></a></span>
<span id="cb62-58"><a href="m-step.html#cb62-58" tabindex="-1"></a>      X<span class="op">(</span>i<span class="op">,</span>j<span class="op">)</span> <span class="op">=</span> <span class="op">(</span>C<span class="op">(</span>i<span class="op">,</span>j<span class="op">)</span> <span class="op">-</span> TAX <span class="op">-</span> XTB<span class="op">)</span> <span class="op">/</span> <span class="op">(</span>TA<span class="op">(</span>i<span class="op">,</span>i<span class="op">)</span> <span class="op">+</span> TB<span class="op">(</span>j<span class="op">,</span>j<span class="op">));</span></span>
<span id="cb62-59"><a href="m-step.html#cb62-59" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb62-60"><a href="m-step.html#cb62-60" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb62-61"><a href="m-step.html#cb62-61" tabindex="-1"></a>  <span class="cf">return</span> X<span class="op">;</span></span>
<span id="cb62-62"><a href="m-step.html#cb62-62" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Also, we define a faster <code>dmvnorm</code> function written in C++.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb63-1"><a href="m-step.html#cb63-1" tabindex="-1"></a><span class="co">// [[Rcpp::depends(RcppArmadillo)]]</span></span>
<span id="cb63-2"><a href="m-step.html#cb63-2" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;RcppArmadillo.h&gt;</span></span>
<span id="cb63-3"><a href="m-step.html#cb63-3" tabindex="-1"></a></span>
<span id="cb63-4"><a href="m-step.html#cb63-4" tabindex="-1"></a><span class="at">static</span> <span class="dt">double</span> <span class="at">const</span> log2pi <span class="op">=</span> <span class="bu">std::</span>log<span class="op">(</span><span class="fl">2.0</span> <span class="op">*</span> M_PI<span class="op">);</span></span>
<span id="cb63-5"><a href="m-step.html#cb63-5" tabindex="-1"></a></span>
<span id="cb63-6"><a href="m-step.html#cb63-6" tabindex="-1"></a><span class="co">/* C++ version of the dtrmv BLAS function */</span></span>
<span id="cb63-7"><a href="m-step.html#cb63-7" tabindex="-1"></a><span class="dt">void</span> inplace_tri_mat_mult<span class="op">(</span>arma<span class="op">::</span>rowvec <span class="op">&amp;</span>x<span class="op">,</span> arma<span class="op">::</span>mat <span class="at">const</span> <span class="op">&amp;</span>trimat<span class="op">){</span></span>
<span id="cb63-8"><a href="m-step.html#cb63-8" tabindex="-1"></a>  arma<span class="op">::</span>uword <span class="at">const</span> n <span class="op">=</span> trimat<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb63-9"><a href="m-step.html#cb63-9" tabindex="-1"></a></span>
<span id="cb63-10"><a href="m-step.html#cb63-10" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">unsigned</span> j <span class="op">=</span> n<span class="op">;</span> j<span class="op">--</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">;){</span></span>
<span id="cb63-11"><a href="m-step.html#cb63-11" tabindex="-1"></a>    <span class="dt">double</span> tmp<span class="op">(</span><span class="fl">0.</span><span class="op">);</span></span>
<span id="cb63-12"><a href="m-step.html#cb63-12" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">unsigned</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;=</span> j<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span></span>
<span id="cb63-13"><a href="m-step.html#cb63-13" tabindex="-1"></a>      tmp <span class="op">+=</span> trimat<span class="op">.</span>at<span class="op">(</span>i<span class="op">,</span> j<span class="op">)</span> <span class="op">*</span> x<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb63-14"><a href="m-step.html#cb63-14" tabindex="-1"></a>    x<span class="op">[</span>j<span class="op">]</span> <span class="op">=</span> tmp<span class="op">;</span></span>
<span id="cb63-15"><a href="m-step.html#cb63-15" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb63-16"><a href="m-step.html#cb63-16" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb63-17"><a href="m-step.html#cb63-17" tabindex="-1"></a></span>
<span id="cb63-18"><a href="m-step.html#cb63-18" tabindex="-1"></a></span>
<span id="cb63-19"><a href="m-step.html#cb63-19" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb63-20"><a href="m-step.html#cb63-20" tabindex="-1"></a>arma<span class="op">::</span>vec dmvnorm_arma_fast<span class="op">(</span>arma<span class="op">::</span>mat <span class="at">const</span> <span class="op">&amp;</span>x<span class="op">,</span></span>
<span id="cb63-21"><a href="m-step.html#cb63-21" tabindex="-1"></a>                           arma<span class="op">::</span>rowvec <span class="at">const</span> <span class="op">&amp;</span>mean<span class="op">,</span></span>
<span id="cb63-22"><a href="m-step.html#cb63-22" tabindex="-1"></a>                           arma<span class="op">::</span>mat <span class="at">const</span> <span class="op">&amp;</span>sigma<span class="op">,</span></span>
<span id="cb63-23"><a href="m-step.html#cb63-23" tabindex="-1"></a>                           <span class="dt">bool</span> <span class="at">const</span> logd <span class="op">=</span> <span class="kw">false</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-24"><a href="m-step.html#cb63-24" tabindex="-1"></a>    <span class="kw">using</span> arma<span class="op">::</span>uword<span class="op">;</span></span>
<span id="cb63-25"><a href="m-step.html#cb63-25" tabindex="-1"></a>    uword <span class="at">const</span> n <span class="op">=</span> x<span class="op">.</span>n_rows<span class="op">,</span></span>
<span id="cb63-26"><a href="m-step.html#cb63-26" tabindex="-1"></a>             xdim <span class="op">=</span> x<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb63-27"><a href="m-step.html#cb63-27" tabindex="-1"></a>    arma<span class="op">::</span>vec out<span class="op">(</span>n<span class="op">);</span></span>
<span id="cb63-28"><a href="m-step.html#cb63-28" tabindex="-1"></a>    arma<span class="op">::</span>mat <span class="at">const</span> rooti <span class="op">=</span> arma<span class="op">::</span>inv<span class="op">(</span>trimatu<span class="op">(</span>arma<span class="op">::</span>chol<span class="op">(</span>sigma<span class="op">)));</span></span>
<span id="cb63-29"><a href="m-step.html#cb63-29" tabindex="-1"></a>    <span class="dt">double</span> <span class="at">const</span> rootisum <span class="op">=</span> arma<span class="op">::</span>sum<span class="op">(</span>log<span class="op">(</span>rooti<span class="op">.</span>diag<span class="op">())),</span></span>
<span id="cb63-30"><a href="m-step.html#cb63-30" tabindex="-1"></a>                constants <span class="op">=</span> <span class="op">-(</span><span class="dt">double</span><span class="op">)</span>xdim<span class="op">/</span><span class="fl">2.0</span> <span class="op">*</span> log2pi<span class="op">,</span></span>
<span id="cb63-31"><a href="m-step.html#cb63-31" tabindex="-1"></a>              other_terms <span class="op">=</span> rootisum <span class="op">+</span> constants<span class="op">;</span></span>
<span id="cb63-32"><a href="m-step.html#cb63-32" tabindex="-1"></a></span>
<span id="cb63-33"><a href="m-step.html#cb63-33" tabindex="-1"></a>    arma<span class="op">::</span>rowvec z<span class="op">;</span></span>
<span id="cb63-34"><a href="m-step.html#cb63-34" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>uword i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb63-35"><a href="m-step.html#cb63-35" tabindex="-1"></a>        z <span class="op">=</span> <span class="op">(</span>x<span class="op">.</span>row<span class="op">(</span>i<span class="op">)</span> <span class="op">-</span> mean<span class="op">);</span></span>
<span id="cb63-36"><a href="m-step.html#cb63-36" tabindex="-1"></a>        inplace_tri_mat_mult<span class="op">(</span>z<span class="op">,</span> rooti<span class="op">);</span></span>
<span id="cb63-37"><a href="m-step.html#cb63-37" tabindex="-1"></a>        out<span class="op">(</span>i<span class="op">)</span> <span class="op">=</span> other_terms <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> arma<span class="op">::</span>dot<span class="op">(</span>z<span class="op">,</span> z<span class="op">);</span></span>
<span id="cb63-38"><a href="m-step.html#cb63-38" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb63-39"><a href="m-step.html#cb63-39" tabindex="-1"></a></span>
<span id="cb63-40"><a href="m-step.html#cb63-40" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>logd<span class="op">)</span></span>
<span id="cb63-41"><a href="m-step.html#cb63-41" tabindex="-1"></a>      <span class="cf">return</span> out<span class="op">;</span></span>
<span id="cb63-42"><a href="m-step.html#cb63-42" tabindex="-1"></a>    <span class="cf">return</span> exp<span class="op">(</span>out<span class="op">);</span></span>
<span id="cb63-43"><a href="m-step.html#cb63-43" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb63-44"><a href="m-step.html#cb63-44" tabindex="-1"></a></span>
<span id="cb63-45"><a href="m-step.html#cb63-45" tabindex="-1"></a><span class="co">// All credit goes to https://gallery.rcpp.org/articles/dmvnorm_arma/</span></span></code></pre></div>
<p>We need this blob
(from <a href="https://github.com/jacobbien/litr-project/blob/main/examples/make-an-r-package-with-armadillo/create-witharmadillo.Rmd" class="uri">https://github.com/jacobbien/litr-project/blob/main/examples/make-an-r-package-with-armadillo/create-witharmadillo.Rmd</a> ):</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="m-step.html#cb64-1" tabindex="-1"></a>usethis<span class="sc">::</span><span class="fu">use_rcpp_armadillo</span>(<span class="at">name =</span> <span class="st">&quot;code&quot;</span>)</span>
<span id="cb64-2"><a href="m-step.html#cb64-2" tabindex="-1"></a>usethis<span class="sc">::</span><span class="fu">use_rcpp_eigen</span>(<span class="at">name =</span> <span class="st">&quot;code&quot;</span>)</span></code></pre></div>
<pre><code>## ✔ Leaving &#39;src/code.cpp&#39; unchanged
## • Edit &#39;src/code.cpp&#39;
## ✔ Adding &#39;RcppArmadillo&#39; to LinkingTo field in DESCRIPTION
## ✔ Created &#39;src/Makevars&#39; and &#39;src/Makevars.win&#39; with requested compilation settings.</code></pre>
<pre><code>## ✔ Leaving &#39;src/code.cpp&#39; unchanged
## • Edit &#39;src/code.cpp&#39;
## ✔ Adding &#39;RcppEigen&#39; to LinkingTo field in DESCRIPTION
## ✔ Adding &#39;@import RcppEigen&#39; to &#39;R/flowtrend-package.R&#39;
## • Run `devtools::document()` to update &#39;NAMESPACE&#39;</code></pre>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="m-step.html#cb67-1" tabindex="-1"></a><span class="co">#&#39; Testing against \code{<a href='m-step.html#Mstep_mu'>Mstep_mu</a>()}, for ONE cluster.</span></span>
<span id="cb67-2"><a href="m-step.html#cb67-2" tabindex="-1"></a><span class="co">#&#39; @param ylist</span></span>
<span id="cb67-3"><a href="m-step.html#cb67-3" tabindex="-1"></a><span class="co">#&#39; @param resp</span></span>
<span id="cb67-4"><a href="m-step.html#cb67-4" tabindex="-1"></a><span class="co">#&#39; @param lambda</span></span>
<span id="cb67-5"><a href="m-step.html#cb67-5" tabindex="-1"></a><span class="co">#&#39; @param l</span></span>
<span id="cb67-6"><a href="m-step.html#cb67-6" tabindex="-1"></a><span class="co">#&#39; @param Sigma_inv inverse of Sigma</span></span>
<span id="cb67-7"><a href="m-step.html#cb67-7" tabindex="-1"></a><span class="co">#&#39; @param x covariates</span></span>
<span id="cb67-8"><a href="m-step.html#cb67-8" tabindex="-1"></a><span id='Mstep_mu_cvxr'>Mstep_mu_cvxr</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(ylist,</span>
<span id="cb67-9"><a href="m-step.html#cb67-9" tabindex="-1"></a>                          resp,</span>
<span id="cb67-10"><a href="m-step.html#cb67-10" tabindex="-1"></a>                          lambda,</span>
<span id="cb67-11"><a href="m-step.html#cb67-11" tabindex="-1"></a>                          l,</span>
<span id="cb67-12"><a href="m-step.html#cb67-12" tabindex="-1"></a>                          Sigma_inv, </span>
<span id="cb67-13"><a href="m-step.html#cb67-13" tabindex="-1"></a>                          <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb67-14"><a href="m-step.html#cb67-14" tabindex="-1"></a>                          <span class="at">thresh =</span> <span class="fl">1E-8</span>,</span>
<span id="cb67-15"><a href="m-step.html#cb67-15" tabindex="-1"></a>                          <span class="at">maxdev =</span> <span class="cn">NULL</span>,</span>
<span id="cb67-16"><a href="m-step.html#cb67-16" tabindex="-1"></a>                          dimdat,</span>
<span id="cb67-17"><a href="m-step.html#cb67-17" tabindex="-1"></a>                          N,</span>
<span id="cb67-18"><a href="m-step.html#cb67-18" tabindex="-1"></a>                          <span class="at">ecos_thresh =</span> <span class="fl">1E-8</span>,</span>
<span id="cb67-19"><a href="m-step.html#cb67-19" tabindex="-1"></a>                          <span class="at">scs_eps =</span> <span class="fl">1E-5</span>){</span>
<span id="cb67-20"><a href="m-step.html#cb67-20" tabindex="-1"></a>  </span>
<span id="cb67-21"><a href="m-step.html#cb67-21" tabindex="-1"></a>  <span class="do">## Define dimensions</span></span>
<span id="cb67-22"><a href="m-step.html#cb67-22" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="fu">length</span>(ylist)</span>
<span id="cb67-23"><a href="m-step.html#cb67-23" tabindex="-1"></a>  </span>
<span id="cb67-24"><a href="m-step.html#cb67-24" tabindex="-1"></a>  <span class="do">## Responsibility Weighted Data</span></span>
<span id="cb67-25"><a href="m-step.html#cb67-25" tabindex="-1"></a>  ytildes <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(tt){</span>
<span id="cb67-26"><a href="m-step.html#cb67-26" tabindex="-1"></a>    yy <span class="ot">&lt;-</span> ylist[[tt]]</span>
<span id="cb67-27"><a href="m-step.html#cb67-27" tabindex="-1"></a>    g <span class="ot">&lt;-</span> resp[[tt]]</span>
<span id="cb67-28"><a href="m-step.html#cb67-28" tabindex="-1"></a>    yy <span class="ot">&lt;-</span> <span class="fu">apply</span>(yy, <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x) x <span class="sc">*</span> g)</span>
<span id="cb67-29"><a href="m-step.html#cb67-29" tabindex="-1"></a>    yrow <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>), <span class="at">nrow=</span><span class="dv">1</span>, <span class="at">ncol=</span>dimdat)</span>
<span id="cb67-30"><a href="m-step.html#cb67-30" tabindex="-1"></a>    yrow[<span class="dv">1</span>,] <span class="ot">=</span> <span class="fu">colSums</span>(yy)</span>
<span id="cb67-31"><a href="m-step.html#cb67-31" tabindex="-1"></a>    yrow</span>
<span id="cb67-32"><a href="m-step.html#cb67-32" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span> <span class="fu">do.call</span>(rbind, .)</span>
<span id="cb67-33"><a href="m-step.html#cb67-33" tabindex="-1"></a>  </span>
<span id="cb67-34"><a href="m-step.html#cb67-34" tabindex="-1"></a>  <span class="do">## Auxiliary term, needed to make the objective interpretable</span></span>
<span id="cb67-35"><a href="m-step.html#cb67-35" tabindex="-1"></a>  aux.y <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(<span class="st">&quot;+&quot;</span>, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(tt){</span>
<span id="cb67-36"><a href="m-step.html#cb67-36" tabindex="-1"></a>    yy <span class="ot">&lt;-</span> ylist[[tt]]</span>
<span id="cb67-37"><a href="m-step.html#cb67-37" tabindex="-1"></a>    g <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(resp[[tt]])</span>
<span id="cb67-38"><a href="m-step.html#cb67-38" tabindex="-1"></a>    yy <span class="ot">&lt;-</span> <span class="fu">apply</span>(yy, <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x) x <span class="sc">*</span> g)</span>
<span id="cb67-39"><a href="m-step.html#cb67-39" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="fu">diag</span>(yy <span class="sc">%*%</span> Sigma_inv <span class="sc">%*%</span> <span class="fu">t</span>(yy)))</span>
<span id="cb67-40"><a href="m-step.html#cb67-40" tabindex="-1"></a>  }))</span>
<span id="cb67-41"><a href="m-step.html#cb67-41" tabindex="-1"></a>  </span>
<span id="cb67-42"><a href="m-step.html#cb67-42" tabindex="-1"></a>  <span class="do">## Mu, d x T matrix</span></span>
<span id="cb67-43"><a href="m-step.html#cb67-43" tabindex="-1"></a>  mumat <span class="ot">&lt;-</span> CVXR<span class="sc">::</span><span class="fu">Variable</span>(<span class="at">cols=</span>dimdat, <span class="at">rows=</span>TT)</span>
<span id="cb67-44"><a href="m-step.html#cb67-44" tabindex="-1"></a>  </span>
<span id="cb67-45"><a href="m-step.html#cb67-45" tabindex="-1"></a>  <span class="do">## Summed sqrt responsibilities - needed in the objective.</span></span>
<span id="cb67-46"><a href="m-step.html#cb67-46" tabindex="-1"></a>  resp.sum.sqrt <span class="ot">&lt;-</span> <span class="fu">lapply</span>(resp, <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">sqrt</span>(<span class="fu">sum</span>(x)))</span>
<span id="cb67-47"><a href="m-step.html#cb67-47" tabindex="-1"></a>  </span>
<span id="cb67-48"><a href="m-step.html#cb67-48" tabindex="-1"></a>  <span class="do">## Differencing Matrix, (TT-(l+1)) x TT </span></span>
<span id="cb67-49"><a href="m-step.html#cb67-49" tabindex="-1"></a>  Dlp1 <span class="ot">&lt;-</span> <a href='trend-filtering.html#gen_diff_mat'>gen_diff_mat</a>(<span class="at">n =</span> TT, <span class="at">l =</span> l<span class="sc">+</span><span class="dv">1</span>, <span class="at">x =</span> x)</span>
<span id="cb67-50"><a href="m-step.html#cb67-50" tabindex="-1"></a>  <span class="co"># l = 2 is quadratic trend filtering</span></span>
<span id="cb67-51"><a href="m-step.html#cb67-51" tabindex="-1"></a>  <span class="co"># l = 1 is linear trend filtering</span></span>
<span id="cb67-52"><a href="m-step.html#cb67-52" tabindex="-1"></a>  <span class="co"># l = 0 is fused lasso</span></span>
<span id="cb67-53"><a href="m-step.html#cb67-53" tabindex="-1"></a>  </span>
<span id="cb67-54"><a href="m-step.html#cb67-54" tabindex="-1"></a>  <span class="do">## Forming the objective</span></span>
<span id="cb67-55"><a href="m-step.html#cb67-55" tabindex="-1"></a>  obj <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>N) <span class="sc">*</span>( <span class="fu">Reduce</span>(<span class="st">&quot;+&quot;</span>, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(tt) CVXR<span class="sc">::</span><span class="fu">quad_form</span>(<span class="fu">t</span>(resp.sum.sqrt[[tt]]<span class="sc">*</span>mumat[tt,]), Sigma_inv))) <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">Reduce</span>(<span class="st">&quot;+&quot;</span>, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(tt) <span class="fu">t</span>(ytildes[tt,]) <span class="sc">%*%</span> Sigma_inv <span class="sc">%*%</span> <span class="fu">t</span>(mumat[tt,]))) <span class="sc">+</span> aux.y) <span class="sc">+</span> lambda <span class="sc">*</span> <span class="fu">sum</span>(CVXR<span class="sc">::</span><span class="fu">sum_entries</span>(<span class="fu">abs</span>(Dlp1 <span class="sc">%*%</span> mumat), <span class="at">axis =</span> <span class="dv">1</span>))</span>
<span id="cb67-56"><a href="m-step.html#cb67-56" tabindex="-1"></a></span>
<span id="cb67-57"><a href="m-step.html#cb67-57" tabindex="-1"></a>  <span class="do">##Reduce(&quot;+&quot;, lapply(1:TT, FUN = function(tt) t(ytildes[tt,]) %*% Sigma_inv %*% (mumat[tt,]))) + aux.y</span></span>
<span id="cb67-58"><a href="m-step.html#cb67-58" tabindex="-1"></a>  <span class="do">## a = t(resp.sum.sqrt[[tt]]*mumat[tt,])</span></span>
<span id="cb67-59"><a href="m-step.html#cb67-59" tabindex="-1"></a>  <span class="do">## CVXR::quad_form(resp.sum.sqrt[[tt]]*mumat[tt,], Sigma_inv)</span></span>
<span id="cb67-60"><a href="m-step.html#cb67-60" tabindex="-1"></a>    </span>
<span id="cb67-61"><a href="m-step.html#cb67-61" tabindex="-1"></a>    </span>
<span id="cb67-62"><a href="m-step.html#cb67-62" tabindex="-1"></a>  <span class="do">## resp.sum.sqrt[[tt]]*mumat[tt,] %&gt;% dim()</span></span>
<span id="cb67-63"><a href="m-step.html#cb67-63" tabindex="-1"></a>  <span class="do">## dim(Sigma_inv)</span></span>
<span id="cb67-64"><a href="m-step.html#cb67-64" tabindex="-1"></a>  <span class="do">## mumat %&gt;% dim()</span></span>
<span id="cb67-65"><a href="m-step.html#cb67-65" tabindex="-1"></a>  <span class="do">## ( (resp.sum.sqrt[[tt]]) * mumat[tt,]) %&gt;% dim()</span></span>
<span id="cb67-66"><a href="m-step.html#cb67-66" tabindex="-1"></a>  </span>
<span id="cb67-67"><a href="m-step.html#cb67-67" tabindex="-1"></a></span>
<span id="cb67-68"><a href="m-step.html#cb67-68" tabindex="-1"></a>  <span class="do">## Putting together the ball constraint</span></span>
<span id="cb67-69"><a href="m-step.html#cb67-69" tabindex="-1"></a>  rowmns <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="dv">1</span>, TT<span class="sc">^</span><span class="dv">2</span>), <span class="at">nrow =</span> TT)<span class="sc">/</span>TT</span>
<span id="cb67-70"><a href="m-step.html#cb67-70" tabindex="-1"></a>  mu_dotdot <span class="ot">&lt;-</span> rowmns <span class="sc">%*%</span> mumat</span>
<span id="cb67-71"><a href="m-step.html#cb67-71" tabindex="-1"></a>  constraints <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb67-72"><a href="m-step.html#cb67-72" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(maxdev)){</span>
<span id="cb67-73"><a href="m-step.html#cb67-73" tabindex="-1"></a>    constraints <span class="ot">=</span> <span class="fu">list</span>(CVXR<span class="sc">::</span><span class="fu">sum_entries</span>(CVXR<span class="sc">::</span><span class="fu">square</span>(mumat <span class="sc">-</span> mu_dotdot), <span class="at">axis =</span> <span class="dv">2</span>) <span class="sc">&lt;=</span> <span class="fu">rep</span>(maxdev<span class="sc">^</span><span class="dv">2</span>, TT) )</span>
<span id="cb67-74"><a href="m-step.html#cb67-74" tabindex="-1"></a>  }</span>
<span id="cb67-75"><a href="m-step.html#cb67-75" tabindex="-1"></a>  </span>
<span id="cb67-76"><a href="m-step.html#cb67-76" tabindex="-1"></a>  <span class="do">## Try all two CVXR solvers.</span></span>
<span id="cb67-77"><a href="m-step.html#cb67-77" tabindex="-1"></a>  prob <span class="ot">&lt;-</span> CVXR<span class="sc">::</span><span class="fu">Problem</span>(CVXR<span class="sc">::</span><span class="fu">Minimize</span>(obj), constraints)</span>
<span id="cb67-78"><a href="m-step.html#cb67-78" tabindex="-1"></a>  result <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb67-79"><a href="m-step.html#cb67-79" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb67-80"><a href="m-step.html#cb67-80" tabindex="-1"></a>    CVXR<span class="sc">::</span><span class="fu">solve</span>(prob, <span class="at">solver=</span><span class="st">&quot;ECOS&quot;</span>,</span>
<span id="cb67-81"><a href="m-step.html#cb67-81" tabindex="-1"></a>          <span class="at">FEASTOL =</span> ecos_thresh, <span class="at">RELTOL =</span> ecos_thresh, <span class="at">ABSTOL =</span> ecos_thresh)</span>
<span id="cb67-82"><a href="m-step.html#cb67-82" tabindex="-1"></a>  }, <span class="at">error=</span><span class="cf">function</span>(err){</span>
<span id="cb67-83"><a href="m-step.html#cb67-83" tabindex="-1"></a>    err<span class="sc">$</span>message <span class="ot">=</span> <span class="fu">paste</span>(err<span class="sc">$</span>message, </span>
<span id="cb67-84"><a href="m-step.html#cb67-84" tabindex="-1"></a>                        <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="st">&quot;Lasso solver using ECOS has failed.&quot;</span> ,<span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb67-85"><a href="m-step.html#cb67-85" tabindex="-1"></a>    <span class="fu">cat</span>(err<span class="sc">$</span>message, <span class="at">fill=</span><span class="cn">TRUE</span>)</span>
<span id="cb67-86"><a href="m-step.html#cb67-86" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb67-87"><a href="m-step.html#cb67-87" tabindex="-1"></a>  })</span>
<span id="cb67-88"><a href="m-step.html#cb67-88" tabindex="-1"></a>  </span>
<span id="cb67-89"><a href="m-step.html#cb67-89" tabindex="-1"></a>  <span class="do">## If anything is wrong, flag to use SCS solver</span></span>
<span id="cb67-90"><a href="m-step.html#cb67-90" tabindex="-1"></a>  scs <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb67-91"><a href="m-step.html#cb67-91" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(result)){</span>
<span id="cb67-92"><a href="m-step.html#cb67-92" tabindex="-1"></a>    scs <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb67-93"><a href="m-step.html#cb67-93" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb67-94"><a href="m-step.html#cb67-94" tabindex="-1"></a>    <span class="cf">if</span>(result<span class="sc">$</span>status <span class="sc">!=</span> <span class="st">&quot;optimal&quot;</span>) scs <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb67-95"><a href="m-step.html#cb67-95" tabindex="-1"></a>  }</span>
<span id="cb67-96"><a href="m-step.html#cb67-96" tabindex="-1"></a>  </span>
<span id="cb67-97"><a href="m-step.html#cb67-97" tabindex="-1"></a>  <span class="do">## Use the SCS solver</span></span>
<span id="cb67-98"><a href="m-step.html#cb67-98" tabindex="-1"></a>  <span class="cf">if</span>(scs){</span>
<span id="cb67-99"><a href="m-step.html#cb67-99" tabindex="-1"></a>    result <span class="ot">=</span> CVXR<span class="sc">::</span><span class="fu">solve</span>(prob, <span class="at">solver=</span><span class="st">&quot;SCS&quot;</span>, <span class="at">eps =</span> scs_eps)</span>
<span id="cb67-100"><a href="m-step.html#cb67-100" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.na</span>(result<span class="sc">$</span><span class="fu">getValue</span>(mumat)))){ <span class="do">## A clumsy way to check.</span></span>
<span id="cb67-101"><a href="m-step.html#cb67-101" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">&quot;Lasso solver using both ECOS and SCS has failed.&quot;</span>, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb67-102"><a href="m-step.html#cb67-102" tabindex="-1"></a>    }</span>
<span id="cb67-103"><a href="m-step.html#cb67-103" tabindex="-1"></a>  }</span>
<span id="cb67-104"><a href="m-step.html#cb67-104" tabindex="-1"></a>  </span>
<span id="cb67-105"><a href="m-step.html#cb67-105" tabindex="-1"></a>  <span class="do">## Record Interesting Parameters</span></span>
<span id="cb67-106"><a href="m-step.html#cb67-106" tabindex="-1"></a>  num_iters <span class="ot">&lt;-</span> result<span class="sc">$</span>num_iters</span>
<span id="cb67-107"><a href="m-step.html#cb67-107" tabindex="-1"></a>  status <span class="ot">&lt;-</span> result<span class="sc">$</span>status</span>
<span id="cb67-108"><a href="m-step.html#cb67-108" tabindex="-1"></a>  mumat <span class="ot">&lt;-</span> result<span class="sc">$</span><span class="fu">getValue</span>(mumat)</span>
<span id="cb67-109"><a href="m-step.html#cb67-109" tabindex="-1"></a>  val <span class="ot">&lt;-</span> result<span class="sc">$</span>value</span>
<span id="cb67-110"><a href="m-step.html#cb67-110" tabindex="-1"></a>  </span>
<span id="cb67-111"><a href="m-step.html#cb67-111" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mu =</span> mumat, <span class="at">value =</span> val, <span class="at">status =</span> status, <span class="at">num_iters =</span> num_iters))</span>
<span id="cb67-112"><a href="m-step.html#cb67-112" tabindex="-1"></a>}</span></code></pre></div>
<p>This function solves the following problem:</p>
<p><span class="math display">\[
\begin{align*}
&amp;\text{minimize}_{\mu}
{\frac{1}{2N}
    \sum_{t=1}^T \sum_{i=1}^{n_t} \hat{\gamma}_{it} (y_i^{(t)} - \mu_{\cdot t})^\top \hat{\Sigma}^{-1} ( y_i^{(t)} - \mu_{\cdot t})
  + \lambda \sum_{j=1}^d \|D^{(l)}\mu_{j\cdot }\|_1}\\
&amp;\text{subject to}\;\; {\| \mu_{\cdot t} - \bar{\mu}_{\cdot \cdot}\|_2 \le r \;\;\forall t=1,\cdots, T, }
\end{align*}
\]</span></p>
<p>and is directly equivalent to <code><a href='m-step.html#Mstep_mu'>Mstep_mu</a>()</code>. The resulting solution and the
objective value should be the same. Let’s check that.</p>
<p>First, set up some objects to run <code><a href='m-step.html#Mstep_mu'>Mstep_mu</a>()</code> and <code><a href='m-step.html#Mstep_mu_cvxr'>Mstep_mu_cvxr</a>()</code>.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="m-step.html#cb68-1" tabindex="-1"></a>numclust <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb68-2"><a href="m-step.html#cb68-2" tabindex="-1"></a>TT <span class="ot">=</span> <span class="dv">100</span></span>
<span id="cb68-3"><a href="m-step.html#cb68-3" tabindex="-1"></a>dimdat <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb68-4"><a href="m-step.html#cb68-4" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">0</span>)</span>
<span id="cb68-5"><a href="m-step.html#cb68-5" tabindex="-1"></a>dt <span class="ot">=</span> <a href='package-setup.html#gendat_1d'>gendat_1d</a>(<span class="at">TT =</span> TT, <span class="at">ntlist =</span> <span class="fu">rep</span>(TT, <span class="dv">100</span>))</span>
<span id="cb68-6"><a href="m-step.html#cb68-6" tabindex="-1"></a>ylist <span class="ot">=</span> dt <span class="sc">%&gt;%</span> <a href='package-setup.html#dt2ylist'>dt2ylist</a>()</span>
<span id="cb68-7"><a href="m-step.html#cb68-7" tabindex="-1"></a>sigma <span class="ot">=</span> <a href='initial-parameters-for-em-algorithm.html#init_sigma'>init_sigma</a>(ylist, numclust) <span class="do">## (T x numclust x (dimdat x dimdat))</span></span>
<span id="cb68-8"><a href="m-step.html#cb68-8" tabindex="-1"></a>mn <span class="ot">=</span> <a href='initial-parameters-for-em-algorithm.html#init_mn'>init_mn</a>(ylist, numclust, TT, dimdat)<span class="do">##, countslist = countslist) </span></span>
<span id="cb68-9"><a href="m-step.html#cb68-9" tabindex="-1"></a>prob <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">/</span>numclust, <span class="at">nrow =</span> TT, <span class="at">ncol =</span> numclust) <span class="do">## Initialize to all 1/K.</span></span>
<span id="cb68-10"><a href="m-step.html#cb68-10" tabindex="-1"></a>resp <span class="ot">=</span> <a href='e-step.html#Estep'>Estep</a>(mn, sigma, prob, <span class="at">ylist =</span> ylist, numclust)</span>
<span id="cb68-11"><a href="m-step.html#cb68-11" tabindex="-1"></a>lambda <span class="ot">=</span> .<span class="dv">01</span></span>
<span id="cb68-12"><a href="m-step.html#cb68-12" tabindex="-1"></a>l <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb68-13"><a href="m-step.html#cb68-13" tabindex="-1"></a>x <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span>TT</span>
<span id="cb68-14"><a href="m-step.html#cb68-14" tabindex="-1"></a>Dlp1 <span class="ot">=</span> <a href='trend-filtering.html#gen_diff_mat'>gen_diff_mat</a>(<span class="at">n =</span> TT, <span class="at">l =</span> l<span class="sc">+</span><span class="dv">1</span>, <span class="at">x =</span> x)</span>
<span id="cb68-15"><a href="m-step.html#cb68-15" tabindex="-1"></a>Dl <span class="ot">=</span> <a href='trend-filtering.html#gen_diff_mat'>gen_diff_mat</a>(<span class="at">n =</span> TT, <span class="at">l =</span> l, <span class="at">x =</span> x)</span>
<span id="cb68-16"><a href="m-step.html#cb68-16" tabindex="-1"></a>Dlsqrd <span class="ot">&lt;-</span> <span class="fu">t</span>(Dl) <span class="sc">%*%</span> Dl</span>
<span id="cb68-17"><a href="m-step.html#cb68-17" tabindex="-1"></a>maxdev <span class="ot">=</span> <span class="cn">NULL</span></span></code></pre></div>
<p>Then, compare the result of the two implementations. They should look identical.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="m-step.html#cb69-1" tabindex="-1"></a><span class="do">## overall ADMM</span></span>
<span id="cb69-2"><a href="m-step.html#cb69-2" tabindex="-1"></a>res1 <span class="ot">=</span> <a href='m-step.html#Mstep_mu'>Mstep_mu</a>(resp, ylist, lambda, <span class="at">l=</span>l, <span class="at">sigma=</span>sigma, <span class="at">Dlsqrd =</span> Dlsqrd, <span class="at">Dl=</span>Dl, <span class="at">Dlp1=</span>Dlp1, <span class="at">TT=</span>TT, <span class="at">N=</span>N, <span class="at">dimdat=</span>dimdat, <span class="at">e_mat=</span><a href='m-step.html#etilde_mat'>etilde_mat</a>(<span class="at">TT =</span> TT),</span>
<span id="cb69-3"><a href="m-step.html#cb69-3" tabindex="-1"></a>                <span class="at">maxdev =</span> maxdev)</span>
<span id="cb69-4"><a href="m-step.html#cb69-4" tabindex="-1"></a>mn1 <span class="ot">=</span> res1<span class="sc">$</span>mns</span>
<span id="cb69-5"><a href="m-step.html#cb69-5" tabindex="-1"></a></span>
<span id="cb69-6"><a href="m-step.html#cb69-6" tabindex="-1"></a><span class="do">## CVXR just ONE cluster</span></span>
<span id="cb69-7"><a href="m-step.html#cb69-7" tabindex="-1"></a>res2list <span class="ot">=</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>numclust, <span class="cf">function</span>(iclust){</span>
<span id="cb69-8"><a href="m-step.html#cb69-8" tabindex="-1"></a>  Sigma_inv_oneclust <span class="ot">=</span> <span class="fu">solve</span>(sigma[iclust,,])</span>
<span id="cb69-9"><a href="m-step.html#cb69-9" tabindex="-1"></a>  resp_oneclist <span class="ot">=</span> <span class="fu">lapply</span>(resp, <span class="cf">function</span>(resp_onetime){resp_onetime[,iclust, drop<span class="ot">=</span><span class="cn">FALSE</span>]})</span>
<span id="cb69-10"><a href="m-step.html#cb69-10" tabindex="-1"></a>  N <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">unlist</span>(resp))</span>
<span id="cb69-11"><a href="m-step.html#cb69-11" tabindex="-1"></a>  res2 <span class="ot">=</span> <a href='m-step.html#Mstep_mu_cvxr'>Mstep_mu_cvxr</a>(ylist, resp_oneclist,</span>
<span id="cb69-12"><a href="m-step.html#cb69-12" tabindex="-1"></a>                       lambda, l,  Sigma_inv_oneclust,</span>
<span id="cb69-13"><a href="m-step.html#cb69-13" tabindex="-1"></a>                       <span class="at">thresh =</span> <span class="fl">1E-8</span>, <span class="at">maxdev =</span> maxdev, dimdat, N) </span>
<span id="cb69-14"><a href="m-step.html#cb69-14" tabindex="-1"></a>  res2<span class="sc">$</span>mu</span>
<span id="cb69-15"><a href="m-step.html#cb69-15" tabindex="-1"></a>})</span>
<span id="cb69-16"><a href="m-step.html#cb69-16" tabindex="-1"></a>mn2 <span class="ot">=</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(<span class="dv">100</span>, dimdat, <span class="dv">3</span>))</span>
<span id="cb69-17"><a href="m-step.html#cb69-17" tabindex="-1"></a><span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>numclust){</span>
<span id="cb69-18"><a href="m-step.html#cb69-18" tabindex="-1"></a>  mn2[,,iclust] <span class="ot">=</span> res2list[[iclust]] <span class="sc">%&gt;%</span>  <span class="fu">as.matrix</span>()</span>
<span id="cb69-19"><a href="m-step.html#cb69-19" tabindex="-1"></a>}</span>
<span id="cb69-20"><a href="m-step.html#cb69-20" tabindex="-1"></a></span>
<span id="cb69-21"><a href="m-step.html#cb69-21" tabindex="-1"></a>  </span>
<span id="cb69-22"><a href="m-step.html#cb69-22" tabindex="-1"></a><span class="do">## Plot them</span></span>
<span id="cb69-23"><a href="m-step.html#cb69-23" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> dt<span class="sc">$</span>time, <span class="at">y=</span>dt<span class="sc">$</span>Y, <span class="at">col =</span> <span class="fu">rgb</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.04</span>),</span>
<span id="cb69-24"><a href="m-step.html#cb69-24" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">&#39;admm (solid) vs cvxr (dashed)&#39;</span>,</span>
<span id="cb69-25"><a href="m-step.html#cb69-25" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">&quot;&quot;</span>, <span class="at">xlab =</span> <span class="st">&quot;time&quot;</span>)</span>
<span id="cb69-26"><a href="m-step.html#cb69-26" tabindex="-1"></a>mn1[,<span class="dv">1</span>,] <span class="sc">%&gt;%</span> <span class="fu">matlines</span>(<span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="dv">1</span>)</span>
<span id="cb69-27"><a href="m-step.html#cb69-27" tabindex="-1"></a>mn2[,<span class="dv">1</span>,] <span class="sc">%&gt;%</span> <span class="fu">matlines</span>(<span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">lty =</span> <span class="dv">3</span>)</span></code></pre></div>
<p>Next, do this for uneven inputs.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="m-step.html#cb70-1" tabindex="-1"></a><span class="do">## Setup</span></span>
<span id="cb70-2"><a href="m-step.html#cb70-2" tabindex="-1"></a>numclust <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb70-3"><a href="m-step.html#cb70-3" tabindex="-1"></a>TT <span class="ot">=</span> <span class="dv">100</span></span>
<span id="cb70-4"><a href="m-step.html#cb70-4" tabindex="-1"></a>dimdat <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb70-5"><a href="m-step.html#cb70-5" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">0</span>)</span>
<span id="cb70-6"><a href="m-step.html#cb70-6" tabindex="-1"></a>dt <span class="ot">=</span> <a href='package-setup.html#gendat_1d'>gendat_1d</a>(<span class="at">TT =</span> TT, <span class="at">ntlist =</span> <span class="fu">rep</span>(TT, <span class="dv">100</span>))</span>
<span id="cb70-7"><a href="m-step.html#cb70-7" tabindex="-1"></a>ylist <span class="ot">=</span> dt <span class="sc">%&gt;%</span> <a href='package-setup.html#dt2ylist'>dt2ylist</a>()</span>
<span id="cb70-8"><a href="m-step.html#cb70-8" tabindex="-1"></a></span>
<span id="cb70-9"><a href="m-step.html#cb70-9" tabindex="-1"></a><span class="do">## Subset them</span></span>
<span id="cb70-10"><a href="m-step.html#cb70-10" tabindex="-1"></a>ylist <span class="ot">=</span> ylist[<span class="sc">-</span><span class="fu">seq</span>(<span class="at">from=</span><span class="dv">10</span>,<span class="at">to=</span><span class="dv">100</span>,<span class="at">by=</span><span class="dv">10</span>)]</span>
<span id="cb70-11"><a href="m-step.html#cb70-11" tabindex="-1"></a>x <span class="ot">=</span> (<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>)[<span class="sc">-</span><span class="fu">seq</span>(<span class="at">from=</span><span class="dv">10</span>,<span class="at">to=</span><span class="dv">100</span>,<span class="at">by=</span><span class="dv">10</span>)]</span>
<span id="cb70-12"><a href="m-step.html#cb70-12" tabindex="-1"></a></span>
<span id="cb70-13"><a href="m-step.html#cb70-13" tabindex="-1"></a>sigma <span class="ot">=</span> <a href='initial-parameters-for-em-algorithm.html#init_sigma'>init_sigma</a>(ylist, numclust) <span class="do">## (T x numclust x (dimdat x dimdat))</span></span>
<span id="cb70-14"><a href="m-step.html#cb70-14" tabindex="-1"></a>mn <span class="ot">=</span> <a href='initial-parameters-for-em-algorithm.html#init_mn'>init_mn</a>(ylist, numclust, TT, dimdat)<span class="do">##, countslist = countslist)</span></span>
<span id="cb70-15"><a href="m-step.html#cb70-15" tabindex="-1"></a>prob <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">/</span>numclust, <span class="at">nrow =</span> TT, <span class="at">ncol =</span> numclust) <span class="do">## Initialize to all 1/K.</span></span>
<span id="cb70-16"><a href="m-step.html#cb70-16" tabindex="-1"></a>resp <span class="ot">=</span> <a href='e-step.html#Estep'>Estep</a>(mn, sigma, prob, <span class="at">ylist =</span> ylist, numclust)</span>
<span id="cb70-17"><a href="m-step.html#cb70-17" tabindex="-1"></a>lambda <span class="ot">=</span> .<span class="dv">1</span></span>
<span id="cb70-18"><a href="m-step.html#cb70-18" tabindex="-1"></a>l <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb70-19"><a href="m-step.html#cb70-19" tabindex="-1"></a><span class="do">##x = 1:TT</span></span>
<span id="cb70-20"><a href="m-step.html#cb70-20" tabindex="-1"></a>Dlp1 <span class="ot">=</span> <a href='trend-filtering.html#gen_diff_mat'>gen_diff_mat</a>(<span class="at">n =</span> <span class="fu">length</span>(x), <span class="at">l =</span> l<span class="sc">+</span><span class="dv">1</span>, <span class="at">x =</span> x)</span>
<span id="cb70-21"><a href="m-step.html#cb70-21" tabindex="-1"></a>Dl <span class="ot">=</span> <a href='trend-filtering.html#gen_diff_mat'>gen_diff_mat</a>(<span class="at">n =</span> <span class="fu">length</span>(x), <span class="at">l =</span> l, <span class="at">x =</span> x)</span>
<span id="cb70-22"><a href="m-step.html#cb70-22" tabindex="-1"></a>Dlsqrd <span class="ot">&lt;-</span> <span class="fu">t</span>(Dl) <span class="sc">%*%</span> Dl</span>
<span id="cb70-23"><a href="m-step.html#cb70-23" tabindex="-1"></a>maxdev <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb70-24"><a href="m-step.html#cb70-24" tabindex="-1"></a></span>
<span id="cb70-25"><a href="m-step.html#cb70-25" tabindex="-1"></a></span>
<span id="cb70-26"><a href="m-step.html#cb70-26" tabindex="-1"></a><span class="do">## Try the algorithm itelf.</span></span>
<span id="cb70-27"><a href="m-step.html#cb70-27" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb70-28"><a href="m-step.html#cb70-28" tabindex="-1"></a>obj <span class="ot">=</span> <a href='flowtrend.html#flowtrend_once'>flowtrend_once</a>(<span class="at">ylist =</span> ylist, <span class="at">x =</span> x, <span class="at">lambda =</span> .<span class="dv">1</span>, <span class="at">lambda_prob =</span> .<span class="dv">1</span>,</span>
<span id="cb70-29"><a href="m-step.html#cb70-29" tabindex="-1"></a>                     <span class="at">l =</span> <span class="dv">2</span>, <span class="at">l_prob =</span> <span class="dv">2</span>, <span class="at">maxdev =</span> <span class="dv">5</span>, <span class="at">numclust =</span> <span class="dv">3</span>,</span>
<span id="cb70-30"><a href="m-step.html#cb70-30" tabindex="-1"></a>                     <span class="at">rho_init =</span> <span class="fl">0.01</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-31"><a href="m-step.html#cb70-31" tabindex="-1"></a><a href='package-setup.html#plot_1d'>plot_1d</a>(<span class="at">ylist=</span>ylist, <span class="at">obj=</span>obj)</span>
<span id="cb70-32"><a href="m-step.html#cb70-32" tabindex="-1"></a><span class="fu">plot</span>(obj<span class="sc">$</span>objectives, <span class="at">type =</span><span class="st">&#39;l&#39;</span>)</span>
<span id="cb70-33"><a href="m-step.html#cb70-33" tabindex="-1"></a>mn1 <span class="ot">=</span> obj<span class="sc">$</span>mn</span>
<span id="cb70-34"><a href="m-step.html#cb70-34" tabindex="-1"></a>obj<span class="sc">$</span>mn[,<span class="dv">1</span>,] <span class="sc">%&gt;%</span> <span class="fu">diff</span>() <span class="sc">%&gt;%</span> <span class="fu">diff</span>() <span class="sc">%&gt;%</span> <span class="fu">diff</span>() <span class="sc">%&gt;%</span> <span class="fu">matplot</span>(<span class="at">type=</span><span class="st">&#39;l&#39;</span>)</span>
<span id="cb70-35"><a href="m-step.html#cb70-35" tabindex="-1"></a>mn[,<span class="dv">1</span>,] <span class="sc">%&gt;%</span> <span class="fu">diff</span>() <span class="sc">%&gt;%</span> <span class="fu">diff</span>() <span class="sc">%&gt;%</span> <span class="fu">diff</span>() <span class="sc">%&gt;%</span> <span class="fu">matplot</span>(<span class="at">type=</span><span class="st">&#39;l&#39;</span>)</span>
<span id="cb70-36"><a href="m-step.html#cb70-36" tabindex="-1"></a>mn[,<span class="dv">1</span>,] <span class="sc">%&gt;%</span> <span class="fu">matplot</span>(<span class="at">type=</span><span class="st">&#39;l&#39;</span>)</span>
<span id="cb70-37"><a href="m-step.html#cb70-37" tabindex="-1"></a><span class="do">## Okay, so cluster 3 has a very irregular mean.</span></span>
<span id="cb70-38"><a href="m-step.html#cb70-38" tabindex="-1"></a></span>
<span id="cb70-39"><a href="m-step.html#cb70-39" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> dt<span class="sc">$</span>time, <span class="at">y=</span>dt<span class="sc">$</span>Y, <span class="at">col =</span> <span class="fu">rgb</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.04</span>),</span>
<span id="cb70-40"><a href="m-step.html#cb70-40" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">&#39;admm (solid) vs cvxr (dashed)&#39;</span>,</span>
<span id="cb70-41"><a href="m-step.html#cb70-41" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">&quot;&quot;</span>, <span class="at">xlab =</span> <span class="st">&quot;time&quot;</span>)</span>
<span id="cb70-42"><a href="m-step.html#cb70-42" tabindex="-1"></a>mn_old[,<span class="dv">1</span>,] <span class="sc">%&gt;%</span> <span class="fu">matlines</span>(<span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">x=</span>x, <span class="at">lty =</span> <span class="dv">1</span>)</span>
<span id="cb70-43"><a href="m-step.html#cb70-43" tabindex="-1"></a>mn_less_old[,<span class="dv">1</span>,] <span class="sc">%&gt;%</span> <span class="fu">matlines</span>(<span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">x=</span>x, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb70-44"><a href="m-step.html#cb70-44" tabindex="-1"></a>mn[,<span class="dv">1</span>,] <span class="sc">%&gt;%</span> <span class="fu">matlines</span>(<span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">x=</span>x, <span class="at">lty =</span> <span class="dv">3</span>)</span>
<span id="cb70-45"><a href="m-step.html#cb70-45" tabindex="-1"></a> </span></code></pre></div>
<p>TODO: We just need to bundle this into <code>testthat</code> style tests, and make sure to test several lambda values.</p>
<p>TODO: maybe do this for unevenly spaced inputs. CVXR needs to take a different D matrix.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="m-step.html#cb71-1" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;Test the M step of \mu against CVXR&quot;</span>, {})</span></code></pre></div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="e-step.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="flowtrend.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
