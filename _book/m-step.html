<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>8 M step | Creating the flowtrend R package</title>
  <meta name="description" content="8 M step | Creating the flowtrend R package" />
  <meta name="generator" content="bookdown 0.33 and GitBook 2.6.7" />

  <meta property="og:title" content="8 M step | Creating the flowtrend R package" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="8 M step | Creating the flowtrend R package" />
  
  
  

<meta name="author" content="Sangwon Hyun" />


<meta name="date" content="2023-05-30" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="e-step.html"/>
<link rel="next" href="flowtrend.html"/>
<script src="libs/header-attrs-2.21/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="package-setup.html"><a href="package-setup.html"><i class="fa fa-check"></i><b>2</b> Package setup</a>
<ul>
<li class="chapter" data-level="2.1" data-path="package-setup.html"><a href="package-setup.html#plotting-1d-data"><i class="fa fa-check"></i><b>2.1</b> Plotting 1d data</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="d-data.html"><a href="d-data.html"><i class="fa fa-check"></i><b>3</b> 2d data</a>
<ul>
<li class="chapter" data-level="3.1" data-path="d-data.html"><a href="d-data.html#generating-2d-data"><i class="fa fa-check"></i><b>3.1</b> Generating 2d data</a></li>
<li class="chapter" data-level="3.2" data-path="d-data.html"><a href="d-data.html#plotting-2d-data"><i class="fa fa-check"></i><b>3.2</b> Plotting 2d data</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="trend-filtering.html"><a href="trend-filtering.html"><i class="fa fa-check"></i><b>4</b> Trend filtering</a></li>
<li class="chapter" data-level="5" data-path="objective-data-log-likelihood.html"><a href="objective-data-log-likelihood.html"><i class="fa fa-check"></i><b>5</b> Objective (data log-likelihood)</a></li>
<li class="chapter" data-level="6" data-path="initial-parameters-for-em-algorithm.html"><a href="initial-parameters-for-em-algorithm.html"><i class="fa fa-check"></i><b>6</b> Initial parameters for EM algorithm</a></li>
<li class="chapter" data-level="7" data-path="e-step.html"><a href="e-step.html"><i class="fa fa-check"></i><b>7</b> E step</a></li>
<li class="chapter" data-level="8" data-path="m-step.html"><a href="m-step.html"><i class="fa fa-check"></i><b>8</b> M step</a>
<ul>
<li class="chapter" data-level="8.1" data-path="m-step.html"><a href="m-step.html#m-step-for-pi"><i class="fa fa-check"></i><b>8.1</b> M step for <span class="math inline">\(\pi\)</span></a></li>
<li class="chapter" data-level="8.2" data-path="m-step.html"><a href="m-step.html#m-step-for-sigma"><i class="fa fa-check"></i><b>8.2</b> M step for <span class="math inline">\(\Sigma\)</span></a></li>
<li class="chapter" data-level="8.3" data-path="m-step.html"><a href="m-step.html#m-step-for-mu"><i class="fa fa-check"></i><b>8.3</b> M step for <span class="math inline">\(\mu\)</span></a></li>
<li class="chapter" data-level="8.4" data-path="m-step.html"><a href="m-step.html#helpers-for-m-step-mu"><i class="fa fa-check"></i><b>8.4</b> Helpers for M step (<span class="math inline">\(\mu\)</span>)</a></li>
<li class="chapter" data-level="8.5" data-path="m-step.html"><a href="m-step.html#all-rcpp-functions"><i class="fa fa-check"></i><b>8.5</b> All Rcpp functions</a></li>
<li class="chapter" data-level="8.6" data-path="m-step.html"><a href="m-step.html#ported-over-from-flowmix"><i class="fa fa-check"></i><b>8.6</b> Ported over from flowmix</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="flowtrend.html"><a href="flowtrend.html"><i class="fa fa-check"></i><b>9</b> flowtrend</a></li>
<li class="chapter" data-level="10" data-path="reordering-clusters.html"><a href="reordering-clusters.html"><i class="fa fa-check"></i><b>10</b> Reordering clusters</a></li>
<li class="chapter" data-level="11" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html"><i class="fa fa-check"></i><b>11</b> Tuning the regularization parameters for <code>flowtrend</code></a>
<ul>
<li class="chapter" data-level="11.1" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html#predicting-and-evaluating-on-new-time-points"><i class="fa fa-check"></i><b>11.1</b> Predicting and evaluating on new time points</a></li>
<li class="chapter" data-level="11.2" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html#maximum-lambda_mu-lambda_pi-values-to-test"><i class="fa fa-check"></i><b>11.2</b> Maximum <span class="math inline">\((\lambda_\mu, \lambda_\pi)\)</span> values to test</a></li>
<li class="chapter" data-level="11.3" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html#define-cv-data-folds"><i class="fa fa-check"></i><b>11.3</b> Define CV data folds</a></li>
<li class="chapter" data-level="11.4" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html#cv-many-single-jobs"><i class="fa fa-check"></i><b>11.4</b> CV = many single jobs</a></li>
<li class="chapter" data-level="11.5" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html#running-cross-validation"><i class="fa fa-check"></i><b>11.5</b> Running cross-validation</a></li>
<li class="chapter" data-level="11.6" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html#summarizing-the-output"><i class="fa fa-check"></i><b>11.6</b> Summarizing the output</a></li>
<li class="chapter" data-level="11.7" data-path="tuning-the-regularization-parameters-for-flowtrend.html"><a href="tuning-the-regularization-parameters-for-flowtrend.html#cv-on-your-own-computer"><i class="fa fa-check"></i><b>11.7</b> CV on your own computer</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html"><i class="fa fa-check"></i><b>12</b> Testing the flowtrend method</a>
<ul>
<li class="chapter" data-level="12.1" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html#id_1d-example"><i class="fa fa-check"></i><b>12.1</b> 1d example</a></li>
<li class="chapter" data-level="12.2" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html#testing-monotonicity-of-objective-values"><i class="fa fa-check"></i><b>12.2</b> Testing monotonicity of objective values</a></li>
<li class="chapter" data-level="12.3" data-path="testing-the-flowtrend-method.html"><a href="testing-the-flowtrend-method.html#id_2d-example"><i class="fa fa-check"></i><b>12.3</b> 2d example</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="documenting-the-package-and-building.html"><a href="documenting-the-package-and-building.html"><i class="fa fa-check"></i><b>13</b> Documenting the package and building</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Creating the <code>flowtrend</code> R package</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="m-step" class="section level1 hasAnchor" number="8">
<h1><span class="header-section-number">8</span> M step<a href="m-step.html#m-step" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>The M step of the EM algorithm has three steps – one each for <span class="math inline">\(\mu\)</span>, <span class="math inline">\(\pi\)</span>, and
<span class="math inline">\(\Sigma\)</span>.</p>
<div id="m-step-for-pi" class="section level2 hasAnchor" number="8.1">
<h2><span class="header-section-number">8.1</span> M step for <span class="math inline">\(\pi\)</span><a href="m-step.html#m-step-for-pi" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="m-step.html#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; The M step for the cluster probabilities</span></span>
<span id="cb40-2"><a href="m-step.html#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb40-3"><a href="m-step.html#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param resp Responsibilities.</span></span>
<span id="cb40-4"><a href="m-step.html#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param H_tf Trend filtering matrix.</span></span>
<span id="cb40-5"><a href="m-step.html#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param countslist Particle multiplicities.</span></span>
<span id="cb40-6"><a href="m-step.html#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param lambda_prob Regularization. </span></span>
<span id="cb40-7"><a href="m-step.html#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param l_prob Trend filtering degree.</span></span>
<span id="cb40-8"><a href="m-step.html#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb40-9"><a href="m-step.html#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return (T x k) matrix containing the alphas, for \code{prob = exp(alpha)/</span></span>
<span id="cb40-10"><a href="m-step.html#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;         rowSums(exp(alpha))}.</span></span>
<span id="cb40-11"><a href="m-step.html#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb40-12"><a href="m-step.html#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb40-13"><a href="m-step.html#cb40-13" aria-hidden="true" tabindex="-1"></a><span id='Mstep_prob'>Mstep_prob</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(resp, H_tf, <span class="at">countslist =</span> <span class="cn">NULL</span>,</span>
<span id="cb40-14"><a href="m-step.html#cb40-14" aria-hidden="true" tabindex="-1"></a>                       <span class="at">lambda_prob =</span> <span class="cn">NULL</span>, <span class="at">l_prob =</span> <span class="cn">NULL</span>, <span class="at">x =</span> <span class="cn">NULL</span>){</span>
<span id="cb40-15"><a href="m-step.html#cb40-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-16"><a href="m-step.html#cb40-16" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Basic setup</span></span>
<span id="cb40-17"><a href="m-step.html#cb40-17" aria-hidden="true" tabindex="-1"></a>  TT <span class="ot">&lt;-</span> <span class="fu">length</span>(resp)</span>
<span id="cb40-18"><a href="m-step.html#cb40-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-19"><a href="m-step.html#cb40-19" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Basic checks</span></span>
<span id="cb40-20"><a href="m-step.html#cb40-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.null</span>(l_prob) <span class="sc">==</span> <span class="fu">is.null</span>(lambda_prob))</span>
<span id="cb40-21"><a href="m-step.html#cb40-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-22"><a href="m-step.html#cb40-22" aria-hidden="true" tabindex="-1"></a>  <span class="do">## If glmnet isn&#39;t actually needed, don&#39;t use it.</span></span>
<span id="cb40-23"><a href="m-step.html#cb40-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(l_prob) <span class="sc">&amp;</span> <span class="fu">is.null</span>(lambda_prob)){</span>
<span id="cb40-24"><a href="m-step.html#cb40-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-25"><a href="m-step.html#cb40-25" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Calculate the average responsibilities, per time point.</span></span>
<span id="cb40-26"><a href="m-step.html#cb40-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(countslist)){</span>
<span id="cb40-27"><a href="m-step.html#cb40-27" aria-hidden="true" tabindex="-1"></a>      resp.avg <span class="ot">&lt;-</span> <span class="fu">lapply</span>(resp, colMeans) <span class="sc">%&gt;%</span> <span class="fu">do.call</span>(rbind, .)</span>
<span id="cb40-28"><a href="m-step.html#cb40-28" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb40-29"><a href="m-step.html#cb40-29" aria-hidden="true" tabindex="-1"></a>      resp.avg <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(ii){</span>
<span id="cb40-30"><a href="m-step.html#cb40-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colSums</span>(resp[[ii]])<span class="sc">/</span><span class="fu">sum</span>(countslist[[ii]])</span>
<span id="cb40-31"><a href="m-step.html#cb40-31" aria-hidden="true" tabindex="-1"></a>      }) <span class="sc">%&gt;%</span> <span class="fu">do.call</span>(rbind, .)</span>
<span id="cb40-32"><a href="m-step.html#cb40-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb40-33"><a href="m-step.html#cb40-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(resp.avg) </span>
<span id="cb40-34"><a href="m-step.html#cb40-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-35"><a href="m-step.html#cb40-35" aria-hidden="true" tabindex="-1"></a>  <span class="do">## If glmnet is actually needed, use it.</span></span>
<span id="cb40-36"><a href="m-step.html#cb40-36" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb40-37"><a href="m-step.html#cb40-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-38"><a href="m-step.html#cb40-38" aria-hidden="true" tabindex="-1"></a>    <span id='lambda_range'>lambda_range</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(lam, <span class="at">nlam =</span> <span class="dv">50</span>, <span class="at">lam.max =</span> <span class="dv">5</span><span class="sc">*</span>lam){</span>
<span id="cb40-39"><a href="m-step.html#cb40-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">exp</span>(<span class="fu">seq</span>(<span class="fu">log</span>(lam.max), <span class="fu">log</span>(lam), <span class="at">length.out =</span> nlam)))</span>
<span id="cb40-40"><a href="m-step.html#cb40-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb40-41"><a href="m-step.html#cb40-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-42"><a href="m-step.html#cb40-42" aria-hidden="true" tabindex="-1"></a>    penalty.facs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>, l_prob<span class="sc">+</span><span class="dv">1</span>), <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(H_tf) <span class="sc">-</span> l_prob <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb40-43"><a href="m-step.html#cb40-43" aria-hidden="true" tabindex="-1"></a>    resp.predict <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(resp, colSums))</span>
<span id="cb40-44"><a href="m-step.html#cb40-44" aria-hidden="true" tabindex="-1"></a>    glmnet_obj <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">glmnet</span>(<span class="at">x =</span> H_tf, <span class="at">y =</span> resp.predict, <span class="at">family =</span> <span class="st">&quot;multinomial&quot;</span>,</span>
<span id="cb40-45"><a href="m-step.html#cb40-45" aria-hidden="true" tabindex="-1"></a>                         <span class="at">penalty.factor =</span> penalty.facs, <span class="at">maxit =</span> <span class="fl">1e7</span>,</span>
<span id="cb40-46"><a href="m-step.html#cb40-46" aria-hidden="true" tabindex="-1"></a>                         <span class="at">lambda =</span>  <span class="fu">mean</span>(penalty.facs)<span class="sc">*</span><a href='m-step.html#lambda_range'>lambda_range</a>(lambda_prob),</span>
<span id="cb40-47"><a href="m-step.html#cb40-47" aria-hidden="true" tabindex="-1"></a>                         <span class="at">standardize =</span> F, <span class="at">intercept =</span> <span class="cn">FALSE</span>) <span class="do">## todo: replicate the parameters.</span></span>
<span id="cb40-48"><a href="m-step.html#cb40-48" aria-hidden="true" tabindex="-1"></a>    pred_link <span class="ot">&lt;-</span> <span class="fu">predict</span>(glmnet_obj, <span class="at">newx =</span> H_tf, <span class="at">type =</span> <span class="st">&quot;link&quot;</span>, <span class="at">s =</span> <span class="fu">mean</span>(penalty.facs) <span class="sc">*</span> lambda_prob)[,,<span class="dv">1</span>]</span>
<span id="cb40-49"><a href="m-step.html#cb40-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(pred_link)</span>
<span id="cb40-50"><a href="m-step.html#cb40-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb40-51"><a href="m-step.html#cb40-51" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-52"><a href="m-step.html#cb40-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-53"><a href="m-step.html#cb40-53" aria-hidden="true" tabindex="-1"></a><span class="do">## Things </span><span class="al">TODO</span><span class="do">: (1) check whether the resp.avg and result from penalized regression match, and (2) check if the scaling has entered the lambdas.</span></span></code></pre></div>
<p>This should return a <span class="math inline">\(T\)</span> by <span class="math inline">\(K\)</span> matrix, which we’ll test here:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="m-step.html#cb41-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;Mstep of pi returns a (T x K) matrix.&quot;</span>, {</span>
<span id="cb41-2"><a href="m-step.html#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="m-step.html#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Generate some fake responsibilities and trend filtering matrix</span></span>
<span id="cb41-4"><a href="m-step.html#cb41-4" aria-hidden="true" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="dv">100</span></span>
<span id="cb41-5"><a href="m-step.html#cb41-5" aria-hidden="true" tabindex="-1"></a>  numclust <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb41-6"><a href="m-step.html#cb41-6" aria-hidden="true" tabindex="-1"></a>  nt <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb41-7"><a href="m-step.html#cb41-7" aria-hidden="true" tabindex="-1"></a>  resp <span class="ot">=</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="cf">function</span>(tt){</span>
<span id="cb41-8"><a href="m-step.html#cb41-8" aria-hidden="true" tabindex="-1"></a>    oneresp <span class="ot">=</span> <span class="fu">runif</span>(nt<span class="sc">*</span>numclust) <span class="sc">%&gt;%</span> <span class="fu">matrix</span>(<span class="at">ncol=</span>numclust)</span>
<span id="cb41-9"><a href="m-step.html#cb41-9" aria-hidden="true" tabindex="-1"></a>    oneresp <span class="ot">=</span> oneresp<span class="sc">/</span><span class="fu">rowSums</span>(oneresp)</span>
<span id="cb41-10"><a href="m-step.html#cb41-10" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb41-11"><a href="m-step.html#cb41-11" aria-hidden="true" tabindex="-1"></a>  H_tf <span class="ot">&lt;-</span> <a href='trend-filtering.html#gen_tf_mat'>gen_tf_mat</a>(<span class="at">n =</span> TT, <span class="at">k =</span> <span class="dv">0</span>)</span>
<span id="cb41-12"><a href="m-step.html#cb41-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-13"><a href="m-step.html#cb41-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Check the size</span></span>
<span id="cb41-14"><a href="m-step.html#cb41-14" aria-hidden="true" tabindex="-1"></a>  pred_link <span class="ot">=</span> <a href='m-step.html#Mstep_prob'>Mstep_prob</a>(resp, H_tf, <span class="at">l_prob =</span> <span class="dv">0</span>, <span class="at">lambda_prob =</span> <span class="fl">1E-3</span>)</span>
<span id="cb41-15"><a href="m-step.html#cb41-15" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">dim</span>(pred_link), <span class="fu">c</span>(TT, numclust))</span>
<span id="cb41-16"><a href="m-step.html#cb41-16" aria-hidden="true" tabindex="-1"></a>  pred_link <span class="ot">=</span> <a href='m-step.html#Mstep_prob'>Mstep_prob</a>(resp, H_tf)</span>
<span id="cb41-17"><a href="m-step.html#cb41-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">dim</span>(pred_link), <span class="fu">c</span>(TT, numclust))</span>
<span id="cb41-18"><a href="m-step.html#cb41-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-19"><a href="m-step.html#cb41-19" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Check the correctness</span></span>
<span id="cb41-20"><a href="m-step.html#cb41-20" aria-hidden="true" tabindex="-1"></a>  pred_link <span class="ot">=</span> <a href='m-step.html#Mstep_prob'>Mstep_prob</a>(resp, H_tf)</span>
<span id="cb41-21"><a href="m-step.html#cb41-21" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>Each row of this matrix should contain the fitted values <span class="math inline">\(\alpha_k \in \mathbb{R}^3\)</span> where <span class="math inline">\(\alpha_{kt} = h_t^T w_{k}\)</span>, for..</p>
<ul>
<li><p><span class="math inline">\(h_t\)</span> that are rows of the trend filtering matrix <span class="math inline">\(H \in \mathbb{R}^{T \times T}\)</span>.</p></li>
<li><p><span class="math inline">\(w_k \in \mathbb{R}^{n}\)</span> that are the regression coefficients estimated by
<code>glmnet()</code>.</p></li>
</ul>
<p>Here is a test for the correctness of the M step for <span class="math inline">\(\pi\)</span>.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="m-step.html#cb42-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;Test the M step of \pi against CVXR&quot;</span>, {})</span></code></pre></div>
</div>
<div id="m-step-for-sigma" class="section level2 hasAnchor" number="8.2">
<h2><span class="header-section-number">8.2</span> M step for <span class="math inline">\(\Sigma\)</span><a href="m-step.html#m-step-for-sigma" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="m-step.html#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; M step for cluster covariance (sigma).</span></span>
<span id="cb43-2"><a href="m-step.html#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb43-3"><a href="m-step.html#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param resp Responsibility.</span></span>
<span id="cb43-4"><a href="m-step.html#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param ylist Data.</span></span>
<span id="cb43-5"><a href="m-step.html#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param mn Means</span></span>
<span id="cb43-6"><a href="m-step.html#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param numclust Number of clusters.</span></span>
<span id="cb43-7"><a href="m-step.html#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb43-8"><a href="m-step.html#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return (K x d x d) array containing K (d x d) covariance matrices.</span></span>
<span id="cb43-9"><a href="m-step.html#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb43-10"><a href="m-step.html#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb43-11"><a href="m-step.html#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @examples</span></span>
<span id="cb43-12"><a href="m-step.html#cb43-12" aria-hidden="true" tabindex="-1"></a><span id='Mstep_sigma'>Mstep_sigma</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(resp, ylist, mn, numclust){</span>
<span id="cb43-13"><a href="m-step.html#cb43-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-14"><a href="m-step.html#cb43-14" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Find some sizes</span></span>
<span id="cb43-15"><a href="m-step.html#cb43-15" aria-hidden="true" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="fu">length</span>(ylist)</span>
<span id="cb43-16"><a href="m-step.html#cb43-16" aria-hidden="true" tabindex="-1"></a>  ntlist <span class="ot">=</span> <span class="fu">sapply</span>(ylist, nrow)</span>
<span id="cb43-17"><a href="m-step.html#cb43-17" aria-hidden="true" tabindex="-1"></a>  dimdat <span class="ot">=</span> <span class="fu">ncol</span>(ylist[[<span class="dv">1</span>]])</span>
<span id="cb43-18"><a href="m-step.html#cb43-18" aria-hidden="true" tabindex="-1"></a>  cs <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">cumsum</span>(ntlist))</span>
<span id="cb43-19"><a href="m-step.html#cb43-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-20"><a href="m-step.html#cb43-20" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Set up empty residual matrix (to be reused)</span></span>
<span id="cb43-21"><a href="m-step.html#cb43-21" aria-hidden="true" tabindex="-1"></a>  cs <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">cumsum</span>(ntlist))</span>
<span id="cb43-22"><a href="m-step.html#cb43-22" aria-hidden="true" tabindex="-1"></a>  vars <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">&quot;list&quot;</span>, numclust)</span>
<span id="cb43-23"><a href="m-step.html#cb43-23" aria-hidden="true" tabindex="-1"></a>  ylong <span class="ot">=</span> <span class="fu">do.call</span>(rbind, ylist)</span>
<span id="cb43-24"><a href="m-step.html#cb43-24" aria-hidden="true" tabindex="-1"></a>  ntlist <span class="ot">=</span> <span class="fu">sapply</span>(ylist, nrow)</span>
<span id="cb43-25"><a href="m-step.html#cb43-25" aria-hidden="true" tabindex="-1"></a>  irows <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(mn), <span class="at">times =</span> ntlist)</span>
<span id="cb43-26"><a href="m-step.html#cb43-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-27"><a href="m-step.html#cb43-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>numclust){</span>
<span id="cb43-28"><a href="m-step.html#cb43-28" aria-hidden="true" tabindex="-1"></a>    resp.thisclust <span class="ot">=</span> <span class="fu">lapply</span>(resp, <span class="cf">function</span>(myresp) myresp[,iclust, <span class="at">drop =</span> <span class="cn">TRUE</span>])</span>
<span id="cb43-29"><a href="m-step.html#cb43-29" aria-hidden="true" tabindex="-1"></a>    resp.long <span class="ot">=</span> <span class="fu">do.call</span>(c, resp.thisclust)</span>
<span id="cb43-30"><a href="m-step.html#cb43-30" aria-hidden="true" tabindex="-1"></a>    mnlong <span class="ot">=</span> mn[irows,,iclust]</span>
<span id="cb43-31"><a href="m-step.html#cb43-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.vector</span>(mnlong)) mnlong <span class="ot">=</span> mnlong <span class="sc">%&gt;%</span> <span class="fu">cbind</span>()</span>
<span id="cb43-32"><a href="m-step.html#cb43-32" aria-hidden="true" tabindex="-1"></a>    <span class="do">## browser()</span></span>
<span id="cb43-33"><a href="m-step.html#cb43-33" aria-hidden="true" tabindex="-1"></a>    <span class="do">## vars[[iclust]] = estepC(ylong, mnlong, sqrt(resp.long), sum(resp.long))</span></span>
<span id="cb43-34"><a href="m-step.html#cb43-34" aria-hidden="true" tabindex="-1"></a>    <span class="do">## </span><span class="al">TODO</span><span class="do">: see if this could be sped up.</span></span>
<span id="cb43-35"><a href="m-step.html#cb43-35" aria-hidden="true" tabindex="-1"></a>    resid <span class="ot">&lt;-</span> ylong <span class="sc">-</span> mnlong</span>
<span id="cb43-36"><a href="m-step.html#cb43-36" aria-hidden="true" tabindex="-1"></a>    resid_weighted <span class="ot">&lt;-</span> resp.long <span class="sc">*</span> resid</span>
<span id="cb43-37"><a href="m-step.html#cb43-37" aria-hidden="true" tabindex="-1"></a>    sig_temp <span class="ot">&lt;-</span> <span class="fu">t</span>(resid_weighted) <span class="sc">%*%</span> resid<span class="sc">/</span><span class="fu">sum</span>(resp.long)</span>
<span id="cb43-38"><a href="m-step.html#cb43-38" aria-hidden="true" tabindex="-1"></a>    vars[[iclust]] <span class="ot">&lt;-</span> sig_temp</span>
<span id="cb43-39"><a href="m-step.html#cb43-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-40"><a href="m-step.html#cb43-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-41"><a href="m-step.html#cb43-41" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Make into an array</span></span>
<span id="cb43-42"><a href="m-step.html#cb43-42" aria-hidden="true" tabindex="-1"></a>  sigma_array <span class="ot">=</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(numclust, dimdat, dimdat))</span>
<span id="cb43-43"><a href="m-step.html#cb43-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>numclust){</span>
<span id="cb43-44"><a href="m-step.html#cb43-44" aria-hidden="true" tabindex="-1"></a>    sigma_array[iclust,,] <span class="ot">=</span> vars[[iclust]]</span>
<span id="cb43-45"><a href="m-step.html#cb43-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-46"><a href="m-step.html#cb43-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-47"><a href="m-step.html#cb43-47" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Basic check</span></span>
<span id="cb43-48"><a href="m-step.html#cb43-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="fu">dim</span>(sigma_array) <span class="sc">==</span> <span class="fu">c</span>(numclust, dimdat, dimdat)))</span>
<span id="cb43-49"><a href="m-step.html#cb43-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(sigma_array)</span>
<span id="cb43-50"><a href="m-step.html#cb43-50" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="m-step-for-mu" class="section level2 hasAnchor" number="8.3">
<h2><span class="header-section-number">8.3</span> M step for <span class="math inline">\(\mu\)</span><a href="m-step.html#m-step-for-mu" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This is a big one. It uses the ADMM written in section OO, reproduced briefly here.</p>
<p>We need a convergence checker for the outer layer of LA-ADMM:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="m-step.html#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; LA-ADMM requires an convergence check for the outer layer.</span></span>
<span id="cb44-2"><a href="m-step.html#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb44-3"><a href="m-step.html#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param objectives Objectives of the outer layer.</span></span>
<span id="cb44-4"><a href="m-step.html#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb44-5"><a href="m-step.html#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return TRUE if relative improvement is smaller than 1E-5 in the last four</span></span>
<span id="cb44-6"><a href="m-step.html#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;   outer iterations&#39; objective.</span></span>
<span id="cb44-7"><a href="m-step.html#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb44-8"><a href="m-step.html#cb44-8" aria-hidden="true" tabindex="-1"></a><span id='outer_converge'>outer_converge</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(objectives){</span>
<span id="cb44-9"><a href="m-step.html#cb44-9" aria-hidden="true" tabindex="-1"></a>  consec <span class="ot">=</span> <span class="dv">4</span></span>
<span id="cb44-10"><a href="m-step.html#cb44-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(objectives) <span class="sc">&lt;</span> consec){</span>
<span id="cb44-11"><a href="m-step.html#cb44-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">FALSE</span>)</span>
<span id="cb44-12"><a href="m-step.html#cb44-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb44-13"><a href="m-step.html#cb44-13" aria-hidden="true" tabindex="-1"></a>    mytail <span class="ot">=</span> utils<span class="sc">::</span><span class="fu">tail</span>(objectives, consec)</span>
<span id="cb44-14"><a href="m-step.html#cb44-14" aria-hidden="true" tabindex="-1"></a>    rel_diffs <span class="ot">=</span> mytail[<span class="dv">1</span><span class="sc">:</span>(consec<span class="dv">-1</span>)]<span class="sc">/</span>mytail[<span class="dv">2</span><span class="sc">:</span>consec]</span>
<span id="cb44-15"><a href="m-step.html#cb44-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">all</span>(<span class="fu">abs</span>(rel_diffs) <span class="sc">-</span> <span class="dv">1</span> <span class="sc">&lt;</span> <span class="fl">1E-5</span>))</span>
<span id="cb44-16"><a href="m-step.html#cb44-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb44-17"><a href="m-step.html#cb44-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Next, we define the main function <code><a href='m-step.html#Mstep_mu'>Mstep_mu</a>()</code>. This uses a “locally-adaptive”
ADMM [TODO: add source]. <code>M-step_mu()</code> calls <code><a href='m-step.html#la_admm_oneclust'>la_admm_oneclust</a>()</code> on each
cluster <span class="math inline">\(k=1,\cdots, K\)</span>; this function will be introduced shortly.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="m-step.html#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Computes the M step for mu. </span><span class="al">TODO</span><span class="co">: use templates for the argument. As shown</span></span>
<span id="cb45-2"><a href="m-step.html#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; here:</span></span>
<span id="cb45-3"><a href="m-step.html#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; https://stackoverflow.com/questions/15100129/using-roxygen2-template-tags</span></span>
<span id="cb45-4"><a href="m-step.html#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb45-5"><a href="m-step.html#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param resp Responsbilities of each particle.</span></span>
<span id="cb45-6"><a href="m-step.html#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param ylist </span></span>
<span id="cb45-7"><a href="m-step.html#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param lambda</span></span>
<span id="cb45-8"><a href="m-step.html#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param l</span></span>
<span id="cb45-9"><a href="m-step.html#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param sigma</span></span>
<span id="cb45-10"><a href="m-step.html#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param sigma_eig_by_clust</span></span>
<span id="cb45-11"><a href="m-step.html#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param Dlm1</span></span>
<span id="cb45-12"><a href="m-step.html#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param Dl</span></span>
<span id="cb45-13"><a href="m-step.html#cb45-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param TT</span></span>
<span id="cb45-14"><a href="m-step.html#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param N</span></span>
<span id="cb45-15"><a href="m-step.html#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param dimdat</span></span>
<span id="cb45-16"><a href="m-step.html#cb45-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param first_iter</span></span>
<span id="cb45-17"><a href="m-step.html#cb45-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param mus</span></span>
<span id="cb45-18"><a href="m-step.html#cb45-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param Zs</span></span>
<span id="cb45-19"><a href="m-step.html#cb45-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param Ws</span></span>
<span id="cb45-20"><a href="m-step.html#cb45-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param uws</span></span>
<span id="cb45-21"><a href="m-step.html#cb45-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param uzs</span></span>
<span id="cb45-22"><a href="m-step.html#cb45-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param maxdev</span></span>
<span id="cb45-23"><a href="m-step.html#cb45-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param x</span></span>
<span id="cb45-24"><a href="m-step.html#cb45-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param niter</span></span>
<span id="cb45-25"><a href="m-step.html#cb45-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param err_rel</span></span>
<span id="cb45-26"><a href="m-step.html#cb45-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param err_abs</span></span>
<span id="cb45-27"><a href="m-step.html#cb45-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param zerothresh</span></span>
<span id="cb45-28"><a href="m-step.html#cb45-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param local_adapt</span></span>
<span id="cb45-29"><a href="m-step.html#cb45-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param local_adapt_niter</span></span>
<span id="cb45-30"><a href="m-step.html#cb45-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param space</span></span>
<span id="cb45-31"><a href="m-step.html#cb45-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb45-32"><a href="m-step.html#cb45-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return</span></span>
<span id="cb45-33"><a href="m-step.html#cb45-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb45-34"><a href="m-step.html#cb45-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb45-35"><a href="m-step.html#cb45-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @examples</span></span>
<span id="cb45-36"><a href="m-step.html#cb45-36" aria-hidden="true" tabindex="-1"></a><span id='Mstep_mu'>Mstep_mu</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(resp,</span>
<span id="cb45-37"><a href="m-step.html#cb45-37" aria-hidden="true" tabindex="-1"></a>                     ylist,</span>
<span id="cb45-38"><a href="m-step.html#cb45-38" aria-hidden="true" tabindex="-1"></a>                     <span class="at">lambda =</span> <span class="fl">0.5</span>,</span>
<span id="cb45-39"><a href="m-step.html#cb45-39" aria-hidden="true" tabindex="-1"></a>                     <span class="at">l =</span> <span class="dv">3</span>,</span>
<span id="cb45-40"><a href="m-step.html#cb45-40" aria-hidden="true" tabindex="-1"></a>                     sigma,</span>
<span id="cb45-41"><a href="m-step.html#cb45-41" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sigma_eig_by_clust =</span> <span class="cn">NULL</span>,</span>
<span id="cb45-42"><a href="m-step.html#cb45-42" aria-hidden="true" tabindex="-1"></a>                     Dlm1sqrd,</span>
<span id="cb45-43"><a href="m-step.html#cb45-43" aria-hidden="true" tabindex="-1"></a>                     Dlm1, Dl,  TT, N, dimdat,</span>
<span id="cb45-44"><a href="m-step.html#cb45-44" aria-hidden="true" tabindex="-1"></a>                     <span class="at">first_iter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb45-45"><a href="m-step.html#cb45-45" aria-hidden="true" tabindex="-1"></a>                     e_mat,</span>
<span id="cb45-46"><a href="m-step.html#cb45-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-47"><a href="m-step.html#cb45-47" aria-hidden="true" tabindex="-1"></a>                     <span class="do">## Warm startable variables</span></span>
<span id="cb45-48"><a href="m-step.html#cb45-48" aria-hidden="true" tabindex="-1"></a>                     <span class="at">mus =</span> <span class="cn">NULL</span>,</span>
<span id="cb45-49"><a href="m-step.html#cb45-49" aria-hidden="true" tabindex="-1"></a>                     <span class="at">Zs =</span> <span class="cn">NULL</span>,</span>
<span id="cb45-50"><a href="m-step.html#cb45-50" aria-hidden="true" tabindex="-1"></a>                     <span class="at">Ws =</span> <span class="cn">NULL</span>,</span>
<span id="cb45-51"><a href="m-step.html#cb45-51" aria-hidden="true" tabindex="-1"></a>                     <span class="at">uws =</span> <span class="cn">NULL</span>,</span>
<span id="cb45-52"><a href="m-step.html#cb45-52" aria-hidden="true" tabindex="-1"></a>                     <span class="at">uzs =</span> <span class="cn">NULL</span>,</span>
<span id="cb45-53"><a href="m-step.html#cb45-53" aria-hidden="true" tabindex="-1"></a>                     <span class="do">## End of warm startable variables</span></span>
<span id="cb45-54"><a href="m-step.html#cb45-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-55"><a href="m-step.html#cb45-55" aria-hidden="true" tabindex="-1"></a>                     <span class="at">maxdev =</span> <span class="cn">NULL</span>,</span>
<span id="cb45-56"><a href="m-step.html#cb45-56" aria-hidden="true" tabindex="-1"></a>                     <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb45-57"><a href="m-step.html#cb45-57" aria-hidden="true" tabindex="-1"></a>                     <span class="at">niter =</span> (<span class="cf">if</span>(local_adapt) <span class="fl">1e3</span> <span class="cf">else</span> <span class="fl">1e4</span>),</span>
<span id="cb45-58"><a href="m-step.html#cb45-58" aria-hidden="true" tabindex="-1"></a>                     <span class="at">err_rel =</span> <span class="fl">1E-3</span>,</span>
<span id="cb45-59"><a href="m-step.html#cb45-59" aria-hidden="true" tabindex="-1"></a>                     <span class="at">err_abs =</span> <span class="dv">0</span>,</span>
<span id="cb45-60"><a href="m-step.html#cb45-60" aria-hidden="true" tabindex="-1"></a>                     <span class="at">zerothresh =</span> <span class="fl">1E-6</span>,</span>
<span id="cb45-61"><a href="m-step.html#cb45-61" aria-hidden="true" tabindex="-1"></a>                     <span class="at">local_adapt =</span> <span class="cn">FALSE</span>,</span>
<span id="cb45-62"><a href="m-step.html#cb45-62" aria-hidden="true" tabindex="-1"></a>                     <span class="at">local_adapt_niter =</span> <span class="dv">10</span>,</span>
<span id="cb45-63"><a href="m-step.html#cb45-63" aria-hidden="true" tabindex="-1"></a>                     <span class="at">space =</span> <span class="dv">50</span>){</span>
<span id="cb45-64"><a href="m-step.html#cb45-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-65"><a href="m-step.html#cb45-65" aria-hidden="true" tabindex="-1"></a>  <span class="do">####################</span></span>
<span id="cb45-66"><a href="m-step.html#cb45-66" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Preliminaries </span><span class="al">###</span></span>
<span id="cb45-67"><a href="m-step.html#cb45-67" aria-hidden="true" tabindex="-1"></a>  <span class="do">####################</span></span>
<span id="cb45-68"><a href="m-step.html#cb45-68" aria-hidden="true" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="fu">length</span>(ylist)</span>
<span id="cb45-69"><a href="m-step.html#cb45-69" aria-hidden="true" tabindex="-1"></a>  numclust <span class="ot">=</span> <span class="fu">ncol</span>(resp[[<span class="dv">1</span>]])</span>
<span id="cb45-70"><a href="m-step.html#cb45-70" aria-hidden="true" tabindex="-1"></a>  dimdat <span class="ot">=</span> <span class="fu">ncol</span>(ylist[[<span class="dv">1</span>]])</span>
<span id="cb45-71"><a href="m-step.html#cb45-71" aria-hidden="true" tabindex="-1"></a>  ntlist <span class="ot">=</span> <span class="fu">sapply</span>(ylist, nrow)</span>
<span id="cb45-72"><a href="m-step.html#cb45-72" aria-hidden="true" tabindex="-1"></a>  resp.sum <span class="ot">=</span> <span class="fu">lapply</span>(resp, colSums) <span class="sc">%&gt;%</span> <span class="fu">do.call</span>(rbind, .)</span>
<span id="cb45-73"><a href="m-step.html#cb45-73" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">unlist</span>(resp.sum)) <span class="do">## NEW (</span><span class="al">TODO</span><span class="do">: make more efficient, later)</span></span>
<span id="cb45-74"><a href="m-step.html#cb45-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-75"><a href="m-step.html#cb45-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># starting rho for LA-ADMM</span></span>
<span id="cb45-76"><a href="m-step.html#cb45-76" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(local_adapt){</span>
<span id="cb45-77"><a href="m-step.html#cb45-77" aria-hidden="true" tabindex="-1"></a>    rho.init <span class="ot">=</span> <span class="fl">1e-3</span></span>
<span id="cb45-78"><a href="m-step.html#cb45-78" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb45-79"><a href="m-step.html#cb45-79" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb45-80"><a href="m-step.html#cb45-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(x)){</span>
<span id="cb45-81"><a href="m-step.html#cb45-81" aria-hidden="true" tabindex="-1"></a>      rho.init <span class="ot">=</span> lambda<span class="sc">*</span>((<span class="fu">max</span>(x) <span class="sc">-</span> <span class="fu">min</span>(x))<span class="sc">/</span><span class="fu">length</span>(x))<span class="sc">^</span>l</span>
<span id="cb45-82"><a href="m-step.html#cb45-82" aria-hidden="true" tabindex="-1"></a>      rho.init <span class="ot">=</span> lambda</span>
<span id="cb45-83"><a href="m-step.html#cb45-83" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb45-84"><a href="m-step.html#cb45-84" aria-hidden="true" tabindex="-1"></a>    rho.init <span class="ot">=</span> lambda</span>
<span id="cb45-85"><a href="m-step.html#cb45-85" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb45-86"><a href="m-step.html#cb45-86" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb45-87"><a href="m-step.html#cb45-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-88"><a href="m-step.html#cb45-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-89"><a href="m-step.html#cb45-89" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Other preliminaries</span></span>
<span id="cb45-90"><a href="m-step.html#cb45-90" aria-hidden="true" tabindex="-1"></a>  schur_syl_A_by_clust <span class="ot">=</span> schur_syl_B_by_clust <span class="ot">=</span> term3list <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb45-91"><a href="m-step.html#cb45-91" aria-hidden="true" tabindex="-1"></a>  ybarlist <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb45-92"><a href="m-step.html#cb45-92" aria-hidden="true" tabindex="-1"></a>  ycentered_list <span class="ot">=</span> Xcentered_list <span class="ot">=</span> yXcentered_list <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb45-93"><a href="m-step.html#cb45-93" aria-hidden="true" tabindex="-1"></a>  Qlist <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb45-94"><a href="m-step.html#cb45-94" aria-hidden="true" tabindex="-1"></a>  sigmainv_list <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb45-95"><a href="m-step.html#cb45-95" aria-hidden="true" tabindex="-1"></a>  convergences <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb45-96"><a href="m-step.html#cb45-96" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>numclust){</span>
<span id="cb45-97"><a href="m-step.html#cb45-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-98"><a href="m-step.html#cb45-98" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Retrieve sigma inverse from pre-computed SVD, if necessary</span></span>
<span id="cb45-99"><a href="m-step.html#cb45-99" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(sigma_eig_by_clust)){</span>
<span id="cb45-100"><a href="m-step.html#cb45-100" aria-hidden="true" tabindex="-1"></a>      sigmainv <span class="ot">=</span> <span class="fu">solve</span>(sigma[iclust,,])</span>
<span id="cb45-101"><a href="m-step.html#cb45-101" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb45-102"><a href="m-step.html#cb45-102" aria-hidden="true" tabindex="-1"></a>      sigmainv <span class="ot">=</span> sigma_eig_by_clust[[iclust]]<span class="sc">$</span>sigma_inv</span>
<span id="cb45-103"><a href="m-step.html#cb45-103" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb45-104"><a href="m-step.html#cb45-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-105"><a href="m-step.html#cb45-105" aria-hidden="true" tabindex="-1"></a>    resp.iclust <span class="ot">&lt;-</span> <span class="fu">lapply</span>(resp, <span class="at">FUN =</span> <span class="cf">function</span>(r) <span class="fu">matrix</span>(r[,iclust]))</span>
<span id="cb45-106"><a href="m-step.html#cb45-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-107"><a href="m-step.html#cb45-107" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Center y and X</span></span>
<span id="cb45-108"><a href="m-step.html#cb45-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># obj &lt;- <a href='m-step.html#weight_ylist'>weight_ylist</a>(iclust, resp, resp.sum, ylist)</span></span>
<span id="cb45-109"><a href="m-step.html#cb45-109" aria-hidden="true" tabindex="-1"></a>    <span class="co">#ycentered &lt;- obj$ycentered</span></span>
<span id="cb45-110"><a href="m-step.html#cb45-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-111"><a href="m-step.html#cb45-111" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Form the Sylvester equation coefficients in AX + XB + C = 0</span></span>
<span id="cb45-112"><a href="m-step.html#cb45-112" aria-hidden="true" tabindex="-1"></a>    <span class="co"># syl_A = rho * sigma[iclust,,]</span></span>
<span id="cb45-113"><a href="m-step.html#cb45-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Q = 1/N * t(Xcentered) %*% D %*% Xcentered</span></span>
<span id="cb45-114"><a href="m-step.html#cb45-114" aria-hidden="true" tabindex="-1"></a>    <span class="co"># syl_B = Q %*% Xinv</span></span>
<span id="cb45-115"><a href="m-step.html#cb45-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-116"><a href="m-step.html#cb45-116" aria-hidden="true" tabindex="-1"></a>    AB <span class="ot">&lt;-</span> <a href='m-step.html#get_AB_mats'>get_AB_mats</a>(<span class="at">y =</span> y, <span class="at">resp =</span> resp.iclust, <span class="at">Sigma_inv =</span> sigmainv,</span>
<span id="cb45-117"><a href="m-step.html#cb45-117" aria-hidden="true" tabindex="-1"></a>                      <span class="at">e_mat =</span> e_mat, <span class="at">N =</span> N, <span class="at">Dl =</span> Dl, <span class="at">Dlm1 =</span> Dlm1,</span>
<span id="cb45-118"><a href="m-step.html#cb45-118" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Dlm1sqrd =</span> Dlm1sqrd, <span class="at">rho =</span> rho.init, <span class="at">z =</span> <span class="cn">NULL</span>, <span class="at">w =</span> <span class="cn">NULL</span>,</span>
<span id="cb45-119"><a href="m-step.html#cb45-119" aria-hidden="true" tabindex="-1"></a>                      <span class="at">uz =</span> <span class="cn">NULL</span>, <span class="at">uw =</span> <span class="cn">NULL</span>)</span>
<span id="cb45-120"><a href="m-step.html#cb45-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-121"><a href="m-step.html#cb45-121" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Store the Schur decomposition</span></span>
<span id="cb45-122"><a href="m-step.html#cb45-122" aria-hidden="true" tabindex="-1"></a>    schur_syl_A_by_clust[[iclust]] <span class="ot">=</span> <a href='m-step.html#myschur'>myschur</a>(AB<span class="sc">$</span>A)</span>
<span id="cb45-123"><a href="m-step.html#cb45-123" aria-hidden="true" tabindex="-1"></a>    schur_syl_B_by_clust[[iclust]] <span class="ot">=</span> <a href='m-step.html#myschur'>myschur</a>(AB<span class="sc">$</span>B)</span>
<span id="cb45-124"><a href="m-step.html#cb45-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-125"><a href="m-step.html#cb45-125" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Calculate coefficients for objective value  calculation</span></span>
<span id="cb45-126"><a href="m-step.html#cb45-126" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Qlist[[iclust]] = Q</span></span>
<span id="cb45-127"><a href="m-step.html#cb45-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-128"><a href="m-step.html#cb45-128" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ## Also calculate some things for the objective value</span></span>
<span id="cb45-129"><a href="m-step.html#cb45-129" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ylong = sweep(do.call(rbind, ylist), 2, obj$ybar)</span></span>
<span id="cb45-130"><a href="m-step.html#cb45-130" aria-hidden="true" tabindex="-1"></a>    <span class="do">## longwt = do.call(c, lapply(1:TT, function(tt){ resp[[tt]][,iclust]})) %&gt;% sqrt()</span></span>
<span id="cb45-131"><a href="m-step.html#cb45-131" aria-hidden="true" tabindex="-1"></a>    <span class="do">## wt.long = longwt * ylong</span></span>
<span id="cb45-132"><a href="m-step.html#cb45-132" aria-hidden="true" tabindex="-1"></a>    <span class="do">## wt.ylong = longwt * ylong</span></span>
<span id="cb45-133"><a href="m-step.html#cb45-133" aria-hidden="true" tabindex="-1"></a>    <span class="do">## crossprod(wt.ylong, wt.ylong)</span></span>
<span id="cb45-134"><a href="m-step.html#cb45-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-135"><a href="m-step.html#cb45-135" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Store the third term</span></span>
<span id="cb45-136"><a href="m-step.html#cb45-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># term3list[[iclust]] =  1 / N * sigmainv %*% yXcentered</span></span>
<span id="cb45-137"><a href="m-step.html#cb45-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ybarlist[[iclust]] = obj$ybar</span></span>
<span id="cb45-138"><a href="m-step.html#cb45-138" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb45-139"><a href="m-step.html#cb45-139" aria-hidden="true" tabindex="-1"></a>    ycentered <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb45-140"><a href="m-step.html#cb45-140" aria-hidden="true" tabindex="-1"></a>     ycentered_list[[iclust]] <span class="ot">=</span> ycentered</span>
<span id="cb45-141"><a href="m-step.html#cb45-141" aria-hidden="true" tabindex="-1"></a>     <span class="co">#print(ycentered)</span></span>
<span id="cb45-142"><a href="m-step.html#cb45-142" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Xcentered_list[[iclust]] = Xcentered</span></span>
<span id="cb45-143"><a href="m-step.html#cb45-143" aria-hidden="true" tabindex="-1"></a>    <span class="co"># yXcentered_list[[iclust]] = yXcentered</span></span>
<span id="cb45-144"><a href="m-step.html#cb45-144" aria-hidden="true" tabindex="-1"></a>    sigmainv_list[[iclust]] <span class="ot">=</span> sigmainv</span>
<span id="cb45-145"><a href="m-step.html#cb45-145" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb45-146"><a href="m-step.html#cb45-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-147"><a href="m-step.html#cb45-147" aria-hidden="true" tabindex="-1"></a>  <span class="do">##########################################</span></span>
<span id="cb45-148"><a href="m-step.html#cb45-148" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Run ADMM separately on each cluster ##</span></span>
<span id="cb45-149"><a href="m-step.html#cb45-149" aria-hidden="true" tabindex="-1"></a>  <span class="do">#########################################</span></span>
<span id="cb45-150"><a href="m-step.html#cb45-150" aria-hidden="true" tabindex="-1"></a>  yhats <span class="ot">=</span> admm_niters <span class="ot">=</span> admm_inner_iters <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">length =</span> numclust, <span class="at">mode =</span> <span class="st">&quot;list&quot;</span>)</span>
<span id="cb45-151"><a href="m-step.html#cb45-151" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(first_iter) mus <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">length =</span> numclust, <span class="at">mode =</span> <span class="st">&quot;list&quot;</span>)</span>
<span id="cb45-152"><a href="m-step.html#cb45-152" aria-hidden="true" tabindex="-1"></a> <span class="co"># if(first_iter){</span></span>
<span id="cb45-153"><a href="m-step.html#cb45-153" aria-hidden="true" tabindex="-1"></a>    Zs <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>numclust, <span class="cf">function</span>(x) <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT, <span class="at">ncol =</span> dimdat) )</span>
<span id="cb45-154"><a href="m-step.html#cb45-154" aria-hidden="true" tabindex="-1"></a>    Ws <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>numclust, <span class="cf">function</span>(x) <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> dimdat, <span class="at">ncol =</span> TT <span class="sc">-</span> l))</span>
<span id="cb45-155"><a href="m-step.html#cb45-155" aria-hidden="true" tabindex="-1"></a>    uzs <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>numclust, <span class="cf">function</span>(x) <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT, <span class="at">ncol =</span> dimdat) )</span>
<span id="cb45-156"><a href="m-step.html#cb45-156" aria-hidden="true" tabindex="-1"></a>    uws <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>numclust, <span class="cf">function</span>(x) <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> dimdat, <span class="at">ncol =</span> TT <span class="sc">-</span> l))</span>
<span id="cb45-157"><a href="m-step.html#cb45-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-158"><a href="m-step.html#cb45-158" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Zs =  Ws =  Us  = vector(length = numclust, mode = &quot;list&quot;)</span></span>
<span id="cb45-159"><a href="m-step.html#cb45-159" aria-hidden="true" tabindex="-1"></a> <span class="co"># }</span></span>
<span id="cb45-160"><a href="m-step.html#cb45-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-161"><a href="m-step.html#cb45-161" aria-hidden="true" tabindex="-1"></a>  fits <span class="ot">=</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">ncol =</span> numclust, <span class="at">nrow =</span> <span class="fu">ceiling</span>(niter <span class="sc">/</span> space))</span>
<span id="cb45-162"><a href="m-step.html#cb45-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-163"><a href="m-step.html#cb45-163" aria-hidden="true" tabindex="-1"></a>  <span class="do">## For every cluster, run LA-ADMM</span></span>
<span id="cb45-164"><a href="m-step.html#cb45-164" aria-hidden="true" tabindex="-1"></a>  resid_mat_list <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb45-165"><a href="m-step.html#cb45-165" aria-hidden="true" tabindex="-1"></a>  start.time <span class="ot">=</span> <span class="fu">Sys.time</span>()</span>
<span id="cb45-166"><a href="m-step.html#cb45-166" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>numclust){</span>
<span id="cb45-167"><a href="m-step.html#cb45-167" aria-hidden="true" tabindex="-1"></a>    resp.iclust <span class="ot">&lt;-</span> <span class="fu">lapply</span>(resp, <span class="at">FUN =</span> <span class="cf">function</span>(r) <span class="fu">matrix</span>(r[,iclust]))</span>
<span id="cb45-168"><a href="m-step.html#cb45-168" aria-hidden="true" tabindex="-1"></a>    resp.sum.iclust <span class="ot">&lt;-</span> <span class="fu">lapply</span>(resp.sum, <span class="at">FUN =</span> <span class="cf">function</span>(r) <span class="fu">matrix</span>(r[iclust]))</span>
<span id="cb45-169"><a href="m-step.html#cb45-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-170"><a href="m-step.html#cb45-170" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Possibly locally adaptive ADMM, for now just running with rho == lambda</span></span>
<span id="cb45-171"><a href="m-step.html#cb45-171" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">=</span> <a href='m-step.html#la_admm_oneclust'>la_admm_oneclust</a>(<span class="at">K =</span> (<span class="cf">if</span>(local_adapt) local_adapt_niter <span class="cf">else</span> <span class="dv">1</span>),</span>
<span id="cb45-172"><a href="m-step.html#cb45-172" aria-hidden="true" tabindex="-1"></a>                           <span class="at">local_adapt =</span> local_adapt,</span>
<span id="cb45-173"><a href="m-step.html#cb45-173" aria-hidden="true" tabindex="-1"></a>                           <span class="at">iclust =</span> iclust,</span>
<span id="cb45-174"><a href="m-step.html#cb45-174" aria-hidden="true" tabindex="-1"></a>                           <span class="at">niter =</span> niter,</span>
<span id="cb45-175"><a href="m-step.html#cb45-175" aria-hidden="true" tabindex="-1"></a>                           <span class="at">TT =</span> TT, <span class="at">N =</span> N, <span class="at">dimdat =</span> dimdat, <span class="at">maxdev =</span> maxdev,</span>
<span id="cb45-176"><a href="m-step.html#cb45-176" aria-hidden="true" tabindex="-1"></a>                           <span class="at">schurA =</span> schur_syl_A_by_clust[[iclust]],</span>
<span id="cb45-177"><a href="m-step.html#cb45-177" aria-hidden="true" tabindex="-1"></a>                           <span class="at">schurB =</span> schur_syl_B_by_clust[[iclust]],</span>
<span id="cb45-178"><a href="m-step.html#cb45-178" aria-hidden="true" tabindex="-1"></a>                           <span class="co">#term3 = term3list[[iclust]],</span></span>
<span id="cb45-179"><a href="m-step.html#cb45-179" aria-hidden="true" tabindex="-1"></a>                           <span class="at">sigmainv =</span> sigmainv_list[[iclust]],</span>
<span id="cb45-180"><a href="m-step.html#cb45-180" aria-hidden="true" tabindex="-1"></a>                           <span class="co"># Xinv = Xinv,</span></span>
<span id="cb45-181"><a href="m-step.html#cb45-181" aria-hidden="true" tabindex="-1"></a>                           <span class="co"># Xaug = Xaug,</span></span>
<span id="cb45-182"><a href="m-step.html#cb45-182" aria-hidden="true" tabindex="-1"></a>                           <span class="co"># Xa = Xa,</span></span>
<span id="cb45-183"><a href="m-step.html#cb45-183" aria-hidden="true" tabindex="-1"></a>                           <span class="at">rho =</span> rho.init,</span>
<span id="cb45-184"><a href="m-step.html#cb45-184" aria-hidden="true" tabindex="-1"></a>                           <span class="at">rhoinit =</span> rho.init,</span>
<span id="cb45-185"><a href="m-step.html#cb45-185" aria-hidden="true" tabindex="-1"></a>                           <span class="at">sigma =</span> sigma,</span>
<span id="cb45-186"><a href="m-step.html#cb45-186" aria-hidden="true" tabindex="-1"></a>                           <span class="at">lambda =</span> lambda,</span>
<span id="cb45-187"><a href="m-step.html#cb45-187" aria-hidden="true" tabindex="-1"></a>                           <span class="at">resp =</span> resp.iclust,</span>
<span id="cb45-188"><a href="m-step.html#cb45-188" aria-hidden="true" tabindex="-1"></a>                           <span class="at">l =</span> l,</span>
<span id="cb45-189"><a href="m-step.html#cb45-189" aria-hidden="true" tabindex="-1"></a>                           <span class="at">Dl =</span> Dl,</span>
<span id="cb45-190"><a href="m-step.html#cb45-190" aria-hidden="true" tabindex="-1"></a>                           <span class="at">Dlm1 =</span> Dlm1,</span>
<span id="cb45-191"><a href="m-step.html#cb45-191" aria-hidden="true" tabindex="-1"></a>                          <span class="co">#resp.sum = resp.sum.iclust,</span></span>
<span id="cb45-192"><a href="m-step.html#cb45-192" aria-hidden="true" tabindex="-1"></a>                           <span class="at">y =</span> ylist,</span>
<span id="cb45-193"><a href="m-step.html#cb45-193" aria-hidden="true" tabindex="-1"></a>                           <span class="at">err_rel =</span> err_rel,</span>
<span id="cb45-194"><a href="m-step.html#cb45-194" aria-hidden="true" tabindex="-1"></a>                           <span class="at">err_abs =</span> err_abs,</span>
<span id="cb45-195"><a href="m-step.html#cb45-195" aria-hidden="true" tabindex="-1"></a>                           <span class="at">zerothresh =</span> zerothresh,</span>
<span id="cb45-196"><a href="m-step.html#cb45-196" aria-hidden="true" tabindex="-1"></a>                           <span class="at">sigma_eig_by_clust =</span> sigma_eig_by_clust,</span>
<span id="cb45-197"><a href="m-step.html#cb45-197" aria-hidden="true" tabindex="-1"></a>                           <span class="at">space =</span> space,</span>
<span id="cb45-198"><a href="m-step.html#cb45-198" aria-hidden="true" tabindex="-1"></a>                           <span class="at">objective =</span> F, </span>
<span id="cb45-199"><a href="m-step.html#cb45-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-200"><a href="m-step.html#cb45-200" aria-hidden="true" tabindex="-1"></a>                           <span class="do">## Warm starts from previous *EM* iteration</span></span>
<span id="cb45-201"><a href="m-step.html#cb45-201" aria-hidden="true" tabindex="-1"></a>                           <span class="at">first_iter =</span> first_iter,</span>
<span id="cb45-202"><a href="m-step.html#cb45-202" aria-hidden="true" tabindex="-1"></a>                          <span class="co"># beta = betas[[iclust]],</span></span>
<span id="cb45-203"><a href="m-step.html#cb45-203" aria-hidden="true" tabindex="-1"></a>                           <span class="co">#mu = mus[[iclust]],</span></span>
<span id="cb45-204"><a href="m-step.html#cb45-204" aria-hidden="true" tabindex="-1"></a>                           <span class="at">uw =</span> uws[[iclust]],</span>
<span id="cb45-205"><a href="m-step.html#cb45-205" aria-hidden="true" tabindex="-1"></a>                           <span class="at">uz =</span> uzs[[iclust]],</span>
<span id="cb45-206"><a href="m-step.html#cb45-206" aria-hidden="true" tabindex="-1"></a>                           <span class="at">z =</span> Zs[[iclust]],</span>
<span id="cb45-207"><a href="m-step.html#cb45-207" aria-hidden="true" tabindex="-1"></a>                           <span class="at">w =</span> Ws[[iclust]]</span>
<span id="cb45-208"><a href="m-step.html#cb45-208" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb45-209"><a href="m-step.html#cb45-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-210"><a href="m-step.html#cb45-210" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Store the results</span></span>
<span id="cb45-211"><a href="m-step.html#cb45-211" aria-hidden="true" tabindex="-1"></a>    mus[[iclust]] <span class="ot">=</span> res<span class="sc">$</span>mu</span>
<span id="cb45-212"><a href="m-step.html#cb45-212" aria-hidden="true" tabindex="-1"></a>    yhats[[iclust]] <span class="ot">=</span> <span class="fu">t</span>(res<span class="sc">$</span>yhat)</span>
<span id="cb45-213"><a href="m-step.html#cb45-213" aria-hidden="true" tabindex="-1"></a>    <span class="do">## fits[,iclust] = res$fits ## </span><span class="al">TODO</span><span class="do">: revive this, for testing? We&#39;ll see.</span></span>
<span id="cb45-214"><a href="m-step.html#cb45-214" aria-hidden="true" tabindex="-1"></a>    admm_niters[[iclust]] <span class="ot">=</span> res<span class="sc">$</span>kk</span>
<span id="cb45-215"><a href="m-step.html#cb45-215" aria-hidden="true" tabindex="-1"></a>    admm_inner_iters[[iclust]] <span class="ot">=</span> res<span class="sc">$</span>inner.iter</span>
<span id="cb45-216"><a href="m-step.html#cb45-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-217"><a href="m-step.html#cb45-217" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Store other things for for warmstart</span></span>
<span id="cb45-218"><a href="m-step.html#cb45-218" aria-hidden="true" tabindex="-1"></a>    Zs[[iclust]] <span class="ot">=</span> res<span class="sc">$</span>Z</span>
<span id="cb45-219"><a href="m-step.html#cb45-219" aria-hidden="true" tabindex="-1"></a>    uzs[[iclust]] <span class="ot">=</span> res<span class="sc">$</span>uz</span>
<span id="cb45-220"><a href="m-step.html#cb45-220" aria-hidden="true" tabindex="-1"></a>    uws[[iclust]] <span class="ot">=</span> res<span class="sc">$</span>uw</span>
<span id="cb45-221"><a href="m-step.html#cb45-221" aria-hidden="true" tabindex="-1"></a>    Ws[[iclust]] <span class="ot">=</span> res<span class="sc">$</span>W</span>
<span id="cb45-222"><a href="m-step.html#cb45-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-223"><a href="m-step.html#cb45-223" aria-hidden="true" tabindex="-1"></a>    <span class="do">## The upper triangular matrix remains the same. (code missing?)</span></span>
<span id="cb45-224"><a href="m-step.html#cb45-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-225"><a href="m-step.html#cb45-225" aria-hidden="true" tabindex="-1"></a>    resid_mat_list[[iclust]] <span class="ot">=</span> res<span class="sc">$</span>resid_mat <span class="do">## temporary</span></span>
<span id="cb45-226"><a href="m-step.html#cb45-226" aria-hidden="true" tabindex="-1"></a>    convergences[[iclust]] <span class="ot">=</span> res<span class="sc">$</span>converge</span>
<span id="cb45-227"><a href="m-step.html#cb45-227" aria-hidden="true" tabindex="-1"></a>   <span class="co"># print(res$converge)</span></span>
<span id="cb45-228"><a href="m-step.html#cb45-228" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb45-229"><a href="m-step.html#cb45-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-230"><a href="m-step.html#cb45-230" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Aggregate the yhats into one array</span></span>
<span id="cb45-231"><a href="m-step.html#cb45-231" aria-hidden="true" tabindex="-1"></a>  yhats_array <span class="ot">=</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">c</span>(TT, dimdat, numclust))</span>
<span id="cb45-232"><a href="m-step.html#cb45-232" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>numclust){ yhats_array[,,iclust] <span class="ot">=</span> yhats[[iclust]] }</span>
<span id="cb45-233"><a href="m-step.html#cb45-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-234"><a href="m-step.html#cb45-234" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Each are lists of length |numclust|.</span></span>
<span id="cb45-235"><a href="m-step.html#cb45-235" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mns =</span> yhats_array,</span>
<span id="cb45-236"><a href="m-step.html#cb45-236" aria-hidden="true" tabindex="-1"></a>              <span class="do">## fits = fits,</span></span>
<span id="cb45-237"><a href="m-step.html#cb45-237" aria-hidden="true" tabindex="-1"></a>              <span class="at">resid_mat_list =</span> resid_mat_list,</span>
<span id="cb45-238"><a href="m-step.html#cb45-238" aria-hidden="true" tabindex="-1"></a>              <span class="at">convergences =</span> convergences,</span>
<span id="cb45-239"><a href="m-step.html#cb45-239" aria-hidden="true" tabindex="-1"></a>              <span class="at">admm_niters =</span> admm_niters, <span class="do">## Temporary: Seeing the number of</span></span>
<span id="cb45-240"><a href="m-step.html#cb45-240" aria-hidden="true" tabindex="-1"></a>              <span class="do">## outer iterations it took to</span></span>
<span id="cb45-241"><a href="m-step.html#cb45-241" aria-hidden="true" tabindex="-1"></a>              <span class="do">## converge.</span></span>
<span id="cb45-242"><a href="m-step.html#cb45-242" aria-hidden="true" tabindex="-1"></a>              <span class="at">admm_inner_iters =</span> admm_inner_iters,</span>
<span id="cb45-243"><a href="m-step.html#cb45-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-244"><a href="m-step.html#cb45-244" aria-hidden="true" tabindex="-1"></a>              <span class="do">## For warmstarts</span></span>
<span id="cb45-245"><a href="m-step.html#cb45-245" aria-hidden="true" tabindex="-1"></a>              <span class="at">Zs =</span> Zs,</span>
<span id="cb45-246"><a href="m-step.html#cb45-246" aria-hidden="true" tabindex="-1"></a>              <span class="at">Ws =</span> Ws,</span>
<span id="cb45-247"><a href="m-step.html#cb45-247" aria-hidden="true" tabindex="-1"></a>              <span class="at">uws =</span> uws,</span>
<span id="cb45-248"><a href="m-step.html#cb45-248" aria-hidden="true" tabindex="-1"></a>              <span class="at">uzs =</span> uzs,</span>
<span id="cb45-249"><a href="m-step.html#cb45-249" aria-hidden="true" tabindex="-1"></a>              <span class="at">N =</span> N,</span>
<span id="cb45-250"><a href="m-step.html#cb45-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-251"><a href="m-step.html#cb45-251" aria-hidden="true" tabindex="-1"></a>              <span class="do">## For using in the Sigma M step</span></span>
<span id="cb45-252"><a href="m-step.html#cb45-252" aria-hidden="true" tabindex="-1"></a>              <span class="at">ycentered_list =</span> ycentered_list,</span>
<span id="cb45-253"><a href="m-step.html#cb45-253" aria-hidden="true" tabindex="-1"></a>              <span class="at">Xcentered_list =</span> Xcentered_list,</span>
<span id="cb45-254"><a href="m-step.html#cb45-254" aria-hidden="true" tabindex="-1"></a>              <span class="at">yXcentered_list =</span> yXcentered_list,</span>
<span id="cb45-255"><a href="m-step.html#cb45-255" aria-hidden="true" tabindex="-1"></a>              <span class="at">Qlist =</span> Qlist</span>
<span id="cb45-256"><a href="m-step.html#cb45-256" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb45-257"><a href="m-step.html#cb45-257" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The locally adaptive admm for a single cluster involves an inner and outer
loop. The inner loop is an ADMM for a fixed <span class="math inline">\(\rho\)</span>. The outer loop is written
here in <code>la_admm_oneclust</code>, and runs the inner ADMM with a fixed step-size
<span class="math inline">\(\rho\)</span> while sequentially doubling <span class="math inline">\(\rho\)</span>.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="m-step.html#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Locally adaptive ADMM.</span></span>
<span id="cb46-2"><a href="m-step.html#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb46-3"><a href="m-step.html#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param K</span></span>
<span id="cb46-4"><a href="m-step.html#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param ...</span></span>
<span id="cb46-5"><a href="m-step.html#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb46-6"><a href="m-step.html#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return</span></span>
<span id="cb46-7"><a href="m-step.html#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb46-8"><a href="m-step.html#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb46-9"><a href="m-step.html#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @examples</span></span>
<span id="cb46-10"><a href="m-step.html#cb46-10" aria-hidden="true" tabindex="-1"></a><span id='la_admm_oneclust'>la_admm_oneclust</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(K,</span>
<span id="cb46-11"><a href="m-step.html#cb46-11" aria-hidden="true" tabindex="-1"></a>                             ...){</span>
<span id="cb46-12"><a href="m-step.html#cb46-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-13"><a href="m-step.html#cb46-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Initialize arguments for ADMM.</span></span>
<span id="cb46-14"><a href="m-step.html#cb46-14" aria-hidden="true" tabindex="-1"></a>  args <span class="ot">&lt;-</span> <span class="fu">list</span>(...)</span>
<span id="cb46-15"><a href="m-step.html#cb46-15" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">=</span> args<span class="sc">$</span>p</span>
<span id="cb46-16"><a href="m-step.html#cb46-16" aria-hidden="true" tabindex="-1"></a>  l <span class="ot">=</span> args<span class="sc">$</span>l</span>
<span id="cb46-17"><a href="m-step.html#cb46-17" aria-hidden="true" tabindex="-1"></a>  TT <span class="ot">=</span> args<span class="sc">$</span>TT</span>
<span id="cb46-18"><a href="m-step.html#cb46-18" aria-hidden="true" tabindex="-1"></a>  dimdat <span class="ot">=</span> args<span class="sc">$</span>dimdat</span>
<span id="cb46-19"><a href="m-step.html#cb46-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-20"><a href="m-step.html#cb46-20" aria-hidden="true" tabindex="-1"></a>  <span class="do">## This initialization can come from the previous *EM* iteration.</span></span>
<span id="cb46-21"><a href="m-step.html#cb46-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(args<span class="sc">$</span>first_iter){</span>
<span id="cb46-22"><a href="m-step.html#cb46-22" aria-hidden="true" tabindex="-1"></a>    mu <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT, <span class="at">ncol =</span> dimdat)</span>
<span id="cb46-23"><a href="m-step.html#cb46-23" aria-hidden="true" tabindex="-1"></a>    Z <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT, <span class="at">ncol =</span> dimdat)</span>
<span id="cb46-24"><a href="m-step.html#cb46-24" aria-hidden="true" tabindex="-1"></a>    W <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> dimdat, <span class="at">ncol =</span> TT <span class="sc">-</span> l )</span>
<span id="cb46-25"><a href="m-step.html#cb46-25" aria-hidden="true" tabindex="-1"></a>    uz <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT, <span class="at">ncol =</span> dimdat)</span>
<span id="cb46-26"><a href="m-step.html#cb46-26" aria-hidden="true" tabindex="-1"></a>    uw <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> dimdat, <span class="at">ncol =</span> TT <span class="sc">-</span> l )</span>
<span id="cb46-27"><a href="m-step.html#cb46-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-28"><a href="m-step.html#cb46-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">#args[[&#39;beta&#39;]] &lt;- beta</span></span>
<span id="cb46-29"><a href="m-step.html#cb46-29" aria-hidden="true" tabindex="-1"></a>    args[[<span class="st">&#39;z&#39;</span>]] <span class="ot">&lt;-</span> Z</span>
<span id="cb46-30"><a href="m-step.html#cb46-30" aria-hidden="true" tabindex="-1"></a>    args[[<span class="st">&#39;w&#39;</span>]] <span class="ot">&lt;-</span> W</span>
<span id="cb46-31"><a href="m-step.html#cb46-31" aria-hidden="true" tabindex="-1"></a>    args[[<span class="st">&#39;uz&#39;</span>]] <span class="ot">&lt;-</span> uz</span>
<span id="cb46-32"><a href="m-step.html#cb46-32" aria-hidden="true" tabindex="-1"></a>    args[[<span class="st">&#39;uw&#39;</span>]] <span class="ot">&lt;-</span> uw</span>
<span id="cb46-33"><a href="m-step.html#cb46-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb46-34"><a href="m-step.html#cb46-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-35"><a href="m-step.html#cb46-35" aria-hidden="true" tabindex="-1"></a>  cols <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb46-36"><a href="m-step.html#cb46-36" aria-hidden="true" tabindex="-1"></a>  objectives <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb46-37"><a href="m-step.html#cb46-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-38"><a href="m-step.html#cb46-38" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Temporary</span></span>
<span id="cb46-39"><a href="m-step.html#cb46-39" aria-hidden="true" tabindex="-1"></a>  all_fits <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb46-40"><a href="m-step.html#cb46-40" aria-hidden="true" tabindex="-1"></a>  all_cols <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb46-41"><a href="m-step.html#cb46-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-42"><a href="m-step.html#cb46-42" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Run ADMM repeatedly with (1) double rho, and (2) previous b</span></span>
<span id="cb46-43"><a href="m-step.html#cb46-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(kk <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){</span>
<span id="cb46-44"><a href="m-step.html#cb46-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(kk <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb46-45"><a href="m-step.html#cb46-45" aria-hidden="true" tabindex="-1"></a>      Z <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT, <span class="at">ncol =</span> dimdat)</span>
<span id="cb46-46"><a href="m-step.html#cb46-46" aria-hidden="true" tabindex="-1"></a>      W <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">ncol =</span> TT <span class="sc">-</span> l , <span class="at">nrow =</span> dimdat)</span>
<span id="cb46-47"><a href="m-step.html#cb46-47" aria-hidden="true" tabindex="-1"></a>      uz <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT, <span class="at">ncol =</span> dimdat)</span>
<span id="cb46-48"><a href="m-step.html#cb46-48" aria-hidden="true" tabindex="-1"></a>      uw <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">ncol =</span> TT <span class="sc">-</span> l , <span class="at">nrow =</span> dimdat)</span>
<span id="cb46-49"><a href="m-step.html#cb46-49" aria-hidden="true" tabindex="-1"></a>      args[[<span class="st">&#39;mu.warm&#39;</span>]] <span class="ot">&lt;-</span> mu</span>
<span id="cb46-50"><a href="m-step.html#cb46-50" aria-hidden="true" tabindex="-1"></a>      args[[<span class="st">&#39;warmstart&#39;</span>]] <span class="ot">&lt;-</span> T</span>
<span id="cb46-51"><a href="m-step.html#cb46-51" aria-hidden="true" tabindex="-1"></a>      args[[<span class="st">&#39;z&#39;</span>]] <span class="ot">&lt;-</span> Z</span>
<span id="cb46-52"><a href="m-step.html#cb46-52" aria-hidden="true" tabindex="-1"></a>      args[[<span class="st">&#39;w&#39;</span>]] <span class="ot">&lt;-</span> W</span>
<span id="cb46-53"><a href="m-step.html#cb46-53" aria-hidden="true" tabindex="-1"></a>      args[[<span class="st">&#39;uz&#39;</span>]] <span class="ot">&lt;-</span> uz</span>
<span id="cb46-54"><a href="m-step.html#cb46-54" aria-hidden="true" tabindex="-1"></a>      args[[<span class="st">&#39;uw&#39;</span>]] <span class="ot">&lt;-</span> uw</span>
<span id="cb46-55"><a href="m-step.html#cb46-55" aria-hidden="true" tabindex="-1"></a>      args[[<span class="st">&#39;rho&#39;</span>]] <span class="ot">&lt;-</span> rho</span>
<span id="cb46-56"><a href="m-step.html#cb46-56" aria-hidden="true" tabindex="-1"></a>      args[[<span class="st">&#39;schurB&#39;</span>]][[<span class="st">&#39;tQ&#39;</span>]] <span class="ot">&lt;-</span> tQ</span>
<span id="cb46-57"><a href="m-step.html#cb46-57" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(kk)</span>
<span id="cb46-58"><a href="m-step.html#cb46-58" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb46-59"><a href="m-step.html#cb46-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-60"><a href="m-step.html#cb46-60" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Run ADMM</span></span>
<span id="cb46-61"><a href="m-step.html#cb46-61" aria-hidden="true" tabindex="-1"></a>    args[[<span class="st">&#39;outer_iter&#39;</span>]] <span class="ot">&lt;-</span> kk</span>
<span id="cb46-62"><a href="m-step.html#cb46-62" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Call main function</span></span>
<span id="cb46-63"><a href="m-step.html#cb46-63" aria-hidden="true" tabindex="-1"></a>    argn <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(args), as.name)</span>
<span id="cb46-64"><a href="m-step.html#cb46-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(argn) <span class="ot">&lt;-</span> <span class="fu">names</span>(args)</span>
<span id="cb46-65"><a href="m-step.html#cb46-65" aria-hidden="true" tabindex="-1"></a>    call <span class="ot">&lt;-</span> <span class="fu">as.call</span>(<span class="fu">c</span>(<span class="fu">list</span>(<span class="fu">as.name</span>(<span class="st">&quot;admm_oneclust&quot;</span>)), argn))</span>
<span id="cb46-66"><a href="m-step.html#cb46-66" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">=</span> <span class="fu">eval</span>(call, args)</span>
<span id="cb46-67"><a href="m-step.html#cb46-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-68"><a href="m-step.html#cb46-68" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ## Temporary (uncomment for plotting objectives)</span></span>
<span id="cb46-69"><a href="m-step.html#cb46-69" aria-hidden="true" tabindex="-1"></a>    <span class="do">## fits = as.numeric(na.omit(res$fits))</span></span>
<span id="cb46-70"><a href="m-step.html#cb46-70" aria-hidden="true" tabindex="-1"></a>    <span class="do">## all_fits = c(all_fits, fits)</span></span>
<span id="cb46-71"><a href="m-step.html#cb46-71" aria-hidden="true" tabindex="-1"></a>    <span class="do">## all_cols = c(all_cols, rep(kk, length(fits)))</span></span>
<span id="cb46-72"><a href="m-step.html#cb46-72" aria-hidden="true" tabindex="-1"></a>    <span class="do">## print(all_fits)</span></span>
<span id="cb46-73"><a href="m-step.html#cb46-73" aria-hidden="true" tabindex="-1"></a>    <span class="do">## if(length(all_fits)!=0){</span></span>
<span id="cb46-74"><a href="m-step.html#cb46-74" aria-hidden="true" tabindex="-1"></a>    <span class="do">##   plot(all_fits %&gt;% log10(), col=all_cols, type=&#39;o&#39;, lwd=2, main = paste0(&quot;outer iter = &quot;, kk))</span></span>
<span id="cb46-75"><a href="m-step.html#cb46-75" aria-hidden="true" tabindex="-1"></a>    <span class="do">## }</span></span>
<span id="cb46-76"><a href="m-step.html#cb46-76" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ## End temporary</span></span>
<span id="cb46-77"><a href="m-step.html#cb46-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-78"><a href="m-step.html#cb46-78" aria-hidden="true" tabindex="-1"></a>    objectives <span class="ot">=</span> <span class="fu">c</span>(objectives, res<span class="sc">$</span>obj)</span>
<span id="cb46-79"><a href="m-step.html#cb46-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-80"><a href="m-step.html#cb46-80" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Handling the scenario where the objectives are all zero</span></span>
<span id="cb46-81"><a href="m-step.html#cb46-81" aria-hidden="true" tabindex="-1"></a>    padding <span class="ot">=</span> <span class="fl">1E-12</span></span>
<span id="cb46-82"><a href="m-step.html#cb46-82" aria-hidden="true" tabindex="-1"></a>    objectives <span class="ot">=</span> objectives <span class="sc">+</span> padding</span>
<span id="cb46-83"><a href="m-step.html#cb46-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-84"><a href="m-step.html#cb46-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(args<span class="sc">$</span>objective){</span>
<span id="cb46-85"><a href="m-step.html#cb46-85" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(objectives)</span>
<span id="cb46-86"><a href="m-step.html#cb46-86" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb46-87"><a href="m-step.html#cb46-87" aria-hidden="true" tabindex="-1"></a>    <span class="do">## See if outer iterations should terminate</span></span>
<span id="cb46-88"><a href="m-step.html#cb46-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(res<span class="sc">$</span>converge <span class="sc">|</span> <a href='m-step.html#outer_converge'>outer_converge</a>(objectives)){</span>
<span id="cb46-89"><a href="m-step.html#cb46-89" aria-hidden="true" tabindex="-1"></a>      res<span class="sc">$</span>converge <span class="ot">&lt;-</span> T</span>
<span id="cb46-90"><a href="m-step.html#cb46-90" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span></span>
<span id="cb46-91"><a href="m-step.html#cb46-91" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb46-92"><a href="m-step.html#cb46-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-93"><a href="m-step.html#cb46-93" aria-hidden="true" tabindex="-1"></a>    <span class="co">#browser()</span></span>
<span id="cb46-94"><a href="m-step.html#cb46-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-95"><a href="m-step.html#cb46-95" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Update some parameters; double the rho value, and update the B matrix</span></span>
<span id="cb46-96"><a href="m-step.html#cb46-96" aria-hidden="true" tabindex="-1"></a>    rho <span class="ot">=</span> <span class="dv">2</span> <span class="sc">*</span> args<span class="sc">$</span>rho</span>
<span id="cb46-97"><a href="m-step.html#cb46-97" aria-hidden="true" tabindex="-1"></a>    tQ <span class="ot">=</span> <span class="dv">2</span> <span class="sc">*</span> args<span class="sc">$</span>schurB<span class="sc">$</span>tQ</span>
<span id="cb46-98"><a href="m-step.html#cb46-98" aria-hidden="true" tabindex="-1"></a>    mu <span class="ot">=</span> res<span class="sc">$</span>mu</span>
<span id="cb46-99"><a href="m-step.html#cb46-99" aria-hidden="true" tabindex="-1"></a>    Z <span class="ot">=</span> res<span class="sc">$</span>Z</span>
<span id="cb46-100"><a href="m-step.html#cb46-100" aria-hidden="true" tabindex="-1"></a>    W <span class="ot">=</span> res<span class="sc">$</span>W</span>
<span id="cb46-101"><a href="m-step.html#cb46-101" aria-hidden="true" tabindex="-1"></a>    uz <span class="ot">=</span> res<span class="sc">$</span>uz</span>
<span id="cb46-102"><a href="m-step.html#cb46-102" aria-hidden="true" tabindex="-1"></a>    uw <span class="ot">=</span> res<span class="sc">$</span>uw</span>
<span id="cb46-103"><a href="m-step.html#cb46-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># browser()</span></span>
<span id="cb46-104"><a href="m-step.html#cb46-104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print(kk)</span></span>
<span id="cb46-105"><a href="m-step.html#cb46-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-106"><a href="m-step.html#cb46-106" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb46-107"><a href="m-step.html#cb46-107" aria-hidden="true" tabindex="-1"></a>  <span class="do">## if(!res$converge) warning(&quot;Didn&#39;t converge at all&quot;)</span></span>
<span id="cb46-108"><a href="m-step.html#cb46-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-109"><a href="m-step.html#cb46-109" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Record how long the admm took; in terms of # iterations.</span></span>
<span id="cb46-110"><a href="m-step.html#cb46-110" aria-hidden="true" tabindex="-1"></a>  res<span class="sc">$</span>kk <span class="ot">=</span> kk</span>
<span id="cb46-111"><a href="m-step.html#cb46-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-112"><a href="m-step.html#cb46-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(res)</span>
<span id="cb46-113"><a href="m-step.html#cb46-113" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Next, the inner loop. The workhorse <code><a href='m-step.html#admm_oneclust'>admm_oneclust</a>()</code> actually performs the ADMM
update for one cluster for a fixed step-size <span class="math inline">\(\rho\)</span> across optimization
iterations <code>iter=1,...,n</code>.</p>
<p>This <code><a href='m-step.html#admm_oneclust'>admm_oneclust</a>()</code> uses the following helpers:</p>
<ul>
<li><code><a href='m-step.html#W_update_fused'>W_update_fused</a>()</code>: this uses the <code>prox</code> function, which uses a RCpp function.
<code>prox_dp</code>.</li>
<li><code><a href='m-step.html#Z_update'>Z_update</a>()</code></li>
<li><code><a href='m-step.html#U_update_Z'>U_update_Z</a>()</code></li>
<li><code><a href='m-step.html#U_update_W'>U_update_W</a>()</code></li>
</ul>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="m-step.html#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Solve a fused lasso problem for the W update. Internally, a fused lasso dynamic</span></span>
<span id="cb47-2"><a href="m-step.html#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; programming solver \code{<a href='m-step.html#prox'>prox</a>()} (which calls \code{prox_dp()} written in C)</span></span>
<span id="cb47-3"><a href="m-step.html#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; is used.</span></span>
<span id="cb47-4"><a href="m-step.html#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb47-5"><a href="m-step.html#cb47-5" aria-hidden="true" tabindex="-1"></a><span id='W_update_fused'>W_update_fused</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(lm1, TT, mu, uw, rho, lambda){</span>
<span id="cb47-6"><a href="m-step.html#cb47-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-7"><a href="m-step.html#cb47-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># modified lambda for fused lasso routine</span></span>
<span id="cb47-8"><a href="m-step.html#cb47-8" aria-hidden="true" tabindex="-1"></a>  mod_lam <span class="ot">&lt;-</span> lambda<span class="sc">/</span>rho</span>
<span id="cb47-9"><a href="m-step.html#cb47-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-10"><a href="m-step.html#cb47-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># generating pseudo response xi</span></span>
<span id="cb47-11"><a href="m-step.html#cb47-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">#xi &lt;- Dlm1 %*% mu + 1/rho * uw</span></span>
<span id="cb47-12"><a href="m-step.html#cb47-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(lm1 <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb47-13"><a href="m-step.html#cb47-13" aria-hidden="true" tabindex="-1"></a>    xi <span class="ot">&lt;-</span> mu <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>rho <span class="sc">*</span> uw</span>
<span id="cb47-14"><a href="m-step.html#cb47-14" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb47-15"><a href="m-step.html#cb47-15" aria-hidden="true" tabindex="-1"></a>    xi <span class="ot">&lt;-</span> <span class="fu">diff</span>(mu, <span class="at">differences =</span> lm1) <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>rho <span class="sc">*</span> uw</span>
<span id="cb47-16"><a href="m-step.html#cb47-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb47-17"><a href="m-step.html#cb47-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-18"><a href="m-step.html#cb47-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># running the fused LASSO</span></span>
<span id="cb47-19"><a href="m-step.html#cb47-19" aria-hidden="true" tabindex="-1"></a>  <span class="do">## fit &lt;- <a href='m-step.html#prox'>prox</a>(z = xi, lam = mod_lam)</span></span>
<span id="cb47-20"><a href="m-step.html#cb47-20" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> FlowTF<span class="sc">::</span><a href='m-step.html#prox'>prox</a>(<span class="at">z =</span> xi, <span class="at">lam =</span> mod_lam)</span>
<span id="cb47-21"><a href="m-step.html#cb47-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-22"><a href="m-step.html#cb47-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(fit)</span>
<span id="cb47-23"><a href="m-step.html#cb47-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb47-24"><a href="m-step.html#cb47-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-25"><a href="m-step.html#cb47-25" aria-hidden="true" tabindex="-1"></a><span class="do">## This function is in FlowTF now. It&#39;s the last function there!</span></span>
<span id="cb47-26"><a href="m-step.html#cb47-26" aria-hidden="true" tabindex="-1"></a><span class="do">## #&#39; Fused LASSO for scalar inputs.</span></span>
<span id="cb47-27"><a href="m-step.html#cb47-27" aria-hidden="true" tabindex="-1"></a><span class="do">## #&#39;</span></span>
<span id="cb47-28"><a href="m-step.html#cb47-28" aria-hidden="true" tabindex="-1"></a><span class="do">## #&#39; @param z scalar input to be smoothed via the fused LASSO</span></span>
<span id="cb47-29"><a href="m-step.html#cb47-29" aria-hidden="true" tabindex="-1"></a><span class="do">## #&#39; @param lam  Fused LASSO smoothing parameter</span></span>
<span id="cb47-30"><a href="m-step.html#cb47-30" aria-hidden="true" tabindex="-1"></a><span class="do">## #&#39;</span></span>
<span id="cb47-31"><a href="m-step.html#cb47-31" aria-hidden="true" tabindex="-1"></a><span class="do">## #&#39; @return Estimates of the fused LASSO solution</span></span>
<span id="cb47-32"><a href="m-step.html#cb47-32" aria-hidden="true" tabindex="-1"></a><span class="do">## #&#39; @export prox</span></span>
<span id="cb47-33"><a href="m-step.html#cb47-33" aria-hidden="true" tabindex="-1"></a><span class="do">## #&#39;</span></span>
<span id="cb47-34"><a href="m-step.html#cb47-34" aria-hidden="true" tabindex="-1"></a><span class="do">## #&#39; @references All credit for writing this function goes to Ryan Tibshirani. See</span></span>
<span id="cb47-35"><a href="m-step.html#cb47-35" aria-hidden="true" tabindex="-1"></a><span class="do">## #&#39;   the original code for calling this function at</span></span>
<span id="cb47-36"><a href="m-step.html#cb47-36" aria-hidden="true" tabindex="-1"></a><span class="do">## #&#39;</span></span>
<span id="cb47-37"><a href="m-step.html#cb47-37" aria-hidden="true" tabindex="-1"></a><span class="do">## #&#39; @useDynLib FlowTF prox_dp </span></span>
<span id="cb47-38"><a href="m-step.html#cb47-38" aria-hidden="true" tabindex="-1"></a><span class="do">## <span id='prox'>prox</span> &lt;-  function(z, lam) {</span></span>
<span id="cb47-39"><a href="m-step.html#cb47-39" aria-hidden="true" tabindex="-1"></a><span class="do">##   o &lt;- .C(&quot;prox_dp&quot;,</span></span>
<span id="cb47-40"><a href="m-step.html#cb47-40" aria-hidden="true" tabindex="-1"></a><span class="do">##           as.integer(length(z)),</span></span>
<span id="cb47-41"><a href="m-step.html#cb47-41" aria-hidden="true" tabindex="-1"></a><span class="do">##           as.double(z),</span></span>
<span id="cb47-42"><a href="m-step.html#cb47-42" aria-hidden="true" tabindex="-1"></a><span class="do">##           as.double(lam),</span></span>
<span id="cb47-43"><a href="m-step.html#cb47-43" aria-hidden="true" tabindex="-1"></a><span class="do">##           as.double(numeric(length(z))),</span></span>
<span id="cb47-44"><a href="m-step.html#cb47-44" aria-hidden="true" tabindex="-1"></a><span class="do">##           #  dup=FALSE,</span></span>
<span id="cb47-45"><a href="m-step.html#cb47-45" aria-hidden="true" tabindex="-1"></a><span class="do">##           PACKAGE=&quot;FlowTF&quot;)</span></span>
<span id="cb47-46"><a href="m-step.html#cb47-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-47"><a href="m-step.html#cb47-47" aria-hidden="true" tabindex="-1"></a><span class="do">##   return(o[[4]])</span></span>
<span id="cb47-48"><a href="m-step.html#cb47-48" aria-hidden="true" tabindex="-1"></a><span class="do">## }</span></span>
<span id="cb47-49"><a href="m-step.html#cb47-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-50"><a href="m-step.html#cb47-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-51"><a href="m-step.html#cb47-51" aria-hidden="true" tabindex="-1"></a><span id='Z_update'>Z_update</span>  <span class="ot">&lt;-</span> <span class="cf">function</span>(m, Uz, C, rho){</span>
<span id="cb47-52"><a href="m-step.html#cb47-52" aria-hidden="true" tabindex="-1"></a>  mat <span class="ot">=</span> m <span class="sc">+</span> Uz<span class="sc">/</span>rho</span>
<span id="cb47-53"><a href="m-step.html#cb47-53" aria-hidden="true" tabindex="-1"></a>  Z <span class="ot">=</span> <a href='m-step.html#projCmat'>projCmat</a>(mat, C)</span>
<span id="cb47-54"><a href="m-step.html#cb47-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(Z)</span>
<span id="cb47-55"><a href="m-step.html#cb47-55" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb47-56"><a href="m-step.html#cb47-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-57"><a href="m-step.html#cb47-57" aria-hidden="true" tabindex="-1"></a><span id='projCmat'>projCmat</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(mat, C){</span>
<span id="cb47-58"><a href="m-step.html#cb47-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(C)){</span>
<span id="cb47-59"><a href="m-step.html#cb47-59" aria-hidden="true" tabindex="-1"></a>    vlens <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="fu">rowSums</span>(mat <span class="sc">*</span> mat))</span>
<span id="cb47-60"><a href="m-step.html#cb47-60" aria-hidden="true" tabindex="-1"></a>    inds <span class="ot">=</span> <span class="fu">which</span>(vlens <span class="sc">&gt;</span> C)</span>
<span id="cb47-61"><a href="m-step.html#cb47-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(inds) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb47-62"><a href="m-step.html#cb47-62" aria-hidden="true" tabindex="-1"></a>      mat[inds,] <span class="ot">=</span> mat[inds,] <span class="sc">*</span> C <span class="sc">/</span> vlens[inds]</span>
<span id="cb47-63"><a href="m-step.html#cb47-63" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb47-64"><a href="m-step.html#cb47-64" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb47-65"><a href="m-step.html#cb47-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(mat)</span>
<span id="cb47-66"><a href="m-step.html#cb47-66" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb47-67"><a href="m-step.html#cb47-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-68"><a href="m-step.html#cb47-68" aria-hidden="true" tabindex="-1"></a><span id='U_update_Z'>U_update_Z</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(U, rho, mu, Z){</span>
<span id="cb47-69"><a href="m-step.html#cb47-69" aria-hidden="true" tabindex="-1"></a> <span class="co"># return(U + rho * (scale(mu, scale = F) - Z))</span></span>
<span id="cb47-70"><a href="m-step.html#cb47-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(U <span class="sc">+</span> rho <span class="sc">*</span> (<span class="fu">t</span>(<span class="fu">t</span>(mu) <span class="sc">-</span> <span class="fu">rowMeans</span>(<span class="fu">t</span>(mu))) <span class="sc">-</span> Z))</span>
<span id="cb47-71"><a href="m-step.html#cb47-71" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb47-72"><a href="m-step.html#cb47-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-73"><a href="m-step.html#cb47-73" aria-hidden="true" tabindex="-1"></a><span id='U_update_W'>U_update_W</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(U, rho, mu, W, Dlm1, l){</span>
<span id="cb47-74"><a href="m-step.html#cb47-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-75"><a href="m-step.html#cb47-75" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(l<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb47-76"><a href="m-step.html#cb47-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(U <span class="sc">+</span>  rho <span class="sc">*</span> (mu <span class="sc">-</span> W)) <span class="do">## This /seems/ like it will work.</span></span>
<span id="cb47-77"><a href="m-step.html#cb47-77" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb47-78"><a href="m-step.html#cb47-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(U <span class="sc">+</span>  rho <span class="sc">*</span> ( <span class="fu">t</span>(<span class="fu">diff</span>(<span class="fu">t</span>(mu), <span class="at">differences =</span> l)) <span class="sc">-</span> W))</span>
<span id="cb47-79"><a href="m-step.html#cb47-79" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb47-80"><a href="m-step.html#cb47-80" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>A <code>prox_dp</code> function, written in C, will be used:
[TODO: I might rewrite this into Cpp]</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb48-1"><a href="m-step.html#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb48-2"><a href="m-step.html#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span></span>
<span id="cb48-3"><a href="m-step.html#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb48-4"><a href="m-step.html#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="m-step.html#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Dynamic programming algorithm for the 1d fused lasso problem</span></span>
<span id="cb48-6"><a href="m-step.html#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="co">// (Ryan&#39;s implementation of Nick Johnson&#39;s algorithm)</span></span>
<span id="cb48-7"><a href="m-step.html#cb48-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-8"><a href="m-step.html#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> prox_dp<span class="op">(</span><span class="dt">int</span> <span class="op">*</span>pn<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>y<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>plam<span class="op">,</span> <span class="dt">double</span> <span class="op">*</span>beta<span class="op">)</span> <span class="op">{</span></span>
<span id="cb48-9"><a href="m-step.html#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="m-step.html#cb48-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n <span class="op">=</span> <span class="op">*</span>pn<span class="op">;</span></span>
<span id="cb48-11"><a href="m-step.html#cb48-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> lam <span class="op">=</span> <span class="op">*</span>plam<span class="op">;</span></span>
<span id="cb48-12"><a href="m-step.html#cb48-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-13"><a href="m-step.html#cb48-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Take care of a few trivial cases</span></span>
<span id="cb48-14"><a href="m-step.html#cb48-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>n<span class="op">==</span><span class="dv">0</span><span class="op">)</span> <span class="cf">return</span><span class="op">;</span></span>
<span id="cb48-15"><a href="m-step.html#cb48-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>n<span class="op">==</span><span class="dv">1</span> <span class="op">||</span> lam<span class="op">==</span><span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb48-16"><a href="m-step.html#cb48-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;</span>n<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb48-17"><a href="m-step.html#cb48-17" aria-hidden="true" tabindex="-1"></a>      beta<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> y<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb48-18"><a href="m-step.html#cb48-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb48-19"><a href="m-step.html#cb48-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb48-20"><a href="m-step.html#cb48-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb48-21"><a href="m-step.html#cb48-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-22"><a href="m-step.html#cb48-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">// These are used to store the derivative of the</span></span>
<span id="cb48-23"><a href="m-step.html#cb48-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">// piecewise quadratic function of interest</span></span>
<span id="cb48-24"><a href="m-step.html#cb48-24" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> afirst<span class="op">,</span> alast<span class="op">,</span> bfirst<span class="op">,</span> blast<span class="op">;</span></span>
<span id="cb48-25"><a href="m-step.html#cb48-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> <span class="op">*</span>x <span class="op">=</span> <span class="op">(</span><span class="dt">double</span><span class="op">*)</span>malloc<span class="op">(</span><span class="dv">2</span><span class="op">*</span>n<span class="op">*</span><span class="kw">sizeof</span><span class="op">(</span><span class="dt">double</span><span class="op">));</span></span>
<span id="cb48-26"><a href="m-step.html#cb48-26" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> <span class="op">*</span>a <span class="op">=</span> <span class="op">(</span><span class="dt">double</span><span class="op">*)</span>malloc<span class="op">(</span><span class="dv">2</span><span class="op">*</span>n<span class="op">*</span><span class="kw">sizeof</span><span class="op">(</span><span class="dt">double</span><span class="op">));</span></span>
<span id="cb48-27"><a href="m-step.html#cb48-27" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> <span class="op">*</span>b <span class="op">=</span> <span class="op">(</span><span class="dt">double</span><span class="op">*)</span>malloc<span class="op">(</span><span class="dv">2</span><span class="op">*</span>n<span class="op">*</span><span class="kw">sizeof</span><span class="op">(</span><span class="dt">double</span><span class="op">));</span></span>
<span id="cb48-28"><a href="m-step.html#cb48-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> l<span class="op">,</span>r<span class="op">;</span></span>
<span id="cb48-29"><a href="m-step.html#cb48-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-30"><a href="m-step.html#cb48-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">// These are the knots of the back-pointers</span></span>
<span id="cb48-31"><a href="m-step.html#cb48-31" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> <span class="op">*</span>tm <span class="op">=</span> <span class="op">(</span><span class="dt">double</span><span class="op">*)</span>malloc<span class="op">((</span>n<span class="op">-</span><span class="dv">1</span><span class="op">)*</span><span class="kw">sizeof</span><span class="op">(</span><span class="dt">double</span><span class="op">));</span></span>
<span id="cb48-32"><a href="m-step.html#cb48-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> <span class="op">*</span>tp <span class="op">=</span> <span class="op">(</span><span class="dt">double</span><span class="op">*)</span>malloc<span class="op">((</span>n<span class="op">-</span><span class="dv">1</span><span class="op">)*</span><span class="kw">sizeof</span><span class="op">(</span><span class="dt">double</span><span class="op">));</span></span>
<span id="cb48-33"><a href="m-step.html#cb48-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-34"><a href="m-step.html#cb48-34" aria-hidden="true" tabindex="-1"></a>  <span class="co">// We step through the first iteration manually</span></span>
<span id="cb48-35"><a href="m-step.html#cb48-35" aria-hidden="true" tabindex="-1"></a>  tm<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="op">-</span>lam<span class="op">+</span>y<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb48-36"><a href="m-step.html#cb48-36" aria-hidden="true" tabindex="-1"></a>  tp<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> lam<span class="op">+</span>y<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb48-37"><a href="m-step.html#cb48-37" aria-hidden="true" tabindex="-1"></a>  l <span class="op">=</span> n<span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb48-38"><a href="m-step.html#cb48-38" aria-hidden="true" tabindex="-1"></a>  r <span class="op">=</span> n<span class="op">;</span></span>
<span id="cb48-39"><a href="m-step.html#cb48-39" aria-hidden="true" tabindex="-1"></a>  x<span class="op">[</span>l<span class="op">]</span> <span class="op">=</span> tm<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb48-40"><a href="m-step.html#cb48-40" aria-hidden="true" tabindex="-1"></a>  x<span class="op">[</span>r<span class="op">]</span> <span class="op">=</span> tp<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb48-41"><a href="m-step.html#cb48-41" aria-hidden="true" tabindex="-1"></a>  a<span class="op">[</span>l<span class="op">]</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb48-42"><a href="m-step.html#cb48-42" aria-hidden="true" tabindex="-1"></a>  b<span class="op">[</span>l<span class="op">]</span> <span class="op">=</span> <span class="op">-</span>y<span class="op">[</span><span class="dv">0</span><span class="op">]+</span>lam<span class="op">;</span></span>
<span id="cb48-43"><a href="m-step.html#cb48-43" aria-hidden="true" tabindex="-1"></a>  a<span class="op">[</span>r<span class="op">]</span> <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb48-44"><a href="m-step.html#cb48-44" aria-hidden="true" tabindex="-1"></a>  b<span class="op">[</span>r<span class="op">]</span> <span class="op">=</span> y<span class="op">[</span><span class="dv">0</span><span class="op">]+</span>lam<span class="op">;</span></span>
<span id="cb48-45"><a href="m-step.html#cb48-45" aria-hidden="true" tabindex="-1"></a>  afirst <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb48-46"><a href="m-step.html#cb48-46" aria-hidden="true" tabindex="-1"></a>  bfirst <span class="op">=</span> <span class="op">-</span>lam<span class="op">-</span>y<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb48-47"><a href="m-step.html#cb48-47" aria-hidden="true" tabindex="-1"></a>  alast <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb48-48"><a href="m-step.html#cb48-48" aria-hidden="true" tabindex="-1"></a>  blast <span class="op">=</span> <span class="op">-</span>lam<span class="op">+</span>y<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb48-49"><a href="m-step.html#cb48-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-50"><a href="m-step.html#cb48-50" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Now iterations 2 through n-1</span></span>
<span id="cb48-51"><a href="m-step.html#cb48-51" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> lo<span class="op">,</span> hi<span class="op">;</span></span>
<span id="cb48-52"><a href="m-step.html#cb48-52" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> alo<span class="op">,</span> blo<span class="op">,</span> ahi<span class="op">,</span> bhi<span class="op">;</span></span>
<span id="cb48-53"><a href="m-step.html#cb48-53" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> k<span class="op">=</span><span class="dv">1</span><span class="op">;</span> k<span class="op">&lt;</span>n<span class="op">-</span><span class="dv">1</span><span class="op">;</span> k<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb48-54"><a href="m-step.html#cb48-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Compute lo: step up from l until the</span></span>
<span id="cb48-55"><a href="m-step.html#cb48-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">// derivative is greater than -lam</span></span>
<span id="cb48-56"><a href="m-step.html#cb48-56" aria-hidden="true" tabindex="-1"></a>    alo <span class="op">=</span> afirst<span class="op">;</span></span>
<span id="cb48-57"><a href="m-step.html#cb48-57" aria-hidden="true" tabindex="-1"></a>    blo <span class="op">=</span> bfirst<span class="op">;</span></span>
<span id="cb48-58"><a href="m-step.html#cb48-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>lo<span class="op">=</span>l<span class="op">;</span> lo<span class="op">&lt;=</span>r<span class="op">;</span> lo<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb48-59"><a href="m-step.html#cb48-59" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>alo<span class="op">*</span>x<span class="op">[</span>lo<span class="op">]+</span>blo <span class="op">&gt;</span> <span class="op">-</span>lam<span class="op">)</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb48-60"><a href="m-step.html#cb48-60" aria-hidden="true" tabindex="-1"></a>      alo <span class="op">+=</span> a<span class="op">[</span>lo<span class="op">];</span></span>
<span id="cb48-61"><a href="m-step.html#cb48-61" aria-hidden="true" tabindex="-1"></a>      blo <span class="op">+=</span> b<span class="op">[</span>lo<span class="op">];</span></span>
<span id="cb48-62"><a href="m-step.html#cb48-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb48-63"><a href="m-step.html#cb48-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-64"><a href="m-step.html#cb48-64" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Compute the negative knot</span></span>
<span id="cb48-65"><a href="m-step.html#cb48-65" aria-hidden="true" tabindex="-1"></a>    tm<span class="op">[</span>k<span class="op">]</span> <span class="op">=</span> <span class="op">(-</span>lam<span class="op">-</span>blo<span class="op">)/</span>alo<span class="op">;</span></span>
<span id="cb48-66"><a href="m-step.html#cb48-66" aria-hidden="true" tabindex="-1"></a>    l <span class="op">=</span> lo<span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb48-67"><a href="m-step.html#cb48-67" aria-hidden="true" tabindex="-1"></a>    x<span class="op">[</span>l<span class="op">]</span> <span class="op">=</span> tm<span class="op">[</span>k<span class="op">];</span></span>
<span id="cb48-68"><a href="m-step.html#cb48-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-69"><a href="m-step.html#cb48-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Compute hi: step down from r until the</span></span>
<span id="cb48-70"><a href="m-step.html#cb48-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">// derivative is less than lam</span></span>
<span id="cb48-71"><a href="m-step.html#cb48-71" aria-hidden="true" tabindex="-1"></a>    ahi <span class="op">=</span> alast<span class="op">;</span></span>
<span id="cb48-72"><a href="m-step.html#cb48-72" aria-hidden="true" tabindex="-1"></a>    bhi <span class="op">=</span> blast<span class="op">;</span></span>
<span id="cb48-73"><a href="m-step.html#cb48-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>hi<span class="op">=</span>r<span class="op">;</span> hi<span class="op">&gt;=</span>l<span class="op">;</span> hi<span class="op">--)</span> <span class="op">{</span></span>
<span id="cb48-74"><a href="m-step.html#cb48-74" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(-</span>ahi<span class="op">*</span>x<span class="op">[</span>hi<span class="op">]-</span>bhi <span class="op">&lt;</span> lam<span class="op">)</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb48-75"><a href="m-step.html#cb48-75" aria-hidden="true" tabindex="-1"></a>      ahi <span class="op">+=</span> a<span class="op">[</span>hi<span class="op">];</span></span>
<span id="cb48-76"><a href="m-step.html#cb48-76" aria-hidden="true" tabindex="-1"></a>      bhi <span class="op">+=</span> b<span class="op">[</span>hi<span class="op">];</span></span>
<span id="cb48-77"><a href="m-step.html#cb48-77" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb48-78"><a href="m-step.html#cb48-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-79"><a href="m-step.html#cb48-79" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Compute the positive knot</span></span>
<span id="cb48-80"><a href="m-step.html#cb48-80" aria-hidden="true" tabindex="-1"></a>    tp<span class="op">[</span>k<span class="op">]</span> <span class="op">=</span> <span class="op">(</span>lam<span class="op">+</span>bhi<span class="op">)/(-</span>ahi<span class="op">);</span></span>
<span id="cb48-81"><a href="m-step.html#cb48-81" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> hi<span class="op">+</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb48-82"><a href="m-step.html#cb48-82" aria-hidden="true" tabindex="-1"></a>    x<span class="op">[</span>r<span class="op">]</span> <span class="op">=</span> tp<span class="op">[</span>k<span class="op">];</span></span>
<span id="cb48-83"><a href="m-step.html#cb48-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-84"><a href="m-step.html#cb48-84" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update a and b</span></span>
<span id="cb48-85"><a href="m-step.html#cb48-85" aria-hidden="true" tabindex="-1"></a>    a<span class="op">[</span>l<span class="op">]</span> <span class="op">=</span> alo<span class="op">;</span></span>
<span id="cb48-86"><a href="m-step.html#cb48-86" aria-hidden="true" tabindex="-1"></a>    b<span class="op">[</span>l<span class="op">]</span> <span class="op">=</span> blo<span class="op">+</span>lam<span class="op">;</span></span>
<span id="cb48-87"><a href="m-step.html#cb48-87" aria-hidden="true" tabindex="-1"></a>    a<span class="op">[</span>r<span class="op">]</span> <span class="op">=</span> ahi<span class="op">;</span></span>
<span id="cb48-88"><a href="m-step.html#cb48-88" aria-hidden="true" tabindex="-1"></a>    b<span class="op">[</span>r<span class="op">]</span> <span class="op">=</span> bhi<span class="op">+</span>lam<span class="op">;</span></span>
<span id="cb48-89"><a href="m-step.html#cb48-89" aria-hidden="true" tabindex="-1"></a>    afirst <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb48-90"><a href="m-step.html#cb48-90" aria-hidden="true" tabindex="-1"></a>    bfirst <span class="op">=</span> <span class="op">-</span>lam<span class="op">-</span>y<span class="op">[</span>k<span class="op">+</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb48-91"><a href="m-step.html#cb48-91" aria-hidden="true" tabindex="-1"></a>    alast <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb48-92"><a href="m-step.html#cb48-92" aria-hidden="true" tabindex="-1"></a>    blast <span class="op">=</span> <span class="op">-</span>lam<span class="op">+</span>y<span class="op">[</span>k<span class="op">+</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb48-93"><a href="m-step.html#cb48-93" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb48-94"><a href="m-step.html#cb48-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-95"><a href="m-step.html#cb48-95" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute the last coefficient: this is where</span></span>
<span id="cb48-96"><a href="m-step.html#cb48-96" aria-hidden="true" tabindex="-1"></a>  <span class="co">// the function has zero derivative</span></span>
<span id="cb48-97"><a href="m-step.html#cb48-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-98"><a href="m-step.html#cb48-98" aria-hidden="true" tabindex="-1"></a>  alo <span class="op">=</span> afirst<span class="op">;</span></span>
<span id="cb48-99"><a href="m-step.html#cb48-99" aria-hidden="true" tabindex="-1"></a>  blo <span class="op">=</span> bfirst<span class="op">;</span></span>
<span id="cb48-100"><a href="m-step.html#cb48-100" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span>lo<span class="op">=</span>l<span class="op">;</span> lo<span class="op">&lt;=</span>r<span class="op">;</span> lo<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb48-101"><a href="m-step.html#cb48-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>alo<span class="op">*</span>x<span class="op">[</span>lo<span class="op">]+</span>blo <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb48-102"><a href="m-step.html#cb48-102" aria-hidden="true" tabindex="-1"></a>    alo <span class="op">+=</span> a<span class="op">[</span>lo<span class="op">];</span></span>
<span id="cb48-103"><a href="m-step.html#cb48-103" aria-hidden="true" tabindex="-1"></a>    blo <span class="op">+=</span> b<span class="op">[</span>lo<span class="op">];</span></span>
<span id="cb48-104"><a href="m-step.html#cb48-104" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb48-105"><a href="m-step.html#cb48-105" aria-hidden="true" tabindex="-1"></a>  beta<span class="op">[</span>n<span class="op">-</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> <span class="op">-</span>blo<span class="op">/</span>alo<span class="op">;</span></span>
<span id="cb48-106"><a href="m-step.html#cb48-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-107"><a href="m-step.html#cb48-107" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute the rest of the coefficients, by the</span></span>
<span id="cb48-108"><a href="m-step.html#cb48-108" aria-hidden="true" tabindex="-1"></a>  <span class="co">// back-pointers</span></span>
<span id="cb48-109"><a href="m-step.html#cb48-109" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> k<span class="op">=</span>n<span class="op">-</span><span class="dv">2</span><span class="op">;</span> k<span class="op">&gt;=</span><span class="dv">0</span><span class="op">;</span> k<span class="op">--)</span> <span class="op">{</span></span>
<span id="cb48-110"><a href="m-step.html#cb48-110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>beta<span class="op">[</span>k<span class="op">+</span><span class="dv">1</span><span class="op">]&gt;</span>tp<span class="op">[</span>k<span class="op">])</span> beta<span class="op">[</span>k<span class="op">]</span> <span class="op">=</span> tp<span class="op">[</span>k<span class="op">];</span></span>
<span id="cb48-111"><a href="m-step.html#cb48-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>beta<span class="op">[</span>k<span class="op">+</span><span class="dv">1</span><span class="op">]&lt;</span>tm<span class="op">[</span>k<span class="op">])</span> beta<span class="op">[</span>k<span class="op">]</span> <span class="op">=</span> tm<span class="op">[</span>k<span class="op">];</span></span>
<span id="cb48-112"><a href="m-step.html#cb48-112" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> beta<span class="op">[</span>k<span class="op">]</span> <span class="op">=</span> beta<span class="op">[</span>k<span class="op">+</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb48-113"><a href="m-step.html#cb48-113" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb48-114"><a href="m-step.html#cb48-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-115"><a href="m-step.html#cb48-115" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Done! Free up memory</span></span>
<span id="cb48-116"><a href="m-step.html#cb48-116" aria-hidden="true" tabindex="-1"></a>  free<span class="op">(</span>x<span class="op">);</span></span>
<span id="cb48-117"><a href="m-step.html#cb48-117" aria-hidden="true" tabindex="-1"></a>  free<span class="op">(</span>a<span class="op">);</span></span>
<span id="cb48-118"><a href="m-step.html#cb48-118" aria-hidden="true" tabindex="-1"></a>  free<span class="op">(</span>b<span class="op">);</span></span>
<span id="cb48-119"><a href="m-step.html#cb48-119" aria-hidden="true" tabindex="-1"></a>  free<span class="op">(</span>tm<span class="op">);</span></span>
<span id="cb48-120"><a href="m-step.html#cb48-120" aria-hidden="true" tabindex="-1"></a>  free<span class="op">(</span>tp<span class="op">);</span></span>
<span id="cb48-121"><a href="m-step.html#cb48-121" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Here is that main workhorse <code><a href='m-step.html#admm_oneclust'>admm_oneclust</a>()</code>.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="m-step.html#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; One cluster&#39;s admm for a fixed step size (rho).</span></span>
<span id="cb49-2"><a href="m-step.html#cb49-2" aria-hidden="true" tabindex="-1"></a><span id='admm_oneclust'>admm_oneclust</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">iclust =</span> <span class="dv">1</span>, niter, y,</span>
<span id="cb49-3"><a href="m-step.html#cb49-3" aria-hidden="true" tabindex="-1"></a>                          Dlm1, Dl, <span class="at">l =</span> <span class="cn">NULL</span>,</span>
<span id="cb49-4"><a href="m-step.html#cb49-4" aria-hidden="true" tabindex="-1"></a>                          TT, N, dimdat, maxdev,</span>
<span id="cb49-5"><a href="m-step.html#cb49-5" aria-hidden="true" tabindex="-1"></a>                          rho,</span>
<span id="cb49-6"><a href="m-step.html#cb49-6" aria-hidden="true" tabindex="-1"></a>                          <span class="at">rhoinit =</span> rho,</span>
<span id="cb49-7"><a href="m-step.html#cb49-7" aria-hidden="true" tabindex="-1"></a>                          Xinv,</span>
<span id="cb49-8"><a href="m-step.html#cb49-8" aria-hidden="true" tabindex="-1"></a>                          schurA,</span>
<span id="cb49-9"><a href="m-step.html#cb49-9" aria-hidden="true" tabindex="-1"></a>                          schurB,</span>
<span id="cb49-10"><a href="m-step.html#cb49-10" aria-hidden="true" tabindex="-1"></a>                          sigmainv,</span>
<span id="cb49-11"><a href="m-step.html#cb49-11" aria-hidden="true" tabindex="-1"></a>                          lambda,</span>
<span id="cb49-12"><a href="m-step.html#cb49-12" aria-hidden="true" tabindex="-1"></a>                          resp,</span>
<span id="cb49-13"><a href="m-step.html#cb49-13" aria-hidden="true" tabindex="-1"></a>                          ylist, <span class="at">err_rel =</span> <span class="fl">1e-3</span>, <span class="at">err_abs =</span> <span class="dv">0</span>,</span>
<span id="cb49-14"><a href="m-step.html#cb49-14" aria-hidden="true" tabindex="-1"></a>                          zerothresh,</span>
<span id="cb49-15"><a href="m-step.html#cb49-15" aria-hidden="true" tabindex="-1"></a>                          z,</span>
<span id="cb49-16"><a href="m-step.html#cb49-16" aria-hidden="true" tabindex="-1"></a>                          w,</span>
<span id="cb49-17"><a href="m-step.html#cb49-17" aria-hidden="true" tabindex="-1"></a>                          uw,</span>
<span id="cb49-18"><a href="m-step.html#cb49-18" aria-hidden="true" tabindex="-1"></a>                          uz,</span>
<span id="cb49-19"><a href="m-step.html#cb49-19" aria-hidden="true" tabindex="-1"></a>                          <span class="at">warmstart =</span> <span class="cn">FALSE</span>,</span>
<span id="cb49-20"><a href="m-step.html#cb49-20" aria-hidden="true" tabindex="-1"></a>                          <span class="at">mu.warm =</span> <span class="cf">if</span>(<span class="sc">!</span>warmstart) <span class="cn">NULL</span>,</span>
<span id="cb49-21"><a href="m-step.html#cb49-21" aria-hidden="true" tabindex="-1"></a>                          first_iter,<span class="do">## Not used</span></span>
<span id="cb49-22"><a href="m-step.html#cb49-22" aria-hidden="true" tabindex="-1"></a>                          outer_iter,</span>
<span id="cb49-23"><a href="m-step.html#cb49-23" aria-hidden="true" tabindex="-1"></a>                          local_adapt,</span>
<span id="cb49-24"><a href="m-step.html#cb49-24" aria-hidden="true" tabindex="-1"></a>                          sigma,</span>
<span id="cb49-25"><a href="m-step.html#cb49-25" aria-hidden="true" tabindex="-1"></a>                          sigma_eig_by_clust,</span>
<span id="cb49-26"><a href="m-step.html#cb49-26" aria-hidden="true" tabindex="-1"></a>                          <span class="at">space =</span> <span class="dv">20</span>,</span>
<span id="cb49-27"><a href="m-step.html#cb49-27" aria-hidden="true" tabindex="-1"></a>                          <span class="do">## diagnostics</span></span>
<span id="cb49-28"><a href="m-step.html#cb49-28" aria-hidden="true" tabindex="-1"></a>                          <span class="at">norms =</span> F, <span class="at">objective  =</span> F){</span>
<span id="cb49-29"><a href="m-step.html#cb49-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-30"><a href="m-step.html#cb49-30" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Initialize the variables </span><span class="al">###</span></span>
<span id="cb49-31"><a href="m-step.html#cb49-31" aria-hidden="true" tabindex="-1"></a>  resid_mat <span class="ot">=</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">ceiling</span>(niter<span class="sc">/</span><span class="dv">5</span>), <span class="at">ncol =</span> <span class="dv">4</span>)</span>
<span id="cb49-32"><a href="m-step.html#cb49-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(resid_mat) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;primresid&quot;</span>, <span class="st">&quot;primerr&quot;</span>, <span class="st">&quot;dualresid&quot;</span>, <span class="st">&quot;dualerr&quot;</span>)</span>
<span id="cb49-33"><a href="m-step.html#cb49-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-34"><a href="m-step.html#cb49-34" aria-hidden="true" tabindex="-1"></a>  rhofac <span class="ot">=</span> rho <span class="sc">/</span> rhoinit</span>
<span id="cb49-35"><a href="m-step.html#cb49-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-36"><a href="m-step.html#cb49-36" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Main inner LA-ADMM loop</span></span>
<span id="cb49-37"><a href="m-step.html#cb49-37" aria-hidden="true" tabindex="-1"></a>  fits <span class="ot">=</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">ceiling</span>(niter<span class="sc">/</span>space))</span>
<span id="cb49-38"><a href="m-step.html#cb49-38" aria-hidden="true" tabindex="-1"></a>  converge <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb49-39"><a href="m-step.html#cb49-39" aria-hidden="true" tabindex="-1"></a>  start.time <span class="ot">=</span> <span class="fu">Sys.time</span>()</span>
<span id="cb49-40"><a href="m-step.html#cb49-40" aria-hidden="true" tabindex="-1"></a>  Zlist <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb49-41"><a href="m-step.html#cb49-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-42"><a href="m-step.html#cb49-42" aria-hidden="true" tabindex="-1"></a>  <span class="do">## This doesn&#39;t change over iterations</span></span>
<span id="cb49-43"><a href="m-step.html#cb49-43" aria-hidden="true" tabindex="-1"></a>  schurA <span class="ot">=</span> <a href='m-step.html#myschur'>myschur</a>(schurA<span class="sc">$</span>orig <span class="sc">*</span> rhofac)</span>
<span id="cb49-44"><a href="m-step.html#cb49-44" aria-hidden="true" tabindex="-1"></a>  TA <span class="ot">=</span> schurA<span class="sc">$</span>T <span class="do">##* rhofac</span></span>
<span id="cb49-45"><a href="m-step.html#cb49-45" aria-hidden="true" tabindex="-1"></a>  TB <span class="ot">=</span> schurB<span class="sc">$</span>T</span>
<span id="cb49-46"><a href="m-step.html#cb49-46" aria-hidden="true" tabindex="-1"></a>  UA <span class="ot">=</span> schurA<span class="sc">$</span>Q</span>
<span id="cb49-47"><a href="m-step.html#cb49-47" aria-hidden="true" tabindex="-1"></a>  UB <span class="ot">=</span> schurB<span class="sc">$</span>Q</span>
<span id="cb49-48"><a href="m-step.html#cb49-48" aria-hidden="true" tabindex="-1"></a>  tUA <span class="ot">=</span> schurA<span class="sc">$</span>tQ</span>
<span id="cb49-49"><a href="m-step.html#cb49-49" aria-hidden="true" tabindex="-1"></a>  tUB <span class="ot">=</span> schurB<span class="sc">$</span>tQ</span>
<span id="cb49-50"><a href="m-step.html#cb49-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-51"><a href="m-step.html#cb49-51" aria-hidden="true" tabindex="-1"></a>  <span class="do">## This also doesn&#39;t change over iterations</span></span>
<span id="cb49-52"><a href="m-step.html#cb49-52" aria-hidden="true" tabindex="-1"></a>  C1 <span class="ot">&lt;-</span> <span class="fu">do.call</span>(cbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(t){</span>
<span id="cb49-53"><a href="m-step.html#cb49-53" aria-hidden="true" tabindex="-1"></a>      multmat <span class="ot">&lt;-</span> <span class="fu">apply</span>(y[[t]], <span class="at">FUN =</span> <span class="cf">function</span>(yy) yy<span class="sc">*</span>resp[[t]], <span class="at">MARGIN =</span> <span class="dv">2</span>)</span>
<span id="cb49-54"><a href="m-step.html#cb49-54" aria-hidden="true" tabindex="-1"></a>      sigmainv <span class="sc">%*%</span> <span class="fu">colSums</span>(multmat)</span>
<span id="cb49-55"><a href="m-step.html#cb49-55" aria-hidden="true" tabindex="-1"></a>    }))</span>
<span id="cb49-56"><a href="m-step.html#cb49-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-57"><a href="m-step.html#cb49-57" aria-hidden="true" tabindex="-1"></a>  resp_sum <span class="ot">&lt;-</span> <span class="fu">lapply</span>(resp, sum)</span>
<span id="cb49-58"><a href="m-step.html#cb49-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-59"><a href="m-step.html#cb49-59" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(iter <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>niter){</span>
<span id="cb49-60"><a href="m-step.html#cb49-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-61"><a href="m-step.html#cb49-61" aria-hidden="true" tabindex="-1"></a>    syl_C <span class="ot">&lt;-</span> <a href='m-step.html#get_C_mat'>get_C_mat</a>(<span class="at">C1 =</span> C1, <span class="at">resp_sum =</span> resp_sum, <span class="at">TT =</span> TT, <span class="at">d =</span> dimdat,</span>
<span id="cb49-62"><a href="m-step.html#cb49-62" aria-hidden="true" tabindex="-1"></a>                       <span class="at">Sigma_inv =</span> sigmainv, <span class="at">N =</span> N, <span class="at">Dlm1 =</span> Dlm1, <span class="at">rho =</span> rho,</span>
<span id="cb49-63"><a href="m-step.html#cb49-63" aria-hidden="true" tabindex="-1"></a>                       <span class="at">z =</span> z, <span class="at">w =</span> w, <span class="at">uz =</span> uz, <span class="at">uw =</span> uw)</span>
<span id="cb49-64"><a href="m-step.html#cb49-64" aria-hidden="true" tabindex="-1"></a>    FF <span class="ot">=</span>  (<span class="sc">-</span><span class="dv">1</span>) <span class="sc">*</span> tUA <span class="sc">%*%</span> syl_C <span class="sc">%*%</span> UB</span>
<span id="cb49-65"><a href="m-step.html#cb49-65" aria-hidden="true" tabindex="-1"></a>    mu <span class="ot">=</span> UA <span class="sc">%*%</span> <span class="fu">matrix_function_solve_triangular_sylvester_barebonesC2</span>(TA, TB, FF) <span class="sc">%*%</span> tUB</span>
<span id="cb49-66"><a href="m-step.html#cb49-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">#mu = -1 *  matrix_function_solve_triangular_sylvester_barebones(schurA$orig, schurB$orig, syl_C)</span></span>
<span id="cb49-67"><a href="m-step.html#cb49-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-68"><a href="m-step.html#cb49-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(warmstart <span class="sc">&amp;</span> iter <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb49-69"><a href="m-step.html#cb49-69" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(<span class="st">&quot;warmed up mu!&quot;</span>)</span>
<span id="cb49-70"><a href="m-step.html#cb49-70" aria-hidden="true" tabindex="-1"></a>      mu <span class="ot">=</span> mu.warm</span>
<span id="cb49-71"><a href="m-step.html#cb49-71" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb49-72"><a href="m-step.html#cb49-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-73"><a href="m-step.html#cb49-73" aria-hidden="true" tabindex="-1"></a>    <span class="co">#z &lt;- <a href='m-step.html#Z_update'>Z_update</a>( scale(t(mu), scale = F), Uz = uz, C = maxdev, rho = rho)</span></span>
<span id="cb49-74"><a href="m-step.html#cb49-74" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> <a href='m-step.html#Z_update'>Z_update</a>( <span class="fu">t</span>(mu <span class="sc">-</span> <span class="fu">rowMeans</span>(mu)), <span class="at">Uz =</span> uz, <span class="at">C =</span> maxdev, <span class="at">rho =</span> rho)</span>
<span id="cb49-75"><a href="m-step.html#cb49-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-76"><a href="m-step.html#cb49-76" aria-hidden="true" tabindex="-1"></a>    wlist <span class="ot">=</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>dimdat, <span class="cf">function</span>(j){</span>
<span id="cb49-77"><a href="m-step.html#cb49-77" aria-hidden="true" tabindex="-1"></a>      <a href='m-step.html#W_update_fused'>W_update_fused</a>(<span class="at">lm1 =</span> l, <span class="at">TT =</span> TT, <span class="at">mu =</span> mu[j,], <span class="at">rho =</span> rho, <span class="at">lambda =</span> lambda,</span>
<span id="cb49-78"><a href="m-step.html#cb49-78" aria-hidden="true" tabindex="-1"></a>                     <span class="at">uw =</span> uw[j,])})</span>
<span id="cb49-79"><a href="m-step.html#cb49-79" aria-hidden="true" tabindex="-1"></a>    w <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, wlist)</span>
<span id="cb49-80"><a href="m-step.html#cb49-80" aria-hidden="true" tabindex="-1"></a>    uz <span class="ot">=</span> <a href='m-step.html#U_update_Z'>U_update_Z</a>(uz, rho, <span class="fu">t</span>(mu), z)</span>
<span id="cb49-81"><a href="m-step.html#cb49-81" aria-hidden="true" tabindex="-1"></a>    uw <span class="ot">=</span> <a href='m-step.html#U_update_W'>U_update_W</a>(uw, rho, mu, w, Dlm1, <span class="at">l =</span> l)</span>
<span id="cb49-82"><a href="m-step.html#cb49-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-83"><a href="m-step.html#cb49-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(norms <span class="sc">&amp;</span> iter <span class="sc">%%</span> <span class="dv">1</span> <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb49-84"><a href="m-step.html#cb49-84" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(<span class="fu">round</span>(<span class="fu">c</span>(<span class="st">&quot;mu&quot;</span> <span class="ot">=</span> <span class="fu">norm</span>(mu, <span class="st">&quot;F&quot;</span>),</span>
<span id="cb49-85"><a href="m-step.html#cb49-85" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;C&quot;</span> <span class="ot">=</span> <span class="fu">norm</span>(syl_C, <span class="st">&quot;F&quot;</span>),</span>
<span id="cb49-86"><a href="m-step.html#cb49-86" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;FF&quot;</span> <span class="ot">=</span> <span class="fu">norm</span>(FF, <span class="st">&quot;F&quot;</span>),</span>
<span id="cb49-87"><a href="m-step.html#cb49-87" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;z&quot;</span> <span class="ot">=</span> <span class="fu">norm</span>(z, <span class="st">&quot;F&quot;</span>),</span>
<span id="cb49-88"><a href="m-step.html#cb49-88" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;w&quot;</span> <span class="ot">=</span> <span class="fu">norm</span>(w, <span class="st">&quot;F&quot;</span>),</span>
<span id="cb49-89"><a href="m-step.html#cb49-89" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;uz&quot;</span> <span class="ot">=</span> <span class="fu">norm</span>(uz, <span class="st">&quot;F&quot;</span>),</span>
<span id="cb49-90"><a href="m-step.html#cb49-90" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;uw&quot;</span> <span class="ot">=</span> <span class="fu">norm</span>(uw, <span class="st">&quot;F&quot;</span>)),<span class="dv">3</span>))</span>
<span id="cb49-91"><a href="m-step.html#cb49-91" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb49-92"><a href="m-step.html#cb49-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-93"><a href="m-step.html#cb49-93" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Check convergence</span></span>
<span id="cb49-94"><a href="m-step.html#cb49-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>( iter <span class="sc">&gt;</span> <span class="dv">1</span>  <span class="sc">&amp;</span> iter <span class="sc">%%</span> <span class="dv">5</span> <span class="sc">==</span> <span class="dv">0</span>){<span class="do">## &amp; !local_adapt){</span></span>
<span id="cb49-95"><a href="m-step.html#cb49-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-96"><a href="m-step.html#cb49-96" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Calculate convergence criterion</span></span>
<span id="cb49-97"><a href="m-step.html#cb49-97" aria-hidden="true" tabindex="-1"></a>      obj <span class="ot">=</span> <a href='m-step.html#converge'>converge</a>(mu, rho,</span>
<span id="cb49-98"><a href="m-step.html#cb49-98" aria-hidden="true" tabindex="-1"></a>                     w, z,</span>
<span id="cb49-99"><a href="m-step.html#cb49-99" aria-hidden="true" tabindex="-1"></a>                     w_prev, z_prev,</span>
<span id="cb49-100"><a href="m-step.html#cb49-100" aria-hidden="true" tabindex="-1"></a>                     uw, uz,</span>
<span id="cb49-101"><a href="m-step.html#cb49-101" aria-hidden="true" tabindex="-1"></a>                     Dlm1, <span class="at">err_rel =</span> err_rel, <span class="at">err_abs =</span> err_abs)</span>
<span id="cb49-102"><a href="m-step.html#cb49-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-103"><a href="m-step.html#cb49-103" aria-hidden="true" tabindex="-1"></a>      jj <span class="ot">=</span> (iter<span class="sc">/</span> <span class="dv">5</span>)</span>
<span id="cb49-104"><a href="m-step.html#cb49-104" aria-hidden="true" tabindex="-1"></a>      resid_mat[jj,] <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">norm</span>(obj<span class="sc">$</span>primal_resid, <span class="st">&quot;F&quot;</span>),</span>
<span id="cb49-105"><a href="m-step.html#cb49-105" aria-hidden="true" tabindex="-1"></a>                         obj<span class="sc">$</span>primal_err,</span>
<span id="cb49-106"><a href="m-step.html#cb49-106" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">norm</span>(obj<span class="sc">$</span>dual_resid,<span class="st">&quot;F&quot;</span>),</span>
<span id="cb49-107"><a href="m-step.html#cb49-107" aria-hidden="true" tabindex="-1"></a>                         obj<span class="sc">$</span>dual_err)</span>
<span id="cb49-108"><a href="m-step.html#cb49-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-109"><a href="m-step.html#cb49-109" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.na</span>(obj<span class="sc">$</span>converge)){</span>
<span id="cb49-110"><a href="m-step.html#cb49-110" aria-hidden="true" tabindex="-1"></a>        obj<span class="sc">$</span>converge <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb49-111"><a href="m-step.html#cb49-111" aria-hidden="true" tabindex="-1"></a>        <span class="fu">warning</span>(<span class="st">&quot;Convergence was NA&quot;</span>)</span>
<span id="cb49-112"><a href="m-step.html#cb49-112" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb49-113"><a href="m-step.html#cb49-113" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(obj<span class="sc">$</span>converge){</span>
<span id="cb49-114"><a href="m-step.html#cb49-114" aria-hidden="true" tabindex="-1"></a>        converge <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb49-115"><a href="m-step.html#cb49-115" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb49-116"><a href="m-step.html#cb49-116" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb49-117"><a href="m-step.html#cb49-117" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb49-118"><a href="m-step.html#cb49-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-119"><a href="m-step.html#cb49-119" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ## 3. Calculate objective values for this cluster.</span></span>
<span id="cb49-120"><a href="m-step.html#cb49-120" aria-hidden="true" tabindex="-1"></a>    w_prev <span class="ot">=</span> w</span>
<span id="cb49-121"><a href="m-step.html#cb49-121" aria-hidden="true" tabindex="-1"></a>    z_prev <span class="ot">=</span> z</span>
<span id="cb49-122"><a href="m-step.html#cb49-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-123"><a href="m-step.html#cb49-123" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb49-124"><a href="m-step.html#cb49-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-125"><a href="m-step.html#cb49-125" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Gather results.</span></span>
<span id="cb49-126"><a href="m-step.html#cb49-126" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">=</span> mu</span>
<span id="cb49-127"><a href="m-step.html#cb49-127" aria-hidden="true" tabindex="-1"></a>  yhat <span class="ot">=</span> mu</span>
<span id="cb49-128"><a href="m-step.html#cb49-128" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb49-129"><a href="m-step.html#cb49-129" aria-hidden="true" tabindex="-1"></a>  fits <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb49-130"><a href="m-step.html#cb49-130" aria-hidden="true" tabindex="-1"></a>  obj.value <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb49-131"><a href="m-step.html#cb49-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-132"><a href="m-step.html#cb49-132" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(objective){</span>
<span id="cb49-133"><a href="m-step.html#cb49-133" aria-hidden="true" tabindex="-1"></a>    obj.value <span class="ot">&lt;-</span> <a href='m-step.html#obj'>obj</a>(<span class="at">y =</span> y, <span class="at">mu =</span> mu, <span class="at">resp =</span> resp, <span class="at">Sigma_inv =</span> sigmainv, <span class="at">TT =</span> TT,</span>
<span id="cb49-134"><a href="m-step.html#cb49-134" aria-hidden="true" tabindex="-1"></a>                     <span class="at">d =</span> dimdat, <span class="at">Dl =</span> Dl, <span class="at">Dlm1 =</span> Dlm1, <span class="at">l =</span> l, <span class="at">maxdev =</span> maxdev,</span>
<span id="cb49-135"><a href="m-step.html#cb49-135" aria-hidden="true" tabindex="-1"></a>                     <span class="at">lambda =</span> lambda, <span class="at">rho =</span> rho, <span class="at">N =</span> N)</span>
<span id="cb49-136"><a href="m-step.html#cb49-136" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb49-137"><a href="m-step.html#cb49-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-138"><a href="m-step.html#cb49-138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mu =</span> mu,</span>
<span id="cb49-139"><a href="m-step.html#cb49-139" aria-hidden="true" tabindex="-1"></a>              <span class="at">yhat =</span> yhat,</span>
<span id="cb49-140"><a href="m-step.html#cb49-140" aria-hidden="true" tabindex="-1"></a>              <span class="at">resid_mat =</span> resid_mat,</span>
<span id="cb49-141"><a href="m-step.html#cb49-141" aria-hidden="true" tabindex="-1"></a>              <span class="at">fits =</span> fits,</span>
<span id="cb49-142"><a href="m-step.html#cb49-142" aria-hidden="true" tabindex="-1"></a>              <span class="at">converge =</span> converge,</span>
<span id="cb49-143"><a href="m-step.html#cb49-143" aria-hidden="true" tabindex="-1"></a>              <span class="at">fit =</span> obj.value,</span>
<span id="cb49-144"><a href="m-step.html#cb49-144" aria-hidden="true" tabindex="-1"></a>              <span class="do">## Other variables to return.</span></span>
<span id="cb49-145"><a href="m-step.html#cb49-145" aria-hidden="true" tabindex="-1"></a>              <span class="at">Z =</span> z,</span>
<span id="cb49-146"><a href="m-step.html#cb49-146" aria-hidden="true" tabindex="-1"></a>              <span class="at">W =</span> w,</span>
<span id="cb49-147"><a href="m-step.html#cb49-147" aria-hidden="true" tabindex="-1"></a>              <span class="at">uz =</span> uz,</span>
<span id="cb49-148"><a href="m-step.html#cb49-148" aria-hidden="true" tabindex="-1"></a>              <span class="at">uw =</span> uw,</span>
<span id="cb49-149"><a href="m-step.html#cb49-149" aria-hidden="true" tabindex="-1"></a>              <span class="at">inner.iter =</span> iter,</span>
<span id="cb49-150"><a href="m-step.html#cb49-150" aria-hidden="true" tabindex="-1"></a>              <span class="at">objective =</span> obj.value</span>
<span id="cb49-151"><a href="m-step.html#cb49-151" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb49-152"><a href="m-step.html#cb49-152" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="helpers-for-m-step-mu" class="section level2 hasAnchor" number="8.4">
<h2><span class="header-section-number">8.4</span> Helpers for M step (<span class="math inline">\(\mu\)</span>)<a href="m-step.html#helpers-for-m-step-mu" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>First, let’s start with a few R functions.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="m-step.html#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param TT Number of time points.</span></span>
<span id="cb50-2"><a href="m-step.html#cb50-2" aria-hidden="true" tabindex="-1"></a><span id='etilde_mat'>etilde_mat</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(TT){</span>
<span id="cb50-3"><a href="m-step.html#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="m-step.html#cb50-4" aria-hidden="true" tabindex="-1"></a>  mats <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(t){</span>
<span id="cb50-5"><a href="m-step.html#cb50-5" aria-hidden="true" tabindex="-1"></a>    e_vec <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, TT)</span>
<span id="cb50-6"><a href="m-step.html#cb50-6" aria-hidden="true" tabindex="-1"></a>    e_vec[t] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb50-7"><a href="m-step.html#cb50-7" aria-hidden="true" tabindex="-1"></a>    (e_vec <span class="sc">-</span> <span class="dv">1</span><span class="sc">/</span>TT) <span class="sc">%*%</span> <span class="fu">t</span>(e_vec <span class="sc">-</span> <span class="dv">1</span><span class="sc">/</span>TT)</span>
<span id="cb50-8"><a href="m-step.html#cb50-8" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb50-9"><a href="m-step.html#cb50-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Reduce</span>(<span class="st">&#39;+&#39;</span>, mats)</span>
<span id="cb50-10"><a href="m-step.html#cb50-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb50-11"><a href="m-step.html#cb50-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-12"><a href="m-step.html#cb50-12" aria-hidden="true" tabindex="-1"></a><span id='get_AB_mats'>get_AB_mats</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(y, resp, Sigma_inv, e_mat, Dlm1sqrd, N, Dl, Dlm1, rho, z, w, uz, uw){</span>
<span id="cb50-13"><a href="m-step.html#cb50-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-14"><a href="m-step.html#cb50-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># A matrix</span></span>
<span id="cb50-15"><a href="m-step.html#cb50-15" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> Sigma_inv</span>
<span id="cb50-16"><a href="m-step.html#cb50-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-17"><a href="m-step.html#cb50-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># B matrix</span></span>
<span id="cb50-18"><a href="m-step.html#cb50-18" aria-hidden="true" tabindex="-1"></a>  sum_resp <span class="ot">&lt;-</span> <span class="fu">sapply</span>(resp, sum)</span>
<span id="cb50-19"><a href="m-step.html#cb50-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">#B &lt;- rho*(t(Dlm1)%*%Dlm1 + e_mat)%*% diag(1/unlist(sum_resp))</span></span>
<span id="cb50-20"><a href="m-step.html#cb50-20" aria-hidden="true" tabindex="-1"></a>  B <span class="ot">&lt;-</span> rho<span class="sc">*</span>(Dlm1sqrd <span class="sc">+</span> e_mat)</span>
<span id="cb50-21"><a href="m-step.html#cb50-21" aria-hidden="true" tabindex="-1"></a>  B <span class="ot">&lt;-</span> B<span class="sc">/</span>sum_resp[<span class="fu">col</span>(B)]</span>
<span id="cb50-22"><a href="m-step.html#cb50-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">#B &lt;- rho*(Dlm1sqrd + e_mat)  %*% diag(1/unlist(sum_resp))</span></span>
<span id="cb50-23"><a href="m-step.html#cb50-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-24"><a href="m-step.html#cb50-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">A =</span> A, <span class="at">B =</span> B))</span>
<span id="cb50-25"><a href="m-step.html#cb50-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb50-26"><a href="m-step.html#cb50-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-27"><a href="m-step.html#cb50-27" aria-hidden="true" tabindex="-1"></a><span id='get_C_mat'>get_C_mat</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(C1, resp_sum, TT, d, Sigma_inv, e_mat, N, Dl, Dlm1, rho, z, w, uz, uw){</span>
<span id="cb50-28"><a href="m-step.html#cb50-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-29"><a href="m-step.html#cb50-29" aria-hidden="true" tabindex="-1"></a>  C2 <span class="ot">&lt;-</span> <span class="fu">t</span>(uz <span class="sc">-</span> rho<span class="sc">*</span>z)</span>
<span id="cb50-30"><a href="m-step.html#cb50-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-31"><a href="m-step.html#cb50-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># averaging</span></span>
<span id="cb50-32"><a href="m-step.html#cb50-32" aria-hidden="true" tabindex="-1"></a>  C2 <span class="ot">&lt;-</span> C2 <span class="sc">-</span> <span class="fu">rowMeans</span>(C2)</span>
<span id="cb50-33"><a href="m-step.html#cb50-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-34"><a href="m-step.html#cb50-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># third component</span></span>
<span id="cb50-35"><a href="m-step.html#cb50-35" aria-hidden="true" tabindex="-1"></a>  C3 <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>d, <span class="at">FUN =</span> <span class="cf">function</span>(j){</span>
<span id="cb50-36"><a href="m-step.html#cb50-36" aria-hidden="true" tabindex="-1"></a>    (uw[j,] <span class="sc">-</span> rho<span class="sc">*</span>w[j,]) <span class="sc">%*%</span> Dlm1</span>
<span id="cb50-37"><a href="m-step.html#cb50-37" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb50-38"><a href="m-step.html#cb50-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-39"><a href="m-step.html#cb50-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># combining</span></span>
<span id="cb50-40"><a href="m-step.html#cb50-40" aria-hidden="true" tabindex="-1"></a>  C <span class="ot">&lt;-</span>  (<span class="sc">-</span><span class="dv">1</span><span class="sc">/</span>N<span class="sc">*</span>C1 <span class="sc">+</span> C2 <span class="sc">+</span> C3)</span>
<span id="cb50-41"><a href="m-step.html#cb50-41" aria-hidden="true" tabindex="-1"></a>  C <span class="ot">&lt;-</span> C<span class="sc">/</span><span class="fu">unlist</span>(resp_sum)[<span class="fu">col</span>(C)]</span>
<span id="cb50-42"><a href="m-step.html#cb50-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-43"><a href="m-step.html#cb50-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(C)</span>
<span id="cb50-44"><a href="m-step.html#cb50-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb50-45"><a href="m-step.html#cb50-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-46"><a href="m-step.html#cb50-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-47"><a href="m-step.html#cb50-47" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param mat Matrix to Schur-decompose.</span></span>
<span id="cb50-48"><a href="m-step.html#cb50-48" aria-hidden="true" tabindex="-1"></a><span id='myschur'>myschur</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(mat){</span>
<span id="cb50-49"><a href="m-step.html#cb50-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(mat) <span class="sc">==</span> <span class="fu">ncol</span>(mat))</span>
<span id="cb50-50"><a href="m-step.html#cb50-50" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.numeric</span>(mat) <span class="sc">&amp;</span> <span class="fu">length</span>(mat)<span class="sc">==</span><span class="dv">1</span>) mat <span class="ot">=</span> mat <span class="sc">%&gt;%</span> <span class="fu">as.matrix</span>()</span>
<span id="cb50-51"><a href="m-step.html#cb50-51" aria-hidden="true" tabindex="-1"></a>  obj <span class="ot">=</span> Matrix<span class="sc">::</span><span class="fu">Schur</span>(mat)</span>
<span id="cb50-52"><a href="m-step.html#cb50-52" aria-hidden="true" tabindex="-1"></a>  obj<span class="sc">$</span>tQ <span class="ot">=</span> <span class="fu">t</span>(obj<span class="sc">$</span>Q)</span>
<span id="cb50-53"><a href="m-step.html#cb50-53" aria-hidden="true" tabindex="-1"></a>  obj<span class="sc">$</span>orig <span class="ot">=</span> mat</span>
<span id="cb50-54"><a href="m-step.html#cb50-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(obj)</span>
<span id="cb50-55"><a href="m-step.html#cb50-55" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Here’s a function to check convergence of the ADMM with a fixed step size.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="m-step.html#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Check convergence of ADMM with a fixed step size (rho).</span></span>
<span id="cb51-2"><a href="m-step.html#cb51-2" aria-hidden="true" tabindex="-1"></a><span id='converge'>converge</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(mu, rho, w, z, w_prev, z_prev, uw, uz, Dlm1,</span>
<span id="cb51-3"><a href="m-step.html#cb51-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">err_rel =</span> <span class="fl">1E-4</span>,</span>
<span id="cb51-4"><a href="m-step.html#cb51-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">err_abs =</span> <span class="dv">0</span></span>
<span id="cb51-5"><a href="m-step.html#cb51-5" aria-hidden="true" tabindex="-1"></a>){</span>
<span id="cb51-6"><a href="m-step.html#cb51-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-7"><a href="m-step.html#cb51-7" aria-hidden="true" tabindex="-1"></a>  prim1 <span class="ot">=</span> <span class="fu">rbind</span>(<span class="fu">t</span>(mu <span class="sc">-</span> <span class="fu">rowMeans</span>(mu)), Dlm1 <span class="sc">%*%</span> <span class="fu">t</span>(mu))</span>
<span id="cb51-8"><a href="m-step.html#cb51-8" aria-hidden="true" tabindex="-1"></a>  prim2 <span class="ot">=</span> <span class="fu">rbind</span>(z, <span class="fu">t</span>(w))</span>
<span id="cb51-9"><a href="m-step.html#cb51-9" aria-hidden="true" tabindex="-1"></a>  primal_resid <span class="ot">=</span> prim1 <span class="sc">-</span> prim2</span>
<span id="cb51-10"><a href="m-step.html#cb51-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-11"><a href="m-step.html#cb51-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-12"><a href="m-step.html#cb51-12" aria-hidden="true" tabindex="-1"></a>  dual_resid <span class="ot">=</span> <span class="sc">-</span>rho <span class="sc">*</span> <span class="fu">rbind</span>((z<span class="sc">-</span>z_prev <span class="sc">-</span> <span class="fu">colMeans</span>(z<span class="sc">-</span>z_prev)), <span class="fu">t</span>(Dlm1) <span class="sc">%*%</span> <span class="fu">t</span>(w <span class="sc">-</span> w_prev))</span>
<span id="cb51-13"><a href="m-step.html#cb51-13" aria-hidden="true" tabindex="-1"></a>  tAU <span class="ot">=</span> <span class="fu">rbind</span>(uz, <span class="sc">-</span><span class="fu">t</span>(uw))</span>
<span id="cb51-14"><a href="m-step.html#cb51-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-15"><a href="m-step.html#cb51-15" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Form primal and dual tolerances.</span></span>
<span id="cb51-16"><a href="m-step.html#cb51-16" aria-hidden="true" tabindex="-1"></a>  primal_err <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="fu">length</span>(primal_resid)) <span class="sc">*</span> err_abs <span class="sc">+</span></span>
<span id="cb51-17"><a href="m-step.html#cb51-17" aria-hidden="true" tabindex="-1"></a>    err_rel <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">norm</span>(prim1, <span class="st">&quot;F&quot;</span>), <span class="fu">norm</span>(prim2, <span class="st">&quot;F&quot;</span>))</span>
<span id="cb51-18"><a href="m-step.html#cb51-18" aria-hidden="true" tabindex="-1"></a>  dual_err <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="fu">length</span>(dual_resid)) <span class="sc">*</span> err_abs <span class="sc">+</span></span>
<span id="cb51-19"><a href="m-step.html#cb51-19" aria-hidden="true" tabindex="-1"></a>    err_rel <span class="sc">*</span> <span class="fu">norm</span>(tAU, <span class="st">&quot;F&quot;</span>)</span>
<span id="cb51-20"><a href="m-step.html#cb51-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-21"><a href="m-step.html#cb51-21" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Check convergence.</span></span>
<span id="cb51-22"><a href="m-step.html#cb51-22" aria-hidden="true" tabindex="-1"></a>  primal_resid_size <span class="ot">=</span> <span class="fu">norm</span>(primal_resid, <span class="st">&quot;F&quot;</span>)</span>
<span id="cb51-23"><a href="m-step.html#cb51-23" aria-hidden="true" tabindex="-1"></a>  dual_resid_size <span class="ot">=</span> <span class="fu">norm</span>(dual_resid, <span class="st">&quot;F&quot;</span>)</span>
<span id="cb51-24"><a href="m-step.html#cb51-24" aria-hidden="true" tabindex="-1"></a>  primal_converge <span class="ot">=</span> ( primal_resid_size  <span class="sc">&lt;=</span> primal_err )</span>
<span id="cb51-25"><a href="m-step.html#cb51-25" aria-hidden="true" tabindex="-1"></a>  dual_converge <span class="ot">=</span> ( dual_resid_size <span class="sc">&lt;=</span> dual_err )</span>
<span id="cb51-26"><a href="m-step.html#cb51-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-27"><a href="m-step.html#cb51-27" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Some checks (trying to address problems with |converge|).</span></span>
<span id="cb51-28"><a href="m-step.html#cb51-28" aria-hidden="true" tabindex="-1"></a>  assertthat<span class="sc">::</span><span class="fu">assert_that</span>(<span class="fu">is.numeric</span>(primal_resid_size))</span>
<span id="cb51-29"><a href="m-step.html#cb51-29" aria-hidden="true" tabindex="-1"></a>  assertthat<span class="sc">::</span><span class="fu">assert_that</span>(<span class="fu">is.numeric</span>(primal_err))</span>
<span id="cb51-30"><a href="m-step.html#cb51-30" aria-hidden="true" tabindex="-1"></a>  assertthat<span class="sc">::</span><span class="fu">assert_that</span>(<span class="fu">is.numeric</span>(dual_resid_size))</span>
<span id="cb51-31"><a href="m-step.html#cb51-31" aria-hidden="true" tabindex="-1"></a>  assertthat<span class="sc">::</span><span class="fu">assert_that</span>(<span class="fu">is.numeric</span>(dual_err))</span>
<span id="cb51-32"><a href="m-step.html#cb51-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-33"><a href="m-step.html#cb51-33" aria-hidden="true" tabindex="-1"></a>  <span class="do">## return(primal_converge &amp; dual_converge)</span></span>
<span id="cb51-34"><a href="m-step.html#cb51-34" aria-hidden="true" tabindex="-1"></a>  converge <span class="ot">=</span> primal_converge <span class="sc">&amp;</span> dual_converge</span>
<span id="cb51-35"><a href="m-step.html#cb51-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-36"><a href="m-step.html#cb51-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">primal_resid =</span> primal_resid,</span>
<span id="cb51-37"><a href="m-step.html#cb51-37" aria-hidden="true" tabindex="-1"></a>              <span class="at">primal_err =</span> primal_err,</span>
<span id="cb51-38"><a href="m-step.html#cb51-38" aria-hidden="true" tabindex="-1"></a>              <span class="at">dual_resid =</span> dual_resid,</span>
<span id="cb51-39"><a href="m-step.html#cb51-39" aria-hidden="true" tabindex="-1"></a>              <span class="at">dual_err =</span> dual_err,</span>
<span id="cb51-40"><a href="m-step.html#cb51-40" aria-hidden="true" tabindex="-1"></a>              <span class="at">converge =</span> converge))</span>
<span id="cb51-41"><a href="m-step.html#cb51-41" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Here’s a function to compute the augmented Lagrangian.
[TODO: write the augmented Lagrangian here]</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="m-step.html#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; computes the Augmented lagrangian.</span></span>
<span id="cb52-2"><a href="m-step.html#cb52-2" aria-hidden="true" tabindex="-1"></a><span id='aug_lagr'>aug_lagr</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(y, TT, d, z, w, l, uz, uw, mu, resp, Sigma_inv, Dl, Dlm1, maxdev, lambda, rho, N){</span>
<span id="cb52-3"><a href="m-step.html#cb52-3" aria-hidden="true" tabindex="-1"></a>  mu_dd <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(mu)</span>
<span id="cb52-4"><a href="m-step.html#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="m-step.html#cb52-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check the Z&#39;s for ball constraint, up to a tolerance of 1e-4</span></span>
<span id="cb52-6"><a href="m-step.html#cb52-6" aria-hidden="true" tabindex="-1"></a>  znorms <span class="ot">&lt;-</span> <span class="fu">apply</span>(z, <span class="at">FUN =</span> <span class="cf">function</span>(zz) <span class="fu">sqrt</span>(<span class="fu">sum</span>(zz<span class="sc">^</span><span class="dv">2</span>)), <span class="at">MARGIN =</span> <span class="dv">1</span>)</span>
<span id="cb52-7"><a href="m-step.html#cb52-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.na</span>(znorms))) <span class="fu">browser</span>()</span>
<span id="cb52-8"><a href="m-step.html#cb52-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(znorms <span class="sc">&gt;</span> (maxdev <span class="sc">+</span> <span class="fl">1e-4</span>))){</span>
<span id="cb52-9"><a href="m-step.html#cb52-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">&quot;||z||_2 &gt; maxdev, current iterate not feasible.&quot;</span>)</span>
<span id="cb52-10"><a href="m-step.html#cb52-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">Inf</span>)</span>
<span id="cb52-11"><a href="m-step.html#cb52-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb52-12"><a href="m-step.html#cb52-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-13"><a href="m-step.html#cb52-13" aria-hidden="true" tabindex="-1"></a>  aug1 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">do.call</span>(cbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(t){</span>
<span id="cb52-14"><a href="m-step.html#cb52-14" aria-hidden="true" tabindex="-1"></a>    multmat <span class="ot">&lt;-</span> <span class="fu">apply</span>(y[[t]], <span class="at">FUN =</span> <span class="cf">function</span>(yy){</span>
<span id="cb52-15"><a href="m-step.html#cb52-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">t</span>(yy <span class="sc">-</span> mu[,t]) <span class="sc">%*%</span> Sigma_inv <span class="sc">%*%</span> (yy <span class="sc">-</span> mu[,t])}, <span class="at">MARGIN =</span> <span class="dv">1</span>)</span>
<span id="cb52-16"><a href="m-step.html#cb52-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="dv">1</span><span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>N) <span class="sc">*</span> resp[[t]]<span class="sc">*</span>multmat)</span>
<span id="cb52-17"><a href="m-step.html#cb52-17" aria-hidden="true" tabindex="-1"></a>  })))</span>
<span id="cb52-18"><a href="m-step.html#cb52-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-19"><a href="m-step.html#cb52-19" aria-hidden="true" tabindex="-1"></a>  aug2 <span class="ot">&lt;-</span> lambda<span class="sc">*</span><span class="fu">sum</span>(<span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>d, <span class="at">FUN =</span> <span class="cf">function</span>(j)</span>
<span id="cb52-20"><a href="m-step.html#cb52-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="fu">abs</span>(<span class="fu">diff</span>(w[j,], <span class="at">differences =</span> <span class="dv">1</span>))))))</span>
<span id="cb52-21"><a href="m-step.html#cb52-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-22"><a href="m-step.html#cb52-22" aria-hidden="true" tabindex="-1"></a>  aug3 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">do.call</span>(cbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(t){</span>
<span id="cb52-23"><a href="m-step.html#cb52-23" aria-hidden="true" tabindex="-1"></a>    uz[t,]<span class="sc">%*%</span>(mu[,t] <span class="sc">-</span> mu_dd <span class="sc">-</span> z[t,]) <span class="sc">+</span> rho<span class="sc">/</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">sum</span>((mu[,t] <span class="sc">-</span> mu_dd <span class="sc">-</span> z[t,])<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb52-24"><a href="m-step.html#cb52-24" aria-hidden="true" tabindex="-1"></a>  })))</span>
<span id="cb52-25"><a href="m-step.html#cb52-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-26"><a href="m-step.html#cb52-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-27"><a href="m-step.html#cb52-27" aria-hidden="true" tabindex="-1"></a>  aug4 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>d, <span class="at">FUN =</span> <span class="cf">function</span>(j){</span>
<span id="cb52-28"><a href="m-step.html#cb52-28" aria-hidden="true" tabindex="-1"></a>    uw[j,] <span class="sc">%*%</span> (Dlm1 <span class="sc">%*%</span> mu[j,]  <span class="sc">-</span> w[j,]) <span class="sc">+</span> rho<span class="sc">/</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">sum</span>((Dlm1 <span class="sc">%*%</span> mu[j,] <span class="sc">-</span> w[j,])<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb52-29"><a href="m-step.html#cb52-29" aria-hidden="true" tabindex="-1"></a>  })))</span>
<span id="cb52-30"><a href="m-step.html#cb52-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-31"><a href="m-step.html#cb52-31" aria-hidden="true" tabindex="-1"></a>  total <span class="ot">&lt;-</span> aug1 <span class="sc">+</span> aug2 <span class="sc">+</span> aug3 <span class="sc">+</span> aug4</span>
<span id="cb52-32"><a href="m-step.html#cb52-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-33"><a href="m-step.html#cb52-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(total)</span>
<span id="cb52-34"><a href="m-step.html#cb52-34" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Here’s a function to calculate the ADMM objective.</p>
<p>[TODO: write the admm objective here]</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="m-step.html#cb53-1" aria-hidden="true" tabindex="-1"></a><span id='obj'>obj</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(y, TT, d, l, mu, resp, Sigma_inv, Dl, Dlm1, maxdev, lambda, rho, N){</span>
<span id="cb53-2"><a href="m-step.html#cb53-2" aria-hidden="true" tabindex="-1"></a>  mu_dd <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(mu)</span>
<span id="cb53-3"><a href="m-step.html#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="m-step.html#cb53-4" aria-hidden="true" tabindex="-1"></a>  aug1 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">do.call</span>(cbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(t){</span>
<span id="cb53-5"><a href="m-step.html#cb53-5" aria-hidden="true" tabindex="-1"></a>    multmat <span class="ot">&lt;-</span> <span class="fu">apply</span>(y[[t]], <span class="at">FUN =</span> <span class="cf">function</span>(yy){</span>
<span id="cb53-6"><a href="m-step.html#cb53-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">t</span>(yy <span class="sc">-</span> mu[,t]) <span class="sc">%*%</span> Sigma_inv <span class="sc">%*%</span> (yy <span class="sc">-</span> mu[,t])}, <span class="at">MARGIN =</span> <span class="dv">1</span>)</span>
<span id="cb53-7"><a href="m-step.html#cb53-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="dv">1</span><span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>N) <span class="sc">*</span> resp[[t]]<span class="sc">*</span>multmat)</span>
<span id="cb53-8"><a href="m-step.html#cb53-8" aria-hidden="true" tabindex="-1"></a>  })))</span>
<span id="cb53-9"><a href="m-step.html#cb53-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-10"><a href="m-step.html#cb53-10" aria-hidden="true" tabindex="-1"></a>  aug2 <span class="ot">&lt;-</span> lambda<span class="sc">*</span><span class="fu">sum</span>(<span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>d, <span class="at">FUN =</span> <span class="cf">function</span>(j)</span>
<span id="cb53-11"><a href="m-step.html#cb53-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="fu">abs</span>(<span class="fu">diff</span>(mu[j,], <span class="at">differences =</span> l))))))</span>
<span id="cb53-12"><a href="m-step.html#cb53-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-13"><a href="m-step.html#cb53-13" aria-hidden="true" tabindex="-1"></a>  total <span class="ot">&lt;-</span> aug1 <span class="sc">+</span> aug2</span>
<span id="cb53-14"><a href="m-step.html#cb53-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-15"><a href="m-step.html#cb53-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(total)</span>
<span id="cb53-16"><a href="m-step.html#cb53-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="all-rcpp-functions" class="section level2 hasAnchor" number="8.5">
<h2><span class="header-section-number">8.5</span> All Rcpp functions<a href="m-step.html#all-rcpp-functions" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The main function we write in Rcpp is the “barebones” Sylvester equation solver
that takes upper-triangular coefficient matrices.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb54-1"><a href="m-step.html#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::depends(RcppArmadillo)]]</span></span>
<span id="cb54-2"><a href="m-step.html#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::depends(RcppEigen)]]</span></span>
<span id="cb54-3"><a href="m-step.html#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;RcppArmadillo.h&gt;</span></span>
<span id="cb54-4"><a href="m-step.html#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;RcppEigen.h&gt;</span></span>
<span id="cb54-5"><a href="m-step.html#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;numeric&gt;</span></span>
<span id="cb54-6"><a href="m-step.html#cb54-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-7"><a href="m-step.html#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> arma<span class="op">;</span></span>
<span id="cb54-8"><a href="m-step.html#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Eigen<span class="op">;</span></span>
<span id="cb54-9"><a href="m-step.html#cb54-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-10"><a href="m-step.html#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> Eigen<span class="op">::</span>Map<span class="op">;</span>                       <span class="co">// &#39;maps&#39; rather than copies</span></span>
<span id="cb54-11"><a href="m-step.html#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> Eigen<span class="op">::</span>MatrixXd<span class="op">;</span>                  <span class="co">// variable size matrix, double precision</span></span>
<span id="cb54-12"><a href="m-step.html#cb54-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-13"><a href="m-step.html#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="co">//&#39; Solve &quot;barebones&quot; sylvester equation that takes upper triangular matrices as coefficients.</span></span>
<span id="cb54-14"><a href="m-step.html#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="co">//&#39; </span></span>
<span id="cb54-15"><a href="m-step.html#cb54-15" aria-hidden="true" tabindex="-1"></a><span class="co">//&#39; @param TA Upper-triangular matrix</span></span>
<span id="cb54-16"><a href="m-step.html#cb54-16" aria-hidden="true" tabindex="-1"></a><span class="co">//&#39; @param TB Upper-triangular matrix</span></span>
<span id="cb54-17"><a href="m-step.html#cb54-17" aria-hidden="true" tabindex="-1"></a><span class="co">//&#39; @param C matrix</span></span>
<span id="cb54-18"><a href="m-step.html#cb54-18" aria-hidden="true" tabindex="-1"></a><span class="co">//&#39; @export</span></span>
<span id="cb54-19"><a href="m-step.html#cb54-19" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb54-20"><a href="m-step.html#cb54-20" aria-hidden="true" tabindex="-1"></a>Eigen<span class="op">::</span>MatrixXd matrix_function_solve_triangular_sylvester_barebonesC2<span class="op">(</span><span class="at">const</span> Eigen<span class="op">::</span>MatrixXd <span class="op">&amp;</span> TA<span class="op">,</span></span>
<span id="cb54-21"><a href="m-step.html#cb54-21" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">const</span> Eigen<span class="op">::</span>MatrixXd <span class="op">&amp;</span> TB<span class="op">,</span></span>
<span id="cb54-22"><a href="m-step.html#cb54-22" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">const</span> Eigen<span class="op">::</span>MatrixXd <span class="op">&amp;</span> C<span class="op">){</span></span>
<span id="cb54-23"><a href="m-step.html#cb54-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Eigen::eigen_assert(TA.rows() == TA.cols());</span></span>
<span id="cb54-24"><a href="m-step.html#cb54-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Eigen::eigen_assert(TA.Eigen::isUpperTriangular());</span></span>
<span id="cb54-25"><a href="m-step.html#cb54-25" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Eigen::eigen_assert(TB.rows() == TB.cols());</span></span>
<span id="cb54-26"><a href="m-step.html#cb54-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Eigen::eigen_assert(TB.Eigen::isUpperTriangular());</span></span>
<span id="cb54-27"><a href="m-step.html#cb54-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Eigen::eigen_assert(C.rows() == TA.rows());</span></span>
<span id="cb54-28"><a href="m-step.html#cb54-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Eigen::eigen_assert(C.cols() == TB.rows());</span></span>
<span id="cb54-29"><a href="m-step.html#cb54-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-30"><a href="m-step.html#cb54-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">// typedef typename MatrixType::Index Index;</span></span>
<span id="cb54-31"><a href="m-step.html#cb54-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">// typedef typename MatrixType::Scalar Scalar;</span></span>
<span id="cb54-32"><a href="m-step.html#cb54-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-33"><a href="m-step.html#cb54-33" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> m <span class="op">=</span> TA<span class="op">.</span>rows<span class="op">();</span></span>
<span id="cb54-34"><a href="m-step.html#cb54-34" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n <span class="op">=</span> TB<span class="op">.</span>rows<span class="op">();</span></span>
<span id="cb54-35"><a href="m-step.html#cb54-35" aria-hidden="true" tabindex="-1"></a>  Eigen<span class="op">::</span>MatrixXd X<span class="op">(</span>m<span class="op">,</span> n<span class="op">);</span></span>
<span id="cb54-36"><a href="m-step.html#cb54-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-37"><a href="m-step.html#cb54-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> m <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">;</span> <span class="op">--</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb54-38"><a href="m-step.html#cb54-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> n<span class="op">;</span> <span class="op">++</span>j<span class="op">)</span> <span class="op">{</span></span>
<span id="cb54-39"><a href="m-step.html#cb54-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-40"><a href="m-step.html#cb54-40" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Compute T_A X = \sum_{k=i+1}^m T_A_{ik} X_{kj}</span></span>
<span id="cb54-41"><a href="m-step.html#cb54-41" aria-hidden="true" tabindex="-1"></a>      <span class="dt">double</span> TAX<span class="op">;</span></span>
<span id="cb54-42"><a href="m-step.html#cb54-42" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>i <span class="op">==</span> m <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb54-43"><a href="m-step.html#cb54-43" aria-hidden="true" tabindex="-1"></a>        TAX <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb54-44"><a href="m-step.html#cb54-44" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb54-45"><a href="m-step.html#cb54-45" aria-hidden="true" tabindex="-1"></a>    MatrixXd TAXmatrix <span class="op">=</span> TA<span class="op">.</span>row<span class="op">(</span>i<span class="op">).</span>tail<span class="op">(</span>m<span class="op">-</span><span class="dv">1</span><span class="op">-</span>i<span class="op">)</span> <span class="op">*</span> X<span class="op">.</span>col<span class="op">(</span>j<span class="op">).</span>tail<span class="op">(</span>m<span class="op">-</span><span class="dv">1</span><span class="op">-</span>i<span class="op">);</span></span>
<span id="cb54-46"><a href="m-step.html#cb54-46" aria-hidden="true" tabindex="-1"></a>        TAX <span class="op">=</span> TAXmatrix<span class="op">(</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb54-47"><a href="m-step.html#cb54-47" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb54-48"><a href="m-step.html#cb54-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-49"><a href="m-step.html#cb54-49" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Compute X T_B = \sum_{k=1}^{j-1} X_{ik} T_B_{kj}</span></span>
<span id="cb54-50"><a href="m-step.html#cb54-50" aria-hidden="true" tabindex="-1"></a>      <span class="dt">double</span> XTB<span class="op">;</span></span>
<span id="cb54-51"><a href="m-step.html#cb54-51" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>j <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb54-52"><a href="m-step.html#cb54-52" aria-hidden="true" tabindex="-1"></a>        XTB <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb54-53"><a href="m-step.html#cb54-53" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb54-54"><a href="m-step.html#cb54-54" aria-hidden="true" tabindex="-1"></a>        MatrixXd XTBmatrix <span class="op">=</span> X<span class="op">.</span>row<span class="op">(</span>i<span class="op">).</span>head<span class="op">(</span>j<span class="op">)</span> <span class="op">*</span> TB<span class="op">.</span>col<span class="op">(</span>j<span class="op">).</span>head<span class="op">(</span>j<span class="op">);</span></span>
<span id="cb54-55"><a href="m-step.html#cb54-55" aria-hidden="true" tabindex="-1"></a>        XTB <span class="op">=</span> XTBmatrix<span class="op">(</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb54-56"><a href="m-step.html#cb54-56" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb54-57"><a href="m-step.html#cb54-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-58"><a href="m-step.html#cb54-58" aria-hidden="true" tabindex="-1"></a>      X<span class="op">(</span>i<span class="op">,</span>j<span class="op">)</span> <span class="op">=</span> <span class="op">(</span>C<span class="op">(</span>i<span class="op">,</span>j<span class="op">)</span> <span class="op">-</span> TAX <span class="op">-</span> XTB<span class="op">)</span> <span class="op">/</span> <span class="op">(</span>TA<span class="op">(</span>i<span class="op">,</span>i<span class="op">)</span> <span class="op">+</span> TB<span class="op">(</span>j<span class="op">,</span>j<span class="op">));</span></span>
<span id="cb54-59"><a href="m-step.html#cb54-59" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb54-60"><a href="m-step.html#cb54-60" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb54-61"><a href="m-step.html#cb54-61" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> X<span class="op">;</span></span>
<span id="cb54-62"><a href="m-step.html#cb54-62" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Also, we define a faster <code>dmvnorm</code> function written in C++.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb55-1"><a href="m-step.html#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::depends(RcppArmadillo)]]</span></span>
<span id="cb55-2"><a href="m-step.html#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;RcppArmadillo.h&gt;</span></span>
<span id="cb55-3"><a href="m-step.html#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="m-step.html#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> <span class="dt">double</span> <span class="at">const</span> log2pi <span class="op">=</span> <span class="bu">std::</span>log<span class="op">(</span><span class="fl">2.0</span> <span class="op">*</span> M_PI<span class="op">);</span></span>
<span id="cb55-5"><a href="m-step.html#cb55-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-6"><a href="m-step.html#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="co">/* C++ version of the dtrmv BLAS function */</span></span>
<span id="cb55-7"><a href="m-step.html#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> inplace_tri_mat_mult<span class="op">(</span>arma<span class="op">::</span>rowvec <span class="op">&amp;</span>x<span class="op">,</span> arma<span class="op">::</span>mat <span class="at">const</span> <span class="op">&amp;</span>trimat<span class="op">){</span></span>
<span id="cb55-8"><a href="m-step.html#cb55-8" aria-hidden="true" tabindex="-1"></a>  arma<span class="op">::</span>uword <span class="at">const</span> n <span class="op">=</span> trimat<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb55-9"><a href="m-step.html#cb55-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-10"><a href="m-step.html#cb55-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">unsigned</span> j <span class="op">=</span> n<span class="op">;</span> j<span class="op">--</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">;){</span></span>
<span id="cb55-11"><a href="m-step.html#cb55-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> tmp<span class="op">(</span><span class="fl">0.</span><span class="op">);</span></span>
<span id="cb55-12"><a href="m-step.html#cb55-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">unsigned</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;=</span> j<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span></span>
<span id="cb55-13"><a href="m-step.html#cb55-13" aria-hidden="true" tabindex="-1"></a>      tmp <span class="op">+=</span> trimat<span class="op">.</span>at<span class="op">(</span>i<span class="op">,</span> j<span class="op">)</span> <span class="op">*</span> x<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb55-14"><a href="m-step.html#cb55-14" aria-hidden="true" tabindex="-1"></a>    x<span class="op">[</span>j<span class="op">]</span> <span class="op">=</span> tmp<span class="op">;</span></span>
<span id="cb55-15"><a href="m-step.html#cb55-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb55-16"><a href="m-step.html#cb55-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb55-17"><a href="m-step.html#cb55-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-18"><a href="m-step.html#cb55-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-19"><a href="m-step.html#cb55-19" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb55-20"><a href="m-step.html#cb55-20" aria-hidden="true" tabindex="-1"></a>arma<span class="op">::</span>vec dmvnorm_arma_fast<span class="op">(</span>arma<span class="op">::</span>mat <span class="at">const</span> <span class="op">&amp;</span>x<span class="op">,</span></span>
<span id="cb55-21"><a href="m-step.html#cb55-21" aria-hidden="true" tabindex="-1"></a>                           arma<span class="op">::</span>rowvec <span class="at">const</span> <span class="op">&amp;</span>mean<span class="op">,</span></span>
<span id="cb55-22"><a href="m-step.html#cb55-22" aria-hidden="true" tabindex="-1"></a>                           arma<span class="op">::</span>mat <span class="at">const</span> <span class="op">&amp;</span>sigma<span class="op">,</span></span>
<span id="cb55-23"><a href="m-step.html#cb55-23" aria-hidden="true" tabindex="-1"></a>                           <span class="dt">bool</span> <span class="at">const</span> logd <span class="op">=</span> <span class="kw">false</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb55-24"><a href="m-step.html#cb55-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> arma<span class="op">::</span>uword<span class="op">;</span></span>
<span id="cb55-25"><a href="m-step.html#cb55-25" aria-hidden="true" tabindex="-1"></a>    uword <span class="at">const</span> n <span class="op">=</span> x<span class="op">.</span>n_rows<span class="op">,</span></span>
<span id="cb55-26"><a href="m-step.html#cb55-26" aria-hidden="true" tabindex="-1"></a>             xdim <span class="op">=</span> x<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb55-27"><a href="m-step.html#cb55-27" aria-hidden="true" tabindex="-1"></a>    arma<span class="op">::</span>vec out<span class="op">(</span>n<span class="op">);</span></span>
<span id="cb55-28"><a href="m-step.html#cb55-28" aria-hidden="true" tabindex="-1"></a>    arma<span class="op">::</span>mat <span class="at">const</span> rooti <span class="op">=</span> arma<span class="op">::</span>inv<span class="op">(</span>trimatu<span class="op">(</span>arma<span class="op">::</span>chol<span class="op">(</span>sigma<span class="op">)));</span></span>
<span id="cb55-29"><a href="m-step.html#cb55-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> <span class="at">const</span> rootisum <span class="op">=</span> arma<span class="op">::</span>sum<span class="op">(</span>log<span class="op">(</span>rooti<span class="op">.</span>diag<span class="op">())),</span></span>
<span id="cb55-30"><a href="m-step.html#cb55-30" aria-hidden="true" tabindex="-1"></a>                constants <span class="op">=</span> <span class="op">-(</span><span class="dt">double</span><span class="op">)</span>xdim<span class="op">/</span><span class="fl">2.0</span> <span class="op">*</span> log2pi<span class="op">,</span></span>
<span id="cb55-31"><a href="m-step.html#cb55-31" aria-hidden="true" tabindex="-1"></a>              other_terms <span class="op">=</span> rootisum <span class="op">+</span> constants<span class="op">;</span></span>
<span id="cb55-32"><a href="m-step.html#cb55-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-33"><a href="m-step.html#cb55-33" aria-hidden="true" tabindex="-1"></a>    arma<span class="op">::</span>rowvec z<span class="op">;</span></span>
<span id="cb55-34"><a href="m-step.html#cb55-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>uword i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb55-35"><a href="m-step.html#cb55-35" aria-hidden="true" tabindex="-1"></a>        z <span class="op">=</span> <span class="op">(</span>x<span class="op">.</span>row<span class="op">(</span>i<span class="op">)</span> <span class="op">-</span> mean<span class="op">);</span></span>
<span id="cb55-36"><a href="m-step.html#cb55-36" aria-hidden="true" tabindex="-1"></a>        inplace_tri_mat_mult<span class="op">(</span>z<span class="op">,</span> rooti<span class="op">);</span></span>
<span id="cb55-37"><a href="m-step.html#cb55-37" aria-hidden="true" tabindex="-1"></a>        out<span class="op">(</span>i<span class="op">)</span> <span class="op">=</span> other_terms <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> arma<span class="op">::</span>dot<span class="op">(</span>z<span class="op">,</span> z<span class="op">);</span></span>
<span id="cb55-38"><a href="m-step.html#cb55-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb55-39"><a href="m-step.html#cb55-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-40"><a href="m-step.html#cb55-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>logd<span class="op">)</span></span>
<span id="cb55-41"><a href="m-step.html#cb55-41" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> out<span class="op">;</span></span>
<span id="cb55-42"><a href="m-step.html#cb55-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> exp<span class="op">(</span>out<span class="op">);</span></span>
<span id="cb55-43"><a href="m-step.html#cb55-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb55-44"><a href="m-step.html#cb55-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-45"><a href="m-step.html#cb55-45" aria-hidden="true" tabindex="-1"></a><span class="co">// All credit goes to https://gallery.rcpp.org/articles/dmvnorm_arma/</span></span></code></pre></div>
<p>We need this blob
(from <a href="https://github.com/jacobbien/litr-project/blob/main/examples/make-an-r-package-with-armadillo/create-witharmadillo.Rmd" class="uri">https://github.com/jacobbien/litr-project/blob/main/examples/make-an-r-package-with-armadillo/create-witharmadillo.Rmd</a> ):</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="m-step.html#cb56-1" aria-hidden="true" tabindex="-1"></a>usethis<span class="sc">::</span><span class="fu">use_rcpp_armadillo</span>()</span>
<span id="cb56-2"><a href="m-step.html#cb56-2" aria-hidden="true" tabindex="-1"></a>usethis<span class="sc">::</span><span class="fu">use_rcpp_eigen</span>()</span></code></pre></div>
<pre><code>## ✔ Adding &#39;Rcpp&#39; to LinkingTo field in DESCRIPTION
## ✔ Adding &#39;Rcpp&#39; to Imports field in DESCRIPTION
## ✔ Leaving &#39;src/code.cpp&#39; unchanged
## ✔ Adding &#39;RcppArmadillo&#39; to LinkingTo field in DESCRIPTION
## ✔ Created &#39;src/Makevars&#39; and &#39;src/Makevars.win&#39; with requested compilation settings.</code></pre>
<pre><code>## ✔ Adding &#39;Rcpp&#39; to LinkingTo field in DESCRIPTION
## ✔ Adding &#39;Rcpp&#39; to Imports field in DESCRIPTION
## ✔ Leaving &#39;src/code.cpp&#39; unchanged
## ✔ Adding &#39;RcppEigen&#39; to LinkingTo field in DESCRIPTION
## ✔ Adding &#39;@import RcppEigen&#39; to &#39;R/flowtrend-package.R&#39;
## • Run `devtools::document()` to update &#39;NAMESPACE&#39;</code></pre>
</div>
<div id="ported-over-from-flowmix" class="section level2 hasAnchor" number="8.6">
<h2><span class="header-section-number">8.6</span> Ported over from flowmix<a href="m-step.html#ported-over-from-flowmix" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>There are some potentially useful computational tricks from flowmix (e.g. the
eigendecomposition of the Sigmas) that could still be useful for flowtrend. But
flowtrend’s computation is dominated by the M-step of alpha, so these gains may
not matter as much.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="m-step.html#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="do">##&#39; Helper for making list of densities. Returns list by cluster then time</span></span>
<span id="cb59-2"><a href="m-step.html#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="do">##&#39; e.g. access by \code{denslist_by_clust[[iclust]][[tt]]}</span></span>
<span id="cb59-3"><a href="m-step.html#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="do">##&#39;</span></span>
<span id="cb59-4"><a href="m-step.html#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="do">##&#39; @param ylist T-length list each containing response matrices of size (nt x</span></span>
<span id="cb59-5"><a href="m-step.html#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="do">##&#39;   3), which contains coordinates of the 3-variate particles, organized over</span></span>
<span id="cb59-6"><a href="m-step.html#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="do">##&#39;   time (T) and with (nt) particles at every time.</span></span>
<span id="cb59-7"><a href="m-step.html#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="do">##&#39; @param mu (T x dimdat x numclust) array.</span></span>
<span id="cb59-8"><a href="m-step.html#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="do">##&#39; @param dimdat dimension of data.</span></span>
<span id="cb59-9"><a href="m-step.html#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="do">##&#39; @param numclust number of clusters.</span></span>
<span id="cb59-10"><a href="m-step.html#cb59-10" aria-hidden="true" tabindex="-1"></a><span class="do">##&#39; @param TT number of time points</span></span>
<span id="cb59-11"><a href="m-step.html#cb59-11" aria-hidden="true" tabindex="-1"></a><span class="do">##&#39; @param sigma_eig_by_clust Result of running</span></span>
<span id="cb59-12"><a href="m-step.html#cb59-12" aria-hidden="true" tabindex="-1"></a><span class="do">##&#39;   \code{eigendecomp_sigma_array(sigma.list[[iter]])}.</span></span>
<span id="cb59-13"><a href="m-step.html#cb59-13" aria-hidden="true" tabindex="-1"></a><span class="do">##&#39;</span></span>
<span id="cb59-14"><a href="m-step.html#cb59-14" aria-hidden="true" tabindex="-1"></a><span class="do">##&#39; @return numclust-lengthed list of TT-lengthed.</span></span>
<span id="cb59-15"><a href="m-step.html#cb59-15" aria-hidden="true" tabindex="-1"></a><span class="do">##&#39;</span></span>
<span id="cb59-16"><a href="m-step.html#cb59-16" aria-hidden="true" tabindex="-1"></a><span id='make_denslist_eigen'>make_denslist_eigen</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(ylist, mu,</span>
<span id="cb59-17"><a href="m-step.html#cb59-17" aria-hidden="true" tabindex="-1"></a>                                TT, dimdat, numclust,</span>
<span id="cb59-18"><a href="m-step.html#cb59-18" aria-hidden="true" tabindex="-1"></a>                                sigma_eig_by_clust,</span>
<span id="cb59-19"><a href="m-step.html#cb59-19" aria-hidden="true" tabindex="-1"></a>                                countslist){ <span class="do">## Temporary</span></span>
<span id="cb59-20"><a href="m-step.html#cb59-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-21"><a href="m-step.html#cb59-21" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Basic checks</span></span>
<span id="cb59-22"><a href="m-step.html#cb59-22" aria-hidden="true" tabindex="-1"></a>  assertthat<span class="sc">::</span><span class="fu">assert_that</span>(<span class="sc">!</span><span class="fu">is.null</span>(sigma_eig_by_clust))</span>
<span id="cb59-23"><a href="m-step.html#cb59-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-24"><a href="m-step.html#cb59-24" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Calculate densities (note to self: nested for loop poses no problems)</span></span>
<span id="cb59-25"><a href="m-step.html#cb59-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>numclust, <span class="cf">function</span>(iclust){</span>
<span id="cb59-26"><a href="m-step.html#cb59-26" aria-hidden="true" tabindex="-1"></a>    mysigma_eig <span class="ot">&lt;-</span> sigma_eig_by_clust[[iclust]]</span>
<span id="cb59-27"><a href="m-step.html#cb59-27" aria-hidden="true" tabindex="-1"></a>      <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="cf">function</span>(tt){</span>
<span id="cb59-28"><a href="m-step.html#cb59-28" aria-hidden="true" tabindex="-1"></a>        <span class="do">## return(dmvnorm_fast(ylist[[tt]],</span></span>
<span id="cb59-29"><a href="m-step.html#cb59-29" aria-hidden="true" tabindex="-1"></a>        <span class="do">##                     mu[tt,,iclust],</span></span>
<span id="cb59-30"><a href="m-step.html#cb59-30" aria-hidden="true" tabindex="-1"></a>        <span class="do">##                     sigma_eig=mysigma_eig))</span></span>
<span id="cb59-31"><a href="m-step.html#cb59-31" aria-hidden="true" tabindex="-1"></a>        mn <span class="ot">=</span> mu[tt,,iclust]</span>
<span id="cb59-32"><a href="m-step.html#cb59-32" aria-hidden="true" tabindex="-1"></a>        sgm <span class="ot">=</span> mysigma_eig<span class="sc">$</span>sigma</span>
<span id="cb59-33"><a href="m-step.html#cb59-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(dimdat <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb59-34"><a href="m-step.html#cb59-34" aria-hidden="true" tabindex="-1"></a>          mn <span class="ot">=</span> <span class="fu">as.matrix</span>(mn)</span>
<span id="cb59-35"><a href="m-step.html#cb59-35" aria-hidden="true" tabindex="-1"></a>          sgm <span class="ot">=</span> sgm <span class="sc">%&gt;%</span> <span class="fu">as.matrix</span>()</span>
<span id="cb59-36"><a href="m-step.html#cb59-36" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb59-37"><a href="m-step.html#cb59-37" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">dmvnorm_arma_fast</span>(ylist[[tt]],</span>
<span id="cb59-38"><a href="m-step.html#cb59-38" aria-hidden="true" tabindex="-1"></a>                                 mn,</span>
<span id="cb59-39"><a href="m-step.html#cb59-39" aria-hidden="true" tabindex="-1"></a>                                 sgm))</span>
<span id="cb59-40"><a href="m-step.html#cb59-40" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb59-41"><a href="m-step.html#cb59-41" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb59-42"><a href="m-step.html#cb59-42" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb59-43"><a href="m-step.html#cb59-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-44"><a href="m-step.html#cb59-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-45"><a href="m-step.html#cb59-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; We might not use this. Legacy from flowmix.</span></span>
<span id="cb59-46"><a href="m-step.html#cb59-46" aria-hidden="true" tabindex="-1"></a><span id='weight_ylist'>weight_ylist</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(iclust, resp, resp.sum, ylist){</span>
<span id="cb59-47"><a href="m-step.html#cb59-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-48"><a href="m-step.html#cb59-48" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Setup</span></span>
<span id="cb59-49"><a href="m-step.html#cb59-49" aria-hidden="true" tabindex="-1"></a>  dimdat <span class="ot">=</span> <span class="fu">ncol</span>(ylist[[<span class="dv">1</span>]])</span>
<span id="cb59-50"><a href="m-step.html#cb59-50" aria-hidden="true" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="fu">length</span>(ylist)</span>
<span id="cb59-51"><a href="m-step.html#cb59-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-52"><a href="m-step.html#cb59-52" aria-hidden="true" tabindex="-1"></a>  <span class="do">## All weighted data</span></span>
<span id="cb59-53"><a href="m-step.html#cb59-53" aria-hidden="true" tabindex="-1"></a>  weighted_ylist <span class="ot">=</span> <span class="fu">Map</span>(<span class="cf">function</span>(myresp, y){</span>
<span id="cb59-54"><a href="m-step.html#cb59-54" aria-hidden="true" tabindex="-1"></a>    myresp[,iclust, drop <span class="ot">=</span> <span class="cn">TRUE</span>] <span class="sc">*</span> y</span>
<span id="cb59-55"><a href="m-step.html#cb59-55" aria-hidden="true" tabindex="-1"></a>  }, resp, ylist)</span>
<span id="cb59-56"><a href="m-step.html#cb59-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-57"><a href="m-step.html#cb59-57" aria-hidden="true" tabindex="-1"></a>  <span class="do">## All weighted data SUMs</span></span>
<span id="cb59-58"><a href="m-step.html#cb59-58" aria-hidden="true" tabindex="-1"></a>  weighted_ysum <span class="ot">=</span> <span class="fu">lapply</span>(weighted_ylist, colSums)</span>
<span id="cb59-59"><a href="m-step.html#cb59-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-60"><a href="m-step.html#cb59-60" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Grand mean of data</span></span>
<span id="cb59-61"><a href="m-step.html#cb59-61" aria-hidden="true" tabindex="-1"></a>  resp.sum.thisclust <span class="ot">=</span> <span class="fu">sum</span>(resp.sum[,iclust])</span>
<span id="cb59-62"><a href="m-step.html#cb59-62" aria-hidden="true" tabindex="-1"></a>  ybar <span class="ot">=</span> <span class="fu">Reduce</span>(<span class="st">&quot;+&quot;</span>, weighted_ysum) <span class="sc">/</span> resp.sum.thisclust</span>
<span id="cb59-63"><a href="m-step.html#cb59-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-64"><a href="m-step.html#cb59-64" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Centered weighted ylist</span></span>
<span id="cb59-65"><a href="m-step.html#cb59-65" aria-hidden="true" tabindex="-1"></a>  weighted_ybar <span class="ot">=</span> resp.sum[,iclust] <span class="sc">*</span> <span class="fu">matrix</span>(ybar, TT, dimdat, <span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb59-66"><a href="m-step.html#cb59-66" aria-hidden="true" tabindex="-1"></a>  ycentered <span class="ot">=</span> <span class="fu">do.call</span>(rbind, weighted_ysum) <span class="sc">-</span> weighted_ybar<span class="do">##sweep(do.call(cbind, centered_y), 1, ybar)</span></span>
<span id="cb59-67"><a href="m-step.html#cb59-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">weighted_ylist =</span> weighted_ylist,</span>
<span id="cb59-68"><a href="m-step.html#cb59-68" aria-hidden="true" tabindex="-1"></a>              <span class="at">weighted_ysum =</span> weighted_ysum,</span>
<span id="cb59-69"><a href="m-step.html#cb59-69" aria-hidden="true" tabindex="-1"></a>              <span class="at">ybar =</span> ybar,</span>
<span id="cb59-70"><a href="m-step.html#cb59-70" aria-hidden="true" tabindex="-1"></a>              <span class="at">ycentered =</span> <span class="fu">t</span>(ycentered)))</span>
<span id="cb59-71"><a href="m-step.html#cb59-71" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>TODO:
- Right now, <code>sigma_eig_by_clust</code> is not used. When speeding up the code, do
this first.
- Likewise, <code>ycentered_list</code> isn’t used, while it is clearly useful in Sigma M
step &lt;– IS IT? Revisit the actual form of it.
- Read the document and ADMM details carefully. Then, write down the appropriate
math.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="m-step.html#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Testing against \code{<a href='m-step.html#Mstep_mu'>Mstep_mu</a>()}, for ONE cluster.</span></span>
<span id="cb60-2"><a href="m-step.html#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param ylist</span></span>
<span id="cb60-3"><a href="m-step.html#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param resp</span></span>
<span id="cb60-4"><a href="m-step.html#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param lambda</span></span>
<span id="cb60-5"><a href="m-step.html#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param l</span></span>
<span id="cb60-6"><a href="m-step.html#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param Sigma_inv inverse of Sigma</span></span>
<span id="cb60-7"><a href="m-step.html#cb60-7" aria-hidden="true" tabindex="-1"></a><span id='Mstep_mu_cvxr'>Mstep_mu_cvxr</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(ylist,</span>
<span id="cb60-8"><a href="m-step.html#cb60-8" aria-hidden="true" tabindex="-1"></a>                          resp,</span>
<span id="cb60-9"><a href="m-step.html#cb60-9" aria-hidden="true" tabindex="-1"></a>                          lambda,</span>
<span id="cb60-10"><a href="m-step.html#cb60-10" aria-hidden="true" tabindex="-1"></a>                          l,</span>
<span id="cb60-11"><a href="m-step.html#cb60-11" aria-hidden="true" tabindex="-1"></a>                          Sigma_inv, </span>
<span id="cb60-12"><a href="m-step.html#cb60-12" aria-hidden="true" tabindex="-1"></a>                          <span class="at">thresh =</span> <span class="fl">1E-8</span>,</span>
<span id="cb60-13"><a href="m-step.html#cb60-13" aria-hidden="true" tabindex="-1"></a>                          <span class="at">maxdev =</span> <span class="cn">NULL</span>,</span>
<span id="cb60-14"><a href="m-step.html#cb60-14" aria-hidden="true" tabindex="-1"></a>                          dimdat,</span>
<span id="cb60-15"><a href="m-step.html#cb60-15" aria-hidden="true" tabindex="-1"></a>                          N,</span>
<span id="cb60-16"><a href="m-step.html#cb60-16" aria-hidden="true" tabindex="-1"></a>                          <span class="at">ecos_thresh =</span> <span class="fl">1E-8</span>,</span>
<span id="cb60-17"><a href="m-step.html#cb60-17" aria-hidden="true" tabindex="-1"></a>                          <span class="at">scs_eps =</span> <span class="fl">1E-5</span>){</span>
<span id="cb60-18"><a href="m-step.html#cb60-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-19"><a href="m-step.html#cb60-19" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Define dimensions</span></span>
<span id="cb60-20"><a href="m-step.html#cb60-20" aria-hidden="true" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="fu">length</span>(ylist)</span>
<span id="cb60-21"><a href="m-step.html#cb60-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-22"><a href="m-step.html#cb60-22" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Responsibility Weighted Data</span></span>
<span id="cb60-23"><a href="m-step.html#cb60-23" aria-hidden="true" tabindex="-1"></a>  ytildes <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(tt){</span>
<span id="cb60-24"><a href="m-step.html#cb60-24" aria-hidden="true" tabindex="-1"></a>    yy <span class="ot">&lt;-</span> ylist[[tt]]</span>
<span id="cb60-25"><a href="m-step.html#cb60-25" aria-hidden="true" tabindex="-1"></a>    g <span class="ot">&lt;-</span> resp[[tt]]</span>
<span id="cb60-26"><a href="m-step.html#cb60-26" aria-hidden="true" tabindex="-1"></a>    yy <span class="ot">&lt;-</span> <span class="fu">apply</span>(yy, <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x) x <span class="sc">*</span> g)</span>
<span id="cb60-27"><a href="m-step.html#cb60-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colSums</span>(yy)</span>
<span id="cb60-28"><a href="m-step.html#cb60-28" aria-hidden="true" tabindex="-1"></a>  })  <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>() <span class="sc">%&gt;%</span> <span class="fu">as.matrix</span>()</span>
<span id="cb60-29"><a href="m-step.html#cb60-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-30"><a href="m-step.html#cb60-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-31"><a href="m-step.html#cb60-31" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Auxiliary term, needed to make the objective interpretable</span></span>
<span id="cb60-32"><a href="m-step.html#cb60-32" aria-hidden="true" tabindex="-1"></a>  aux.y <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(<span class="st">&quot;+&quot;</span>, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(tt){</span>
<span id="cb60-33"><a href="m-step.html#cb60-33" aria-hidden="true" tabindex="-1"></a>    yy <span class="ot">&lt;-</span> ylist[[tt]]</span>
<span id="cb60-34"><a href="m-step.html#cb60-34" aria-hidden="true" tabindex="-1"></a>    g <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(resp[[tt]])</span>
<span id="cb60-35"><a href="m-step.html#cb60-35" aria-hidden="true" tabindex="-1"></a>    yy <span class="ot">&lt;-</span> <span class="fu">apply</span>(yy, <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x) x <span class="sc">*</span> g)</span>
<span id="cb60-36"><a href="m-step.html#cb60-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="fu">diag</span>(yy <span class="sc">%*%</span> Sigma_inv <span class="sc">%*%</span> <span class="fu">t</span>(yy)))</span>
<span id="cb60-37"><a href="m-step.html#cb60-37" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb60-38"><a href="m-step.html#cb60-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-39"><a href="m-step.html#cb60-39" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Mu, d x T matrix</span></span>
<span id="cb60-40"><a href="m-step.html#cb60-40" aria-hidden="true" tabindex="-1"></a>  mumat <span class="ot">&lt;-</span> CVXR<span class="sc">::</span><span class="fu">Variable</span>(<span class="at">cols=</span>dimdat, <span class="at">rows=</span>TT)</span>
<span id="cb60-41"><a href="m-step.html#cb60-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-42"><a href="m-step.html#cb60-42" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Summed sqrt responsibilities - needed in the objective.</span></span>
<span id="cb60-43"><a href="m-step.html#cb60-43" aria-hidden="true" tabindex="-1"></a>  resp.sum.sqrt <span class="ot">&lt;-</span> <span class="fu">lapply</span>(resp, <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">sqrt</span>(<span class="fu">sum</span>(x)))</span>
<span id="cb60-44"><a href="m-step.html#cb60-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-45"><a href="m-step.html#cb60-45" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Differencing Matrix, TT-l + 1 x TT </span></span>
<span id="cb60-46"><a href="m-step.html#cb60-46" aria-hidden="true" tabindex="-1"></a>  Dl <span class="ot">&lt;-</span> <a href='trend-filtering.html#gen_diff_mat'>gen_diff_mat</a>(<span class="at">n =</span> TT, <span class="at">l =</span> l)</span>
<span id="cb60-47"><a href="m-step.html#cb60-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-48"><a href="m-step.html#cb60-48" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Forming the objective</span></span>
<span id="cb60-49"><a href="m-step.html#cb60-49" aria-hidden="true" tabindex="-1"></a>  obj <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>N) <span class="sc">*</span>( <span class="fu">Reduce</span>(<span class="st">&quot;+&quot;</span>, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(tt) CVXR<span class="sc">::</span><span class="fu">quad_form</span>(resp.sum.sqrt[[tt]]<span class="sc">*</span>mumat[tt,], Sigma_inv))) <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">Reduce</span>(<span class="st">&quot;+&quot;</span>, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">FUN =</span> <span class="cf">function</span>(tt) <span class="fu">t</span>(ytildes[tt,]) <span class="sc">%*%</span> Sigma_inv <span class="sc">%*%</span> mumat[tt,])) <span class="sc">+</span> aux.y) <span class="sc">+</span> lambda <span class="sc">*</span> <span class="fu">sum</span>(CVXR<span class="sc">::</span><span class="fu">sum_entries</span>(<span class="fu">abs</span>(Dl <span class="sc">%*%</span> mumat), <span class="at">axis =</span> <span class="dv">1</span>))</span>
<span id="cb60-50"><a href="m-step.html#cb60-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-51"><a href="m-step.html#cb60-51" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Putting together the ball constraint</span></span>
<span id="cb60-52"><a href="m-step.html#cb60-52" aria-hidden="true" tabindex="-1"></a>  rowmns <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="dv">1</span>, TT<span class="sc">^</span><span class="dv">2</span>), <span class="at">nrow =</span> TT)<span class="sc">/</span>TT</span>
<span id="cb60-53"><a href="m-step.html#cb60-53" aria-hidden="true" tabindex="-1"></a>  mu_dotdot <span class="ot">&lt;-</span> rowmns <span class="sc">%*%</span> mumat</span>
<span id="cb60-54"><a href="m-step.html#cb60-54" aria-hidden="true" tabindex="-1"></a>  constraints <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb60-55"><a href="m-step.html#cb60-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(maxdev)){</span>
<span id="cb60-56"><a href="m-step.html#cb60-56" aria-hidden="true" tabindex="-1"></a>    constraints <span class="ot">=</span> <span class="fu">list</span>(CVXR<span class="sc">::</span><span class="fu">sum_entries</span>(CVXR<span class="sc">::</span><span class="fu">square</span>(mumat <span class="sc">-</span> mu_dotdot), <span class="at">axis =</span> <span class="dv">2</span>) <span class="sc">&lt;=</span> <span class="fu">rep</span>(maxdev<span class="sc">^</span><span class="dv">2</span>, TT) )</span>
<span id="cb60-57"><a href="m-step.html#cb60-57" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb60-58"><a href="m-step.html#cb60-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-59"><a href="m-step.html#cb60-59" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Try all two CVXR solvers.</span></span>
<span id="cb60-60"><a href="m-step.html#cb60-60" aria-hidden="true" tabindex="-1"></a>  prob <span class="ot">&lt;-</span> CVXR<span class="sc">::</span><span class="fu">Problem</span>(CVXR<span class="sc">::</span><span class="fu">Minimize</span>(obj), constraints)</span>
<span id="cb60-61"><a href="m-step.html#cb60-61" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb60-62"><a href="m-step.html#cb60-62" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb60-63"><a href="m-step.html#cb60-63" aria-hidden="true" tabindex="-1"></a>    CVXR<span class="sc">::</span><span class="fu">solve</span>(prob, <span class="at">solver=</span><span class="st">&quot;ECOS&quot;</span>,</span>
<span id="cb60-64"><a href="m-step.html#cb60-64" aria-hidden="true" tabindex="-1"></a>          <span class="at">FEASTOL =</span> ecos_thresh, <span class="at">RELTOL =</span> ecos_thresh, <span class="at">ABSTOL =</span> ecos_thresh)</span>
<span id="cb60-65"><a href="m-step.html#cb60-65" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error=</span><span class="cf">function</span>(err){</span>
<span id="cb60-66"><a href="m-step.html#cb60-66" aria-hidden="true" tabindex="-1"></a>    err<span class="sc">$</span>message <span class="ot">=</span> <span class="fu">paste</span>(err<span class="sc">$</span>message, </span>
<span id="cb60-67"><a href="m-step.html#cb60-67" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="st">&quot;Lasso solver using ECOS has failed.&quot;</span> ,<span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb60-68"><a href="m-step.html#cb60-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(err<span class="sc">$</span>message, <span class="at">fill=</span><span class="cn">TRUE</span>)</span>
<span id="cb60-69"><a href="m-step.html#cb60-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb60-70"><a href="m-step.html#cb60-70" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb60-71"><a href="m-step.html#cb60-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-72"><a href="m-step.html#cb60-72" aria-hidden="true" tabindex="-1"></a>  <span class="do">## If anything is wrong, flag to use SCS solver</span></span>
<span id="cb60-73"><a href="m-step.html#cb60-73" aria-hidden="true" tabindex="-1"></a>  scs <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb60-74"><a href="m-step.html#cb60-74" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(result)){</span>
<span id="cb60-75"><a href="m-step.html#cb60-75" aria-hidden="true" tabindex="-1"></a>    scs <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb60-76"><a href="m-step.html#cb60-76" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb60-77"><a href="m-step.html#cb60-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(result<span class="sc">$</span>status <span class="sc">!=</span> <span class="st">&quot;optimal&quot;</span>) scs <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb60-78"><a href="m-step.html#cb60-78" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb60-79"><a href="m-step.html#cb60-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-80"><a href="m-step.html#cb60-80" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Use the SCS solver</span></span>
<span id="cb60-81"><a href="m-step.html#cb60-81" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(scs){</span>
<span id="cb60-82"><a href="m-step.html#cb60-82" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">=</span> CVXR<span class="sc">::</span><span class="fu">solve</span>(prob, <span class="at">solver=</span><span class="st">&quot;SCS&quot;</span>, <span class="at">eps =</span> scs_eps)</span>
<span id="cb60-83"><a href="m-step.html#cb60-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.na</span>(result<span class="sc">$</span><span class="fu">getValue</span>(mumat)))){ <span class="do">## A clumsy way to check.</span></span>
<span id="cb60-84"><a href="m-step.html#cb60-84" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">&quot;Lasso solver using both ECOS and SCS has failed.&quot;</span>, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb60-85"><a href="m-step.html#cb60-85" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb60-86"><a href="m-step.html#cb60-86" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb60-87"><a href="m-step.html#cb60-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-88"><a href="m-step.html#cb60-88" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Record Interesting Parameters</span></span>
<span id="cb60-89"><a href="m-step.html#cb60-89" aria-hidden="true" tabindex="-1"></a>  num_iters <span class="ot">&lt;-</span> result<span class="sc">$</span>num_iters</span>
<span id="cb60-90"><a href="m-step.html#cb60-90" aria-hidden="true" tabindex="-1"></a>  status <span class="ot">&lt;-</span> result<span class="sc">$</span>status</span>
<span id="cb60-91"><a href="m-step.html#cb60-91" aria-hidden="true" tabindex="-1"></a>  mumat <span class="ot">&lt;-</span> result<span class="sc">$</span><span class="fu">getValue</span>(mumat)</span>
<span id="cb60-92"><a href="m-step.html#cb60-92" aria-hidden="true" tabindex="-1"></a>  val <span class="ot">&lt;-</span> result<span class="sc">$</span>value</span>
<span id="cb60-93"><a href="m-step.html#cb60-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-94"><a href="m-step.html#cb60-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mu =</span> mumat, <span class="at">value =</span> val, <span class="at">status =</span> status, <span class="at">num_iters =</span> num_iters))</span>
<span id="cb60-95"><a href="m-step.html#cb60-95" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This function solves the following problem:</p>
<p><span class="math display">\[
\begin{align*}
&amp;\text{minimize}_{\mu}
{\frac{1}{2N}
    \sum_{t=1}^T \sum_{i=1}^{n_t} \hat{\gamma}_{it} (y_i^{(t)} - \mu_{\cdot t})^\top \hat{\Sigma}^{-1} ( y_i^{(t)} - \mu_{\cdot t})
  + \lambda \sum_{j=1}^d \|D^{(l)}\mu_{j\cdot }\|_1}\\
&amp;\text{subject to}\;\; {\| \mu_{\cdot t} - \bar{\mu}_{\cdot \cdot}\|_2 \le r \;\;\forall t=1,\cdots, T, }
\end{align*}
\]</span></p>
<p>and is directly equivalent to <code><a href='m-step.html#Mstep_mu'>Mstep_mu</a>()</code>. The resulting solution and the
objective value should be the same. Let’s check that.</p>
<p>First, set up some objects to run <code><a href='m-step.html#Mstep_mu'>Mstep_mu</a>()</code> and <code><a href='m-step.html#Mstep_mu_cvxr'>Mstep_mu_cvxr</a>()</code>.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="m-step.html#cb61-1" aria-hidden="true" tabindex="-1"></a>numclust <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb61-2"><a href="m-step.html#cb61-2" aria-hidden="true" tabindex="-1"></a>TT <span class="ot">=</span> <span class="dv">100</span></span>
<span id="cb61-3"><a href="m-step.html#cb61-3" aria-hidden="true" tabindex="-1"></a>dimdat <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb61-4"><a href="m-step.html#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">0</span>)</span>
<span id="cb61-5"><a href="m-step.html#cb61-5" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">=</span> <a href='package-setup.html#gendat_1d'>gendat_1d</a>(<span class="at">TT =</span> TT, <span class="at">ntlist =</span> <span class="fu">rep</span>(TT, <span class="dv">100</span>))</span>
<span id="cb61-6"><a href="m-step.html#cb61-6" aria-hidden="true" tabindex="-1"></a>ylist <span class="ot">=</span> dt <span class="sc">%&gt;%</span> <a href='package-setup.html#dt2ylist'>dt2ylist</a>()</span>
<span id="cb61-7"><a href="m-step.html#cb61-7" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">=</span> <a href='initial-parameters-for-em-algorithm.html#init_sigma'>init_sigma</a>(ylist, numclust) <span class="do">## (T x numclust x (dimdat x dimdat))</span></span>
<span id="cb61-8"><a href="m-step.html#cb61-8" aria-hidden="true" tabindex="-1"></a>mn <span class="ot">=</span> <a href='initial-parameters-for-em-algorithm.html#init_mn'>init_mn</a>(ylist, numclust, TT, dimdat)<span class="do">##, countslist = countslist)</span></span>
<span id="cb61-9"><a href="m-step.html#cb61-9" aria-hidden="true" tabindex="-1"></a>prob <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">/</span>numclust, <span class="at">nrow =</span> TT, <span class="at">ncol =</span> numclust) <span class="do">## Initialize to all 1/K.</span></span>
<span id="cb61-10"><a href="m-step.html#cb61-10" aria-hidden="true" tabindex="-1"></a>resp <span class="ot">=</span> <a href='e-step.html#Estep'>Estep</a>(mn, sigma, prob, <span class="at">ylist =</span> ylist, numclust)</span>
<span id="cb61-11"><a href="m-step.html#cb61-11" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">=</span> .<span class="dv">01</span></span>
<span id="cb61-12"><a href="m-step.html#cb61-12" aria-hidden="true" tabindex="-1"></a>l <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb61-13"><a href="m-step.html#cb61-13" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span>TT</span>
<span id="cb61-14"><a href="m-step.html#cb61-14" aria-hidden="true" tabindex="-1"></a>Dl <span class="ot">=</span> <a href='trend-filtering.html#gen_diff_mat'>gen_diff_mat</a>(<span class="at">n =</span> TT, <span class="at">l =</span> l<span class="sc">+</span><span class="dv">1</span>, <span class="at">x =</span> x)</span>
<span id="cb61-15"><a href="m-step.html#cb61-15" aria-hidden="true" tabindex="-1"></a>Dlm1 <span class="ot">=</span> <a href='trend-filtering.html#gen_diff_mat'>gen_diff_mat</a>(<span class="at">n =</span> TT, <span class="at">l =</span> l, <span class="at">x =</span> x)</span>
<span id="cb61-16"><a href="m-step.html#cb61-16" aria-hidden="true" tabindex="-1"></a>Dlm1sqrd <span class="ot">&lt;-</span> <span class="fu">t</span>(Dlm1) <span class="sc">%*%</span> Dlm1</span>
<span id="cb61-17"><a href="m-step.html#cb61-17" aria-hidden="true" tabindex="-1"></a>maxdev <span class="ot">=</span> <span class="cn">NULL</span></span></code></pre></div>
<p>Then, compare the result of the two implementations. They should look identical.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="m-step.html#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="do">## overall ADMM</span></span>
<span id="cb62-2"><a href="m-step.html#cb62-2" aria-hidden="true" tabindex="-1"></a>res1 <span class="ot">=</span> <a href='m-step.html#Mstep_mu'>Mstep_mu</a>(resp, ylist, lambda, <span class="at">l=</span>l, <span class="at">sigma=</span>sigma, <span class="at">Dlm1sqrd =</span> Dlm1sqrd, <span class="at">Dlm1=</span>Dlm1, <span class="at">Dl=</span>Dl, <span class="at">TT=</span>TT, <span class="at">N=</span>N, <span class="at">dimdat=</span>dimdat, <span class="at">e_mat=</span><a href='m-step.html#etilde_mat'>etilde_mat</a>(<span class="at">TT =</span> TT),</span>
<span id="cb62-3"><a href="m-step.html#cb62-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">maxdev =</span> maxdev)</span>
<span id="cb62-4"><a href="m-step.html#cb62-4" aria-hidden="true" tabindex="-1"></a>mn1 <span class="ot">=</span> res1<span class="sc">$</span>mns</span>
<span id="cb62-5"><a href="m-step.html#cb62-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-6"><a href="m-step.html#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="do">## CVXR just ONE cluster</span></span>
<span id="cb62-7"><a href="m-step.html#cb62-7" aria-hidden="true" tabindex="-1"></a>res2list <span class="ot">=</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>numclust, <span class="cf">function</span>(iclust){</span>
<span id="cb62-8"><a href="m-step.html#cb62-8" aria-hidden="true" tabindex="-1"></a>  Sigma_inv_oneclust <span class="ot">=</span> <span class="fu">solve</span>(sigma[iclust,,])</span>
<span id="cb62-9"><a href="m-step.html#cb62-9" aria-hidden="true" tabindex="-1"></a>  resp_oneclist <span class="ot">=</span> <span class="fu">lapply</span>(resp, <span class="cf">function</span>(resp_onetime){resp_onetime[,iclust, drop<span class="ot">=</span><span class="cn">FALSE</span>]})</span>
<span id="cb62-10"><a href="m-step.html#cb62-10" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">unlist</span>(resp))</span>
<span id="cb62-11"><a href="m-step.html#cb62-11" aria-hidden="true" tabindex="-1"></a>  res2 <span class="ot">=</span> <a href='m-step.html#Mstep_mu_cvxr'>Mstep_mu_cvxr</a>(ylist, resp_oneclist, lambda, l<span class="sc">+</span><span class="dv">1</span>,  Sigma_inv_oneclust, <span class="at">thresh =</span> <span class="fl">1E-8</span>, <span class="at">maxdev =</span> maxdev, dimdat, N) </span>
<span id="cb62-12"><a href="m-step.html#cb62-12" aria-hidden="true" tabindex="-1"></a>  res2<span class="sc">$</span>mu</span>
<span id="cb62-13"><a href="m-step.html#cb62-13" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb62-14"><a href="m-step.html#cb62-14" aria-hidden="true" tabindex="-1"></a>mn2 <span class="ot">=</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(<span class="dv">100</span>, dimdat, <span class="dv">3</span>))</span>
<span id="cb62-15"><a href="m-step.html#cb62-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(iclust <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>numclust){</span>
<span id="cb62-16"><a href="m-step.html#cb62-16" aria-hidden="true" tabindex="-1"></a>  mn2[,,iclust] <span class="ot">=</span> res2list[[iclust]] <span class="sc">%&gt;%</span>  <span class="fu">as.matrix</span>()</span>
<span id="cb62-17"><a href="m-step.html#cb62-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb62-18"><a href="m-step.html#cb62-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-19"><a href="m-step.html#cb62-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-20"><a href="m-step.html#cb62-20" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot!</span></span>
<span id="cb62-21"><a href="m-step.html#cb62-21" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> dt<span class="sc">$</span>time, <span class="at">y=</span>dt<span class="sc">$</span>Y, <span class="at">col =</span> <span class="fu">rgb</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.04</span>), <span class="at">main =</span> <span class="st">&#39;admm vs cvxr&#39;</span>, <span class="at">ylab =</span> <span class="st">&quot;&quot;</span>, <span class="at">xlab =</span> <span class="st">&quot;time&quot;</span>)</span>
<span id="cb62-22"><a href="m-step.html#cb62-22" aria-hidden="true" tabindex="-1"></a>mn1[,<span class="dv">1</span>,] <span class="sc">%&gt;%</span> <span class="fu">matlines</span>(<span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="dv">1</span>)</span>
<span id="cb62-23"><a href="m-step.html#cb62-23" aria-hidden="true" tabindex="-1"></a>mn2[,<span class="dv">1</span>,] <span class="sc">%&gt;%</span> <span class="fu">matlines</span>(<span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">lty =</span> <span class="dv">3</span>)</span></code></pre></div>
<p>TODO: We just need to bundle this into <code>testthat</code> style tests, and make sure to test several lambda values.</p>
<p>TODO: maybe do this for unevenly spaced inputs. CVXR needs to take a different D matrix.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="m-step.html#cb63-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;Test the M step of \mu against CVXR&quot;</span>, {})</span></code></pre></div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="e-step.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="flowtrend.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
